System.register([],(function(t,e){"use strict";return{execute:function(){t({BitMask:Ut,CCClass:Me,CacheMode:void 0,DebugMode:void 0,ECollider2DType:void 0,EJoint2DType:void 0,EPhysics2DDrawFlags:void 0,ERaycast2DType:void 0,ERigidBody2DType:void 0,Enum:Gt,Eventify:$i,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,Overflow:void 0,Physics2DManifoldType:void 0,SystemEventType:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:Yg,WorldNode3DToWorldNodeUI:Kg,absMax:ii,absMaxComponent:ei,approx:Ve,assert:p,assertID:E,bezier:qP,bezierByTime:QP,ccenum:jt,clamp:Ue,clamp01:Ge,color:ri,computeRatioByType:nI,createDefaultPipeline:Av,deserialize:mm,earcut:xV,equals:ze,error:d,errorID:T,find:Ab,fragmentText:SM,getBaselineOffset:function(){return 0},getError:I,getPathFromRoot:function(t,e){let i=t,n="";for(;null!==i&&i!==e;)n=`${i.name}/${n}`,i=i.parent;return n.slice(0,-1)},getWorldTransformUntilRoot:function(t,e,i){for(Si.identity(i);t!==e;)Si.fromRTS(dD,t.rotation,t.position,t.scale),Si.multiply(i,dD,i),t=t.parent;return i},instantiate:cS,inverseLerp:ti,isCustomTargetModifier:wD,isDisplayStats:D,isElementModifier:TD,isPropertyModifier:bD,isUnicodeCJK:gM,isUnicodeSpace:yM,isValid:ki,lerp:He,log:u,logID:S,markAsWarning:void 0,mat4:bi,murmurhash2_32_gc:qa,nextPow2:$e,pingPong:Qe,pseudoRandom:Ye,pseudoRandomRange:Ke,pseudoRandomRangeInt:Je,quat:vi,randomRange:qe,randomRangeInt:Xe,rect:Ni,removeProperty:void 0,repeat:Ze,replaceProperty:void 0,safeMeasureText:vM,sampleAnimationCurve:iI,setDefaultLogTimes:function(t){t>0&&(j=t)},setDisplayStats:R,size:Bi,toDegree:je,toRadian:ke,tween:h7,tweenUtil:_7,v2:Pi,v3:ci,v4:Di,warn:m,warnID:C});const i="undefined"==typeof window?global:window,n=t("cclegacy",{_global:i});n.internal={},i.CC_BUILD=!0,i.CC_TEST=!1,i.CC_EDITOR=false,i.CC_PREVIEW=!1,i.CC_DEV=!1,i.CC_DEBUG=!1,i.CC_JSB=!0,i.CC_BYTEDANCE=!1,i.CC_WECHAT=!1,i.CC_ALIPAY=!1,i.CC_XIAOMI=!1,i.CC_BAIDU=!1,i.CC_COCOSPLAY=!1,i.CC_HUAWEI=!1,i.CC_OPPO=!1,i.CC_VIVO=!1,i.CC_MINIGAME=!1,i.CC_RUNTIME_BASED=!1,i.CC_SUPPORT_JIT=!0;const s=t("VERSION","3.2.0");i.CocosEngine=n.ENGINE_VERSION=s,i.cc=n;let r=null,o=console.log.bind(console),a=o,l=o,c=(t,e,...i)=>{t||console.log(`ASSERT: ${_(e,...i)}`)},h=o;function _(t,...e){return n.js.formatStr.apply(null,[t].concat(e))}function u(t,...e){return o(t,...e)}function m(t,...e){return a(t,...e)}function d(t,...e){return l(t,...e)}function p(t,e,...i){return c(t,e,...i)}function f(...t){return h(...t)}function g(t){if(o=a=l=c=h=()=>{},t!==P.NONE){if(t>P.ERROR){const e=t=>{if(n.game.canvas){if(!r){const t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",n.game.canvas.height);const e=t.style;e.zIndex="99999",e.position="absolute",e.top=e.left="0",r=document.createElement("textarea"),r.setAttribute("rows","20"),r.setAttribute("cols","30"),r.setAttribute("disabled","true");const i=r.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",t.appendChild(r),n.game.canvas.parentNode.appendChild(t)}r.value=`${r.value+t}\r\n`,r.scrollTop=r.scrollHeight}};l=(t,...i)=>{e(`ERROR :  ${_(t,...i)}`)},c=(t,i,...n)=>{t||e(`ASSERT: ${_(i,...n)}`)},t!==P.ERROR_FOR_WEB_PAGE&&(a=(t,...i)=>{e(`WARN :  ${_(t,...i)}`)}),t===P.INFO_FOR_WEB_PAGE&&(o=(t,...i)=>{e(_(t,...i))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),l=console.error.bind?console.error.bind(console):console.error,c=(t,e,...i)=>{if(!t){const t=_(e,...i);throw new Error(t)}});if(t!==P.ERROR&&(a=console.warn.bind?console.warn.bind(console):console.warn),t===P.INFO&&(o="JavaScriptCore"===scriptEngineType?(t,...e)=>console.log.apply(console,[t,...e]):console.log),t<=P.VERBOSE&&"function"==typeof console.debug){const t=console.debug;h=(...e)=>t(...e)}}}function y(t){{const e=t.stack;return void d(e?`${t}\n${e}`:t)}}function v(t){return(e,...i)=>{const n=`${t} ${e}, please go to https://github.com/cocos-creator/engine/blob/3d/EngineErrorMap.md#${e} to see details.`;return 0===i.length?n:`${n} Arguments: ${i.join(", ")}`}}const x=v("Log");function S(t,...e){u(x(t,...e))}const A=v("Warning");function C(t,...e){m(A(t,...e))}const b=v("Error");function T(t,...e){d(b(t,...e))}const w=v("Assert");function E(t,e,...i){t||p(!1,w(e,...i))}let P;function I(t,...e){return b(t,...e)}function D(){return!!n.profiler&&n.profiler.isShowingStats()}function R(t){n.profiler&&(t?n.profiler.showStats():n.profiler.hideStats(),n.game.config.showFPS=!!t)}!function(t){t[t.NONE=0]="NONE",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",t[t.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",t[t.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(P||(P=t("DebugMode",{})));var M=Object.freeze({__proto__:null,log:u,warn:m,error:d,assert:p,debug:f,_resetDebugSetting:g,_throw:y,logID:S,warnID:C,errorID:T,assertID:E,get DebugMode(){return P},getError:I,isDisplayStats:D,setDisplayStats:R});function B(t){let e,i;return e=(t>65535)<<4,i=((t>>>=e)>255)<<3,e|=i,i=((t>>>=i)>15)<<2,e|=i,i=((t>>>=i)>3)<<1,e|=i,e|(t>>>=i)>>1}function O(t){let e=32;return(t&=-t)&&e--,65535&t&&(e-=16),16711935&t&&(e-=8),252645135&t&&(e-=4),858993459&t&&(e-=2),1431655765&t&&(e-=1),e}function N(t){return t+=0===t,--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,1+(t|=t>>>16)}const L=new Array(256);(t=>{for(let e=0;e<256;++e){let i=e,n=e,s=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--s;t[e]=n<<s&255}})(L);var F=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(t){return(t>0)-(t<0)},abs:function(t){const e=t>>31;return(t^e)-e},min:function(t,e){return e^(t^e)&-(t<e)},max:function(t,e){return t^(t^e)&-(t<e)},isPow2:function(t){return!(t&t-1||!t)},log2:B,log10:function(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0},popCount:function(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24},countTrailingZeros:O,nextPow2:N,prevPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,(t|=t>>>16)-(t>>>1)},parity:function(t){return t^=t>>>16,t^=t>>>8,t^=t>>>4,27030>>>(t&=15)&1},reverse:function(t){return L[255&t]<<24|L[t>>>8&255]<<16|L[t>>>16&255]<<8|L[t>>>24&255]},interleave2:function(t,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))<<1},deinterleave2:function(t,e){return(t=65535&((t=16711935&((t=252645135&((t=858993459&((t=t>>>e&1431655765)|t>>>1))|t>>>2))|t>>>4))|t>>>16))<<16>>16},interleave3:function(t,e,i){return t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2),(t|=(e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(t,e){return(t=1023&((t=4278190335&((t=251719695&((t=3272356035&((t=t>>>e&1227133513)|t>>>2))|t>>>4))|t>>>8))|t>>>16))<<22>>22},nextCombination:function(t){const e=t|t-1;return e+1|(~e&-~e)-1>>>O(t)+1}});t("bits",F);let z,V,U,G,H,k,j=10,W=0;const q=new Map;G=(t,e,i,n,s,r,o)=>{const a=q.get(r);a&&a.logTimes>a.count&&(s(`'%s' is deprecated, please use '%s' instead. ${o}`,`${t}.${e}`,`${i}.${n}`),a.count++)},z=t("replaceProperty",((t,e,i)=>{null!=t&&i.forEach((i=>{const n=W++;q.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:j});const s=null!=i.target?i.target:t,r=null!=i.newName?i.newName:i.name,o=null!=i.targetName?i.targetName:e,a=s===t,l=i.suggest?`(${i.suggest})`:"";if(null!=i.customFunction)t[i.name]=function(){return G(e,i.name,o,r,m,n,l),i.customFunction.call(this,...arguments)};else if(null!=i.customSetter||null!=i.customGetter){const s=null!=i.customSetter,a=null!=i.customGetter;s&&a?Object.defineProperty(t,i.name,{get(){return G(e,i.name,o,r,m,n,l),i.customGetter.call(this)},set(t){G(e,i.name,o,r,m,n,l),i.customSetter.call(this,t)},enumerable:!1}):s?Object.defineProperty(t,i.name,{set(t){G(e,i.name,o,r,m,n,l),i.customSetter.call(this,t)},enumerable:!1}):a&&Object.defineProperty(t,i.name,{get(){return G(e,i.name,o,r,m,n,l),i.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(t,i.name,{get(){return G(e,i.name,o,r,m,n,l),a?this[r]:s[r]},set(t){G(e,i.name,o,r,m,n,l),a?this[r]=t:s[r]=t},enumerable:!1})}))})),k=(t,e,i,n,s)=>{const r=q.get(n);r&&r.logTimes>r.count&&(i(`'%s' has been removed. ${s}`,`${t}.${e}`),r.count++)},V=t("removeProperty",((t,e,i)=>{null!=t&&i.forEach((i=>{const n=W++;q.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:j});const s=i.suggest?`(${i.suggest})`:"";Object.defineProperty(t,i.name,{get:()=>k(e,i.name,d,n,s),set(){k(e,i.name,d,n,s)},enumerable:!1})}))})),H=(t,e,i,n,s)=>{const r=q.get(n);r&&r.logTimes>r.count&&(i(`'%s' is deprecated. ${s}`,`${t}.${e}`),r.count++)},U=t("markAsWarning",((t,e,i)=>{if(null==t)return;const n=(e,i,n,s,r,o)=>{if(e.get){const t=e.get;e.get=function(){return H(i,n,s,r,o),t.call(this)}}if(e.set){const t=e.set;e.set=function(e){H(i,n,s,r,o),t.call(this,e)}}Object.defineProperty(t,n,e)};i.forEach((i=>{const s=i.name,r=Object.getOwnPropertyDescriptor(t,s);if(!r||!r.configurable)return;const o=W++;q.set(o,{id:o,count:0,logTimes:void 0!==i.logTimes?i.logTimes:j});const a=i.suggest?`(${i.suggest})`:"";if(null!=r.value)if("function"==typeof r.value){const i=r.value;t[s]=function(){return H(e,s,m,o,a),i.call(this,...arguments)}}else n(r,e,s,m,o,a);else n(r,e,s,m,o,a);Object.defineProperty(t,s,{enumerable:!1})}))}));class X{constructor(t){this.i=0,this.array=t}get length(){return this.array.length}set length(t){this.array.length=t,this.i>=t&&(this.i=t-1)}remove(t){const e=this.array.indexOf(t);e>=0&&this.removeAt(e)}removeAt(t){this.array.splice(t,1),t<=this.i&&--this.i}fastRemove(t){const e=this.array.indexOf(t);e>=0&&this.fastRemoveAt(e)}fastRemoveAt(t){const e=this.array;e[t]=e[e.length-1],--e.length,t<=this.i&&--this.i}push(t){this.array.push(t)}}function Y(t,e){t.splice(e,1)}function K(t,e){const i=t.length;e<0||e>=i||(t[e]=t[i-1],t.length=i-1)}function J(t,e){const i=t.indexOf(e);return i>=0&&(Y(t,i),!0)}function $(t,e){return t.indexOf(e)>=0}var Z=Object.freeze({__proto__:null,removeAt:Y,fastRemoveAt:K,remove:J,fastRemove:function(t,e){const i=t.indexOf(e);i>=0&&(t[i]=t[t.length-1],--t.length)},removeIf:function(t,e){const i=t.findIndex(e);if(i>=0){const e=t[i];return Y(t,i),e}},verifyType:function(t,e){if(t&&t.length>0)for(const i of t)if(!(i instanceof e))return S(1300),!1;return!0},removeArray:function(t,e){for(let i=0,n=e.length;i<n;i++)J(t,e[i])},appendObjectsAt:function(t,e,i){return t.splice.apply(t,[i,0,...e]),t},contains:$,copy:function(t){const e=t.length,i=new Array(e);for(let n=0;n<e;n+=1)i[n]=t[n];return i},MutableForwardIterator:X});class Q{constructor(t){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}getNewId(){return this.prefix+ ++this.id}}Q.global=new Q("global");const tt=new Q("TmpCId."),et="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),it="__cid__";function nt(t){return"number"==typeof t||t instanceof Number}function st(t){return"string"==typeof t||t instanceof String}function rt(t){for(const e in t)return!1;return!0}const ot=(()=>{const t={value:void 0,enumerable:!1,writable:!1,configurable:!0};return(e,i,n,s,r)=>{t.value=n,t.writable=s,t.enumerable=r,Object.defineProperty(e,i,t),t.value=void 0}})(),at=(()=>{const t={get:void 0,set:void 0,enumerable:!1};return(e,i,n,s,r=!1,o=!1)=>{"boolean"==typeof s&&(r=s,s=void 0),t.get=n,t.set=s,t.enumerable=r,t.configurable=o,Object.defineProperty(e,i,t),t.get=void 0,t.set=void 0}})(),lt=(()=>{const t={get:void 0,enumerable:!1,configurable:!1};return(e,i,n,s,r)=>{t.get=n,t.enumerable=s,t.configurable=r,Object.defineProperty(e,i,t),t.get=void 0}})(),ct=(()=>{const t={set:void 0,enumerable:!1,configurable:!1};return(e,i,n,s,r)=>{t.set=n,t.enumerable=s,t.configurable=r,Object.defineProperty(e,i,t),t.set=void 0}})();function ht(t){const e=Object.create(null);if(t){const t=".",i="/";e[t]=1,e[i]=1,delete e[t],delete e[i]}return e}function _t(t){if("function"==typeof t){const e=t.prototype;if(e&&e.hasOwnProperty("__classname__")&&e.__classname__)return e.__classname__;let i="";if(t.name&&(i=t.name),t.toString){let e;const n=t.toString();e="["===n.charAt(0)?n.match(/\[\w+\s*(\w+)\]/):n.match(/function\s*(\w+)/),e&&2===e.length&&(i=e[1])}return"Object"!==i?i:""}return t&&t.constructor?_t(t.constructor):""}function ut(t,e,i,n){const s=/([^.]+)$/,r=s.exec(e)[0],o=s.exec(i)[0];function a(){return this[o]}n?at(t,r,a,(function(t){this[o]=t})):lt(t,r,a)}function mt(t,e,i,n){for(const s in i)ut(t,`${e}.${s}`,i[s],n)}const dt=/(%d)|(%s)/,pt=/%s/;function ft(t,...e){if(0===arguments.length)return"";if(0===e.length)return`${t}`;const i="string"==typeof t&&dt.test(t);if(i)for(const i of e){const e="number"==typeof i?dt:pt;if(e.test(t)){const n=`${i}`;t=t.replace(e,n)}else t+=` ${i}`}else for(const i of e)t+=` ${i}`;return t}function gt(){const t=arguments.length-1,e=new Array(t);for(let i=0;i<t;++i)e[i]=arguments[i+1];return e}function yt(t,e){for(;t;){const i=Object.getOwnPropertyDescriptor(t,e);if(i)return i;t=Object.getPrototypeOf(t)}return null}function vt(t,e,i){const n=yt(e,t);n&&Object.defineProperty(i,t,n)}function xt(t,...e){t=t||{};for(const i of e)if(i){if("object"!=typeof i){T(5402,i);continue}for(const e in i)e in t||vt(e,i,t)}return t}function St(t,...e){t=t||{};for(const i of e)if(i){if("object"!=typeof i){T(5403,i);continue}for(const e in i)vt(e,i,t)}return t}function At(t,e){for(const i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t.prototype=Object.create(e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),t}function Ct(t){const e=t.prototype,i=e&&Object.getPrototypeOf(e);return i&&i.constructor}function bt(t,e){if(t&&e){if("function"!=typeof t)return!1;if("function"!=typeof e)return!1;if(t===e)return!0;for(;;){if(!(t=Ct(t)))return!1;if(t===e)return!0}}return!1}function Tt(t){for(const e of Object.keys(t))delete t[e]}const wt=ht(!0),Et=ht(!0);function Pt(t,e){return function(i,n){if(n.prototype.hasOwnProperty(t)&&delete e[n.prototype[t]],ot(n.prototype,t,i),i){const s=e[i];s&&s!==n?d(`A Class already exists with the same ${t} : "${i}".`):e[i]=n}}}const It=Pt("__cid__",wt),Dt=Pt("__classname__",Et);function Rt(t,e){if(Dt(t,e),!e.prototype.hasOwnProperty(it)){const i=t||tt.getNewId();i&&It(i,e)}}function Mt(t,e){const i=Et[e],n=wt[e];let s=!0;if(i&&i!==t&&(d(`"${e}" has already been set as name or alias of another class.`),s=!1),n&&n!==t&&(d(`"${e}" has already been set as id or alias of another class.`),s=!1),s){let i=t[et];i||(i=[],t[et]=i),i.push(e),Et[e]=t,wt[e]=t}}function Bt(...t){for(const e of t){const t=e.prototype,i=t.__cid__;i&&delete wt[i];const n=t.__classname__;n&&delete Et[n];const s=t[et];if(s)for(let t=0;t<s.length;++t){const e=s[t];delete Et[e],delete wt[e]}}}function Ot(t){return wt[t]}function Nt(t){return Et[t]}function Lt(t,e){let i;if(e=void 0===e||e,"function"==typeof t&&t.prototype.hasOwnProperty(it))return i=t.prototype.__cid__,i;if(t&&t.constructor){const e=t.constructor.prototype;if(e&&e.hasOwnProperty(it))return i=t.__cid__,i}return""}class Ft{get(){return this._get()}constructor(t,e){this.count=void 0,this._pool=void 0,this._cleanup=void 0;const i=void 0===e?t:e,n=void 0===e?null:t;this.count=0,this._pool=new Array(i),this._cleanup=n}_get(){if(this.count>0){--this.count;const t=this._pool[this.count];return this._pool[this.count]=null,t}return null}put(t){const e=this._pool;if(this.count<e.length){if(this._cleanup&&!1===this._cleanup(t))return;e[this.count]=t,++this.count}}resize(t){t>=0&&(this._pool.length=t,this.count>t&&(this.count=t))}}const zt=Z,Vt={IDGenerator:Q,Pool:Ft,array:Z,isNumber:nt,isString:st,isEmptyObject:rt,getPropertyDescriptor:yt,addon:xt,mixin:St,extend:At,getSuper:Ct,isChildClassOf:bt,clear:Tt,value:ot,getset:at,get:lt,set:ct,unregisterClass:Bt,getClassName:_t,setClassName:Rt,setClassAlias:Mt,getClassByName:Nt,get _registeredClassNames(){return{...Et}},set _registeredClassNames(t){Tt(Et),Object.assign(Et,t)},get _registeredClassIds(){return{...wt}},set _registeredClassIds(t){Tt(wt),Object.assign(wt,t)},_getClassId:Lt,_setClassId:It,_getClassById:Ot,obsolete:ut,obsoletes:mt,formatStr:ft,shiftArguments:gt,createMap:ht};function Ut(t){if("__bitmask__"in t)return t;ot(t,"__bitmask__",null,!0);let e=-1;const i=Object.keys(t);for(let n=0;n<i.length;n++){const s=i[n];let r=t[s];if(-1===r)r=++e,t[s]=r;else if("number"==typeof r)e=r;else if("string"==typeof r&&Number.isInteger(parseFloat(s)))continue;const o=`${r}`;s!==o&&ot(t,o,s)}return t}function Gt(t){return"__enums__"in t?t:(ot(t,"__enums__",null,!0),Gt.update(t))}function Ht(t){t.hasOwnProperty("__enums__")}function kt(t){Ht(t);const e=t.__enums__||[];e.length=0;for(const i in t){const n=t[i];Number.isInteger(n)&&e.push({name:i,value:n})}return e.sort(((t,e)=>t.value-e.value)),t.__enums__=e,e}function jt(t){"__enums__"in t||ot(t,"__enums__",null,!0)}n.js=Vt,t("js",Object.freeze({__proto__:null,array:zt,js:Vt,IDGenerator:Q,Pool:Ft,isNumber:nt,isString:st,isEmptyObject:rt,value:ot,getset:at,get:lt,set:ct,createMap:ht,getClassName:_t,obsolete:ut,obsoletes:mt,formatStr:ft,shiftArguments:gt,getPropertyDescriptor:yt,addon:xt,mixin:St,extend:At,getSuper:Ct,isChildClassOf:bt,clear:Tt,_idToClass:wt,_nameToClass:Et,_setClassId:It,setClassName:Rt,setClassAlias:Mt,unregisterClass:Bt,_getClassById:Ot,getClassByName:Nt,_getClassId:Lt})),Ut.isBitMask=t=>t&&t.hasOwnProperty("__bitmask__"),Ut.getList=t=>{if(t.__bitmask__)return t.__bitmask__;const e=t.__bitmask__=[];for(const i in t){const n=t[i];Number.isInteger(n)&&e.push({name:i,value:n})}return e.sort(((t,e)=>t.value-e.value)),e},n.BitMask=Ut,Gt.update=t=>{let e=-1;const i=Object.keys(t);for(let n=0;n<i.length;n++){const s=i[n];let r=t[s];if(-1===r)r=++e,t[s]=r;else if("number"==typeof r)e=r;else if("string"==typeof r&&Number.isInteger(parseFloat(s)))continue;const o=`${r}`;s!==o&&ot(t,o,s)}return Array.isArray(t.__enums__)&&kt(t),t},Gt||(Gt=t("Enum",{})),Gt.isEnum=t=>t&&t.hasOwnProperty("__enums__"),Gt.getList=t=>(Ht(t),t.__enums__?t.__enums__:kt(t)),n.Enum=Gt;class Wt{clone(){return T(100,`${_t(this)}.clone`),this}equals(t){return!1}set(t){T(100,`${_t(this)}.set`)}toString(){return`${{}}`}}t("ValueType",Wt),Rt("cc.ValueType",Wt),n.ValueType=Wt;const qt=t("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20});n.macro=qt;const Xt=/^(?:cc|dragonBones|sp|ccsg)\..+/,Yt=new Array(123);for(let t=0;t<123;++t)Yt[t]=64;for(let t=0;t<64;++t)Yt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(t)]=t;const Kt=Yt;function Jt(t,e,i){function n(t,e,i,n){const s=Object.getOwnPropertyDescriptor(t,e);if(s)s.get&&(t[i]=s.get),s.set&&n&&(t[n]=s.set);else{const s=t[i];at(t,e,s,t[n])}}let s;const r=t.prototype;for(let t=0;t<e.length;t++){s=e[t];const i=s[0].toUpperCase()+s.slice(1);n(r,s,`get${i}`,`set${i}`)}for(s in i){const t=i[s];n(r,s,t[0],t[1])}}function $t(t,e,i,n){const s=t[e];s?Array.isArray(s)?n?(s.push(s[0]),s[0]=i):s.push(i):t[e]=n?[i,s]:[s,i]:t[e]=i}function Zt(t,e){if("function"==typeof t.contains)return t.contains(e);if("function"==typeof t.compareDocumentPosition)return!!(16&t.compareDocumentPosition(e));{let i=e.parentNode;if(i)do{if(i===t)return!0;i=i.parentNode}while(null!==i);return!1}}function Qt(t){return"object"==typeof window&&"function"==typeof Node?t instanceof Node:t&&"object"==typeof t&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName}function te(t,e,i){t&&setTimeout((()=>{t(e,i)}),0)}function ee(t){return!(!t||t.constructor!==Object)&&rt(t)}function ie(t,e,i){if(e>i){const t=e;e=i,i=t}return t<e?e:t<i?t:i}function ne(t){return t*qt.RAD}function se(t){return t*qt.DEG}n.misc={BUILTIN_CLASSID_RE:Xt,BASE64_VALUES:Kt,propertyDefine:Jt,pushToMap:$t,contains:Zt,isDomNode:Qt,callInNextTick:te,isPlainEmptyObj_DEV:ee,clampf:ie,degreesToRadians:ne,radiansToDegrees:se},t("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:Xt,BASE64_VALUES:Kt,propertyDefine:Jt,pushToMap:$t,contains:Zt,isDomNode:Qt,callInNextTick:te,tryCatchFunctor_EDITOR:function(t){return Function("target",`try {\n  target.${t}();\n}\ncatch (e) {\n  cc._throw(e);\n}`)},isPlainEmptyObj_DEV:ee,clampf:ie,degreesToRadians:ne,radiansToDegrees:se}));const re="$_$";function oe(t,e){const i=e?Object.create(e):{};return ot(t,"__attrs__",i),i}function ae(t){if("function"!=typeof t)return oe(t,ce(t.constructor));let e;const i=n.Class.getInheritanceChain(t);for(let t=i.length-1;t>=0;t--){const n=i[t];n.hasOwnProperty("__attrs__")&&n.__attrs__||(e=i[t+1],oe(n,e&&e.__attrs__))}return e=i[0],oe(t,e&&e.__attrs__),t.__attrs__}function le(t,e){const i=ce(t),n=e+re,s={};for(const t in i)t.startsWith(n)&&(s[t.slice(n.length)]=i[t]);return s}function ce(t){return t.hasOwnProperty("__attrs__")&&t.__attrs__||ae(t)}function he(t,e,i,n){ce(t)[e+re+i]=n}class _e{constructor(t,e){this.name=void 0,this.default=void 0,this.name=t,this.default=e}toString(){return this.name}}const ue=t("CCInteger",new _e("Integer",0));n.Integer=ue,n.CCInteger=ue;const me=t("CCFloat",new _e("Float",0));n.Float=me,n.CCFloat=me;const de=t("CCBoolean",new _e("Boolean",!1));n.Boolean=de,n.CCBoolean=de;const pe=t("CCString",new _e("String",""));function fe(t,e){return function(i,n){const s=`"${_t(i)}.${n}"`,r=le(i,n);let o=r.type;if(o===ue||o===me?o="Number":o!==pe&&o!==de||(o=`${o}`),o!==t)return void C(3604,s);if(!r.hasOwnProperty("default"))return;const a=r.default;if(void 0===a)return;if(Array.isArray(a)||ee(a))return;const l=typeof a,c=t.toLowerCase();if(l===c)if("object"===c){if(!a||a instanceof r.ctor)return;C(3605,s,_t(r.ctor))}else"Number"!==t&&C(3606,e,s,t);else{if("function"===l)return;t===pe.default&&null==a?C(3607,s):C(3611,e,s,l)}delete r.type}}n.String=pe,n.CCString=pe;var ge=Object.freeze({__proto__:null,DELIMETER:re,createAttrsSingle:oe,createAttrs:ae,attr:le,getClassAttrs:ce,setClassAttr:he,PrimitiveType:_e,CCInteger:ue,CCFloat:me,CCBoolean:de,CCString:pe,getTypeChecker_ET:fe,getObjTypeChecker_ET:function(t){return function(e,i){fe("Object","type")(e,i);const s=ce(e)[`${i+re}default`],r=n.Class.getDefault(s);if(!Array.isArray(r)&&bt(t,n.ValueType)){const n=_t(t),r=ft('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',_t(e),i,n);s?u(r):C(3612,r,n,_t(e),i,n)}}}});const ye={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function ve(t,e,i,n){if(!t.get&&!t.set&&t.hasOwnProperty("default")){const s=`_N$${e}`;t.get=function(){return this[s]},t.set=function(t){const e=this[s];this[s]=t,i.call(this,e)};const r={};n[s]=r;for(const e in ye){const i=ye[e];t.hasOwnProperty(e)&&(r[e]=t[e],i.canUsedInGet||delete t[e])}}}function xe(t,e,i,s){if(Array.isArray(e)){if(!(e.length>0))return T(5508,i,s);t.type=e=e[0]}"function"==typeof e&&(e===String?t.type=n.String:e===Boolean?t.type=n.Boolean:e===Number&&(t.type=n.Float))}function Se(t,e,i){const n=t?{_short:!0}:{_short:!0,default:e};return i&&(n.type=i),n}function Ae(t,e){if(!t||t.constructor!==Object){if(Array.isArray(t)&&t.length>0)return Se(e,[],t);if("function"==typeof t){const i=t;return Se(e,bt(i,n.ValueType)?new i:null,i)}return Se(e,t instanceof _e?t.default:t)}return null}let Ce=[];function be(){return Ce[Ce.length-1]}n._RF={push:function(t,e,i,n){void 0===i&&(i=e,e=""),Ce.push({uuid:e,script:i,module:t,exports:t.exports,beh:null,importMeta:n})},pop:function(){const t=Ce.pop(),e=t.module;let i=e.exports;if(i===t.exports){for(const t in i)return;e.exports=i=t.cls}},peek:be};const Te=re,we={datas:null,push(t){if(this.datas)this.datas.push(t);else{this.datas=[t];const e=this;setTimeout((()=>{e.init()}),0)}},init(){const t=this.datas;if(t){for(let e=0;e<t.length;++e){const i=t[e],n=i.cls;let s=i.props;"function"==typeof s&&(s=s());const r=_t(n);s?Re(n,r,s,n.$super,i.mixins):T(3633,r)}this.datas=null}}};function Ee(t,e,i,n){!function(t,e){!function(t,e){t.indexOf(e)<0&&t.push(e)}(t.__props__,e)}(t,i),Oe(t,n,e,i)}function Pe(t,e,i,n){const s=n.get;n.set,s&&(Oe(t,n,e,i),he(t,i,"serializable",!1))}function Ie(t){return"function"==typeof t?t():t}function De(t,e,i){for(const n in e)t.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(t,n,yt(e,n))}function Re(t,e,i,n,s){if(t.__props__=[],n&&n.__props__&&(t.__props__=n.__props__.slice()),s)for(let e=0;e<s.length;++e){const i=s[e];i.__props__&&(t.__props__=t.__props__.concat(i.__props__.filter((e=>t.__props__.indexOf(e)<0))))}if(i){!function(t,e){for(const i in t){let n=t[i];const s=Ae(n,!1);if(s&&(n=t[i]=s),n){const s=n.notify;s&&ve(n,i,s,t),"type"in n&&xe(n,n.type,e,i)}}}(i,e);for(const n in i){const s=i[n];s.get||s.set?Pe(t,e,n,s):Ee(t,e,n,s)}}const r=ce(t);t.__values__=t.__props__.filter((t=>!1!==r[`${t+Te}serializable`]))}function Me(t){let e=t.name;const i=t.extends,s=t.mixins,r=function(t,e,i,s){const r=n.Component,o=be();if(o&&bt(e,r)){if(bt(o.cls,r))return T(3615),null;t=t||o.script}const a=function(t,e,i,n){const s=n.ctor,r=[s],o=s;ot(o,"__ctors__",r.length>0?r:null,!0);const a=o.prototype;if(e&&(o.$super=e),i){for(let t=i.length-1;t>=0;t--){const e=i[t];De(a,e.prototype),Me._isCCClass(e)&&De(ce(o),ce(e))}a.constructor=o}return Rt(t,o),o}(t,e,i,s);if(o)if(bt(e,r)){const t=o.uuid;t&&It(t,a),o.cls=a}else bt(o.cls,r)||(o.cls=a);return a}(e,i,s,t);e||(e=n.js.getClassName(r)),r._sealed=!0,i&&(i._sealed=!1);const o=t.properties;"function"==typeof o||i&&null===i.__props__||s&&s.some((t=>null===t.__props__))?(we.push({cls:r,props:o,mixins:s}),r.__props__=r.__values__=null):Re(r,e,o,i,t.mixins);const a=t.editor;return a&&bt(i,n.Component)&&n.Component._registerEditorProps(r,a),r}Me._isCCClass=function(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,"__ctors__")},Me.fastDefine=function(t,e,i){Rt(t,e);const n=e.__props__=e.__values__=Object.keys(i),s=ce(e);for(let t=0;t<n.length;t++){const e=n[t];s[`${e+Te}visible`]=!1,s[`${e+Te}default`]=i[e]}},Me.Attr=ge,Me.attr=le,Me.getInheritanceChain=function(t){const e=[];for(;t=Ct(t);)t!==Object&&e.push(t);return e};const Be={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Oe(t,e,i,n){let s=null,r="";function o(){return r=n+Te,s=ce(t)}"type"in e&&void 0===e.type&&C(3660,n,i);const a=e.type;a&&(Be[a]?(s||o())[`${r}type`]=a:"Object"===a||("object"==typeof a?Gt.isEnum(a)?((s||o())[`${r}type`]="Enum",s[`${r}enumList`]=Gt.getList(a)):Ut.isBitMask(a)&&((s||o())[`${r}type`]="BitMask",s[`${r}bitmaskList`]=Ut.getList(a)):"function"==typeof a&&((s||o())[`${r}type`]="Object",s[`${r}ctor`]=a))),"default"in e&&((s||o())[`${r}default`]=e.default);const l=(t,i)=>{if(t in e){const n=e[t];typeof n===i&&((s||o())[r+t]=n)}};var c;e.editorOnly&&((s||o())[`${r}editorOnly`]=!0),e.__noImplicit?(s||o())[`${r}serializable`]=null!==(c=e.serializable)&&void 0!==c&&c:!1===e.serializable&&((s||o())[`${r}serializable`]=!1),l("formerlySerializedAs","string");const h=e.range;h&&Array.isArray(h)&&h.length>=2&&((s||o())[`${r}min`]=h[0],s[`${r}max`]=h[1],h.length>2&&(s[`${r}step`]=h[2])),l("min","number"),l("max","number"),l("step","number")}Me.isArray=function(t){return t=Ie(t),Array.isArray(t)},Me.getDefault=Ie,Me.escapeForJS=function(t){return JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Me.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Me.getNewValueTypeCode=function(t){const e=_t(t),i=t.constructor;let n=`new ${e}(`;for(let e=0;e<i.__props__.length;e++)n+=t[i.__props__[e]],e<i.__props__.length-1&&(n+=",");return`${n})`},n.Class=Me;const Ne=Math.PI/180,Le=180/Math.PI,Fe=t("EPSILON",1e-6);function ze(t,e){return Math.abs(t-e)<=Fe*Math.max(1,Math.abs(t),Math.abs(e))}function Ve(t,e,i){return i=i||Fe,Math.abs(t-e)<=i}function Ue(t,e,i){if(e>i){const t=e;e=i,i=t}return t<e?e:t>i?i:t}function Ge(t){return t<0?0:t>1?1:t}function He(t,e,i){return t+(e-t)*i}function ke(t){return t*Ne}function je(t){return t*Le}const We=t("random",Math.random);function qe(t,e){return Math.random()*(e-t)+t}function Xe(t,e){return Math.floor(qe(t,e))}function Ye(t){return(t=(9301*t+49297)%233280)/233280}function Ke(t,e,i){return Ye(t)*(i-e)+e}function Je(t,e,i){return Math.floor(Ke(t,e,i))}function $e(t){return--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function Ze(t,e){return t-Math.floor(t/e)*e}function Qe(t,e){return t=Ze(t,2*e),e-Math.abs(t-e)}function ti(t,e,i){return(i-t)/(e-t)}function ei(t){return Math.abs(t.x)>Math.abs(t.y)?Math.abs(t.x)>Math.abs(t.z)?t.x:t.z:Math.abs(t.y)>Math.abs(t.z)?t.y:t.z}function ii(t,e){return Math.abs(t)>Math.abs(e)?t:e}const ni=1/255;class si extends Wt{static clone(t){const e=new si;return t._val?e._val=t._val:e._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,e}static copy(t,e){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t}static set(t,e,i,n,s){return t.r=e,t.g=i,t.b=n,t.a=s,t}static fromHEX(t,e){return e=0===e.indexOf("#")?e.substring(1):e,t.r=parseInt(e.substr(0,2),16)||0,t.g=parseInt(e.substr(2,2),16)||0,t.b=parseInt(e.substr(4,2),16)||0,t.a=parseInt(e.substr(6,2),16)||255,t._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,t}static add(t,e,i){return t.r=e.r+i.r,t.g=e.g+i.g,t.b=e.b+i.b,t.a=e.a+i.a,t}static subtract(t,e,i){return t.r=e.r-i.r,t.g=e.g-i.g,t.b=e.b-i.b,t.a=e.a-i.a,t}static multiply(t,e,i){return t.r=e.r*i.r,t.g=e.g*i.g,t.b=e.b*i.b,t.a=e.a*i.a,t}static divide(t,e,i){return t.r=e.r/i.r,t.g=e.g/i.g,t.b=e.b/i.b,t.a=e.a/i.a,t}static scale(t,e,i){return t.r=e.r*i,t.g=e.g*i,t.b=e.b*i,t.a=e.a*i,t}static lerp(t,e,i,n){let s=e.r,r=e.g,o=e.b,a=e.a;return s+=(i.r-s)*n,r+=(i.g-r)*n,o+=(i.b-o)*n,a+=(i.a-a)*n,t._val=Math.floor((a<<24>>>0)+(o<<16)+(r<<8)+s),t}static toArray(t,e,i=0){const n=e instanceof si||e.a>1?1/255:1;return t[i+0]=e.r*n,t[i+1]=e.g*n,t[i+2]=e.b*n,t[i+3]=e.a*n,t}static fromArray(t,e,i=0){return e.r=255*t[i+0],e.g=255*t[i+1],e.b=255*t[i+2],e.a=255*t[i+3],e}static strictEquals(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a}static equals(t,e,i=Fe){return Math.abs(t.r-e.r)<=i*Math.max(1,Math.abs(t.r),Math.abs(e.r))&&Math.abs(t.g-e.g)<=i*Math.max(1,Math.abs(t.g),Math.abs(e.g))&&Math.abs(t.b-e.b)<=i*Math.max(1,Math.abs(t.b),Math.abs(e.b))&&Math.abs(t.a-e.a)<=i*Math.max(1,Math.abs(t.a),Math.abs(e.a))}static hex(t){return(255*t.r<<24|255*t.g<<16|255*t.b<<8|255*t.a)>>>0}get r(){return 255&this._val}set r(t){t=~~Ue(t,0,255),this._val=(4294967040&this._val|t)>>>0}get g(){return(65280&this._val)>>8}set g(t){t=~~Ue(t,0,255),this._val=(4294902015&this._val|t<<8)>>>0}get b(){return(16711680&this._val)>>16}set b(t){t=~~Ue(t,0,255),this._val=(4278255615&this._val|t<<16)>>>0}get a(){return(4278190080&this._val)>>>24}set a(t){t=~~Ue(t,0,255),this._val=(16777215&this._val|t<<24)>>>0}get x(){return this.r*ni}set x(t){this.r=255*t}get y(){return this.g*ni}set y(t){this.g=255*t}get z(){return this.b*ni}set z(t){this.b=255*t}get w(){return this.a*ni}set w(t){this.a=255*t}constructor(t,e,i,n){super(),this._val=0,"string"==typeof t?this.fromHEX(t):void 0!==e?this.set(t,e,i,n):this.set(t)}clone(){const t=new si;return t._val=this._val,t}equals(t){return t&&this._val===t._val}lerp(t,e){let i=this.r,n=this.g,s=this.b,r=this.a;return i+=(t.r-i)*e,n+=(t.g-n)*e,s+=(t.b-s)*e,r+=(t.a-r)*e,this._val=Math.floor((r<<24>>>0)+(s<<16)+(n<<8)+i),this}toString(){return`rgba(${this.r.toFixed()}, ${this.g.toFixed()}, ${this.b.toFixed()}, ${this.a.toFixed()})`}toCSS(t="rgba"){return"rgba"===t?`rgba(${this.r},${this.g},${this.b},${(this.a*ni).toFixed(2)})`:"rgb"===t?`rgb(${this.r},${this.g},${this.b})`:`#${this.toHEX(t)}`}fromHEX(t){t=0===t.indexOf("#")?t.substring(1):t;const e=parseInt(t.substr(0,2),16)||0,i=parseInt(t.substr(2,2),16)||0,n=parseInt(t.substr(4,2),16)||0,s=parseInt(t.substr(6,2),16)||255;return this._val=(s<<24>>>0)+(n<<16)+(i<<8)+(0|e),this}toHEX(t="#rrggbb"){const e="0",i=[(this.r<16?e:"")+this.r.toString(16),(this.g<16?e:"")+this.g.toString(16),(this.b<16?e:"")+this.b.toString(16)];return"#rgb"===t?(i[0]=i[0][0],i[1]=i[1][0],i[2]=i[2][0]):"#rrggbbaa"===t&&i.push((this.a<16?e:"")+this.a.toString(16)),i.join("")}toRGBValue(){return 16777215&this._val}fromHSV(t,e,i){let n=0,s=0,r=0;if(0===e)n=s=r=i;else if(0===i)n=s=r=0;else{1===t&&(t=0),t*=6;const o=Math.floor(t),a=t-o,l=i*(1-e),c=i*(1-e*a),h=i*(1-e*(1-a));switch(o){case 0:n=i,s=h,r=l;break;case 1:n=c,s=i,r=l;break;case 2:n=l,s=i,r=h;break;case 3:n=l,s=c,r=i;break;case 4:n=h,s=l,r=i;break;case 5:n=i,s=l,r=c}}return n*=255,s*=255,r*=255,this._val=(this.a<<24>>>0)+(r<<16)+(s<<8)+(0|n),this}toHSV(){const t=this.r*ni,e=this.g*ni,i=this.b*ni,n={h:0,s:0,v:0},s=Math.max(t,e,i),r=Math.min(t,e,i);let o=0;return n.v=s,n.s=s?(s-r)/s:0,n.s?(o=s-r,n.h=t===s?(e-i)/o:e===s?2+(i-t)/o:4+(t-e)/o,n.h/=6,n.h<0&&(n.h+=1)):n.h=0,n}set(t,e,i,n){return"object"==typeof t?null!=t._val?this._val=t._val:(e=t.g||0,i=t.b||0,n="number"==typeof t.a?t.a:255,t=t.r||0,this._val=(n<<24>>>0)+(i<<16)+(e<<8)+(0|t)):(t=t||0,e=e||0,i=i||0,n="number"==typeof n?n:255,this._val=(n<<24>>>0)+(i<<16)+(e<<8)+(0|t)),this}multiply(t){const e=(255&this._val)*t.r>>8,i=(65280&this._val)*t.g>>8,n=(16711680&this._val)*t.b>>8,s=((4278190080&this._val)>>>8)*t.a;return this._val=4278190080&s|16711680&n|65280&i|255&e,this}_set_r_unsafe(t){return this._val=(4294967040&this._val|t)>>>0,this}_set_g_unsafe(t){return this._val=(4294902015&this._val|t<<8)>>>0,this}_set_b_unsafe(t){return this._val=(4278255615&this._val|t<<16)>>>0,this}_set_a_unsafe(t){return this._val=(16777215&this._val|t<<24)>>>0,this}}function ri(t,e,i,n){return new si(t,e,i,n)}t("Color",si),si.WHITE=Object.freeze(new si(255,255,255,255)),si.GRAY=Object.freeze(new si(127,127,127,255)),si.BLACK=Object.freeze(new si(0,0,0,255)),si.TRANSPARENT=Object.freeze(new si(0,0,0,0)),si.RED=Object.freeze(new si(255,0,0,255)),si.GREEN=Object.freeze(new si(0,255,0,255)),si.BLUE=Object.freeze(new si(0,0,255,255)),si.CYAN=Object.freeze(new si(0,255,255,255)),si.MAGENTA=Object.freeze(new si(255,0,255,255)),si.YELLOW=Object.freeze(new si(255,255,0,255)),Me.fastDefine("cc.Color",si,{r:0,g:0,b:0,a:255}),n.Color=si,n.color=ri;class oi extends Wt{static zero(t){return t.x=0,t.y=0,t.z=0,t}static clone(t){return new oi(t.x,t.y,t.z)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t}static set(t,e,i,n){return t.x=e,t.y=i,t.z=n,t}static add(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t.z=e.z+i.z,t}static subtract(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t.z=e.z-i.z,t}static multiply(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t.z=e.z*i.z,t}static divide(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t.z=e.z/i.z,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t}static min(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t.z=Math.min(e.z,i.z),t}static max(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t.z=Math.max(e.z,i.z),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t}static scaleAndAdd(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t}static distance(t,e){const i=e.x-t.x,n=e.y-t.y,s=e.z-t.z;return Math.sqrt(i*i+n*n+s*s)}static squaredDistance(t,e){const i=e.x-t.x,n=e.y-t.y,s=e.z-t.z;return i*i+n*n+s*s}static len(t){const e=t.x,i=t.y,n=t.z;return Math.sqrt(e*e+i*i+n*n)}static lengthSqr(t){const e=t.x,i=t.y,n=t.z;return e*e+i*i+n*n}static negate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t}static invert(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t}static invertSafe(t,e){const i=e.x,n=e.y,s=e.z;return Math.abs(i)<Fe?t.x=0:t.x=1/i,Math.abs(n)<Fe?t.y=0:t.y=1/n,Math.abs(s)<Fe?t.z=0:t.z=1/s,t}static normalize(t,e){const i=e.x,n=e.y,s=e.z;let r=i*i+n*n+s*s;return r>0&&(r=1/Math.sqrt(r),t.x=i*r,t.y=n*r,t.z=s*r),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static cross(t,e,i){const{x:n,y:s,z:r}=e,{x:o,y:a,z:l}=i;return t.x=s*l-r*a,t.y=r*o-n*l,t.z=n*a-s*o,t}static lerp(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t}static random(t,e){e=e||1;const i=2*We()*Math.PI,n=2*We()-1,s=Math.sqrt(1-n*n);return t.x=s*Math.cos(i)*e,t.y=s*Math.sin(i)*e,t.z=n*e,t}static transformMat4(t,e,i){const n=e.x,s=e.y,r=e.z;let o=i.m03*n+i.m07*s+i.m11*r+i.m15;return o=o?Math.abs(1/o):1,t.x=(i.m00*n+i.m04*s+i.m08*r+i.m12)*o,t.y=(i.m01*n+i.m05*s+i.m09*r+i.m13)*o,t.z=(i.m02*n+i.m06*s+i.m10*r+i.m14)*o,t}static transformMat4Normal(t,e,i){const n=e.x,s=e.y,r=e.z;let o=i.m03*n+i.m07*s+i.m11*r;return o=o?Math.abs(1/o):1,t.x=(i.m00*n+i.m04*s+i.m08*r)*o,t.y=(i.m01*n+i.m05*s+i.m09*r)*o,t.z=(i.m02*n+i.m06*s+i.m10*r)*o,t}static transformMat3(t,e,i){const n=e.x,s=e.y,r=e.z;return t.x=n*i.m00+s*i.m03+r*i.m06,t.y=n*i.m01+s*i.m04+r*i.m07,t.z=n*i.m02+s*i.m05+r*i.m08,t}static transformAffine(t,e,i){const n=e.x,s=e.y,r=e.z;return t.x=i.m00*n+i.m04*s+i.m08*r+i.m12,t.y=i.m01*n+i.m05*s+i.m09*r+i.m13,t.x=i.m02*n+i.m06*s+i.m10*r+i.m14,t}static transformQuat(t,e,i){const n=i.w*e.x+i.y*e.z-i.z*e.y,s=i.w*e.y+i.z*e.x-i.x*e.z,r=i.w*e.z+i.x*e.y-i.y*e.x,o=-i.x*e.x-i.y*e.y-i.z*e.z;return t.x=n*i.w+o*-i.x+s*-i.z-r*-i.y,t.y=s*i.w+o*-i.y+r*-i.x-n*-i.z,t.z=r*i.w+o*-i.z+n*-i.y-s*-i.x,t}static transformRTS(t,e,i,n,s){const r=e.x*s.x,o=e.y*s.y,a=e.z*s.z,l=i.w*r+i.y*a-i.z*o,c=i.w*o+i.z*r-i.x*a,h=i.w*a+i.x*o-i.y*r,_=-i.x*r-i.y*o-i.z*a;return t.x=l*i.w+_*-i.x+c*-i.z-h*-i.y+n.x,t.y=c*i.w+_*-i.y+h*-i.x-l*-i.z+n.y,t.z=h*i.w+_*-i.z+l*-i.y-c*-i.x+n.z,t}static transformInverseRTS(t,e,i,n,s){const r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,l=i.w*r-i.y*a+i.z*o,c=i.w*o-i.z*r+i.x*a,h=i.w*a-i.x*o+i.y*r,_=i.x*r+i.y*o+i.z*a;return t.x=(l*i.w+_*i.x+c*i.z-h*i.y)/s.x,t.y=(c*i.w+_*i.y+h*i.x-l*i.z)/s.y,t.z=(h*i.w+_*i.z+l*i.y-c*i.x)/s.z,t}static rotateX(t,e,i,n){const s=e.x-i.x,r=e.y-i.y,o=e.z-i.z,a=Math.cos(n),l=Math.sin(n),c=s,h=r*a-o*l,_=r*l+o*a;return t.x=c+i.x,t.y=h+i.y,t.z=_+i.z,t}static rotateY(t,e,i,n){const s=e.x-i.x,r=e.y-i.y,o=e.z-i.z,a=Math.cos(n),l=Math.sin(n),c=o*l+s*a,h=r,_=o*a-s*l;return t.x=c+i.x,t.y=h+i.y,t.z=_+i.z,t}static rotateZ(t,e,i,n){const s=e.x-i.x,r=e.y-i.y,o=e.z-i.z,a=Math.cos(n),l=Math.sin(n),c=s*a-r*l,h=s*l+r*a,_=o;return t.x=c+i.x,t.y=h+i.y,t.z=_+i.z,t}static toArray(t,e,i=0){return t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t}static fromArray(t,e,i=0){return t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z}static equals(t,e,i=Fe){const{x:n,y:s,z:r}=t,{x:o,y:a,z:l}=e;return Math.abs(n-o)<=i*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(s-a)<=i*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(r-l)<=i*Math.max(1,Math.abs(r),Math.abs(l))}static angle(t,e){oi.normalize(ai,t),oi.normalize(li,e);const i=oi.dot(ai,li);return i>1?0:i<-1?Math.PI:Math.acos(i)}static projectOnPlane(t,e,i){return oi.subtract(t,e,oi.project(t,e,i))}static project(t,e,i){const n=oi.lengthSqr(i);return n<1e-6?oi.set(t,0,0,0):oi.multiplyScalar(t,i,oi.dot(e,i)/n)}constructor(t,e,i){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=i||0)}clone(){return new oi(this.x,this.y,this.z)}set(t,e,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=i||0),this}equals(t,e=Fe){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))}equals3f(t,e,i,n=Fe){return Math.abs(this.x-t)<=n*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=n*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-i)<=n*Math.max(1,Math.abs(this.z),Math.abs(i))}strictEquals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}strictEquals3f(t,e,i){return this.x===t&&this.y===e&&this.z===i}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.z.toFixed(2)})`}lerp(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}add3f(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this}subtract(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subtract3f(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this}multiply(t){return"object"!=typeof t&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiply3f(t,e,i){return this.x*=t,this.y*=e,this.z*=i,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divide3f(t,e,i){return this.x/=t,this.y/=e,this.z/=i,this}negative(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}clampf(t,e){return this.x=Ue(this.x,t.x,e.x),this.y=Ue(this.y,t.y,e.y),this.z=Ue(this.z,t.z,e.z),this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){const{x:e,y:i,z:n}=this,{x:s,y:r,z:o}=t;return this.x=i*o-n*r,this.y=n*s-e*o,this.z=e*r-i*s,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSqr(){return this.x*this.x+this.y*this.y+this.z*this.z}normalize(){const t=this.x,e=this.y,i=this.z;let n=t*t+e*e+i*i;return n>0&&(n=1/Math.sqrt(n),this.x=t*n,this.y=e*n,this.z=i*n),this}transformMat4(t){const e=this.x,i=this.y,n=this.z;let s=t.m03*e+t.m07*i+t.m11*n+t.m15;return s=s?1/s:1,this.x=(t.m00*e+t.m04*i+t.m08*n+t.m12)*s,this.y=(t.m01*e+t.m05*i+t.m09*n+t.m13)*s,this.z=(t.m02*e+t.m06*i+t.m10*n+t.m14)*s,this}}t("Vec3",oi),oi.UNIT_X=Object.freeze(new oi(1,0,0)),oi.UNIT_Y=Object.freeze(new oi(0,1,0)),oi.UNIT_Z=Object.freeze(new oi(0,0,1)),oi.RIGHT=Object.freeze(new oi(1,0,0)),oi.UP=Object.freeze(new oi(0,1,0)),oi.FORWARD=Object.freeze(new oi(0,0,-1)),oi.ZERO=Object.freeze(new oi(0,0,0)),oi.ONE=Object.freeze(new oi(1,1,1)),oi.NEG_ONE=Object.freeze(new oi(-1,-1,-1));const ai=new oi,li=new oi;function ci(t,e,i){return new oi(t,e,i)}Me.fastDefine("cc.Vec3",oi,{x:0,y:0,z:0}),n.Vec3=oi,n.v3=ci;class hi extends Wt{static clone(t){return new hi(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)}static copy(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t}static set(t,e,i,n,s,r,o,a,l,c){return t.m00=e,t.m01=i,t.m02=n,t.m03=s,t.m04=r,t.m05=o,t.m06=a,t.m07=l,t.m08=c,t}static identity(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static transpose(t,e){if(t===e){const i=e.m01,n=e.m02,s=e.m05;t.m01=e.m03,t.m02=e.m06,t.m03=i,t.m05=e.m07,t.m06=n,t.m07=s}else t.m00=e.m00,t.m01=e.m03,t.m02=e.m06,t.m03=e.m01,t.m04=e.m04,t.m05=e.m07,t.m06=e.m02,t.m07=e.m05,t.m08=e.m08;return t}static invert(t,e){const i=e.m00,n=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,l=e.m06,c=e.m07,h=e.m08,_=h*o-a*c,u=-h*r+a*l,m=c*r-o*l;let d=i*_+n*u+s*m;return 0===d?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t):(d=1/d,t.m00=_*d,t.m01=(-h*n+s*c)*d,t.m02=(a*n-s*o)*d,t.m03=u*d,t.m04=(h*i-s*l)*d,t.m05=(-a*i+s*r)*d,t.m06=m*d,t.m07=(-c*i+n*l)*d,t.m08=(o*i-n*r)*d,t)}static determinant(t){const e=t.m00,i=t.m01,n=t.m02,s=t.m03,r=t.m04,o=t.m05,a=t.m06,l=t.m07,c=t.m08;return e*(c*r-o*l)+i*(-c*s+o*a)+n*(l*s-r*a)}static multiply(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,l=e.m05,c=e.m06,h=e.m07,_=e.m08,u=i.m00,m=i.m01,d=i.m02,p=i.m03,f=i.m04,g=i.m05,y=i.m06,v=i.m07,x=i.m08;return t.m00=u*n+m*o+d*c,t.m01=u*s+m*a+d*h,t.m02=u*r+m*l+d*_,t.m03=p*n+f*o+g*c,t.m04=p*s+f*a+g*h,t.m05=p*r+f*l+g*_,t.m06=y*n+v*o+x*c,t.m07=y*s+v*a+x*h,t.m08=y*r+v*l+x*_,t}static multiplyMat4(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,l=e.m05,c=e.m06,h=e.m07,_=e.m08,u=i.m00,m=i.m01,d=i.m02,p=i.m04,f=i.m05,g=i.m06,y=i.m08,v=i.m09,x=i.m10;return t.m00=u*n+m*o+d*c,t.m01=u*s+m*a+d*h,t.m02=u*r+m*l+d*_,t.m03=p*n+f*o+g*c,t.m04=p*s+f*a+g*h,t.m05=p*r+f*l+g*_,t.m06=y*n+v*o+x*c,t.m07=y*s+v*a+x*h,t.m08=y*r+v*l+x*_,t}static transform(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,l=e.m05,c=e.m06,h=e.m07,_=e.m08,u=i.x,m=i.y;return t.m00=n,t.m01=s,t.m02=r,t.m03=o,t.m04=a,t.m05=l,t.m06=u*n+m*o+c,t.m07=u*s+m*a+h,t.m08=u*r+m*l+_,t}static scale(t,e,i){const n=i.x,s=i.y;return t.m00=n*e.m00,t.m01=n*e.m01,t.m02=n*e.m02,t.m03=s*e.m03,t.m04=s*e.m04,t.m05=s*e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t}static rotate(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,l=e.m05,c=e.m06,h=e.m07,_=e.m08,u=Math.sin(i),m=Math.cos(i);return t.m00=m*n+u*o,t.m01=m*s+u*a,t.m02=m*r+u*l,t.m03=m*o-u*n,t.m04=m*a-u*s,t.m05=m*l-u*r,t.m06=c,t.m07=h,t.m08=_,t}static fromMat4(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m04,t.m04=e.m05,t.m05=e.m06,t.m06=e.m08,t.m07=e.m09,t.m08=e.m10,t}static fromViewUp(t,e,i){return oi.lengthSqr(e)<Fe*Fe?(hi.identity(t),t):(i=i||oi.UNIT_Y,oi.normalize(_i,oi.cross(_i,i,e)),oi.lengthSqr(_i)<Fe*Fe?(hi.identity(t),t):(oi.cross(ui,e,_i),hi.set(t,_i.x,_i.y,_i.z,ui.x,ui.y,ui.z,e.x,e.y,e.z),t))}static fromTranslation(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=e.x,t.m07=e.y,t.m08=1,t}static fromScaling(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=e.y,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static fromRotation(t,e){const i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=i,t.m02=0,t.m03=-i,t.m04=n,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static fromQuat(t,e){const i=e.x,n=e.y,s=e.z,r=e.w,o=i+i,a=n+n,l=s+s,c=i*o,h=n*o,_=n*a,u=s*o,m=s*a,d=s*l,p=r*o,f=r*a,g=r*l;return t.m00=1-_-d,t.m03=h-g,t.m06=u+f,t.m01=h+g,t.m04=1-c-d,t.m07=m-p,t.m02=u-f,t.m05=m+p,t.m08=1-c-_,t}static inverseTransposeMat4(t,e){const i=e.m00,n=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,l=e.m06,c=e.m07,h=e.m08,_=e.m09,u=e.m10,m=e.m11,d=e.m12,p=e.m13,f=e.m14,g=e.m15,y=i*a-n*o,v=i*l-s*o,x=i*c-r*o,S=n*l-s*a,A=n*c-r*a,C=s*c-r*l,b=h*p-_*d,T=h*f-u*d,w=h*g-m*d,E=_*f-u*p,P=_*g-m*p,I=u*g-m*f;let D=y*I-v*P+x*E+S*w-A*T+C*b;return D?(D=1/D,t.m00=(a*I-l*P+c*E)*D,t.m01=(l*w-o*I-c*T)*D,t.m02=(o*P-a*w+c*b)*D,t.m03=(s*P-n*I-r*E)*D,t.m04=(i*I-s*w+r*T)*D,t.m05=(n*w-i*P-r*b)*D,t.m06=(p*C-f*A+g*S)*D,t.m07=(f*x-d*C-g*v)*D,t.m08=(d*A-p*x+g*y)*D,t):null}static toArray(t,e,i=0){return t[i+0]=e.m00,t[i+1]=e.m01,t[i+2]=e.m02,t[i+3]=e.m03,t[i+4]=e.m04,t[i+5]=e.m05,t[i+6]=e.m06,t[i+7]=e.m07,t[i+8]=e.m08,t}static fromArray(t,e,i=0){return t.m00=e[i+0],t.m01=e[i+1],t.m02=e[i+2],t.m03=e[i+3],t.m04=e[i+4],t.m05=e[i+5],t.m06=e[i+6],t.m07=e[i+7],t.m08=e[i+8],t}static add(t,e,i){return t.m00=e.m00+i.m00,t.m01=e.m01+i.m01,t.m02=e.m02+i.m02,t.m03=e.m03+i.m03,t.m04=e.m04+i.m04,t.m05=e.m05+i.m05,t.m06=e.m06+i.m06,t.m07=e.m07+i.m07,t.m08=e.m08+i.m08,t}static subtract(t,e,i){return t.m00=e.m00-i.m00,t.m01=e.m01-i.m01,t.m02=e.m02-i.m02,t.m03=e.m03-i.m03,t.m04=e.m04-i.m04,t.m05=e.m05-i.m05,t.m06=e.m06-i.m06,t.m07=e.m07-i.m07,t.m08=e.m08-i.m08,t}static multiplyScalar(t,e,i){return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*i,t.m05=e.m05*i,t.m06=e.m06*i,t.m07=e.m07*i,t.m08=e.m08*i,t}static multiplyScalarAndAdd(t,e,i,n){return t.m00=i.m00*n+e.m00,t.m01=i.m01*n+e.m01,t.m02=i.m02*n+e.m02,t.m03=i.m03*n+e.m03,t.m04=i.m04*n+e.m04,t.m05=i.m05*n+e.m05,t.m06=i.m06*n+e.m06,t.m07=i.m07*n+e.m07,t.m08=i.m08*n+e.m08,t}static strictEquals(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08}static equals(t,e,i=Fe){return Math.abs(t.m00-e.m00)<=i*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=i*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=i*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=i*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=i*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=i*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=i*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=i*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=i*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))}constructor(t=1,e=0,i=0,n=0,s=1,r=0,o=0,a=0,l=1){super(),"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08):(this.m00=t,this.m01=e,this.m02=i,this.m03=n,this.m04=s,this.m05=r,this.m06=o,this.m07=a,this.m08=l)}clone(){const t=this;return new hi(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)}set(t=1,e=0,i=0,n=0,s=1,r=0,o=0,a=0,l=1){return"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08):(this.m00=t,this.m01=e,this.m02=i,this.m03=n,this.m04=s,this.m05=r,this.m06=o,this.m07=a,this.m08=l),this}equals(t,e=Fe){return Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))}strictEquals(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08}toString(){const t=this;return`[\n${t.m00}, ${t.m01}, ${t.m02},\n${t.m03},\n${t.m04}, ${t.m05},\n${t.m06}, ${t.m07},\n${t.m08}\n]`}identity(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this}transpose(){const t=this.m01,e=this.m02,i=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=t,this.m05=this.m07,this.m06=e,this.m07=i,this}invert(){const t=this.m00,e=this.m01,i=this.m02,n=this.m03,s=this.m04,r=this.m05,o=this.m06,a=this.m07,l=this.m08,c=l*s-r*a,h=-l*n+r*o,_=a*n-s*o;let u=t*c+e*h+i*_;return 0===u?(this.set(0,0,0,0,0,0,0,0,0),this):(u=1/u,this.m00=c*u,this.m01=(-l*e+i*a)*u,this.m02=(r*e-i*s)*u,this.m03=h*u,this.m04=(l*t-i*o)*u,this.m05=(-r*t+i*n)*u,this.m06=_*u,this.m07=(-a*t+e*o)*u,this.m08=(s*t-e*n)*u,this)}determinant(){const t=this.m00,e=this.m01,i=this.m02,n=this.m03,s=this.m04,r=this.m05,o=this.m06,a=this.m07,l=this.m08;return t*(l*s-r*a)+e*(-l*n+r*o)+i*(a*n-s*o)}add(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this}subtract(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this}multiply(t){const e=this.m00,i=this.m01,n=this.m02,s=this.m03,r=this.m04,o=this.m05,a=this.m06,l=this.m07,c=this.m08,h=t.m00,_=t.m01,u=t.m02,m=t.m03,d=t.m04,p=t.m05,f=t.m06,g=t.m07,y=t.m08;return this.m00=h*e+_*s+u*a,this.m01=h*i+_*r+u*l,this.m02=h*n+_*o+u*c,this.m03=m*e+d*s+p*a,this.m04=m*i+d*r+p*l,this.m05=m*n+d*o+p*c,this.m06=f*e+g*s+y*a,this.m07=f*i+g*r+y*l,this.m08=f*n+g*o+y*c,this}multiplyScalar(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this}scale(t){const e=t.x,i=t.y;return this.m00=e*this.m00,this.m01=e*this.m01,this.m02=e*this.m02,this.m03=i*this.m03,this.m04=i*this.m04,this.m05=i*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this}rotate(t){const e=this.m00,i=this.m01,n=this.m02,s=this.m03,r=this.m04,o=this.m05,a=this.m06,l=this.m07,c=this.m08,h=Math.sin(t),_=Math.cos(t);return this.m00=_*e+h*s,this.m01=_*i+h*r,this.m02=_*n+h*o,this.m03=_*s-h*e,this.m04=_*r-h*i,this.m05=_*o-h*n,this.m06=a,this.m07=l,this.m08=c,this}fromQuat(t){const e=t.x,i=t.y,n=t.z,s=t.w,r=e+e,o=i+i,a=n+n,l=e*r,c=i*r,h=i*o,_=n*r,u=n*o,m=n*a,d=s*r,p=s*o,f=s*a;return this.m00=1-h-m,this.m03=c-f,this.m06=_+p,this.m01=c+f,this.m04=1-l-m,this.m07=u-d,this.m02=_-p,this.m05=u+d,this.m08=1-l-h,this}}t("Mat3",hi),hi.IDENTITY=Object.freeze(new hi);const _i=new oi,ui=new oi;Me.fastDefine("cc.Mat3",hi,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),n.Mat3=hi;class mi extends Wt{static clone(t){return new mi(t.x,t.y,t.z,t.w)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}static set(t,e,i,n,s){return t.x=e,t.y=i,t.z=n,t.w=s,t}static identity(t){return t.x=0,t.y=0,t.z=0,t.w=1,t}static rotationTo(t,e,i){const n=oi.dot(e,i);return n<-.999999?(oi.cross(fi,oi.UNIT_X,e),fi.length()<1e-6&&oi.cross(fi,oi.UNIT_Y,e),oi.normalize(fi,fi),mi.fromAxisAngle(t,fi,Math.PI),t):n>.999999?(t.x=0,t.y=0,t.z=0,t.w=1,t):(oi.cross(fi,e,i),t.x=fi.x,t.y=fi.y,t.z=fi.z,t.w=1+n,mi.normalize(t,t))}static getAxisAngle(t,e){const i=2*Math.acos(e.w),n=Math.sin(i/2);return 0!==n?(t.x=e.x/n,t.y=e.y/n,t.z=e.z/n):(t.x=1,t.y=0,t.z=0),i}static multiply(t,e,i){const n=e.x*i.w+e.w*i.x+e.y*i.z-e.z*i.y,s=e.y*i.w+e.w*i.y+e.z*i.x-e.x*i.z,r=e.z*i.w+e.w*i.z+e.x*i.y-e.y*i.x,o=e.w*i.w-e.x*i.x-e.y*i.y-e.z*i.z;return t.x=n,t.y=s,t.z=r,t.w=o,t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i,t}static scaleAndAdd(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t.w=e.w+i.w*n,t}static rotateX(t,e,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:r,y:o,z:a,w:l}=e;return t.x=r*s+l*n,t.y=o*s+a*n,t.z=a*s-o*n,t.w=l*s-r*n,t}static rotateY(t,e,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:r,y:o,z:a,w:l}=e;return t.x=r*s-a*n,t.y=o*s+l*n,t.z=a*s+r*n,t.w=l*s-o*n,t}static rotateZ(t,e,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:r,y:o,z:a,w:l}=e;return t.x=r*s+o*n,t.y=o*s-r*n,t.z=a*s+l*n,t.w=l*s-a*n,t}static rotateAround(t,e,i,n){return mi.invert(di,e),oi.transformQuat(fi,i,di),mi.fromAxisAngle(di,fi,n),mi.multiply(t,e,di),t}static rotateAroundLocal(t,e,i,n){return mi.fromAxisAngle(di,i,n),mi.multiply(t,e,di),t}static calculateW(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=Math.sqrt(Math.abs(1-e.x*e.x-e.y*e.y-e.z*e.z)),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static lerp(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t.w=e.w+n*(i.w-e.w),t}static slerp(t,e,i,n){let s=0,r=0,o=i.x,a=i.y,l=i.z,c=i.w,h=e.x*i.x+e.y*i.y+e.z*i.z+e.w*i.w;if(h<0&&(h=-h,o=-o,a=-a,l=-l,c=-c),1-h>1e-6){const t=Math.acos(h),e=Math.sin(t);s=Math.sin((1-n)*t)/e,r=Math.sin(n*t)/e}else s=1-n,r=n;return t.x=s*e.x+r*o,t.y=s*e.y+r*a,t.z=s*e.z+r*l,t.w=s*e.w+r*c,t}static sqlerp(t,e,i,n,s,r){return mi.slerp(di,e,s,r),mi.slerp(pi,i,n,r),mi.slerp(t,di,pi,2*r*(1-r)),t}static invert(t,e){const i=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w,n=i?1/i:0;return t.x=-e.x*n,t.y=-e.y*n,t.z=-e.z*n,t.w=e.w*n,t}static conjugate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w,t}static len(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w)}static lengthSqr(t){return t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w}static normalize(t,e){let i=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;return i>0&&(i=1/Math.sqrt(i),t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i),t}static fromAxes(t,e,i,n){return hi.set(gi,e.x,e.y,e.z,i.x,i.y,i.z,n.x,n.y,n.z),mi.normalize(t,mi.fromMat3(t,gi))}static fromViewUp(t,e,i){return hi.fromViewUp(gi,e,i),mi.normalize(t,mi.fromMat3(t,gi))}static fromAxisAngle(t,e,i){i*=.5;const n=Math.sin(i);return t.x=n*e.x,t.y=n*e.y,t.z=n*e.z,t.w=Math.cos(i),t}static fromMat3(t,e){const{m00:i,m03:n,m06:s,m01:r,m04:o,m07:a,m02:l,m05:c,m08:h}=e,_=i+o+h;if(_>0){const e=.5/Math.sqrt(_+1);t.w=.25/e,t.x=(c-a)*e,t.y=(s-l)*e,t.z=(r-n)*e}else if(i>o&&i>h){const e=2*Math.sqrt(1+i-o-h);t.w=(c-a)/e,t.x=.25*e,t.y=(n+r)/e,t.z=(s+l)/e}else if(o>h){const e=2*Math.sqrt(1+o-i-h);t.w=(s-l)/e,t.x=(n+r)/e,t.y=.25*e,t.z=(a+c)/e}else{const e=2*Math.sqrt(1+h-i-o);t.w=(r-n)/e,t.x=(s+l)/e,t.y=(a+c)/e,t.z=.25*e}return t}static fromEuler(t,e,i,n){e*=yi,i*=yi,n*=yi;const s=Math.sin(e),r=Math.cos(e),o=Math.sin(i),a=Math.cos(i),l=Math.sin(n),c=Math.cos(n);return t.x=s*a*c+r*o*l,t.y=r*o*c+s*a*l,t.z=r*a*l-s*o*c,t.w=r*a*c-s*o*l,t}static fromAngleZ(t,e){return e*=yi,t.x=t.y=0,t.z=Math.sin(e),t.w=Math.cos(e),t}static toAxisX(t,e){const i=2*e.y,n=2*e.z;return t.x=1-i*e.y-n*e.z,t.y=i*e.x+n*e.w,t.z=n*e.x+i*e.w,t}static toAxisY(t,e){const i=2*e.x,n=2*e.y,s=2*e.z;return t.x=n*e.x-s*e.w,t.y=1-i*e.x-s*e.z,t.z=s*e.y+i*e.w,t}static toAxisZ(t,e){const i=2*e.x,n=2*e.y,s=2*e.z;return t.x=s*e.x-n*e.w,t.y=s*e.y-i*e.w,t.z=1-i*e.x-n*e.y,t}static toEuler(t,e,i){const{x:n,y:s,z:r,w:o}=e;let a=0,l=0,c=0;const h=n*s+r*o;if(h>.499999)a=0,l=je(2*Math.atan2(n,o)),c=90;else if(h<-.499999)a=0,l=-je(2*Math.atan2(n,o)),c=-90;else{const t=n*n,e=s*s,_=r*r;a=je(Math.atan2(2*n*o-2*s*r,1-2*t-2*_)),l=je(Math.atan2(2*s*o-2*n*r,1-2*e-2*_)),c=je(Math.asin(2*h)),i&&(a=-180*Math.sign(a+1e-6)+a,l=-180*Math.sign(l+1e-6)+l,c=180*Math.sign(c+1e-6)-c)}return t.x=a,t.y=l,t.z=c,t}static toArray(t,e,i=0){return t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t[i+3]=e.w,t}static fromArray(t,e,i=0){return t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t.w=e[i+3],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w}static equals(t,e,i=Fe){return Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=i*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=i*Math.max(1,Math.abs(t.w),Math.abs(e.w))}constructor(t,e,i,n){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=null!=n?n:1)}clone(){return new mi(this.x,this.y,this.z,this.w)}set(t,e,i,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=null!=n?n:1),this}equals(t,e=Fe){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))}strictEquals(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}getEulerAngles(t){return mi.toEuler(t,this)}lerp(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this.w+=e*(t.w-this.w),this}slerp(t,e){return mi.slerp(this,this,t,e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSqr(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}}t("Quat",mi),mi.IDENTITY=Object.freeze(new mi);const di=new mi,pi=new mi,fi=new oi,gi=new hi,yi=.5*Math.PI/180;function vi(t=0,e=0,i=0,n=1){return new mi(t,e,i,n)}Me.fastDefine("cc.Quat",mi,{x:0,y:0,z:0,w:1}),n.Quat=mi,n.quat=vi;const xi=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]);class Si extends Wt{static clone(t){return new Si(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)}static copy(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t}static set(t,e,i,n,s,r,o,a,l,c,h,_,u,m,d,p,f){return t.m00=e,t.m01=i,t.m02=n,t.m03=s,t.m04=r,t.m05=o,t.m06=a,t.m07=l,t.m08=c,t.m09=h,t.m10=_,t.m11=u,t.m12=m,t.m13=d,t.m14=p,t.m15=f,t}static identity(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static transpose(t,e){if(t===e){const i=e.m01,n=e.m02,s=e.m03,r=e.m06,o=e.m07,a=e.m11;t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=i,t.m06=e.m09,t.m07=e.m13,t.m08=n,t.m09=r,t.m11=e.m14,t.m12=s,t.m13=o,t.m14=a}else t.m00=e.m00,t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=e.m01,t.m05=e.m05,t.m06=e.m09,t.m07=e.m13,t.m08=e.m02,t.m09=e.m06,t.m10=e.m10,t.m11=e.m14,t.m12=e.m03,t.m13=e.m07,t.m14=e.m11,t.m15=e.m15;return t}static invert(t,e){const i=e.m00,n=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,l=e.m06,c=e.m07,h=e.m08,_=e.m09,u=e.m10,m=e.m11,d=e.m12,p=e.m13,f=e.m14,g=e.m15,y=i*a-n*o,v=i*l-s*o,x=i*c-r*o,S=n*l-s*a,A=n*c-r*a,C=s*c-r*l,b=h*p-_*d,T=h*f-u*d,w=h*g-m*d,E=_*f-u*p,P=_*g-m*p,I=u*g-m*f;let D=y*I-v*P+x*E+S*w-A*T+C*b;return 0===D?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=0,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=0,t):(D=1/D,t.m00=(a*I-l*P+c*E)*D,t.m01=(s*P-n*I-r*E)*D,t.m02=(p*C-f*A+g*S)*D,t.m03=(u*A-_*C-m*S)*D,t.m04=(l*w-o*I-c*T)*D,t.m05=(i*I-s*w+r*T)*D,t.m06=(f*x-d*C-g*v)*D,t.m07=(h*C-u*x+m*v)*D,t.m08=(o*P-a*w+c*b)*D,t.m09=(n*w-i*P-r*b)*D,t.m10=(d*A-p*x+g*y)*D,t.m11=(_*x-h*A-m*y)*D,t.m12=(a*T-o*E-l*b)*D,t.m13=(i*E-n*T+s*b)*D,t.m14=(p*v-d*S-f*y)*D,t.m15=(h*S-_*v+u*y)*D,t)}static determinant(t){const e=t.m00,i=t.m01,n=t.m02,s=t.m03,r=t.m04,o=t.m05,a=t.m06,l=t.m07,c=t.m08,h=t.m09,_=t.m10,u=t.m11,m=t.m12,d=t.m13,p=t.m14,f=t.m15;return(e*o-i*r)*(_*f-u*p)-(e*a-n*r)*(h*f-u*d)+(e*l-s*r)*(h*p-_*d)+(i*a-n*o)*(c*f-u*m)-(i*l-s*o)*(c*p-_*m)+(n*l-s*a)*(c*d-h*m)}static multiply(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,l=e.m05,c=e.m06,h=e.m07,_=e.m08,u=e.m09,m=e.m10,d=e.m11,p=e.m12,f=e.m13,g=e.m14,y=e.m15;let v=i.m00,x=i.m01,S=i.m02,A=i.m03;return t.m00=v*n+x*a+S*_+A*p,t.m01=v*s+x*l+S*u+A*f,t.m02=v*r+x*c+S*m+A*g,t.m03=v*o+x*h+S*d+A*y,v=i.m04,x=i.m05,S=i.m06,A=i.m07,t.m04=v*n+x*a+S*_+A*p,t.m05=v*s+x*l+S*u+A*f,t.m06=v*r+x*c+S*m+A*g,t.m07=v*o+x*h+S*d+A*y,v=i.m08,x=i.m09,S=i.m10,A=i.m11,t.m08=v*n+x*a+S*_+A*p,t.m09=v*s+x*l+S*u+A*f,t.m10=v*r+x*c+S*m+A*g,t.m11=v*o+x*h+S*d+A*y,v=i.m12,x=i.m13,S=i.m14,A=i.m15,t.m12=v*n+x*a+S*_+A*p,t.m13=v*s+x*l+S*u+A*f,t.m14=v*r+x*c+S*m+A*g,t.m15=v*o+x*h+S*d+A*y,t}static transform(t,e,i){const n=i.x,s=i.y,r=i.z;if(e===t)t.m12=e.m00*n+e.m04*s+e.m08*r+e.m12,t.m13=e.m01*n+e.m05*s+e.m09*r+e.m13,t.m14=e.m02*n+e.m06*s+e.m10*r+e.m14,t.m15=e.m03*n+e.m07*s+e.m11*r+e.m15;else{const i=e.m00,o=e.m01,a=e.m02,l=e.m03,c=e.m04,h=e.m05,_=e.m06,u=e.m07,m=e.m08,d=e.m09,p=e.m10,f=e.m11;e.m12,e.m13,e.m14,e.m15,t.m00=i,t.m01=o,t.m02=a,t.m03=l,t.m04=c,t.m05=h,t.m06=_,t.m07=u,t.m08=m,t.m09=d,t.m10=p,t.m11=f,t.m12=i*n+c*s+m*r+e.m12,t.m13=o*n+h*s+d*r+e.m13,t.m14=a*n+_*s+p*r+e.m14,t.m15=l*n+u*s+f*r+e.m15}return t}static translate(t,e,i){return console.warn("function changed"),e===t?(t.m12+=i.x,t.m13+=i.y,t.m14+=i.z):(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12+=i.x,t.m13+=i.y,t.m14+=i.z,t.m15=e.m15),t}static scale(t,e,i){const n=i.x,s=i.y,r=i.z;return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*s,t.m05=e.m05*s,t.m06=e.m06*s,t.m07=e.m07*s,t.m08=e.m08*r,t.m09=e.m09*r,t.m10=e.m10*r,t.m11=e.m11*r,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t}static rotate(t,e,i,n){let s=n.x,r=n.y,o=n.z,a=Math.sqrt(s*s+r*r+o*o);if(Math.abs(a)<Fe)return null;a=1/a,s*=a,r*=a,o*=a;const l=Math.sin(i),c=Math.cos(i),h=1-c,_=e.m00,u=e.m01,m=e.m02,d=e.m03,p=e.m04,f=e.m05,g=e.m06,y=e.m07,v=e.m08,x=e.m09,S=e.m10,A=e.m11,C=s*s*h+c,b=r*s*h+o*l,T=o*s*h-r*l,w=s*r*h-o*l,E=r*r*h+c,P=o*r*h+s*l,I=s*o*h+r*l,D=r*o*h-s*l,R=o*o*h+c;return t.m00=_*C+p*b+v*T,t.m01=u*C+f*b+x*T,t.m02=m*C+g*b+S*T,t.m03=d*C+y*b+A*T,t.m04=_*w+p*E+v*P,t.m05=u*w+f*E+x*P,t.m06=m*w+g*E+S*P,t.m07=d*w+y*E+A*P,t.m08=_*I+p*D+v*R,t.m09=u*I+f*D+x*R,t.m10=m*I+g*D+S*R,t.m11=d*I+y*D+A*R,e!==t&&(t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t}static rotateX(t,e,i){const n=Math.sin(i),s=Math.cos(i),r=e.m04,o=e.m05,a=e.m06,l=e.m07,c=e.m08,h=e.m09,_=e.m10,u=e.m11;return e!==t&&(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m04=r*s+c*n,t.m05=o*s+h*n,t.m06=a*s+_*n,t.m07=l*s+u*n,t.m08=c*s-r*n,t.m09=h*s-o*n,t.m10=_*s-a*n,t.m11=u*s-l*n,t}static rotateY(t,e,i){const n=Math.sin(i),s=Math.cos(i),r=e.m00,o=e.m01,a=e.m02,l=e.m03,c=e.m08,h=e.m09,_=e.m10,u=e.m11;return e!==t&&(t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=r*s-c*n,t.m01=o*s-h*n,t.m02=a*s-_*n,t.m03=l*s-u*n,t.m08=r*n+c*s,t.m09=o*n+h*s,t.m10=a*n+_*s,t.m11=l*n+u*s,t}static rotateZ(t,e,i){const n=Math.sin(i),s=Math.cos(i),r=e.m00,o=e.m01,a=e.m02,l=e.m03,c=e.m04,h=e.m05,_=e.m06,u=e.m07;return e!==t&&(t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=r*s+c*n,t.m01=o*s+h*n,t.m02=a*s+_*n,t.m03=l*s+u*n,t.m04=c*s-r*n,t.m05=h*s-o*n,t.m06=_*s-a*n,t.m07=u*s-l*n,t}static fromTranslation(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=e.x,t.m13=e.y,t.m14=e.z,t.m15=1,t}static fromScaling(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=e.y,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=e.z,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromRotation(t,e,i){let n=i.x,s=i.y,r=i.z,o=Math.sqrt(n*n+s*s+r*r);if(Math.abs(o)<Fe)return null;o=1/o,n*=o,s*=o,r*=o;const a=Math.sin(e),l=Math.cos(e),c=1-l;return t.m00=n*n*c+l,t.m01=s*n*c+r*a,t.m02=r*n*c-s*a,t.m03=0,t.m04=n*s*c-r*a,t.m05=s*s*c+l,t.m06=r*s*c+n*a,t.m07=0,t.m08=n*r*c+s*a,t.m09=s*r*c-n*a,t.m10=r*r*c+l,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromXRotation(t,e){const i=Math.sin(e),n=Math.cos(e);return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=n,t.m06=i,t.m07=0,t.m08=0,t.m09=-i,t.m10=n,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromYRotation(t,e){const i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=0,t.m02=-i,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=i,t.m09=0,t.m10=n,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromZRotation(t,e){const i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=i,t.m02=0,t.m03=0,t.m04=-i,t.m05=n,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromRT(t,e,i){const n=e.x,s=e.y,r=e.z,o=e.w,a=n+n,l=s+s,c=r+r,h=n*a,_=n*l,u=n*c,m=s*l,d=s*c,p=r*c,f=o*a,g=o*l,y=o*c;return t.m00=1-(m+p),t.m01=_+y,t.m02=u-g,t.m03=0,t.m04=_-y,t.m05=1-(h+p),t.m06=d+f,t.m07=0,t.m08=u+g,t.m09=d-f,t.m10=1-(h+m),t.m11=0,t.m12=i.x,t.m13=i.y,t.m14=i.z,t.m15=1,t}static getTranslation(t,e){return t.x=e.m12,t.y=e.m13,t.z=e.m14,t}static getScaling(t,e){const i=Ci.m00=e.m00,n=Ci.m01=e.m01,s=Ci.m02=e.m02,r=Ci.m03=e.m04,o=Ci.m04=e.m05,a=Ci.m05=e.m06,l=Ci.m06=e.m08,c=Ci.m07=e.m09,h=Ci.m08=e.m10;return t.x=Math.sqrt(i*i+n*n+s*s),t.y=Math.sqrt(r*r+o*o+a*a),t.z=Math.sqrt(l*l+c*c+h*h),hi.determinant(Ci)<0&&(t.x*=-1),t}static getRotation(t,e){const i=e.m00+e.m05+e.m10;let n=0;return i>0?(n=2*Math.sqrt(i+1),t.w=.25*n,t.x=(e.m06-e.m09)/n,t.y=(e.m08-e.m02)/n,t.z=(e.m01-e.m04)/n):e.m00>e.m05&&e.m00>e.m10?(n=2*Math.sqrt(1+e.m00-e.m05-e.m10),t.w=(e.m06-e.m09)/n,t.x=.25*n,t.y=(e.m01+e.m04)/n,t.z=(e.m08+e.m02)/n):e.m05>e.m10?(n=2*Math.sqrt(1+e.m05-e.m00-e.m10),t.w=(e.m08-e.m02)/n,t.x=(e.m01+e.m04)/n,t.y=.25*n,t.z=(e.m06+e.m09)/n):(n=2*Math.sqrt(1+e.m10-e.m00-e.m05),t.w=(e.m01-e.m04)/n,t.x=(e.m08+e.m02)/n,t.y=(e.m06+e.m09)/n,t.z=.25*n),t}static toRTS(t,e,i,n){n.x=oi.set(Ai,t.m00,t.m01,t.m02).length(),Ci.m00=t.m00/n.x,Ci.m01=t.m01/n.x,Ci.m02=t.m02/n.x,n.y=oi.set(Ai,t.m04,t.m05,t.m06).length(),Ci.m03=t.m04/n.y,Ci.m04=t.m05/n.y,Ci.m05=t.m06/n.y,n.z=oi.set(Ai,t.m08,t.m09,t.m10).length(),Ci.m06=t.m08/n.z,Ci.m07=t.m09/n.z,Ci.m08=t.m10/n.z,hi.determinant(Ci)<0&&(n.x*=-1,Ci.m00*=-1,Ci.m01*=-1,Ci.m02*=-1),mi.fromMat3(e,Ci),oi.set(i,t.m12,t.m13,t.m14)}static fromRTS(t,e,i,n){const s=e.x,r=e.y,o=e.z,a=e.w,l=s+s,c=r+r,h=o+o,_=s*l,u=s*c,m=s*h,d=r*c,p=r*h,f=o*h,g=a*l,y=a*c,v=a*h,x=n.x,S=n.y,A=n.z;return t.m00=(1-(d+f))*x,t.m01=(u+v)*x,t.m02=(m-y)*x,t.m03=0,t.m04=(u-v)*S,t.m05=(1-(_+f))*S,t.m06=(p+g)*S,t.m07=0,t.m08=(m+y)*A,t.m09=(p-g)*A,t.m10=(1-(_+d))*A,t.m11=0,t.m12=i.x,t.m13=i.y,t.m14=i.z,t.m15=1,t}static fromRTSOrigin(t,e,i,n,s){const r=e.x,o=e.y,a=e.z,l=e.w,c=r+r,h=o+o,_=a+a,u=r*c,m=r*h,d=r*_,p=o*h,f=o*_,g=a*_,y=l*c,v=l*h,x=l*_,S=n.x,A=n.y,C=n.z,b=s.x,T=s.y,w=s.z;return t.m00=(1-(p+g))*S,t.m01=(m+x)*S,t.m02=(d-v)*S,t.m03=0,t.m04=(m-x)*A,t.m05=(1-(u+g))*A,t.m06=(f+y)*A,t.m07=0,t.m08=(d+v)*C,t.m09=(f-y)*C,t.m10=(1-(u+p))*C,t.m11=0,t.m12=i.x+b-(t.m00*b+t.m04*T+t.m08*w),t.m13=i.y+T-(t.m01*b+t.m05*T+t.m09*w),t.m14=i.z+w-(t.m02*b+t.m06*T+t.m10*w),t.m15=1,t}static fromQuat(t,e){const i=e.x,n=e.y,s=e.z,r=e.w,o=i+i,a=n+n,l=s+s,c=i*o,h=n*o,_=n*a,u=s*o,m=s*a,d=s*l,p=r*o,f=r*a,g=r*l;return t.m00=1-_-d,t.m01=h+g,t.m02=u-f,t.m03=0,t.m04=h-g,t.m05=1-c-d,t.m06=m+p,t.m07=0,t.m08=u+f,t.m09=m-p,t.m10=1-c-_,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static frustum(t,e,i,n,s,r,o){const a=1/(i-e),l=1/(s-n),c=1/(r-o);return t.m00=2*r*a,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=2*r*l,t.m06=0,t.m07=0,t.m08=(i+e)*a,t.m09=(s+n)*l,t.m10=(o+r)*c,t.m11=-1,t.m12=0,t.m13=0,t.m14=o*r*2*c,t.m15=0,t}static perspective(t,e,i,n,s,r=!0,o=-1,a=1,l=0){const c=1/Math.tan(e/2),h=1/(n-s),_=r?c/i:c,u=(r?c:c*i)*a,m=xi[l];return t.m00=_*m[0],t.m01=_*m[1],t.m02=0,t.m03=0,t.m04=u*m[2],t.m05=u*m[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=(s-o*n)*h,t.m11=-1,t.m12=0,t.m13=0,t.m14=s*n*h*(1-o),t.m15=0,t}static ortho(t,e,i,n,s,r,o,a=-1,l=1,c=0){const h=1/(e-i),_=1/(n-s)*l,u=1/(r-o),m=-2*h,d=-2*_,p=(e+i)*h,f=(s+n)*_,g=xi[c];return t.m00=m*g[0],t.m01=m*g[1],t.m02=0,t.m03=0,t.m04=d*g[2],t.m05=d*g[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=u*(1-a),t.m11=0,t.m12=p*g[0]+f*g[2],t.m13=p*g[1]+f*g[3],t.m14=(r-a*o)*u,t.m15=1,t}static lookAt(t,e,i,n){const s=e.x,r=e.y,o=e.z,a=n.x,l=n.y,c=n.z;let h=s-i.x,_=r-i.y,u=o-i.z,m=1/Math.sqrt(h*h+_*_+u*u);h*=m,_*=m,u*=m;let d=l*u-c*_,p=c*h-a*u,f=a*_-l*h;m=1/Math.sqrt(d*d+p*p+f*f),d*=m,p*=m,f*=m;const g=_*f-u*p,y=u*d-h*f,v=h*p-_*d;return t.m00=d,t.m01=g,t.m02=h,t.m03=0,t.m04=p,t.m05=y,t.m06=_,t.m07=0,t.m08=f,t.m09=v,t.m10=u,t.m11=0,t.m12=-(d*s+p*r+f*o),t.m13=-(g*s+y*r+v*o),t.m14=-(h*s+_*r+u*o),t.m15=1,t}static inverseTranspose(t,e){const i=e.m00,n=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,l=e.m06,c=e.m07,h=e.m08,_=e.m09,u=e.m10,m=e.m11,d=e.m12,p=e.m13,f=e.m14,g=e.m15,y=i*a-n*o,v=i*l-s*o,x=i*c-r*o,S=n*l-s*a,A=n*c-r*a,C=s*c-r*l,b=h*p-_*d,T=h*f-u*d,w=h*g-m*d,E=_*f-u*p,P=_*g-m*p,I=u*g-m*f;let D=y*I-v*P+x*E+S*w-A*T+C*b;return D?(D=1/D,t.m00=(a*I-l*P+c*E)*D,t.m01=(l*w-o*I-c*T)*D,t.m02=(o*P-a*w+c*b)*D,t.m03=0,t.m04=(s*P-n*I-r*E)*D,t.m05=(i*I-s*w+r*T)*D,t.m06=(n*w-i*P-r*b)*D,t.m07=0,t.m08=(p*C-f*A+g*S)*D,t.m09=(f*x-d*C-g*v)*D,t.m10=(d*A-p*x+g*y)*D,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t):null}static toArray(t,e,i=0){return t[i+0]=e.m00,t[i+1]=e.m01,t[i+2]=e.m02,t[i+3]=e.m03,t[i+4]=e.m04,t[i+5]=e.m05,t[i+6]=e.m06,t[i+7]=e.m07,t[i+8]=e.m08,t[i+9]=e.m09,t[i+10]=e.m10,t[i+11]=e.m11,t[i+12]=e.m12,t[i+13]=e.m13,t[i+14]=e.m14,t[i+15]=e.m15,t}static fromArray(t,e,i=0){return t.m00=e[i+0],t.m01=e[i+1],t.m02=e[i+2],t.m03=e[i+3],t.m04=e[i+4],t.m05=e[i+5],t.m06=e[i+6],t.m07=e[i+7],t.m08=e[i+8],t.m09=e[i+9],t.m10=e[i+10],t.m11=e[i+11],t.m12=e[i+12],t.m13=e[i+13],t.m14=e[i+14],t.m15=e[i+15],t}static add(t,e,i){return t.m00=e.m00+i.m00,t.m01=e.m01+i.m01,t.m02=e.m02+i.m02,t.m03=e.m03+i.m03,t.m04=e.m04+i.m04,t.m05=e.m05+i.m05,t.m06=e.m06+i.m06,t.m07=e.m07+i.m07,t.m08=e.m08+i.m08,t.m09=e.m09+i.m09,t.m10=e.m10+i.m10,t.m11=e.m11+i.m11,t.m12=e.m12+i.m12,t.m13=e.m13+i.m13,t.m14=e.m14+i.m14,t.m15=e.m15+i.m15,t}static subtract(t,e,i){return t.m00=e.m00-i.m00,t.m01=e.m01-i.m01,t.m02=e.m02-i.m02,t.m03=e.m03-i.m03,t.m04=e.m04-i.m04,t.m05=e.m05-i.m05,t.m06=e.m06-i.m06,t.m07=e.m07-i.m07,t.m08=e.m08-i.m08,t.m09=e.m09-i.m09,t.m10=e.m10-i.m10,t.m11=e.m11-i.m11,t.m12=e.m12-i.m12,t.m13=e.m13-i.m13,t.m14=e.m14-i.m14,t.m15=e.m15-i.m15,t}static multiplyScalar(t,e,i){return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*i,t.m05=e.m05*i,t.m06=e.m06*i,t.m07=e.m07*i,t.m08=e.m08*i,t.m09=e.m09*i,t.m10=e.m10*i,t.m11=e.m11*i,t.m12=e.m12*i,t.m13=e.m13*i,t.m14=e.m14*i,t.m15=e.m15*i,t}static multiplyScalarAndAdd(t,e,i,n){return t.m00=e.m00+i.m00*n,t.m01=e.m01+i.m01*n,t.m02=e.m02+i.m02*n,t.m03=e.m03+i.m03*n,t.m04=e.m04+i.m04*n,t.m05=e.m05+i.m05*n,t.m06=e.m06+i.m06*n,t.m07=e.m07+i.m07*n,t.m08=e.m08+i.m08*n,t.m09=e.m09+i.m09*n,t.m10=e.m10+i.m10*n,t.m11=e.m11+i.m11*n,t.m12=e.m12+i.m12*n,t.m13=e.m13+i.m13*n,t.m14=e.m14+i.m14*n,t.m15=e.m15+i.m15*n,t}static strictEquals(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15}static equals(t,e,i=Fe){return Math.abs(t.m00-e.m00)<=i*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=i*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=i*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=i*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=i*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=i*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=i*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=i*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=i*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))&&Math.abs(t.m09-e.m09)<=i*Math.max(1,Math.abs(t.m09),Math.abs(e.m09))&&Math.abs(t.m10-e.m10)<=i*Math.max(1,Math.abs(t.m10),Math.abs(e.m10))&&Math.abs(t.m11-e.m11)<=i*Math.max(1,Math.abs(t.m11),Math.abs(e.m11))&&Math.abs(t.m12-e.m12)<=i*Math.max(1,Math.abs(t.m12),Math.abs(e.m12))&&Math.abs(t.m13-e.m13)<=i*Math.max(1,Math.abs(t.m13),Math.abs(e.m13))&&Math.abs(t.m14-e.m14)<=i*Math.max(1,Math.abs(t.m14),Math.abs(e.m14))&&Math.abs(t.m15-e.m15)<=i*Math.max(1,Math.abs(t.m15),Math.abs(e.m15))}constructor(t=1,e=0,i=0,n=0,s=0,r=1,o=0,a=0,l=0,c=0,h=1,_=0,u=0,m=0,d=0,p=1){super(),this.m00=void 0,this.m01=void 0,this.m02=void 0,this.m03=void 0,this.m04=void 0,this.m05=void 0,this.m06=void 0,this.m07=void 0,this.m08=void 0,this.m09=void 0,this.m10=void 0,this.m11=void 0,this.m12=void 0,this.m13=void 0,this.m14=void 0,this.m15=void 0,"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08,this.m09=t.m09,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=t.m13,this.m14=t.m14,this.m15=t.m15):(this.m00=t,this.m01=e,this.m02=i,this.m03=n,this.m04=s,this.m05=r,this.m06=o,this.m07=a,this.m08=l,this.m09=c,this.m10=h,this.m11=_,this.m12=u,this.m13=m,this.m14=d,this.m15=p)}clone(){return new Si(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)}set(t=1,e=0,i=0,n=0,s=0,r=1,o=0,a=0,l=0,c=0,h=1,_=0,u=0,m=0,d=0,p=1){return"object"==typeof t?(this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08,this.m09=t.m09,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=t.m13,this.m14=t.m14,this.m15=t.m15,this.m00=t.m00):(this.m01=e,this.m02=i,this.m03=n,this.m04=s,this.m05=r,this.m06=o,this.m07=a,this.m08=l,this.m09=c,this.m10=h,this.m11=_,this.m12=u,this.m13=m,this.m14=d,this.m15=p,this.m00=t),this}equals(t,e=Fe){return Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))&&Math.abs(this.m09-t.m09)<=e*Math.max(1,Math.abs(this.m09),Math.abs(t.m09))&&Math.abs(this.m10-t.m10)<=e*Math.max(1,Math.abs(this.m10),Math.abs(t.m10))&&Math.abs(this.m11-t.m11)<=e*Math.max(1,Math.abs(this.m11),Math.abs(t.m11))&&Math.abs(this.m12-t.m12)<=e*Math.max(1,Math.abs(this.m12),Math.abs(t.m12))&&Math.abs(this.m13-t.m13)<=e*Math.max(1,Math.abs(this.m13),Math.abs(t.m13))&&Math.abs(this.m14-t.m14)<=e*Math.max(1,Math.abs(this.m14),Math.abs(t.m14))&&Math.abs(this.m15-t.m15)<=e*Math.max(1,Math.abs(this.m15),Math.abs(t.m15))}strictEquals(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08&&this.m09===t.m09&&this.m10===t.m10&&this.m11===t.m11&&this.m12===t.m12&&this.m13===t.m13&&this.m14===t.m14&&this.m15===t.m15}toString(){return`[\n${this.m00}, ${this.m01}, ${this.m02}, ${this.m03},\n${this.m04}, ${this.m05}, ${this.m06}, ${this.m07},\n${this.m08}, ${this.m09}, ${this.m10}, ${this.m11},\n${this.m12}, ${this.m13}, ${this.m14}, ${this.m15}\n]`}identity(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}zero(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this}transpose(){const t=this.m01,e=this.m02,i=this.m03,n=this.m06,s=this.m07,r=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=t,this.m06=this.m09,this.m07=this.m13,this.m08=e,this.m09=n,this.m11=this.m14,this.m12=i,this.m13=s,this.m14=r,this}invert(){const t=this.m00,e=this.m01,i=this.m02,n=this.m03,s=this.m04,r=this.m05,o=this.m06,a=this.m07,l=this.m08,c=this.m09,h=this.m10,_=this.m11,u=this.m12,m=this.m13,d=this.m14,p=this.m15,f=t*r-e*s,g=t*o-i*s,y=t*a-n*s,v=e*o-i*r,x=e*a-n*r,S=i*a-n*o,A=l*m-c*u,C=l*d-h*u,b=l*p-_*u,T=c*d-h*m,w=c*p-_*m,E=h*p-_*d;let P=f*E-g*w+y*T+v*b-x*C+S*A;return 0===P?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(P=1/P,this.m00=(r*E-o*w+a*T)*P,this.m01=(i*w-e*E-n*T)*P,this.m02=(m*S-d*x+p*v)*P,this.m03=(h*x-c*S-_*v)*P,this.m04=(o*b-s*E-a*C)*P,this.m05=(t*E-i*b+n*C)*P,this.m06=(d*y-u*S-p*g)*P,this.m07=(l*S-h*y+_*g)*P,this.m08=(s*w-r*b+a*A)*P,this.m09=(e*b-t*w-n*A)*P,this.m10=(u*x-m*y+p*f)*P,this.m11=(c*y-l*x-_*f)*P,this.m12=(r*C-s*T-o*A)*P,this.m13=(t*T-e*C+i*A)*P,this.m14=(m*g-u*v-d*f)*P,this.m15=(l*v-c*g+h*f)*P,this)}determinant(){const t=this.m00,e=this.m01,i=this.m02,n=this.m03,s=this.m04,r=this.m05,o=this.m06,a=this.m07,l=this.m08,c=this.m09,h=this.m10,_=this.m11,u=this.m12,m=this.m13,d=this.m14,p=this.m15;return(t*r-e*s)*(h*p-_*d)-(t*o-i*s)*(c*p-_*m)+(t*a-n*s)*(c*d-h*m)+(e*o-i*r)*(l*p-_*u)-(e*a-n*r)*(l*d-h*u)+(i*a-n*o)*(l*m-c*u)}add(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this.m09+=t.m09,this.m10+=t.m10,this.m11+=t.m11,this.m12+=t.m12,this.m13+=t.m13,this.m14+=t.m14,this.m15+=t.m15,this}subtract(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this.m09-=t.m09,this.m10-=t.m10,this.m11-=t.m11,this.m12-=t.m12,this.m13-=t.m13,this.m14-=t.m14,this.m15-=t.m15,this}multiply(t){const e=this.m00,i=this.m01,n=this.m02,s=this.m03,r=this.m04,o=this.m05,a=this.m06,l=this.m07,c=this.m08,h=this.m09,_=this.m10,u=this.m11,m=this.m12,d=this.m13,p=this.m14,f=this.m15;let g=t.m00,y=t.m01,v=t.m02,x=t.m03;return this.m00=g*e+y*r+v*c+x*m,this.m01=g*i+y*o+v*h+x*d,this.m02=g*n+y*a+v*_+x*p,this.m03=g*s+y*l+v*u+x*f,g=t.m04,y=t.m05,v=t.m06,x=t.m07,this.m04=g*e+y*r+v*c+x*m,this.m05=g*i+y*o+v*h+x*d,this.m06=g*n+y*a+v*_+x*p,this.m07=g*s+y*l+v*u+x*f,g=t.m08,y=t.m09,v=t.m10,x=t.m11,this.m08=g*e+y*r+v*c+x*m,this.m09=g*i+y*o+v*h+x*d,this.m10=g*n+y*a+v*_+x*p,this.m11=g*s+y*l+v*u+x*f,g=t.m12,y=t.m13,v=t.m14,x=t.m15,this.m12=g*e+y*r+v*c+x*m,this.m13=g*i+y*o+v*h+x*d,this.m14=g*n+y*a+v*_+x*p,this.m15=g*s+y*l+v*u+x*f,this}multiplyScalar(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this.m09*=t,this.m10*=t,this.m11*=t,this.m12*=t,this.m13*=t,this.m14*=t,this.m15*=t,this}translate(t){return console.warn("function changed"),this.m12+=t.x,this.m13+=t.y,this.m14+=t.z,this}scale(t){const e=t.x,i=t.y,n=t.z;return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=i,this.m05*=i,this.m06*=i,this.m07*=i,this.m08*=n,this.m09*=n,this.m10*=n,this.m11*=n,this}rotate(t,e){let i=e.x,n=e.y,s=e.z,r=Math.sqrt(i*i+n*n+s*s);if(Math.abs(r)<Fe)return null;r=1/r,i*=r,n*=r,s*=r;const o=Math.sin(t),a=Math.cos(t),l=1-a,c=this.m00,h=this.m01,_=this.m02,u=this.m03,m=this.m04,d=this.m05,p=this.m06,f=this.m07,g=this.m08,y=this.m09,v=this.m10,x=this.m11,S=i*i*l+a,A=n*i*l+s*o,C=s*i*l-n*o,b=i*n*l-s*o,T=n*n*l+a,w=s*n*l+i*o,E=i*s*l+n*o,P=n*s*l-i*o,I=s*s*l+a;return this.m00=c*S+m*A+g*C,this.m01=h*S+d*A+y*C,this.m02=_*S+p*A+v*C,this.m03=u*S+f*A+x*C,this.m04=c*b+m*T+g*w,this.m05=h*b+d*T+y*w,this.m06=_*b+p*T+v*w,this.m07=u*b+f*T+x*w,this.m08=c*E+m*P+g*I,this.m09=h*E+d*P+y*I,this.m10=_*E+p*P+v*I,this.m11=u*E+f*P+x*I,this}getTranslation(t){return t.x=this.m12,t.y=this.m13,t.z=this.m14,t}getScale(t){const e=Ci.m00=this.m00,i=Ci.m01=this.m01,n=Ci.m02=this.m02,s=Ci.m03=this.m04,r=Ci.m04=this.m05,o=Ci.m05=this.m06,a=Ci.m06=this.m08,l=Ci.m07=this.m09,c=Ci.m08=this.m10;return t.x=Math.sqrt(e*e+i*i+n*n),t.y=Math.sqrt(s*s+r*r+o*o),t.z=Math.sqrt(a*a+l*l+c*c),hi.determinant(Ci)<0&&(t.x*=-1),t}getRotation(t){const e=this.m00+this.m05+this.m10;let i=0;return e>0?(i=2*Math.sqrt(e+1),t.w=.25*i,t.x=(this.m06-this.m09)/i,t.y=(this.m08-this.m02)/i,t.z=(this.m01-this.m04)/i):this.m00>this.m05&&this.m00>this.m10?(i=2*Math.sqrt(1+this.m00-this.m05-this.m10),t.w=(this.m06-this.m09)/i,t.x=.25*i,t.y=(this.m01+this.m04)/i,t.z=(this.m08+this.m02)/i):this.m05>this.m10?(i=2*Math.sqrt(1+this.m05-this.m00-this.m10),t.w=(this.m08-this.m02)/i,t.x=(this.m01+this.m04)/i,t.y=.25*i,t.z=(this.m06+this.m09)/i):(i=2*Math.sqrt(1+this.m10-this.m00-this.m05),t.w=(this.m01-this.m04)/i,t.x=(this.m08+this.m02)/i,t.y=(this.m06+this.m09)/i,t.z=.25*i),t}fromRTS(t,e,i){const n=t.x,s=t.y,r=t.z,o=t.w,a=n+n,l=s+s,c=r+r,h=n*a,_=n*l,u=n*c,m=s*l,d=s*c,p=r*c,f=o*a,g=o*l,y=o*c,v=i.x,x=i.y,S=i.z;return this.m00=(1-(m+p))*v,this.m01=(_+y)*v,this.m02=(u-g)*v,this.m03=0,this.m04=(_-y)*x,this.m05=(1-(h+p))*x,this.m06=(d+f)*x,this.m07=0,this.m08=(u+g)*S,this.m09=(d-f)*S,this.m10=(1-(h+m))*S,this.m11=0,this.m12=e.x,this.m13=e.y,this.m14=e.z,this.m15=1,this}fromQuat(t){const e=t.x,i=t.y,n=t.z,s=t.w,r=e+e,o=i+i,a=n+n,l=e*r,c=i*r,h=i*o,_=n*r,u=n*o,m=n*a,d=s*r,p=s*o,f=s*a;return this.m00=1-h-m,this.m01=c+f,this.m02=_-p,this.m03=0,this.m04=c-f,this.m05=1-l-m,this.m06=u+d,this.m07=0,this.m08=_+p,this.m09=u-d,this.m10=1-l-h,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}}t("Mat4",Si),Si.IDENTITY=Object.freeze(new Si);const Ai=new oi,Ci=new hi;function bi(t,e,i,n,s,r,o,a,l,c,h,_,u,m,d,p){return new Si(t,e,i,n,s,r,o,a,l,c,h,_,u,m,d,p)}Me.fastDefine("cc.Mat4",Si,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),n.Mat4=Si,n.mat4=bi;class Ti extends Wt{static clone(t){return new Ti(t.x,t.y)}static copy(t,e){return t.x=e.x,t.y=e.y,t}static set(t,e,i){return t.x=e,t.y=i,t}static add(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t}static subtract(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t}static multiply(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t}static divide(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t}static min(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t}static max(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t}static scaleAndAdd(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t}static distance(t,e){const i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)}static squaredDistance(t,e){const i=e.x-t.x,n=e.y-t.y;return i*i+n*n}static len(t){const e=t.x,i=t.y;return Math.sqrt(e*e+i*i)}static lengthSqr(t){const e=t.x,i=t.y;return e*e+i*i}static negate(t,e){return t.x=-e.x,t.y=-e.y,t}static inverse(t,e){return t.x=1/e.x,t.y=1/e.y,t}static inverseSafe(t,e){const i=e.x,n=e.y;return Math.abs(i)<Fe?t.x=0:t.x=1/i,Math.abs(n)<Fe?t.y=0:t.y=1/n,t}static normalize(t,e){const i=e.x,n=e.y;let s=i*i+n*n;return s>0&&(s=1/Math.sqrt(s),t.x=i*s,t.y=n*s),t}static dot(t,e){return t.x*e.x+t.y*e.y}static cross(t,e,i){return t.x=t.y=0,t.z=e.x*i.y-e.y*i.x,t}static lerp(t,e,i,n){const s=e.x,r=e.y;return t.x=s+n*(i.x-s),t.y=r+n*(i.y-r),t}static random(t,e){e=e||1;const i=2*We()*Math.PI;return t.x=Math.cos(i)*e,t.y=Math.sin(i)*e,t}static transformMat3(t,e,i){const n=e.x,s=e.y;return t.x=i.m00*n+i.m03*s+i.m06,t.y=i.m01*n+i.m04*s+i.m07,t}static transformMat4(t,e,i){const n=e.x,s=e.y;return t.x=i.m00*n+i.m04*s+i.m12,t.y=i.m01*n+i.m05*s+i.m13,t}static str(t){return`Vec2(${t.x}, ${t.y})`}static toArray(t,e,i=0){return t[i+0]=e.x,t[i+1]=e.y,t}static fromArray(t,e,i=0){return t.x=e[i+0],t.y=e[i+1],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y}static equals(t,e,i=Fe){return Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))}static angle(t,e){Ti.normalize(wi,t),Ti.normalize(Ei,e);const i=Ti.dot(wi,Ei);return i>1?0:i<-1?Math.PI:Math.acos(i)}constructor(t,e){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0)}clone(){return new Ti(this.x,this.y)}set(t,e){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0),this}equals(t,e=Fe){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))}equals2f(t,e,i=Fe){return Math.abs(this.x-t)<=i*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=i*Math.max(1,Math.abs(this.y),Math.abs(e))}strictEquals(t){return t&&this.x===t.x&&this.y===t.y}strictEquals2f(t,e){return this.x===t&&this.y===e}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}lerp(t,e){const i=this.x,n=this.y;return this.x=i+e*(t.x-i),this.y=n+e*(t.y-n),this}clampf(t,e){return this.x=Ue(this.x,t.x,e.x),this.y=Ue(this.y,t.y,e.y),this}add(t){return this.x+=t.x,this.y+=t.y,this}add2f(t,e){return this.x+=t,this.y+=e,this}subtract(t){return this.x-=t.x,this.y-=t.y,this}subtract2f(t,e){return this.x-=t,this.y-=e,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=t,this.y*=t,this}multiply(t){return"object"!=typeof t&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this}multiply2f(t,e){return this.x*=t,this.y*=e,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divide2f(t,e){return this.x/=t,this.y/=e,this}negative(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSqr(){return this.x*this.x+this.y*this.y}normalize(){const t=this.x,e=this.y;let i=t*t+e*e;return i>0&&(i=1/Math.sqrt(i),this.x*=i,this.y*=i),this}angle(t){const e=this.lengthSqr(),i=t.lengthSqr();if(0===e||0===i)return console.warn("Can't get angle between zero vector"),0;let n=this.dot(t)/Math.sqrt(e*i);return n=Ue(n,-1,1),Math.acos(n)}signAngle(t){const e=this.angle(t);return this.cross(t)<0?-e:e}rotate(t){const e=this.x,i=this.y,n=Math.sin(t),s=Math.cos(t);return this.x=s*e-n*i,this.y=n*e+s*i,this}project(t){const e=this.dot(t)/t.dot(t);return this.x=t.x*e,this.y=t.y*e,this}transformMat4(t){const e=this.x,i=this.y;return this.x=t.m00*e+t.m04*i+t.m12,this.y=t.m01*e+t.m05*i+t.m13,this}}t("Vec2",Ti),Ti.ZERO=Object.freeze(new Ti(0,0)),Ti.ONE=Object.freeze(new Ti(1,1)),Ti.NEG_ONE=Object.freeze(new Ti(-1,-1)),Ti.UNIT_X=Object.freeze(new Ti(1,0)),Ti.UNIT_Y=Object.freeze(new Ti(0,1));const wi=new Ti,Ei=new Ti;function Pi(t,e){return new Ti(t,e)}Me.fastDefine("cc.Vec2",Ti,{x:0,y:0}),n.Vec2=Ti,n.v2=Pi;class Ii extends Wt{static clone(t){return new Ii(t.x,t.y,t.z,t.w)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}static set(t,e,i,n,s){return t.x=e,t.y=i,t.z=n,t.w=s,t}static add(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t.z=e.z+i.z,t.w=e.w+i.w,t}static subtract(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t.z=e.z-i.z,t.w=e.w-i.w,t}static multiply(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t.z=e.z*i.z,t.w=e.w*i.w,t}static divide(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t.z=e.z/i.z,t.w=e.w/i.w,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t.w=Math.ceil(e.w),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t.w=Math.floor(e.w),t}static min(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t.z=Math.min(e.z,i.z),t.w=Math.min(e.w,i.w),t}static max(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t.z=Math.max(e.z,i.z),t.w=Math.max(e.w,i.w),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t.w=Math.round(e.w),t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i,t}static scaleAndAdd(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t.w=e.w+i.w*n,t}static distance(t,e){const i=e.x-t.x,n=e.y-t.y,s=e.z-t.z,r=e.w-t.w;return Math.sqrt(i*i+n*n+s*s+r*r)}static squaredDistance(t,e){const i=e.x-t.x,n=e.y-t.y,s=e.z-t.z,r=e.w-t.w;return i*i+n*n+s*s+r*r}static len(t){const e=t.x,i=t.y,n=t.z,s=t.w;return Math.sqrt(e*e+i*i+n*n+s*s)}static lengthSqr(t){const e=t.x,i=t.y,n=t.z,s=t.w;return e*e+i*i+n*n+s*s}static negate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w,t}static inverse(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t.w=1/e.w,t}static inverseSafe(t,e){const i=e.x,n=e.y,s=e.z,r=e.w;return Math.abs(i)<Fe?t.x=0:t.x=1/i,Math.abs(n)<Fe?t.y=0:t.y=1/n,Math.abs(s)<Fe?t.z=0:t.z=1/s,Math.abs(r)<Fe?t.w=0:t.w=1/r,t}static normalize(t,e){const i=e.x,n=e.y,s=e.z,r=e.w;let o=i*i+n*n+s*s+r*r;return o>0&&(o=1/Math.sqrt(o),t.x=i*o,t.y=n*o,t.z=s*o,t.w=r*o),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static lerp(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t.w=e.w+n*(i.w-e.w),t}static random(t,e){e=e||1;const i=2*We()*Math.PI,n=2*We()-1,s=Math.sqrt(1-n*n);return t.x=s*Math.cos(i)*e,t.y=s*Math.sin(i)*e,t.z=n*e,t.w=0,t}static transformMat4(t,e,i){const n=e.x,s=e.y,r=e.z,o=e.w;return t.x=i.m00*n+i.m04*s+i.m08*r+i.m12*o,t.y=i.m01*n+i.m05*s+i.m09*r+i.m13*o,t.z=i.m02*n+i.m06*s+i.m10*r+i.m14*o,t.w=i.m03*n+i.m07*s+i.m11*r+i.m15*o,t}static transformAffine(t,e,i){const n=e.x,s=e.y,r=e.z,o=e.w;return t.x=i.m00*n+i.m01*s+i.m02*r+i.m03*o,t.y=i.m04*n+i.m05*s+i.m06*r+i.m07*o,t.x=i.m08*n+i.m09*s+i.m10*r+i.m11*o,t.w=e.w,t}static transformQuat(t,e,i){const{x:n,y:s,z:r}=e,o=i.x,a=i.y,l=i.z,c=i.w,h=c*n+a*r-l*s,_=c*s+l*n-o*r,u=c*r+o*s-a*n,m=-o*n-a*s-l*r;return t.x=h*c+m*-o+_*-l-u*-a,t.y=_*c+m*-a+u*-o-h*-l,t.z=u*c+m*-l+h*-a-_*-o,t.w=e.w,t}static toArray(t,e,i=0){return t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t[i+3]=e.w,t}static fromArray(t,e,i=0){return t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t.w=e[i+3],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w}static equals(t,e,i=Fe){return Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=i*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=i*Math.max(1,Math.abs(t.w),Math.abs(e.w))}constructor(t,e,i,n){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=n||0)}clone(){return new Ii(this.x,this.y,this.z,this.w)}set(t,e,i,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=n||0),this}equals(t,e=Fe){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))}equals4f(t,e,i,n,s=Fe){return Math.abs(this.x-t)<=s*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=s*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-i)<=s*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=s*Math.max(1,Math.abs(this.w),Math.abs(n))}strictEquals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}strictEquals4f(t,e,i,n){return this.x===t&&this.y===e&&this.z===i&&this.w===n}lerp(t,e){const i=this.x,n=this.y,s=this.z,r=this.w;return this.x=i+e*(t.x-i),this.y=n+e*(t.y-n),this.z=s+e*(t.z-s),this.w=r+e*(t.w-r),this}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.z.toFixed(2)}, ${this.w.toFixed(2)})`}clampf(t,e){return this.x=Ue(this.x,t.x,e.x),this.y=Ue(this.y,t.y,e.y),this.z=Ue(this.z,t.z,e.z),this.w=Ue(this.w,t.w,e.w),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}add4f(t,e,i,n){return this.x+=t,this.y+=e,this.z+=i,this.w+=n,this}subtract(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subtract4f(t,e,i,n){return this.x-=t,this.y-=e,this.z-=i,this.w-=n,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}multiply(t){return"object"!=typeof t&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiply4f(t,e,i,n){return this.x*=t,this.y*=e,this.z*=i,this.w*=n,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}divide4f(t,e,i,n){return this.x/=t,this.y/=e,this.z/=i,this.w/=n,this}negative(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}cross(t){const{x:e,y:i,z:n}=this,{x:s,y:r,z:o}=t;return this.x=i*o-n*r,this.y=n*s-e*o,this.z=e*r-i*s,this}length(){const t=this.x,e=this.y,i=this.z,n=this.w;return Math.sqrt(t*t+e*e+i*i+n*n)}lengthSqr(){const t=this.x,e=this.y,i=this.z,n=this.w;return t*t+e*e+i*i+n*n}normalize(){const t=this.x,e=this.y,i=this.z,n=this.w;let s=t*t+e*e+i*i+n*n;return s>0&&(s=1/Math.sqrt(s),this.x=t*s,this.y=e*s,this.z=i*s,this.w=n*s),this}transformMat4(t){const e=this.x,i=this.y,n=this.z,s=this.w;return this.x=t.m00*e+t.m04*i+t.m08*n+t.m12*s,this.y=t.m01*e+t.m05*i+t.m09*n+t.m13*s,this.z=t.m02*e+t.m06*i+t.m10*n+t.m14*s,this.w=t.m03*e+t.m07*i+t.m11*n+t.m15*s,this}}function Di(t,e,i,n){return new Ii(t,e,i,n)}t("Vec4",Ii),Ii.ZERO=Object.freeze(new Ii(0,0,0,0)),Ii.ONE=Object.freeze(new Ii(1,1,1,1)),Ii.NEG_ONE=Object.freeze(new Ii(-1,-1,-1,-1)),Me.fastDefine("cc.Vec4",Ii,{x:0,y:0,z:0,w:0}),n.Vec4=Ii,n.v4=Di,z(Ti,"Vec2",[{name:"sub",newName:"subtract",target:Ti,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Ti,targetName:"Vec2"},{name:"div",newName:"divide",target:Ti,targetName:"Vec2"},{name:"dist",newName:"distance",target:Ti,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Ti,targetName:"Vec2"},{name:"mag",newName:"len",target:Ti,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Ti,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Ti,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Ti,targetName:"Vec2"}]),z(Ti.prototype,"Vec2",[{name:"mag",newName:"length",target:Ti.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Ti.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Ti.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Ti.prototype,targetName:"Vec2"}]),z(oi,"Vec3",[{name:"sub",newName:"subtract",target:oi,targetName:"Vec3"},{name:"mul",newName:"multiply",target:oi,targetName:"Vec3"},{name:"div",newName:"divide",target:oi,targetName:"Vec3"},{name:"dist",newName:"distance",target:oi,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:oi,targetName:"Vec3"},{name:"mag",newName:"len",target:oi,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:oi,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:oi,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:oi,targetName:"Vec3"}]),z(oi.prototype,"Vec3",[{name:"mag",newName:"length",target:oi.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:oi.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:oi.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:oi.prototype,targetName:"Vec3"}]),z(Ii,"Vec4",[{name:"sub",newName:"subtract",target:Ii,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Ii,targetName:"Vec4"},{name:"div",newName:"divide",target:Ii,targetName:"Vec4"},{name:"dist",newName:"distance",target:Ii,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Ii,targetName:"Vec4"},{name:"mag",newName:"len",target:Ii,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Ii,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Ii,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Ii,targetName:"Vec4"}]),z(Ii.prototype,"Vec4",[{name:"mag",newName:"length",target:Ii.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Ii.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Ii.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Ii.prototype,targetName:"Vec4"}]),z(mi,"Quat",[{name:"mag",newName:"len",target:mi,targetName:"Quat"},{name:"mul",newName:"multiply",target:mi,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:mi,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:mi,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:mi,targetName:"Quat"}]),z(mi.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:mi.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:mi.prototype,targetName:"Quat"}]),z(si,"Color",[{name:"sub",newName:"subtract",target:si,targetName:"Color"},{name:"mul",newName:"multiply",target:si,targetName:"Color"},{name:"div",newName:"divide",target:si,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:si,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction(...t){const e=t[1].toString(16);return n.Color.fromHEX(t[0],e)}}]),z(hi,"Mat3",[{name:"sub",newName:"subtract",target:hi,targetName:"Mat3"},{name:"mul",newName:"multiply",target:hi,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:hi,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:hi,targetName:"Mat3"}]),z(hi.prototype,"Mat3",[{name:"sub",newName:"subtract",target:hi.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:hi.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:hi.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:hi.prototype,targetName:"Mat3"}]),z(Si,"Mat4",[{name:"sub",newName:"subtract",target:Si,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Si,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Si,targetName:"Mat4"}]),z(Si.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Si.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Si.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Si.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Si.prototype,targetName:"Mat4"}]);class Ri{static identity(){return new Ri}static clone(t){return new Ri(t.a,t.b,t.c,t.d,t.tx,t.ty)}static concat(t,e,i){const n=e.a,s=e.b,r=e.c,o=e.d,a=e.tx,l=e.ty;t.a=n*i.a+s*i.c,t.b=n*i.b+s*i.d,t.c=r*i.a+o*i.c,t.d=r*i.b+o*i.d,t.tx=a*i.a+l*i.c+i.tx,t.ty=a*i.b+l*i.d+i.ty}static invert(t,e){const i=1/(e.a*e.d-e.b*e.c);t.a=i*e.d,t.b=-i*e.b,t.c=-i*e.c,t.d=i*e.a,t.tx=i*(e.c*e.ty-e.d*e.tx),t.ty=i*(e.b*e.tx-e.a*e.ty)}static fromMat4(t,e){t.a=e.m00,t.b=e.m01,t.c=e.m04,t.d=e.m05,t.tx=e.m12,t.ty=e.m13}static transformVec2(t,e,i,n){let s,r;void 0===n?(n=i,s=e.x,r=e.y):(s=e,r=i),t.x=n.a*s+n.c*r+n.tx,t.y=n.b*s+n.d*r+n.ty}static transformSize(t,e,i){t.width=i.a*e.width+i.c*e.height,t.height=i.b*e.width+i.d*e.height}static transformRect(t,e,i){const n=e.x+e.width,s=e.y+e.height,r=i.a*e.x+i.c*e.y+i.tx,o=i.b*e.x+i.d*e.y+i.ty,a=i.a*n+i.c*e.y+i.tx,l=i.b*n+i.d*e.y+i.ty,c=i.a*e.x+i.c*s+i.tx,h=i.b*e.x+i.d*s+i.ty,_=i.a*n+i.c*s+i.tx,u=i.b*n+i.d*s+i.ty,m=Math.min(r,a,c,_),d=Math.max(r,a,c,_),p=Math.min(o,l,h,u),f=Math.max(o,l,h,u);t.x=m,t.y=p,t.width=d-m,t.height=f-p}static transformObb(t,e,i,n,s,r){const o=r.a*s.x+r.c*s.y+r.tx,a=r.b*s.x+r.d*s.y+r.ty,l=r.a*s.width,c=r.b*s.width,h=r.c*s.height,_=r.d*s.height;e.x=o,e.y=a,i.x=l+o,i.y=c+a,t.x=h+o,t.y=_+a,n.x=l+h+o,n.y=c+_+a}constructor(t=1,e=0,i=0,n=1,s=0,r=0){this.a=t,this.b=e,this.c=i,this.d=n,this.tx=s,this.ty=r}}t("AffineTransform",Ri),n.AffineTransform=Ri;class Mi extends Wt{static lerp(t,e,i,n){return t.width=e.width+(i.width-e.width)*n,t.height=e.height+(i.height-e.height)*n,t}set x(t){this.width=t}get x(){return this.width}set y(t){this.height=t}get y(){return this.height}constructor(t,e){super(),t&&"object"==typeof t?(this.width=t.width,this.height=t.height):(this.width=t||0,this.height=e||0)}clone(){return new Mi(this.width,this.height)}set(t,e){return t&&"object"==typeof t?(this.height=t.height,this.width=t.width):(this.width=t||0,this.height=e||0),this}equals(t){return this.width===t.width&&this.height===t.height}lerp(t,e){return this.width+=(t.width-this.width)*e,this.height+=(t.height-this.height)*e,this}toString(){return`(${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}}function Bi(t=0,e=0){return new Mi(t,e)}t("Size",Mi),Mi.ZERO=Object.freeze(new Mi(0,0)),Mi.ONE=Object.freeze(new Mi(1,1)),Me.fastDefine("cc.Size",Mi,{width:0,height:0}),n.size=Bi,n.Size=Mi;class Oi extends Wt{static fromMinMax(t,e,i){const n=Math.min(e.x,i.x),s=Math.min(e.y,i.y),r=Math.max(e.x,i.x),o=Math.max(e.y,i.y);return t.x=n,t.y=s,t.width=r-n,t.height=o-s,t}static lerp(t,e,i,n){const s=e.x,r=e.y,o=e.width,a=e.height;return t.x=s+(i.x-s)*n,t.y=r+(i.y-r)*n,t.width=o+(i.width-o)*n,t.height=a+(i.height-a)*n,t}static intersection(t,e,i){const n=e.x,s=e.y,r=e.x+e.width,o=e.y+e.height,a=i.x,l=i.y,c=i.x+i.width,h=i.y+i.height;return t.x=Math.max(n,a),t.y=Math.max(s,l),t.width=Math.min(r,c)-t.x,t.height=Math.min(o,h)-t.y,t}static union(t,e,i){const n=e.x,s=e.y,r=e.width,o=e.height,a=i.x,l=i.y,c=i.width,h=i.height;return t.x=Math.min(n,a),t.y=Math.min(s,l),t.width=Math.max(n+r,a+c)-t.x,t.height=Math.max(s+o,l+h)-t.y,t}get xMin(){return this.x}set xMin(t){this.width+=this.x-t,this.x=t}get yMin(){return this.y}set yMin(t){this.height+=this.y-t,this.y=t}get xMax(){return this.x+this.width}set xMax(t){this.width=t-this.x}get yMax(){return this.y+this.height}set yMax(t){this.height=t-this.y}get center(){return new Ti(this.x+.5*this.width,this.y+.5*this.height)}set center(t){this.x=t.x-.5*this.width,this.y=t.y-.5*this.height}get origin(){return new Ti(this.x,this.y)}set origin(t){this.x=t.x,this.y=t.y}get size(){return new Mi(this.width,this.height)}set size(t){this.width=t.width,this.height=t.height}set z(t){this.width=t}get z(){return this.width}set w(t){this.height=t}get w(){return this.height}constructor(t,e,i,n){super(),t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=i||0,this.height=n||0)}clone(){return new Oi(this.x,this.y,this.width,this.height)}set(t,e,i,n){return t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=i||0,this.height=n||0),this}equals(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height}lerp(t,e){const i=this.x,n=this.y,s=this.width,r=this.height;return this.x=i+(t.x-i)*e,this.y=n+(t.y-n)*e,this.width=s+(t.width-s)*e,this.height=r+(t.height-r)*e,this}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}intersects(t){const e=this.x+this.width,i=this.y+this.height,n=t.x+t.width,s=t.y+t.height;return!(e<t.x||n<this.x||i<t.y||s<this.y)}contains(t){return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y}containsRect(t){return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height}transformMat4(t){const e=this.x,i=this.y,n=e+this.width,s=i+this.height,r=t.m00*e+t.m04*i+t.m12,o=t.m01*e+t.m05*i+t.m13,a=t.m00*n+t.m04*i+t.m12,l=t.m01*n+t.m05*i+t.m13,c=t.m00*e+t.m04*s+t.m12,h=t.m01*e+t.m05*s+t.m13,_=t.m00*n+t.m04*s+t.m12,u=t.m01*n+t.m05*s+t.m13,m=Math.min(r,a,c,_),d=Math.max(r,a,c,_),p=Math.min(o,l,h,u),f=Math.max(o,l,h,u);return this.x=m,this.y=p,this.width=d-m,this.height=f-p,this}transformMat4ToPoints(t,e,i,n,s){const r=this.x,o=this.y,a=r+this.width,l=o+this.height;e.x=t.m00*r+t.m04*o+t.m12,e.y=t.m01*r+t.m05*o+t.m13,s.x=t.m00*a+t.m04*o+t.m12,s.y=t.m01*a+t.m05*o+t.m13,i.x=t.m00*r+t.m04*l+t.m12,i.y=t.m01*r+t.m05*l+t.m13,n.x=t.m00*a+t.m04*l+t.m12,n.y=t.m01*a+t.m05*l+t.m13}}function Ni(t=0,e=0,i=0,n=0){return new Oi(t,e,i,n)}t("Rect",Oi),Me.fastDefine("cc.Rect",Oi,{x:0,y:0,width:0,height:0}),n.Rect=Oi,n.rect=Ni;var Li=Object.freeze({__proto__:null,bits:F,Vec2:Ti,v2:Pi,Vec3:oi,v3:ci,Vec4:Ii,v4:Di,Quat:mi,quat:vi,Mat3:hi,Mat4:Si,mat4:bi,AffineTransform:Ri,Size:Mi,size:Bi,Rect:Oi,rect:Ni,Color:si,color:ri,EPSILON:Fe,equals:ze,approx:Ve,clamp:Ue,clamp01:Ge,lerp:He,toRadian:ke,toDegree:je,random:We,randomRange:qe,randomRangeInt:Xe,pseudoRandom:Ye,pseudoRandomRange:Ke,pseudoRandomRangeInt:Je,nextPow2:$e,repeat:Ze,pingPong:Qe,inverseLerp:ti,absMaxComponent:ei,absMax:ii});t("math",Li);class Fi{constructor(t,e){this._ctor=void 0,this._elementsPerBatch=void 0,this._nextAvail=void 0,this._freepool=[],this._ctor=t,this._elementsPerBatch=Math.max(e,1),this._nextAvail=this._elementsPerBatch-1;for(let e=0;e<this._elementsPerBatch;++e)this._freepool.push(t())}alloc(){if(this._nextAvail<0){const t=this._elementsPerBatch;for(let e=0;e<t;e++)this._freepool.push(this._ctor());this._nextAvail=t-1}const t=this._freepool[this._nextAvail--];return this._freepool.length--,t}free(t){this._freepool.push(t),this._nextAvail++}freeArray(t){Array.prototype.push.apply(this._freepool,t),this._nextAvail+=t.length}destroy(t){if(t)for(let e=0;e<=this._nextAvail;e++)t(this._freepool[e]);this._freepool.length=0,this._nextAvail=-1}}t("Pool",Fi);class zi{constructor(t,e){this._fn=void 0,this._count=0,this._data=void 0,this._fn=t,this._data=new Array(e);for(let i=0;i<e;++i)this._data[i]=t()}get length(){return this._count}get data(){return this._data}reset(){this._count=0}resize(t){if(t>this._data.length)for(let e=this._data.length;e<t;++e)this._data[e]=this._fn()}add(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}removeAt(t){if(t>=this._count)return;const e=this._count-1,i=this._data[t];this._data[t]=this._data[e],this._data[e]=i,this._count-=1}}t("RecyclePool",zi);class Vi{constructor(t,e){this.array=void 0,this.length=0,this._compareFn=void 0,this.array=new Array(t),this.length=0,this._compareFn=void 0!==e?e:(t,e)=>t-e}push(t){this.array[this.length++]=t}pop(){return this.array[--this.length]}get(t){return this.array[t]}clear(){this.length=0}destroy(){this.length=0,this.array.length=0}sort(){this.array.length=this.length,this.array.sort(this._compareFn)}concat(t){for(let e=0;e<t.length;++e)this.array[this.length++]=t[e]}fastRemove(t){if(t>=this.length||t<0)return;const e=--this.length;this.array[t]=this.array[e]}indexOf(t){return this.array.indexOf(t)}}t("CachedArray",Vi),t("memop",Object.freeze({__proto__:null,Pool:Fi,RecyclePool:zi,CachedArray:Vi}));const Ui=[];class Gi{static _deferredDestroy(){const t=Ui.length;for(let e=0;e<t;++e){const t=Ui[e];1&t._objFlags||t._destroyImmediate()}t===Ui.length?Ui.length=0:Ui.splice(0,t)}constructor(t=""){this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}get name(){return this._name}set name(t){this._name=t}set hideFlags(t){const e=t&Gi.Flags.AllHideMasks;this._objFlags=this._objFlags&~Gi.Flags.AllHideMasks|e}get hideFlags(){return this._objFlags&Gi.Flags.AllHideMasks}get isValid(){return!(1&this._objFlags)}destroy(){return 1&this._objFlags?(C(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,Ui.push(this),0))}_destruct(){const t=this.constructor;let e=t.__destruct__;e||(e=function(t,e){const i=t instanceof n._BaseNode||t instanceof n.Component,s=i?"_id":null;let r;const o={};for(r in t)if(t.hasOwnProperty(r)){if(r===s)continue;switch(typeof t[r]){case"string":o[r]="";break;case"object":case"function":o[r]=null}}if(Me._isCCClass(e)){const t=n.Class.Attr.getClassAttrs(e),s=e.__props__;for(let e=0;e<s.length;e++){r=s[e];const a=`${r+n.Class.Attr.DELIMETER}default`;if(a in t){if(i&&"_id"===r)continue;switch(typeof t[a]){case"string":o[r]="";break;case"object":case"function":o[r]=null;break;case"undefined":o[r]=void 0}}}}{let t="";for(r in o){let e;e=Me.IDENTIFIER_RE.test(r)?`o.${r}=`:`o[${Me.escapeForJS(r)}]=`;let i=o[r];""===i&&(i='""'),t+=`${e+i};\n`}return Function("o",t)}}(this,t),ot(t,"__destruct__",e,!0)),e(this)}_destroyImmediate(){1&this._objFlags?T(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}}t("CCObject",Gi);const Hi=Gi.prototype;function ki(t,e){return"object"==typeof t?!(!t||t._objFlags&(e?5:1)):void 0!==t}Hi._deserialize=null,Hi._onPreDestroy=null,Me.fastDefine("cc.Object",Gi,{_name:"",_objFlags:0}),ot(Gi,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),n.isValid=ki,n.Object=Gi;const ji=zt.fastRemoveAt;function Wi(){}class qi{constructor(){this.callback=Wi,this.target=void 0,this.once=!1}set(t,e,i){this.callback=t||Wi,this.target=e,this.once=!!i}reset(){this.target=void 0,this.callback=Wi,this.once=!1}check(){return!(this.target instanceof Gi&&!ki(this.target,!0))}}const Xi=new Fi((()=>new qi),32);class Yi{constructor(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}removeByCallback(t){for(let e=0;e<this.callbackInfos.length;++e){const i=this.callbackInfos[e];i&&i.callback===t&&(i.reset(),Xi.free(i),ji(this.callbackInfos,e),--e)}}removeByTarget(t){for(let e=0;e<this.callbackInfos.length;++e){const i=this.callbackInfos[e];i&&i.target===t&&(i.reset(),Xi.free(i),ji(this.callbackInfos,e),--e)}}cancel(t){const e=this.callbackInfos[t];e&&(e.reset(),this.isInvoking?this.callbackInfos[t]=null:ji(this.callbackInfos,t),Xi.free(e)),this.containCanceled=!0}cancelAll(){for(let t=0;t<this.callbackInfos.length;t++){const e=this.callbackInfos[t];e&&(e.reset(),Xi.free(e),this.callbackInfos[t]=null)}this.containCanceled=!0}purgeCanceled(){for(let t=this.callbackInfos.length-1;t>=0;--t)this.callbackInfos[t]||ji(this.callbackInfos,t);this.containCanceled=!1}clear(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}const Ki=new Fi((()=>new Yi),16);class Ji{constructor(){this._callbackTable=ht(!0)}on(t,e,i,n){if(!this.hasEventListener(t,e,i)){let s=this._callbackTable[t];s||(s=this._callbackTable[t]=Ki.alloc());const r=Xi.alloc();r.set(e,i,n),s.callbackInfos.push(r)}return e}hasEventListener(t,e,i){const n=this._callbackTable&&this._callbackTable[t];if(!n)return!1;const s=n.callbackInfos;if(!e){if(n.isInvoking){for(let t=0;t<s.length;++t)if(s[t])return!0;return!1}return s.length>0}for(let t=0;t<s.length;++t){const n=s[t];if(n&&n.check()&&n.callback===e&&n.target===i)return!0}return!1}removeAll(t){if("string"==typeof t){const e=this._callbackTable&&this._callbackTable[t];e&&(e.isInvoking?e.cancelAll():(e.clear(),Ki.free(e),delete this._callbackTable[t]))}else if(t)for(const e in this._callbackTable){const i=this._callbackTable[e];if(i.isInvoking){const e=i.callbackInfos;for(let n=0;n<e.length;++n){const s=e[n];s&&s.target===t&&i.cancel(n)}}else i.removeByTarget(t)}}off(t,e,i){const n=this._callbackTable&&this._callbackTable[t];if(n){const s=n.callbackInfos;if(e)for(let t=0;t<s.length;++t){const r=s[t];if(r&&r.callback===e&&r.target===i){n.cancel(t);break}}else this.removeAll(t)}}emit(t,e,i,n,s,r){const o=this._callbackTable&&this._callbackTable[t];if(o){const a=!o.isInvoking;o.isInvoking=!0;const l=o.callbackInfos;for(let o=0,a=l.length;o<a;++o){const a=l[o];if(a){const o=a.callback,l=a.target;a.once&&this.off(t,o,l),a.check()?l?o.call(l,e,i,n,s,r):o(e,i,n,s,r):this.off(t,o,l)}}a&&(o.isInvoking=!1,o.containCanceled&&o.purgeCanceled())}}clear(){for(const t in this._callbackTable){const e=this._callbackTable[t];e&&(e.clear(),Ki.free(e),delete this._callbackTable[t])}}}function $i(t){class e extends t{constructor(...t){super(...t),this._callbackTable=ht(!0)}once(t,e,i){return this.on(t,e,i,!0)}targetOff(t){this.removeAll(t)}}const i=Ji.prototype,n=Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i));for(let t=0;t<n.length;++t){const s=n[t];if(!(s in e.prototype)){const t=Object.getOwnPropertyDescriptor(i,s);t&&Object.defineProperty(e.prototype,s,t)}}return e}const Zi=t("EventTarget",$i(class{}));let Qi,tn,en,nn,sn,rn,on;n.EventTarget=Zi,function(t){t.UNKNOWN="unknown",t.WECHAT="wechat",t.ANDROID="androidbrowser",t.IE="ie",t.EDGE="edge",t.QQ="qqbrowser",t.MOBILE_QQ="mqqbrowser",t.UC="ucbrowser",t.UCBS="ucbs",t.BROWSER_360="360browser",t.BAIDU_APP="baiduboxapp",t.BAIDU="baidubrowser",t.MAXTHON="maxthon",t.OPERA="opera",t.OUPENG="oupeng",t.MIUI="miuibrowser",t.FIREFOX="firefox",t.SAFARI="safari",t.CHROME="chrome",t.LIEBAO="liebao",t.QZONE="qzone",t.SOUGOU="sogou",t.HUAWEI="huawei"}(Qi||(Qi={})),function(t){t.HIDE="hide",t.SHOW="show",t.RESIZE="resize",t.ORIENTATION_CHANGE="orientation_change"}(tn||(tn={})),function(t){t.UNKNOWN="unknown",t.ENGLISH="en",t.CHINESE="zh",t.FRENCH="fr",t.ITALIAN="it",t.GERMAN="de",t.SPANISH="es",t.DUTCH="du",t.RUSSIAN="ru",t.KOREAN="ko",t.JAPANESE="ja",t.HUNGARIAN="hu",t.PORTUGUESE="pt",t.ARABIC="ar",t.NORWEGIAN="no",t.POLISH="pl",t.TURKISH="tr",t.UKRAINIAN="uk",t.ROMANIAN="ro",t.BULGARIAN="bg"}(en||(en={})),function(t){t[t.NONE=0]="NONE",t[t.LAN=1]="LAN",t[t.WWAN=2]="WWAN"}(nn||(nn={})),function(t){t.UNKNOWN="Unknown",t.IOS="iOS",t.ANDROID="Android",t.WINDOWS="Windows",t.LINUX="Linux",t.OSX="OS X",t.OHOS="OHOS"}(sn||(sn={})),function(t){t[t.PORTRAIT=1]="PORTRAIT",t[t.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",t[t.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",t[t.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",t[t.LANDSCAPE=12]="LANDSCAPE"}(rn||(rn={})),function(t){t.UNKNOWN="UNKNOWN",t.EDITOR_PAGE="EDITOR_PAGE",t.EDITOR_CORE="EDITOR_CORE",t.MOBILE_BROWSER="MOBILE_BROWSER",t.DESKTOP_BROWSER="DESKTOP_BROWSER",t.WIN32="WIN32",t.ANDROID="ANDROID",t.IOS="IOS",t.MACOS="MACOS",t.OHOS="OHOS",t.WECHAT_GAME="WECHAT_GAME",t.BAIDU_MINI_GAME="BAIDU_MINI_GAME",t.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",t.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",t.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",t.OPPO_MINI_GAME="OPPO_MINI_GAME",t.VIVO_MINI_GAME="VIVO_MINI_GAME",t.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",t.COCOSPLAY="COCOSPLAY",t.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",t.QTT_MINI_GAME="QTT_MINI_GAME"}(on||(on={}));const an={0:rn.PORTRAIT,"-90":rn.LANDSCAPE_LEFT,90:rn.LANDSCAPE_RIGHT,180:rn.PORTRAIT_UPSIDE_DOWN},ln={},cn={0:on.WIN32,2:on.MACOS,3:on.ANDROID,4:on.IOS,5:on.IOS,6:on.OHOS},hn=new class{get networkType(){return ln[jsb.device.getNetworkType()]}constructor(){this.isNative=void 0,this.isBrowser=void 0,this.isMobile=void 0,this.isLittleEndian=void 0,this.platform=void 0,this.language=void 0,this.nativeLanguage=void 0,this.os=void 0,this.osVersion=void 0,this.osMainVersion=void 0,this.browserType=void 0,this.browserVersion=void 0,this.pixelRatio=void 0,this.supportCapability=void 0,this._eventTarget=new Zi,this.isNative=!0,this.isBrowser=!1,this.platform=cn[__getPlatform()],this.isMobile=this.platform===on.ANDROID||this.platform===on.IOS||this.platform===on.OHOS,this.isLittleEndian=(()=>{const t=new ArrayBuffer(2);return new DataView(t).setInt16(0,256,!0),256===new Int16Array(t)[0]})();const t=__getCurrentLanguageCode();this.nativeLanguage=t?t.toLowerCase():en.UNKNOWN,this.language=__getCurrentLanguage(),this.os=__getOS(),this.osVersion=__getOSVersion(),this.osMainVersion=parseInt(this.osVersion),this.browserType=Qi.UNKNOWN,this.browserVersion="",this.pixelRatio=jsb.device.getDevicePixelRatio()||1,this.supportCapability={webp:!0,gl:!0,canvas:!0,imageBitmap:!1},this._registerEvent()}_registerEvent(){jsb.onResize=t=>{0!==t.width&&0!==t.height&&(t.width/=this.pixelRatio,t.height/=this.pixelRatio,window.resize(t.width,t.height),this._eventTarget.emit(tn.RESIZE))},jsb.onOrientationChanged=()=>{this._eventTarget.emit(tn.ORIENTATION_CHANGE)},jsb.onPause=()=>{this._eventTarget.emit(tn.HIDE)},jsb.onResume=()=>{this._eventTarget.emit(tn.SHOW)}}getViewSize(){return new Mi(window.innerWidth,window.innerHeight)}getOrientation(){return an[jsb.device.getDeviceOrientation()]}getSafeAreaEdge(){const t=jsb.device.getSafeAreaEdge();let e=t.x,i=t.z,n=t.y,s=t.w;return this.getOrientation()===rn.PORTRAIT?e<i?e=i:i=e:n<s?n=s:s=n,{top:e,bottom:i,left:n,right:s}}getBatteryLevel(){return jsb.device.getBatteryLevel()}triggerGC(){jsb.garbageCollect()}openURL(t){jsb.openURL(t)}now(){return Date.now?Date.now():+new Date}restartJSVM(){__restartVM()}onHide(t){this._eventTarget.on(tn.HIDE,t)}onShow(t){this._eventTarget.on(tn.SHOW,t)}onViewResize(t){this._eventTarget.on(tn.RESIZE,t)}onOrientationChange(t){this._eventTarget.on(tn.ORIENTATION_CHANGE,t)}offHide(t){this._eventTarget.off(tn.HIDE,t)}offShow(t){this._eventTarget.off(tn.SHOW,t)}offViewResize(t){this._eventTarget.off(tn.RESIZE,t)}offOrientationChange(t){this._eventTarget.off(tn.ORIENTATION_CHANGE,t)}},_n=/(\.[^\.\/\?\\]*)(\?.*)?$/,un=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,mn=/[^\.\/]+\/\.\.\//;function dn(...t){let e="";for(const i of t)e=(e+(""===e?"":"/")+i).replace(/(\/|\\\\)$/,"");return e}function pn(t){const e=_n.exec(t);return e?e[1]:""}function fn(t){if(t){const e=t.lastIndexOf(".");if(-1!==e)return t.substring(0,e)}return t}function gn(t,e){const i=t.indexOf("?");i>0&&(t=t.substring(0,i));const n=/(\/|\\)([^\/\\]+)$/g.exec(t.replace(/(\/|\\)$/,""));if(!n)return t;const s=n[2];return e&&t.substring(t.length-e.length).toLowerCase()===e.toLowerCase()?s.substring(0,s.length-e.length):s}function yn(t){const e=un.exec(t);return e?e[2]:""}function vn(t,e){e=e||"";let i=t.indexOf("?"),n="";return i>0&&(n=t.substring(i),t=t.substring(0,i)),i=t.lastIndexOf("."),i<0?t+e+n:t.substring(0,i)+e+n}function xn(t,e,i){if(0===e.indexOf("."))return vn(t,e);let n=t.indexOf("?"),s="";const r=i?pn(t):"";return n>0&&(s=t.substring(n),t=t.substring(0,n)),n=t.lastIndexOf("/"),n=n<=0?0:n+1,t.substring(0,n)+e+r+s}function Sn(t){let e=t=String(t);do{e=t,t=t.replace(mn,"")}while(e.length!==t.length);return t}function An(t){return t.replace(/[\/\\]$/,"")}function Cn(){return hn.os===sn.WINDOWS?"\\":"/"}t("path",Object.freeze({__proto__:null,join:dn,extname:pn,mainFileName:fn,basename:gn,dirname:yn,changeExtname:vn,changeBasename:xn,_normalize:Sn,stripSep:An,getSeperator:Cn})),n.log=u,n.warn=m,n.error=d,n.assert=p,n._throw=y,n.logID=S,n.warnID=C,n.errorID=T,n.assertID=E,n.debug=M,n.path={join:dn,extname:pn,mainFileName:fn,basename:gn,dirname:yn,changeExtname:vn,changeBasename:xn,_normalize:Sn,stripSep:An,get sep(){return Cn()}};let bn=0;const Tn={};var wn={addStage(t){if(void 0!==Tn[t])return;const e=1<<bn;Tn[t]=e,bn+=1},stageID(t){const e=Tn[t];return void 0===e?-1:e},stageIDs(t){let e=0;for(const i of t){const t=Tn[i];void 0!==t&&(e|=t)}return e}};const En=jsb.NativeBufferPool,Pn=jsb.NativeObjectPool,In=jsb.NativeBufferAllocator;var Dn;!function(t){t[t.UINT32=0]="UINT32",t[t.FLOAT32=1]="FLOAT32",t[t.NEVER=2]="NEVER"}(Dn||(Dn={}));class Rn{constructor(t,e,i,n=8){this._dataType=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freelists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=n,this._dataType=e,this._stride=4*this._elementCount,this._entriesPerChunk=1<<n,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new En(t,n,this._stride);let s=Dn.NEVER,r=!1,o=!1;for(const t in e){if(r=this._hasFloat32,o=this._hasUint32,o&&r)break;s=e[t],r||s!==Dn.FLOAT32?o||s!==Dn.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}alloc(){let t=0;for(;t<this._freelists.length;t++){const e=this._freelists[t];if(e.length){const i=e[e.length-1];return e.length--,(t<<this._entryBits)+i+this._poolFlag}}const e=this._nativePool.allocateNewChunk(),i=[],n=[],s=[],r=this._hasFloat32,o=this._hasUint32;for(let t=0;t<this._entriesPerChunk;t++)r&&i.push(new Float32Array(e,this._stride*t,this._elementCount)),o&&n.push(new Uint32Array(e,this._stride*t,this._elementCount)),t&&s.push(t);return this._arrayBuffers.push(e),o&&this._uint32BufferViews.push(n),r&&this._float32BufferViews.push(i),this._freelists.push(s),(t<<this._entryBits)+this._poolFlag}get(t,e){const i=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t;return(this._dataType[e]===Dn.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][n][e]}set(t,e,i){const n=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;(this._dataType[e]===Dn.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][s][e]=i}setVec2(t,e,i){const n=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let r=e;const o=(this._dataType[e]===Dn.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][s];o[r++]=i.x,o[r++]=i.y}setVec3(t,e,i){const n=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let r=e;const o=(this._dataType[e]===Dn.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][s];o[r++]=i.x,o[r++]=i.y,o[r]=i.z}getVec3(t,e,i){const n=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let r=e;const o=(this._dataType[e]===Dn.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][s];i.x=o[r++],i.y=o[r++],i.z=o[r]}setVec4(t,e,i){const n=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let r=e;const o=(this._dataType[e]===Dn.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][s];o[r++]=i.x,o[r++]=i.y,o[r++]=i.z,o[r]=i.w}getVec4(t,e,i){const n=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let r=e;const o=(this._dataType[e]===Dn.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][s];i.x=o[r++],i.y=o[r++],i.z=o[r++],i.w=o[r]}setMat4(t,e,i){const n=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let r=e;const o=(this._dataType[e]===Dn.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][s];o[r++]=i.m00,o[r++]=i.m01,o[r++]=i.m02,o[r++]=i.m03,o[r++]=i.m04,o[r++]=i.m05,o[r++]=i.m06,o[r++]=i.m07,o[r++]=i.m08,o[r++]=i.m09,o[r++]=i.m10,o[r++]=i.m11,o[r++]=i.m12,o[r++]=i.m13,o[r++]=i.m14,o[r]=i.m15}free(t){const e=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[e][i].fill(0),this._freelists[e].push(i)}}class Mn{constructor(t,e,i){this._ctor=void 0,this._dtor=void 0,this._indexMask=void 0,this._poolFlag=void 0,this._array=[],this._freelist=[],this._nativePool=void 0,this._ctor=e,i&&(this._dtor=i),this._poolFlag=1<<29,this._indexMask=~this._poolFlag,this._nativePool=new Pn(t,this._array)}alloc(...t){const e=this._freelist;let i=-1;if(e.length)i=e[e.length-1],e.length--,this._array[i]=this._ctor(arguments,this._array[i]);else{i=this._array.length;const t=this._ctor(arguments);if(!t)return 0;this._array.push(t)}return this._nativePool.bind(i,this._array[i]),i+this._poolFlag}get(t){const e=this._indexMask&t;return this._array[e]}free(t){const e=this._indexMask&t;this._dtor&&(this._array[e]=this._dtor(this._array[e])),this._freelist.push(e)}}class Bn{constructor(t){this._nativeBufferAllocator=void 0,this._buffers=new Map,this._nextBufferIdx=0,this._poolFlag=void 0,this._bufferIdxMask=void 0,this._freelist=[],this._poolFlag=1<<30,this._bufferIdxMask=~this._poolFlag,this._nativeBufferAllocator=new In(t)}alloc(t){const e=this._freelist;let i=-1;e.length?(i=e[e.length-1],e.length--):i=this._nextBufferIdx++;const n=this._nativeBufferAllocator.alloc(i,t);return this._buffers.set(i,n),i|this._poolFlag}free(t){const e=this._bufferIdxMask&t;this._buffers.get(e)&&(this._nativeBufferAllocator.free(e),this._buffers.delete(e),this._freelist.push(e))}getBuffer(t){const e=this._bufferIdxMask&t;return this._buffers.get(e)||null}}class On extends Bn{constructor(t,e,i,n){super(t),this._viewCtor=void 0,this._size=void 0,this._step=void 0,this._viewCtor=e,this._size=i*e.BYTES_PER_ELEMENT,this._step=n||i}alloc(){const t=this._nextBufferIdx++,e=this._nativeBufferAllocator.alloc(t,this._size);return this._buffers.set(t,new this._viewCtor(e)),t|this._poolFlag}getBuffer(t){return null}assign(t,e,i){const n=this._bufferIdxMask&t;let s=this._buffers.get(n);if(!s)return;const r=e+1;if(r>=s.length){let t=s.length;for(;r>=t;)t+=this._step;t*=this._viewCtor.BYTES_PER_ELEMENT;const e=new this._viewCtor(this._nativeBufferAllocator.alloc(n,t));e.set(s),s=e,this._buffers.set(n,s)}s[r]=i;const o=s[0];s[0]=r>o?r:o}erase(t,e){const i=this._bufferIdxMask&t,n=this._buffers.get(i);if(n&&!(e>=n[0])){for(let t=e+1;t<n[0];++t)n[t]=n[t+1];--n[0]}}push(t,e){const i=this._bufferIdxMask&t,n=this._buffers.get(i);n&&this.assign(t,n[0],e)}pop(t){const e=this._bufferIdxMask&t,i=this._buffers.get(e);i&&0!==i[0]&&--i[0]}clear(t){const e=this._bufferIdxMask&t,i=this._buffers.get(e);i&&(i[0]=0)}get(t,e){const i=this._bufferIdxMask&t,n=this._buffers.get(i);return!n||e>=n[0]?0:n[e+1]}length(t){const e=this._bufferIdxMask&t,i=this._buffers.get(e);return i?i[0]:0}}function Nn(t,e,i,n=!0){const s=e.length(t);for(let n=0;n<s;n++){const s=e.get(t,n);s&&i.free(s)}n?e.free(t):e.clear(t)}let Ln;!function(t){t[t.ATTRIBUTE=0]="ATTRIBUTE",t[t.DESCRIPTOR_SETS=1]="DESCRIPTOR_SETS",t[t.SHADER=2]="SHADER",t[t.INPUT_ASSEMBLER=3]="INPUT_ASSEMBLER",t[t.PIPELINE_LAYOUT=4]="PIPELINE_LAYOUT",t[t.FRAMEBUFFER=5]="FRAMEBUFFER",t[t.PASS=100]="PASS",t[t.SUB_MODEL=101]="SUB_MODEL",t[t.MODEL=102]="MODEL",t[t.SCENE=103]="SCENE",t[t.CAMERA=104]="CAMERA",t[t.NODE=105]="NODE",t[t.ROOT=106]="ROOT",t[t.AABB=107]="AABB",t[t.RENDER_WINDOW=108]="RENDER_WINDOW",t[t.FRUSTUM=109]="FRUSTUM",t[t.AMBIENT=110]="AMBIENT",t[t.FOG=111]="FOG",t[t.SKYBOX=112]="SKYBOX",t[t.SHADOW=113]="SHADOW",t[t.LIGHT=114]="LIGHT",t[t.SPHERE=115]="SPHERE",t[t.INSTANCED_ATTRIBUTE=116]="INSTANCED_ATTRIBUTE",t[t.FLAT_BUFFER=117]="FLAT_BUFFER",t[t.SUB_MESH=118]="SUB_MESH",t[t.RASTERIZER_STATE=119]="RASTERIZER_STATE",t[t.DEPTH_STENCIL_STATE=120]="DEPTH_STENCIL_STATE",t[t.BLEND_TARGET=121]="BLEND_TARGET",t[t.BLEND_STATE=122]="BLEND_STATE",t[t.BATCH_2D=123]="BATCH_2D",t[t.PIPELINE_SCENE_DATA=124]="PIPELINE_SCENE_DATA",t[t.SUB_MODEL_ARRAY=200]="SUB_MODEL_ARRAY",t[t.MODEL_ARRAY=201]="MODEL_ARRAY",t[t.ATTRIBUTE_ARRAY=202]="ATTRIBUTE_ARRAY",t[t.FLAT_BUFFER_ARRAY=203]="FLAT_BUFFER_ARRAY",t[t.INSTANCED_BUFFER_ARRAY=204]="INSTANCED_BUFFER_ARRAY",t[t.LIGHT_ARRAY=205]="LIGHT_ARRAY",t[t.BLEND_TARGET_ARRAY=206]="BLEND_TARGET_ARRAY",t[t.BATCH_ARRAY_2D=207]="BATCH_ARRAY_2D",t[t.RAW_BUFFER=300]="RAW_BUFFER",t[t.RAW_OBJECT=400]="RAW_OBJECT"}(Ln||(Ln={}));const Fn=new Mn(Ln.SHADER,((t,e)=>e?(e.initialize(t[1]),e):t[0].createShader(t[1])),(t=>(t&&t.destroy(),t))),zn=new Mn(Ln.DESCRIPTOR_SETS,((t,e)=>e?(e.initialize(t[1]),e):t[0].createDescriptorSet(t[1])),(t=>(t&&t.destroy(),t))),Vn=new Mn(Ln.INPUT_ASSEMBLER,((t,e)=>e?(e.initialize(t[1]),e):t[0].createInputAssembler(t[1])),(t=>(t&&t.destroy(),t))),Un=new Mn(Ln.PIPELINE_LAYOUT,((t,e)=>e?(e.initialize(t[1]),e):t[0].createPipelineLayout(t[1])),(t=>(t&&t.destroy(),t))),Gn=new Mn(Ln.FRAMEBUFFER,((t,e)=>e?(e.initialize(t[1]),e):t[0].createFramebuffer(t[1])),(t=>(t&&t.destroy(),t))),Hn=new On(Ln.SUB_MODEL_ARRAY,Uint32Array,8,4),kn=new On(Ln.MODEL_ARRAY,Uint32Array,32,16),jn=new On(Ln.ATTRIBUTE_ARRAY,Uint32Array,8,4),Wn=new On(Ln.FLAT_BUFFER_ARRAY,Uint32Array,8,4),qn=new On(Ln.LIGHT_ARRAY,Uint32Array,8,4),Xn=new On(Ln.BLEND_TARGET_ARRAY,Uint32Array,8,4),Yn=new On(Ln.BATCH_ARRAY_2D,Uint32Array,32,16),Kn=new Bn(Ln.RAW_BUFFER),Jn=new Mn(Ln.RAW_OBJECT,(t=>t[0]||{}),(()=>{}));let $n;!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.STAGE=1]="STAGE",t[t.PHASE=2]="PHASE",t[t.BATCHING_SCHEME=3]="BATCHING_SCHEME",t[t.PRIMITIVE=4]="PRIMITIVE",t[t.DYNAMIC_STATES=5]="DYNAMIC_STATES",t[t.HASH=6]="HASH",t[t.RASTERIZER_STATE=7]="RASTERIZER_STATE",t[t.DEPTH_STENCIL_STATE=8]="DEPTH_STENCIL_STATE",t[t.BLEND_STATE=9]="BLEND_STATE",t[t.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",t[t.PIPELINE_LAYOUT=11]="PIPELINE_LAYOUT",t[t.COUNT=12]="COUNT"}($n||($n={}));const Zn={[$n.PRIORITY]:Dn.UINT32,[$n.STAGE]:Dn.UINT32,[$n.PHASE]:Dn.UINT32,[$n.BATCHING_SCHEME]:Dn.UINT32,[$n.PRIMITIVE]:Dn.UINT32,[$n.DYNAMIC_STATES]:Dn.UINT32,[$n.HASH]:Dn.UINT32,[$n.RASTERIZER_STATE]:Dn.UINT32,[$n.DEPTH_STENCIL_STATE]:Dn.UINT32,[$n.BLEND_STATE]:Dn.UINT32,[$n.DESCRIPTOR_SET]:Dn.UINT32,[$n.PIPELINE_LAYOUT]:Dn.UINT32,[$n.COUNT]:Dn.NEVER},Qn=new Rn(Ln.PASS,Zn,$n);let ts;!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.PASS_COUNT=1]="PASS_COUNT",t[t.PASS_0=2]="PASS_0",t[t.PASS_1=3]="PASS_1",t[t.PASS_2=4]="PASS_2",t[t.PASS_3=5]="PASS_3",t[t.PASS_4=6]="PASS_4",t[t.PASS_5=7]="PASS_5",t[t.PASS_6=8]="PASS_6",t[t.PASS_7=9]="PASS_7",t[t.SHADER_0=10]="SHADER_0",t[t.SHADER_1=11]="SHADER_1",t[t.SHADER_2=12]="SHADER_2",t[t.SHADER_3=13]="SHADER_3",t[t.SHADER_4=14]="SHADER_4",t[t.SHADER_5=15]="SHADER_5",t[t.SHADER_6=16]="SHADER_6",t[t.SHADER_7=17]="SHADER_7",t[t.PLANAR_SHADER=18]="PLANAR_SHADER",t[t.PLANAR_INSTANCE_SHADER=19]="PLANAR_INSTANCE_SHADER",t[t.DESCRIPTOR_SET=20]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=21]="INPUT_ASSEMBLER",t[t.SUB_MESH=22]="SUB_MESH",t[t.COUNT=23]="COUNT"}(ts||(ts={}));const es={[ts.PRIORITY]:Dn.UINT32,[ts.PASS_COUNT]:Dn.UINT32,[ts.PASS_0]:Dn.UINT32,[ts.PASS_1]:Dn.UINT32,[ts.PASS_2]:Dn.UINT32,[ts.PASS_3]:Dn.UINT32,[ts.PASS_4]:Dn.UINT32,[ts.PASS_5]:Dn.UINT32,[ts.PASS_6]:Dn.UINT32,[ts.PASS_7]:Dn.UINT32,[ts.SHADER_0]:Dn.UINT32,[ts.SHADER_1]:Dn.UINT32,[ts.SHADER_2]:Dn.UINT32,[ts.SHADER_3]:Dn.UINT32,[ts.SHADER_4]:Dn.UINT32,[ts.SHADER_5]:Dn.UINT32,[ts.SHADER_6]:Dn.UINT32,[ts.SHADER_7]:Dn.UINT32,[ts.PLANAR_SHADER]:Dn.UINT32,[ts.PLANAR_INSTANCE_SHADER]:Dn.UINT32,[ts.DESCRIPTOR_SET]:Dn.UINT32,[ts.INPUT_ASSEMBLER]:Dn.UINT32,[ts.SUB_MESH]:Dn.UINT32,[ts.COUNT]:Dn.NEVER},is=new Rn(Ln.SUB_MODEL,es,ts);let ns;!function(t){t[t.ENABLED=0]="ENABLED",t[t.VIS_FLAGS=1]="VIS_FLAGS",t[t.CAST_SHADOW=2]="CAST_SHADOW",t[t.RECEIVE_SHADOW=3]="RECEIVE_SHADOW",t[t.WORLD_BOUNDS=4]="WORLD_BOUNDS",t[t.NODE=5]="NODE",t[t.TRANSFORM=6]="TRANSFORM",t[t.SUB_MODEL_ARRAY=7]="SUB_MODEL_ARRAY",t[t.INSTANCED_BUFFER=8]="INSTANCED_BUFFER",t[t.INSTANCED_ATTR_ARRAY=9]="INSTANCED_ATTR_ARRAY",t[t.COUNT=10]="COUNT"}(ns||(ns={}));const ss={[ns.ENABLED]:Dn.UINT32,[ns.VIS_FLAGS]:Dn.UINT32,[ns.CAST_SHADOW]:Dn.UINT32,[ns.RECEIVE_SHADOW]:Dn.UINT32,[ns.WORLD_BOUNDS]:Dn.UINT32,[ns.NODE]:Dn.UINT32,[ns.TRANSFORM]:Dn.UINT32,[ns.SUB_MODEL_ARRAY]:Dn.UINT32,[ns.INSTANCED_BUFFER]:Dn.UINT32,[ns.INSTANCED_ATTR_ARRAY]:Dn.UINT32,[ns.COUNT]:Dn.NEVER},rs=new Rn(Ln.MODEL,ss,ns);let os;!function(t){t[t.VIS_FLAGS=0]="VIS_FLAGS",t[t.PASS_COUNT=1]="PASS_COUNT",t[t.PASS_0=2]="PASS_0",t[t.PASS_1=3]="PASS_1",t[t.PASS_2=4]="PASS_2",t[t.PASS_3=5]="PASS_3",t[t.SHADER_0=6]="SHADER_0",t[t.SHADER_1=7]="SHADER_1",t[t.SHADER_2=8]="SHADER_2",t[t.SHADER_3=9]="SHADER_3",t[t.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",t[t.COUNT=12]="COUNT"}(os||(os={}));const as={[os.VIS_FLAGS]:Dn.UINT32,[os.PASS_COUNT]:Dn.UINT32,[os.PASS_0]:Dn.UINT32,[os.PASS_1]:Dn.UINT32,[os.PASS_2]:Dn.UINT32,[os.PASS_3]:Dn.UINT32,[os.SHADER_0]:Dn.UINT32,[os.SHADER_1]:Dn.UINT32,[os.SHADER_2]:Dn.UINT32,[os.SHADER_3]:Dn.UINT32,[os.DESCRIPTOR_SET]:Dn.UINT32,[os.INPUT_ASSEMBLER]:Dn.UINT32,[os.COUNT]:Dn.NEVER},ls=new Rn(Ln.BATCH_2D,as,os);let cs;!function(t){t[t.CENTER=0]="CENTER",t[t.HALF_EXTENSION=3]="HALF_EXTENSION",t[t.COUNT=6]="COUNT"}(cs||(cs={}));const hs={[cs.CENTER]:Dn.FLOAT32,[cs.HALF_EXTENSION]:Dn.FLOAT32,[cs.COUNT]:Dn.NEVER},_s=new Rn(Ln.AABB,hs,cs);let us;!function(t){t[t.MAIN_LIGHT=0]="MAIN_LIGHT",t[t.MODEL_ARRAY=1]="MODEL_ARRAY",t[t.SPHERE_LIGHT_ARRAY=2]="SPHERE_LIGHT_ARRAY",t[t.SPOT_LIGHT_ARRAY=3]="SPOT_LIGHT_ARRAY",t[t.BATCH_ARRAY_2D=4]="BATCH_ARRAY_2D",t[t.COUNT=5]="COUNT"}(us||(us={}));const ms={[us.MAIN_LIGHT]:Dn.UINT32,[us.MODEL_ARRAY]:Dn.UINT32,[us.SPHERE_LIGHT_ARRAY]:Dn.UINT32,[us.SPOT_LIGHT_ARRAY]:Dn.UINT32,[us.BATCH_ARRAY_2D]:Dn.UINT32,[us.COUNT]:Dn.NEVER},ds=new Rn(Ln.SCENE,ms,us);let ps;!function(t){t[t.WIDTH=0]="WIDTH",t[t.HEIGHT=1]="HEIGHT",t[t.EXPOSURE=2]="EXPOSURE",t[t.CLEAR_FLAGS=3]="CLEAR_FLAGS",t[t.CLEAR_DEPTH=4]="CLEAR_DEPTH",t[t.CLEAR_STENCIL=5]="CLEAR_STENCIL",t[t.VISIBILITY=6]="VISIBILITY",t[t.NODE=7]="NODE",t[t.SCENE=8]="SCENE",t[t.FRUSTUM=9]="FRUSTUM",t[t.WINDOW=10]="WINDOW",t[t.FORWARD=11]="FORWARD",t[t.POSITION=14]="POSITION",t[t.VIEW_PORT=17]="VIEW_PORT",t[t.CLEAR_COLOR=21]="CLEAR_COLOR",t[t.MAT_VIEW=25]="MAT_VIEW",t[t.MAT_VIEW_PROJ=41]="MAT_VIEW_PROJ",t[t.MAT_VIEW_PROJ_INV=57]="MAT_VIEW_PROJ_INV",t[t.MAT_PROJ=73]="MAT_PROJ",t[t.MAT_PROJ_INV=89]="MAT_PROJ_INV",t[t.MAT_VIEW_PROJ_OFFSCREEN=105]="MAT_VIEW_PROJ_OFFSCREEN",t[t.MAT_VIEW_PROJ_INV_OFFSCREEN=121]="MAT_VIEW_PROJ_INV_OFFSCREEN",t[t.MAT_PROJ_OFFSCREEN=137]="MAT_PROJ_OFFSCREEN",t[t.MAT_PROJ_INV_OFFSCREEN=153]="MAT_PROJ_INV_OFFSCREEN",t[t.COUNT=169]="COUNT"}(ps||(ps={}));const fs={[ps.WIDTH]:Dn.UINT32,[ps.HEIGHT]:Dn.UINT32,[ps.EXPOSURE]:Dn.FLOAT32,[ps.CLEAR_FLAGS]:Dn.UINT32,[ps.CLEAR_DEPTH]:Dn.FLOAT32,[ps.CLEAR_STENCIL]:Dn.UINT32,[ps.VISIBILITY]:Dn.UINT32,[ps.NODE]:Dn.UINT32,[ps.SCENE]:Dn.UINT32,[ps.FRUSTUM]:Dn.UINT32,[ps.WINDOW]:Dn.UINT32,[ps.FORWARD]:Dn.FLOAT32,[ps.POSITION]:Dn.FLOAT32,[ps.VIEW_PORT]:Dn.FLOAT32,[ps.CLEAR_COLOR]:Dn.FLOAT32,[ps.MAT_VIEW]:Dn.FLOAT32,[ps.MAT_VIEW_PROJ]:Dn.FLOAT32,[ps.MAT_VIEW_PROJ_INV]:Dn.FLOAT32,[ps.MAT_PROJ]:Dn.FLOAT32,[ps.MAT_PROJ_INV]:Dn.FLOAT32,[ps.MAT_VIEW_PROJ_OFFSCREEN]:Dn.FLOAT32,[ps.MAT_VIEW_PROJ_INV_OFFSCREEN]:Dn.FLOAT32,[ps.MAT_PROJ_OFFSCREEN]:Dn.FLOAT32,[ps.MAT_PROJ_INV_OFFSCREEN]:Dn.FLOAT32,[ps.COUNT]:Dn.NEVER},gs=new Rn(Ln.CAMERA,fs,ps);let ys;!function(t){t[t.FLAGS_CHANGED=0]="FLAGS_CHANGED",t[t.LAYER=1]="LAYER",t[t.WORLD_SCALE=2]="WORLD_SCALE",t[t.WORLD_POSITION=5]="WORLD_POSITION",t[t.WORLD_ROTATION=8]="WORLD_ROTATION",t[t.WORLD_MATRIX=12]="WORLD_MATRIX",t[t.COUNT=28]="COUNT"}(ys||(ys={}));const vs={[ys.FLAGS_CHANGED]:Dn.UINT32,[ys.LAYER]:Dn.UINT32,[ys.WORLD_SCALE]:Dn.FLOAT32,[ys.WORLD_POSITION]:Dn.FLOAT32,[ys.WORLD_ROTATION]:Dn.FLOAT32,[ys.WORLD_MATRIX]:Dn.FLOAT32,[ys.COUNT]:Dn.NEVER},xs=new Rn(Ln.NODE,vs,ys);let Ss;!function(t){t[t.CUMULATIVE_TIME=0]="CUMULATIVE_TIME",t[t.FRAME_TIME=1]="FRAME_TIME",t[t.COUNT=2]="COUNT"}(Ss||(Ss={}));const As={[Ss.CUMULATIVE_TIME]:Dn.FLOAT32,[Ss.FRAME_TIME]:Dn.FLOAT32,[Ss.COUNT]:Dn.NEVER},Cs=new Rn(Ln.ROOT,As,Ss,1);let bs;!function(t){t[t.HAS_ON_SCREEN_ATTACHMENTS=0]="HAS_ON_SCREEN_ATTACHMENTS",t[t.HAS_OFF_SCREEN_ATTACHMENTS=1]="HAS_OFF_SCREEN_ATTACHMENTS",t[t.FRAMEBUFFER=2]="FRAMEBUFFER",t[t.COUNT=3]="COUNT"}(bs||(bs={}));const Ts={[bs.HAS_ON_SCREEN_ATTACHMENTS]:Dn.UINT32,[bs.HAS_OFF_SCREEN_ATTACHMENTS]:Dn.UINT32,[bs.FRAMEBUFFER]:Dn.UINT32,[bs.COUNT]:Dn.NEVER},ws=new Rn(Ln.RENDER_WINDOW,Ts,bs,2);let Es;!function(t){t[t.VERTICES=0]="VERTICES",t[t.PLANES=24]="PLANES",t[t.COUNT=48]="COUNT"}(Es||(Es={}));const Ps={[Es.VERTICES]:Dn.FLOAT32,[Es.PLANES]:Dn.FLOAT32,[Es.COUNT]:Dn.NEVER},Is=new Rn(Ln.FRUSTUM,Ps,Es);let Ds;!function(t){t[t.ENABLE=0]="ENABLE",t[t.ILLUM=1]="ILLUM",t[t.SKY_COLOR=2]="SKY_COLOR",t[t.GROUND_ALBEDO=6]="GROUND_ALBEDO",t[t.COUNT=10]="COUNT"}(Ds||(Ds={}));const Rs={[Ds.ENABLE]:Dn.UINT32,[Ds.ILLUM]:Dn.FLOAT32,[Ds.SKY_COLOR]:Dn.FLOAT32,[Ds.GROUND_ALBEDO]:Dn.FLOAT32,[Ds.COUNT]:Dn.NEVER},Ms=new Rn(Ln.AMBIENT,Rs,Ds,1);let Bs;!function(t){t[t.ENABLE=0]="ENABLE",t[t.IS_RGBE=1]="IS_RGBE",t[t.USE_IBL=2]="USE_IBL",t[t.MODEL=3]="MODEL",t[t.COUNT=4]="COUNT"}(Bs||(Bs={}));const Os={[Bs.ENABLE]:Dn.UINT32,[Bs.IS_RGBE]:Dn.UINT32,[Bs.USE_IBL]:Dn.UINT32,[Bs.MODEL]:Dn.UINT32,[Bs.COUNT]:Dn.NEVER},Ns=new Rn(Ln.SKYBOX,Os,Bs,1);let Ls;!function(t){t[t.ENABLE=0]="ENABLE",t[t.TYPE=1]="TYPE",t[t.DENSITY=2]="DENSITY",t[t.START=3]="START",t[t.END=4]="END",t[t.ATTEN=5]="ATTEN",t[t.TOP=6]="TOP",t[t.RANGE=7]="RANGE",t[t.COLOR=8]="COLOR",t[t.COUNT=12]="COUNT"}(Ls||(Ls={}));const Fs={[Ls.ENABLE]:Dn.UINT32,[Ls.TYPE]:Dn.UINT32,[Ls.DENSITY]:Dn.FLOAT32,[Ls.START]:Dn.FLOAT32,[Ls.END]:Dn.FLOAT32,[Ls.ATTEN]:Dn.FLOAT32,[Ls.TOP]:Dn.FLOAT32,[Ls.RANGE]:Dn.FLOAT32,[Ls.COLOR]:Dn.FLOAT32,[Ls.COUNT]:Dn.NEVER},zs=new Rn(Ln.FOG,Fs,Ls);let Vs;!function(t){t[t.ENABLE=0]="ENABLE",t[t.DIRTY=1]="DIRTY",t[t.TYPE=2]="TYPE",t[t.DISTANCE=3]="DISTANCE",t[t.INSTANCE_PASS=4]="INSTANCE_PASS",t[t.PLANAR_PASS=5]="PLANAR_PASS",t[t.NEAR=6]="NEAR",t[t.FAR=7]="FAR",t[t.ASPECT=8]="ASPECT",t[t.PCF_TYPE=9]="PCF_TYPE",t[t.SHADOW_MAP_DIRTY=10]="SHADOW_MAP_DIRTY",t[t.BIAS=11]="BIAS",t[t.PACKING=12]="PACKING",t[t.LINEAR=13]="LINEAR",t[t.SELF_SHADOW=14]="SELF_SHADOW",t[t.NORMAL_BIAS=15]="NORMAL_BIAS",t[t.ORTHO_SIZE=16]="ORTHO_SIZE",t[t.AUTO_ADAPT=17]="AUTO_ADAPT",t[t.COLOR=18]="COLOR",t[t.SIZE=22]="SIZE",t[t.NORMAL=24]="NORMAL",t[t.MAT_LIGHT=27]="MAT_LIGHT",t[t.COUNT=43]="COUNT"}(Vs||(Vs={}));const Us={[Vs.ENABLE]:Dn.UINT32,[Vs.DIRTY]:Dn.UINT32,[Vs.TYPE]:Dn.UINT32,[Vs.DISTANCE]:Dn.FLOAT32,[Vs.INSTANCE_PASS]:Dn.UINT32,[Vs.PLANAR_PASS]:Dn.UINT32,[Vs.NEAR]:Dn.FLOAT32,[Vs.FAR]:Dn.FLOAT32,[Vs.ASPECT]:Dn.FLOAT32,[Vs.PCF_TYPE]:Dn.UINT32,[Vs.SHADOW_MAP_DIRTY]:Dn.UINT32,[Vs.BIAS]:Dn.FLOAT32,[Vs.PACKING]:Dn.UINT32,[Vs.LINEAR]:Dn.UINT32,[Vs.SELF_SHADOW]:Dn.UINT32,[Vs.NORMAL_BIAS]:Dn.FLOAT32,[Vs.ORTHO_SIZE]:Dn.FLOAT32,[Vs.AUTO_ADAPT]:Dn.UINT32,[Vs.COLOR]:Dn.FLOAT32,[Vs.SIZE]:Dn.FLOAT32,[Vs.NORMAL]:Dn.FLOAT32,[Vs.MAT_LIGHT]:Dn.FLOAT32,[Vs.COUNT]:Dn.NEVER},Gs=new Rn(Ln.SHADOW,Us,Vs,1);let Hs;!function(t){t[t.SHADOW=0]="SHADOW",t[t.SKYBOX=1]="SKYBOX",t[t.AMBIENT=2]="AMBIENT",t[t.FOG=3]="FOG",t[t.IS_HDR=4]="IS_HDR",t[t.SHADING_SCALE=5]="SHADING_SCALE",t[t.FP_SCALE=6]="FP_SCALE",t[t.DEFERRED_LIGHT_PASS=7]="DEFERRED_LIGHT_PASS",t[t.DEFERRED_LIGHT_PASS_SHADER=8]="DEFERRED_LIGHT_PASS_SHADER",t[t.DEFERRED_POST_PASS=9]="DEFERRED_POST_PASS",t[t.DEFERRED_POST_PASS_SHADER=10]="DEFERRED_POST_PASS_SHADER",t[t.COUNT=11]="COUNT"}(Hs||(Hs={}));const ks={[Hs.SHADOW]:Dn.UINT32,[Hs.SKYBOX]:Dn.UINT32,[Hs.AMBIENT]:Dn.UINT32,[Hs.FOG]:Dn.UINT32,[Hs.IS_HDR]:Dn.UINT32,[Hs.SHADING_SCALE]:Dn.UINT32,[Hs.FP_SCALE]:Dn.UINT32,[Hs.DEFERRED_LIGHT_PASS]:Dn.UINT32,[Hs.DEFERRED_LIGHT_PASS_SHADER]:Dn.UINT32,[Hs.DEFERRED_POST_PASS]:Dn.UINT32,[Hs.DEFERRED_POST_PASS_SHADER]:Dn.UINT32,[Hs.COUNT]:Dn.NEVER},js=new Rn(Ln.PIPELINE_SCENE_DATA,ks,Hs,1);let Ws;!function(t){t[t.USE_COLOR_TEMPERATURE=0]="USE_COLOR_TEMPERATURE",t[t.ILLUMINANCE=1]="ILLUMINANCE",t[t.NODE=2]="NODE",t[t.RANGE=3]="RANGE",t[t.TYPE=4]="TYPE",t[t.AABB=5]="AABB",t[t.FRUSTUM=6]="FRUSTUM",t[t.SIZE=7]="SIZE",t[t.SPOT_ANGLE=8]="SPOT_ANGLE",t[t.ASPECT=9]="ASPECT",t[t.DIRECTION=10]="DIRECTION",t[t.COLOR=13]="COLOR",t[t.COLOR_TEMPERATURE_RGB=16]="COLOR_TEMPERATURE_RGB",t[t.POSITION=19]="POSITION",t[t.COUNT=22]="COUNT"}(Ws||(Ws={}));const qs={[Ws.USE_COLOR_TEMPERATURE]:Dn.UINT32,[Ws.ILLUMINANCE]:Dn.FLOAT32,[Ws.NODE]:Dn.UINT32,[Ws.RANGE]:Dn.FLOAT32,[Ws.TYPE]:Dn.UINT32,[Ws.AABB]:Dn.UINT32,[Ws.FRUSTUM]:Dn.UINT32,[Ws.SIZE]:Dn.FLOAT32,[Ws.SPOT_ANGLE]:Dn.FLOAT32,[Ws.ASPECT]:Dn.FLOAT32,[Ws.DIRECTION]:Dn.FLOAT32,[Ws.COLOR]:Dn.FLOAT32,[Ws.COLOR_TEMPERATURE_RGB]:Dn.FLOAT32,[Ws.POSITION]:Dn.FLOAT32,[Ws.COUNT]:Dn.NEVER},Xs=new Rn(Ln.LIGHT,qs,Ws,3);let Ys;!function(t){t[t.RADIUS=0]="RADIUS",t[t.CENTER=1]="CENTER",t[t.COUNT=4]="COUNT"}(Ys||(Ys={}));const Ks={[Ys.RADIUS]:Dn.FLOAT32,[Ys.CENTER]:Dn.FLOAT32,[Ys.COUNT]:Dn.NEVER},Js=new Rn(Ln.SPHERE,Ks,Ys,3);let $s;!function(t){t[t.STRIDE=0]="STRIDE",t[t.AMOUNT=1]="AMOUNT",t[t.BUFFER=2]="BUFFER",t[t.COUNT=3]="COUNT"}($s||($s={}));const Zs={[$s.STRIDE]:Dn.UINT32,[$s.AMOUNT]:Dn.UINT32,[$s.BUFFER]:Dn.UINT32,[$s.COUNT]:Dn.NEVER},Qs=new Rn(Ln.FLAT_BUFFER,Zs,$s,3);let tr;!function(t){t[t.FLAT_BUFFER_ARRAY=0]="FLAT_BUFFER_ARRAY",t[t.COUNT=1]="COUNT"}(tr||(tr={}));const er={[tr.FLAT_BUFFER_ARRAY]:Dn.UINT32,[tr.COUNT]:Dn.NEVER},ir=new Rn(Ln.SUB_MESH,er,tr,3);let sr;!function(t){t[t.IS_DISCARD=0]="IS_DISCARD",t[t.POLYGO_MODEL=1]="POLYGO_MODEL",t[t.SHADE_MODEL=2]="SHADE_MODEL",t[t.CULL_MODE=3]="CULL_MODE",t[t.IS_FRONT_FACE_CCW=4]="IS_FRONT_FACE_CCW",t[t.DEPTH_BIAS_ENABLED=5]="DEPTH_BIAS_ENABLED",t[t.DEPTH_BIAS=6]="DEPTH_BIAS",t[t.DEPTH_BIAS_CLAMP=7]="DEPTH_BIAS_CLAMP",t[t.DEPTH_BIAS_SLOP=8]="DEPTH_BIAS_SLOP",t[t.IS_DEPTH_CLIP=9]="IS_DEPTH_CLIP",t[t.IS_MULTI_SAMPLE=10]="IS_MULTI_SAMPLE",t[t.LINE_WIDTH=11]="LINE_WIDTH",t[t.COUNT=12]="COUNT"}(sr||(sr={}));const rr={[sr.IS_DISCARD]:Dn.UINT32,[sr.POLYGO_MODEL]:Dn.UINT32,[sr.SHADE_MODEL]:Dn.UINT32,[sr.CULL_MODE]:Dn.UINT32,[sr.IS_FRONT_FACE_CCW]:Dn.UINT32,[sr.DEPTH_BIAS_ENABLED]:Dn.UINT32,[sr.DEPTH_BIAS]:Dn.FLOAT32,[sr.DEPTH_BIAS_CLAMP]:Dn.FLOAT32,[sr.DEPTH_BIAS_SLOP]:Dn.FLOAT32,[sr.IS_DEPTH_CLIP]:Dn.UINT32,[sr.IS_MULTI_SAMPLE]:Dn.UINT32,[sr.LINE_WIDTH]:Dn.FLOAT32,[sr.COUNT]:Dn.NEVER},or=new Rn(Ln.RASTERIZER_STATE,rr,sr,9);let ar;!function(t){t[t.DEPTH_TEST=0]="DEPTH_TEST",t[t.DEPTH_WRITE=1]="DEPTH_WRITE",t[t.DEPTH_FUNC=2]="DEPTH_FUNC",t[t.STENCIL_TEST_FRONT=3]="STENCIL_TEST_FRONT",t[t.STENCIL_FUNC_FRONT=4]="STENCIL_FUNC_FRONT",t[t.STENCIL_READ_MASK_FRONT=5]="STENCIL_READ_MASK_FRONT",t[t.STENCIL_WRITE_MASK_FRONT=6]="STENCIL_WRITE_MASK_FRONT",t[t.STENCIL_FAIL_OP_FRONT=7]="STENCIL_FAIL_OP_FRONT",t[t.STENCIL_Z_FAIL_OP_FRONT=8]="STENCIL_Z_FAIL_OP_FRONT",t[t.STENCIL_PASS_OP_FRONT=9]="STENCIL_PASS_OP_FRONT",t[t.STENCIL_REF_FRONT=10]="STENCIL_REF_FRONT",t[t.STENCIL_TEST_BACK=11]="STENCIL_TEST_BACK",t[t.STENCIL_FUNC_BACK=12]="STENCIL_FUNC_BACK",t[t.STENCIL_READ_MADK_BACK=13]="STENCIL_READ_MADK_BACK",t[t.STENCIL_WRITE_MASK_BACK=14]="STENCIL_WRITE_MASK_BACK",t[t.STENCIL_FAIL_OP_BACK=15]="STENCIL_FAIL_OP_BACK",t[t.STENCIL_Z_FAIL_OP_BACK=16]="STENCIL_Z_FAIL_OP_BACK",t[t.STENCIL_PASS_OP_BACK=17]="STENCIL_PASS_OP_BACK",t[t.STENCIL_REF_BACK=18]="STENCIL_REF_BACK",t[t.COUNT=19]="COUNT"}(ar||(ar={}));const lr={[ar.DEPTH_TEST]:Dn.UINT32,[ar.DEPTH_WRITE]:Dn.UINT32,[ar.DEPTH_FUNC]:Dn.UINT32,[ar.STENCIL_TEST_FRONT]:Dn.UINT32,[ar.STENCIL_FUNC_FRONT]:Dn.UINT32,[ar.STENCIL_READ_MASK_FRONT]:Dn.UINT32,[ar.STENCIL_WRITE_MASK_FRONT]:Dn.UINT32,[ar.STENCIL_FAIL_OP_FRONT]:Dn.UINT32,[ar.STENCIL_Z_FAIL_OP_FRONT]:Dn.UINT32,[ar.STENCIL_PASS_OP_FRONT]:Dn.UINT32,[ar.STENCIL_REF_FRONT]:Dn.UINT32,[ar.STENCIL_TEST_BACK]:Dn.UINT32,[ar.STENCIL_FUNC_BACK]:Dn.UINT32,[ar.STENCIL_READ_MADK_BACK]:Dn.UINT32,[ar.STENCIL_WRITE_MASK_BACK]:Dn.UINT32,[ar.STENCIL_FAIL_OP_BACK]:Dn.UINT32,[ar.STENCIL_Z_FAIL_OP_BACK]:Dn.UINT32,[ar.STENCIL_PASS_OP_BACK]:Dn.UINT32,[ar.STENCIL_REF_BACK]:Dn.UINT32,[ar.COUNT]:Dn.NEVER},cr=new Rn(Ln.DEPTH_STENCIL_STATE,lr,ar,9);let hr;!function(t){t[t.BLEND=0]="BLEND",t[t.BLEND_SRC=1]="BLEND_SRC",t[t.BLEND_DST=2]="BLEND_DST",t[t.BLEND_EQ=3]="BLEND_EQ",t[t.BLEND_SRC_ALPHA=4]="BLEND_SRC_ALPHA",t[t.BLEND_DST_ALPHA=5]="BLEND_DST_ALPHA",t[t.BLEND_ALPHA_EQ=6]="BLEND_ALPHA_EQ",t[t.BLEND_COLOR_MASK=7]="BLEND_COLOR_MASK",t[t.COUNT=8]="COUNT"}(hr||(hr={})),hr.BLEND,Dn.UINT32,hr.BLEND_SRC,Dn.UINT32,hr.BLEND_DST,Dn.UINT32,hr.BLEND_EQ,Dn.UINT32,hr.BLEND_SRC_ALPHA,Dn.UINT32,hr.BLEND_DST_ALPHA,Dn.UINT32,hr.BLEND_ALPHA_EQ,Dn.UINT32,hr.BLEND_COLOR_MASK,Dn.UINT32,hr.COUNT,Dn.NEVER;const _r=new Rn(Ln.BLEND_TARGET,lr,hr,9);let ur;!function(t){t[t.IS_A2C=0]="IS_A2C",t[t.IS_INDEPEND=1]="IS_INDEPEND",t[t.BLEND_COLOR=2]="BLEND_COLOR",t[t.BLEND_TARGET=6]="BLEND_TARGET",t[t.COUNT=7]="COUNT"}(ur||(ur={}));const mr={[ur.IS_A2C]:Dn.UINT32,[ur.IS_INDEPEND]:Dn.UINT32,[ur.BLEND_COLOR]:Dn.FLOAT32,[ur.BLEND_TARGET]:Dn.UINT32,[ur.COUNT]:Dn.NEVER},dr=new Rn(Ln.BLEND_STATE,mr,ur,9);class pr{get colorArray(){return this._colorArray}get albedoArray(){return this._albedoArray}set enabled(t){Ms.set(this._handle,Ds.ENABLE,t?1:0)}get enabled(){return Ms.get(this._handle,Ds.ENABLE)}get skyColor(){return this._skyColor}set skyColor(t){this._skyColor.set(t),si.toArray(this._colorArray,this._skyColor),Ms.setVec4(this._handle,Ds.SKY_COLOR,this._skyColor)}get skyIllum(){return Ms.get(this._handle,Ds.ILLUM)}set skyIllum(t){Ms.set(this._handle,Ds.ILLUM,t)}get groundAlbedo(){return this._groundAlbedo}set groundAlbedo(t){this._groundAlbedo.set(t),oi.toArray(this._albedoArray,this._groundAlbedo),Ms.setVec4(this._handle,Ds.GROUND_ALBEDO,this._groundAlbedo)}get handle(){return this._handle}constructor(){this._skyColor=new si(51,128,204,1),this._groundAlbedo=new si(51,51,51,255),this._albedoArray=Float32Array.from([.2,.2,.2,1]),this._colorArray=Float32Array.from([.2,.5,.8,1]),this._handle=0,this._handle=Ms.alloc()}initialize(t){this._skyColor.set(t.skyColor),this._groundAlbedo.set(t.groundAlbedo),si.toArray(this._colorArray,this._skyColor),oi.toArray(this._albedoArray,this._groundAlbedo),Ms.setVec4(this._handle,Ds.SKY_COLOR,this._skyColor),Ms.setVec4(this._handle,Ds.GROUND_ALBEDO,this._groundAlbedo),Ms.set(this._handle,Ds.ILLUM,t.skyIllum)}destroy(){this._handle&&(Ms.free(this._handle),this._handle=0)}}pr.SUN_ILLUM=65e3,pr.SKY_ILLUM=2e4,n.Ambient=pr;const fr=new oi,gr=new oi,yr=new oi,vr=new oi,xr=new oi,Sr=new oi,Ar=new Array(3),Cr=new Array(3);function br(t,e){return oi.dot(e.n,t)-e.d}function Tr(t,e,i){return oi.copy(t,e),oi.subtract(xr,i.center,i.halfExtents),oi.add(Sr,i.center,i.halfExtents),t.x=t.x<xr.x?xr.x:t.x,t.y=t.y<xr.y?xr.y:t.y,t.z=t.z<xr.z?xr.z:t.z,t.x=t.x>Sr.x?Sr.x:t.x,t.y=t.y>Sr.y?Sr.y:t.y,t.z=t.z>Sr.z?Sr.z:t.z,t}function wr(t,e,i){oi.set(fr,i.orientation.m00,i.orientation.m01,i.orientation.m02),oi.set(gr,i.orientation.m03,i.orientation.m04,i.orientation.m05),oi.set(yr,i.orientation.m06,i.orientation.m07,i.orientation.m08),Ar[0]=fr,Ar[1]=gr,Ar[2]=yr,Cr[0]=i.halfExtents.x,Cr[1]=i.halfExtents.y,Cr[2]=i.halfExtents.z,oi.subtract(vr,e,i.center),oi.set(t,i.center.x,i.center.y,i.center.z);for(let e=0;e<3;e++){let i=oi.dot(vr,Ar[e]);i>Cr[e]&&(i=Cr[e]),i<-Cr[e]&&(i=-Cr[e]),t.x+=i*Ar[e].x,t.y+=i*Ar[e].y,t.z+=i*Ar[e].z}return t}var Er=Object.freeze({__proto__:null,point_plane:br,pt_point_plane:function(t,e,i){const n=br(e,i);return oi.subtract(t,e,oi.multiplyScalar(t,i.n,n))},pt_point_aabb:Tr,pt_point_obb:wr,pt_point_line:function(t,e,i,n){oi.subtract(fr,i,n);const s=fr,r=oi.lengthSqr(s);if(0==r)oi.copy(t,i);else{oi.subtract(fr,e,i);const o=oi.dot(fr,s)/r;o<0?oi.copy(t,i):o>1?oi.copy(t,n):oi.scaleAndAdd(t,i,s,o)}}}),Pr={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512};class Ir{static create(t,e,i,n,s,r){return new Ir(t,e,i,n,s,r)}static clone(t){return new Ir(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)}static copy(t,e){return oi.copy(t.s,e.s),oi.copy(t.e,e.e),t}static fromPoints(t,e,i){return oi.copy(t.s,e),oi.copy(t.e,i),t}static set(t,e,i,n,s,r,o){return t.s.x=e,t.s.y=i,t.s.z=n,t.e.x=s,t.e.y=r,t.e.z=o,t}static len(t){return oi.distance(t.s,t.e)}get type(){return this._type}constructor(t=0,e=0,i=0,n=0,s=0,r=-1){this.s=void 0,this.e=void 0,this._type=void 0,this._type=Pr.SHAPE_LINE,this.s=new oi(t,e,i),this.e=new oi(n,s,r)}length(){return oi.distance(this.s,this.e)}}class Dr{static create(t=0,e=0,i=0,n=0,s=0,r=1){return new Dr(t,e,i,n,s,r)}static clone(t){return new Dr(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)}static copy(t,e){return oi.copy(t.o,e.o),oi.copy(t.d,e.d),t}static fromPoints(t,e,i){return oi.copy(t.o,e),oi.normalize(t.d,oi.subtract(t.d,i,e)),t}static set(t,e,i,n,s,r,o){return t.o.x=e,t.o.y=i,t.o.z=n,t.d.x=s,t.d.y=r,t.d.z=o,t}get type(){return this._type}constructor(t=0,e=0,i=0,n=0,s=0,r=-1){this.o=void 0,this.d=void 0,this._type=void 0,this._type=Pr.SHAPE_RAY,this.o=new oi(t,e,i),this.d=new oi(n,s,r)}computeHit(t,e){oi.normalize(t,this.d),oi.scaleAndAdd(t,this.o,t,e)}}const Rr=new oi,Mr=new oi,Br=new oi,Or=new oi;function Nr(t){return Math.max(Math.max(t.x,t.y),t.z)}class Lr{static create(t,e,i,n){return new Lr(t,e,i,n)}static clone(t){return new Lr(t.center.x,t.center.y,t.center.z,t.radius)}static copy(t,e){return oi.copy(t.center,e.center),t.radius=e.radius,t}static fromPoints(t,e,i){return oi.multiplyScalar(t.center,oi.add(Rr,e,i),.5),t.radius=.5*oi.subtract(Rr,i,e).length(),t}static set(t,e,i,n,s){return t.center.x=e,t.center.y=i,t.center.z=n,t.radius=s,t}static mergePoint(t,e,i){if(e.radius<0)return t.center.set(i),t.radius=0,t;oi.subtract(Mr,i,e.center);const n=Mr.length();if(n>e.radius){const i=.5*(n-e.radius);t.radius+=i,oi.multiplyScalar(Mr,Mr,i/n),oi.add(t.center,t.center,Mr)}return t}static mergeAABB(t,e,i){return i.getBoundary(Br,Or),Lr.mergePoint(t,e,Br),Lr.mergePoint(t,e,Or),t}get center(){return this._center}set center(t){this._center=t,Js.setVec3(this._poolHandle,Ys.CENTER,this._center)}get radius(){return Js.get(this._poolHandle,Ys.RADIUS)}set radius(t){Js.set(this._poolHandle,Ys.RADIUS,t)}get handle(){return this._poolHandle}get type(){return this._type}constructor(t=0,e=0,i=0,n=1){this._center=new oi(0,0,0),this._poolHandle=0,this._type=void 0,this._type=Pr.SHAPE_SPHERE,this._center=new oi(t,e,i),this._poolHandle=Js.alloc(),Js.setVec3(this._poolHandle,Ys.CENTER,this._center),Js.set(this._poolHandle,Ys.RADIUS,n)}destroy(){this._poolHandle&&(Js.free(this._poolHandle),this._poolHandle=0)}clone(){return Lr.clone(this)}copy(t){return Lr.copy(this,t)}getBoundary(t,e){oi.set(t,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),oi.set(e,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}transform(t,e,i,n,s){oi.transformMat4(s.center,this.center,t),s.radius=this.radius*Nr(n)}translateAndRotate(t,e,i){oi.transformMat4(i.center,this.center,t)}setScale(t,e){e.radius=this.radius*Nr(t)}}class Fr{static create(t=1,e=0,i=0,n=0,s=0,r=0,o=0,a=0,l=1){return new Fr(t,e,i,n,s,r,o,a,l)}static clone(t){return new Fr(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)}static copy(t,e){return oi.copy(t.a,e.a),oi.copy(t.b,e.b),oi.copy(t.c,e.c),t}static fromPoints(t,e,i,n){return oi.copy(t.a,e),oi.copy(t.b,i),oi.copy(t.c,n),t}static set(t,e,i,n,s,r,o,a,l,c){return t.a.x=e,t.a.y=i,t.a.z=n,t.b.x=s,t.b.y=r,t.b.z=o,t.c.x=a,t.c.y=l,t.c.z=c,t}get type(){return this._type}constructor(t=0,e=0,i=0,n=1,s=0,r=0,o=0,a=1,l=0){this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=Pr.SHAPE_TRIANGLE,this.a=new oi(t,e,i),this.b=new oi(n,s,r),this.c=new oi(o,a,l)}}const zr=(t,e,i)=>{for(let n=0;n<e.length;++n)t.length<=n&&t.push(new i),t[n].copy(e[n]);t.length=e.length};let Vr,Ur,Gr,Hr,kr,jr,Wr,qr,Xr,Yr,Kr,Jr,$r,Zr,Qr,to,eo,io,no,so,ro,oo,ao,lo,co,ho,_o,uo,mo,po,fo,go,yo,vo,xo,So,Ao,Co,bo;!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BUFFER=1]="BUFFER",t[t.TEXTURE=2]="TEXTURE",t[t.RENDER_PASS=3]="RENDER_PASS",t[t.FRAMEBUFFER=4]="FRAMEBUFFER",t[t.SAMPLER=5]="SAMPLER",t[t.SHADER=6]="SHADER",t[t.DESCRIPTOR_SET_LAYOUT=7]="DESCRIPTOR_SET_LAYOUT",t[t.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",t[t.PIPELINE_STATE=9]="PIPELINE_STATE",t[t.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",t[t.COMMAND_BUFFER=12]="COMMAND_BUFFER",t[t.QUEUE=13]="QUEUE",t[t.GLOBAL_BARRIER=14]="GLOBAL_BARRIER",t[t.TEXTURE_BARRIER=15]="TEXTURE_BARRIER",t[t.BUFFER_BARRIER=16]="BUFFER_BARRIER"}(Vr||(Vr={})),function(t){t[t.UNREADY=0]="UNREADY",t[t.FAILED=1]="FAILED",t[t.SUCCESS=2]="SUCCESS"}(Ur||(Ur={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.GLES2=1]="GLES2",t[t.GLES3=2]="GLES3",t[t.METAL=3]="METAL",t[t.VULKAN=4]="VULKAN",t[t.WEBGL=5]="WEBGL",t[t.WEBGL2=6]="WEBGL2",t[t.WEBGPU=7]="WEBGPU"}(Gr||(Gr={})),function(t){t[t.IDENTITY=0]="IDENTITY",t[t.ROTATE_90=1]="ROTATE_90",t[t.ROTATE_180=2]="ROTATE_180",t[t.ROTATE_270=3]="ROTATE_270"}(Hr||(Hr={})),function(t){t[t.COLOR_FLOAT=0]="COLOR_FLOAT",t[t.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",t[t.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",t[t.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",t[t.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",t[t.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",t[t.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",t[t.FORMAT_D16=7]="FORMAT_D16",t[t.FORMAT_D16S8=8]="FORMAT_D16S8",t[t.FORMAT_D24=9]="FORMAT_D24",t[t.FORMAT_D24S8=10]="FORMAT_D24S8",t[t.FORMAT_D32F=11]="FORMAT_D32F",t[t.FORMAT_D32FS8=12]="FORMAT_D32FS8",t[t.FORMAT_ETC1=13]="FORMAT_ETC1",t[t.FORMAT_ETC2=14]="FORMAT_ETC2",t[t.FORMAT_DXT=15]="FORMAT_DXT",t[t.FORMAT_PVRTC=16]="FORMAT_PVRTC",t[t.FORMAT_ASTC=17]="FORMAT_ASTC",t[t.FORMAT_RGB8=18]="FORMAT_RGB8",t[t.MSAA=19]="MSAA",t[t.ELEMENT_INDEX_UINT=20]="ELEMENT_INDEX_UINT",t[t.INSTANCED_ARRAYS=21]="INSTANCED_ARRAYS",t[t.MULTIPLE_RENDER_TARGETS=22]="MULTIPLE_RENDER_TARGETS",t[t.BLEND_MINMAX=23]="BLEND_MINMAX",t[t.DEPTH_BOUNDS=24]="DEPTH_BOUNDS",t[t.LINE_WIDTH=25]="LINE_WIDTH",t[t.STENCIL_WRITE_MASK=26]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=27]="STENCIL_COMPARE_MASK",t[t.MULTITHREADED_SUBMISSION=28]="MULTITHREADED_SUBMISSION",t[t.COMPUTE_SHADER=29]="COMPUTE_SHADER",t[t.COUNT=30]="COUNT"}(kr||(kr={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A8=1]="A8",t[t.L8=2]="L8",t[t.LA8=3]="LA8",t[t.R8=4]="R8",t[t.R8SN=5]="R8SN",t[t.R8UI=6]="R8UI",t[t.R8I=7]="R8I",t[t.R16F=8]="R16F",t[t.R16UI=9]="R16UI",t[t.R16I=10]="R16I",t[t.R32F=11]="R32F",t[t.R32UI=12]="R32UI",t[t.R32I=13]="R32I",t[t.RG8=14]="RG8",t[t.RG8SN=15]="RG8SN",t[t.RG8UI=16]="RG8UI",t[t.RG8I=17]="RG8I",t[t.RG16F=18]="RG16F",t[t.RG16UI=19]="RG16UI",t[t.RG16I=20]="RG16I",t[t.RG32F=21]="RG32F",t[t.RG32UI=22]="RG32UI",t[t.RG32I=23]="RG32I",t[t.RGB8=24]="RGB8",t[t.SRGB8=25]="SRGB8",t[t.RGB8SN=26]="RGB8SN",t[t.RGB8UI=27]="RGB8UI",t[t.RGB8I=28]="RGB8I",t[t.RGB16F=29]="RGB16F",t[t.RGB16UI=30]="RGB16UI",t[t.RGB16I=31]="RGB16I",t[t.RGB32F=32]="RGB32F",t[t.RGB32UI=33]="RGB32UI",t[t.RGB32I=34]="RGB32I",t[t.RGBA8=35]="RGBA8",t[t.BGRA8=36]="BGRA8",t[t.SRGB8_A8=37]="SRGB8_A8",t[t.RGBA8SN=38]="RGBA8SN",t[t.RGBA8UI=39]="RGBA8UI",t[t.RGBA8I=40]="RGBA8I",t[t.RGBA16F=41]="RGBA16F",t[t.RGBA16UI=42]="RGBA16UI",t[t.RGBA16I=43]="RGBA16I",t[t.RGBA32F=44]="RGBA32F",t[t.RGBA32UI=45]="RGBA32UI",t[t.RGBA32I=46]="RGBA32I",t[t.R5G6B5=47]="R5G6B5",t[t.R11G11B10F=48]="R11G11B10F",t[t.RGB5A1=49]="RGB5A1",t[t.RGBA4=50]="RGBA4",t[t.RGB10A2=51]="RGB10A2",t[t.RGB10A2UI=52]="RGB10A2UI",t[t.RGB9E5=53]="RGB9E5",t[t.D16=54]="D16",t[t.D16S8=55]="D16S8",t[t.D24=56]="D24",t[t.D24S8=57]="D24S8",t[t.D32F=58]="D32F",t[t.D32F_S8=59]="D32F_S8",t[t.BC1=60]="BC1",t[t.BC1_ALPHA=61]="BC1_ALPHA",t[t.BC1_SRGB=62]="BC1_SRGB",t[t.BC1_SRGB_ALPHA=63]="BC1_SRGB_ALPHA",t[t.BC2=64]="BC2",t[t.BC2_SRGB=65]="BC2_SRGB",t[t.BC3=66]="BC3",t[t.BC3_SRGB=67]="BC3_SRGB",t[t.BC4=68]="BC4",t[t.BC4_SNORM=69]="BC4_SNORM",t[t.BC5=70]="BC5",t[t.BC5_SNORM=71]="BC5_SNORM",t[t.BC6H_UF16=72]="BC6H_UF16",t[t.BC6H_SF16=73]="BC6H_SF16",t[t.BC7=74]="BC7",t[t.BC7_SRGB=75]="BC7_SRGB",t[t.ETC_RGB8=76]="ETC_RGB8",t[t.ETC2_RGB8=77]="ETC2_RGB8",t[t.ETC2_SRGB8=78]="ETC2_SRGB8",t[t.ETC2_RGB8_A1=79]="ETC2_RGB8_A1",t[t.ETC2_SRGB8_A1=80]="ETC2_SRGB8_A1",t[t.ETC2_RGBA8=81]="ETC2_RGBA8",t[t.ETC2_SRGB8_A8=82]="ETC2_SRGB8_A8",t[t.EAC_R11=83]="EAC_R11",t[t.EAC_R11SN=84]="EAC_R11SN",t[t.EAC_RG11=85]="EAC_RG11",t[t.EAC_RG11SN=86]="EAC_RG11SN",t[t.PVRTC_RGB2=87]="PVRTC_RGB2",t[t.PVRTC_RGBA2=88]="PVRTC_RGBA2",t[t.PVRTC_RGB4=89]="PVRTC_RGB4",t[t.PVRTC_RGBA4=90]="PVRTC_RGBA4",t[t.PVRTC2_2BPP=91]="PVRTC2_2BPP",t[t.PVRTC2_4BPP=92]="PVRTC2_4BPP",t[t.ASTC_RGBA_4x4=93]="ASTC_RGBA_4x4",t[t.ASTC_RGBA_5x4=94]="ASTC_RGBA_5x4",t[t.ASTC_RGBA_5x5=95]="ASTC_RGBA_5x5",t[t.ASTC_RGBA_6x5=96]="ASTC_RGBA_6x5",t[t.ASTC_RGBA_6x6=97]="ASTC_RGBA_6x6",t[t.ASTC_RGBA_8x5=98]="ASTC_RGBA_8x5",t[t.ASTC_RGBA_8x6=99]="ASTC_RGBA_8x6",t[t.ASTC_RGBA_8x8=100]="ASTC_RGBA_8x8",t[t.ASTC_RGBA_10x5=101]="ASTC_RGBA_10x5",t[t.ASTC_RGBA_10x6=102]="ASTC_RGBA_10x6",t[t.ASTC_RGBA_10x8=103]="ASTC_RGBA_10x8",t[t.ASTC_RGBA_10x10=104]="ASTC_RGBA_10x10",t[t.ASTC_RGBA_12x10=105]="ASTC_RGBA_12x10",t[t.ASTC_RGBA_12x12=106]="ASTC_RGBA_12x12",t[t.ASTC_SRGBA_4x4=107]="ASTC_SRGBA_4x4",t[t.ASTC_SRGBA_5x4=108]="ASTC_SRGBA_5x4",t[t.ASTC_SRGBA_5x5=109]="ASTC_SRGBA_5x5",t[t.ASTC_SRGBA_6x5=110]="ASTC_SRGBA_6x5",t[t.ASTC_SRGBA_6x6=111]="ASTC_SRGBA_6x6",t[t.ASTC_SRGBA_8x5=112]="ASTC_SRGBA_8x5",t[t.ASTC_SRGBA_8x6=113]="ASTC_SRGBA_8x6",t[t.ASTC_SRGBA_8x8=114]="ASTC_SRGBA_8x8",t[t.ASTC_SRGBA_10x5=115]="ASTC_SRGBA_10x5",t[t.ASTC_SRGBA_10x6=116]="ASTC_SRGBA_10x6",t[t.ASTC_SRGBA_10x8=117]="ASTC_SRGBA_10x8",t[t.ASTC_SRGBA_10x10=118]="ASTC_SRGBA_10x10",t[t.ASTC_SRGBA_12x10=119]="ASTC_SRGBA_12x10",t[t.ASTC_SRGBA_12x12=120]="ASTC_SRGBA_12x12",t[t.COUNT=121]="COUNT"}(jr||(jr={})),function(t){t[t.NONE=0]="NONE",t[t.UNORM=1]="UNORM",t[t.SNORM=2]="SNORM",t[t.UINT=3]="UINT",t[t.INT=4]="INT",t[t.UFLOAT=5]="UFLOAT",t[t.FLOAT=6]="FLOAT"}(Wr||(Wr={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BOOL=1]="BOOL",t[t.BOOL2=2]="BOOL2",t[t.BOOL3=3]="BOOL3",t[t.BOOL4=4]="BOOL4",t[t.INT=5]="INT",t[t.INT2=6]="INT2",t[t.INT3=7]="INT3",t[t.INT4=8]="INT4",t[t.UINT=9]="UINT",t[t.UINT2=10]="UINT2",t[t.UINT3=11]="UINT3",t[t.UINT4=12]="UINT4",t[t.FLOAT=13]="FLOAT",t[t.FLOAT2=14]="FLOAT2",t[t.FLOAT3=15]="FLOAT3",t[t.FLOAT4=16]="FLOAT4",t[t.MAT2=17]="MAT2",t[t.MAT2X3=18]="MAT2X3",t[t.MAT2X4=19]="MAT2X4",t[t.MAT3X2=20]="MAT3X2",t[t.MAT3=21]="MAT3",t[t.MAT3X4=22]="MAT3X4",t[t.MAT4X2=23]="MAT4X2",t[t.MAT4X3=24]="MAT4X3",t[t.MAT4=25]="MAT4",t[t.SAMPLER1D=26]="SAMPLER1D",t[t.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",t[t.SAMPLER2D=28]="SAMPLER2D",t[t.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",t[t.SAMPLER3D=30]="SAMPLER3D",t[t.SAMPLER_CUBE=31]="SAMPLER_CUBE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE1D=33]="TEXTURE1D",t[t.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",t[t.TEXTURE2D=35]="TEXTURE2D",t[t.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",t[t.TEXTURE3D=37]="TEXTURE3D",t[t.TEXTURE_CUBE=38]="TEXTURE_CUBE",t[t.IMAGE1D=39]="IMAGE1D",t[t.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",t[t.IMAGE2D=41]="IMAGE2D",t[t.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",t[t.IMAGE3D=43]="IMAGE3D",t[t.IMAGE_CUBE=44]="IMAGE_CUBE",t[t.SUBPASS_INPUT=45]="SUBPASS_INPUT",t[t.COUNT=46]="COUNT"}(qr||(qr={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.INDEX=4]="INDEX",t[t.VERTEX=8]="VERTEX",t[t.UNIFORM=16]="UNIFORM",t[t.STORAGE=32]="STORAGE",t[t.INDIRECT=64]="INDIRECT"}(Xr||(Xr={})),function(t){t[t.NONE=0]="NONE"}(Yr||(Yr={})),function(t){t[t.NONE=0]="NONE",t[t.READ_ONLY=1]="READ_ONLY",t[t.WRITE_ONLY=2]="WRITE_ONLY",t[t.READ_WRITE=3]="READ_WRITE"}(Kr||(Kr={})),function(t){t[t.NONE=0]="NONE",t[t.DEVICE=1]="DEVICE",t[t.HOST=2]="HOST"}(Jr||(Jr={})),function(t){t[t.TEX1D=0]="TEX1D",t[t.TEX2D=1]="TEX2D",t[t.TEX3D=2]="TEX3D",t[t.CUBE=3]="CUBE",t[t.TEX1D_ARRAY=4]="TEX1D_ARRAY",t[t.TEX2D_ARRAY=5]="TEX2D_ARRAY"}($r||($r={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.SAMPLED=4]="SAMPLED",t[t.STORAGE=8]="STORAGE",t[t.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",t[t.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",t[t.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT"}(Zr||(Zr={})),function(t){t[t.NONE=0]="NONE",t[t.GEN_MIPMAP=1]="GEN_MIPMAP",t[t.IMMUTABLE=2]="IMMUTABLE"}(Qr||(Qr={})),function(t){t[t.X1=0]="X1",t[t.X2=1]="X2",t[t.X4=2]="X4",t[t.X8=3]="X8",t[t.X16=4]="X16",t[t.X32=5]="X32",t[t.X64=6]="X64"}(to||(to={})),function(t){t[t.NONE=0]="NONE",t[t.POINT=1]="POINT",t[t.LINEAR=2]="LINEAR",t[t.ANISOTROPIC=3]="ANISOTROPIC"}(eo||(eo={})),function(t){t[t.WRAP=0]="WRAP",t[t.MIRROR=1]="MIRROR",t[t.CLAMP=2]="CLAMP",t[t.BORDER=3]="BORDER"}(io||(io={})),function(t){t[t.NEVER=0]="NEVER",t[t.LESS=1]="LESS",t[t.EQUAL=2]="EQUAL",t[t.LESS_EQUAL=3]="LESS_EQUAL",t[t.GREATER=4]="GREATER",t[t.NOT_EQUAL=5]="NOT_EQUAL",t[t.GREATER_EQUAL=6]="GREATER_EQUAL",t[t.ALWAYS=7]="ALWAYS"}(no||(no={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=1]="KEEP",t[t.REPLACE=2]="REPLACE",t[t.INCR=3]="INCR",t[t.DECR=4]="DECR",t[t.INVERT=5]="INVERT",t[t.INCR_WRAP=6]="INCR_WRAP",t[t.DECR_WRAP=7]="DECR_WRAP"}(so||(so={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_ALPHA=2]="SRC_ALPHA",t[t.DST_ALPHA=3]="DST_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",t[t.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",t[t.SRC_COLOR=6]="SRC_COLOR",t[t.DST_COLOR=7]="DST_COLOR",t[t.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",t[t.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=11]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(ro||(ro={})),function(t){t[t.ADD=0]="ADD",t[t.SUB=1]="SUB",t[t.REV_SUB=2]="REV_SUB",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(oo||(oo={})),function(t){t[t.NONE=0]="NONE",t[t.R=1]="R",t[t.G=2]="G",t[t.B=4]="B",t[t.A=8]="A",t[t.ALL=15]="ALL"}(ao||(ao={})),function(t){t[t.NONE=0]="NONE",t[t.VERTEX=1]="VERTEX",t[t.CONTROL=2]="CONTROL",t[t.EVALUATION=4]="EVALUATION",t[t.GEOMETRY=8]="GEOMETRY",t[t.FRAGMENT=16]="FRAGMENT",t[t.COMPUTE=32]="COMPUTE",t[t.ALL=63]="ALL"}(lo||(lo={})),function(t){t[t.LOAD=0]="LOAD",t[t.CLEAR=1]="CLEAR",t[t.DISCARD=2]="DISCARD"}(co||(co={})),function(t){t[t.STORE=0]="STORE",t[t.DISCARD=1]="DISCARD"}(ho||(ho={})),function(t){t[t.NONE=0]="NONE",t[t.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",t[t.INDEX_BUFFER=2]="INDEX_BUFFER",t[t.VERTEX_BUFFER=3]="VERTEX_BUFFER",t[t.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",t[t.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",t[t.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",t[t.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",t[t.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",t[t.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",t[t.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",t[t.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",t[t.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",t[t.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",t[t.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",t[t.TRANSFER_READ=17]="TRANSFER_READ",t[t.HOST_READ=18]="HOST_READ",t[t.PRESENT=19]="PRESENT",t[t.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",t[t.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",t[t.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",t[t.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",t[t.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",t[t.TRANSFER_WRITE=25]="TRANSFER_WRITE",t[t.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",t[t.HOST_WRITE=27]="HOST_WRITE"}(_o||(_o={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.RAY_TRACING=2]="RAY_TRACING"}(uo||(uo={})),function(t){t[t.POINT_LIST=0]="POINT_LIST",t[t.LINE_LIST=1]="LINE_LIST",t[t.LINE_STRIP=2]="LINE_STRIP",t[t.LINE_LOOP=3]="LINE_LOOP",t[t.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",t[t.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",t[t.ISO_LINE_LIST=6]="ISO_LINE_LIST",t[t.TRIANGLE_LIST=7]="TRIANGLE_LIST",t[t.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=9]="TRIANGLE_FAN",t[t.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",t[t.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",t[t.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",t[t.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(mo||(mo={})),function(t){t[t.FILL=0]="FILL",t[t.POINT=1]="POINT",t[t.LINE=2]="LINE"}(po||(po={})),function(t){t[t.GOURAND=0]="GOURAND",t[t.FLAT=1]="FLAT"}(fo||(fo={})),function(t){t[t.NONE=0]="NONE",t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK"}(go||(go={})),function(t){t[t.NONE=0]="NONE",t[t.VIEWPORT=1]="VIEWPORT",t[t.SCISSOR=2]="SCISSOR",t[t.LINE_WIDTH=4]="LINE_WIDTH",t[t.DEPTH_BIAS=8]="DEPTH_BIAS",t[t.BLEND_CONSTANTS=16]="BLEND_CONSTANTS",t[t.DEPTH_BOUNDS=32]="DEPTH_BOUNDS",t[t.STENCIL_WRITE_MASK=64]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=128]="STENCIL_COMPARE_MASK"}(yo||(yo={})),function(t){t[t.FRONT=0]="FRONT",t[t.BACK=1]="BACK",t[t.ALL=2]="ALL"}(vo||(vo={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",t[t.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",t[t.STORAGE_BUFFER=4]="STORAGE_BUFFER",t[t.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",t[t.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE=64]="TEXTURE",t[t.STORAGE_IMAGE=128]="STORAGE_IMAGE",t[t.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(xo||(xo={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.TRANSFER=2]="TRANSFER"}(So||(So={})),function(t){t[t.PRIMARY=0]="PRIMARY",t[t.SECONDARY=1]="SECONDARY"}(Ao||(Ao={})),function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.DEPTH=2]="DEPTH",t[t.STENCIL=4]="STENCIL",t[t.DEPTH_STENCIL=6]="DEPTH_STENCIL",t[t.ALL=7]="ALL"}(Co||(Co={}));class To{constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.z=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}}class wo{constructor(t=0,e=0,i=0,n=0,s=0,r=0,o=0,a=0,l=0,c=0,h=0,_=0,u=0,m=0,d=0,p=1,f=0,g=0,y=new To,v=new To,x=-1,S=1,A=1){this.maxVertexAttributes=t,this.maxVertexUniformVectors=e,this.maxFragmentUniformVectors=i,this.maxTextureUnits=n,this.maxImageUnits=s,this.maxVertexTextureUnits=r,this.maxColorRenderTargets=o,this.maxShaderStorageBufferBindings=a,this.maxShaderStorageBlockSize=l,this.maxUniformBufferBindings=c,this.maxUniformBlockSize=h,this.maxTextureSize=_,this.maxCubeMapTextureSize=u,this.depthBits=m,this.stencilBits=d,this.uboOffsetAlignment=p,this.maxComputeSharedMemorySize=f,this.maxComputeWorkGroupInvocations=g,this.maxComputeWorkGroupSize=y,this.maxComputeWorkGroupCount=v,this.clipSpaceMinZ=x,this.screenSpaceSignY=S,this.clipSpaceSignY=A}copy(t){return this.maxVertexAttributes=t.maxVertexAttributes,this.maxVertexUniformVectors=t.maxVertexUniformVectors,this.maxFragmentUniformVectors=t.maxFragmentUniformVectors,this.maxTextureUnits=t.maxTextureUnits,this.maxImageUnits=t.maxImageUnits,this.maxVertexTextureUnits=t.maxVertexTextureUnits,this.maxColorRenderTargets=t.maxColorRenderTargets,this.maxShaderStorageBufferBindings=t.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=t.maxShaderStorageBlockSize,this.maxUniformBufferBindings=t.maxUniformBufferBindings,this.maxUniformBlockSize=t.maxUniformBlockSize,this.maxTextureSize=t.maxTextureSize,this.maxCubeMapTextureSize=t.maxCubeMapTextureSize,this.depthBits=t.depthBits,this.stencilBits=t.stencilBits,this.uboOffsetAlignment=t.uboOffsetAlignment,this.maxComputeSharedMemorySize=t.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=t.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(t.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(t.maxComputeWorkGroupCount),this.clipSpaceMinZ=t.clipSpaceMinZ,this.screenSpaceSignY=t.screenSpaceSignY,this.clipSpaceSignY=t.clipSpaceSignY,this}}class Eo{constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.z=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}}class Po{constructor(t=0,e=0,i=0,n=0){this.x=t,this.y=e,this.width=i,this.height=n}copy(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}}class Io{constructor(t=0,e=0,i=1){this.width=t,this.height=e,this.depth=i}copy(t){return this.width=t.width,this.height=t.height,this.depth=t.depth,this}}class Do{constructor(t=0,e=0,i=1){this.mipLevel=t,this.baseArrayLayer=e,this.layerCount=i}copy(t){return this.mipLevel=t.mipLevel,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this}}class Ro{constructor(t=0,e=1,i=0,n=1){this.baseMipLevel=t,this.levelCount=e,this.baseArrayLayer=i,this.layerCount=n}copy(t){return this.baseMipLevel=t.baseMipLevel,this.levelCount=t.levelCount,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this}}class Mo{constructor(t=new Do,e=new Eo,i=new Do,n=new Eo,s=new Io){this.srcSubres=t,this.srcOffset=e,this.dstSubres=i,this.dstOffset=n,this.extent=s}copy(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.extent.copy(t.extent),this}}class Bo{constructor(t=new Do,e=new Eo,i=new Io,n=new Do,s=new Eo,r=new Io){this.srcSubres=t,this.srcOffset=e,this.srcExtent=i,this.dstSubres=n,this.dstOffset=s,this.dstExtent=r}copy(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.srcExtent.copy(t.srcExtent),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.dstExtent.copy(t.dstExtent),this}}class Oo{constructor(t=0,e=0,i=new Eo,n=new Io,s=new Do){this.buffStride=t,this.buffTexHeight=e,this.texOffset=i,this.texExtent=n,this.texSubres=s}copy(t){return this.buffStride=t.buffStride,this.buffTexHeight=t.buffTexHeight,this.texOffset.copy(t.texOffset),this.texExtent.copy(t.texExtent),this.texSubres.copy(t.texSubres),this}}class No{constructor(t=0,e=0,i=0,n=0,s=0,r=1){this.left=t,this.top=e,this.width=i,this.height=n,this.minDepth=s,this.maxDepth=r}copy(t){return this.left=t.left,this.top=t.top,this.width=t.width,this.height=t.height,this.minDepth=t.minDepth,this.maxDepth=t.maxDepth,this}}class Lo{constructor(t=0,e=0,i=0,n=0){this.x=t,this.y=e,this.z=i,this.w=n}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}}class Fo{constructor(t=[],e=[],i=0){this.bufferOffsets=t,this.samplerOffsets=e,this.flexibleSet=i}copy(t){return this.bufferOffsets=t.bufferOffsets.slice(),this.samplerOffsets=t.samplerOffsets.slice(),this.flexibleSet=t.flexibleSet,this}}class zo{constructor(t=Xr.NONE,e=Jr.NONE,i=0,n=0,s=Yr.NONE){this.usage=t,this.memUsage=e,this.size=i,this.stride=n,this.flags=s}copy(t){return this.usage=t.usage,this.memUsage=t.memUsage,this.size=t.size,this.stride=t.stride,this.flags=t.flags,this}}class Vo{constructor(t=null,e=0,i=0){this.buffer=t,this.offset=e,this.range=i}copy(t){return this.buffer=t.buffer,this.offset=t.offset,this.range=t.range,this}}class Uo{constructor(t=0,e=0,i=0,n=0,s=0,r=0,o=0){this.vertexCount=t,this.firstVertex=e,this.indexCount=i,this.firstIndex=n,this.vertexOffset=s,this.instanceCount=r,this.firstInstance=o}copy(t){return this.vertexCount=t.vertexCount,this.firstVertex=t.firstVertex,this.indexCount=t.indexCount,this.firstIndex=t.firstIndex,this.vertexOffset=t.vertexOffset,this.instanceCount=t.instanceCount,this.firstInstance=t.firstInstance,this}}class Go{constructor(t=0,e=0,i=0,n=null,s=0){this.groupCountX=t,this.groupCountY=e,this.groupCountZ=i,this.indirectBuffer=n,this.indirectOffset=s}copy(t){return this.groupCountX=t.groupCountX,this.groupCountY=t.groupCountY,this.groupCountZ=t.groupCountZ,this.indirectBuffer=t.indirectBuffer,this.indirectOffset=t.indirectOffset,this}}class Ho{constructor(t=[]){this.drawInfos=t}copy(t){return zr(this.drawInfos,t.drawInfos,Uo),this}}class ko{constructor(t=$r.TEX2D,e=Zr.NONE,i=jr.UNKNOWN,n=0,s=0,r=Qr.NONE,o=1,a=1,l=to.X1,c=1){this.type=t,this.usage=e,this.format=i,this.width=n,this.height=s,this.flags=r,this.layerCount=o,this.levelCount=a,this.samples=l,this.depth=c}copy(t){return this.type=t.type,this.usage=t.usage,this.format=t.format,this.width=t.width,this.height=t.height,this.flags=t.flags,this.layerCount=t.layerCount,this.levelCount=t.levelCount,this.samples=t.samples,this.depth=t.depth,this}}class jo{constructor(t=null,e=$r.TEX2D,i=jr.UNKNOWN,n=0,s=1,r=0,o=1){this.texture=t,this.type=e,this.format=i,this.baseLevel=n,this.levelCount=s,this.baseLayer=r,this.layerCount=o}copy(t){return this.texture=t.texture,this.type=t.type,this.format=t.format,this.baseLevel=t.baseLevel,this.levelCount=t.levelCount,this.baseLayer=t.baseLayer,this.layerCount=t.layerCount,this}}class Wo{constructor(t=eo.LINEAR,e=eo.LINEAR,i=eo.NONE,n=io.WRAP,s=io.WRAP,r=io.WRAP,o=0,a=no.ALWAYS,l=new Lo,c=0){this.minFilter=t,this.magFilter=e,this.mipFilter=i,this.addressU=n,this.addressV=s,this.addressW=r,this.maxAnisotropy=o,this.cmpFunc=a,this.borderColor=l,this.mipLODBias=c}copy(t){return this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.mipFilter=t.mipFilter,this.addressU=t.addressU,this.addressV=t.addressV,this.addressW=t.addressW,this.maxAnisotropy=t.maxAnisotropy,this.cmpFunc=t.cmpFunc,this.borderColor.copy(t.borderColor),this.mipLODBias=t.mipLODBias,this}}class qo{constructor(t="",e=qr.UNKNOWN,i=0){this.name=t,this.type=e,this.count=i}copy(t){return this.name=t.name,this.type=t.type,this.count=t.count,this}}class Xo{constructor(t=0,e=0,i="",n=[],s=0){this.set=t,this.binding=e,this.name=i,this.members=n,this.count=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,zr(this.members,t.members,qo),this.count=t.count,this}}class Yo{constructor(t=0,e=0,i="",n=qr.UNKNOWN,s=0){this.set=t,this.binding=e,this.name=i,this.type=n,this.count=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this}}class Ko{constructor(t=0,e=0,i="",n=0){this.set=t,this.binding=e,this.name=i,this.count=n}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this}}class Jo{constructor(t=0,e=0,i="",n=qr.UNKNOWN,s=0){this.set=t,this.binding=e,this.name=i,this.type=n,this.count=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this}}class $o{constructor(t=0,e=0,i="",n=qr.UNKNOWN,s=0,r=Kr.READ_WRITE){this.set=t,this.binding=e,this.name=i,this.type=n,this.count=s,this.memoryAccess=r}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this.memoryAccess=t.memoryAccess,this}}class Zo{constructor(t=0,e=0,i="",n=0,s=Kr.READ_WRITE){this.set=t,this.binding=e,this.name=i,this.count=n,this.memoryAccess=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this.memoryAccess=t.memoryAccess,this}}class Qo{constructor(t=0,e=0,i="",n=0){this.set=t,this.binding=e,this.name=i,this.count=n}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this}}class ta{constructor(t=lo.NONE,e=""){this.stage=t,this.source=e}copy(t){return this.stage=t.stage,this.source=t.source,this}}class ea{constructor(t="",e=jr.UNKNOWN,i=!1,n=0,s=!1,r=0){this.name=t,this.format=e,this.isNormalized=i,this.stream=n,this.isInstanced=s,this.location=r}copy(t){return this.name=t.name,this.format=t.format,this.isNormalized=t.isNormalized,this.stream=t.stream,this.isInstanced=t.isInstanced,this.location=t.location,this}}class ia{constructor(t="",e=[],i=[],n=[],s=[],r=[],o=[],a=[],l=[],c=[]){this.name=t,this.stages=e,this.attributes=i,this.blocks=n,this.buffers=s,this.samplerTextures=r,this.samplers=o,this.textures=a,this.images=l,this.subpassInputs=c}copy(t){return this.name=t.name,zr(this.stages,t.stages,ta),zr(this.attributes,t.attributes,ea),zr(this.blocks,t.blocks,Xo),zr(this.buffers,t.buffers,Zo),zr(this.samplerTextures,t.samplerTextures,Yo),zr(this.samplers,t.samplers,Ko),zr(this.textures,t.textures,Jo),zr(this.images,t.images,$o),zr(this.subpassInputs,t.subpassInputs,Qo),this}}class na{constructor(t=[],e=[],i=null,n=null){this.attributes=t,this.vertexBuffers=e,this.indexBuffer=i,this.indirectBuffer=n}copy(t){return zr(this.attributes,t.attributes,ea),this.vertexBuffers=t.vertexBuffers.slice(),this.indexBuffer=t.indexBuffer,this.indirectBuffer=t.indirectBuffer,this}}class sa{constructor(t=jr.UNKNOWN,e=to.X1,i=co.CLEAR,n=ho.STORE,s=[],r=[_o.PRESENT]){this.format=t,this.sampleCount=e,this.loadOp=i,this.storeOp=n,this.beginAccesses=s,this.endAccesses=r}copy(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.loadOp=t.loadOp,this.storeOp=t.storeOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this}}class ra{constructor(t=jr.UNKNOWN,e=to.X1,i=co.CLEAR,n=ho.STORE,s=co.CLEAR,r=ho.STORE,o=[],a=[_o.DEPTH_STENCIL_ATTACHMENT_WRITE]){this.format=t,this.sampleCount=e,this.depthLoadOp=i,this.depthStoreOp=n,this.stencilLoadOp=s,this.stencilStoreOp=r,this.beginAccesses=o,this.endAccesses=a}copy(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.depthLoadOp=t.depthLoadOp,this.depthStoreOp=t.depthStoreOp,this.stencilLoadOp=t.stencilLoadOp,this.stencilStoreOp=t.stencilStoreOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this}}class oa{constructor(t=[],e=[],i=[],n=[],s=-1){this.inputs=t,this.colors=e,this.resolves=i,this.preserves=n,this.depthStencil=s}copy(t){return this.inputs=t.inputs.slice(),this.colors=t.colors.slice(),this.resolves=t.resolves.slice(),this.preserves=t.preserves.slice(),this.depthStencil=t.depthStencil,this}}class aa{constructor(t=[],e=new ra,i=[]){this.colorAttachments=t,this.depthStencilAttachment=e,this.subpasses=i}copy(t){return zr(this.colorAttachments,t.colorAttachments,sa),this.depthStencilAttachment.copy(t.depthStencilAttachment),zr(this.subpasses,t.subpasses,oa),this}}class la{constructor(t=[],e=[]){this.prevAccesses=t,this.nextAccesses=e}copy(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this}}class ca{constructor(t=[],e=[],i=!1,n=null,s=null){this.prevAccesses=t,this.nextAccesses=e,this.discardContents=i,this.srcQueue=n,this.dstQueue=s}copy(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this.discardContents=t.discardContents,this.srcQueue=t.srcQueue,this.dstQueue=t.dstQueue,this}}class ha{constructor(t=null,e=[],i=null,n=[],s=0){this.renderPass=t,this.colorTextures=e,this.depthStencilTexture=i,this.colorMipmapLevels=n,this.depthStencilMipmapLevel=s}copy(t){return this.renderPass=t.renderPass,this.colorTextures=t.colorTextures.slice(),this.depthStencilTexture=t.depthStencilTexture,this.colorMipmapLevels=t.colorMipmapLevels.slice(),this.depthStencilMipmapLevel=t.depthStencilMipmapLevel,this}}class _a{constructor(t=-1,e=xo.UNKNOWN,i=0,n=lo.NONE,s=[]){this.binding=t,this.descriptorType=e,this.count=i,this.stageFlags=n,this.immutableSamplers=s}copy(t){return this.binding=t.binding,this.descriptorType=t.descriptorType,this.count=t.count,this.stageFlags=t.stageFlags,this.immutableSamplers=t.immutableSamplers.slice(),this}}class ua{constructor(t=[]){this.bindings=t}copy(t){return zr(this.bindings,t.bindings,_a),this}}class ma{constructor(t=null){this.layout=t}copy(t){return this.layout=t.layout,this}}class da{constructor(t=[]){this.setLayouts=t}copy(t){return this.setLayouts=t.setLayouts.slice(),this}}class pa{constructor(t=[]){this.attributes=t}copy(t){return zr(this.attributes,t.attributes,ea),this}}class fa{constructor(t=null,e=Ao.PRIMARY){this.queue=t,this.type=e}copy(t){return this.queue=t.queue,this.type=t.type,this}}class ga{constructor(t=So.GRAPHICS){this.type=t}copy(t){return this.type=t.type,this}}class ya{constructor(t="",e=0,i=0,n=Wr.NONE,s=!1,r=!1,o=!1,a=!1){this.name=t,this.size=e,this.count=i,this.type=n,this.hasAlpha=s,this.hasDepth=r,this.hasStencil=o,this.isCompressed=a}}class va{constructor(t=0,e=0){this.bufferSize=t,this.textureSize=e}copy(t){return this.bufferSize=t.bufferSize,this.textureSize=t.textureSize,this}}class xa{get gfxType(){return this._gfxType}constructor(t){this._gfxType=Vr.UNKNOWN,this._gfxType=t}}class Sa{constructor(t,e=!0,i=!0,n=1,s=1,r=1,o=new Fo){this.canvasElm=t,this.isAntialias=e,this.isPremultipliedAlpha=i,this.devicePixelRatio=n,this.nativeWidth=s,this.nativeHeight=r,this.bindingMappingInfo=o}}!function(t){t.ATTR_POSITION="a_position",t.ATTR_NORMAL="a_normal",t.ATTR_TANGENT="a_tangent",t.ATTR_BITANGENT="a_bitangent",t.ATTR_WEIGHTS="a_weights",t.ATTR_JOINTS="a_joints",t.ATTR_COLOR="a_color",t.ATTR_COLOR1="a_color1",t.ATTR_COLOR2="a_color2",t.ATTR_TEX_COORD="a_texCoord",t.ATTR_TEX_COORD1="a_texCoord1",t.ATTR_TEX_COORD2="a_texCoord2",t.ATTR_TEX_COORD3="a_texCoord3",t.ATTR_TEX_COORD4="a_texCoord4",t.ATTR_TEX_COORD5="a_texCoord5",t.ATTR_TEX_COORD6="a_texCoord6",t.ATTR_TEX_COORD7="a_texCoord7",t.ATTR_TEX_COORD8="a_texCoord8",t.ATTR_BATCH_ID="a_batch_id",t.ATTR_BATCH_UV="a_batch_uv"}(bo||(bo={}));const Aa=Object.freeze([new ya("UNKNOWN",0,0,Wr.NONE,!1,!1,!1,!1),new ya("A8",1,1,Wr.UNORM,!0,!1,!1,!1),new ya("L8",1,1,Wr.UNORM,!1,!1,!1,!1),new ya("LA8",1,2,Wr.UNORM,!0,!1,!1,!1),new ya("R8",1,1,Wr.UNORM,!1,!1,!1,!1),new ya("R8SN",1,1,Wr.SNORM,!1,!1,!1,!1),new ya("R8UI",1,1,Wr.UINT,!1,!1,!1,!1),new ya("R8I",1,1,Wr.INT,!1,!1,!1,!1),new ya("R16F",2,1,Wr.FLOAT,!1,!1,!1,!1),new ya("R16UI",2,1,Wr.UINT,!1,!1,!1,!1),new ya("R16I",2,1,Wr.INT,!1,!1,!1,!1),new ya("R32F",4,1,Wr.FLOAT,!1,!1,!1,!1),new ya("R32UI",4,1,Wr.UINT,!1,!1,!1,!1),new ya("R32I",4,1,Wr.INT,!1,!1,!1,!1),new ya("RG8",2,2,Wr.UNORM,!1,!1,!1,!1),new ya("RG8SN",2,2,Wr.SNORM,!1,!1,!1,!1),new ya("RG8UI",2,2,Wr.UINT,!1,!1,!1,!1),new ya("RG8I",2,2,Wr.INT,!1,!1,!1,!1),new ya("RG16F",4,2,Wr.FLOAT,!1,!1,!1,!1),new ya("RG16UI",4,2,Wr.UINT,!1,!1,!1,!1),new ya("RG16I",4,2,Wr.INT,!1,!1,!1,!1),new ya("RG32F",8,2,Wr.FLOAT,!1,!1,!1,!1),new ya("RG32UI",8,2,Wr.UINT,!1,!1,!1,!1),new ya("RG32I",8,2,Wr.INT,!1,!1,!1,!1),new ya("RGB8",3,3,Wr.UNORM,!1,!1,!1,!1),new ya("SRGB8",3,3,Wr.UNORM,!1,!1,!1,!1),new ya("RGB8SN",3,3,Wr.SNORM,!1,!1,!1,!1),new ya("RGB8UI",3,3,Wr.UINT,!1,!1,!1,!1),new ya("RGB8I",3,3,Wr.INT,!1,!1,!1,!1),new ya("RGB16F",6,3,Wr.FLOAT,!1,!1,!1,!1),new ya("RGB16UI",6,3,Wr.UINT,!1,!1,!1,!1),new ya("RGB16I",6,3,Wr.INT,!1,!1,!1,!1),new ya("RGB32F",12,3,Wr.FLOAT,!1,!1,!1,!1),new ya("RGB32UI",12,3,Wr.UINT,!1,!1,!1,!1),new ya("RGB32I",12,3,Wr.INT,!1,!1,!1,!1),new ya("RGBA8",4,4,Wr.UNORM,!0,!1,!1,!1),new ya("BGRA8",4,4,Wr.UNORM,!0,!1,!1,!1),new ya("SRGB8_A8",4,4,Wr.UNORM,!0,!1,!1,!1),new ya("RGBA8SN",4,4,Wr.SNORM,!0,!1,!1,!1),new ya("RGBA8UI",4,4,Wr.UINT,!0,!1,!1,!1),new ya("RGBA8I",4,4,Wr.INT,!0,!1,!1,!1),new ya("RGBA16F",8,4,Wr.FLOAT,!0,!1,!1,!1),new ya("RGBA16UI",8,4,Wr.UINT,!0,!1,!1,!1),new ya("RGBA16I",8,4,Wr.INT,!0,!1,!1,!1),new ya("RGBA32F",16,4,Wr.FLOAT,!0,!1,!1,!1),new ya("RGBA32UI",16,4,Wr.UINT,!0,!1,!1,!1),new ya("RGBA32I",16,4,Wr.INT,!0,!1,!1,!1),new ya("R5G6B5",2,3,Wr.UNORM,!1,!1,!1,!1),new ya("R11G11B10F",4,3,Wr.FLOAT,!1,!1,!1,!1),new ya("RGB5A1",2,4,Wr.UNORM,!0,!1,!1,!1),new ya("RGBA4",2,4,Wr.UNORM,!0,!1,!1,!1),new ya("RGB10A2",2,4,Wr.UNORM,!0,!1,!1,!1),new ya("RGB10A2UI",2,4,Wr.UINT,!0,!1,!1,!1),new ya("RGB9E5",2,4,Wr.FLOAT,!0,!1,!1,!1),new ya("D16",2,1,Wr.UINT,!1,!0,!1,!1),new ya("D16S8",3,2,Wr.UINT,!1,!0,!0,!1),new ya("D24",3,1,Wr.UINT,!1,!0,!1,!1),new ya("D24S8",4,2,Wr.UINT,!1,!0,!0,!1),new ya("D32F",4,1,Wr.FLOAT,!1,!0,!1,!1),new ya("D32FS8",5,2,Wr.FLOAT,!1,!0,!0,!1),new ya("BC1",1,3,Wr.UNORM,!1,!1,!1,!0),new ya("BC1_ALPHA",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("BC1_SRGB",1,3,Wr.UNORM,!1,!1,!1,!0),new ya("BC1_SRGB_ALPHA",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("BC2",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("BC2_SRGB",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("BC3",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("BC3_SRGB",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("BC4",1,1,Wr.UNORM,!1,!1,!1,!0),new ya("BC4_SNORM",1,1,Wr.SNORM,!1,!1,!1,!0),new ya("BC5",1,2,Wr.UNORM,!1,!1,!1,!0),new ya("BC5_SNORM",1,2,Wr.SNORM,!1,!1,!1,!0),new ya("BC6H_UF16",1,3,Wr.UFLOAT,!1,!1,!1,!0),new ya("BC6H_SF16",1,3,Wr.FLOAT,!1,!1,!1,!0),new ya("BC7",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("BC7_SRGB",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ETC_RGB8",1,3,Wr.UNORM,!1,!1,!1,!0),new ya("ETC2_RGB8",1,3,Wr.UNORM,!1,!1,!1,!0),new ya("ETC2_SRGB8",1,3,Wr.UNORM,!1,!1,!1,!0),new ya("ETC2_RGB8_A1",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ETC2_SRGB8_A1",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ETC2_RGBA8",2,4,Wr.UNORM,!0,!1,!1,!0),new ya("ETC2_SRGB8_A8",2,4,Wr.UNORM,!0,!1,!1,!0),new ya("EAC_R11",1,1,Wr.UNORM,!1,!1,!1,!0),new ya("EAC_R11SN",1,1,Wr.SNORM,!1,!1,!1,!0),new ya("EAC_RG11",2,2,Wr.UNORM,!1,!1,!1,!0),new ya("EAC_RG11SN",2,2,Wr.SNORM,!1,!1,!1,!0),new ya("PVRTC_RGB2",2,3,Wr.UNORM,!1,!1,!1,!0),new ya("PVRTC_RGBA2",2,4,Wr.UNORM,!0,!1,!1,!0),new ya("PVRTC_RGB4",2,3,Wr.UNORM,!1,!1,!1,!0),new ya("PVRTC_RGBA4",2,4,Wr.UNORM,!0,!1,!1,!0),new ya("PVRTC2_2BPP",2,4,Wr.UNORM,!0,!1,!1,!0),new ya("PVRTC2_4BPP",2,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_RGBA_4x4",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_RGBA_5x4",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_RGBA_5x5",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_RGBA_6x5",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_RGBA_6x6",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_RGBA_8x5",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_RGBA_8x6",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_RGBA_8x8",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_RGBA_10x5",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_RGBA_10x6",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_RGBA_10x8",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_RGBA_10x10",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_RGBA_12x10",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_RGBA_12x12",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_SRGBA_4x4",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_SRGBA_5x4",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_SRGBA_5x5",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_SRGBA_6x5",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_SRGBA_6x6",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_SRGBA_8x5",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_SRGBA_8x6",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_SRGBA_8x8",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_SRGBA_10x5",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_SRGBA_10x6",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_SRGBA_10x8",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_SRGBA_10x10",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_SRGBA_12x10",1,4,Wr.UNORM,!0,!1,!1,!0),new ya("ASTC_SRGBA_12x12",1,4,Wr.UNORM,!0,!1,!1,!0)]),Ca=xo.UNIFORM_BUFFER|xo.DYNAMIC_UNIFORM_BUFFER|xo.STORAGE_BUFFER|xo.DYNAMIC_STORAGE_BUFFER,ba=xo.SAMPLER_TEXTURE|xo.SAMPLER|xo.TEXTURE|xo.STORAGE_IMAGE|xo.INPUT_ATTACHMENT,Ta=xo.DYNAMIC_STORAGE_BUFFER|xo.DYNAMIC_UNIFORM_BUFFER;function wa(t){return t>0&&0==(t&t-1)}function Ea(t,e,i,n){if(!Aa[t].isCompressed)return e*i*n*Aa[t].size;switch(t){case jr.BC1:case jr.BC1_ALPHA:case jr.BC1_SRGB:case jr.BC1_SRGB_ALPHA:return Math.ceil(e/4)*Math.ceil(i/4)*8*n;case jr.BC2:case jr.BC2_SRGB:case jr.BC3:case jr.BC3_SRGB:case jr.BC4:case jr.BC4_SNORM:case jr.BC6H_SF16:case jr.BC6H_UF16:case jr.BC7:case jr.BC7_SRGB:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case jr.BC5:case jr.BC5_SNORM:return Math.ceil(e/4)*Math.ceil(i/4)*32*n;case jr.ETC_RGB8:case jr.ETC2_RGB8:case jr.ETC2_SRGB8:case jr.ETC2_RGB8_A1:case jr.EAC_R11:case jr.EAC_R11SN:return Math.ceil(e/4)*Math.ceil(i/4)*8*n;case jr.ETC2_RGBA8:case jr.ETC2_SRGB8_A1:case jr.EAC_RG11:case jr.EAC_RG11SN:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case jr.PVRTC_RGB2:case jr.PVRTC_RGBA2:case jr.PVRTC2_2BPP:return Math.ceil(Math.max(e,16)*Math.max(i,8)/4)*n;case jr.PVRTC_RGB4:case jr.PVRTC_RGBA4:case jr.PVRTC2_4BPP:return Math.ceil(Math.max(e,8)*Math.max(i,8)/2)*n;case jr.ASTC_RGBA_4x4:case jr.ASTC_SRGBA_4x4:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case jr.ASTC_RGBA_5x4:case jr.ASTC_SRGBA_5x4:return Math.ceil(e/5)*Math.ceil(i/4)*16*n;case jr.ASTC_RGBA_5x5:case jr.ASTC_SRGBA_5x5:return Math.ceil(e/5)*Math.ceil(i/5)*16*n;case jr.ASTC_RGBA_6x5:case jr.ASTC_SRGBA_6x5:return Math.ceil(e/6)*Math.ceil(i/5)*16*n;case jr.ASTC_RGBA_6x6:case jr.ASTC_SRGBA_6x6:return Math.ceil(e/6)*Math.ceil(i/6)*16*n;case jr.ASTC_RGBA_8x5:case jr.ASTC_SRGBA_8x5:return Math.ceil(e/8)*Math.ceil(i/5)*16*n;case jr.ASTC_RGBA_8x6:case jr.ASTC_SRGBA_8x6:return Math.ceil(e/8)*Math.ceil(i/6)*16*n;case jr.ASTC_RGBA_8x8:case jr.ASTC_SRGBA_8x8:return Math.ceil(e/8)*Math.ceil(i/8)*16*n;case jr.ASTC_RGBA_10x5:case jr.ASTC_SRGBA_10x5:return Math.ceil(e/10)*Math.ceil(i/5)*16*n;case jr.ASTC_RGBA_10x6:case jr.ASTC_SRGBA_10x6:return Math.ceil(e/10)*Math.ceil(i/6)*16*n;case jr.ASTC_RGBA_10x8:case jr.ASTC_SRGBA_10x8:return Math.ceil(e/10)*Math.ceil(i/8)*16*n;case jr.ASTC_RGBA_10x10:case jr.ASTC_SRGBA_10x10:return Math.ceil(e/10)*Math.ceil(i/10)*16*n;case jr.ASTC_RGBA_12x10:case jr.ASTC_SRGBA_12x10:return Math.ceil(e/12)*Math.ceil(i/10)*16*n;case jr.ASTC_RGBA_12x12:case jr.ASTC_SRGBA_12x12:return Math.ceil(e/12)*Math.ceil(i/12)*16*n;default:return 0}}function Pa(t,e,i,n,s){let r=0;for(let o=0;o<s;++o)r+=Ea(t,e,i,n),e=Math.max(e>>1,1),i=Math.max(i>>1,1);return r}const Ia=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Da(t){return Ia[t]||0}function Ra(t){const e=t.size/t.count;switch(t.type){case Wr.UNORM:case Wr.UINT:switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Wr.SNORM:case Wr.INT:switch(e){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Wr.FLOAT:return Float32Array}return Float32Array}var Ma=Object.freeze({__proto__:null,get ObjectType(){return Vr},get Status(){return Ur},get API(){return Gr},get SurfaceTransform(){return Hr},get Feature(){return kr},get Format(){return jr},get FormatType(){return Wr},get Type(){return qr},get BufferUsageBit(){return Xr},get BufferFlagBit(){return Yr},get MemoryAccessBit(){return Kr},get MemoryUsageBit(){return Jr},get TextureType(){return $r},get TextureUsageBit(){return Zr},get TextureFlagBit(){return Qr},get SampleCount(){return to},get Filter(){return eo},get Address(){return io},get ComparisonFunc(){return no},get StencilOp(){return so},get BlendFactor(){return ro},get BlendOp(){return oo},get ColorMask(){return ao},get ShaderStageFlagBit(){return lo},get LoadOp(){return co},get StoreOp(){return ho},get AccessType(){return _o},get PipelineBindPoint(){return uo},get PrimitiveMode(){return mo},get PolygonMode(){return po},get ShadeModel(){return fo},get CullMode(){return go},get DynamicStateFlagBit(){return yo},get StencilFace(){return vo},get DescriptorType(){return xo},get QueueType(){return So},get CommandBufferType(){return Ao},get ClearFlagBit(){return Co},Size:To,DeviceCaps:wo,Offset:Eo,Rect:Po,Extent:Io,TextureSubresLayers:Do,TextureSubresRange:Ro,TextureCopy:Mo,TextureBlit:Bo,BufferTextureCopy:Oo,Viewport:No,Color:Lo,BindingMappingInfo:Fo,BufferInfo:zo,BufferViewInfo:Vo,DrawInfo:Uo,DispatchInfo:Go,IndirectBuffer:Ho,TextureInfo:ko,TextureViewInfo:jo,SamplerInfo:Wo,Uniform:qo,UniformBlock:Xo,UniformSamplerTexture:Yo,UniformSampler:Ko,UniformTexture:Jo,UniformStorageImage:$o,UniformStorageBuffer:Zo,UniformInputAttachment:Qo,ShaderStage:ta,Attribute:ea,ShaderInfo:ia,InputAssemblerInfo:na,ColorAttachment:sa,DepthStencilAttachment:ra,SubpassInfo:oa,RenderPassInfo:aa,GlobalBarrierInfo:la,TextureBarrierInfo:ca,FramebufferInfo:ha,DescriptorSetLayoutBinding:_a,DescriptorSetLayoutInfo:ua,DescriptorSetInfo:ma,PipelineLayoutInfo:da,InputState:pa,CommandBufferInfo:fa,QueueInfo:ga,FormatInfo:ya,MemoryStatus:va,Obj:xa,DeviceInfo:Sa,get AttributeName(){return bo},FormatInfos:Aa,DESCRIPTOR_BUFFER_TYPE:Ca,DESCRIPTOR_SAMPLER_TYPE:ba,DESCRIPTOR_DYNAMIC_TYPE:Ta,DRAW_INFO_SIZE:28,IsPowerOf2:wa,FormatSize:Ea,FormatSurfaceSize:Pa,GetTypeSize:Da,getTypedArrayConstructor:Ra});class Ba{constructor(t=!1,e=po.FILL,i=fo.GOURAND,n=go.BACK,s=!0,r=!1,o=0,a=0,l=0,c=!0,h=!1,_=1){this.h=void 0,this.h=or.alloc(),this.assignProperties(t,e,i,n,s,r,o,a,l,c,h,_)}get isDiscard(){return!!or.get(this.h,sr.IS_DISCARD)}set isDiscard(t){or.set(this.h,sr.IS_DISCARD,t?1:0)}get polygonMode(){return or.get(this.h,sr.POLYGO_MODEL)}set polygonMode(t){or.set(this.h,sr.POLYGO_MODEL,t)}get shadeModel(){return or.get(this.h,sr.SHADE_MODEL)}set shadeModel(t){or.set(this.h,sr.SHADE_MODEL,t)}get cullMode(){return or.get(this.h,sr.CULL_MODE)}set cullMode(t){or.set(this.h,sr.CULL_MODE,t)}get isFrontFaceCCW(){return!!or.get(this.h,sr.IS_FRONT_FACE_CCW)}set isFrontFaceCCW(t){or.set(this.h,sr.IS_FRONT_FACE_CCW,t?1:0)}get depthBiasEnabled(){return!!or.get(this.h,sr.DEPTH_BIAS_ENABLED)}set depthBiasEnabled(t){or.set(this.h,sr.DEPTH_BIAS_ENABLED,t?1:0)}get depthBias(){return or.get(this.h,sr.DEPTH_BIAS)}set depthBias(t){or.set(this.h,sr.DEPTH_BIAS,t)}get depthBiasClamp(){return or.get(this.h,sr.DEPTH_BIAS_CLAMP)}set depthBiasClamp(t){or.set(this.h,sr.DEPTH_BIAS_CLAMP,t)}get depthBiasSlop(){return or.get(this.h,sr.DEPTH_BIAS_SLOP)}set depthBiasSlop(t){or.set(this.h,sr.DEPTH_BIAS_SLOP,t)}get isDepthClip(){return!!or.get(this.h,sr.IS_DEPTH_CLIP)}set isDepthClip(t){or.set(this.h,sr.IS_DEPTH_CLIP,t?1:0)}get isMultisample(){return!!or.get(this.h,sr.IS_MULTI_SAMPLE)}set isMultisample(t){or.set(this.h,sr.IS_MULTI_SAMPLE,t?1:0)}get lineWidth(){return or.get(this.h,sr.LINE_WIDTH)}set lineWidth(t){or.set(this.h,sr.LINE_WIDTH,t)}get handle(){return this.h}reset(){this.assignProperties(!1,po.FILL,fo.GOURAND,go.BACK,!0,!1,0,0,0,!0,!1,1)}assign(t){t&&this.assignProperties(t.isDiscard,t.polygonMode,t.shadeModel,t.cullMode,t.isFrontFaceCCW,t.depthBiasEnabled,t.depthBias,t.depthBiasClamp,t.depthBiasSlop,t.isDepthClip,t.isMultisample,t.lineWidth)}destroy(){this.h&&(or.free(this.h),this.h=0)}assignProperties(t,e,i,n,s,r,o,a,l,c,h,_){void 0!==t&&(this.isDiscard=t),void 0!==e&&(this.polygonMode=e),void 0!==i&&(this.shadeModel=i),void 0!==n&&(this.cullMode=n),void 0!==s&&(this.isFrontFaceCCW=s),void 0!==r&&(this.depthBiasEnabled=r),void 0!==o&&(this.depthBias=o),void 0!==a&&(this.depthBiasClamp=a),void 0!==l&&(this.depthBiasSlop=l),void 0!==c&&(this.isDepthClip=c),void 0!==h&&(this.isMultisample=h),void 0!==_&&(this.lineWidth=_)}}class Oa{constructor(t=!0,e=!0,i=no.LESS,n=!1,s=no.ALWAYS,r=65535,o=65535,a=so.KEEP,l=so.KEEP,c=so.KEEP,h=1,_=!1,u=no.ALWAYS,m=65535,d=65535,p=so.KEEP,f=so.KEEP,g=so.KEEP,y=1){this.h=void 0,this.h=cr.alloc(),this.assignProperties(t,e,i,n,s,r,o,a,l,c,h,_,u,m,d,p,f,g,y)}get depthTest(){return!!cr.get(this.h,ar.DEPTH_TEST)}set depthTest(t){cr.set(this.h,ar.DEPTH_TEST,t?1:0)}get depthWrite(){return!!cr.get(this.h,ar.DEPTH_WRITE)}set depthWrite(t){cr.set(this.h,ar.DEPTH_WRITE,t?1:0)}get depthFunc(){return cr.get(this.h,ar.DEPTH_FUNC)}set depthFunc(t){cr.set(this.h,ar.DEPTH_FUNC,t)}get stencilTestFront(){return!!cr.get(this.h,ar.STENCIL_TEST_FRONT)}set stencilTestFront(t){cr.set(this.h,ar.STENCIL_TEST_FRONT,t?1:0)}get stencilFuncFront(){return cr.get(this.h,ar.STENCIL_FUNC_FRONT)}set stencilFuncFront(t){cr.set(this.h,ar.STENCIL_FUNC_FRONT,t)}get stencilReadMaskFront(){return cr.get(this.h,ar.STENCIL_READ_MASK_FRONT)}set stencilReadMaskFront(t){cr.set(this.h,ar.STENCIL_READ_MASK_FRONT,t)}get stencilWriteMaskFront(){return cr.get(this.h,ar.STENCIL_WRITE_MASK_FRONT)}set stencilWriteMaskFront(t){cr.set(this.h,ar.STENCIL_WRITE_MASK_FRONT,t)}get stencilFailOpFront(){return cr.get(this.h,ar.STENCIL_FAIL_OP_FRONT)}set stencilFailOpFront(t){cr.set(this.h,ar.STENCIL_FAIL_OP_FRONT,t)}get stencilZFailOpFront(){return cr.get(this.h,ar.STENCIL_Z_FAIL_OP_FRONT)}set stencilZFailOpFront(t){cr.set(this.h,ar.STENCIL_Z_FAIL_OP_FRONT,t)}get stencilPassOpFront(){return cr.get(this.h,ar.STENCIL_PASS_OP_FRONT)}set stencilPassOpFront(t){cr.set(this.h,ar.STENCIL_PASS_OP_FRONT,t)}get stencilRefFront(){return cr.get(this.h,ar.STENCIL_REF_FRONT)}set stencilRefFront(t){cr.set(this.h,ar.STENCIL_REF_FRONT,t)}get stencilTestBack(){return!!cr.get(this.h,ar.STENCIL_TEST_BACK)}set stencilTestBack(t){cr.set(this.h,ar.STENCIL_TEST_BACK,t?1:0)}get stencilFuncBack(){return cr.get(this.h,ar.STENCIL_FUNC_BACK)}set stencilFuncBack(t){cr.set(this.h,ar.STENCIL_FUNC_BACK,t)}get stencilReadMaskBack(){return cr.get(this.h,ar.STENCIL_READ_MADK_BACK)}set stencilReadMaskBack(t){cr.set(this.h,ar.STENCIL_READ_MADK_BACK,t)}get stencilWriteMaskBack(){return cr.get(this.h,ar.STENCIL_WRITE_MASK_BACK)}set stencilWriteMaskBack(t){cr.set(this.h,ar.STENCIL_WRITE_MASK_BACK,t)}get stencilFailOpBack(){return cr.get(this.h,ar.STENCIL_FAIL_OP_BACK)}set stencilFailOpBack(t){cr.set(this.h,ar.STENCIL_FAIL_OP_BACK,t)}get stencilZFailOpBack(){return cr.get(this.h,ar.STENCIL_Z_FAIL_OP_BACK)}set stencilZFailOpBack(t){cr.set(this.h,ar.STENCIL_Z_FAIL_OP_BACK,t)}get stencilPassOpBack(){return cr.get(this.h,ar.STENCIL_PASS_OP_BACK)}set stencilPassOpBack(t){cr.set(this.h,ar.STENCIL_PASS_OP_BACK,t)}get stencilRefBack(){return cr.get(this.h,ar.STENCIL_REF_BACK)}set stencilRefBack(t){cr.set(this.h,ar.STENCIL_REF_BACK,t)}get handle(){return this.h}reset(){this.assignProperties(!0,!0,no.LESS,!1,no.ALWAYS,65535,65535,so.KEEP,so.KEEP,so.KEEP,1,!1,no.ALWAYS,65535,65535,so.KEEP,so.KEEP,so.KEEP,1)}assign(t){t&&this.assignProperties(t.depthTest,t.depthWrite,t.depthFunc,t.stencilTestFront,t.stencilFuncFront,t.stencilReadMaskFront,t.stencilWriteMaskFront,t.stencilFailOpFront,t.stencilZFailOpFront,t.stencilPassOpFront,t.stencilRefFront,t.stencilTestBack,t.stencilFuncBack,t.stencilReadMaskBack,t.stencilWriteMaskBack,t.stencilFailOpBack,t.stencilZFailOpBack,t.stencilPassOpBack,t.stencilRefBack)}destroy(){cr.free(this.h),this.h=0}assignProperties(t,e,i,n,s,r,o,a,l,c,h,_,u,m,d,p,f,g,y){void 0!==t&&(this.depthTest=t),void 0!==e&&(this.depthWrite=e),void 0!==i&&(this.depthFunc=i),void 0!==n&&(this.stencilTestFront=n),void 0!==s&&(this.stencilFuncFront=s),void 0!==r&&(this.stencilReadMaskFront=r),void 0!==o&&(this.stencilWriteMaskFront=o),void 0!==a&&(this.stencilFailOpFront=a),void 0!==l&&(this.stencilZFailOpFront=l),void 0!==c&&(this.stencilPassOpFront=c),void 0!==h&&(this.stencilRefFront=h),void 0!==_&&(this.stencilTestBack=_),void 0!==u&&(this.stencilFuncBack=u),void 0!==m&&(this.stencilReadMaskBack=m),void 0!==d&&(this.stencilWriteMaskBack=d),void 0!==p&&(this.stencilFailOpBack=p),void 0!==f&&(this.stencilZFailOpBack=f),void 0!==g&&(this.stencilPassOpBack=g),void 0!==y&&(this.stencilRefBack=y)}}class Na{constructor(t=!1,e=ro.ONE,i=ro.ZERO,n=oo.ADD,s=ro.ONE,r=ro.ZERO,o=oo.ADD,a=ao.ALL){this.h=void 0,this.h=_r.alloc(),this.assignProperties(t,e,i,n,s,r,o,a)}get blend(){return!!_r.get(this.h,hr.BLEND)}set blend(t){_r.set(this.h,hr.BLEND,t?1:0)}get blendSrc(){return _r.get(this.h,hr.BLEND_SRC)}set blendSrc(t){_r.set(this.h,hr.BLEND_SRC,t)}get blendDst(){return _r.get(this.h,hr.BLEND_DST)}set blendDst(t){_r.set(this.h,hr.BLEND_DST,t)}get blendEq(){return _r.get(this.h,hr.BLEND_EQ)}set blendEq(t){_r.set(this.h,hr.BLEND_EQ,t)}get blendSrcAlpha(){return _r.get(this.h,hr.BLEND_SRC_ALPHA)}set blendSrcAlpha(t){_r.set(this.h,hr.BLEND_SRC_ALPHA,t)}get blendDstAlpha(){return _r.get(this.h,hr.BLEND_DST_ALPHA)}set blendDstAlpha(t){_r.set(this.h,hr.BLEND_DST_ALPHA,t)}get blendAlphaEq(){return _r.get(this.h,hr.BLEND_ALPHA_EQ)}set blendAlphaEq(t){_r.set(this.h,hr.BLEND_ALPHA_EQ,t)}get blendColorMask(){return _r.get(this.h,hr.BLEND_COLOR_MASK)}set blendColorMask(t){_r.set(this.h,hr.BLEND_COLOR_MASK,t)}get handle(){return this.h}reset(){this.assignProperties(!1,ro.ONE,ro.ZERO,oo.ADD,ro.ONE,ro.ZERO,oo.ADD,ao.ALL)}destroy(){_r.free(this.h),this.h=0}assign(t){t&&this.assignProperties(t.blend,t.blendSrc,t.blendDst,t.blendEq,t.blendSrcAlpha,t.blendDstAlpha,t.blendAlphaEq,t.blendColorMask)}assignProperties(t,e,i,n,s,r,o,a){void 0!==t&&(this.blend=t),void 0!==e&&(this.blendSrc=e),void 0!==i&&(this.blendDst=i),void 0!==n&&(this.blendEq=n),void 0!==s&&(this.blendSrcAlpha=s),void 0!==r&&(this.blendDstAlpha=r),void 0!==o&&(this.blendAlphaEq=o),void 0!==a&&(this.blendColorMask=a)}}class La{constructor(t=!1,e=!1,i=new Lo,n=[new Na]){this.h=void 0,this.hBt=void 0,this.targets=void 0,this._blendColor=void 0,this.h=dr.alloc(),this.targets=n,this.blendColor=i,this.isA2c=t,this.isIndepend=e,this.blendColor=i,this.hBt=Xn.alloc(),dr.set(this.h,ur.BLEND_TARGET,this.hBt);for(let t=0,e=n.length;t<e;++t)Xn.push(this.hBt,n[t].handle)}get isA2c(){return!!dr.get(this.h,ur.IS_A2C)}set isA2c(t){dr.set(this.h,ur.IS_A2C,t?1:0)}get isIndepend(){return!!dr.get(this.h,ur.IS_INDEPEND)}set isIndepend(t){dr.set(this.h,ur.IS_INDEPEND,t?1:0)}get blendColor(){return this._blendColor}set blendColor(t){this._blendColor=t,dr.setVec4(this.h,ur.BLEND_COLOR,t)}get handle(){return this.h}setTarget(t,e){let i=this.targets[t];i||(i=this.targets[t]=new Na,Xn.assign(this.hBt,t,i.handle)),i.assign(e)}reset(){this.isA2c=!1,this.isIndepend=!1,dr.setVec4(this.h,ur.BLEND_COLOR,new Lo(0,0,0,0));const t=this.targets;for(let e=1,i=t.length;e<i;++e)t[e].destroy();t.length=1,t[0].reset(),Xn.clear(this.hBt),Xn.push(this.hBt,t[0].handle)}destroy(){dr.free(this.h),this.h=0,Xn.free(this.hBt),this.hBt=0;for(let t=0,e=this.targets.length;t<e;++t)this.targets[t].destroy();this.targets=null}}const Fa=gfx.PipelineState,za=gfx.PipelineStateInfo;class Va extends xa{get layout(){return this._layout}constructor(t){super(Vr.DESCRIPTOR_SET),this._device=void 0,this._layout=null,this._buffers=[],this._textures=[],this._samplers=[],this._isDirty=!1,this._device=t}bindBuffer(t,e,i=0){const n=this._layout.bindingIndices[t],s=this._layout.bindings[n];if(s)if(s.descriptorType&Ca){const n=this._layout.descriptorIndices[t];this._buffers[n+i]!==e&&(this._buffers[n+i]=e,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.UNIFORM_BUFFER.")}bindSampler(t,e,i=0){const n=this._layout.bindingIndices[t],s=this._layout.bindings[n];if(s)if(s.descriptorType&ba){const n=this._layout.descriptorIndices[t];this._samplers[n+i]!==e&&(this._samplers[n+i]=e,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.SAMPLER.")}bindTexture(t,e,i=0){const n=this._layout.bindingIndices[t],s=this._layout.bindings[n];if(s)if(s.descriptorType&ba){const n=this._layout.descriptorIndices[t];this._textures[n+i]!==e&&(this._textures[n+i]=e,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.SAMPLER.")}getBuffer(t,e=0){const i=this._layout.descriptorIndices[t];return this._buffers[i+e]}getSampler(t,e=0){const i=this._layout.descriptorIndices[t];return this._samplers[i+e]}getTexture(t,e=0){const i=this._layout.descriptorIndices[t];return this._textures[i+e]}}class Ua extends xa{get usage(){return this._usage}get memUsage(){return this._memUsage}get size(){return this._size}get stride(){return this._stride}get count(){return this._count}get flags(){return this._flags}constructor(t){super(Vr.BUFFER),this._device=void 0,this._usage=Xr.NONE,this._memUsage=Jr.NONE,this._size=0,this._stride=1,this._count=0,this._flags=Yr.NONE,this._indirectBuffer=null,this._isBufferView=!1,this._device=t}}class Ga extends xa{get type(){return this._type}get queue(){return this._queue}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}constructor(t){super(Vr.COMMAND_BUFFER),this._device=void 0,this._queue=null,this._type=Ao.PRIMARY,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._device=t}}jt(jr);class Ha{constructor(){this._canvas=null,this._canvas2D=null,this._gfxAPI=Gr.UNKNOWN,this._transform=Hr.IDENTITY,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(kr.COUNT),this._queue=null,this._cmdBuff=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._colorFmt=jr.UNKNOWN,this._depthStencilFmt=jr.UNKNOWN,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new va,this._caps=new wo}get canvas(){return this._canvas}get canvas2D(){return this._canvas2D}get gfxAPI(){return this._gfxAPI}get queue(){return this._queue}get commandBuffer(){return this._cmdBuff}get devicePixelRatio(){return this._devicePixelRatio}get width(){return this._width}get height(){return this._height}get nativeWidth(){return this._nativeWidth}get nativeHeight(){return this._nativeHeight}get renderer(){return this._renderer}get vendor(){return this._vendor}get colorFormat(){return this._colorFmt}get depthStencilFormat(){return this._depthStencilFmt}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}get memoryStatus(){return this._memoryStatus}get capabilities(){return this._caps}get surfaceTransform(){return this._transform}hasFeature(t){return this._features[t]}}class ka extends xa{get renderPass(){return this._renderPass}get colorTextures(){return this._colorTextures}get depthStencilTexture(){return this._depthStencilTexture}constructor(t){super(Vr.FRAMEBUFFER),this._device=void 0,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._device=t}}const ja=String.prototype.charCodeAt;function Wa(t){return this[t]}function qa(t,e){let i=t.length,n=e^i,s=0;const r="string"==typeof t?ja:Wa;for(;i>=4;){let e=255&r.call(t,s)|(255&r.call(t,++s))<<8|(255&r.call(t,++s))<<16|(255&r.call(t,++s))<<24;e=1540483477*(65535&e)+((1540483477*(e>>>16)&65535)<<16),e^=e>>>24,e=1540483477*(65535&e)+((1540483477*(e>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^e,i-=4,++s}switch(i){case 3:n^=(255&r.call(t,s+2))<<16;case 2:n^=(255&r.call(t,s+1))<<8;case 1:n^=255&r.call(t,s),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)}return n^=n>>>13,n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16),n^=n>>>15,n>>>0}class Xa extends xa{get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get attributes(){return this._attributes}get attributesHash(){return this._attributesHash}get vertexCount(){return this._vertexCount}set vertexCount(t){this._vertexCount=t}get firstVertex(){return this._firstVertex}set firstVertex(t){this._firstVertex=t}get indexCount(){return this._indexCount}set indexCount(t){this._indexCount=t}get firstIndex(){return this._firstIndex}set firstIndex(t){this._firstIndex=t}get vertexOffset(){return this._vertexOffset}set vertexOffset(t){this._vertexOffset=t}get instanceCount(){return this._instanceCount}set instanceCount(t){this._instanceCount=t}get firstInstance(){return this._firstInstance}set firstInstance(t){this._firstInstance=t}get indirectBuffer(){return this._indirectBuffer}constructor(t){super(Vr.INPUT_ASSEMBLER),this._device=void 0,this._attributes=[],this._vertexBuffers=[],this._indexBuffer=null,this._vertexCount=0,this._firstVertex=0,this._indexCount=0,this._firstIndex=0,this._vertexOffset=0,this._instanceCount=0,this._firstInstance=0,this._attributesHash=0,this._indirectBuffer=null,this._device=t}getVertexBuffer(t=0){return t<this._vertexBuffers.length?this._vertexBuffers[t]:null}computeAttributesHash(){let t="attrs";for(let e=0;e<this.attributes.length;++e){const i=this.attributes[e];t+=`,${i.name},${i.format},${i.isNormalized},${i.stream},${i.isInstanced}`}return qa(t,666)}}class Ya extends xa{get bindings(){return this._bindings}get bindingIndices(){return this._bindingIndices}get descriptorIndices(){return this._descriptorIndices}constructor(t){super(Vr.DESCRIPTOR_SET_LAYOUT),this._device=void 0,this._bindings=[],this._bindingIndices=[],this._descriptorIndices=[],this._device=t}}class Ka extends xa{get setLayouts(){return this._setLayouts}constructor(t){super(Vr.PIPELINE_LAYOUT),this._device=void 0,this._setLayouts=[],this._device=t}}class Ja extends xa{get type(){return this._type}constructor(t){super(Vr.QUEUE),this._device=void 0,this._type=So.GRAPHICS,this._isAsync=!1,this._device=t}isAsync(){return this._isAsync}}class $a extends xa{get colorAttachments(){return this._colorInfos}get depthStencilAttachment(){return this._depthStencilInfo}get subPasses(){return this._subpasses}get hash(){return this._hash}constructor(t){super(Vr.RENDER_PASS),this._device=void 0,this._colorInfos=[],this._depthStencilInfo=null,this._subpasses=[],this._hash=0,this._device=t}computeHash(){let t="";if(this._subpasses.length)for(let e=0;e<this._subpasses.length;++e){const i=this._subpasses[e];if(i.inputs.length){t+="ia";for(let e=0;e<i.inputs.length;++e){const n=this._colorInfos[i.inputs[e]];t+=`,${n.format},${n.sampleCount}`}}if(i.colors.length){t+="ca";for(let e=0;e<i.inputs.length;++e){const n=this._colorInfos[i.inputs[e]];t+=`,${n.format},${n.sampleCount}`}}if(i.depthStencil>=0){const e=this._colorInfos[i.depthStencil];t+=`ds,${e.format},${e.sampleCount}`}}else{t+="ca";for(let e=0;e<this._colorInfos.length;++e){const i=this._colorInfos[e];t+=`,${i.format},${i.sampleCount}`}const e=this._depthStencilInfo;e&&(t+=`ds,${e.format},${e.sampleCount}`)}return qa(t,666)}}class Za extends xa{get minFilter(){return this._minFilter}get magFilter(){return this._magFilter}get mipFilter(){return this._mipFilter}get addressU(){return this._addressU}get addressV(){return this._addressV}get addressW(){return this._addressW}get maxAnisotropy(){return this._maxAnisotropy}get cmpFunc(){return this._cmpFunc}get borderColor(){return this._borderColor}get mipLODBias(){return this._mipLODBias}constructor(t){super(Vr.SAMPLER),this._device=void 0,this._minFilter=eo.LINEAR,this._magFilter=eo.LINEAR,this._mipFilter=eo.NONE,this._addressU=io.WRAP,this._addressV=io.WRAP,this._addressW=io.WRAP,this._maxAnisotropy=16,this._cmpFunc=no.NEVER,this._borderColor=new Lo,this._mipLODBias=0,this._device=t}}class Qa extends xa{get id(){return this._id}get name(){return this._name}get attributes(){return this._attributes}get blocks(){return this._blocks}get samplers(){return this._samplers}constructor(t){super(Vr.SHADER),this._device=void 0,this._id=void 0,this._name="",this._stages=[],this._attributes=[],this._blocks=[],this._samplers=[],this._device=t,this._id=Qa._shaderIdGen++}}Qa._shaderIdGen=0;class tl extends xa{get type(){return this._type}get usage(){return this._usage}get format(){return this._format}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get layerCount(){return this._layerCount}get levelCount(){return this._levelCount}get samples(){return this._samples}get flags(){return this._flags}get size(){return this._size}constructor(t){super(Vr.TEXTURE),this._device=void 0,this._type=$r.TEX2D,this._usage=Zr.NONE,this._format=jr.UNKNOWN,this._width=0,this._height=0,this._depth=1,this._layerCount=1,this._levelCount=1,this._samples=to.X1,this._flags=Qr.NONE,this._isPowerOf2=!1,this._size=0,this._device=t}}class el extends xa{constructor(t){super(Vr.GLOBAL_BARRIER),this._device=void 0,this._info=new la,this._device=t}initialize(t){return this._info.copy(t),!0}}class il extends xa{constructor(t){super(Vr.TEXTURE_BARRIER),this._device=void 0,this._info=new ca,this._device=t}initialize(t){return this._info.copy(t),!0}}const nl={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(const t in n.gfx){if("__esModule"===t)continue;let e=nl[t];""===e?e=t:void 0===e&&(e=`GFX${t}`),z(n,"cc",[{name:e,newName:t,target:n.gfx,targetName:"cc.gfx"}])}const sl=Object.assign({},Ma);sl.Device=gfx.Device,sl.Buffer=gfx.Buffer,sl.Texture=gfx.Texture,sl.Sampler=gfx.Sampler,sl.Shader=gfx.Shader,sl.InputAssembler=gfx.InputAssembler,sl.RenderPass=gfx.RenderPass,sl.Framebuffer=gfx.Framebuffer,sl.DescriptorSet=gfx.DescriptorSet,sl.DescriptorSetLayout=gfx.DescriptorSetLayout,sl.PipelineLayout=gfx.PipelineLayout,sl.PipelineState=gfx.PipelineState,sl.CommandBuffer=gfx.CommandBuffer,sl.Queue=gfx.Queue,n.gfx=sl;const rl=gfx.Attribute,ol=Na,al=La,ll=Ba,cl=Oa,hl=Fa,_l=za;let ul;sl.BlendTarget=Na,sl.BlendState=La,sl.RasterizerState=Ba,sl.DepthStencilState=Oa,sl.PipelineStateInfo=za,t("gfx",Object.freeze({__proto__:null,DescriptorSet:Va,Buffer:Ua,CommandBuffer:Ga,get ObjectType(){return Vr},get Status(){return Ur},get API(){return Gr},get SurfaceTransform(){return Hr},get Feature(){return kr},get Format(){return jr},get FormatType(){return Wr},get Type(){return qr},get BufferUsageBit(){return Xr},get BufferFlagBit(){return Yr},get MemoryAccessBit(){return Kr},get MemoryUsageBit(){return Jr},get TextureType(){return $r},get TextureUsageBit(){return Zr},get TextureFlagBit(){return Qr},get SampleCount(){return to},get Filter(){return eo},get Address(){return io},get ComparisonFunc(){return no},get StencilOp(){return so},get BlendFactor(){return ro},get BlendOp(){return oo},get ColorMask(){return ao},get ShaderStageFlagBit(){return lo},get LoadOp(){return co},get StoreOp(){return ho},get AccessType(){return _o},get PipelineBindPoint(){return uo},get PrimitiveMode(){return mo},get PolygonMode(){return po},get ShadeModel(){return fo},get CullMode(){return go},get DynamicStateFlagBit(){return yo},get StencilFace(){return vo},get DescriptorType(){return xo},get QueueType(){return So},get CommandBufferType(){return Ao},get ClearFlagBit(){return Co},Size:To,DeviceCaps:wo,Offset:Eo,Rect:Po,Extent:Io,TextureSubresLayers:Do,TextureSubresRange:Ro,TextureCopy:Mo,TextureBlit:Bo,BufferTextureCopy:Oo,Viewport:No,Color:Lo,BindingMappingInfo:Fo,BufferInfo:zo,BufferViewInfo:Vo,DrawInfo:Uo,DispatchInfo:Go,IndirectBuffer:Ho,TextureInfo:ko,TextureViewInfo:jo,SamplerInfo:Wo,Uniform:qo,UniformBlock:Xo,UniformSamplerTexture:Yo,UniformSampler:Ko,UniformTexture:Jo,UniformStorageImage:$o,UniformStorageBuffer:Zo,UniformInputAttachment:Qo,ShaderStage:ta,Attribute:rl,ShaderInfo:ia,InputAssemblerInfo:na,ColorAttachment:sa,DepthStencilAttachment:ra,SubpassInfo:oa,RenderPassInfo:aa,GlobalBarrierInfo:la,TextureBarrierInfo:ca,FramebufferInfo:ha,DescriptorSetLayoutBinding:_a,DescriptorSetLayoutInfo:ua,DescriptorSetInfo:ma,PipelineLayoutInfo:da,InputState:pa,CommandBufferInfo:fa,QueueInfo:ga,FormatInfo:ya,MemoryStatus:va,Obj:xa,DeviceInfo:Sa,get AttributeName(){return bo},FormatInfos:Aa,DESCRIPTOR_BUFFER_TYPE:Ca,DESCRIPTOR_SAMPLER_TYPE:ba,DESCRIPTOR_DYNAMIC_TYPE:Ta,DRAW_INFO_SIZE:28,IsPowerOf2:wa,FormatSize:Ea,FormatSurfaceSize:Pa,GetTypeSize:Da,getTypedArrayConstructor:Ra,Device:Ha,Framebuffer:ka,InputAssembler:Xa,DescriptorSetLayout:Ya,PipelineLayout:Ka,Queue:Ja,RenderPass:$a,Sampler:Za,Shader:Qa,Texture:tl,GlobalBarrier:el,TextureBarrier:il,BlendTarget:ol,BlendState:al,RasterizerState:ll,DepthStencilState:cl,PipelineState:hl,PipelineStateInfo:_l})),function(t){t[t.ALL=0]="ALL",t[t.CLOSEST=1]="CLOSEST",t[t.ANY=2]="ANY"}(ul||(ul={}));const ml=function(){const t=new oi(0,0,0);return function(e,i){const n=oi.dot(e.d,i.n);if(Math.abs(n)<Number.EPSILON)return 0;oi.multiplyScalar(t,i.n,i.d);const s=oi.dot(oi.subtract(t,t,e.o),i.n)/n;return s<0?0:s}}(),dl=function(){const t=new oi(0,0,0),e=new oi(0,0,0),i=new oi(0,0,0),n=new oi(0,0,0),s=new oi(0,0,0);return function(r,o,a){oi.subtract(t,o.b,o.a),oi.subtract(e,o.c,o.a),oi.cross(i,r.d,e);const l=oi.dot(t,i);if(l<Number.EPSILON&&(!a||l>-Number.EPSILON))return 0;const c=1/l;oi.subtract(n,r.o,o.a);const h=oi.dot(n,i)*c;if(h<0||h>1)return 0;oi.cross(s,n,t);const _=oi.dot(r.d,s)*c;if(_<0||h+_>1)return 0;const u=oi.dot(e,s)*c;return u<0?0:u}}(),pl=function(){const t=new oi(0,0,0);return function(e,i){const n=i.radius,s=i.center,r=e.o,o=e.d,a=n*n;oi.subtract(t,s,r);const l=t.lengthSqr(),c=oi.dot(t,o),h=a-(l-c*c);if(h<0)return 0;const _=Math.sqrt(h),u=l<a?c+_:c-_;return u<0?0:u}}(),fl=function(){const t=new oi,e=new oi;return function(i,n){return oi.subtract(t,n.center,n.halfExtents),oi.add(e,n.center,n.halfExtents),gl(i,t,e)}}();function gl(t,e,i){const n=t.o,s=t.d,r=1/s.x,o=1/s.y,a=1/s.z,l=(e.x-n.x)*r,c=(i.x-n.x)*r,h=(e.y-n.y)*o,_=(i.y-n.y)*o,u=(e.z-n.z)*a,m=(i.z-n.z)*a,d=Math.max(Math.max(Math.min(l,c),Math.min(h,_)),Math.min(u,m)),p=Math.min(Math.min(Math.max(l,c),Math.max(h,_)),Math.max(u,m));return p<0||d>p?0:d>0?d:p}const yl=function(){let t=new oi,e=new oi,i=new oi;const n=new oi,s=new oi,r=new oi,o=new oi,a=new Array(3),l=new Array(3),c=new Array(3),h=new Array(6);return function(_,u){a[0]=u.halfExtents.x,a[1]=u.halfExtents.y,a[2]=u.halfExtents.z,t=u.center,e=_.o,i=_.d,oi.set(n,u.orientation.m00,u.orientation.m01,u.orientation.m02),oi.set(s,u.orientation.m03,u.orientation.m04,u.orientation.m05),oi.set(r,u.orientation.m06,u.orientation.m07,u.orientation.m08),oi.subtract(o,t,e),l[0]=oi.dot(n,i),l[1]=oi.dot(s,i),l[2]=oi.dot(r,i),c[0]=oi.dot(n,o),c[1]=oi.dot(s,o),c[2]=oi.dot(r,o);for(let t=0;t<3;++t){if(0===l[t]){if(-c[t]-a[t]>0||-c[t]+a[t]<0)return 0;l[t]=1e-7}h[2*t+0]=(c[t]+a[t])/l[t],h[2*t+1]=(c[t]-a[t])/l[t]}const m=Math.max(Math.max(Math.min(h[0],h[1]),Math.min(h[2],h[3])),Math.min(h[4],h[5])),d=Math.min(Math.min(Math.max(h[0],h[1]),Math.max(h[2],h[3])),Math.max(h[4],h[5]));return d<0||m>d?0:m>0?m:d}}(),vl=function(){const t=new oi,e=new oi,i=new oi,n=new oi,s=new oi,r=new oi,o=new oi,a=new Lr;return function(l,c){const h=c.radius*c.radius,_=oi.normalize(t,l.d),u=c.ellipseCenter0,m=c.ellipseCenter1,d=oi.subtract(e,m,u);if(d.equals(oi.ZERO))return a.radius=c.radius,a.center.set(c.ellipseCenter0),Jl.raySphere(l,a);const p=l.o,f=oi.subtract(i,p,u),g=oi.cross(n,_,d),y=g.lengthSqr();if(0===y){a.radius=c.radius;const t=oi.subtract(s,m,p);return f.lengthSqr()<t.lengthSqr()?a.center.set(c.ellipseCenter0):a.center.set(c.ellipseCenter1),Jl.raySphere(l,a)}const v=oi.cross(s,f,d),x=d.lengthSqr(),S=2*oi.dot(g,v),A=S*S-4*y*(v.lengthSqr()-h*x);if(A<0)return 0;const C=(-S-Math.sqrt(A))/(2*y);if(C<0){a.radius=c.radius;const t=oi.subtract(r,m,p);return f.lengthSqr()<t.lengthSqr()?a.center.set(c.ellipseCenter0):a.center.set(c.ellipseCenter1),Jl.raySphere(l,a)}{const t=oi.scaleAndAdd(r,l.o,_,C),e=oi.subtract(o,t,u),i=oi.dot(e,d)/x;return i>=0&&i<=1?C:i<0?(a.radius=c.radius,a.center.set(c.ellipseCenter0),Jl.raySphere(l,a)):i>1?(a.radius=c.radius,a.center.set(c.ellipseCenter1),Jl.raySphere(l,a)):0}}}(),xl=function(){const t=Fr.create(),e={distance:1/0,doubleSided:!1,mode:ul.ANY};let i=0;const n=(t,e,n,s,r,o)=>{t===ul.CLOSEST?(i>e||0===i)&&(i=e,o&&(0===o.length?o.push({distance:e,vertexIndex0:n/3,vertexIndex1:s/3,vertexIndex2:r/3}):(o[0].distance=e,o[0].vertexIndex0=n/3,o[0].vertexIndex1=s/3,o[0].vertexIndex2=r/3))):(i=e,o&&o.push({distance:e,vertexIndex0:n/3,vertexIndex1:s/3,vertexIndex2:r/3}))};return function(s,r,o){if(i=0,0===r.geometricInfo.positions.length)return i;const a=void 0===o?e:o;if(gl(s,r.geometricInfo.boundingBox.min,r.geometricInfo.boundingBox.max)){const e=r.primitiveMode,{positions:i,indices:o}=r.geometricInfo;((e,i,s,r,o)=>{if(s===mo.TRIANGLE_LIST){const s=i.length;for(let a=0;a<s;a+=3){const s=3*i[a],l=3*i[a+1],c=3*i[a+2];oi.set(t.a,e[s],e[s+1],e[s+2]),oi.set(t.b,e[l],e[l+1],e[l+2]),oi.set(t.c,e[c],e[c+1],e[c+2]);const h=Jl.rayTriangle(r,t,o.doubleSided);if(!(0===h||h>o.distance)&&(n(o.mode,h,s,l,c,o.result),o.mode===ul.ANY))return h}}else if(s===mo.TRIANGLE_STRIP){const s=i.length-2;let a=0;for(let l=0;l<s;l+=1){const s=3*i[l-a],c=3*i[l+a+1],h=3*i[l+2];oi.set(t.a,e[s],e[s+1],e[s+2]),oi.set(t.b,e[c],e[c+1],e[c+2]),oi.set(t.c,e[h],e[h+1],e[h+2]),a=~a;const _=Jl.rayTriangle(r,t,o.doubleSided);if(!(0===_||_>o.distance)&&(n(o.mode,_,s,c,h,o.result),o.mode===ul.ANY))return _}}else if(s===mo.TRIANGLE_FAN){const s=i.length-1,a=3*i[0];oi.set(t.a,e[a],e[a+1],e[a+2]);for(let l=1;l<s;l+=1){const s=3*i[l],c=3*i[l+1];oi.set(t.b,e[s],e[s+1],e[s+2]),oi.set(t.c,e[c],e[c+1],e[c+2]);const h=Jl.rayTriangle(r,t,o.doubleSided);if(!(0===h||h>o.distance)&&(n(o.mode,h,a,s,c,o.result),o.mode===ul.ANY))return h}}})(i,o,e,s,a)}return i}}(),Sl=function(){let t=0;const e={distance:1/0,doubleSided:!1,mode:ul.ANY};return function(i,n,s){t=0;const r=void 0===s?e:s,o=n.renderingSubMeshes.length,a=n.struct.minPosition,l=n.struct.maxPosition;if(a&&l&&!gl(i,a,l))return t;for(let e=0;e<o;e++){const s=n.renderingSubMeshes[e],o=xl(i,s,r);if(o)if(r.mode===ul.CLOSEST)(0===t||t>o)&&(t=o,r.subIndices&&(r.subIndices[0]=e));else if(t=o,r.subIndices&&r.subIndices.push(e),r.mode===ul.ANY)return o}return t&&r.mode===ul.CLOSEST&&(r.result&&(r.result[0].distance=t,r.result.length=1),r.subIndices&&(r.subIndices.length=1)),t}}(),Al=function(){let t=0;const e={distance:1/0,doubleSided:!1,mode:ul.ANY},i=new Dr,n=new Si;return function(s,r,o){t=0;const a=void 0===o?e:o,l=r.worldBounds;if(l&&!fl(s,l))return t;Dr.copy(i,s),r.node&&(Si.invert(n,r.node.getWorldMatrix(n)),oi.transformMat4(i.o,s.o,n),oi.transformMat4Normal(i.d,s.d,n));const c=r.subModels;for(let e=0;e<c.length;e++){const n=c[e].subMesh,s=xl(i,n,a);if(s)if(a.mode===ul.CLOSEST)(0===t||t>s)&&(t=s,a.subIndices&&(a.subIndices[0]=e));else if(t=s,a.subIndices&&a.subIndices.push(e),a.mode===ul.ANY)return s}return t&&a.mode===ul.CLOSEST&&(a.result&&(a.result[0].distance=t,a.result.length=1),a.subIndices&&(a.subIndices.length=1)),t}}(),Cl=function(){const t=new oi(0,0,0);return function(e,i){oi.subtract(t,e.e,e.s);const n=(i.d-oi.dot(e.s,i.n))/oi.dot(t,i.n);return n<0||n>1?0:n}}(),bl=function(){const t=new oi(0,0,0),e=new oi(0,0,0),i=new oi(0,0,0),n=new oi(0,0,0),s=new oi(0,0,0),r=new oi(0,0,0);return function(o,a,l){oi.subtract(t,a.b,a.a),oi.subtract(e,a.c,a.a),oi.subtract(i,o.s,o.e),oi.cross(s,t,e);const c=oi.dot(i,s);if(c<=0)return 0;oi.subtract(n,o.s,a.a);const h=oi.dot(n,s);if(h<0||h>c)return 0;oi.cross(r,i,n);let _=oi.dot(e,r);if(_<0||_>c)return 0;let u=-oi.dot(t,r);if(u<0||_+u>c)return 0;if(l){const t=1/c;_*=t,u*=t;const e=1-_-u;oi.set(l,a.a.x*e+a.b.x*_+a.c.x*u,a.a.y*e+a.b.y*_+a.c.y*u,a.a.z*e+a.b.z*_+a.c.z*u)}return 1}}(),Tl=new Dr;function wl(t,e){Tl.o.set(t.s),oi.subtract(Tl.d,t.e,t.s),Tl.d.normalize();const i=fl(Tl,e);return i<=t.length()?i:0}function El(t,e){Tl.o.set(t.s),oi.subtract(Tl.d,t.e,t.s),Tl.d.normalize();const i=yl(Tl,e);return i<=t.length()?i:0}function Pl(t,e){Tl.o.set(t.s),oi.subtract(Tl.d,t.e,t.s),Tl.d.normalize();const i=pl(Tl,e);return i<=t.length()?i:0}const Il=function(){const t=new oi,e=new oi,i=new oi,n=new oi;return function(s,r){return oi.subtract(t,s.center,s.halfExtents),oi.add(e,s.center,s.halfExtents),oi.subtract(i,r.center,r.halfExtents),oi.add(n,r.center,r.halfExtents),t.x<=n.x&&e.x>=i.x&&t.y<=n.y&&e.y>=i.y&&t.z<=n.z&&e.z>=i.z}}();function Dl(t,e,i,n,s,r){oi.set(r[0],t.x+i.x*e.x+n.x*e.y+s.x*e.z,t.y+i.y*e.x+n.y*e.y+s.y*e.z,t.z+i.z*e.x+n.z*e.y+s.z*e.z),oi.set(r[1],t.x-i.x*e.x+n.x*e.y+s.x*e.z,t.y-i.y*e.x+n.y*e.y+s.y*e.z,t.z-i.z*e.x+n.z*e.y+s.z*e.z),oi.set(r[2],t.x+i.x*e.x-n.x*e.y+s.x*e.z,t.y+i.y*e.x-n.y*e.y+s.y*e.z,t.z+i.z*e.x-n.z*e.y+s.z*e.z),oi.set(r[3],t.x+i.x*e.x+n.x*e.y-s.x*e.z,t.y+i.y*e.x+n.y*e.y-s.y*e.z,t.z+i.z*e.x+n.z*e.y-s.z*e.z),oi.set(r[4],t.x-i.x*e.x-n.x*e.y-s.x*e.z,t.y-i.y*e.x-n.y*e.y-s.y*e.z,t.z-i.z*e.x-n.z*e.y-s.z*e.z),oi.set(r[5],t.x+i.x*e.x-n.x*e.y-s.x*e.z,t.y+i.y*e.x-n.y*e.y-s.y*e.z,t.z+i.z*e.x-n.z*e.y-s.z*e.z),oi.set(r[6],t.x-i.x*e.x+n.x*e.y-s.x*e.z,t.y-i.y*e.x+n.y*e.y-s.y*e.z,t.z-i.z*e.x+n.z*e.y-s.z*e.z),oi.set(r[7],t.x-i.x*e.x-n.x*e.y+s.x*e.z,t.y-i.y*e.x-n.y*e.y+s.y*e.z,t.z-i.z*e.x-n.z*e.y+s.z*e.z)}function Rl(t,e){let i=oi.dot(e,t[0]),n=i;for(let s=1;s<8;++s){const r=oi.dot(e,t[s]);i=r<i?r:i,n=r>n?r:n}return[i,n]}const Ml=function(){const t=new Array(15);for(let e=0;e<15;e++)t[e]=new oi(0,0,0);const e=new Array(8),i=new Array(8);for(let t=0;t<8;t++)e[t]=new oi(0,0,0),i[t]=new oi(0,0,0);const n=new oi,s=new oi;return function(r,o){oi.set(t[0],1,0,0),oi.set(t[1],0,1,0),oi.set(t[2],0,0,1),oi.set(t[3],o.orientation.m00,o.orientation.m01,o.orientation.m02),oi.set(t[4],o.orientation.m03,o.orientation.m04,o.orientation.m05),oi.set(t[5],o.orientation.m06,o.orientation.m07,o.orientation.m08);for(let e=0;e<3;++e)oi.cross(t[6+3*e],t[e],t[0]),oi.cross(t[7+3*e],t[e],t[1]),oi.cross(t[7+3*e],t[e],t[2]);oi.subtract(n,r.center,r.halfExtents),oi.add(s,r.center,r.halfExtents),function(t,e,i){oi.set(i[0],t.x,e.y,e.z),oi.set(i[1],t.x,e.y,t.z),oi.set(i[2],t.x,t.y,e.z),oi.set(i[3],t.x,t.y,t.z),oi.set(i[4],e.x,e.y,e.z),oi.set(i[5],e.x,e.y,t.z),oi.set(i[6],e.x,t.y,e.z),oi.set(i[7],e.x,t.y,t.z)}(n,s,e),Dl(o.center,o.halfExtents,t[3],t[4],t[5],i);for(let n=0;n<15;++n){const s=Rl(e,t[n]),r=Rl(i,t[n]);if(r[0]>s[1]||s[0]>r[1])return 0}return 1}}(),Bl=function(t,e){const i=t.halfExtents.x*Math.abs(e.n.x)+t.halfExtents.y*Math.abs(e.n.y)+t.halfExtents.z*Math.abs(e.n.z),n=oi.dot(e.n,t.center);return n+i<e.d?-1:n-i>e.d?0:1},Ol=function(t,e){for(let i=0;i<e.planes.length;i++)if(-1===Bl(t,e.planes[i]))return 0;return 1},Nl=function(){const t=new Array(8);let e=0,i=0;for(let e=0;e<t.length;e++)t[e]=new oi(0,0,0);return function(n,s){let r=0,o=!1;for(let t=0;t<s.planes.length;t++){if(r=Bl(n,s.planes[t]),-1===r)return 0;1===r&&(o=!0)}if(!o)return 1;for(let e=0;e<s.vertices.length;e++)oi.subtract(t[e],s.vertices[e],n.center);e=0,i=0;for(let r=0;r<s.vertices.length;r++)t[r].x>n.halfExtents.x?e++:t[r].x<-n.halfExtents.x&&i++;if(e===s.vertices.length||i===s.vertices.length)return 0;e=0,i=0;for(let r=0;r<s.vertices.length;r++)t[r].y>n.halfExtents.y?e++:t[r].y<-n.halfExtents.y&&i++;if(e===s.vertices.length||i===s.vertices.length)return 0;e=0,i=0;for(let r=0;r<s.vertices.length;r++)t[r].z>n.halfExtents.z?e++:t[r].z<-n.halfExtents.z&&i++;return e===s.vertices.length||i===s.vertices.length?0:1}}(),Ll=function(){const t=new oi(0,0,0),e=new hi;return function(i,n){return oi.subtract(t,n,i.center),oi.transformMat3(t,t,hi.transpose(e,i.orientation)),s=t,r=i.halfExtents,Math.abs(s.x)<r.x&&Math.abs(s.y)<r.y&&Math.abs(s.z)<r.z;var s,r}}(),Fl=function(){const t=function(t,e,i,n){return Math.abs(t.x*e+t.y*i+t.z*n)};return function(e,i){const n=e.halfExtents.x*t(i.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*t(i.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*t(i.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),s=oi.dot(i.n,e.center);return s+n<i.d?-1:s-n>i.d?0:1}}(),zl=function(t,e){for(let i=0;i<e.planes.length;i++)if(-1===Fl(t,e.planes[i]))return 0;return 1},Vl=function(){const t=new Array(8);let e=0,i=0,n=0;for(let e=0;e<t.length;e++)t[e]=new oi(0,0,0);const s=function(t,e,i,n){return t.x*e+t.y*i+t.z*n};return function(r,o){let a=0,l=!1;for(let t=0;t<o.planes.length;t++){if(a=Fl(r,o.planes[t]),-1===a)return 0;1===a&&(l=!0)}if(!l)return 1;for(let e=0;e<o.vertices.length;e++)oi.subtract(t[e],o.vertices[e],r.center);i=0,n=0;for(let a=0;a<o.vertices.length;a++)e=s(t[a],r.orientation.m00,r.orientation.m01,r.orientation.m02),e>r.halfExtents.x?i++:e<-r.halfExtents.x&&n++;if(i===o.vertices.length||n===o.vertices.length)return 0;i=0,n=0;for(let a=0;a<o.vertices.length;a++)e=s(t[a],r.orientation.m03,r.orientation.m04,r.orientation.m05),e>r.halfExtents.y?i++:e<-r.halfExtents.y&&n++;if(i===o.vertices.length||n===o.vertices.length)return 0;i=0,n=0;for(let a=0;a<o.vertices.length;a++)e=s(t[a],r.orientation.m06,r.orientation.m07,r.orientation.m08),e>r.halfExtents.z?i++:e<-r.halfExtents.z&&n++;return i===o.vertices.length||n===o.vertices.length?0:1}}(),Ul=function(){const t=new Array(15);for(let e=0;e<15;e++)t[e]=new oi(0,0,0);const e=new Array(8),i=new Array(8);for(let t=0;t<8;t++)e[t]=new oi(0,0,0),i[t]=new oi(0,0,0);return function(n,s){oi.set(t[0],n.orientation.m00,n.orientation.m01,n.orientation.m02),oi.set(t[1],n.orientation.m03,n.orientation.m04,n.orientation.m05),oi.set(t[2],n.orientation.m06,n.orientation.m07,n.orientation.m08),oi.set(t[3],s.orientation.m00,s.orientation.m01,s.orientation.m02),oi.set(t[4],s.orientation.m03,s.orientation.m04,s.orientation.m05),oi.set(t[5],s.orientation.m06,s.orientation.m07,s.orientation.m08);for(let e=0;e<3;++e)oi.cross(t[6+3*e],t[e],t[0]),oi.cross(t[7+3*e],t[e],t[1]),oi.cross(t[7+3*e],t[e],t[2]);Dl(n.center,n.halfExtents,t[0],t[1],t[2],e),Dl(s.center,s.halfExtents,t[3],t[4],t[5],i);for(let n=0;n<15;++n){const s=Rl(e,t[n]),r=Rl(i,t[n]);if(r[0]>s[1]||s[0]>r[1])return 0}return 1}}(),Gl=function(){const t=new Lr,e=new oi,i=new oi,n=new oi,s=new Array(8);for(let t=0;t<8;t++)s[t]=new oi;const r=new Array(8);for(let t=0;t<8;t++)r[t]=new oi;return function(o,a){if(0===oi.squaredDistance(a.ellipseCenter0,a.ellipseCenter1))return t.radius=a.radius,t.center.set(a.ellipseCenter0),Jl.sphereOBB(t,o);{e.x=o.orientation.m00,e.y=o.orientation.m01,e.z=o.orientation.m02,i.x=o.orientation.m03,i.y=o.orientation.m04,i.z=o.orientation.m05,n.x=o.orientation.m06,n.y=o.orientation.m07,n.z=o.orientation.m08,Dl(o.center,o.halfExtents,e,i,n,s);const t=r,l=oi.copy(t[0],e),c=oi.copy(t[1],i),h=oi.copy(t[2],n);oi.subtract(t[3],a.center,o.center).normalize();const _=oi.subtract(t[4],a.ellipseCenter0,a.ellipseCenter1);_.normalize(),oi.cross(t[5],l,_),oi.cross(t[6],c,_),oi.cross(t[7],h,_);for(let e=0;e<8;++e){const i=Rl(s,t[e]),n=oi.dot(t[e],a.ellipseCenter0),r=oi.dot(t[e],a.ellipseCenter1),o=Math.max(n,r),l=Math.min(n,r)-a.radius,c=o+a.radius;if(l>i[1]||i[0]>c)return 0}return 1}}}(),Hl=function(t,e){const i=oi.dot(e.n,t.center),n=t.radius*e.n.length();return i+n<e.d?-1:i-n>e.d?0:1},kl=function(t,e){for(let i=0;i<e.planes.length;i++)if(-1===Hl(t,e.planes[i]))return 0;return 1},jl=function(){const t=new oi(0,0,0),e=[1,-1,1,-1,1,-1];return function(i,n){for(let s=0;s<6;s++){const r=n.planes[s],o=i.radius,a=i.center,l=r.n,c=r.d,h=oi.dot(l,a);if(h+o<c)return 0;if(!(h-o>c)){oi.add(t,a,oi.multiplyScalar(t,l,o));for(let i=0;i<6;i++){if(i===s||i===s+e[s])continue;const r=n.planes[i];if(oi.dot(r.n,t)<r.d)return 0}}}return 1}}(),Wl=function(t,e){const i=t.radius+e.radius;return oi.squaredDistance(t.center,e.center)<i*i},ql=function(){const t=new oi;return function(e,i){return Tr(t,e.center,i),oi.squaredDistance(e.center,t)<e.radius*e.radius}}(),Xl=function(){const t=new oi;return function(e,i){return wr(t,e.center,i),oi.squaredDistance(e.center,t)<e.radius*e.radius}}(),Yl=function(){const t=new oi,e=new oi;return function(i,n){const s=i.radius+n.radius,r=s*s,o=oi.squaredDistance(n.ellipseCenter0,n.ellipseCenter1);if(0===o)return oi.squaredDistance(i.center,n.center)<r;{oi.subtract(t,i.center,n.ellipseCenter0),oi.subtract(e,n.ellipseCenter1,n.ellipseCenter0);const s=oi.dot(t,e)/o;return s<0?oi.squaredDistance(i.center,n.ellipseCenter0)<r:s>1?oi.squaredDistance(i.center,n.ellipseCenter1)<r:(oi.scaleAndAdd(t,n.ellipseCenter0,e,s),oi.squaredDistance(i.center,t)<r)}}}(),Kl=function(){const t=new oi,e=new oi,i=new oi,n=new oi,s=new oi,r=new oi;return function(o,a){const l=oi.subtract(t,o.ellipseCenter1,o.ellipseCenter0),c=oi.subtract(e,a.ellipseCenter1,a.ellipseCenter0),h=oi.subtract(i,o.ellipseCenter0,a.ellipseCenter0),_=oi.dot(l,l),u=oi.dot(l,c),m=oi.dot(c,c),d=oi.dot(l,h),p=oi.dot(c,h),f=_*m-u*u;let g,y,v,x,S=f,A=f;f<Fe?(y=0,S=1,x=p,A=m):(y=u*p-m*d,x=_*p-u*d,y<0?(y=0,x=p,A=m):y>S&&(y=S,x=p+u,A=m)),x<0?(x=0,-d<0?y=0:-d>_?y=S:(y=-d,S=_)):x>A&&(x=A,-d+u<0?y=0:-d+u>_?y=S:(y=-d+u,S=_)),g=Math.abs(y)<Fe?0:y/S,v=Math.abs(x)<Fe?0:x/A;const C=n;C.set(h),C.add(oi.multiplyScalar(s,l,g)),C.subtract(oi.multiplyScalar(r,c,v));const b=o.radius+a.radius;return C.lengthSqr()<b*b}}(),Jl={raySphere:pl,rayAABB:fl,rayOBB:yl,rayPlane:ml,rayTriangle:dl,rayCapsule:vl,raySubMesh:xl,rayMesh:Sl,rayModel:Al,lineSphere:Pl,lineAABB:wl,lineOBB:El,linePlane:Cl,lineTriangle:bl,sphereWithSphere:Wl,sphereAABB:ql,sphereOBB:Xl,spherePlane:Hl,sphereFrustum:kl,sphereFrustumAccurate:jl,sphereCapsule:Yl,aabbWithAABB:Il,aabbWithOBB:Ml,aabbPlane:Bl,aabbFrustum:Ol,aabbFrustumAccurate:Nl,obbWithOBB:Ul,obbPlane:Fl,obbFrustum:zl,obbFrustumAccurate:Vl,obbPoint:Ll,obbCapsule:Gl,capsuleWithCapsule:Kl,resolve(t,e,i=null){const n=t._type,s=e._type,r=this[n|s];return n<s?r(t,e,i):r(e,t,i)}};Jl[Pr.SHAPE_RAY|Pr.SHAPE_SPHERE]=pl,Jl[Pr.SHAPE_RAY|Pr.SHAPE_AABB]=fl,Jl[Pr.SHAPE_RAY|Pr.SHAPE_OBB]=yl,Jl[Pr.SHAPE_RAY|Pr.SHAPE_PLANE]=ml,Jl[Pr.SHAPE_RAY|Pr.SHAPE_TRIANGLE]=dl,Jl[Pr.SHAPE_RAY|Pr.SHAPE_CAPSULE]=vl,Jl[Pr.SHAPE_LINE|Pr.SHAPE_SPHERE]=Pl,Jl[Pr.SHAPE_LINE|Pr.SHAPE_AABB]=wl,Jl[Pr.SHAPE_LINE|Pr.SHAPE_OBB]=El,Jl[Pr.SHAPE_LINE|Pr.SHAPE_PLANE]=Cl,Jl[Pr.SHAPE_LINE|Pr.SHAPE_TRIANGLE]=bl,Jl[Pr.SHAPE_SPHERE]=Wl,Jl[Pr.SHAPE_SPHERE|Pr.SHAPE_AABB]=ql,Jl[Pr.SHAPE_SPHERE|Pr.SHAPE_OBB]=Xl,Jl[Pr.SHAPE_SPHERE|Pr.SHAPE_PLANE]=Hl,Jl[Pr.SHAPE_SPHERE|Pr.SHAPE_FRUSTUM]=kl,Jl[Pr.SHAPE_SPHERE|Pr.SHAPE_FRUSTUM_ACCURATE]=jl,Jl[Pr.SHAPE_SPHERE|Pr.SHAPE_CAPSULE]=Yl,Jl[Pr.SHAPE_AABB]=Il,Jl[Pr.SHAPE_AABB|Pr.SHAPE_OBB]=Ml,Jl[Pr.SHAPE_AABB|Pr.SHAPE_PLANE]=Bl,Jl[Pr.SHAPE_AABB|Pr.SHAPE_FRUSTUM]=Ol,Jl[Pr.SHAPE_AABB|Pr.SHAPE_FRUSTUM_ACCURATE]=Nl,Jl[Pr.SHAPE_OBB]=Ul,Jl[Pr.SHAPE_OBB|Pr.SHAPE_PLANE]=Fl,Jl[Pr.SHAPE_OBB|Pr.SHAPE_FRUSTUM]=zl,Jl[Pr.SHAPE_OBB|Pr.SHAPE_FRUSTUM_ACCURATE]=Vl,Jl[Pr.SHAPE_OBB|Pr.SHAPE_CAPSULE]=Gl,Jl[Pr.SHAPE_CAPSULE]=Kl,z(Ir.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),V(Jl,"intersect",[{name:"line_quad"}]);const $l=new oi(0,0,0),Zl=new oi(0,0,0),Ql=n.mat4(),tc=n.v4();class ec{static create(t,e,i,n){return new ec(t,e,i,n)}static clone(t){return new ec(t.n.x,t.n.y,t.n.z,t.d)}static copy(t,e){return oi.copy(t.n,e.n),t.d=e.d,t}static fromPoints(t,e,i,n){return oi.subtract($l,i,e),oi.subtract(Zl,n,e),oi.normalize(t.n,oi.cross(t.n,$l,Zl)),t.d=oi.dot(t.n,e),t}static set(t,e,i,n,s){return t.n.x=e,t.n.y=i,t.n.z=n,t.d=s,t}static fromNormalAndPoint(t,e,i){return oi.copy(t.n,e),t.d=oi.dot(e,i),t}static normalize(t,e){const i=e.n.length();return oi.normalize(t.n,e.n),i>0&&(t.d=e.d/i),t}get type(){return this._type}set x(t){this.n.x=t}get x(){return this.n.x}set y(t){this.n.y=t}get y(){return this.n.y}set z(t){this.n.z=t}get z(){return this.n.z}set w(t){this.d=t}get w(){return this.d}constructor(t=0,e=1,i=0,n=0){this.n=void 0,this.d=void 0,this._type=void 0,this._type=Pr.SHAPE_PLANE,this.n=new oi(t,e,i),this.d=n}transform(t){Si.invert(Ql,t),Si.transpose(Ql,Ql),Ii.set(tc,this.n.x,this.n.y,this.n.z,this.d),Ii.transformMat4(tc,tc,Ql),oi.set(this.n,tc.x,tc.y,tc.z),this.d=tc.w}}const ic=new oi,nc=new oi,sc=new oi,rc=new oi,oc=new hi,ac=(t,e,i)=>{oc.m00=Math.abs(i.m00),oc.m01=Math.abs(i.m01),oc.m02=Math.abs(i.m02),oc.m03=Math.abs(i.m04),oc.m04=Math.abs(i.m05),oc.m05=Math.abs(i.m06),oc.m06=Math.abs(i.m08),oc.m07=Math.abs(i.m09),oc.m08=Math.abs(i.m10),oi.transformMat3(t,e,oc)};class lc{static create(t,e,i,n,s,r){return new lc(t,e,i,n,s,r)}static clone(t){return new lc(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)}static copy(t,e){return oi.copy(t.center,e.center),oi.copy(t.halfExtents,e.halfExtents),t}static fromPoints(t,e,i){return oi.add(ic,i,e),oi.subtract(nc,i,e),oi.multiplyScalar(t.center,ic,.5),oi.multiplyScalar(t.halfExtents,nc,.5),t}static set(t,e,i,n,s,r,o){return oi.set(t.center,e,i,n),oi.set(t.halfExtents,s,r,o),t}static merge(t,e,i){return oi.subtract(ic,e.center,e.halfExtents),oi.subtract(nc,i.center,i.halfExtents),oi.add(sc,e.center,e.halfExtents),oi.add(rc,i.center,i.halfExtents),oi.max(rc,sc,rc),oi.min(sc,ic,nc),lc.fromPoints(t,sc,rc)}static toBoundingSphere(t,e){e.getBoundary(ic,nc),t.center.set(ic),t.radius=0,oi.subtract(sc,nc,t.center);const i=sc.length(),n=.5*i;return t.radius+=n,oi.multiplyScalar(sc,sc,n/i),oi.add(t.center,t.center,sc),t}static transform(t,e,i){return oi.transformMat4(t.center,e.center,i),ac(t.halfExtents,e.halfExtents,i),t}get type(){return this._type}constructor(t=0,e=0,i=0,n=1,s=1,r=1){this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._type=Pr.SHAPE_AABB,this.center=new oi(t,e,i),this.halfExtents=new oi(n,s,r)}getBoundary(t,e){oi.subtract(t,this.center,this.halfExtents),oi.add(e,this.center,this.halfExtents)}transform(t,e,i,n,s){oi.transformMat4(s.center,this.center,t),ac(s.halfExtents,this.halfExtents,t)}clone(){return lc.clone(this)}copy(t){return lc.copy(this,t)}}const cc=new oi,hc=new oi,_c=new hi;class uc{static create(t,e,i,n,s,r,o,a,l,c,h,_,u,m,d){return new uc(t,e,i,n,s,r,o,a,l,c,h,_,u,m,d)}static clone(t){return new uc(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)}static copy(t,e){return oi.copy(t.center,e.center),oi.copy(t.halfExtents,e.halfExtents),hi.copy(t.orientation,e.orientation),t}static fromPoints(t,e,i){return oi.multiplyScalar(t.center,oi.add(cc,e,i),.5),oi.multiplyScalar(t.halfExtents,oi.subtract(hc,i,e),.5),hi.identity(t.orientation),t}static set(t,e,i,n,s,r,o,a,l,c,h,_,u,m,d,p){return oi.set(t.center,e,i,n),oi.set(t.halfExtents,s,r,o),hi.set(t.orientation,a,l,c,h,_,u,m,d,p),t}get type(){return this._type}constructor(t=0,e=0,i=0,n=1,s=1,r=1,o=1,a=0,l=0,c=0,h=1,_=0,u=0,m=0,d=1){this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=Pr.SHAPE_OBB,this.center=new oi(t,e,i),this.halfExtents=new oi(n,s,r),this.orientation=new hi(o,a,l,c,h,_,u,m,d)}getBoundary(t,e){var i,n,s;i=cc,n=this.halfExtents,s=this.orientation,_c.m00=Math.abs(s.m00),_c.m01=Math.abs(s.m01),_c.m02=Math.abs(s.m02),_c.m03=Math.abs(s.m03),_c.m04=Math.abs(s.m04),_c.m05=Math.abs(s.m05),_c.m06=Math.abs(s.m06),_c.m07=Math.abs(s.m07),_c.m08=Math.abs(s.m08),oi.transformMat3(i,n,_c),oi.subtract(t,this.center,cc),oi.add(e,this.center,cc)}transform(t,e,i,n,s){oi.transformMat4(s.center,this.center,t),hi.fromQuat(s.orientation,i),oi.multiply(s.halfExtents,this.halfExtents,n)}translateAndRotate(t,e,i){oi.transformMat4(i.center,this.center,t),hi.fromQuat(i.orientation,e)}setScale(t,e){oi.multiply(e.halfExtents,this.halfExtents,t)}}class mc{get type(){return this._type}constructor(t=.5,e=.5,i=1){this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=Pr.SHAPE_CAPSULE,this.radius=t,this.halfHeight=e,this.axis=i,this.center=new oi,this.rotation=new mi,this.ellipseCenter0=new oi(0,e,0),this.ellipseCenter1=new oi(0,-e,0),this.updateCache()}transform(t,e,i,n,s){const r=n,o=ei(r);s.radius=this.radius*Math.abs(o);let a=(this.halfHeight+this.radius)*Math.abs(r.y)-s.radius;a<0&&(a=0),s.halfHeight=a,oi.transformMat4(s.center,this.center,t),mi.multiply(s.rotation,this.rotation,i),s.updateCache()}updateCache(){this.updateLocalCenter(),oi.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),oi.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)}updateLocalCenter(){const t=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(t,0,0),this.ellipseCenter1.set(-t,0,0);break;case 1:this.ellipseCenter0.set(0,t,0),this.ellipseCenter1.set(0,-t,0);break;case 2:this.ellipseCenter0.set(0,0,t),this.ellipseCenter1.set(0,0,-t)}}}const dc=new Array(8);dc[0]=new oi(1,1,1),dc[1]=new oi(-1,1,1),dc[2]=new oi(-1,-1,1),dc[3]=new oi(1,-1,1),dc[4]=new oi(1,1,-1),dc[5]=new oi(-1,1,-1),dc[6]=new oi(-1,-1,-1),dc[7]=new oi(1,-1,-1);class pc{set accurate(t){this._type=t?Pr.SHAPE_FRUSTUM_ACCURATE:Pr.SHAPE_FRUSTUM}static create(){return new pc}static clone(t){return pc.copy(new pc,t)}static copy(t,e){t._type=e._type;for(let i=0;i<6;++i)ec.copy(t.planes[i],e.planes[i]);for(let i=0;i<8;++i)oi.copy(t.vertices[i],e.vertices[i]);return t}get type(){return this._type}constructor(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=Pr.SHAPE_FRUSTUM,this.planes=new Array(6);for(let t=0;t<6;++t)this.planes[t]=ec.create(0,0,0,0);this.vertices=new Array(8);for(let t=0;t<8;++t)this.vertices[t]=new oi}update(t,e){if(oi.set(this.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08),this.planes[0].d=-(t.m15+t.m12),oi.set(this.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08),this.planes[1].d=-(t.m15-t.m12),oi.set(this.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09),this.planes[2].d=-(t.m15+t.m13),oi.set(this.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09),this.planes[3].d=-(t.m15-t.m13),oi.set(this.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10),this.planes[4].d=-(t.m15+t.m14),oi.set(this.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10),this.planes[5].d=-(t.m15-t.m14),this._type===Pr.SHAPE_FRUSTUM_ACCURATE){for(let t=0;t<6;t++){const e=this.planes[t],i=1/e.n.length();oi.multiplyScalar(e.n,e.n,i),e.d*=i}for(let t=0;t<8;t++)oi.transformMat4(this.vertices[t],dc[t],e)}}transform(t){if(this._type===Pr.SHAPE_FRUSTUM_ACCURATE){for(let e=0;e<8;e++)oi.transformMat4(this.vertices[e],this.vertices[e],t);ec.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),ec.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),ec.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),ec.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),ec.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),ec.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}function fc(t,e){if(!e||0===t)return;const i=e.vertices;let n=Es.VERTICES;for(let e=0;e<8;++e)Is.setVec3(t,n,i[e]),n+=3;const s=e.planes;let r=Es.PLANES;for(let e=0;e<6;e++,r+=4)Is.setVec4(t,r,s[e])}let gc,yc;pc.createOrtho=(()=>{const t=new oi;return(e,i,n,s,r,o)=>{const a=i/2,l=n/2;oi.set(t,a,l,s),oi.transformMat4(e.vertices[0],t,o),oi.set(t,-a,l,s),oi.transformMat4(e.vertices[1],t,o),oi.set(t,-a,-l,s),oi.transformMat4(e.vertices[2],t,o),oi.set(t,a,-l,s),oi.transformMat4(e.vertices[3],t,o),oi.set(t,a,l,r),oi.transformMat4(e.vertices[4],t,o),oi.set(t,-a,l,r),oi.transformMat4(e.vertices[5],t,o),oi.set(t,-a,-l,r),oi.transformMat4(e.vertices[6],t,o),oi.set(t,a,-l,r),oi.transformMat4(e.vertices[7],t,o),ec.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),ec.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),ec.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),ec.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),ec.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),ec.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])}})(),function(t){t[t.Default=0]="Default",t[t.Normal=1]="Normal",t[t.Loop=2]="Loop",t[t.ShouldWrap=4]="ShouldWrap",t[t.Clamp=8]="Clamp",t[t.PingPong=22]="PingPong",t[t.Reverse=36]="Reverse"}(gc||(gc={})),function(t){t[t.Default=gc.Default]="Default",t[t.Normal=gc.Normal]="Normal",t[t.Reverse=gc.Reverse]="Reverse",t[t.Loop=gc.Loop]="Loop",t[t.LoopReverse=gc.Loop|gc.Reverse]="LoopReverse",t[t.PingPong=gc.PingPong]="PingPong",t[t.PingPongReverse=gc.PingPong|gc.Reverse]="PingPongReverse"}(yc||(yc={})),jt(yc);class vc{constructor(t){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}set(t){this.ratio=t.ratio,this.time=t.time,this.direction=t.direction,this.stopped=t.stopped,this.iterations=t.iterations,this.frameIndex=t.frameIndex}}const xc=Gt({Default:gc.Default,Normal:gc.Normal,Clamp:gc.Clamp,Loop:gc.Loop,PingPong:gc.PingPong});class Sc{constructor(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}}Me.fastDefine("cc.Keyframe",Sc,{time:0,value:0,inTangent:0,outTangent:0});class Ac{constructor(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}evaluate(t){return e=t-this.time,i=this.coefficient,e*(e*(e*i[0]+i[1])+i[2])+i[3];var e,i}}class Cc{constructor(t=null){this.keyFrames=void 0,this.preWrapMode=xc.Loop,this.postWrapMode=xc.Clamp,this.cachedKey=void 0,this.keyFrames=t||[].concat(Cc.defaultKF),this.cachedKey=new Ac}addKey(t){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(t)}evaluate_slow(t){let e=t;const i=t<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,s=this.keyFrames[this.keyFrames.length-1].time;switch(i){case xc.Loop:e=Ze(t-n,s-n)+n;break;case xc.PingPong:e=Qe(t-n,s-n)+n;break;case xc.Default:case xc.Normal:case xc.Clamp:default:e=Ue(t,n,s)}let r=0;if(e>this.keyFrames[0].time)if(e>=this.keyFrames[this.keyFrames.length-1].time)r=this.keyFrames.length-2;else for(let t=0;t<this.keyFrames.length-1;t++)if(e>=this.keyFrames[0].time&&e<=this.keyFrames[t+1].time){r=t;break}const o=this.keyFrames[r],a=this.keyFrames[r+1],l=ti(o.time,a.time,e),c=a.time-o.time,h=o.outTangent*c,_=a.inTangent*c,u=l*l,m=u*l,d=m-2*u+l,p=m-u,f=-2*m+3*u;return(2*m-3*u+1)*o.value+d*h+p*_+f*a.value}evaluate(t){let e=t;const i=t<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,s=this.keyFrames[this.keyFrames.length-1].time;switch(i){case xc.Loop:e=Ze(t-n,s-n)+n;break;case xc.PingPong:e=Qe(t-n,s-n)+n;break;case xc.Default:case xc.Normal:case xc.Clamp:default:e=Ue(t,n,s)}if(e>=this.cachedKey.time&&e<this.cachedKey.endTime)return this.cachedKey.evaluate(e);const r=this.findIndex(this.cachedKey,e),o=Math.min(r+1,this.keyFrames.length-1);return this.calcOptimizedKey(this.cachedKey,r,o),this.cachedKey.evaluate(e)}calcOptimizedKey(t,e,i){const n=this.keyFrames[e],s=this.keyFrames[i];t.index=e,t.time=n.time,t.endTime=s.time;const r=s.time-n.time,o=s.value-n.value,a=1/(r*r),l=n.outTangent*r,c=s.inTangent*r;t.coefficient[0]=(l+c-o-o)*a/r,t.coefficient[1]=(o+o+o-l-l-c)*a,t.coefficient[2]=n.outTangent,t.coefficient[3]=n.value}findIndex(t,e){const i=t.index;if(-1!==i)if(e>this.keyFrames[i].time)for(let t=0;t<3;t++){const n=i+t;if(n+1<this.keyFrames.length&&this.keyFrames[n+1].time>e)return n}else for(let t=0;t<3;t++){const n=i-t;if(n>=0&&this.keyFrames[n-1].time<=e)return n-1}let n,s=0,r=this.keyFrames.length;for(;r-s>1;)n=Math.floor((s+r)/2),this.keyFrames[n].time>=e?r=n:s=n;return s}}function bc(t,e){console.warn(`${t} is deprecated, please use ${e} instead.`)}Cc.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Me.fastDefine("cc.AnimationCurve",Cc,{preWrapMode:xc.Default,postWrapMode:xc.Default,keyFrames:[]}),z(Jl,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var Tc=Object.freeze({__proto__:null,distance:Er,enums:Pr,intersect:Jl,Line:Ir,Plane:ec,Ray:Dr,Triangle:Fr,Sphere:Lr,AABB:lc,OBB:uc,Capsule:mc,Frustum:pc,Keyframe:Sc,AnimationCurve:Cc,get ERaycastMode(){return ul},line:class extends Ir{constructor(){super(),bc("line","Line")}},plane:class extends ec{constructor(){super(),bc("plane","Plane")}},ray:class extends Dr{constructor(){super(),bc("ray","Ray")}},triangle:class extends Fr{constructor(){super(),bc("triangle","Triangle")}},sphere:class extends Lr{constructor(){super(),bc("sphere","Sphere")}},aabb:class extends lc{constructor(){super(),bc("aabb","AABB")}},obb:class extends uc{constructor(){super(),bc("obb","OBB")}},capsule:class extends mc{constructor(){super(),bc("capsule","Capsule")}},frustum:class extends pc{constructor(){super(),bc("frustum","Frustum")}}});t("geometry",Tc);const wc={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295};class Ec{static makeMaskInclude(t){let e=0;for(const i of t)e|=i;return e}static makeMaskExclude(t){return~Ec.makeMaskInclude(t)}static addLayer(t,e){void 0!==e?e>19||e<0?console.warn("maximum layers reached."):(Ec.Enum[t]=1<<e,Ec.Enum[e]=t,Ec.BitMask[t]=1<<e,Ec.BitMask[e]=t):console.warn("bitNum can't be undefined")}static deleteLayer(t){t>19||t<0?console.warn("do not change buildin layers."):(delete Ec.Enum[Ec.Enum[t]],delete Ec.Enum[t],delete Ec.BitMask[Ec.BitMask[t]],delete Ec.BitMask[t])}}let Pc,Ic;t("Layers",Ec),Ec.Enum=Gt(wc),Ec.BitMask=Ut({...wc}),n.Layers=Ec,function(t){t[t.DEFAULT=100]="DEFAULT",t[t.UI=200]="UI"}(Pc||(Pc={})),n.RenderPassStage=Pc,function(t){t[t.MIN=0]="MIN",t[t.MAX=255]="MAX",t[t.DEFAULT=128]="DEFAULT"}(Ic||(Ic={}));const Dc={bindings:[],layouts:{}},Rc={bindings:[],layouts:{}};let Mc;!function(t){t[t.UBO_GLOBAL=0]="UBO_GLOBAL",t[t.UBO_CAMERA=1]="UBO_CAMERA",t[t.UBO_SHADOW=2]="UBO_SHADOW",t[t.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",t[t.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",t[t.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",t[t.SAMPLER_GBUFFER_ALBEDOMAP=6]="SAMPLER_GBUFFER_ALBEDOMAP",t[t.SAMPLER_GBUFFER_POSITIONMAP=7]="SAMPLER_GBUFFER_POSITIONMAP",t[t.SAMPLER_GBUFFER_NORMALMAP=8]="SAMPLER_GBUFFER_NORMALMAP",t[t.SAMPLER_GBUFFER_EMISSIVEMAP=9]="SAMPLER_GBUFFER_EMISSIVEMAP",t[t.SAMPLER_LIGHTING_RESULTMAP=10]="SAMPLER_LIGHTING_RESULTMAP",t[t.COUNT=11]="COUNT"}(Mc||(Mc={}));const Bc=Mc.SAMPLER_SHADOWMAP,Oc=Mc.COUNT-Bc;let Nc;!function(t){t[t.UBO_LOCAL=0]="UBO_LOCAL",t[t.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",t[t.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",t[t.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",t[t.UBO_MORPH=4]="UBO_MORPH",t[t.SAMPLER_JOINTS=5]="SAMPLER_JOINTS",t[t.SAMPLER_MORPH_POSITION=6]="SAMPLER_MORPH_POSITION",t[t.SAMPLER_MORPH_NORMAL=7]="SAMPLER_MORPH_NORMAL",t[t.SAMPLER_MORPH_TANGENT=8]="SAMPLER_MORPH_TANGENT",t[t.SAMPLER_LIGHTMAP=9]="SAMPLER_LIGHTMAP",t[t.SAMPLER_SPRITE=10]="SAMPLER_SPRITE",t[t.COUNT=11]="COUNT"}(Nc||(Nc={}));const Lc=Nc.SAMPLER_JOINTS,Fc=Nc.COUNT-Lc;let zc;!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.MATERIAL=1]="MATERIAL",t[t.LOCAL=2]="LOCAL"}(zc||(zc={}));const Vc=new Fo;Vc.bufferOffsets=[0,Bc+Lc,Bc],Vc.samplerOffsets=[-Bc,Oc+Fc,Oc-Lc],Vc.flexibleSet=1;class Uc{}Uc.TIME_OFFSET=0,Uc.NATIVE_SIZE_OFFSET=Uc.TIME_OFFSET+4,Uc.SCREEN_SIZE_OFFSET=Uc.NATIVE_SIZE_OFFSET+4,Uc.COUNT=Uc.SCREEN_SIZE_OFFSET+4,Uc.SIZE=4*Uc.COUNT,Uc.NAME="CCGlobal",Uc.BINDING=Mc.UBO_GLOBAL,Uc.DESCRIPTOR=new _a(Uc.BINDING,xo.UNIFORM_BUFFER,1,lo.ALL),Uc.LAYOUT=new Xo(zc.GLOBAL,Uc.BINDING,Uc.NAME,[new qo("cc_time",qr.FLOAT4,1),new qo("cc_screenSize",qr.FLOAT4,1),new qo("cc_nativeSize",qr.FLOAT4,1)],1),Dc.layouts[Uc.NAME]=Uc.LAYOUT,Dc.bindings[Uc.BINDING]=Uc.DESCRIPTOR;class Gc{}Gc.MAT_VIEW_OFFSET=0,Gc.MAT_VIEW_INV_OFFSET=Gc.MAT_VIEW_OFFSET+16,Gc.MAT_PROJ_OFFSET=Gc.MAT_VIEW_INV_OFFSET+16,Gc.MAT_PROJ_INV_OFFSET=Gc.MAT_PROJ_OFFSET+16,Gc.MAT_VIEW_PROJ_OFFSET=Gc.MAT_PROJ_INV_OFFSET+16,Gc.MAT_VIEW_PROJ_INV_OFFSET=Gc.MAT_VIEW_PROJ_OFFSET+16,Gc.CAMERA_POS_OFFSET=Gc.MAT_VIEW_PROJ_INV_OFFSET+16,Gc.SCREEN_SCALE_OFFSET=Gc.CAMERA_POS_OFFSET+4,Gc.EXPOSURE_OFFSET=Gc.SCREEN_SCALE_OFFSET+4,Gc.MAIN_LIT_DIR_OFFSET=Gc.EXPOSURE_OFFSET+4,Gc.MAIN_LIT_COLOR_OFFSET=Gc.MAIN_LIT_DIR_OFFSET+4,Gc.AMBIENT_SKY_OFFSET=Gc.MAIN_LIT_COLOR_OFFSET+4,Gc.AMBIENT_GROUND_OFFSET=Gc.AMBIENT_SKY_OFFSET+4,Gc.GLOBAL_FOG_COLOR_OFFSET=Gc.AMBIENT_GROUND_OFFSET+4,Gc.GLOBAL_FOG_BASE_OFFSET=Gc.GLOBAL_FOG_COLOR_OFFSET+4,Gc.GLOBAL_FOG_ADD_OFFSET=Gc.GLOBAL_FOG_BASE_OFFSET+4,Gc.COUNT=Gc.GLOBAL_FOG_ADD_OFFSET+4,Gc.SIZE=4*Gc.COUNT,Gc.NAME="CCCamera",Gc.BINDING=Mc.UBO_CAMERA,Gc.DESCRIPTOR=new _a(Gc.BINDING,xo.UNIFORM_BUFFER,1,lo.ALL),Gc.LAYOUT=new Xo(zc.GLOBAL,Gc.BINDING,Gc.NAME,[new qo("cc_matView",qr.MAT4,1),new qo("cc_matViewInv",qr.MAT4,1),new qo("cc_matProj",qr.MAT4,1),new qo("cc_matProjInv",qr.MAT4,1),new qo("cc_matViewProj",qr.MAT4,1),new qo("cc_matViewProjInv",qr.MAT4,1),new qo("cc_cameraPos",qr.FLOAT4,1),new qo("cc_screenScale",qr.FLOAT4,1),new qo("cc_exposure",qr.FLOAT4,1),new qo("cc_mainLitDir",qr.FLOAT4,1),new qo("cc_mainLitColor",qr.FLOAT4,1),new qo("cc_ambientSky",qr.FLOAT4,1),new qo("cc_ambientGround",qr.FLOAT4,1),new qo("cc_fogColor",qr.FLOAT4,1),new qo("cc_fogBase",qr.FLOAT4,1),new qo("cc_fogAdd",qr.FLOAT4,1)],1),Dc.layouts[Gc.NAME]=Gc.LAYOUT,Dc.bindings[Gc.BINDING]=Gc.DESCRIPTOR;class Hc{}Hc.MAT_LIGHT_PLANE_PROJ_OFFSET=0,Hc.MAT_LIGHT_VIEW_OFFSET=Hc.MAT_LIGHT_PLANE_PROJ_OFFSET+16,Hc.MAT_LIGHT_VIEW_PROJ_OFFSET=Hc.MAT_LIGHT_VIEW_OFFSET+16,Hc.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET=Hc.MAT_LIGHT_VIEW_PROJ_OFFSET+16,Hc.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=Hc.SHADOW_NEAR_FAR_LINEAR_SELF_INFO_OFFSET+4,Hc.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=Hc.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+4,Hc.SHADOW_COLOR_OFFSET=Hc.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+4,Hc.COUNT=Hc.SHADOW_COLOR_OFFSET+4,Hc.SIZE=4*Hc.COUNT,Hc.NAME="CCShadow",Hc.BINDING=Mc.UBO_SHADOW,Hc.DESCRIPTOR=new _a(Hc.BINDING,xo.UNIFORM_BUFFER,1,lo.ALL),Hc.LAYOUT=new Xo(zc.GLOBAL,Hc.BINDING,Hc.NAME,[new qo("cc_matLightPlaneProj",qr.MAT4,1),new qo("cc_matLightView",qr.MAT4,1),new qo("cc_matLightViewProj",qr.MAT4,1),new qo("cc_shadowNFLSInfo",qr.FLOAT4,1),new qo("cc_shadowWHPBInfo",qr.FLOAT4,1),new qo("cc_shadowLPNNInfo",qr.FLOAT4,1),new qo("cc_shadowColor",qr.FLOAT4,1)],1),Dc.layouts[Hc.NAME]=Hc.LAYOUT,Dc.bindings[Hc.BINDING]=Hc.DESCRIPTOR;const kc=Mc.SAMPLER_SHADOWMAP,jc=new _a(kc,xo.SAMPLER_TEXTURE,1,lo.FRAGMENT),Wc=new Yo(zc.GLOBAL,kc,"cc_shadowMap",qr.SAMPLER2D,1);Dc.layouts.cc_shadowMap=Wc,Dc.bindings[kc]=jc;const qc=Mc.SAMPLER_GBUFFER_ALBEDOMAP,Xc=new _a(qc,xo.SAMPLER_TEXTURE,1,lo.FRAGMENT),Yc=new Yo(zc.GLOBAL,qc,"cc_gbuffer_albedoMap",qr.SAMPLER2D,1);Dc.layouts.cc_gbuffer_albedoMap=Yc,Dc.bindings[qc]=Xc;const Kc=Mc.SAMPLER_GBUFFER_POSITIONMAP,Jc=new _a(Kc,xo.SAMPLER_TEXTURE,1,lo.FRAGMENT),$c=new Yo(zc.GLOBAL,Kc,"cc_gbuffer_positionMap",qr.SAMPLER2D,1);Dc.layouts.cc_gbuffer_positionMap=$c,Dc.bindings[Kc]=Jc;const Zc=Mc.SAMPLER_GBUFFER_NORMALMAP,Qc=new _a(Zc,xo.SAMPLER_TEXTURE,1,lo.FRAGMENT),th=new Yo(zc.GLOBAL,Zc,"cc_gbuffer_normalMap",qr.SAMPLER2D,1);Dc.layouts.cc_gbuffer_normalMap=th,Dc.bindings[Zc]=Qc;const eh=Mc.SAMPLER_LIGHTING_RESULTMAP,ih=new _a(eh,xo.SAMPLER_TEXTURE,1,lo.FRAGMENT),nh=new Yo(zc.GLOBAL,eh,"cc_lighting_resultMap",qr.SAMPLER2D,1);Dc.layouts.cc_lighting_resultMap=nh,Dc.bindings[eh]=ih;const sh=Mc.SAMPLER_GBUFFER_EMISSIVEMAP,rh=new _a(sh,xo.SAMPLER_TEXTURE,1,lo.FRAGMENT),oh=new Yo(zc.GLOBAL,sh,"cc_gbuffer_emissiveMap",qr.SAMPLER2D,1);Dc.layouts.cc_gbuffer_emissiveMap=oh,Dc.bindings[sh]=rh;const ah=Mc.SAMPLER_ENVIRONMENT,lh=new _a(ah,xo.SAMPLER_TEXTURE,1,lo.FRAGMENT),ch=new Yo(zc.GLOBAL,ah,"cc_environment",qr.SAMPLER_CUBE,1);Dc.layouts.cc_environment=ch,Dc.bindings[ah]=lh;const hh=Mc.SAMPLER_SPOT_LIGHTING_MAP,_h=new _a(hh,xo.SAMPLER_TEXTURE,1,lo.FRAGMENT),uh=new Yo(zc.GLOBAL,hh,"cc_spotLightingMap",qr.SAMPLER2D,1);Dc.layouts.cc_spotLightingMap=uh,Dc.bindings[hh]=_h;class mh{}mh.MAT_WORLD_OFFSET=0,mh.MAT_WORLD_IT_OFFSET=mh.MAT_WORLD_OFFSET+16,mh.LIGHTINGMAP_UVPARAM=mh.MAT_WORLD_IT_OFFSET+16,mh.COUNT=mh.LIGHTINGMAP_UVPARAM+4,mh.SIZE=4*mh.COUNT,mh.NAME="CCLocal",mh.BINDING=Nc.UBO_LOCAL,mh.DESCRIPTOR=new _a(mh.BINDING,xo.UNIFORM_BUFFER,1,lo.VERTEX),mh.LAYOUT=new Xo(zc.LOCAL,mh.BINDING,mh.NAME,[new qo("cc_matWorld",qr.MAT4,1),new qo("cc_matWorldIT",qr.MAT4,1),new qo("cc_lightingMapUVParam",qr.FLOAT4,1)],1),Rc.layouts[mh.NAME]=mh.LAYOUT,Rc.bindings[mh.BINDING]=mh.DESCRIPTOR;class dh{}dh.BATCHING_COUNT=10,dh.MAT_WORLDS_OFFSET=0,dh.COUNT=16*dh.BATCHING_COUNT,dh.SIZE=4*dh.COUNT,dh.NAME="CCLocalBatched",dh.BINDING=Nc.UBO_LOCAL,dh.DESCRIPTOR=new _a(dh.BINDING,xo.UNIFORM_BUFFER,1,lo.VERTEX),dh.LAYOUT=new Xo(zc.LOCAL,dh.BINDING,dh.NAME,[new qo("cc_matWorlds",qr.MAT4,dh.BATCHING_COUNT)],1),Rc.layouts[dh.NAME]=dh.LAYOUT,Rc.bindings[dh.BINDING]=dh.DESCRIPTOR;class ph{}ph.LIGHTS_PER_PASS=1,ph.LIGHT_POS_OFFSET=0,ph.LIGHT_COLOR_OFFSET=ph.LIGHT_POS_OFFSET+4*ph.LIGHTS_PER_PASS,ph.LIGHT_SIZE_RANGE_ANGLE_OFFSET=ph.LIGHT_COLOR_OFFSET+4*ph.LIGHTS_PER_PASS,ph.LIGHT_DIR_OFFSET=ph.LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*ph.LIGHTS_PER_PASS,ph.COUNT=ph.LIGHT_DIR_OFFSET+4*ph.LIGHTS_PER_PASS,ph.SIZE=4*ph.COUNT,ph.NAME="CCForwardLight",ph.BINDING=Nc.UBO_FORWARD_LIGHTS,ph.DESCRIPTOR=new _a(ph.BINDING,xo.DYNAMIC_UNIFORM_BUFFER,1,lo.FRAGMENT),ph.LAYOUT=new Xo(zc.LOCAL,ph.BINDING,ph.NAME,[new qo("cc_lightPos",qr.FLOAT4,ph.LIGHTS_PER_PASS),new qo("cc_lightColor",qr.FLOAT4,ph.LIGHTS_PER_PASS),new qo("cc_lightSizeRangeAngle",qr.FLOAT4,ph.LIGHTS_PER_PASS),new qo("cc_lightDir",qr.FLOAT4,ph.LIGHTS_PER_PASS)],1),Rc.layouts[ph.NAME]=ph.LAYOUT,Rc.bindings[ph.BINDING]=ph.DESCRIPTOR;class fh{}fh.JOINTS_TEXTURE_INFO_OFFSET=0,fh.COUNT=fh.JOINTS_TEXTURE_INFO_OFFSET+4,fh.SIZE=4*fh.COUNT,fh.NAME="CCSkinningTexture",fh.BINDING=Nc.UBO_SKINNING_TEXTURE,fh.DESCRIPTOR=new _a(fh.BINDING,xo.UNIFORM_BUFFER,1,lo.VERTEX),fh.LAYOUT=new Xo(zc.LOCAL,fh.BINDING,fh.NAME,[new qo("cc_jointTextureInfo",qr.FLOAT4,1)],1),Rc.layouts[fh.NAME]=fh.LAYOUT,Rc.bindings[fh.BINDING]=fh.DESCRIPTOR;class gh{}gh.JOINTS_ANIM_INFO_OFFSET=0,gh.COUNT=gh.JOINTS_ANIM_INFO_OFFSET+4,gh.SIZE=4*gh.COUNT,gh.NAME="CCSkinningAnimation",gh.BINDING=Nc.UBO_SKINNING_ANIMATION,gh.DESCRIPTOR=new _a(gh.BINDING,xo.UNIFORM_BUFFER,1,lo.VERTEX),gh.LAYOUT=new Xo(zc.LOCAL,gh.BINDING,gh.NAME,[new qo("cc_jointAnimInfo",qr.FLOAT4,1)],1),Rc.layouts[gh.NAME]=gh.LAYOUT,Rc.bindings[gh.BINDING]=gh.DESCRIPTOR;class yh{}yh.JOINTS_OFFSET=0,yh.COUNT=yh.JOINTS_OFFSET+360,yh.SIZE=4*yh.COUNT,yh.NAME="CCSkinning",yh.BINDING=Nc.UBO_SKINNING_TEXTURE,yh.DESCRIPTOR=new _a(yh.BINDING,xo.UNIFORM_BUFFER,1,lo.VERTEX),yh.LAYOUT=new Xo(zc.LOCAL,yh.BINDING,yh.NAME,[new qo("cc_joints",qr.FLOAT4,90)],1),Rc.layouts[yh.NAME]=yh.LAYOUT,Rc.bindings[yh.BINDING]=yh.DESCRIPTOR;class vh{}vh.MAX_MORPH_TARGET_COUNT=60,vh.OFFSET_OF_WEIGHTS=0,vh.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*vh.MAX_MORPH_TARGET_COUNT,vh.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=vh.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH+4,vh.OFFSET_OF_VERTICES_COUNT=vh.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT+4,vh.COUNT_BASE_4_BYTES=4*Math.ceil(vh.MAX_MORPH_TARGET_COUNT/4)+4,vh.SIZE=4*vh.COUNT_BASE_4_BYTES,vh.NAME="CCMorph",vh.BINDING=Nc.UBO_MORPH,vh.DESCRIPTOR=new _a(vh.BINDING,xo.UNIFORM_BUFFER,1,lo.VERTEX),vh.LAYOUT=new Xo(zc.LOCAL,vh.BINDING,vh.NAME,[new qo("cc_displacementWeights",qr.FLOAT4,vh.MAX_MORPH_TARGET_COUNT/4),new qo("cc_displacementTextureInfo",qr.FLOAT4,1)],1),Rc.layouts[vh.NAME]=vh.LAYOUT,Rc.bindings[vh.BINDING]=vh.DESCRIPTOR;const xh=Nc.SAMPLER_JOINTS,Sh=new _a(xh,xo.SAMPLER_TEXTURE,1,lo.VERTEX),Ah=new Yo(zc.LOCAL,xh,"cc_jointTexture",qr.SAMPLER2D,1);Rc.layouts.cc_jointTexture=Ah,Rc.bindings[xh]=Sh;const Ch=Nc.SAMPLER_MORPH_POSITION,bh=new _a(Ch,xo.SAMPLER_TEXTURE,1,lo.VERTEX),Th=new Yo(zc.LOCAL,Ch,"cc_PositionDisplacements",qr.SAMPLER2D,1);Rc.layouts.cc_PositionDisplacements=Th,Rc.bindings[Ch]=bh;const wh=Nc.SAMPLER_MORPH_NORMAL,Eh=new _a(wh,xo.SAMPLER_TEXTURE,1,lo.VERTEX),Ph=new Yo(zc.LOCAL,wh,"cc_NormalDisplacements",qr.SAMPLER2D,1);Rc.layouts.cc_NormalDisplacements=Ph,Rc.bindings[wh]=Eh;const Ih=Nc.SAMPLER_MORPH_TANGENT,Dh=new _a(Ih,xo.SAMPLER_TEXTURE,1,lo.VERTEX),Rh=new Yo(zc.LOCAL,Ih,"cc_TangentDisplacements",qr.SAMPLER2D,1);Rc.layouts.cc_TangentDisplacements=Rh,Rc.bindings[Ih]=Dh;const Mh=Nc.SAMPLER_LIGHTMAP,Bh=new _a(Mh,xo.SAMPLER_TEXTURE,1,lo.FRAGMENT),Oh=new Yo(zc.LOCAL,Mh,"cc_lightingMap",qr.SAMPLER2D,1);Rc.layouts.cc_lightingMap=Oh,Rc.bindings[Mh]=Bh;const Nh=Nc.SAMPLER_SPRITE,Lh=new _a(Nh,xo.SAMPLER_TEXTURE,1,lo.FRAGMENT),Fh=new Yo(zc.LOCAL,Nh,"cc_spriteTexture",qr.SAMPLER2D,1);Rc.layouts.cc_spriteTexture=Fh,Rc.bindings[Nh]=Lh;const zh=Ec.makeMaskExclude([Ec.BitMask.UI_2D,Ec.BitMask.GIZMOS,Ec.BitMask.EDITOR,Ec.BitMask.SCENE_GIZMO,Ec.BitMask.PROFILER]);let Vh,Uh,Gh,Hh,kh;Ec.makeMaskExclude([Ec.BitMask.UI_2D,Ec.BitMask.PROFILER]),Ec.Enum.ALL,function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL"}(Vh||(Vh={})),function(t){t[t.ORTHO=0]="ORTHO",t[t.PERSPECTIVE=1]="PERSPECTIVE"}(Uh||(Uh={})),function(t){t[t.F1_8=0]="F1_8",t[t.F2_0=1]="F2_0",t[t.F2_2=2]="F2_2",t[t.F2_5=3]="F2_5",t[t.F2_8=4]="F2_8",t[t.F3_2=5]="F3_2",t[t.F3_5=6]="F3_5",t[t.F4_0=7]="F4_0",t[t.F4_5=8]="F4_5",t[t.F5_0=9]="F5_0",t[t.F5_6=10]="F5_6",t[t.F6_3=11]="F6_3",t[t.F7_1=12]="F7_1",t[t.F8_0=13]="F8_0",t[t.F9_0=14]="F9_0",t[t.F10_0=15]="F10_0",t[t.F11_0=16]="F11_0",t[t.F13_0=17]="F13_0",t[t.F14_0=18]="F14_0",t[t.F16_0=19]="F16_0",t[t.F18_0=20]="F18_0",t[t.F20_0=21]="F20_0",t[t.F22_0=22]="F22_0"}(Gh||(Gh={})),function(t){t[t.ISO100=0]="ISO100",t[t.ISO200=1]="ISO200",t[t.ISO400=2]="ISO400",t[t.ISO800=3]="ISO800"}(Hh||(Hh={})),function(t){t[t.D1=0]="D1",t[t.D2=1]="D2",t[t.D4=2]="D4",t[t.D8=3]="D8",t[t.D15=4]="D15",t[t.D30=5]="D30",t[t.D60=6]="D60",t[t.D125=7]="D125",t[t.D250=8]="D250",t[t.D500=9]="D500",t[t.D1000=10]="D1000",t[t.D2000=11]="D2000",t[t.D4000=12]="D4000"}(kh||(kh={}));const jh=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],Wh=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],qh=[100,200,400,800],Xh=new oi,Yh=new oi,Kh=new Si,Jh=Co.STENCIL<<1,$h=[];class Zh{constructor(t){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Vh.VERTICAL,this._fov=ke(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new Lo(.2,.2,.2,1),this._viewport=new Oi(0,0,1,1),this._curTransform=Hr.IDENTITY,this._isProjDirty=!0,this._matView=new Si,this._matViewInv=null,this._matProj=new Si,this._matProjInv=new Si,this._matViewProj=new Si,this._matViewProjInv=new Si,this._frustum=new pc,this._forward=new oi,this._position=new oi,this._priority=0,this._aperture=Gh.F16_0,this._apertureValue=void 0,this._shutter=kh.D125,this._shutterValue=0,this._iso=Hh.ISO100,this._isoValue=0,this._ec=0,this._poolHandle=0,this._frustumHandle=0,this._window=null,this._device=t,this._apertureValue=jh[this._aperture],this._shutterValue=Wh[this._shutter],this._isoValue=qh[this._iso],this._aspect=this.screenScale=1,!$h.length){const e=t.capabilities.clipSpaceSignY;$h[Hr.IDENTITY]=new Si(1,0,0,0,0,e),$h[Hr.ROTATE_90]=new Si(0,1,0,0,-e,0),$h[Hr.ROTATE_180]=new Si(-1,0,0,0,0,-e),$h[Hr.ROTATE_270]=new Si(0,-1,0,0,e,0)}}initialize(t){this._name=t.name,this._node=t.node,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1;const e=this._poolHandle=gs.alloc();gs.set(e,ps.WIDTH,1),gs.set(e,ps.HEIGHT,1),gs.set(e,ps.CLEAR_FLAGS,Co.NONE),gs.set(e,ps.CLEAR_DEPTH,1),gs.set(e,ps.NODE,this._node.handle),gs.set(e,ps.VISIBILITY,zh),this._scene&&gs.set(e,ps.SCENE,this._scene.handle),this._frustumHandle=Is.alloc(),gs.set(e,ps.FRUSTUM,this._frustumHandle),this.updateExposure(),this.changeTargetWindow(t.window),console.log(`Created Camera: ${this._name} ${gs.get(e,ps.WIDTH)}x${gs.get(e,ps.HEIGHT)}`)}destroy(){this._window&&this._window.detachCamera(this),this._name=null,this._poolHandle&&(gs.free(this._poolHandle),this._poolHandle=0,this._frustumHandle&&(Is.free(this._frustumHandle),this._frustumHandle=0))}attachToScene(t){this._scene=t,this._enabled=!0,gs.set(this._poolHandle,ps.SCENE,t.handle)}detachFromScene(){this._scene=null,this._enabled=!1,gs.set(this._poolHandle,ps.SCENE,0)}resize(t,e){const i=this._poolHandle;gs.set(i,ps.WIDTH,t),gs.set(i,ps.HEIGHT,e),this._aspect=t*this._viewport.width/(e*this._viewport.height),this._isProjDirty=!0}setFixedSize(t,e){const i=this._poolHandle;gs.set(i,ps.WIDTH,t),gs.set(i,ps.HEIGHT,e),this._aspect=t*this._viewport.width/(e*this._viewport.height),this.isWindowSize=!1}update(t=!1){if(!this._node)return;let e=!1;(this._node.hasChangedFlags||t)&&(Si.invert(this._matView,this._node.worldMatrix),gs.setMat4(this._poolHandle,ps.MAT_VIEW,this._matView),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),gs.setVec3(this._poolHandle,ps.POSITION,this._position),gs.setVec3(this._poolHandle,ps.FORWARD,this._forward),e=!0);let i=this._device.surfaceTransform;if(this._isProjDirty||this._curTransform!==i){var n;this._curTransform=i;const t=this._device.capabilities.clipSpaceSignY;if((null===(n=this.window)||void 0===n?void 0:n.hasOffScreenAttachments)&&(i=Hr.IDENTITY),this._proj===Uh.PERSPECTIVE)Si.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Vh.VERTICAL,this._device.capabilities.clipSpaceMinZ,t,i);else{const e=this._orthoHeight*this._aspect,n=this._orthoHeight;Si.ortho(this._matProj,-e,e,-n,n,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,t,i)}Si.invert(this._matProjInv,this._matProj),gs.setMat4(this._poolHandle,ps.MAT_PROJ,this._matProj),gs.setMat4(this._poolHandle,ps.MAT_PROJ_INV,this._matProjInv),e=!0,this._isProjDirty=!1}e&&(Si.multiply(this._matViewProj,this._matProj,this._matView),Si.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv),gs.setMat4(this._poolHandle,ps.MAT_VIEW_PROJ,this._matViewProj),gs.setMat4(this._poolHandle,ps.MAT_VIEW_PROJ_INV,this._matViewProjInv),fc(this._frustumHandle,this._frustum))}set node(t){this._node=t}get node(){return this._node}set enabled(t){this._enabled=t}get enabled(){return this._enabled}set orthoHeight(t){this._orthoHeight=t,this._isProjDirty=!0}get orthoHeight(){return this._orthoHeight}set projectionType(t){this._proj=t,this._isProjDirty=!0}get projectionType(){return this._proj}set fovAxis(t){this._fovAxis=t,this._isProjDirty=!0}get fovAxis(){return this._fovAxis}set fov(t){this._fov=t,this._isProjDirty=!0}get fov(){return this._fov}set nearClip(t){this._nearClip=t,this._isProjDirty=!0}get nearClip(){return this._nearClip}set farClip(t){this._farClip=t,this._isProjDirty=!0}get farClip(){return this._farClip}set clearColor(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w,gs.setVec4(this._poolHandle,ps.CLEAR_COLOR,t)}get clearColor(){return this._clearColor}get viewport(){return this._viewport}set viewport(t){const{x:e,width:i,height:n}=t,s=this._device.capabilities.clipSpaceSignY<0?1-t.y-n:t.y;switch(this._device.surfaceTransform){case Hr.ROTATE_90:this._viewport.x=1-s-n,this._viewport.y=e,this._viewport.width=n,this._viewport.height=i;break;case Hr.ROTATE_180:this._viewport.x=1-e-i,this._viewport.y=1-s-n,this._viewport.width=i,this._viewport.height=n;break;case Hr.ROTATE_270:this._viewport.x=s,this._viewport.y=1-e-i,this._viewport.width=n,this._viewport.height=i;break;case Hr.IDENTITY:this._viewport.x=e,this._viewport.y=s,this._viewport.width=i,this._viewport.height=n}gs.setVec4(this._poolHandle,ps.VIEW_PORT,this._viewport),this.resize(this.width,this.height)}get scene(){return this._scene}get name(){return this._name}get width(){return gs.get(this._poolHandle,ps.WIDTH)}get height(){return gs.get(this._poolHandle,ps.HEIGHT)}get aspect(){return this._aspect}set matView(t){this._matView=t,gs.setMat4(this._poolHandle,ps.MAT_VIEW,this._matView)}get matView(){return this._matView}set matViewInv(t){this._matViewInv=t}get matViewInv(){return this._matViewInv||this._node.worldMatrix}set matProj(t){this._matProj=t,gs.setMat4(this._poolHandle,ps.MAT_PROJ,this._matProj)}get matProj(){return this._matProj}set matProjInv(t){this._matProjInv=t,gs.setMat4(this._poolHandle,ps.MAT_PROJ_INV,this._matProjInv)}get matProjInv(){return this._matProjInv}set matViewProj(t){this._matViewProj=t,gs.setMat4(this._poolHandle,ps.MAT_VIEW_PROJ,this._matViewProj)}get matViewProj(){return this._matViewProj}set matViewProjInv(t){this._matViewProjInv=t,gs.setMat4(this._poolHandle,ps.MAT_VIEW_PROJ_INV,this._matViewProjInv)}get matViewProjInv(){return this._matViewProjInv}set frustum(t){this._frustum=t,fc(this._frustumHandle,t)}get frustum(){return this._frustum}set window(t){this._window=t,t&&gs.set(this._poolHandle,ps.WINDOW,t.handle)}get window(){return this._window}set forward(t){this._forward=t,gs.setVec3(this._poolHandle,ps.FORWARD,this._forward)}get forward(){return this._forward}set position(t){this._position=t,gs.setVec3(this._poolHandle,ps.POSITION,this._position)}get position(){return this._position}set visibility(t){gs.set(this._poolHandle,ps.VISIBILITY,t)}get visibility(){return gs.get(this._poolHandle,ps.VISIBILITY)}get priority(){return this._priority}set priority(t){this._priority=t}set aperture(t){this._aperture=t,this._apertureValue=jh[this._aperture],this.updateExposure()}get aperture(){return this._aperture}get apertureValue(){return this._apertureValue}set shutter(t){this._shutter=t,this._shutterValue=Wh[this._shutter],this.updateExposure()}get shutter(){return this._shutter}get shutterValue(){return this._shutterValue}set iso(t){this._iso=t,this._isoValue=qh[this._iso],this.updateExposure()}get iso(){return this._iso}get isoValue(){return this._isoValue}set ec(t){this._ec=t}get ec(){return this._ec}get exposure(){return gs.get(this._poolHandle,ps.EXPOSURE)}get clearFlag(){return gs.get(this._poolHandle,ps.CLEAR_FLAGS)}set clearFlag(t){gs.set(this._poolHandle,ps.CLEAR_FLAGS,t)}get clearDepth(){return gs.get(this._poolHandle,ps.CLEAR_DEPTH)}set clearDepth(t){gs.set(this._poolHandle,ps.CLEAR_DEPTH,t)}get clearStencil(){return gs.get(this._poolHandle,ps.CLEAR_STENCIL)}set clearStencil(t){gs.set(this._poolHandle,ps.CLEAR_STENCIL,t)}get handle(){return this._poolHandle}changeTargetWindow(t=null){this._window&&this._window.detachCamera(this);const e=t||n.director.root.mainWindow;e&&(e.attachCamera(this),this.resize(e.width,e.height),this._window=e,gs.set(this._poolHandle,ps.WINDOW,e.handle))}detachCamera(){this._window&&this._window.detachCamera(this)}screenPointToRay(t,e,i){if(!this._node)return null;const n=this._poolHandle,s=gs.get(n,ps.WIDTH),r=gs.get(n,ps.HEIGHT),o=this._viewport.x*s,a=this._viewport.y*r,l=this._viewport.width*s,c=this._viewport.height*r,h=this._proj===Uh.PERSPECTIVE,_=this._device.capabilities.clipSpaceSignY,u=xi[this._curTransform];oi.set(Xh,(e-o)/l*2-1,(i-a)/c*2-1,h?1:-1);const{x:m,y:d}=Xh;return Xh.x=m*u[0]+d*u[2]*_,Xh.y=m*u[1]+d*u[3]*_,oi.transformMat4(h?Xh:t.o,Xh,this._matViewProjInv),h?(this._node.getWorldPosition(Yh),Dr.fromPoints(t,Yh,Xh)):oi.transformQuat(t.d,oi.FORWARD,this._node.worldRotation),t}screenToWorld(t,e){const i=this._poolHandle,n=gs.get(i,ps.WIDTH),s=gs.get(i,ps.HEIGHT),r=this._viewport.x*n,o=this._viewport.y*s,a=this._viewport.width*n,l=this._viewport.height*s,c=this._device.capabilities.clipSpaceSignY,h=xi[this._curTransform];if(this._proj===Uh.PERSPECTIVE){oi.set(t,(e.x-r)/a*2-1,(e.y-o)/l*2-1,1);const{x:i,y:n}=t;t.x=i*h[0]+n*h[2]*c,t.y=i*h[1]+n*h[3]*c,oi.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(Xh),oi.lerp(t,Xh,t,He(this._nearClip/this._farClip,1,e.z))}else{oi.set(t,(e.x-r)/a*2-1,(e.y-o)/l*2-1,2*e.z-1);const{x:i,y:n}=t;t.x=i*h[0]+n*h[2]*c,t.y=i*h[1]+n*h[3]*c,oi.transformMat4(t,t,this._matViewProjInv)}return t}worldToScreen(t,e){const i=this._poolHandle,n=gs.get(i,ps.WIDTH),s=gs.get(i,ps.HEIGHT),r=this._viewport.x*n,o=this._viewport.y*s,a=this._viewport.width*n,l=this._viewport.height*s,c=this._device.capabilities.clipSpaceSignY,h=xi[this._curTransform];oi.transformMat4(t,e,this._matViewProj);const{x:_,y:u}=t;return t.x=_*h[0]+u*h[2]*c,t.y=_*h[1]+u*h[3]*c,t.x=r+.5*(t.x+1)*a,t.y=o+.5*(t.y+1)*l,t.z=.5*t.z+.5,t}worldMatrixToScreen(t,e,i,n){Si.multiply(t,this._matViewProj,e),Si.multiply(t,$h[this._curTransform],t);const s=i/2,r=n/2;return Si.identity(Kh),Si.transform(Kh,Kh,oi.set(Xh,s,r,0)),Si.scale(Kh,Kh,oi.set(Xh,s,r,1)),Si.multiply(t,Kh,t),t}updateExposure(){const t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);gs.set(this._poolHandle,ps.EXPOSURE,.833333/2**t)}}let Qh,t_;!function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(Qh||(Qh={})),function(t){t[t.NONE=0]="NONE",t[t.POSITION=1]="POSITION",t[t.ROTATION=2]="ROTATION",t[t.SCALE=4]="SCALE",t[t.RS=t.ROTATION|t.SCALE]="RS",t[t.TRS=t.POSITION|t.ROTATION|t.SCALE]="TRS",t[t.TRS_MASK=~t.TRS]="TRS_MASK"}(t_||(t_={})),n.internal.TransformBit=t_;class e_{get root(){return this._root}get name(){return this._name}get cameras(){return this._cameras}get mainLight(){return this._mainLight}get sphereLights(){return this._sphereLights}get spotLights(){return this._spotLights}get models(){return this._models}get handle(){return this._scenePoolHandle}get batches(){return this._batches}static registerCreateFunc(t){t._createSceneFun=t=>new e_(t)}constructor(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._scenePoolHandle=0,this._modelArrayHandle=0,this._batchArrayHandle=0,this._sphereLightsHandle=0,this._spotLightsHandle=0,this._root=t,this._createHandles()}initialize(t){return this._name=t.name,this._createHandles(),!0}update(t){const e=this._mainLight;e&&e.update();const i=this._sphereLights;for(let t=0;t<i.length;t++)i[t].update();const n=this._spotLights;for(let t=0;t<n.length;t++)n[t].update();const s=this._models;for(let e=0;e<s.length;e++){const i=s[e];i.enabled&&(i.updateTransform(t),i.updateUBOs(t))}}destroy(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._modelArrayHandle&&(kn.free(this._modelArrayHandle),this._modelArrayHandle=0),this._scenePoolHandle&&(ds.free(this._scenePoolHandle),this._scenePoolHandle=0),this._sphereLightsHandle&&(qn.free(this._sphereLightsHandle),this._sphereLightsHandle=0),this._spotLightsHandle&&(qn.free(this._spotLightsHandle),this._spotLightsHandle=0),this._batchArrayHandle&&(Yn.free(this._batchArrayHandle),this._batchArrayHandle=0)}addCamera(t){t.attachToScene(this),this._cameras.push(t)}removeCamera(t){for(let e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()}removeCameras(){for(const t of this._cameras)t.detachFromScene();this._cameras.splice(0)}setMainLight(t){this._mainLight=t,ds.set(this._scenePoolHandle,us.MAIN_LIGHT,t.handle)}unsetMainLight(t){if(this._mainLight===t){const t=this._directionalLights;t.length?(this._mainLight=t[t.length-1],this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=t_.ROTATION)):this._mainLight=null}}addDirectionalLight(t){t.attachToScene(this),this._directionalLights.push(t)}removeDirectionalLight(t){for(let e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)}addSphereLight(t){t.attachToScene(this),this._sphereLights.push(t),qn.push(this._sphereLightsHandle,t.handle)}removeSphereLight(t){for(let e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),this._sphereLights.splice(e,1),void qn.erase(this._sphereLightsHandle,e)}addSpotLight(t){t.attachToScene(this),this._spotLights.push(t),qn.push(this._spotLightsHandle,t.handle)}removeSpotLight(t){for(let e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),this._spotLights.splice(e,1),void qn.erase(this._spotLightsHandle,e)}removeSphereLights(){for(let t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0,qn.clear(this._sphereLightsHandle)}removeSpotLights(){for(let t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[],qn.clear(this._spotLightsHandle)}addModel(t){t.attachToScene(this),this._models.push(t),kn.push(this._modelArrayHandle,t.handle)}removeModel(t){for(let e=0;e<this._models.length;++e)if(this._models[e]===t)return t.detachFromScene(),this._models.splice(e,1),void kn.erase(this._modelArrayHandle,e)}removeModels(){for(const t of this._models)t.detachFromScene(),t.destroy();this._models.length=0,kn.clear(this._modelArrayHandle)}addBatch(t){this._batches.push(t),Yn.push(this._batchArrayHandle,t.handle)}removeBatch(t){for(let e=0;e<this._batches.length;++e)if(this._batches[e]===t)return this._batches.splice(e,1),void Yn.erase(this._batchArrayHandle,e)}removeBatches(){this._batches.length=0,Yn.clear(this._batchArrayHandle)}onGlobalPipelineStateChanged(){for(const t of this._models)t.onGlobalPipelineStateChanged()}generateModelId(){return this._modelId++}_createHandles(){this._modelArrayHandle||(this._modelArrayHandle=kn.alloc(),this._scenePoolHandle=ds.alloc(),ds.set(this._scenePoolHandle,us.MODEL_ARRAY,this._modelArrayHandle),this._spotLightsHandle=qn.alloc(),ds.set(this._scenePoolHandle,us.SPOT_LIGHT_ARRAY,this._spotLightsHandle),this._sphereLightsHandle=qn.alloc(),ds.set(this._scenePoolHandle,us.SPHERE_LIGHT_ARRAY,this._sphereLightsHandle)),this._batchArrayHandle||(this._batchArrayHandle=Yn.alloc(),ds.set(this._scenePoolHandle,us.BATCH_ARRAY_2D,this._batchArrayHandle))}}function i_(t,e,i,n){i&&Object.defineProperty(t,e,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function n_(t,e,i,n,s){var r={};return Object.keys(n).forEach((function(t){r[t]=n[t]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=i.slice().reverse().reduce((function(i,n){return n(t,e,i)||i}),r),s&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(s):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(t,e,r),r=null),r}const s_=()=>{},r_=()=>s_,o_=a_((()=>{}));function a_(t){return function(e){return"function"==typeof e?t(e):function(i){return t(i,e)}}}function l_(t){return e=>i=>{!function(t,e,i){const n=h_(t);if(n){const t=__(n,"proto");__(t,"editor")[e]=i}}(i,t,e)}}const c_="__ccclassCache__";function h_(t){return __(t,c_)}function __(t,e){return t[e]||(t[e]={})}const u_=a_(((t,e)=>{let i=Vt.getSuper(t);i===Object&&(i=null);const n={name:e,extends:i,ctor:t},s=t[c_];if(s){const e=s.proto;e&&Vt.mixin(n,e),t[c_]=void 0}return Me(n)})),m_=l_("requireComponent"),d_=l_("executionOrder"),p_=o_;function f_(t,e,i){let n=null;function s(t,e,i){const s=h_(t.constructor);if(s){const r=__(s,"proto"),o=__(r,"properties");!function(t,e,i,n,s,r){let o;const a=s&&(s.get||s.set);n&&(o=Ae(n,a));const l=e[i],c=Vt.mixin(l||{},o||n||{});if(a)s.get&&(c.get=s.get),s.set&&(c.set=s.set);else if(s)s.initializer&&(c.default=function(t){let e;try{e=t()}catch(e){return t}return"object"!=typeof e||null===e?e:t}(s.initializer));else{const e=r.default||(r.default=function(t){let e;try{e=new t}catch(t){return{}}return e}(t));e.hasOwnProperty(i)&&(c.default=e[i])}e[i]=c}(t.constructor,o,e,n,i,s)}}return void 0===t?f_({type:void 0}):void 0===e?(n=t,s):void s(t,e,i)}const g_=(t,e,i)=>f_(v_({}))(t,e,i),y_=(t,e,i)=>f_({editorOnly:!0})(t,e,i);function v_(t){return t.__noImplicit=!0,"serializable"in t||(t.serializable=!0),t}const x_=o_,S_=r_,A_=o_,C_=r_,b_=r_,T_=r_,w_=s_,E_=r_,P_=r_,I_=r_,D_=r_,R_=r_,M_=r_,B_=r_,O_=s_,N_=r_,L_=s_,F_=s_,z_=H_(ue),V_=H_(me),U_=H_(de),G_=H_(pe);function H_(t){return f_({type:t})}const k_=(t,e,i)=>f_({__noImplicit:!0,override:!0})(t,e,i);class j_{constructor(t){this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=Vt.createMap(!0),this._count=0)}add(t,e){return t in this._map||this._count++,this._map[t]=e}get(t){return this._map[t]}has(t){return t in this._map}remove(t){const e=this._map[t];return t in this._map&&(delete this._map[t],this._count--),e}clear(){0!==this._count&&(this._map=Vt.createMap(!0),this._count=0)}forEach(t){for(const e in this._map)t(this._map[e],e)}find(t){for(const e in this._map)if(t(this._map[e],e))return this._map[e];return null}get count(){return this._count}destroy(){this._map=null}}class W_{constructor(t,e){this.id=W_._pipelineId++,this.name="",this.pipes=[],this.name=t;for(let t=0,i=e.length;t<i;t++)this.pipes.push(e[t])}insert(t,e){return e>this.pipes.length?(C(4921),this):(this.pipes.splice(e,0,t),this)}append(t){return this.pipes.push(t),this}remove(t){return this.pipes.splice(t,1),this}sync(t){const e=this.pipes;if(0===e.length)return null;t.isFinish=!1;for(let i=0,n=e.length;i<n;){const s=(0,e[i])(t);if(s)return t.isFinish=!0,s;i++,i!==n&&(t.input=t.output,t.output=null)}return t.isFinish=!0,t.output}async(t){0!==this.pipes.length&&(t.isFinish=!1,this._flow(0,t))}_flow(t,e){(0,this.pipes[t])(e,(i=>{i?(e.isFinish=!0,e.dispatch("complete",i)):++t<this.pipes.length?(e.input=e.output,e.output=null,this._flow(t,e)):(e.isFinish=!0,e.dispatch("complete",i,e.output))}))}}W_._pipelineId=0;const q_=new j_,X_=new j_,Y_=new j_,K_=new j_,J_=new W_("normal load",[]),$_=new W_("fetch",[]),Z_=new W_("transform url",[]);let Q_;!function(t){t.UUID="uuid",t.PATH="path",t.DIR="dir",t.URL="url",t.SCENE="scene"}(Q_||(Q_={}));const tu={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};let eu;!function(t){t.RESOURCES="resources",t.MAIN="main",t.START_SCENE="start-scene"}(eu||(eu={}));class iu{static create(t){let e;return 0!==iu._deadPool.length?(e=iu._deadPool.pop(),e.set(t)):e=new iu(t),e}constructor(t){this.id=iu._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}set(t=Object.create(null)){this.onComplete=t.onComplete||null,this.onProgress=t.onProgress||null,this.onError=t.onError||null,this.source=this.input=t.input,this.output=null,this.progress=t.progress,this.options=t.options||Object.create(null)}dispatch(t,e,i,n,s){switch(t){case"complete":this.onComplete&&this.onComplete(e,i);break;case"progress":this.onProgress&&this.onProgress(e,i,n,s);break;case"error":this.onError&&this.onError(e,i,n,s);break;default:{const r=`on${t[0].toUpperCase()}${t.substr(1)}`;"function"==typeof this[r]&&this[r](e,i,n,s);break}}}recycle(){iu._deadPool.length!==iu.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,iu._deadPool.push(this))}}iu.MAX_DEAD_NUM=500,iu._taskId=0,iu._deadPool=[];const nu="0123456789abcdef".split(""),su=["","","",""],ru=su.concat(su,"-",su,"-",su,"-",su,"-",su,su,su),ou=ru.map(((t,e)=>"-"===t?NaN:e)).filter(isFinite);function au(t){const e=t.split("@")[0];if(22!==e.length)return t;ru[0]=t[0],ru[1]=t[1];for(let e=2,i=2;e<22;e+=2){const n=Kt[t.charCodeAt(e)],s=Kt[t.charCodeAt(e+1)];ru[ou[i++]]=nu[n>>2],ru[ou[i++]]=nu[(3&n)<<2|s>>4],ru[ou[i++]]=nu[15&s]}return t.replace(e,ru.join(""))}const lu=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function cu(t){const e=lu.exec(t);return e?e[1]:""}function hu(t,e){(e=e||Object.create(null)).__isNative__=e.isNative,e.ext=e.nativeExt;const i=K_.find((e=>!!e.getAssetInfo(t)));return i&&(e.bundle=i.name),mu(t,e)}function _u(t){return t&&(t instanceof n.SceneAsset||t instanceof n.Scene)}function uu(t){return t&&(46===t.charCodeAt(0)&&47===t.charCodeAt(1)?t=t.slice(2):47===t.charCodeAt(0)&&(t=t.slice(1))),t}function mu(t,e){const i=iu.create({input:t,options:e}),n=[];try{const t=Z_.sync(i);for(const e of t){const t=e.url;e.recycle(),n.push(t)}}catch(t){for(const t of i.output)t.recycle();d(t.message,t.stack)}return i.recycle(),n.length>1?n:n[0]}var du,pu,fu,gu,yu=Object.freeze({__proto__:null,getUuidFromURL:cu,getUrlWithUuid:hu,isScene:_u,normalize:uu,transform:mu,decodeUuid:au});class vu{constructor(t,e){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!e}unuse(){this.type=vu.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=vu.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}reuse(t,e){this.type=t,this.bubbles=e||!1}isStopped(){return this.propagationStopped||this.propagationImmediateStopped}getCurrentTarget(){return this.currentTarget}getType(){return this.type}}t("Event",vu),vu.NO_TYPE="no_type",vu.TOUCH="touch",vu.MOUSE="mouse",vu.KEYBOARD="keyboard",vu.ACCELERATION="acceleration",vu.NONE=0,vu.CAPTURING_PHASE=1,vu.AT_TARGET=2,vu.BUBBLING_PHASE=3,n.Event=vu;let xu=t("Asset",u_("cc.Asset")((gu=class extends($i(Gi)){static deserialize(t){return n.deserialize(t)}get nativeUrl(){if(!this._nativeUrl){if(!this._native)return"";const t=this._native;if(47===t.charCodeAt(0))return t.slice(1);46===t.charCodeAt(0)?this._nativeUrl=hu(this._uuid,{nativeExt:t,isNative:!0}):this._nativeUrl=hu(this._uuid,{__nativeName__:t,nativeExt:pn(t),isNative:!0})}return this._nativeUrl}get _nativeAsset(){return this._file}set _nativeAsset(t){this._file=t}constructor(...t){super(...t),this.loaded=!0,i_(this,"_native",fu,this),this._nativeUrl="",this.__onLoadedInvoked__=!1,this.__nativeDepend__=null,this.__depends__=null,this._file=null,this._ref=0,Object.defineProperty(this,"_uuid",{value:"",writable:!0})}toString(){return this.nativeUrl}serialize(){}_setRawAsset(t,e=!0){this._native=!1!==e?t||"":`/${t}`}get _nativeDep(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}get refCount(){return this._ref}addRef(){return this._ref++,this}decRef(t=!0){return this._ref>0&&this._ref--,t&&n.assetManager._releaseManager.tryRelease(this),this}onLoaded(){}initDefault(t){t&&(this._uuid=t),this.isDefault=!0}validate(){return!0}},fu=n_((pu=gu).prototype,"_native",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),n_(pu.prototype,"_nativeAsset",[f_],Object.getOwnPropertyDescriptor(pu.prototype,"_nativeAsset"),pu.prototype),du=pu))||du);xu.prototype.createNode=null,n.Asset=xu;let Su,Au,Cu,bu=1024;var Tu,wu,Eu,Pu;function Iu(t){return n.sys.capabilities.imageBitmap&&t instanceof ImageBitmap}!function(t){t[t.RGB565=jr.R5G6B5]="RGB565",t[t.RGB5A1=jr.RGB5A1]="RGB5A1",t[t.RGBA4444=jr.RGBA4]="RGBA4444",t[t.RGB888=jr.RGB8]="RGB888",t[t.RGB32F=jr.RGB32F]="RGB32F",t[t.RGBA8888=jr.RGBA8]="RGBA8888",t[t.RGBA32F=jr.RGBA32F]="RGBA32F",t[t.A8=jr.A8]="A8",t[t.I8=jr.L8]="I8",t[t.AI8=jr.LA8]="AI8",t[t.RGB_PVRTC_2BPPV1=jr.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",t[t.RGBA_PVRTC_2BPPV1=jr.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",t[t.RGB_A_PVRTC_2BPPV1=bu++]="RGB_A_PVRTC_2BPPV1",t[t.RGB_PVRTC_4BPPV1=jr.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",t[t.RGBA_PVRTC_4BPPV1=jr.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",t[t.RGB_A_PVRTC_4BPPV1=bu++]="RGB_A_PVRTC_4BPPV1",t[t.RGB_ETC1=jr.ETC_RGB8]="RGB_ETC1",t[t.RGBA_ETC1=bu++]="RGBA_ETC1",t[t.RGB_ETC2=jr.ETC2_RGB8]="RGB_ETC2",t[t.RGBA_ETC2=jr.ETC2_RGBA8]="RGBA_ETC2",t[t.RGBA_ASTC_4x4=jr.ASTC_RGBA_4x4]="RGBA_ASTC_4x4",t[t.RGBA_ASTC_5x4=jr.ASTC_RGBA_5x4]="RGBA_ASTC_5x4",t[t.RGBA_ASTC_5x5=jr.ASTC_RGBA_5x5]="RGBA_ASTC_5x5",t[t.RGBA_ASTC_6x5=jr.ASTC_RGBA_6x5]="RGBA_ASTC_6x5",t[t.RGBA_ASTC_6x6=jr.ASTC_RGBA_6x6]="RGBA_ASTC_6x6",t[t.RGBA_ASTC_8x5=jr.ASTC_RGBA_8x5]="RGBA_ASTC_8x5",t[t.RGBA_ASTC_8x6=jr.ASTC_RGBA_8x6]="RGBA_ASTC_8x6",t[t.RGBA_ASTC_8x8=jr.ASTC_RGBA_8x8]="RGBA_ASTC_8x8",t[t.RGBA_ASTC_10x5=jr.ASTC_RGBA_10x5]="RGBA_ASTC_10x5",t[t.RGBA_ASTC_10x6=jr.ASTC_RGBA_10x6]="RGBA_ASTC_10x6",t[t.RGBA_ASTC_10x8=jr.ASTC_RGBA_10x8]="RGBA_ASTC_10x8",t[t.RGBA_ASTC_10x10=jr.ASTC_RGBA_10x10]="RGBA_ASTC_10x10",t[t.RGBA_ASTC_12x10=jr.ASTC_RGBA_12x10]="RGBA_ASTC_12x10",t[t.RGBA_ASTC_12x12=jr.ASTC_RGBA_12x12]="RGBA_ASTC_12x12"}(Su||(Su={})),function(t){t[t.REPEAT=io.WRAP]="REPEAT",t[t.CLAMP_TO_EDGE=io.CLAMP]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=io.MIRROR]="MIRRORED_REPEAT",t[t.CLAMP_TO_BORDER=io.BORDER]="CLAMP_TO_BORDER"}(Au||(Au={})),function(t){t[t.NONE=eo.NONE]="NONE",t[t.LINEAR=eo.LINEAR]="LINEAR",t[t.NEAREST=eo.POINT]="NEAREST"}(Cu||(Cu={}));let Du,Ru=t("ImageAsset",u_("cc.ImageAsset")((Pu=Eu=class t extends xu{get _nativeAsset(){return this._nativeData}set _nativeAsset(t){t instanceof HTMLElement||Iu(t)||(t.format=t.format||this._format),this.reset(t)}get data(){return this._nativeData&&!0!==(t=this._nativeData)._compressed&&(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||Iu(t))?this._nativeData:this._nativeData&&this._nativeData._data;var t}get width(){return this._nativeData.width||this._width}get height(){return this._nativeData.height||this._height}get format(){return this._format}get isCompressed(){return this._format>=Su.RGB_ETC1&&this._format<=Su.RGBA_ASTC_12x12||this._format>=Su.RGB_A_PVRTC_2BPPV1&&this._format<=Su.RGBA_ETC1}get url(){return this.nativeUrl}set _texture(t){this._tex=t}get _texture(){if(!this._tex){const t=new n.Texture2D;t.name=this.nativeUrl,t.image=this,this._tex=t}return this._tex}constructor(t){super(),this._nativeData=void 0,this._tex=void 0,this._exportedExts=void 0,this._format=Su.RGBA8888,this._width=0,this._height=0,this.loaded=!1,this._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&this.reset(t)}reset(t){Iu(t)?(this._nativeData=t,this._onDataComplete()):t instanceof HTMLElement?(this._nativeData=t,t.complete||t instanceof HTMLCanvasElement?this._onDataComplete():(this.loaded=!1,t.addEventListener("load",(()=>{this._onDataComplete()})),t.addEventListener("error",(t=>{C(3119,t.message)})))):(this._nativeData=t,this._format=t.format,this._onDataComplete())}destroy(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset(""),this.data.destroy()):Iu(this.data)&&this.data.close&&this.data.close(),super.destroy()}_serialize(){}_deserialize(e){let i="";"string"==typeof e?i=e:(this._width=e.w,this._height=e.h,i=e.fmt);const s=n.director.root?n.director.root.device:null,r=i.split("_");let o="",a=Number.MAX_VALUE,l=this._format,c="";const h=n.macro.SUPPORT_TEXTURE_FORMATS;for(const e of r){const i=e.split("@"),r=parseInt(i[0],void 0),_=t.extnames[r]||i[0],u=h.indexOf(_);if(-1!==u&&u<a){const t=i[1]?parseInt(i[1]):this._format;if(!(".astc"!==_||s&&s.hasFeature(kr.FORMAT_ASTC)))continue;if(!(".pvr"!==_||s&&s.hasFeature(kr.FORMAT_PVRTC)))continue;if(!(t!==Su.RGB_ETC1&&t!==Su.RGBA_ETC1||s&&s.hasFeature(kr.FORMAT_ETC1)))continue;if(!(t!==Su.RGB_ETC2&&t!==Su.RGBA_ETC2||s&&s.hasFeature(kr.FORMAT_ETC2)))continue;if(".webp"===_&&!n.sys.capabilities.webp)continue;a=u,c=_,l=t}else o||(o=_)}c?(this._setRawAsset(c),this._format=l):o?(this._setRawAsset(o),C(3120,o,o)):C(3121)}_onDataComplete(){this.loaded=!0,this.emit("load")}initDefault(e){if(super.initDefault(e),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{const e=document.createElement("canvas"),i=e.getContext("2d"),n=e.width=e.height=2;i.fillStyle="#ff00ff",i.fillRect(0,0,n,n),this.reset(e),t._sharedPlaceHolderCanvas=e}}validate(){return!!this.data}},Eu.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Eu._sharedPlaceHolderCanvas=null,n_((wu=Pu).prototype,"_nativeAsset",[k_],Object.getOwnPropertyDescriptor(wu.prototype,"_nativeAsset"),wu.prototype),Tu=wu))||Tu);n.ImageAsset=Ru,function(t){t[t.minFilter=0]="minFilter",t[t.magFilter=1]="magFilter",t[t.mipFilter=2]="mipFilter",t[t.addressU=3]="addressU",t[t.addressV=4]="addressV",t[t.addressW=5]="addressW",t[t.maxAnisotropy=6]="maxAnisotropy",t[t.cmpFunc=7]="cmpFunc",t[t.mipLODBias=8]="mipLODBias",t[t.total=9]="total"}(Du||(Du={}));const Mu=[eo.LINEAR,eo.LINEAR,eo.NONE,io.WRAP,io.WRAP,io.WRAP,0,no.NEVER,0],Bu=Lu(Mu),Ou=new Lo,Nu=new Wo;function Lu(t){let e=0,i=0;for(let n=0;n<Mu.length;n++)switch(e=t[n]||Mu[n],n){case Du.minFilter:i|=e;break;case Du.magFilter:i|=e<<2;break;case Du.mipFilter:i|=e<<4;break;case Du.addressU:i|=e<<6;break;case Du.addressV:i|=e<<8;break;case Du.addressW:i|=e<<10;break;case Du.maxAnisotropy:i|=e<<12;break;case Du.cmpFunc:i|=e<<16;break;case Du.mipLODBias:i|=e<<28}return i}const Fu=new class{constructor(){this._cache={}}getSampler(t,e){e||(e=Bu);const i=this._cache[e];return i||(Nu.minFilter=3&e,Nu.magFilter=e>>2&3,Nu.mipFilter=e>>4&3,Nu.addressU=e>>6&3,Nu.addressV=e>>8&3,Nu.addressW=e>>10&3,Nu.maxAnisotropy=e>>12&15,Nu.cmpFunc=e>>16&15,Nu.mipLODBias=e>>28&15,Nu.borderColor=Ou,this._cache[e]=t.createSampler(Nu))}};var zu,Vu,Uu,Gu,Hu,ku,ju,Wu,qu,Xu,Yu,Ku;n.samplerLib=Fu;const Ju=new Q("Tex");let $u=u_("cc.TextureBase")((Ku=Yu=class extends xu{get isCompressed(){return this._format>=Su.RGB_ETC1&&this._format<=Su.RGBA_ASTC_12x12||this._format>=Su.RGB_A_PVRTC_2BPPV1&&this._format<=Su.RGBA_ETC1}get width(){return this._width}get height(){return this._height}constructor(){super(),i_(this,"_format",Uu,this),i_(this,"_minFilter",Gu,this),i_(this,"_magFilter",Hu,this),i_(this,"_mipFilter",ku,this),i_(this,"_wrapS",ju,this),i_(this,"_wrapT",Wu,this),i_(this,"_wrapR",qu,this),i_(this,"_anisotropy",Xu,this),this._width=1,this._height=1,this._id=void 0,this._samplerInfo=[],this._samplerHash=0,this._gfxSampler=null,this._gfxDevice=null,this._textureHash=0,this._id=Ju.getNewId(),this.loaded=!1,this._gfxDevice=this._getGFXDevice(),this._textureHash=qa(this._id,666)}getId(){return this._id}getPixelFormat(){return this._format}getAnisotropy(){return this._anisotropy}setWrapMode(t,e,i){this._wrapS=t,this._samplerInfo[Du.addressU]=t,this._wrapT=e,this._samplerInfo[Du.addressV]=e,void 0!==i&&(this._wrapR=i,this._samplerInfo[Du.addressW]=i),this._samplerHash=Lu(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Fu.getSampler(this._gfxDevice,this._samplerHash))}setFilters(t,e){this._minFilter=t,this._samplerInfo[Du.minFilter]=t,this._magFilter=e,this._samplerInfo[Du.magFilter]=e,this._samplerHash=Lu(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Fu.getSampler(this._gfxDevice,this._samplerHash))}setMipFilter(t){this._mipFilter=t,this._samplerInfo[Du.mipFilter]=t,this._samplerHash=Lu(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Fu.getSampler(this._gfxDevice,this._samplerHash))}setAnisotropy(t){this._anisotropy=t,this._samplerInfo[Du.maxAnisotropy]=t,this._samplerHash=Lu(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Fu.getSampler(this._gfxDevice,this._samplerHash))}destroy(){const t=super.destroy();return t&&n.director.root&&n.director.root.batcher2D&&n.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),t}getHash(){return this._textureHash}getGFXTexture(){return null}getSamplerHash(){return this._samplerHash}getGFXSampler(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=Fu.getSampler(this._gfxDevice,this._samplerHash):T(9302)),this._gfxSampler}_serialize(t){return""}_deserialize(t,e){const i=t.split(",");i.unshift(""),i.length>=5&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4]))),i.length>=7&&(this.setMipFilter(parseInt(i[5])),this.setAnisotropy(parseInt(i[6])))}_getGFXDevice(){return n.director.root?n.director.root.device:null}_getGFXFormat(){return this._getGFXPixelFormat(this._format)}_setGFXFormat(t){this._format=void 0===t?Su.RGBA8888:t}_getGFXPixelFormat(t){return t===Su.RGBA_ETC1?t=Su.RGB_ETC1:t===Su.RGB_A_PVRTC_4BPPV1?t=Su.RGB_PVRTC_4BPPV1:t===Su.RGB_A_PVRTC_2BPPV1&&(t=Su.RGB_PVRTC_2BPPV1),t}},Yu.PixelFormat=Su,Yu.WrapMode=Au,Yu.Filter=Cu,Uu=n_((Vu=Ku).prototype,"_format",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Su.RGBA8888}}),Gu=n_(Vu.prototype,"_minFilter",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cu.LINEAR}}),Hu=n_(Vu.prototype,"_magFilter",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cu.LINEAR}}),ku=n_(Vu.prototype,"_mipFilter",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cu.NONE}}),ju=n_(Vu.prototype,"_wrapS",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Au.REPEAT}}),Wu=n_(Vu.prototype,"_wrapT",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Au.REPEAT}}),qu=n_(Vu.prototype,"_wrapR",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Au.REPEAT}}),Xu=n_(Vu.prototype,"_anisotropy",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zu=Vu))||zu;n.TextureBase=$u;const Zu=[Ti,oi,Ii,mi,si,Mi,Oi,Si];function Qu(t,e){t.x=e[1],t.y=e[2],t.z=e[3],t.w=e[4]}const tm=[(t,e)=>{t.x=e[1],t.y=e[2]},(t,e)=>{t.x=e[1],t.y=e[2],t.z=e[3]},Qu,Qu,(t,e)=>{t._val=e[1]},(t,e)=>{t.width=e[1],t.height=e[2]},(t,e)=>{t.x=e[1],t.y=e[2],t.width=e[3],t.height=e[4]},(t,e)=>{Si.fromArray(t,e,1)}];class em{constructor(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}init(t){this.uuidObjList=t[8],this.uuidPropList=t[9],this.uuidList=t[10]}reset(){this.uuidList=null,this.uuidObjList=null,this.uuidPropList=null}push(t,e,i,n){this.uuidObjList.push(t),this.uuidPropList.push(e),this.uuidList.push(i),this.uuidTypeList.push(n||"")}}function im(t,e){const i=t[4][e[0]],n=i[0],s=new(0,n[0]),r=n[1],o=n[2],a=i[i.length-1];let l=1;for(;l<a;++l)s[r[i[l]]]=e[l];for(;l<e.length;++l){const a=r[i[l]],c=n[i[l]+o];(0,lm[c])(t,s,a,e[l])}return s}function nm(t,e,i){const n=new e;return n._deserialize?n._deserialize(i,t[0]):T(5303,_t(e)),n}function sm(t,e,i,n){n>=0?e[i]=t[5][n]:t[7][3*~n]=e}function rm(t){return(e,i,n,s)=>{i[n]=s;for(let i=0;i<s.length;++i)t(e,s,i,s[i])}}function om(t,e,i,n){e[i]=null,t[8][n]=e}function am(t,e,i,n){e[i]=im(t,n)}t("Details",em),em.pool=new Ft((t=>{t.reset()}),5),em.pool.get=function(){return this._get()||new em};const lm=new Array(13);function cm(t,e){return t||mm.reportMissingClass(e),Object}function hm(t,e,i,n,s,r){let o=t(e);if(!o){if(s)return void(i[n]=(a=i,l=n,c=e,function(){const e=t(c)||cm(r,c);return a[l]=e,new e}));o=cm(r,e)}var a,l,c;i[n]=o}function _m(t,e,i){const n=i||Ot,s=t[3];for(let t=0;t<s.length;++t){const r=s[t];"string"!=typeof r?hm(n,r[0],r,0,e,i):hm(n,r,s,t,e,i)}}function um(t){const e=t[4];if(e){const i=t[3];for(let t=0;t<e.length;++t){const n=e[t];n[0]=i[n[0]]}}}function mm(t,e,i){"string"==typeof t&&(t=JSON.parse(t));const s=!e;let r;{(e=e||em.pool.get()).init(t),i=i||{};let s=t[0],l=!1;if("object"==typeof s&&(l=s.preprocessed,s=s.version),s<1)throw new Error(I(5304,s));i._version=s,i.result=e,t[0]=i,l||(_m(t,!1,i.classFinder),um(t)),n.game._isCloning=!0;const c=t[5],h=function(t){const e=t[5],i=t[6],n=0===i?0:i.length;let s=e[e.length-1],r=e.length-n;"number"!=typeof s?s=0:(s<0&&(s=~s),--r);let o=0;for(;o<r;++o)e[o]=im(t,e[o]);const a=t[3];for(let s=0;s<n;++s,++o){let n=i[s];const r=e[o];if(n>=0){const i=a[n];e[o]=nm(t,i,r)}else n=~n,(0,lm[n])(t,e,o,r)}return s}(t);n.game._isCloning=!1,t[7]&&function(t,e,i){const n=t.length-1;let s=0;const r=3*t[n];for(;s<r;s+=3){const n=t[s],r=e[t[s+2]],o=t[s+1];o>=0?n[i[o]]=r:n[~o]=r}for(;s<n;s+=3){const n=e[t[s]],r=e[t[s+2]],o=t[s+1];o>=0?n[i[o]]=r:n[~o]=r}}(t[7],c,t[2]),function(t){const e=t[5],i=t[2],n=t[1],s=t[8],r=t[9],o=t[10];for(let t=0;t<s.length;++t){const a=s[t];"number"==typeof a&&(s[t]=e[a]);let l=r[t];"number"==typeof l&&(l=l>=0?i[l]:~l,r[t]=l);const c=o[t];"number"==typeof c&&(o[t]=n[c])}}(t);for(let t=0;t<c.length;++t){var o,a;null===(o=c[t])||void 0===o||null===(a=o.onAfterDeserialize_JSB)||void 0===a||a.call(o)}r=c[h]}return s&&em.pool.put(e),r}lm[0]=function(t,e,i,n){e[i]=n},lm[1]=sm,lm[2]=rm(sm),lm[3]=rm(om),lm[4]=am,lm[5]=function(t,e,i,n){tm[n[0]](e[i],n)},lm[6]=om,lm[7]=function(t,e,i,n){e[i].set(n)},lm[8]=function(t,e,i,n){const s=new Zu[n[0]];tm[n[0]](s,n),e[i]=s},lm[9]=rm(am),lm[10]=function(t,e,i,n){const s=t[3][n[0]];e[i]=nm(t,s,n[1])},lm[11]=function(t,e,i,n){const s=n[0];e[i]=s;for(let e=1;e<n.length;e+=3){const i=n[e],r=n[e+1],o=n[e+2];(0,lm[r])(t,s,i,o)}},lm[12]=function(t,e,i,n){const s=n[0];e[i]=s;for(let e=0;e<s.length;++e){const i=s[e],r=n[e+1];0!==r&&(0,lm[r])(t,s,e,i)}},mm.Details=em,mm.reportMissingClass=t=>{C(5302,t)};class dm{constructor(t){this.preprocessed=!0,this.version=t}}function pm(t,e,i){return[1,0,0,[t],0,i?[e,-1]:[e],[0],0,[],[],[]]}var fm,gm,ym;n.deserialize=mm;let vm=t("Script",u_("cc.Script")(fm=class extends xu{})||fm);n._Script=vm;let xm=t("JavaScript",u_("cc.JavaScript")(gm=class extends vm{})||gm);n._JavaScript=xm;let Sm=t("TypeScript",u_("cc.TypeScript")(ym=class extends vm{})||ym);var Am,Cm,bm,Tm,wm,Em,Pm,Im,Dm,Rm,Mm;n._TypeScript=Sm;const Bm=new Q("Comp"),Om=Gi.Flags.IsOnLoadCalled;let Nm=t("Component",(Am=u_("cc.Component"),Cm=P_(),bm=H_(vm),Tm=I_(),Am((Mm=Rm=class extends Gi{constructor(...t){super(...t),i_(this,"node",Pm,this),i_(this,"_enabled",Im,this),i_(this,"__prefab",Dm,this),this._sceneGetter=null,this._id=Bm.getNewId()}get name(){if(this._name)return this._name;let t=_t(this);const e=t.lastIndexOf(".");return e>=0&&(t=t.slice(e+1)),`${this.node.name}<${t}>`}set name(t){this._name=t}get uuid(){return this._id}get __scriptAsset(){return null}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&(this._enabled=t,this.node.activeInHierarchy)){const e=n.director._compScheduler;t?e.enableComp(this):e.disableComp(this)}}get enabledInHierarchy(){return this._enabled&&this.node&&this.node.activeInHierarchy}get _isOnLoadCalled(){return this._objFlags&Om}_getRenderScene(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}addComponent(t){return this.node.addComponent(t)}getComponent(t){return this.node.getComponent(t)}getComponents(t){return this.node.getComponents(t)}getComponentInChildren(t){return this.node.getComponentInChildren(t)}getComponentsInChildren(t){return this.node.getComponentsInChildren(t)}destroy(){return!!super.destroy()&&(this._enabled&&this.node.activeInHierarchy&&n.director._compScheduler.disableComp(this),!0)}_onPreDestroy(){this.unscheduleAllCallbacks(),n.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}_instantiate(t){return t||(t=n.instantiate._clone(this,this)),t&&(t.node=null),t}schedule(t,e=0,i=n.macro.REPEAT_FOREVER,s=0){E(t,1619),E((e=e||0)>=0,1620),i=Number.isNaN(i)?n.macro.REPEAT_FOREVER:i,s=s||0;const r=n.director.getScheduler(),o=r.isTargetPaused(this);r.schedule(t,this,e,i,s,o)}scheduleOnce(t,e=0){this.schedule(t,0,0,e)}unschedule(t){t&&n.director.getScheduler().unschedule(t,this)}unscheduleAllCallbacks(){n.director.getScheduler().unscheduleAllForTarget(this)}},Rm.system=null,n_((Em=Mm).prototype,"__scriptAsset",[Cm,bm,Tm,F_],Object.getOwnPropertyDescriptor(Em.prototype,"__scriptAsset"),Em.prototype),Pm=n_(Em.prototype,"node",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Im=n_(Em.prototype,"_enabled",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Dm=n_(Em.prototype,"__prefab",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wm=Em))||wm));const Lm=Nm.prototype;var Fm,zm,Vm;Lm.update=null,Lm.lateUpdate=null,Lm.__preload=null,Lm.onLoad=null,Lm.start=null,Lm.onEnable=null,Lm.onDisable=null,Lm.onDestroy=null,Lm.onFocusInEditor=null,Lm.onLostFocusInEditor=null,Lm.resetInEditor=null,Lm._getLocalBounds=null,Lm.onRestore=null,Nm._requireComponent=null,Nm._executionOrder=0,ot(Nm,"_registerEditorProps",((t,e)=>{const i=e.requireComponent;i&&(t._requireComponent=i);const n=e.executionOrder;n&&"number"==typeof n&&(t._executionOrder=n)})),n.Component=Nm;let Um=t("MissingScript",u_("cc.MissingScript")(Fm=C_()((Vm=n_((zm=class extends Nm{static safeFindClass(t){const e=Ot(t);if(e)return e;n.deserialize.reportMissingClass(t)}constructor(){super(),i_(this,"_$erialized",Vm,this)}onLoad(){C(4600,this.node.name)}}).prototype,"_$erialized",[g_,y_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fm=zm))||Fm)||Fm);function Gm(t,e){let i;i=Um.safeFindClass;const n=em.pool.get();let s;try{s=mm(t,n,{classFinder:i,customEnv:e})}catch(t){throw d(t),em.pool.put(n),t}s._uuid=e.__uuid__||"";const r=n.uuidList,o=n.uuidObjList,a=n.uuidPropList,l=n.uuidTypeList||[],c=[];for(let t=0;t<r.length;t++){const e=r[t];c[t]={uuid:au(e),owner:o[t],prop:a[t],type:Vt._getClassById(l[t])}}return s.__depends__=c,s._native&&(s.__nativeDepend__=!0),em.pool.put(n),s}n._MissingScript=Um;var Hm,km=new class{constructor(){this._depends=new j_}init(){this._depends.clear()}getNativeDep(t){const e=this._depends.get(t);return e&&e.nativeDep?{...e.nativeDep}:null}getDeps(t){return this._depends.has(t)?this._depends.get(t).deps:[]}getDepsRecursively(t){const e=Object.create(null),i=[];return this._descend(t,e,i),i}remove(t){this._depends.remove(t)}parse(t,e){let i=null;if(Array.isArray(e)||e.__type__){if(this._depends.has(t))return this._depends.get(t);if(Array.isArray(e)&&!function(t){const e=t[5],i=e[e.length-1];return"number"==typeof i&&i<0}(e))i={deps:this._parseDepsFromJson(e)};else try{const n=Gm(e,{__uuid__:t});i=this._parseDepsFromAsset(n),i.nativeDep&&(i.nativeDep.uuid=t),Y_.add(`${t}@import`,n)}catch(e){X_.remove(`${t}@import`),i={deps:[]}}}else{if(this._depends.has(t)&&(i=this._depends.get(t),i.parsedFromExistAsset))return i;i=this._parseDepsFromAsset(e)}return this._depends.add(t,i),i}_parseDepsFromAsset(t){const e={deps:[],parsedFromExistAsset:!0},i=t.__depends__;for(let t=0,n=i.length;t<n;t++)e.deps.push(i[t].uuid);return t.__nativeDepend__&&(e.nativeDep=t._nativeDep),e}_parseDepsFromJson(t){let e=null;return e=function(t){const e=t[1];return t[10].map((t=>e[t]))}(t),e.forEach(((t,i)=>e[i]=au(t))),e}_descend(t,e,i){const n=this.getDeps(t);for(let t=0;t<n.length;t++){const s=n[t];e[s]||(e[s]=!0,i.push(s),this._descend(s,e,i))}}};const jm=[new Oo];function Wm(t){return t&&0==(t&t-1)}let qm=u_("cc.SimpleTexture")(Hm=class extends $u{constructor(...t){super(...t),this._gfxTexture=null,this._mipmapLevel=1,this._textureWidth=0,this._textureHeight=0}get mipmapLevel(){return this._mipmapLevel}getGFXTexture(){return this._gfxTexture}destroy(){return this._tryDestroyTexture(),super.destroy()}updateImage(){this.updateMipmaps(0)}updateMipmaps(t=0,e){}uploadData(t,e=0,i=0){if(!this._gfxTexture||this._mipmapLevel<=e)return;const n=this._getGFXDevice();if(!n)return;const s=jm[0];s.texExtent.width=this._textureWidth>>e,s.texExtent.height=this._textureHeight>>e,s.texSubres.mipLevel=e,s.texSubres.baseArrayLayer=i,ArrayBuffer.isView(t)?n.copyBuffersToTexture([t],this._gfxTexture,jm):n.copyTexImagesToTexture([t],this._gfxTexture,jm)}_assignImage(t,e,i){const s=()=>{const n=t.data;if(n&&(this.uploadData(n,e,i),this._checkTextureLoaded(),qt.CLEANUP_IMAGE_CACHE)){const e=km.getDeps(this._uuid),i=e.indexOf(t._uuid);-1!==i&&(K(e,i),t.decRef())}};if(t.loaded)s();else{if(t.once("load",(()=>{s()})),!this.isCompressed){const t=n.builtinResMgr.get("black-texture").image;this.uploadData(t.data,e,i)}n.assetManager.postLoadNative(t)}}_checkTextureLoaded(){this._textureReady()}_textureReady(){this.loaded=!0,this.emit("load")}_setMipmapLevel(t){this._mipmapLevel=t<1?1:t}_getGfxTextureCreateInfo(t){return null}_tryReset(){if(this._tryDestroyTexture(),0===this._mipmapLevel)return;const t=this._getGFXDevice();t&&this._createTexture(t)}_createTexture(t){if(0===this._width||0===this._height)return;let e=Qr.NONE;this._mipFilter!==Cu.NONE&&function(t,e,i){return!(t.gfxAPI===Gr.WEBGL)||Wm(e)&&Wm(i)}(t,this._width,this._height)&&(this._mipmapLevel=function(t,e){let i=Math.max(t,e),n=0;for(;i;)i>>=1,n++;return n}(this._width,this._height),e=Qr.GEN_MIPMAP);const i=this._getGfxTextureCreateInfo({usage:Zr.SAMPLED|Zr.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:e|Qr.IMMUTABLE});if(!i)return;const n=t.createTexture(i);this._textureWidth=i.width,this._textureHeight=i.height,this._gfxTexture=n}_tryDestroyTexture(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)}})||Hm;var Xm,Ym,Km,Jm,$m;n.SimpleTexture=qm;let Zm=t("Texture2D",(Xm=u_("cc.Texture2D"),Ym=H_([Ru]),Xm(($m=n_((Jm=class extends qm{constructor(...t){super(...t),i_(this,"_mipmaps",$m,this)}get mipmaps(){return this._mipmaps}set mipmaps(t){if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){const t=this._mipmaps[0];this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(((t,e)=>{this._assignImage(t,e)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(t){this.mipmaps=t?[t]:[]}initialize(){this.mipmaps=this._mipmaps}onLoaded(){this.initialize()}reset(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()}create(t,e,i=Su.RGBA8888,n=1){this.reset({width:t,height:e,format:i,mipmapLevel:n})}toString(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}updateMipmaps(t=0,e){if(t>=this._mipmaps.length)return;const i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t);for(let e=0;e<i;++e){const i=t+e;this._assignImage(this._mipmaps[i],i)}}getHtmlElementObj(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}destroy(){return this._mipmaps=[],super.destroy()}description(){return`<cc.Texture2D | Name = ${this._mipmaps[0]?this._mipmaps[0].url:""} | Dimension = ${this.width} x ${this.height}>`}releaseTexture(){this.destroy()}_serialize(t){return null}_deserialize(t,e){const i=t;super._deserialize(i.base,e),this._mipmaps=new Array(i.mipmaps.length);for(let t=0;t<i.mipmaps.length;++t){if(this._mipmaps[t]=new Ru,!i.mipmaps[t])continue;const n=i.mipmaps[t];e.result.push(this._mipmaps,`${t}`,n,Vt._getClassId(Ru)),this._mipmaps[t]._texture=this}}_getGfxTextureCreateInfo(t){const e=new ko($r.TEX2D);return e.width=this._width,e.height=this._height,Object.assign(e,t)}_checkTextureLoaded(){let t=!0;for(let e=0;e<this._mipmaps.length;++e)if(!this._mipmaps[e].loaded){t=!1;break}t&&super._textureReady()}initDefault(t){super.initDefault(t);const e=new Ru;e.initDefault(),this.image=e}validate(){return this.mipmaps&&0!==this.mipmaps.length}}).prototype,"_mipmaps",[Ym],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Km=Jm))||Km));var Qm,td,ed,id,nd,sd;n.Texture2D=Zm,function(t){t[t.right=0]="right",t[t.left=1]="left",t[t.top=2]="top",t[t.bottom=3]="bottom",t[t.front=4]="front",t[t.back=5]="back"}(sd||(sd={}));let rd=t("TextureCube",u_("cc.TextureCube")((nd=id=class t extends qm{constructor(...t){super(...t),i_(this,"_mipmaps",ed,this)}get mipmaps(){return this._mipmaps}set mipmaps(t){if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){const t=this._mipmaps[0].front;this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(((t,e)=>{od(t,((t,i)=>{this._assignImage(t,e,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(t){this.mipmaps=t?[t]:[]}static fromTexture2DArray(e,i){const n=[],s=e.length/6;for(let t=0;t<s;t++){const i=6*t;n.push({front:e[i+sd.front].image,back:e[i+sd.back].image,left:e[i+sd.left].image,right:e[i+sd.right].image,top:e[i+sd.top].image,bottom:e[i+sd.bottom].image})}return(i=i||new t).mipmaps=n,i}onLoaded(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}reset(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()}updateMipmaps(t=0,e){if(t>=this._mipmaps.length)return;const i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t);for(let e=0;e<i;++e){const i=t+e;od(this._mipmaps[i],((t,e)=>{this._assignImage(t,i,e)}))}}destroy(){return this._mipmaps=[],super.destroy()}releaseTexture(){this.mipmaps=[]}_serialize(t){return null}_deserialize(t,e){const i=t;super._deserialize(i.base,e),this._mipmaps=new Array(i.mipmaps.length);for(let t=0;t<i.mipmaps.length;++t){this._mipmaps[t]={front:new Ru,back:new Ru,left:new Ru,right:new Ru,top:new Ru,bottom:new Ru};const n=i.mipmaps[t],s=Vt._getClassId(Ru);e.result.push(this._mipmaps[t],"front",n.front,s),e.result.push(this._mipmaps[t],"back",n.back,s),e.result.push(this._mipmaps[t],"left",n.left,s),e.result.push(this._mipmaps[t],"right",n.right,s),e.result.push(this._mipmaps[t],"top",n.top,s),e.result.push(this._mipmaps[t],"bottom",n.bottom,s)}}_getGfxTextureCreateInfo(t){const e=new ko($r.CUBE);return e.width=this._width,e.height=this._height,e.layerCount=6,Object.assign(e,t),e}initDefault(t){super.initDefault(t);const e=new Ru;e.initDefault(),this.mipmaps=[{front:e,back:e,top:e,bottom:e,left:e,right:e}]}validate(){return 0!==this._mipmaps.length&&!this._mipmaps.find((t=>!(t.top&&t.bottom&&t.front&&t.back&&t.left&&t.right)))}},id.FaceIndex=sd,ed=n_((td=nd).prototype,"_mipmaps",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qm=td))||Qm);function od(t,e){e(t.front,sd.front),e(t.back,sd.back),e(t.left,sd.left),e(t.right,sd.right),e(t.top,sd.top),e(t.bottom,sd.bottom)}n.TextureCube=rd;const ad=t("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:456146524,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:50,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:1062464958,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0}]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:3946667351,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_dist",type:13,count:1,defines:[],stageFlags:1,format:11,location:2}]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:932177378,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],attributes:[{name:"a_position_starttime",type:16,count:1,defines:[],stageFlags:1,format:44,location:0},{name:"a_size_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_rotation_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_dir_life",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_rndSeed",type:13,count:1,defines:[],stageFlags:1,format:11,location:5},{name:"a_texCoord",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_color1",type:16,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:44,location:9}]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:293909391,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4}]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:3802928649,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_color1",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7}]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:2041444135,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color2",type:16,count:1,defines:["TWO_COLORED"],stageFlags:1,format:44,location:3}]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1142786345,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"deferred",propertyIndex:0,blendState:{targets:[{blend:!1},{blend:!1},{blend:!1},{blend:!1}]},program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:632993342,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:216,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:14}]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:1518991842,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:179,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:22},globals:{blocks:[{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:13}]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"deferred",propertyIndex:0,blendState:{targets:[{blend:!1},{blend:!1},{blend:!1},{blend:!1}]},program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:2532494361,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:64,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:55},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3874167763,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:62,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3579616855,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:195,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13}]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:4181944545,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:37,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:53},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_gbuffer_albedoMap",defines:[]},{name:"cc_gbuffer_positionMap",defines:[]},{name:"cc_gbuffer_normalMap",defines:[]},{name:"cc_gbuffer_emissiveMap",defines:[]}]},locals:{blocks:[{name:"CCForwardLight",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_USE_FOG",type:"number",range:[0,4]}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:3940098901,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:210,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:53},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12}]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:2054814724,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:145,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_lighting_resultMap",defines:[]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7}]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:553035852,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:37,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplerTextures:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:3108604430,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:58,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1}]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},precent:{value:[.5],type:13,handleInfo:["u_buffer0",2,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,.5,0]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:624029864,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:14,count:1,defines:[],stageFlags:1,format:21,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1}]}]}]),ld=4026531840,cd=264241152,hd=3145728,_d=1032192;let ud;!function(t){t[t.BUFFER=0]="BUFFER",t[t.TEXTURE=1]="TEXTURE"}(ud||(ud={}));const md=(t,e,i,n,s=0)=>t<<28&ld|n<<22&cd|e<<20&hd|i<<14&_d|16383&s,dd=t=>(t&ld)>>>28,pd=t=>(t&cd)>>>22,fd=t=>(t&_d)>>>14,gd=t=>16383&t,yd=(t,e)=>t&~cd|e<<22&cd,vd={[qr.UNKNOWN]:()=>console.warn("illegal uniform handle"),[qr.INT]:(t,e,i=0)=>t[i],[qr.INT2]:(t,e,i=0)=>Ti.fromArray(e,t,i),[qr.INT3]:(t,e,i=0)=>oi.fromArray(e,t,i),[qr.INT4]:(t,e,i=0)=>Ii.fromArray(e,t,i),[qr.FLOAT]:(t,e,i=0)=>t[i],[qr.FLOAT2]:(t,e,i=0)=>Ti.fromArray(e,t,i),[qr.FLOAT3]:(t,e,i=0)=>oi.fromArray(e,t,i),[qr.FLOAT4]:(t,e,i=0)=>Ii.fromArray(e,t,i),[qr.MAT3]:(t,e,i=0)=>hi.fromArray(e,t,i),[qr.MAT4]:(t,e,i=0)=>Si.fromArray(e,t,i)},xd={[qr.UNKNOWN]:()=>console.warn("illegal uniform handle"),[qr.INT]:(t,e,i=0)=>t[i]=e,[qr.INT2]:(t,e,i=0)=>Ti.toArray(t,e,i),[qr.INT3]:(t,e,i=0)=>oi.toArray(t,e,i),[qr.INT4]:(t,e,i=0)=>Ii.toArray(t,e,i),[qr.FLOAT]:(t,e,i=0)=>t[i]=e,[qr.FLOAT2]:(t,e,i=0)=>Ti.toArray(t,e,i),[qr.FLOAT3]:(t,e,i=0)=>oi.toArray(t,e,i),[qr.FLOAT4]:(t,e,i=0)=>Ii.toArray(t,e,i),[qr.MAT3]:(t,e,i=0)=>hi.toArray(t,e,i),[qr.MAT4]:(t,e,i=0)=>Si.toArray(t,e,i)},Sd=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function Ad(t){switch(t){case qr.BOOL:case qr.INT:case qr.UINT:case qr.FLOAT:return Sd[0];case qr.BOOL2:case qr.INT2:case qr.UINT2:case qr.FLOAT2:return Sd[1];case qr.BOOL4:case qr.INT4:case qr.UINT4:case qr.FLOAT4:return Sd[2];case qr.MAT4:return Sd[3];case qr.SAMPLER2D:return"default-texture";case qr.SAMPLER_CUBE:return"default-cube-texture"}return Sd[0]}function Cd(t,e){const i=Object.entries(e);let n=!1;for(let e=0;e<i.length;e++)t[i[e][0]]!==i[e][1]&&(t[i[e][0]]=i[e][1],n=!0);return n}const bd=new ua;function Td(t){return Math.ceil(Math.log2(Math.max(t,2)))}function wd(t,e){switch(t.type){case"boolean":return"number"==typeof e?e.toString():e?"1":"0";case"string":return void 0!==e?e:t.options[0];case"number":return void 0!==e?e.toString():t.range[0].toString();default:return console.warn(`unknown define type '${t.type}'`),"-1"}}function Ed(t,e,i,n,s){const r=t.builtins[n],o=[];for(let t=0;t<r.blocks.length;t++){const e=r.blocks[t],n=i.layouts[e.name],a=n&&i.bindings.find((t=>t.binding===n.binding));n&&a&&a.descriptorType&Ca?(o.push(n),s&&!s.includes(a)&&s.push(a)):console.warn(`builtin UBO '${e.name}' not available!`)}Array.prototype.unshift.apply(e.gfxBlocks,o);const a=[];for(let t=0;t<r.samplerTextures.length;t++){const e=r.samplerTextures[t],n=i.layouts[e.name],o=n&&i.bindings.find((t=>t.binding===n.binding));n&&o&&o.descriptorType&ba?(a.push(n),s&&!s.includes(o)&&s.push(o)):console.warn(`builtin samplerTexture '${e.name}' not available!`)}Array.prototype.unshift.apply(e.gfxSamplerTextures,a),s&&s.sort(((t,e)=>t.binding-e.binding))}function Pd(t){return t.members.reduce(((t,e)=>t+Da(e.type)*e.count),0)}function Id(t,e){for(let i=0;i<t.length;i++){const n=t[i];if("!"===n[0]){if(e[n.slice(1)])return!1}else if(!e[n])return!1}return!0}function Dd(t){switch(t.gfxAPI){case Gr.GLES2:case Gr.WEBGL:return"glsl1";case Gr.GLES3:case Gr.WEBGL2:return"glsl3";default:return"glsl4"}}const Rd=new class{constructor(){this._templates={},this._cache={},this._templateInfos={}}register(t){for(let e=0;e<t.shaders.length;e++)this.define(t.shaders[e]).effectName=t.name}define(t){const e=this._templates[t.name];if(e&&e.hash===t.hash)return e;const i={...t};let n=0;for(let t=0;t<i.defines.length;t++){const e=i.defines[t];let s=1;if("number"===e.type){const t=e.range;s=Td(t[1]-t[0]+1),e._map=e=>e-t[0]}else"string"===e.type?(s=Td(e.options.length),e._map=t=>Math.max(0,e.options.findIndex((e=>e===t)))):"boolean"===e.type&&(e._map=t=>t?1:0);e._offset=n,n+=s}n>31&&(i.uber=!0),i.constantMacros="";for(const t in i.builtins.statistics)i.constantMacros+=`#define ${t} ${i.builtins.statistics[t]}\n`;if(this._templates[t.name]=i,!this._templateInfos[i.hash]){const t={};t.samplerStartBinding=i.blocks.length,t.gfxBlocks=[],t.gfxSamplerTextures=[],t.bindings=[],t.blockSizes=[];for(let e=0;e<i.blocks.length;e++){const n=i.blocks[e];t.blockSizes.push(Pd(n)),t.bindings.push(new _a(n.binding,n.descriptorType||xo.UNIFORM_BUFFER,1,n.stageFlags)),t.gfxBlocks.push(new Xo(zc.MATERIAL,n.binding,n.name,n.members.map((t=>new qo(t.name,t.type,t.count))),1))}for(let e=0;e<i.samplerTextures.length;e++){const n=i.samplerTextures[e];t.bindings.push(new _a(n.binding,n.descriptorType||xo.SAMPLER_TEXTURE,n.count,n.stageFlags)),t.gfxSamplerTextures.push(new Yo(zc.MATERIAL,n.binding,n.name,n.type,n.count))}t.gfxAttributes=[];for(let e=0;e<i.attributes.length;e++){const n=i.attributes[e];t.gfxAttributes.push(new rl(n.name,n.format,n.isNormalized,0,n.isInstanced,n.location))}Ed(i,t,Rc,"locals"),t.gfxStages=[],t.gfxStages.push(new ta(lo.VERTEX,"")),t.gfxStages.push(new ta(lo.FRAGMENT,"")),t.handleMap=function(t){const e={};for(let i=0;i<t.blocks.length;i++){const n=t.blocks[i],s=n.members;let r=0;for(let t=0;t<s.length;t++){const i=s[t];e[i.name]=md(ud.BUFFER,zc.MATERIAL,n.binding,i.type,r),r+=(Da(i.type)>>2)*i.count}}for(let i=0;i<t.samplerTextures.length;i++){const n=t.samplerTextures[i];e[n.name]=md(ud.TEXTURE,zc.MATERIAL,n.binding,n.type)}return e}(i),t.hPipelineLayout=0,t.setLayouts=[],this._templateInfos[i.hash]=t}return i}getTemplate(t){return this._templates[t]}getTemplateInfo(t){const e=this._templates[t].hash;return this._templateInfos[e]}getDescriptorSetLayout(t,e,i=!1){const n=this._templates[e],s=this._templateInfos[n.hash];return s.setLayouts.length||(bd.bindings=s.bindings,s.setLayouts[zc.MATERIAL]=t.createDescriptorSetLayout(bd),bd.bindings=Rc.bindings,s.setLayouts[zc.LOCAL]=t.createDescriptorSetLayout(bd)),s.setLayouts[i?zc.LOCAL:zc.MATERIAL]}hasProgram(t){return void 0!==this._templates[t]}getKey(t,e){const i=this._templates[t],n=i.defines;if(i.uber){let t="";for(let i=0;i<n.length;i++){const s=n[i],r=e[s.name];if(!r||!s._map)continue;const o=s._map(r);t+=`${s._offset}${o}|`}return`${t}${i.hash}`}let s=0;for(let t=0;t<n.length;t++){const i=n[t],r=e[i.name];r&&i._map&&(s|=i._map(r)<<i._offset)}return`${s.toString(16)}|${i.hash}`}destroyShaderByDefines(t){const e=Object.keys(t);if(!e.length)return;const i=e.map((e=>{let i=t[e];return"boolean"==typeof i&&(i=i?"1":"0"),new RegExp(`${e}${i}`)})),n=Object.keys(this._cache).filter((t=>i.every((e=>e.test(Fn.get(this._cache[t]).name)))));for(let t=0;t<n.length;t++){const e=n[t],i=Fn.get(this._cache[e]);console.log(`destroyed shader ${i.name}`),i.destroy(),delete this._cache[e]}}getGFXShader(t,e,i,n,s){Object.assign(i,n.macros),s||(s=this.getKey(e,i));const r=this._cache[s];if(r)return r;const o=this._templates[e],a=this._templateInfos[o.hash];a.hPipelineLayout||(this.getDescriptorSetLayout(t,e),Ed(o,a,Dc,"globals"),a.setLayouts[zc.GLOBAL]=n.descriptorSetLayout,a.hPipelineLayout=Un.alloc(t,new da(a.setLayouts)));const l=function(t,e){const i=[];for(let n=0;n<e.length;n++){const s=e[n],r=s.name,o=t[r],a=wd(s,o),l=!o||"0"===o;i.push({name:r,value:a,isDefault:l})}return i}(i,o.defines),c=n.constantMacros+o.constantMacros+l.reduce(((t,e)=>`${t}#define ${e.name} ${e.value}\n`),"");let h=o.glsl3;const _=Dd(t);_?h=o[_]:console.error("Invalid GFX API!"),a.gfxStages[0].source=c+h.vert,a.gfxStages[1].source=c+h.frag;const u=function(t,e,i){const n=[],s=t.attributes,r=e.gfxAttributes;for(let t=0;t<s.length;t++)Id(s[t].defines,i)&&n.push(r[t]);return n}(o,a,i),m=function(t,e){return t+e.reduce(((t,e)=>e.isDefault?t:`${t}|${e.name}${e.value}`),"")}(e,l),d=new ia(m,a.gfxStages,u,a.gfxBlocks);return d.samplerTextures=a.gfxSamplerTextures,this._cache[s]=Fn.alloc(t,d)}};n.programLib=Rd;const Md={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 rotation = a_rotation_uv.xyz;\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nrotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nrotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = rotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., rotation.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_texCoord.x\n#endif\n);\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nvarying float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nuniform lowp vec4 cc_shadowColor;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor *= v_color;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * pbrParams.w) * normalize(v_tangent) +\n(nmmp.y * pbrParams.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nvec4 viewStartPos = cc_matLightView * v_worldPos;\nfloat dist = length(viewStartPos.xyz);\nfloat linearDepth = cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\nreturn vec4(linearDepth, 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nuniform lowp vec4 cc_shadowColor;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture2D(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nuniform lowp vec4 cc_shadowColor;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying vec2 v_uv;\nuniform sampler2D cc_gbuffer_albedoMap;\nuniform sampler2D cc_gbuffer_positionMap;\nuniform sampler2D cc_gbuffer_normalMap;\nuniform sampler2D cc_gbuffer_emissiveMap;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture2D(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture2D(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture2D(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\ngl_FragColor = CCFragOutput(color);\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\nvarying vec2 v_uv;\nuniform sampler2D cc_lighting_resultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying float v_percent;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nvarying float v_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 rotation = a_rotation_uv.xyz;\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nrotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nrotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = rotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., rotation.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_texCoord.x\n#endif\n);\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nin float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor *= v_color;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * pbrParams.w) * normalize(v_tangent) +\n(nmmp.y * pbrParams.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nvec4 viewStartPos = cc_matLightView * v_worldPos;\nfloat dist = length(viewStartPos.xyz);\nfloat linearDepth = cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\nreturn vec4(linearDepth, 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin float v_fog_factor;\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nin vec2 v_uv;\nuniform sampler2D cc_gbuffer_albedoMap;\nuniform sampler2D cc_gbuffer_positionMap;\nuniform sampler2D cc_gbuffer_normalMap;\nuniform sampler2D cc_gbuffer_emissiveMap;\nlayout(location = 0) out vec4 fragColor;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\nfragColor = CCFragOutput(color);\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nin vec2 v_uv;\nuniform sampler2D cc_lighting_resultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout float v_percent;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nin float v_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]],glsl4:[[{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(set = 1, binding = 1) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 3) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 2) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(location = 0) in vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nlayout(location = 2) in float a_dist;\nlayout(location = 1) out float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(location = 0) in vec4 v_color;\nlayout(location = 1) in float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(set = 1, binding = 1) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(set = 1, binding = 2) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nlayout(location = 0) in vec4 a_position_starttime;\nlayout(location = 1) in vec4 a_size_uv;\nlayout(location = 2) in vec4 a_rotation_uv;\nlayout(location = 3) in vec4 a_color;\nlayout(location = 4) in vec4 a_dir_life;\nlayout(location = 5) in float a_rndSeed;\n#if CC_RENDER_MODE == 4\nlayout(location = 6) in vec3 a_texCoord;\nlayout(location = 7) in vec3 a_texCoord3;\nlayout(location = 8) in vec3 a_normal;\nlayout(location = 9) in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 10) uniform sampler2D color_over_time_tex0;\nlayout(set = 1, binding = 3) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 11) uniform sampler2D rotation_over_time_tex0;\nlayout(set = 1, binding = 4) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 12) uniform sampler2D size_over_time_tex0;\nlayout(set = 1, binding = 5) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 13) uniform sampler2D force_over_time_tex0;\nlayout(set = 1, binding = 6) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 14) uniform sampler2D velocity_over_time_tex0;\nlayout(set = 1, binding = 7) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nlayout(set = 1, binding = 15) uniform sampler2D texture_animation_tex0;\nlayout(set = 1, binding = 8) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 rotation = a_rotation_uv.xyz;\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nrotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nrotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = rotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., rotation.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 16) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 9) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nlayout(location = 2) out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\n#if CC_DRAW_WIRE_FRAME\nlayout(location = 2) in vec3 vBarycentric;\n#endif\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\nfloat xOS = cos(angle) * corner.x - sin(angle) * corner.y;\nfloat yOS = sin(angle) * corner.x + cos(angle) * corner.y;\ncorner.x = xOS;\ncorner.y = yOS;\n}\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\nrotateCorner(viewSpaceVert, q.z);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_RENDER_MODE == 1\nlayout(location = 8) in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nlayout(location = 6) in vec3 a_texCoord3;\nlayout(location = 7) in vec3 a_normal;\nlayout(location = 8) in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\ncomputeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_texCoord.x\n#endif\n);\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\nmat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 v_light;\nlayout(location = 1) out vec2 uv0;\n#if TWO_COLORED\nlayout(location = 3) in vec4 a_color2;\nlayout(location = 2) out vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(set = 1, binding = 0) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nlayout(location = 0) in vec4 v_light;\n#if TWO_COLORED\nlayout(location = 2) in vec4 v_dark;\n#endif\nlayout(location = 1) in vec2 uv0;\nlayout(set = 2, binding = 10) uniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 color;\nlayout(location = 1) out vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(set = 1, binding = 0) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nlayout(location = 0) in vec4 color;\n#if USE_TEXTURE\nlayout(location = 1) in vec2 uv0;\nlayout(set = 2, binding = 10) uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) out float v_fog_factor;\nlayout(location = 1) out highp vec4 v_shadowPos;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nlayout(location = 13) in vec4 a_color;\nlayout(location = 2) out vec4 v_color;\n#endif\nlayout(location = 3) out vec3 v_position;\nlayout(location = 4) out vec3 v_normal;\nlayout(location = 5) out vec2 v_uv;\nlayout(location = 6) out vec2 v_uv1;\n#if USE_NORMAL_MAP\nlayout(location = 7) out vec3 v_tangent;\nlayout(location = 8) out vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nlayout(location = 14) in vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 9) out vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(location = 0) in float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nlayout(location = 1) in highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 9) in vec3 v_luv;\nlayout(set = 2, binding = 9) uniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nlayout(location = 3) in vec3 v_position;\nlayout(location = 5) in vec2 v_uv;\nlayout(location = 6) in vec2 v_uv1;\nlayout(location = 4) in vec3 v_normal;\n#if USE_VERTEX_COLOR\nlayout(location = 2) in vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nlayout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nlayout(location = 7) in vec3 v_tangent;\nlayout(location = 8) in vec3 v_bitangent;\nlayout(set = 1, binding = 2) uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nlayout(set = 1, binding = 3) uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nlayout(set = 1, binding = 4) uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nlayout(set = 1, binding = 5) uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nlayout(set = 1, binding = 6) uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor *= v_color;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * pbrParams.w) * normalize(v_tangent) +\n(nmmp.y * pbrParams.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nlayout(location = 13) in vec2 a_texCoord1;\n#endif\nlayout(location = 0) out vec2 v_uv;\nlayout(location = 1) out vec2 v_uv1;\nlayout(location = 2) out vec4 v_worldPos;\nlayout(location = 3) out float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(location = 0) in vec2 v_uv;\nlayout(location = 1) in vec2 v_uv1;\nlayout(location = 2) in vec4 v_worldPos;\nlayout(location = 3) in float v_clip_depth;\n#if USE_ALBEDO_MAP\nlayout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nvec4 viewStartPos = cc_matLightView * v_worldPos;\nfloat dist = length(viewStartPos.xyz);\nfloat linearDepth = cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\nreturn vec4(linearDepth, 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) out float v_fog_factor;\nlayout(location = 1) out highp vec4 v_shadowPos;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 2) out highp vec3 v_position;\nlayout(location = 3) out mediump vec3 v_normal;\n#if USE_NORMALMAP\nlayout(location = 4) out mediump vec3 v_tangent;\nlayout(location = 5) out mediump vec3 v_binormal;\n#endif\nlayout(location = 6) out mediump vec2 uvw;\nlayout(location = 7) out mediump vec2 uv0;\nlayout(location = 8) out mediump vec2 uv1;\nlayout(location = 9) out mediump vec2 uv2;\nlayout(location = 10) out mediump vec2 uv3;\nlayout(location = 11) out mediump vec3 luv;\nlayout(location = 12) out mediump vec3 diffuse;\nlayout(set = 1, binding = 0) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nlayout(location = 0) in float v_fog_factor;\nlayout(location = 1) in highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 13) in vec3 v_luv;\nlayout(set = 2, binding = 9) uniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nlayout(location = 2) in highp vec3 v_position;\nlayout(location = 3) in mediump vec3 v_normal;\n#if USE_NORMALMAP\nlayout(location = 4) in mediump vec3 v_tangent;\nlayout(location = 5) in mediump vec3 v_binormal;\n#endif\nlayout(location = 6) in mediump vec2 uvw;\nlayout(location = 7) in mediump vec2 uv0;\nlayout(location = 8) in mediump vec2 uv1;\nlayout(location = 9) in mediump vec2 uv2;\nlayout(location = 10) in mediump vec2 uv3;\nlayout(location = 12) in mediump vec3 diffuse;\nlayout(location = 11) in mediump vec3 luv;\nlayout(set = 1, binding = 1) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nlayout(set = 1, binding = 2) uniform sampler2D weightMap;\nlayout(set = 1, binding = 3) uniform sampler2D detailMap0;\nlayout(set = 1, binding = 4) uniform sampler2D detailMap1;\nlayout(set = 1, binding = 5) uniform sampler2D detailMap2;\nlayout(set = 1, binding = 6) uniform sampler2D detailMap3;\nlayout(set = 1, binding = 7) uniform sampler2D normalMap0;\nlayout(set = 1, binding = 8) uniform sampler2D normalMap1;\nlayout(set = 1, binding = 9) uniform sampler2D normalMap2;\nlayout(set = 1, binding = 10) uniform sampler2D normalMap3;\nlayout(set = 1, binding = 11) uniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 0\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nlayout(location = 0) in vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) out float v_fog_factor;\n#if USE_VERTEX_COLOR\nlayout(location = 13) in lowp vec4 a_color;\nlayout(location = 1) out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nlayout(location = 2) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nlayout(location = 2) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\n#endif\nlayout(set = 1, binding = 1) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nlayout(location = 1) in lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) out vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorX1 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, clipPos.z- cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetShadowFactorX5 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetShadowFactorX9 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetShadowFactorX25 (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\nfloat CCGetDirLightShadowFactorX1 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(closestDepth, depth - cc_shadowWHPBInfo.w);\nreturn shadow;\n}\nfloat CCGetDirLightShadowFactorX5 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetDirLightShadowFactorX9 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, depth - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 9.0;\n}\nfloat CCGetDirLightShadowFactorX25 (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat depth = 0.0;\nfloat shadow = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n} else {\nfor (int i = -2; i <= 2; i++) {\nfor (int j = -2; j <= 2; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(closestDepth, clipPos.z - cc_shadowWHPBInfo.w);\n}\n}\n}\nreturn shadow / 25.0;\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.001);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nfinalColor *= (diffuseContrib + specularContrib);\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse);\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular;\n#endif\nfinalColor = finalColor * s.occlusion;\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\n#if CC_RECEIVE_SHADOW\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, L.xyz), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25(pos);\nelse if (pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9(pos);\nelse if (pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5(pos);\nelse shadowAttenuation = CCGetShadowFactorX1(pos);\nvec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\nif (cc_shadowNFLSInfo.w > 0.000001) {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n} else {\nfinalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n}\n}\n#endif\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z + 0.001;\nfloat shadowAttenuation = 0.0;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25(pos, s.position);\nelse if (pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9(pos, s.position);\nelse if (pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5(pos, s.position);\nelse shadowAttenuation = CCGetDirLightShadowFactorX1(pos, s.position);\nlightColor *= 1.0 - shadowAttenuation;\n}\n}\n#endif\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nfinalColor = finalColor * s.occlusion;\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout (set = 0, binding = 6) uniform sampler2D cc_gbuffer_albedoMap;\nlayout (set = 0, binding = 7) uniform sampler2D cc_gbuffer_positionMap;\nlayout (set = 0, binding = 8) uniform sampler2D cc_gbuffer_normalMap;\nlayout (set = 0, binding = 9) uniform sampler2D cc_gbuffer_emissiveMap;\nlayout(location = 0) out vec4 fragColor;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\nfragColor = CCFragOutput(color);\n}"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) out vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) in vec2 v_uv;\nlayout (set = 0, binding = 10) uniform sampler2D cc_lighting_resultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\nlayout(location = 0) out mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nlayout(location = 0) in mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 offset;\n};\nlayout(set = 1, binding = 1) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(location = 0) in vec2 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_uv;\nlayout(location = 1) out float v_percent;\nlayout(set = 1, binding = 0) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(location = 0) in vec2 v_uv;\nlayout(location = 1) in float v_percent;\nlayout(set = 1, binding = 1) uniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},Bd=t("builtinResMgr",n.builtinResMgr=new class{constructor(){this._device=null,this._resources={}}initBuiltinRes(t){this._device=t;const e=this._resources,i=document.createElement("canvas"),s=i.getContext("2d"),r=new Ru(i),o=i.width=i.height=2;s.fillStyle="#000",s.fillRect(0,0,o,o);const a=new Zm;a._uuid="black-texture",a.image=r,e[a._uuid]=a,s.fillStyle="rgba(0,0,0,0)",s.fillRect(0,0,o,o);const l=new Zm;l._uuid="empty-texture",l.image=r,e[l._uuid]=l;const c=new rd;c._uuid="black-cube-texture",c.setMipFilter(rd.Filter.NEAREST),c.image={front:new Ru(i),back:new Ru(i),left:new Ru(i),right:new Ru(i),top:new Ru(i),bottom:new Ru(i)},e[c._uuid]=c,s.fillStyle="#777",s.fillRect(0,0,o,o);const h=new Zm;h._uuid="grey-texture",h.image=r,e[h._uuid]=h,s.fillStyle="#fff",s.fillRect(0,0,o,o);const _=new Zm;_._uuid="white-texture",_.image=r,e[_._uuid]=_;const u=new rd;u._uuid="white-cube-texture",u.setMipFilter(rd.Filter.NEAREST),u.image={front:new Ru(i),back:new Ru(i),left:new Ru(i),right:new Ru(i),top:new Ru(i),bottom:new Ru(i)},e[u._uuid]=u,s.fillStyle="#7f7fff",s.fillRect(0,0,o,o);const m=new Zm;m._uuid="normal-texture",m.image=r,e[m._uuid]=m,i.width=i.height=16,s.fillStyle="#ddd",s.fillRect(0,0,16,16),s.fillStyle="#555",s.fillRect(0,0,8,8),s.fillStyle="#555",s.fillRect(8,8,8,8);const d=new Zm;d._uuid="default-texture",d.image=r,e[d._uuid]=d;const p=new rd;if(p.setMipFilter(rd.Filter.NEAREST),p._uuid="default-cube-texture",p.image={front:new Ru(i),back:new Ru(i),left:new Ru(i),right:new Ru(i),top:new Ru(i),bottom:new Ru(i)},e[p._uuid]=p,n.SpriteFrame){const t=new n.SpriteFrame,i=r._texture;t.texture=i,t._uuid="default-spriteframe",e[t._uuid]=t}const f=Dd(t);if(!f)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));const g=Md[f];return g?Promise.resolve().then((()=>{ad.forEach(((t,e)=>{const i=Object.assign(new n.EffectAsset,t);i.shaders.forEach(((t,i)=>{const n=g[e][i];n&&(t[f]=n)})),i.hideInEditor=!0,i.onLoaded()})),this._initMaterials()})):Promise.reject(Error(`Current device is requiring builtin shaders of version ${f} but shaders of that version are not assembled in this build.`))}get(t){return this._resources[t]}_initMaterials(){const t=this._resources,e=[],i=new n.Material;i._uuid="standard-material",i.initialize({effectName:"standard"}),t[i._uuid]=i,e.push(i);const s=new n.Material;s._uuid="missing-effect-material",s.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),s.setProperty("mainColor",n.color("#ffff00")),t[s._uuid]=s,e.push(s);const r=new n.Material;r._uuid="missing-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",n.color("#ff00ff")),t[r._uuid]=r,e.push(r);const o=new n.Material;o._uuid="default-clear-stencil",o.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),t[o._uuid]=o,e.push(o);const a=new n.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),t[a._uuid]=a,e.push(a);const l=new n.Material;l._uuid="ui-sprite-material",l.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[l._uuid]=l,e.push(l);const c=new n.Material;c._uuid="ui-alpha-test-material",c.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[c._uuid]=c,e.push(c);const h=new n.Material;h._uuid="ui-sprite-gray-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),t[h._uuid]=h,e.push(h);const _=new n.Material;_._uuid="ui-sprite-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),t[_._uuid]=_,e.push(_);const u=new n.Material;u._uuid="ui-sprite-gray-alpha-sep-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),t[u._uuid]=u,e.push(u);const m=new n.Material;m._uuid="ui-graphics-material",m.initialize({effectName:"graphics"}),t[m._uuid]=m,e.push(m);const d=new n.Material;d._uuid="default-particle-material",d.initialize({effectName:"particle"}),t[d._uuid]=d,e.push(d);const p=new n.Material;p._uuid="default-particle-gpu-material",p.initialize({effectName:"particle-gpu"}),t[p._uuid]=p,e.push(p);const f=new n.Material;f._uuid="default-trail-material",f.initialize({effectName:"particle-trail"}),t[f._uuid]=f,e.push(f);const g=new n.Material;g._uuid="default-billboard-material",g.initialize({effectName:"billboard"}),t[g._uuid]=g,e.push(g);const y=new n.Material;y._uuid="default-spine-material",y.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),t[y._uuid]=y,e.push(y);const v=new n.Material;v._uuid="builtin-deferred-material",v.initialize({effectName:"deferred-lighting"}),t[v._uuid]=v,e.push(v);const x=new n.Material;x._uuid="builtin-post-process-material",x.initialize({effectName:"post-process"}),t[x._uuid]=x,e.push(x),n.game.on(n.Game.EVENT_RENDERER_INITED,(()=>{for(let t=0;t<e.length;++t){const i=e[t];for(let t=0;t<i.passes.length;++t)i.passes[t].tryCompile()}}))}}),Od=(()=>{const t=new Map;let e=0;return i=>"number"==typeof i?i:(t.has(i)||(t.set(i,1<<e),e++),t.get(i))})(),Nd=new zo(Xr.UNIFORM|Xr.TRANSFER_DST,Jr.HOST|Jr.DEVICE),Ld=new Vo(null),Fd=new ma(null);let zd;!function(t){t[t.INSTANCING=1]="INSTANCING",t[t.VB_MERGING=2]="VB_MERGING"}(zd||(zd={}));class Vd{static fillPipelineInfo(t,e){const i=t.handle;void 0!==e.priority&&Qn.set(i,$n.PRIORITY,e.priority),void 0!==e.primitive&&Qn.set(i,$n.PRIMITIVE,e.primitive),void 0!==e.stage&&Qn.set(i,$n.STAGE,e.stage),void 0!==e.dynamicStates&&Qn.set(i,$n.DYNAMIC_STATES,e.dynamicStates),void 0!==e.phase&&Qn.set(i,$n.PHASE,Od(e.phase));const n=t._bs;if(e.blendState){const t=e.blendState,{targets:i}=t;i&&i.forEach(((t,e)=>{n.setTarget(e,t)})),void 0!==t.isA2C&&(n.isA2C=t.isA2C),void 0!==t.isIndepend&&(n.isIndepend=t.isIndepend),void 0!==t.blendColor&&(n.blendColor=t.blendColor)}t._rs.assign(e.rasterizerState),t._dss.assign(e.depthStencilState)}static getPassHash(t,e){const i=t.handle;let n=`${e},${Qn.get(i,$n.PRIMITIVE)},${Qn.get(i,$n.DYNAMIC_STATES)}`;var s;return n+=function(t){let e=`,bs,${t.isA2C}`;for(const i of t.targets)e+=`,bt,${i.blend},${i.blendEq},${i.blendAlphaEq},${i.blendColorMask}`,e+=`,${i.blendSrc},${i.blendDst},${i.blendSrcAlpha},${i.blendDstAlpha}`;return e}(t._bs),n+=function(t){let e=`,dss,${t.depthTest},${t.depthWrite},${t.depthFunc}`;return e+=`,${t.stencilTestFront},${t.stencilFuncFront},${t.stencilRefFront},${t.stencilReadMaskFront}`,e+=`,${t.stencilFailOpFront},${t.stencilZFailOpFront},${t.stencilPassOpFront},${t.stencilWriteMaskFront}`,e+=`,${t.stencilTestBack},${t.stencilFuncBack},${t.stencilRefBack},${t.stencilReadMaskBack}`,e+=`,${t.stencilFailOpBack},${t.stencilZFailOpBack},${t.stencilPassOpBack},${t.stencilWriteMaskBack}`,e}(t._dss),n+=`,rs,${(s=t._rs).cullMode},${s.depthBias},${s.isFrontFaceCCW}`,qa(n,666)}constructor(t){this._rootBuffer=null,this._rootBufferDirty=!1,this._buffers=[],this._descriptorSet=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._root=void 0,this._device=void 0,this._hShaderDefault=0,this._handle=0,this._bs=new al,this._dss=new cl,this._rs=new ll,this._root=t,this._device=t.device}initialize(t){this._doInit(t),this.resetUBOs(),this.resetTextures(),this.tryCompile()}getHandle(t,e=0,i=qr.UNKNOWN){let n=this._propertyHandleMap[t];return n?(i?n=yd(n,i):e&&(n=yd(n,pd(n)-e)),n+e):0}getBinding(t){const e=this.getHandle(t);return e?Vd.getBindingFromHandle(e):-1}setUniform(t,e){const i=Vd.getBindingFromHandle(t),n=Vd.getTypeFromHandle(t),s=Vd.getOffsetFromHandle(t),r=this._blocks[i];xd[n](r,e,s),this._rootBufferDirty=!0}getUniform(t,e){const i=Vd.getBindingFromHandle(t),n=Vd.getTypeFromHandle(t),s=Vd.getOffsetFromHandle(t),r=this._blocks[i];return vd[n](r,e,s)}setUniformArray(t,e){const i=Vd.getBindingFromHandle(t),n=Vd.getTypeFromHandle(t),s=Da(n)>>2,r=this._blocks[i];let o=Vd.getOffsetFromHandle(t);for(let t=0;t<e.length;t++,o+=s)null!==e[t]&&xd[n](r,e[t],o);this._rootBufferDirty=!0}bindTexture(t,e,i){this._descriptorSet.bindTexture(t,e,i||0)}bindSampler(t,e,i){this._descriptorSet.bindSampler(t,e,i||0)}setDynamicState(t,e){const i=this._dynamics[t];i&&i.value===e||(i.value=e,i.dirty=!0)}overridePipelineStates(t,e){console.warn("base pass cannot override states, please use pass instance instead.")}update(){this._rootBufferDirty&&this._rootBuffer&&(this._rootBuffer.update(this._rootBlock),this._rootBufferDirty=!1),this._descriptorSet.update()}destroy(){for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t];this._buffers[e.binding].destroy()}this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBlock=null),this._descriptorSet=null,this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._handle&&(zn.free(Qn.get(this._handle,$n.DESCRIPTOR_SET)),Qn.free(this._handle),this._handle=0)}resetUniform(t){const e=this.getHandle(t);if(!e)return;const i=Vd.getTypeFromHandle(e),n=Vd.getBindingFromHandle(e),s=Vd.getOffsetFromHandle(e),r=this._blocks[n],o=this._properties[t],a=o&&o.value||Ad(i);xd[i](r,a,s),this._rootBufferDirty=!0}resetTexture(t,e){const i=this.getHandle(t);if(!i)return;const n=Vd.getTypeFromHandle(i),s=Vd.getBindingFromHandle(i),r=this._properties[t],o=r&&r.value,a=o?`${o}-texture`:Ad(n),l=Bd.get(a),c=l&&l.getGFXTexture(),h=r&&void 0!==r.samplerHash?r.samplerHash:l&&l.getSamplerHash(),_=Fu.getSampler(this._device,h);this._descriptorSet.bindSampler(s,_,e),this._descriptorSet.bindTexture(s,c,e)}resetUBOs(){for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t],i=this._blocks[e.binding];let n=0;for(let t=0;t<e.members.length;t++){const s=e.members[t],r=this._properties[s.name],o=r&&r.value||Ad(s.type),a=(Da(s.type)>>2)*s.count;for(let t=0;t+o.length<=a;t+=o.length)i.set(o,n+t);n+=a}}this._rootBufferDirty=!0}resetTextures(){for(let t=0;t<this._shaderInfo.samplerTextures.length;t++){const e=this._shaderInfo.samplerTextures[t];for(let t=0;t<e.count;t++)this.resetTexture(e.name,t)}}tryCompile(){const{pipeline:t}=this._root;return!!t&&(this._syncBatchingScheme(),this._hShaderDefault=Rd.getGFXShader(this._device,this._programName,this._defines,t),this._hShaderDefault?(Qn.set(this._handle,$n.PIPELINE_LAYOUT,Rd.getTemplateInfo(this._programName).hPipelineLayout),Qn.set(this._handle,$n.HASH,Vd.getPassHash(this,this._hShaderDefault)),!0):(console.warn(`create shader ${this._programName} failed`),!1))}getShaderVariant(t=null){if(!this._hShaderDefault&&!this.tryCompile())return console.warn("pass resources incomplete"),0;if(!t)return this._hShaderDefault;const{pipeline:e}=this._root;for(let e=0;e<t.length;e++){const i=t[e];this._defines[i.name]=i.value}const i=Rd.getGFXShader(this._device,this._programName,this._defines,e);for(let e=0;e<t.length;e++){const i=t[e];delete this._defines[i.name]}return i}beginChangeStatesSilently(){}endChangeStatesSilently(){}_doInit(t,e=!1){const i=this._handle=Qn.alloc();Qn.set(i,$n.PRIORITY,Ic.DEFAULT),Qn.set(i,$n.STAGE,Pc.DEFAULT),Qn.set(i,$n.PHASE,Od("default")),Qn.set(i,$n.PRIMITIVE,mo.TRIANGLE_LIST),Qn.set(i,$n.RASTERIZER_STATE,this._rs.handle),Qn.set(i,$n.DEPTH_STENCIL_STATE,this._dss.handle),Qn.set(i,$n.BLEND_STATE,this._bs.handle),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=e?{...t.defines}:t.defines,this._shaderInfo=Rd.getTemplate(t.program),this._properties=t.properties||this._properties;const n=this._device;Vd.fillPipelineInfo(this,t),t.stateOverrides&&Vd.fillPipelineInfo(this,t.stateOverrides),Fd.layout=Rd.getDescriptorSetLayout(this._device,t.program);const s=zn.alloc(this._device,Fd);Qn.set(this._handle,$n.DESCRIPTOR_SET,s),this._descriptorSet=zn.get(s);const r=this._shaderInfo.blocks,o=Rd.getTemplateInfo(t.program),{blockSizes:a,handleMap:l}=o,c=n.capabilities.uboOffsetAlignment,h=[];let _=0,u=0;for(let t=0;t<r.length;t++){const e=a[t];h.push(u),u+=Math.ceil(e/c)*c,_=e}const m=h[h.length-1]+_;m&&(Nd.size=16*Math.ceil(m/16),this._rootBuffer=n.createBuffer(Nd),this._rootBlock=new ArrayBuffer(m));for(let t=0,e=0;t<r.length;t++){const{binding:i}=r[t],s=a[t];Ld.buffer=this._rootBuffer,Ld.offset=h[e++],Ld.range=16*Math.ceil(s/16);const o=this._buffers[i]=n.createBuffer(Ld);this._blocks[i]=new Float32Array(this._rootBlock,Ld.offset,s/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet.bindBuffer(i,o)}const d=this._propertyHandleMap=l,p={};for(const t in this._properties){const e=this._properties[t];e.handleInfo&&(p[t]=this.getHandle.apply(this,e.handleInfo))}Object.assign(d,p)}_syncBatchingScheme(){this._defines.USE_INSTANCING?this._device.hasFeature(kr.INSTANCED_ARRAYS)?Qn.set(this._handle,$n.BATCHING_SCHEME,zd.INSTANCING):(this._defines.USE_INSTANCING=!1,Qn.set(this._handle,$n.BATCHING_SCHEME,0)):this._defines.USE_BATCHING?Qn.set(this._handle,$n.BATCHING_SCHEME,zd.VB_MERGING):Qn.set(this._handle,$n.BATCHING_SCHEME,0)}_destroyHandle(){this._handle&&(Qn.free(this._handle),this._handle=0)}_initPassFromTarget(t,e,i,n){Qn.set(this.handle,$n.PRIORITY,t.priority),Qn.set(this.handle,$n.STAGE,t.stage),Qn.set(this.handle,$n.PHASE,t.phase),Qn.set(this.handle,$n.BATCHING_SCHEME,t.batchingScheme),Qn.set(this.handle,$n.PRIMITIVE,t.primitive),Qn.set(this.handle,$n.DYNAMIC_STATES,t.dynamicStates),this._descriptorSet=t.descriptorSet,Qn.set(this.handle,$n.DESCRIPTOR_SET,Qn.get(t.handle,$n.DESCRIPTOR_SET)),this._bs=i,Qn.set(this.handle,$n.BLEND_STATE,i.handle),this._rs=t.rasterizerState,Qn.set(this.handle,$n.RASTERIZER_STATE,Qn.get(t.handle,$n.RASTERIZER_STATE)),this._dss=e,Qn.set(this.handle,$n.DEPTH_STENCIL_STATE,e.handle),this._passIndex=t.passIndex,this._propertyIndex=t.propertyIndex,this._programName=t.program,this._defines=t.defines,this._shaderInfo=t._shaderInfo,this._properties=t._properties,this._blocks=t._blocks,this._dynamics=t._dynamics,this._hShaderDefault=t._hShaderDefault,Qn.set(this._handle,$n.PIPELINE_LAYOUT,Rd.getTemplateInfo(this._programName).hPipelineLayout);const s=Qn.get(t.handle,$n.HASH);Qn.set(this._handle,$n.HASH,s^n)}get root(){return this._root}get device(){return this._device}get shaderInfo(){return this._shaderInfo}get localSetLayout(){return Rd.getDescriptorSetLayout(this._device,this._programName,!0)}get program(){return this._programName}get properties(){return this._properties}get defines(){return this._defines}get passIndex(){return this._passIndex}get propertyIndex(){return this._propertyIndex}get dynamics(){return this._dynamics}get blocks(){return this._blocks}get handle(){return this._handle}get priority(){return Qn.get(this._handle,$n.PRIORITY)}get primitive(){return Qn.get(this._handle,$n.PRIMITIVE)}get stage(){return Qn.get(this._handle,$n.STAGE)}get phase(){return Qn.get(this._handle,$n.PHASE)}get rasterizerState(){return this._rs}get depthStencilState(){return this._dss}get blendState(){return this._bs}get dynamicStates(){return Qn.get(this._handle,$n.DYNAMIC_STATES)}get batchingScheme(){return Qn.get(this._handle,$n.BATCHING_SCHEME)}get descriptorSet(){return this._descriptorSet}get hash(){return Qn.get(this._handle,$n.HASH)}get rootBufferDirty(){return this._rootBufferDirty}}Vd.PropertyType=ud,Vd.getPropertyTypeFromHandle=dd,Vd.getTypeFromHandle=pd,Vd.getBindingFromHandle=fd,Vd.getOffsetFromHandle=gd,V(e_.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),V(e_.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);const Ud={};V(Ud,"CameraVisFlags",[{name:"GENERAL"}]),z(Ud,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Ec.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Ec.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Ec.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Ec.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Ec.BitMask,targetName:"UI_2D"}]),n.CameraVisFlags=Ud;const Gd={};function Hd(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);const i=e*e,n=(.860117757+.000154118254*e+1.28641212e-7*i)/(1+.000842420235*e+7.08145163e-7*i),s=(.317398726+422806245e-13*e+4.20481691e-8*i)/(1-289741816e-13*e+1.61456053e-7*i),r=2*n-8*s+4,o=3*n/r,a=2*s/r,l=1/a*o,c=1/a*(1-o-a);t.x=3.2404542*l-1.5371385+-.4985314*c,t.y=-.969266*l+1.8760108+.041556*c,t.z=.0556434*l-.2040259+1.0572252*c}let kd;V(Gd,"VisibilityFlags",[{name:"GENERAL"}]),z(Gd,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Ec.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Ec.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Ec.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Ec.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Ec.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Ec.Enum,targetName:"UI_2D"}]),n.VisibilityFlags=Gd,z(Vd.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),V(Zh.prototype,"Camera.prototype",[{name:"getSplitFrustum"}]),function(t){t[t.DIRECTIONAL=0]="DIRECTIONAL",t[t.SPHERE=1]="SPHERE",t[t.SPOT=2]="SPOT",t[t.UNKNOWN=3]="UNKNOWN"}(kd||(kd={}));const jd=t=>4*Math.PI*Math.PI*t*t;class Wd{constructor(){this._baked=!1,this._color=new oi(1,1,1),this._colorTemp=6550,this._colorTempRGB=new oi(1,1,1),this._scene=null,this._node=null,this._name=null,this._handle=0}get baked(){return this._baked}set baked(t){this._baked=t}set color(t){this._color.set(t),Xs.setVec3(this._handle,Ws.COLOR,t)}get color(){return this._color}set useColorTemperature(t){Xs.set(this._handle,Ws.USE_COLOR_TEMPERATURE,t?1:0)}get useColorTemperature(){return 1===Xs.get(this._handle,Ws.USE_COLOR_TEMPERATURE)}set colorTemperature(t){this._colorTemp=t,Hd(this._colorTempRGB,this._colorTemp),Xs.setVec3(this._handle,Ws.COLOR_TEMPERATURE_RGB,this._colorTempRGB)}get colorTemperature(){return this._colorTemp}get colorTemperatureRGB(){return this._colorTempRGB}set node(t){this._node=t,this._node&&(this._node.hasChangedFlags|=t_.ROTATION,Xs.set(this._handle,Ws.NODE,this._node.handle))}get node(){return this._node}get type(){return Xs.get(this._handle,Ws.TYPE)}get name(){return this._name}set name(t){this._name=t}get scene(){return this._scene}get handle(){return this._handle}initialize(){this._handle=Xs.alloc(),Xs.setVec3(this._handle,Ws.COLOR,this._color),Xs.setVec3(this._handle,Ws.COLOR_TEMPERATURE_RGB,this._colorTempRGB),Xs.set(this._handle,Ws.TYPE,kd.UNKNOWN)}attachToScene(t){this._scene=t}detachFromScene(){this._scene=null}destroy(){this._name=null,this._node=null,this._handle&&(Xs.free(this._handle),this._handle=0)}update(){}}const qd=new oi(0,0,-1),Xd=new oi;function Yd(t,e){for(const i of e)Array.isArray(i)?Yd(t,i):t.push(i)}function Kd(t){const e=[];return Yd(e,t),e.join("")}const Jd=Gi.Flags.Destroyed,$d=Gi.Flags.PersistentMask,Zd=Me.IDENTIFIER_RE,Qd="var ",tp="o",ep={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},ip=Me.escapeForJS;class np{constructor(t,e){this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=e}toString(){return`${Qd+this.varName}=${this.expression};`}}function sp(t,e){return e instanceof np?new np(e.varName,t+e.expression):t+e}function rp(t,e,i){Array.isArray(i)?(i[0]=sp(e,i[0]),t.push(i)):t.push(`${sp(e,i)};`)}class op{constructor(t){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}append(t,e){this._exps.push([t,e])}writeCode(t){let e;if(this._exps.length>1)t.push(`t=${this._targetExp};`),e="t";else{if(1!==this._exps.length)return;e=this._targetExp}for(let i=0;i<this._exps.length;i++){const n=this._exps[i];rp(t,`${e+ap(n[0])}=`,n[1])}}}function ap(t){return Zd.test(t)?`.${t}`:`[${ip(t)}]`}op.pool=void 0,op.pool=new Ft((t=>{t._exps.length=0,t._targetExp=null}),1),op.pool.get=function(t){const e=this._get()||new op;return e._targetExp=t,e};class lp{constructor(t,e){let i;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=e,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=ht(),St(this.funcModuleCache,ep),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{",`o=R=new ${this.getFuncModule(t.constructor,!0)}();`,"}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(i=`${Qd+this.globalVariables.join(",")};`);const n=Kd(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",n)(this.objs,this.funcs);for(let t=0,e=this.objsToClear_iN$t.length;t<e;++t)this.objsToClear_iN$t[t]._iN$t=null;this.objsToClear_iN$t.length=0}getFuncModule(t,e){const i=_t(t);if(i){const e=this.funcModuleCache[i];if(e)return e;if(void 0===e){let e=-1!==i.indexOf(".");if(e)try{if(e=t===Function(`return ${i}`)(),e)return this.funcModuleCache[i]=i,i}catch(t){}}}let n=this.funcs.indexOf(t);n<0&&(n=this.funcs.length,this.funcs.push(t));let s=`F[${n}]`;return e&&(s=`(${s})`),this.funcModuleCache[i]=s,s}getObjRef(t){let e=this.objs.indexOf(t);return e<0&&(e=this.objs.length,this.objs.push(t)),`O[${e}]`}setValueType(t,e,i,n){const s=op.pool.get(n);let r=e.constructor.__props__;r||(r=Object.keys(e));for(let t=0;t<r.length;t++){const n=r[t],o=i[n];if(e[n]===o)continue;const a=this.enumerateField(i,n,o);s.append(n,a)}s.writeCode(t),op.pool.put(s)}enumerateCCClass(t,e,i){const s=i.__values__,r=ce(i);for(let i=0;i<s.length;i++){const o=s[i],a=e[o];let l=r[o+"$_$default"];if(!cp(l,a))if("object"==typeof a&&a instanceof n.ValueType&&(l=Me.getDefault(l),l&&l.constructor===a.constructor)){const e=tp+ap(o);this.setValueType(t,l,a,e)}else this.setObjProp(t,e,o,a)}}instantiateArray(t){if(0===t.length)return"[]";const e="a"+ ++this.localVariableId,i=[new np(e,`new Array(${t.length})`)];t._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(t);for(let n=0;n<t.length;++n)rp(i,`${e}[${n}]=`,this.enumerateField(t,n,t[n]));return i}instantiateTypedArray(t){const e=t.constructor.name;if(0===t.length)return`new ${e}`;const i="a"+ ++this.localVariableId,n=[new np(i,`new ${e}(${t.length})`)];t._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(t);for(let e=0;e<t.length;++e)0!==t[e]&&rp(n,`${i}[${e}]=`,t[e]);return n}enumerateField(t,e,i){if("object"==typeof i&&i){const t=i._iN$t;if(t){let e=t.globalVar;if(!e){e=t.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(e);const i=t.source[0];t.source[0]=sp(`${e}=`,i)}return e}return ArrayBuffer.isView(i)?this.instantiateTypedArray(i):Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?ip(i):("_objFlags"===e&&t instanceof Gi&&(i&=$d),i)}setObjProp(t,e,i,n){rp(t,`${tp+ap(i)}=`,this.enumerateField(e,i,n))}enumerateObject(t,e){const i=e.constructor;if(n.Class._isCCClass(i))this.enumerateCCClass(t,e,i);else for(const i in e){if(!e.hasOwnProperty(i)||95===i.charCodeAt(0)&&95===i.charCodeAt(1)&&"__type__"!==i)continue;const n=e[i];"object"==typeof n&&n&&n===e._iN$t||this.setObjProp(t,e,i,n)}}instantiateObj(t){if(t instanceof n.ValueType)return Me.getNewValueTypeCode(t);if(t instanceof n.Asset)return this.getObjRef(t);if(t._objFlags&Jd)return null;let e;const i=t.constructor;if(n.Class._isCCClass(i)){if(this.parent)if(this.parent instanceof n.Component){if(t instanceof n._BaseNode||t instanceof n.Component)return this.getObjRef(t)}else if(this.parent instanceof n._BaseNode)if(t instanceof n._BaseNode){if(!t.isChildOf(this.parent))return this.getObjRef(t)}else if(t instanceof n.Component&&!t.node.isChildOf(this.parent))return this.getObjRef(t);e=new np(tp,`new ${this.getFuncModule(i,!0)}()`)}else if(i===Object)e=new np(tp,"{}");else{if(i)return this.getObjRef(t);e=new np(tp,"Object.create(null)")}const s=[e];return t._iN$t={globalVar:"",source:s},this.objsToClear_iN$t.push(t),this.enumerateObject(s,t),["(function(){",s,"return o;})();"]}}function cp(t,e){if("function"==typeof t)try{t=t()}catch(t){return!1}if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e&&t.constructor===e.constructor)if(t instanceof n.ValueType){if(t.equals(e))return!0}else{if(Array.isArray(t))return 0===t.length&&0===e.length;if(t.constructor===Object)return rt(t)&&rt(e)}return!1}class hp{get uiTransformComp(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp}set uiTransformComp(t){this._uiTransformComp=t}get uiComp(){return this._uiComp}set uiComp(t){this._uiComp&&t?C(12002):this._uiComp=t}constructor(t){this._uiComp=null,this.opacity=1,this.localOpacity=1,this._uiTransformComp=null,this._node=void 0,this._node=t}}let _p;!function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed"}(_p||(_p=t("SystemEventType",{}))),jt(_p),n.SystemEventType=_p;class up{static create(t){E(t&&t.event,1900);const e=t.event;delete t.event;let i=null;if(e===n.EventListener.TOUCH_ONE_BY_ONE?i=new pp:e===n.EventListener.TOUCH_ALL_AT_ONCE?i=new fp:e===n.EventListener.MOUSE?i=new dp:e===n.EventListener.KEYBOARD?i=new yp:e===n.EventListener.ACCELERATION&&(i=new gp(t.callback),delete t.callback),i)for(const e of Object.keys(t))i[e]=t[e];return i}get onEvent(){return this._onEvent}constructor(t,e,i){this._cameraPriority=0,this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=i,this._type=t||0,this._listenerID=e||""}_setPaused(t){this._paused=t}_isPaused(){return this._paused}_setRegistered(t){this._registered=t}_isRegistered(){return this._registered}_getType(){return this._type}_getListenerID(){return this._listenerID}_setFixedPriority(t){this._fixedPriority=t}_getFixedPriority(){return this._fixedPriority}_setSceneGraphPriority(t){this._target=t,this._node=t}_getSceneGraphPriority(){return this._node}checkAvailable(){return null!==this._onEvent}clone(){return null}setEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}}up.UNKNOWN=0,up.TOUCH_ONE_BY_ONE=1,up.TOUCH_ALL_AT_ONCE=2,up.KEYBOARD=3,up.MOUSE=4,up.ACCELERATION=6,up.CUSTOM=8,up.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};const mp=up.ListenerID;class dp extends up{constructor(){super(up.MOUSE,mp.MOUSE,null),this.onMouseDown=null,this.onMouseUp=null,this.onMouseMove=null,this.onMouseScroll=null,this._onEvent=t=>this._callback(t)}_callback(t){switch(t.eventType){case _p.MOUSE_DOWN:this.onMouseDown&&this.onMouseDown(t);break;case _p.MOUSE_UP:this.onMouseUp&&this.onMouseUp(t);break;case _p.MOUSE_MOVE:this.onMouseMove&&this.onMouseMove(t);break;case _p.MOUSE_WHEEL:this.onMouseScroll&&this.onMouseScroll(t)}}clone(){const t=new dp;return t.onMouseDown=this.onMouseDown,t.onMouseUp=this.onMouseUp,t.onMouseMove=this.onMouseMove,t.onMouseScroll=this.onMouseScroll,t}checkAvailable(){return!0}}class pp extends up{constructor(){super(up.TOUCH_ONE_BY_ONE,mp.TOUCH_ONE_BY_ONE,null),this.swallowTouches=!1,this.onTouchBegan=null,this.onTouchMoved=null,this.onTouchEnded=null,this.onTouchCancelled=null,this._claimedTouches=[]}setSwallowTouches(t){this.swallowTouches=t}isSwallowTouches(){return this.swallowTouches}clone(){const t=new pp;return t.onTouchBegan=this.onTouchBegan,t.onTouchMoved=this.onTouchMoved,t.onTouchEnded=this.onTouchEnded,t.onTouchCancelled=this.onTouchCancelled,t.swallowTouches=this.swallowTouches,t}checkAvailable(){return!!this.onTouchBegan||(S(1801),!1)}}class fp extends up{constructor(){super(up.TOUCH_ALL_AT_ONCE,mp.TOUCH_ALL_AT_ONCE,null),this.onTouchesBegan=null,this.onTouchesMoved=null,this.onTouchesEnded=null,this.onTouchesCancelled=null}clone(){const t=new fp;return t.onTouchesBegan=this.onTouchesBegan,t.onTouchesMoved=this.onTouchesMoved,t.onTouchesEnded=this.onTouchesEnded,t.onTouchesCancelled=this.onTouchesCancelled,t}checkAvailable(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(S(1802),!1)}}class gp extends up{constructor(t){super(up.ACCELERATION,mp.ACCELERATION,null),this._onAccelerationEvent=null,this._onEvent=t=>this._callback(t),this._onAccelerationEvent=t}_callback(t){this._onAccelerationEvent&&this._onAccelerationEvent(t.acc,t)}checkAvailable(){return E(this._onAccelerationEvent,1803),!0}clone(){return new gp(this._onAccelerationEvent)}}class yp extends up{constructor(){super(up.KEYBOARD,mp.KEYBOARD,null),this.onKeyPressed=null,this.onKeyReleased=null,this._onEvent=t=>this._callback(t)}_callback(t){t.isPressed?this.onKeyPressed&&this.onKeyPressed(t.keyCode,t):this.onKeyReleased&&this.onKeyReleased(t.keyCode,t)}clone(){const t=new yp;return t.onKeyPressed=this.onKeyPressed,t.onKeyReleased=this.onKeyReleased,t}checkAvailable(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(S(1800),!1)}}n.EventListener=up;const vp=up.ListenerID;class xp{constructor(){this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}size(){return this._fixedListeners.length+this._sceneGraphListeners.length}empty(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}push(t){0===t._getFixedPriority()?this._sceneGraphListeners.push(t):this._fixedListeners.push(t)}clearSceneGraphListeners(){this._sceneGraphListeners.length=0}clearFixedListeners(){this._fixedListeners.length=0}clear(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}getFixedPriorityListeners(){return this._fixedListeners}getSceneGraphPriorityListeners(){return this._sceneGraphListeners}}const Sp=t("eventManager",new class{constructor(){this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners={},this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null,this._currentTouchListener=null}pauseTarget(t,e=!1){if(!(t instanceof n._BaseNode))return void C(3506);const i=this._nodeListenersMap[t.uuid];if(i)for(let t=0;t<i.length;++t)i[t]._setPaused(!0);if(!0===e){const e=t.children;if(e)for(let t=0;t<e.length;++t){const i=e[t];this.pauseTarget(i,!0)}}}resumeTarget(t,e=!1){if(!(t instanceof n._BaseNode))return void C(3506);const i=this._nodeListenersMap[t.uuid];if(i)for(let t=0;t<i.length;++t)i[t]._setPaused(!1);if(this._setDirtyForNode(t),!0===e&&t.children.length>0){const e=t.children;if(e)for(let t=0;t<e.length;++t){const i=e[t];this.resumeTarget(i,!0)}}}frameUpdateListeners(){const t=this._listenersMap,e=this._priorityDirtyFlagMap;for(const i in t)t[i].empty()&&(delete e[i],delete t[i]);const i=this._toAddedListeners;if(0!==i.length){for(let t=0,e=i.length;t<e;t++)this._forceAddEventListener(i[t]);i.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}hasEventListener(t){return!!this._getListeners(t)}addListener(t,e){if(E(t&&e,3503),!(n.js.isNumber(e)||e instanceof n._BaseNode))return C(3506),null;if(t instanceof n.EventListener){if(t._isRegistered())return S(3505),null}else E(!n.js.isNumber(e),3504),t=n.EventListener.create(t);if(!t.checkAvailable())return null;if(n.js.isNumber(e)){if(0===e)return S(3500),null;t._setSceneGraphPriority(null),t._setFixedPriority(e),t._setRegistered(!0),t._setPaused(!1),this._addListener(t)}else{if(!(i=e)||!i.getComponent("cc.UITransform"))return S(3512),null;t._setSceneGraphPriority(e),t._setFixedPriority(0),t._setRegistered(!0),this._addListener(t)}var i;return t}addCustomListener(t,e){const i=up.create({event:n.EventListener.CUSTOM,eventName:t,callback:e});return this.addListener(i,1),i}removeListener(t){if(null==t)return;let e=!1;const i=this._listenersMap;t===this._currentTouchListener&&(this._currentTouchListener=this._currentTouch=null);for(const n in i){const s=i[n],r=s.getFixedPriorityListeners(),o=s.getSceneGraphPriorityListeners();if(e=this._removeListenerInVector(o,t),e?this._setDirty(t._getListenerID(),2):(e=this._removeListenerInVector(r,t),e&&this._setDirty(t._getListenerID(),1)),s.empty()&&(delete this._priorityDirtyFlagMap[t._getListenerID()],delete i[n]),e)break}if(!e){const e=this._toAddedListeners;for(let i=e.length-1;i>=0;i--){const s=e[i];if(s===t){n.js.array.removeAt(e,i),s._setRegistered(!1);break}}}}removeListeners(t,e=!1){if(n.js.isNumber(t)||t instanceof n._BaseNode)if(void 0!==t._id){const i=this._nodeListenersMap[t._id];if(i){const e=n.js.array.copy(i);for(let t=0;t<e.length;++t){const i=e[t];this.removeListener(i)}delete this._nodeListenersMap[t._id]}const s=this._toAddedListeners;for(let e=0;e<s.length;){const i=s[e];i._getSceneGraphPriority()===t?(i._setSceneGraphPriority(null),i._setRegistered(!1),s.splice(e,1)):++e}if(!0===e){const e=t.getChildren();for(let t=0;t<e.length;++t){const i=e[t];this.removeListeners(i,!0)}}}else t===n.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(vp.TOUCH_ONE_BY_ONE):t===n.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(vp.TOUCH_ALL_AT_ONCE):t===n.EventListener.MOUSE?this._removeListenersForListenerID(vp.MOUSE):t===n.EventListener.ACCELERATION?this._removeListenersForListenerID(vp.ACCELERATION):t===n.EventListener.KEYBOARD?this._removeListenersForListenerID(vp.KEYBOARD):S(3501);else C(3506)}removeCustomListeners(t){this._removeListenersForListenerID(t)}removeAllListeners(){const t=this._listenersMap,e=this._internalCustomListenerIDs;for(const i in t)-1===e.indexOf(i)&&this._removeListenersForListenerID(i)}setPriority(t,e){if(null==t)return;const i=this._listenersMap;for(const n in i){const s=i[n].getFixedPriorityListeners();if(s&&-1!==s.indexOf(t))return null!=t._getSceneGraphPriority()&&S(3502),void(t._getFixedPriority()!==e&&(t._setFixedPriority(e),this._setDirty(t._getListenerID(),1)))}}setEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}dispatchEvent(t){if(!this._isEnabled)return;if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,!t||!t.getType)return void T(3511);if(t.getType().startsWith(n.Event.TOUCH))return this._dispatchTouchEvent(t),void this._inDispatch--;const e=function(t){const e=vu,i=t.type;return i===e.ACCELERATION?vp.ACCELERATION:i===e.KEYBOARD?vp.KEYBOARD:i.startsWith(e.MOUSE)?vp.MOUSE:(i.startsWith(e.TOUCH)&&S(2e3),"")}(t);this._sortEventListeners(e);const i=this._listenersMap[e];null!=i&&(this._dispatchEventToListeners(i,this._onListenerCallback,t),this._onUpdateListeners(i)),this._inDispatch--}_onListenerCallback(t,e){e.currentTarget=t._target;const i=t.onEvent;return i&&i(e),e.isStopped()}dispatchCustomEvent(t,e){const i=new n.Event.EventCustom(t);i.setUserData(e),this.dispatchEvent(i)}_setDirtyForNode(t){const e=this._nodeListenersMap[t._id];if(void 0!==e)for(let t=0,i=e.length;t<i;t++){const i=e[t]._getListenerID();this._dirtyListeners[i]||(this._dirtyListeners[i]=!0)}if(t.children.length>0){const e=t.children;for(let t=0,i=e?e.length:0;t<i;t++)this._setDirtyForNode(e[t])}}_addListener(t){0===this._inDispatch?this._forceAddEventListener(t):this._toAddedListeners.push(t)}_forceAddEventListener(t){const e=t._getListenerID();let i=this._listenersMap[e];if(i||(i=new xp,this._listenersMap[e]=i),i.push(t),0===t._getFixedPriority()){this._setDirty(e,2);const i=t._getSceneGraphPriority();null===i&&S(3507),this._associateNodeAndEventListener(i,t),i.activeInHierarchy&&this.resumeTarget(i)}else this._setDirty(e,1)}_getListeners(t){return this._listenersMap[t]}_updateDirtyFlagForSceneGraph(){const t=this._dirtyListeners;for(const e in t)this._setDirty(e,2),t[e]=!1}_removeAllListenersInVector(t){if(!t)return;let e;for(let i=t.length-1;i>=0;i--)e=t[i],e._setRegistered(!1),null!=e._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(e._getSceneGraphPriority(),e),e._setSceneGraphPriority(null)),0===this._inDispatch&&n.js.array.removeAt(t,i)}_removeListenersForListenerID(t){const e=this._listenersMap[t];if(e){const i=e.getFixedPriorityListeners(),n=e.getSceneGraphPriorityListeners();this._removeAllListenersInVector(n),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[t],this._inDispatch||(e.clear(),delete this._listenersMap[t])}const i=this._toAddedListeners;for(let e=i.length-1;e>=0;e--){const s=i[e];s&&s._getListenerID()===t&&n.js.array.removeAt(i,e)}}_sortEventListeners(t){let e=0;const i=this._priorityDirtyFlagMap;i[t]&&(e=i[t]),0!==e&&(i[t]=0,1&e&&this._sortListenersOfFixedPriority(t),2&e)&&n.director.getScene()&&this._sortListenersOfSceneGraphPriority(t)}_sortListenersOfSceneGraphPriority(t){const e=this._getListeners(t);if(!e)return;const i=e.getSceneGraphPriorityListeners();if(!i||0===i.length)return;const n=e.getSceneGraphPriorityListeners();n.forEach((t=>{const e=t._getSceneGraphPriority()._uiProps.uiTransformComp;t._cameraPriority=e.cameraPriority})),n.sort(this._sortEventListenersOfSceneGraphPriorityDes)}_sortEventListenersOfSceneGraphPriorityDes(t,e){const i=t._getSceneGraphPriority(),n=e._getSceneGraphPriority();if(!(e&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return-1;if(!(t&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return 1;let s=i,r=n,o=!1;if(t._cameraPriority!==e._cameraPriority)return e._cameraPriority-t._cameraPriority;for(;s.parent._id!==r.parent._id;)s=null===s.parent.parent?(o=!0)&&n:s.parent,r=null===r.parent.parent?(o=!0)&&i:r.parent;if(s._id===r._id){if(s._id===n._id)return-1;if(s._id===i._id)return 1}const a=s.getSiblingIndex(),l=r.getSiblingIndex();return o?a-l:l-a}_sortListenersOfFixedPriority(t){const e=this._listenersMap[t];if(!e)return;const i=e.getFixedPriorityListeners();if(!i||0===i.length)return;i.sort(this._sortListenersOfFixedPriorityAsc);let n=0;for(const t=i.length;n<t&&!(i[n]._getFixedPriority()>=0);)++n;e.gt0Index=n}_sortListenersOfFixedPriorityAsc(t,e){return t._getFixedPriority()-e._getFixedPriority()}_onUpdateListeners(t){const e=t.getFixedPriorityListeners(),i=t.getSceneGraphPriorityListeners(),s=this._toRemovedListeners;if(i)for(let t=i.length-1;t>=0;t--){const e=i[t];if(!e._isRegistered()){n.js.array.removeAt(i,t);const r=s.indexOf(e);-1!==r&&s.splice(r,1)}}if(e)for(let t=e.length-1;t>=0;t--){const i=e[t];if(!i._isRegistered()){n.js.array.removeAt(e,t);const r=s.indexOf(i);-1!==r&&s.splice(r,1)}}i&&0===i.length&&t.clearSceneGraphListeners(),e&&0===e.length&&t.clearFixedListeners()}_updateTouchListeners(t){const e=this._inDispatch;if(E(e>0,3508),e>1)return;let i;i=this._listenersMap[vp.TOUCH_ONE_BY_ONE],i&&this._onUpdateListeners(i),i=this._listenersMap[vp.TOUCH_ALL_AT_ONCE],i&&this._onUpdateListeners(i),E(1===e,3509);const n=this._toAddedListeners;if(0!==n.length){for(let t=0,e=n.length;t<e;t++)this._forceAddEventListener(n[t]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}_cleanToRemovedListeners(){const t=this._toRemovedListeners;for(let e=0;e<t.length;++e){const i=t[e],n=this._listenersMap[i._getListenerID()];if(!n)continue;const s=n.getFixedPriorityListeners(),r=n.getSceneGraphPriorityListeners();if(r){const t=r.indexOf(i);-1!==t&&r.splice(t,1)}if(s){const t=s.indexOf(i);-1!==t&&s.splice(t,1)}}t.length=0}_onTouchEventCallback(t,e){if(!t._isRegistered())return!1;const i=e.event,n=i.touch;i.currentTarget=t._getSceneGraphPriority();let s=!1,r=-1;const o=i.getEventCode();if(o===_p.TOUCH_START){if(!qt.ENABLE_MULTI_TOUCH&&Sp._currentTouch){const t=Sp._currentTouchListener._node;if(!t||t.activeInHierarchy)return!1}t.onTouchBegan&&(s=t.onTouchBegan(n,i),s&&t._isRegistered()&&!t._isPaused()&&(t._claimedTouches.push(n),!qt.ENABLE_MULTI_TOUCH&&Sp._currentTouch||(Sp._currentTouch=n),Sp._currentTouchListener=t))}else if(t._claimedTouches.length>0&&(r=t._claimedTouches.indexOf(n),-1!==r)){if(s=!0,!qt.ENABLE_MULTI_TOUCH&&Sp._currentTouch&&Sp._currentTouch!==n)return!1;o===_p.TOUCH_MOVE&&t.onTouchMoved?t.onTouchMoved(n,i):o===_p.TOUCH_END?(t.onTouchEnded&&t.onTouchEnded(n,i),t._isRegistered()&&t._claimedTouches.splice(r,1),(qt.ENABLE_MULTI_TOUCH||Sp._currentTouch===n)&&(Sp._currentTouch=null),Sp._currentTouchListener=null):o===_p.TOUCH_CANCEL&&(t.onTouchCancelled&&t.onTouchCancelled(n,i),t._isRegistered()&&t._claimedTouches.splice(r,1),(qt.ENABLE_MULTI_TOUCH||Sp._currentTouch===n)&&(Sp._currentTouch=null),Sp._currentTouchListener=null)}return i.isStopped()?(Sp._updateTouchListeners(i),!0):!!(s&&t._isRegistered()&&t.swallowTouches)&&(e.needsMutableSet&&e.touches.splice(n,1),!0)}_dispatchTouchEvent(t){this._sortEventListeners(vp.TOUCH_ONE_BY_ONE),this._sortEventListeners(vp.TOUCH_ALL_AT_ONCE);const e=this._getListeners(vp.TOUCH_ONE_BY_ONE),i=this._getListeners(vp.TOUCH_ALL_AT_ONCE);if(null===e&&null===i)return;const s=t.getTouches(),r=n.js.array.copy(s),o={event:t,needsMutableSet:e&&i,touches:r,selTouch:null};if(e)for(let i=0;i<s.length;++i){const n=s[i];t.touch=n,t.propagationStopped=t.propagationImmediateStopped=!1,this._dispatchEventToListeners(e,this._onTouchEventCallback,o)}i&&r.length>0&&(this._dispatchEventToListeners(i,this._onTouchesEventCallback,{event:t,touches:r}),t.isStopped())||this._updateTouchListeners(t)}_onTouchesEventCallback(t,e){if(!t._isRegistered())return!1;const i=e.event,n=e.touches,s=i.getEventCode();return i.currentTarget=t._getSceneGraphPriority(),s===_p.TOUCH_START&&t.onTouchesBegan?t.onTouchesBegan(n,i):s===_p.TOUCH_MOVE&&t.onTouchesMoved?t.onTouchesMoved(n,i):s===_p.TOUCH_END&&t.onTouchesEnded?t.onTouchesEnded(n,i):s===_p.TOUCH_CANCEL&&t.onTouchesCancelled&&t.onTouchesCancelled(n,i),!!i.isStopped()&&(Sp._updateTouchListeners(i),!0)}_associateNodeAndEventListener(t,e){let i=this._nodeListenersMap[t.uuid];i||(i=[],this._nodeListenersMap[t.uuid]=i),i.push(e)}_dissociateNodeAndEventListener(t,e){const i=this._nodeListenersMap[t.uuid];i&&(n.js.array.remove(i,e),0===i.length&&delete this._nodeListenersMap[t.uuid])}_dispatchEventToListeners(t,e,i){let n=!1;const s=t.getFixedPriorityListeners(),r=t.getSceneGraphPriorityListeners();let o=0;if(s&&0!==s.length)for(;o<t.gt0Index;++o){const t=s[o];if(t.isEnabled()&&!t._isPaused()&&t._isRegistered()&&e(t,i)){n=!0;break}}if(r&&!n)for(let t=0;t<r.length;++t){const s=r[t];if(s.isEnabled()&&!s._isPaused()&&s._isRegistered()&&e(s,i)){n=!0;break}}if(s&&!n)for(;o<s.length;++o){const t=s[o];if(t.isEnabled()&&!t._isPaused()&&t._isRegistered()&&e(t,i)){n=!0;break}}}_setDirty(t,e){const i=this._priorityDirtyFlagMap;null==i[t]?i[t]=e:i[t]|=e}_sortNumberAsc(t,e){return t-e}_removeListenerInCallback(t,e){if(null==t)return!1;for(let i=t.length-1;i>=0;i--){const s=t[i];if(s._onCustomEvent===e||s.onEvent===e)return s._setRegistered(!1),null!=s._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(s._getSceneGraphPriority(),s),s._setSceneGraphPriority(null)),0===this._inDispatch?n.js.array.removeAt(t,i):this._toRemovedListeners.push(s),!0}return!1}_removeListenerInVector(t,e){if(null==t)return!1;for(let i=t.length-1;i>=0;i--){const s=t[i];if(s===e)return s._setRegistered(!1),null!=s._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(s._getSceneGraphPriority(),s),s._setSceneGraphPriority(null)),0===this._inDispatch?n.js.array.removeAt(t,i):this._toRemovedListeners.push(s),!0}return!1}});var Ap,Cp,bp,Tp,wp,Ep,Pp,Ip,Dp;n.eventManager=Sp,Gi.Flags.Destroying;const Rp=Gi.Flags.Destroying,Mp=Gi.Flags.DontDestroy,Bp=Gi.Flags.Deactivating,Op=new Q("Node");function Np(t){return t?"string"==typeof t?Nt(t):t:(T(3804),null)}let Lp=t("BaseNode",u_("cc.BaseNode")((Dp=Ip=class t extends Gi{get components(){return this._components}get _persistNode(){return(this._objFlags&Mp)>0}set _persistNode(t){t?this._objFlags|=Mp:this._objFlags&=~Mp}get name(){return this._name}set name(t){this._name=t}get uuid(){return this._id}get children(){return this._children}get active(){return this._active}set active(t){if(this._active!==t){this._active=t;const e=this._parent;e&&e._activeInHierarchy&&n.director._nodeActivator.activateNode(this,t)}}get activeInHierarchy(){return this._activeInHierarchy}get parent(){return this._parent}set parent(t){this.setParent(t)}get scene(){return this._scene}get eventProcessor(){return this._eventProcessor}static _setScene(t){t._updateScene()}static _findComponent(t,e){const i=e,n=t._components;if(i._sealed)for(let t=0;t<n.length;++t){const i=n[t];if(i.constructor===e)return i}else for(let t=0;t<n.length;++t){const i=n[t];if(i instanceof e)return i}return null}static _findComponents(t,e,i){const n=e,s=t._components;if(n._sealed)for(let t=0;t<s.length;++t){const n=s[t];n.constructor===e&&i.push(n)}else for(let t=0;t<s.length;++t){const n=s[t];n instanceof e&&i.push(n)}}static _findChildComponent(e,i){for(let n=0;n<e.length;++n){const s=e[n];let r=t._findComponent(s,i);if(r)return r;if(s._children.length>0&&(r=t._findChildComponent(s._children,i),r))return r}return null}static _findChildComponents(e,i,n){for(let s=0;s<e.length;++s){const r=e[s];t._findComponents(r,i,n),r._children.length>0&&t._findChildComponents(r._children,i,n)}}_updateScene(){null==this._parent?d("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene}constructor(t){super(t),i_(this,"_parent",bp,this),i_(this,"_children",Tp,this),i_(this,"_active",wp,this),i_(this,"_components",Ep,this),i_(this,"_prefab",Pp,this),this._scene=null,this._activeInHierarchy=!1,this._id=Op.getNewId(),this._name=void 0,this._eventProcessor=new n.NodeEventProcessor(this),this._eventMask=0,this._siblingIndex=0,this._originalSceneId="",this._registerIfAttached=void 0,this._name=void 0!==t?t:"New Node"}attr(t){St(this,t)}getParent(){return this._parent}setParent(t,e=!1){if(this._parent===t)return;const i=this._parent,n=t;if(this._parent=n,this._siblingIndex=0,this._onSetParent(i,e),this.emit&&this.emit(_p.PARENT_CHANGED,i),i&&!(i._objFlags&Rp)){const t=i._children.indexOf(this);i._children.splice(t,1),i._updateSiblingIndex(),i.emit&&i.emit(_p.CHILD_REMOVED,this)}n&&(n._children.push(this),this._siblingIndex=n._children.length-1,n.emit&&n.emit(_p.CHILD_ADDED,this)),this._onHierarchyChanged(i)}getChildByUuid(t){if(!t)return u("Invalid uuid"),null;const e=this._children;for(let i=0,n=e.length;i<n;i++)if(e[i]._id===t)return e[i];return null}getChildByName(t){if(!t)return u("Invalid name"),null;const e=this._children;for(let i=0,n=e.length;i<n;i++)if(e[i]._name===t)return e[i];return null}getChildByPath(t){const e=t.split("/");let i=this;for(let t=0;t<e.length;++t){const n=e[t];if(0===n.length)continue;const s=i.children.find((t=>t.name===n));if(!s)return null;i=s}return i}addChild(t){t.setParent(this)}insertChild(t,e){t.parent=this,t.setSiblingIndex(e)}getSiblingIndex(){return this._siblingIndex}setSiblingIndex(t){if(!this._parent)return;if(this._parent._objFlags&Bp)return void T(3821);const e=this._parent._children;t=-1!==t?t:e.length-1;const i=e.indexOf(this);t!==i&&(e.splice(i,1),t<e.length?e.splice(t,0,this):e.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(t))}walk(e,i){let n=1,s=null,r=null,o=0,a=t._stacks[t._stackId];a||(a=[],t._stacks.push(a)),t._stackId++,a.length=0,a[0]=this;let l=null,c=!1;for(;n;)if(n--,r=a[n],r)if(!c&&e?e(r):c&&i&&i(r),a[n]=null,c){if(l===this._parent)break;if(c=!1,s)if(o++,s[o])a[n]=s[o],n++;else if(l&&(a[n]=l,n++,c=!0,l._parent?(s=l._parent._children,o=s.indexOf(l),l=l._parent):(l=null,s=null),o<0))break}else r._children.length>0?(l=r,s=r._children,o=0,a[n]=s[o],n++):(a[n]=r,n++,c=!0);a.length=0,t._stackId--}removeFromParent(){this._parent&&this._parent.removeChild(this)}removeChild(t){this._children.indexOf(t)>-1&&(t.parent=null)}removeAllChildren(){const t=this._children;for(let e=t.length-1;e>=0;e--){const i=t[e];i&&(i.parent=null)}this._children.length=0}isChildOf(t){let e=this;do{if(e===t)return!0;e=e._parent}while(e);return!1}getComponent(e){const i=Np(e);return i?t._findComponent(this,i):null}getComponents(e){const i=Np(e),n=[];return i&&t._findComponents(this,i,n),n}getComponentInChildren(e){const i=Np(e);return i?t._findChildComponent(this._children,i):null}getComponentsInChildren(e){const i=Np(e),n=[];return i&&(t._findComponents(this,i,n),t._findChildComponents(this._children,i,n)),n}addComponent(t){let e;if("string"==typeof t){if(e=Nt(t),!e)throw n._RF.peek()&&T(3808,t),TypeError(I(3807,t))}else{if(!t)throw TypeError(I(3804));e=t}if("function"!=typeof e)throw TypeError(I(3809));if(!bt(e,n.Component))throw TypeError(I(3810));const i=e._requireComponent;i&&!this.getComponent(i)&&this.addComponent(i);const s=new e;return s.node=this,this._components.push(s),this._activeInHierarchy&&n.director._nodeActivator.activateComp(s),s}removeComponent(t){if(!t)return void T(3813);let e=null;e=t instanceof Nm?t:this.getComponent(t),e&&e.destroy()}on(t,e,i,n=!1){switch(t){case _p.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(t,e,i,n)}off(t,e,i,n=!1){if(this._eventProcessor.off(t,e,i,n),!this._eventProcessor.hasEventListener(t))switch(t){case _p.TRANSFORM_CHANGED:this._eventMask&=-2}}once(t,e,i,n){this._eventProcessor.once(t,e,i,n)}emit(t,e,i,n,s,r){this._eventProcessor.emit(t,e,i,n,s,r)}dispatchEvent(t){this._eventProcessor.dispatchEvent(t)}hasEventListener(t,e,i){return this._eventProcessor.hasEventListener(t,e,i)}targetOff(t){this._eventProcessor.targetOff(t),1&this._eventMask&&!this._eventProcessor.hasEventListener(_p.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}destroy(){return!!super.destroy()&&(this.active=!1,!0)}destroyAllChildren(){const t=this._children;for(let e=0;e<t.length;++e)t[e].destroy()}_removeComponent(t){if(t){if(!(this._objFlags&Rp)){const e=this._components.indexOf(t);-1!==e?this._components.splice(e,1):t.node!==this&&T(3815)}}else T(3814)}_updateSiblingIndex(){for(let t=0;t<this._children.length;++t)this._children[t]._siblingIndex=t;this.emit(_p.SIBLING_ORDER_CHANGED)}_onSetParent(e,i=!1){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(t._setScene))}_onPostActivated(t){}_onBatchCreated(t){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}_onPreDestroy(){this._onPreDestroyBase()}_onHierarchyChanged(t){return this._onHierarchyChangedBase(t)}_instantiate(t,e){return t||(t=n.instantiate._clone(this,this)),t._prefab,t._parent=null,t._onBatchCreated(e),t}_onHierarchyChangedBase(t){const e=this._parent;!this._persistNode||e instanceof n.Scene||n.game.removePersistRootNode(this);const i=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==i&&n.director._nodeActivator.activateNode(this,i)}_onPreDestroyBase(){this._objFlags|=Rp;const t=this._parent,e=!!t&&0!=(t._objFlags&Rp);if(this._persistNode&&n.game.removePersistRootNode(this),!e&&t){this.emit(_p.PARENT_CHANGED,this);const e=t._children.indexOf(this);t._children.splice(e,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit(_p.CHILD_REMOVED,this)}this.emit(_p.NODE_DESTROYED,this),this._eventProcessor.destroy();const i=this._children;for(let t=0;t<i.length;++t)i[t]._destroyImmediate();const s=this._components;for(let t=0;t<s.length;++t)s[t]._destroyImmediate();return e}},Ip.idGenerator=Op,Ip._stacks=[[]],Ip._stackId=0,n_((Cp=Dp).prototype,"_persistNode",[f_],Object.getOwnPropertyDescriptor(Cp.prototype,"_persistNode"),Cp.prototype),n_(Cp.prototype,"name",[w_],Object.getOwnPropertyDescriptor(Cp.prototype,"name"),Cp.prototype),n_(Cp.prototype,"children",[w_],Object.getOwnPropertyDescriptor(Cp.prototype,"children"),Cp.prototype),n_(Cp.prototype,"active",[w_],Object.getOwnPropertyDescriptor(Cp.prototype,"active"),Cp.prototype),n_(Cp.prototype,"activeInHierarchy",[w_],Object.getOwnPropertyDescriptor(Cp.prototype,"activeInHierarchy"),Cp.prototype),n_(Cp.prototype,"parent",[w_],Object.getOwnPropertyDescriptor(Cp.prototype,"parent"),Cp.prototype),bp=n_(Cp.prototype,"_parent",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tp=n_(Cp.prototype,"_children",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wp=n_(Cp.prototype,"_active",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ep=n_(Cp.prototype,"_components",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pp=n_(Cp.prototype,"_prefab",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ap=Cp))||Ap);function Fp(t){const e=t._prefab;if(!e)return;if(!e.instance)return;if(!e.asset)return T(3701,t.name),void(e.instance=void 0);const i=t._objFlags,s=t._parent,r=t._id,o=t._prefab;n.game._isCloning=!0,e.asset._doInstantiate(t),n.game._isCloning=!1,t._objFlags=i,t._parent=s,t._id=r,t._prefab&&(t._prefab.instance=null==o?void 0:o.instance)}function zp(t,e,i){var n;if(!e)return;let s=e;const r=null===(n=t._prefab)||void 0===n?void 0:n.instance;!i&&r&&(e[r.fileId]={},s=e[r.fileId]);const o=t._prefab;o&&(s[o.fileId]=t);const a=t.components;for(let t=0;t<a.length;t++){const e=a[t];e.__prefab&&(s[e.__prefab.fileId]=e)}for(let e=0;e<t.children.length;e++)zp(t.children[e],s,!1)}function Vp(t,e){if(!t)return null;let i=null,n=e;for(let e=0;e<t.length;e++){if(!n)return null;n=n[t[e]]}return i=n,i}function Up(t,e,i){if(e)for(let t=0;t<e.length;t++){const n=e[t];if(n&&n.targetInfo){const t=Vp(n.targetInfo.localID,i);if(!t)continue;let e=i;const s=n.targetInfo.localID;if(s.length>0)for(let t=0;t<s.length-1;t++)e=e[s[t]];if(n.nodes)for(let i=0;i<n.nodes.length;i++){const s=n.nodes[i];s&&(t._children.push(s),s._parent=t,zp(s,e,!1),s._siblingIndex=t._children.length-1,s._onBatchCreated(!1))}}}}function Gp(t,e,i){if(e)for(let t=0;t<e.length;t++){const n=e[t];if(n&&n.targetInfo){const t=Vp(n.targetInfo.localID,i);if(!t)continue;if(n.components)for(let e=0;e<n.components.length;e++){const i=n.components[e];i&&(i.node=t,t._components.push(i))}}}}function Hp(t,e,i){if(e)for(let t=0;t<e.length;t++){const n=e[t];if(n){const t=Vp(n.localID,i);if(!t||!t.node)continue;const e=t.node.components.indexOf(t);e>=0&&t.node._components.splice(e,1)}}}function kp(t,e,i){if(e.length<=0)return;let n=null;for(let t=0;t<e.length;t++){const s=e[t];if(s&&s.targetInfo){if(n=Vp(s.targetInfo.localID,i),!n)continue;let t=n;const e=s.propertyPath.slice();if(e.length>0){const i=e.pop();if(!i)continue;for(let i=0;i<e.length&&(t=t[e[i]],t);i++);if(!t)continue;if(Array.isArray(t))if("length"===i)t[i]=s.value;else{const e=Number.parseInt(i);Number.isInteger(e)&&e<t.length&&(t[i]=s.value)}else t[i]=s.value}}}}function jp(t){var e;const i=null===(e=t._prefab)||void 0===e?void 0:e.targetOverrides;if(i)for(let t=0;t<i.length;t++){var n,s;const e=i[t];let a=e.source;const l=e.sourceInfo;if(l){var r,o;const t=null===(r=e.source)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;t&&t.targetMap&&(a=Vp(l.localID,t.targetMap))}if(!a)continue;let c=null;const h=e.targetInfo;if(!h)continue;const _=null===(n=e.target)||void 0===n||null===(s=n._prefab)||void 0===s?void 0:s.instance;if(!_||!_.targetMap)continue;if(c=Vp(h.localID,_.targetMap),!c)continue;const u=e.propertyPath.slice();let m=a;if(u.length>0){const t=u.pop();if(!t)return;for(let t=0;t<u.length&&(m=m[u[t]],m);t++);if(!m)continue;m[t]=c}}}var Wp,qp,Xp,Yp,Kp,Jp,$p,Zp,Qp,tf,ef;n._BaseNode=Lp;const nf=new oi,sf=new mi,rf=new mi,of=new Array(10),af=new mi,lf=new hi,cf=new hi,hf=new Si,_f=new Map;let uf=t("Node",(Wp=u_("cc.Node"),qp=H_(oi),Wp((ef=tf=class t extends Lp{constructor(t){super(t),this._uiProps=new hp(this),this._static=!1,this._pos=new oi,this._rot=new mi,this._scale=new oi(1,1,1),this._mat=new Si,i_(this,"_lpos",Kp,this),i_(this,"_lrot",Jp,this),i_(this,"_lscale",$p,this),i_(this,"_layer",Zp,this),i_(this,"_euler",Qp,this),this._dirtyFlags=t_.NONE,this._eulerDirty=!1,this._poolHandle=0,this._poolHandle=xs.alloc(),xs.set(this._poolHandle,ys.LAYER,this._layer)}static isNode(e){return e instanceof t&&(e.constructor===t||!(e instanceof n.Scene))}destroy(){return this._poolHandle&&(xs.free(this._poolHandle),this._poolHandle=0),super.destroy()}get handle(){return this._poolHandle}get position(){return this._lpos}set position(t){this.setPosition(t)}get worldPosition(){return this.updateWorldTransform(),this._pos}set worldPosition(t){this.setWorldPosition(t)}get rotation(){return this._lrot}set rotation(t){this.setRotation(t)}set eulerAngles(t){this.setRotationFromEuler(t.x,t.y,t.z)}get eulerAngles(){return this._eulerDirty&&(mi.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}get angle(){return this._euler.z}set angle(t){oi.set(this._euler,0,0,t),mi.fromAngleZ(this._lrot,t),this._eulerDirty=!1,this.invalidateChildren(t_.ROTATION),1&this._eventMask&&this.emit(_p.TRANSFORM_CHANGED,t_.ROTATION)}get worldRotation(){return this.updateWorldTransform(),this._rot}set worldRotation(t){this.setWorldRotation(t)}get scale(){return this._lscale}set scale(t){this.setScale(t)}get worldScale(){return this.updateWorldTransform(),this._scale}set worldScale(t){this.setWorldScale(t)}set matrix(t){Si.toRTS(t,this._lrot,this._lpos,this._lscale),this.invalidateChildren(t_.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(_p.TRANSFORM_CHANGED,t_.TRS)}get worldMatrix(){return this.updateWorldTransform(),this._mat}get forward(){return oi.transformQuat(new oi,oi.FORWARD,this.worldRotation)}set forward(t){const e=t.length();oi.multiplyScalar(nf,t,-1/e),mi.fromViewUp(sf,nf),this.setWorldRotation(sf)}set layer(t){this._layer=t,xs.set(this._poolHandle,ys.LAYER,this._layer),this.emit(_p.LAYER_CHANGED,this._layer)}get layer(){return this._layer}get hasChangedFlags(){return _f.get(this)||0}set hasChangedFlags(t){_f.set(this,t),xs.set(this._poolHandle,ys.FLAGS_CHANGED,t)}setParent(t,e=!1){e&&this.updateWorldTransform(),super.setParent(t,e)}_onSetParent(t,e){if(super._onSetParent(t,e),e){const t=this._parent;t?(t.updateWorldTransform(),Si.multiply(hf,Si.invert(hf,t._mat),this._mat),Si.toRTS(hf,this._lrot,this._lpos,this._lscale)):(oi.copy(this._lpos,this._pos),mi.copy(this._lrot,this._rot),oi.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(t_.TRS)}_onHierarchyChanged(t){this.eventProcessor.reattach(),super._onHierarchyChangedBase(t)}_onBatchCreated(t){var e;xs.set(this._poolHandle,ys.LAYER,this._layer),xs.setVec3(this._poolHandle,ys.WORLD_SCALE,this._scale);const i=null===(e=this._prefab)||void 0===e?void 0:e.instance;!t&&i&&Fp(this),this.hasChangedFlags=t_.TRS,this._dirtyFlags=t_.TRS;const n=this._children.length;for(let e=0;e<n;++e)this._children[e]._siblingIndex=e,this._children[e]._onBatchCreated(t);if(!t&&i){const t={};i.targetMap=t,zp(this,t,!0),Up(0,i.mountedChildren,t),Hp(0,i.removedComponents,t),Gp(0,i.mountedComponents,t),kp(0,i.propertyOverrides,t)}jp(this)}_onBeforeSerialize(){this.eulerAngles}_onPostActivated(t){t?(Sp.resumeTarget(this),this.invalidateChildren(t_.TRS)):Sp.pauseTarget(this)}translate(t,e){const i=e||Qh.LOCAL;if(i===Qh.LOCAL)oi.transformQuat(nf,t,this._lrot),this._lpos.x+=nf.x,this._lpos.y+=nf.y,this._lpos.z+=nf.z;else if(i===Qh.WORLD)if(this._parent){mi.invert(sf,this._parent.worldRotation),oi.transformQuat(nf,t,sf);const e=this.worldScale;this._lpos.x+=nf.x/e.x,this._lpos.y+=nf.y/e.y,this._lpos.z+=nf.z/e.z}else this._lpos.x+=t.x,this._lpos.y+=t.y,this._lpos.z+=t.z;this.invalidateChildren(t_.POSITION),1&this._eventMask&&this.emit(_p.TRANSFORM_CHANGED,t_.POSITION),xs.setVec3(this._poolHandle,ys.WORLD_POSITION,this.worldPosition)}rotate(t,e){const i=e||Qh.LOCAL;if(mi.normalize(sf,t),i===Qh.LOCAL)mi.multiply(this._lrot,this._lrot,sf);else if(i===Qh.WORLD){const t=this.worldRotation;mi.multiply(rf,sf,t),mi.invert(sf,t),mi.multiply(rf,sf,rf),mi.multiply(this._lrot,this._lrot,rf)}this._eulerDirty=!0,this.invalidateChildren(t_.ROTATION),1&this._eventMask&&this.emit(_p.TRANSFORM_CHANGED,t_.ROTATION),xs.setVec4(this._poolHandle,ys.WORLD_ROTATION,this.worldRotation)}lookAt(t,e){this.getWorldPosition(nf),oi.subtract(nf,nf,t),oi.normalize(nf,nf),mi.fromViewUp(sf,nf,e),this.setWorldRotation(sf)}invalidateChildren(t){const e=this.hasChangedFlags;if((this._dirtyFlags&e&t)===t)return;this._dirtyFlags|=t,this.hasChangedFlags=e|t;const i=t|t_.POSITION,n=this._children.length;for(let t=0;t<n;++t){const e=this._children[t];e.isValid&&e.invalidateChildren(i)}}updateWorldTransform(){if(!this._dirtyFlags)return;let t,e=this,i=0;for(;e&&e._dirtyFlags;)of[i++]=e,e=e._parent;let n=0;for(;i;)t=of[--i],n|=t._dirtyFlags,e?(n&t_.POSITION&&(oi.transformMat4(t._pos,t._lpos,e._mat),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z,xs.setVec3(t._poolHandle,ys.WORLD_POSITION,t._pos)),n&t_.RS&&(Si.fromRTS(t._mat,t._lrot,t._lpos,t._lscale),Si.multiply(t._mat,e._mat,t._mat),n&t_.ROTATION&&(mi.multiply(t._rot,e._rot,t._lrot),xs.setVec4(t._poolHandle,ys.WORLD_ROTATION,t._rot)),hi.fromQuat(lf,mi.conjugate(af,t._rot)),hi.multiplyMat4(lf,lf,t._mat),t._scale.x=lf.m00,t._scale.y=lf.m04,t._scale.z=lf.m08,xs.setVec3(t._poolHandle,ys.WORLD_SCALE,t._scale))):(n&t_.POSITION&&(oi.copy(t._pos,t._lpos),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z,xs.setVec3(t._poolHandle,ys.WORLD_POSITION,t._pos)),n&t_.RS&&(n&t_.ROTATION&&(mi.copy(t._rot,t._lrot),xs.setVec4(t._poolHandle,ys.WORLD_ROTATION,t._rot)),n&t_.SCALE&&(oi.copy(t._scale,t._lscale),xs.setVec3(t._poolHandle,ys.WORLD_SCALE,t._scale),Si.fromRTS(t._mat,t._rot,t._pos,t._scale)))),n!==t_.NONE&&xs.setMat4(t._poolHandle,ys.WORLD_MATRIX,t._mat),t._dirtyFlags=t_.NONE,e=t}setPosition(t,e,i){void 0===e&&void 0===i?oi.copy(this._lpos,t):void 0===i?oi.set(this._lpos,t,e,this._lpos.z):oi.set(this._lpos,t,e,i),this.invalidateChildren(t_.POSITION),1&this._eventMask&&this.emit(_p.TRANSFORM_CHANGED,t_.POSITION)}getPosition(t){return t?oi.set(t,this._lpos.x,this._lpos.y,this._lpos.z):oi.copy(new oi,this._lpos)}setRotation(t,e,i,n){void 0===e||void 0===i||void 0===n?mi.copy(this._lrot,t):mi.set(this._lrot,t,e,i,n),this._eulerDirty=!0,this.invalidateChildren(t_.ROTATION),1&this._eventMask&&this.emit(_p.TRANSFORM_CHANGED,t_.ROTATION)}setRotationFromEuler(t,e,i){const n=void 0===i?this._euler.z:i;void 0===e?(oi.copy(this._euler,t),mi.fromEuler(this._lrot,t.x,t.y,t.z)):(oi.set(this._euler,t,e,n),mi.fromEuler(this._lrot,t,e,n)),this._eulerDirty=!1,this.invalidateChildren(t_.ROTATION),1&this._eventMask&&this.emit(_p.TRANSFORM_CHANGED,t_.ROTATION)}getRotation(t){return t?mi.set(t,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):mi.copy(new mi,this._lrot)}setScale(t,e,i){void 0===e&&void 0===i?oi.copy(this._lscale,t):void 0===i?oi.set(this._lscale,t,e,this._lscale.z):oi.set(this._lscale,t,e,i),this.invalidateChildren(t_.SCALE),1&this._eventMask&&this.emit(_p.TRANSFORM_CHANGED,t_.SCALE)}getScale(t){return t?oi.set(t,this._lscale.x,this._lscale.y,this._lscale.z):oi.copy(new oi,this._lscale)}inverseTransformPoint(t,e){oi.copy(t,e);let i=this,n=0;for(;i._parent;)of[n++]=i,i=i._parent;for(;n>=0;)oi.transformInverseRTS(t,t,i._lrot,i._lpos,i._lscale),i=of[--n];return t}setWorldPosition(t,e,i){void 0===e||void 0===i?oi.copy(this._pos,t):oi.set(this._pos,t,e,i),xs.setVec3(this._poolHandle,ys.WORLD_POSITION,this._pos);const n=this._parent,s=this._lpos;n?(n.updateWorldTransform(),oi.transformMat4(s,this._pos,Si.invert(hf,n._mat))):oi.copy(s,this._pos),this.invalidateChildren(t_.POSITION),1&this._eventMask&&this.emit(_p.TRANSFORM_CHANGED,t_.POSITION)}getWorldPosition(t){return this.updateWorldTransform(),t?oi.copy(t,this._pos):oi.copy(new oi,this._pos)}setWorldRotation(t,e,i,n){void 0===e||void 0===i||void 0===n?mi.copy(this._rot,t):mi.set(this._rot,t,e,i,n),xs.setVec4(this._poolHandle,ys.WORLD_ROTATION,this._rot),this._parent?(this._parent.updateWorldTransform(),mi.multiply(this._lrot,mi.conjugate(this._lrot,this._parent._rot),this._rot)):mi.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(t_.ROTATION),1&this._eventMask&&this.emit(_p.TRANSFORM_CHANGED,t_.ROTATION)}setWorldRotationFromEuler(t,e,i){mi.fromEuler(this._rot,t,e,i),this._parent?(this._parent.updateWorldTransform(),mi.multiply(this._lrot,mi.conjugate(this._lrot,this._parent._rot),this._rot)):mi.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(t_.ROTATION),1&this._eventMask&&this.emit(_p.TRANSFORM_CHANGED,t_.ROTATION)}getWorldRotation(t){return this.updateWorldTransform(),t?mi.copy(t,this._rot):mi.copy(new mi,this._rot)}setWorldScale(t,e,i){void 0===e||void 0===i?oi.copy(this._scale,t):oi.set(this._scale,t,e,i),xs.setVec3(this._poolHandle,ys.WORLD_SCALE,this._scale);const n=this._parent;n?(n.updateWorldTransform(),hi.fromQuat(lf,mi.conjugate(af,n._rot)),hi.multiplyMat4(lf,lf,n._mat),cf.m00=this._scale.x,cf.m04=this._scale.y,cf.m08=this._scale.z,hi.multiply(lf,cf,hi.invert(lf,lf)),this._lscale.x=oi.set(nf,lf.m00,lf.m01,lf.m02).length(),this._lscale.y=oi.set(nf,lf.m03,lf.m04,lf.m05).length(),this._lscale.z=oi.set(nf,lf.m06,lf.m07,lf.m08).length()):oi.copy(this._lscale,this._scale),this.invalidateChildren(t_.SCALE),1&this._eventMask&&this.emit(_p.TRANSFORM_CHANGED,t_.SCALE)}getWorldScale(t){return this.updateWorldTransform(),t?oi.copy(t,this._scale):oi.copy(new oi,this._scale)}getWorldMatrix(t){this.updateWorldTransform();const e=t||new Si;return Si.copy(e,this._mat)}getWorldRS(t){this.updateWorldTransform();const e=t||new Si;return Si.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}getWorldRT(t){this.updateWorldTransform();const e=t||new Si;return Si.fromRT(e,this._rot,this._pos)}setRTS(t,e,i){let n=0;t&&(n|=t_.ROTATION,void 0!==t.w?(mi.copy(this._lrot,t),this._eulerDirty=!0):(oi.copy(this._euler,t),mi.fromEuler(this._lrot,t.x,t.y,t.z),this._eulerDirty=!1)),e&&(oi.copy(this._lpos,e),n|=t_.POSITION),i&&(oi.copy(this._lscale,i),n|=t_.SCALE),n&&(this.invalidateChildren(n),1&this._eventMask&&this.emit(_p.TRANSFORM_CHANGED,n))}pauseSystemEvents(t){Sp.pauseTarget(this,t)}resumeSystemEvents(t){Sp.resumeTarget(this,t)}static clearBooks(){_f.forEach(((t,e)=>{e.isValid&&(e.hasChangedFlags=t_.NONE)})),_f.clear()}syncToNativeTransform(){const t=this.hasChangedFlags;t&&(t&t_.POSITION&&xs.setVec3(this._poolHandle,ys.WORLD_POSITION,this.worldPosition),t&t_.ROTATION&&xs.setVec3(this._poolHandle,ys.WORLD_ROTATION,this.worldRotation),t&t_.SCALE&&xs.setVec3(this._poolHandle,ys.WORLD_SCALE,this.worldScale))}syncFromNativeTransform(){const t=xs.get(this._poolHandle,ys.FLAGS_CHANGED);t&&(t&t_.POSITION&&(xs.getVec3(this._poolHandle,ys.WORLD_POSITION,nf),this.setWorldPosition(nf)),t&t_.ROTATION&&(xs.getVec4(this._poolHandle,ys.WORLD_ROTATION,sf),this.setWorldRotation(sf)),t&t_.SCALE&&(xs.getVec3(this._poolHandle,ys.WORLD_SCALE,nf),this.setWorldScale(nf)))}},tf.bookOfChange=_f,tf.EventType=_p,tf.NodeSpace=Qh,tf.TransformDirtyBit=t_,tf.TransformBit=t_,Kp=n_((Yp=ef).prototype,"_lpos",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oi}}),Jp=n_(Yp.prototype,"_lrot",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mi}}),$p=n_(Yp.prototype,"_lscale",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oi(1,1,1)}}),Zp=n_(Yp.prototype,"_layer",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ec.Enum.DEFAULT}}),Qp=n_(Yp.prototype,"_euler",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oi}}),n_(Yp.prototype,"eulerAngles",[qp],Object.getOwnPropertyDescriptor(Yp.prototype,"eulerAngles"),Yp.prototype),n_(Yp.prototype,"angle",[w_],Object.getOwnPropertyDescriptor(Yp.prototype,"angle"),Yp.prototype),n_(Yp.prototype,"layer",[w_],Object.getOwnPropertyDescriptor(Yp.prototype,"layer"),Yp.prototype),Xp=Yp))||Xp));var mf,df,pf,ff,gf,yf,vf,xf,Sf,Af,Cf,bf,Tf,wf,Ef,Pf,If,Df,Rf,Mf,Bf,Of,Nf,Lf,Ff,zf,Vf,Uf,Gf,Hf,kf,jf,Wf,qf,Xf,Yf,Kf,Jf,$f,Zf,Qf,tg,eg,ig,ng,sg,rg,og,ag,lg,cg,hg,_g,ug,mg,dg,pg,fg,gg,yg,vg,xg,Sg,Ag,Cg;n.Node=uf;let bg=u_("cc.TargetInfo")((pf=n_((df=class{constructor(){i_(this,"localID",pf,this)}}).prototype,"localID",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mf=df))||mf,Tg=(ff=u_("cc.TargetOverrideInfo"),gf=H_(Gi),yf=H_(bg),vf=H_(uf),xf=H_(bg),ff((Cf=n_((Af=class{constructor(){i_(this,"source",Cf,this),i_(this,"sourceInfo",bf,this),i_(this,"propertyPath",Tf,this),i_(this,"target",wf,this),i_(this,"targetInfo",Ef,this)}}).prototype,"source",[g_,gf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bf=n_(Af.prototype,"sourceInfo",[g_,yf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tf=n_(Af.prototype,"propertyPath",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wf=n_(Af.prototype,"target",[g_,vf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ef=n_(Af.prototype,"targetInfo",[g_,xf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sf=Af))||Sf),wg=u_("cc.CompPrefabInfo")((Df=n_((If=class{constructor(){i_(this,"fileId",Df,this)}}).prototype,"fileId",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Pf=If))||Pf,Eg=(Rf=u_("CCPropertyOverrideInfo"),Mf=H_(bg),Rf((Nf=n_((Of=class{constructor(){i_(this,"targetInfo",Nf,this),i_(this,"propertyPath",Lf,this),i_(this,"value",Ff,this)}isTarget(t,e){}}).prototype,"targetInfo",[g_,Mf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lf=n_(Of.prototype,"propertyPath",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ff=n_(Of.prototype,"value",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Bf=Of))||Bf),Pg=(zf=u_("cc.MountedChildrenInfo"),Vf=H_(bg),Uf=H_([uf]),zf((kf=n_((Hf=class{constructor(){i_(this,"targetInfo",kf,this),i_(this,"nodes",jf,this)}isTarget(t){}}).prototype,"targetInfo",[g_,Vf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jf=n_(Hf.prototype,"nodes",[g_,Uf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gf=Hf))||Gf),Ig=(Wf=u_("cc.MountedComponentsInfo"),qf=H_(bg),Xf=H_([Nm]),Wf((Jf=n_((Kf=class{constructor(){i_(this,"targetInfo",Jf,this),i_(this,"components",$f,this)}isTarget(t){}}).prototype,"targetInfo",[g_,qf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$f=n_(Kf.prototype,"components",[g_,Xf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yf=Kf))||Yf),Dg=(Zf=u_("cc.PrefabInstance"),Qf=H_(uf),tg=H_([Pg]),eg=H_([Ig]),ig=H_([Eg]),ng=H_([bg]),Zf((og=n_((rg=class{constructor(){i_(this,"fileId",og,this),i_(this,"prefabRootNode",ag,this),i_(this,"mountedChildren",lg,this),i_(this,"mountedComponents",cg,this),i_(this,"propertyOverrides",hg,this),i_(this,"removedComponents",_g,this),this.targetMap={}}findPropertyOverride(t,e){}removePropertyOverride(t,e){}}).prototype,"fileId",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ag=n_(rg.prototype,"prefabRootNode",[g_,Qf],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lg=n_(rg.prototype,"mountedChildren",[g_,tg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cg=n_(rg.prototype,"mountedComponents",[g_,eg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hg=n_(rg.prototype,"propertyOverrides",[g_,ig],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_g=n_(rg.prototype,"removedComponents",[g_,ng],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sg=rg))||sg),Rg=(ug=u_("cc.PrefabInfo"),mg=H_(uf),dg=H_(n.Prefab),pg=H_(Dg),fg=H_([Tg]),ug((vg=n_((yg=class{constructor(){i_(this,"root",vg,this),i_(this,"asset",xg,this),i_(this,"fileId",Sg,this),i_(this,"instance",Ag,this),i_(this,"targetOverrides",Cg,this)}}).prototype,"root",[g_,mg],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),xg=n_(yg.prototype,"asset",[g_,dg],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Sg=n_(yg.prototype,"fileId",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ag=n_(yg.prototype,"instance",[g_,pg],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Cg=n_(yg.prototype,"targetOverrides",[g_,fg],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),gg=yg))||gg);n._PrefabInfo=Rg;var Mg,Bg,Og,Ng,Lg,Fg,zg=Object.freeze({__proto__:null,TargetInfo:bg,TargetOverrideInfo:Tg,CompPrefabInfo:wg,PropertyOverrideInfo:Eg,MountedChildrenInfo:Pg,MountedComponentsInfo:Ig,PrefabInstance:Dg,PrefabInfo:Rg,createNodeWithPrefab:Fp,generateTargetMap:zp,getTarget:Vp,applyMountedChildren:Up,applyMountedComponents:Gp,applyRemovedComponents:Hp,applyPropertyOverrides:kp,applyTargetOverrides:jp});const Vg=Gt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2});let Ug=t("Prefab",u_("cc.Prefab")((Fg=Lg=class t extends xu{constructor(){super(),i_(this,"data",Og,this),i_(this,"optimizationPolicy",Ng,this),this._createFunction=void 0,this._instantiatedTimes=void 0,this._createFunction=null,this._instantiatedTimes=0}createNode(t){const e=n.instantiate(this);e.name=this.name,t(null,e)}compileCreateFunction(){this._createFunction=function(t){const e=t instanceof n._BaseNode&&t;return new lp(t,e).result}(this.data)}_doInstantiate(t){return this.data._prefab||C(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(t)}_instantiate(){let e,i=!1;return i=this.optimizationPolicy!==Vg.SINGLE_INSTANCE&&(this.optimizationPolicy===Vg.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold),i?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e}initDefault(t){super.initDefault(t),this.data=new uf,this.data.name="(Missing Node)";const e=new Rg;e.asset=this,e.root=this.data,this.data._prefab=e}validate(){return!!this.data}},Lg.OptimizationPolicy=Vg,Lg.OptimizationPolicyThreshold=3,Og=n_((Bg=Fg).prototype,"data",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ng=n_(Bg.prototype,"optimizationPolicy",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vg.AUTO}}),Mg=Bg))||Mg);var Gg,Hg,kg,jg,Wg,qg;Vt.value(Ug,"_utils",zg),n.Prefab=Ug,ut(n,"cc._Prefab","Prefab"),t("PrefabLink",(Gg=u_("cc.PrefabLink"),Hg=H_(Ug),kg=E_(),Gg((qg=n_((Wg=class extends Nm{constructor(...t){super(...t),i_(this,"prefab",qg,this)}}).prototype,"prefab",[Hg,g_,kg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jg=Wg))||jg));const Xg=new oi;function Yg(t,e,i,n){n||(n=new oi),t.convertToUINode(e,i,n);const s=i.position;return n.add(s),n}function Kg(t,e,i){return i||(i=new oi),t.worldToScreen(e,i),i.x/=n.view.getScaleX(),i.y/=n.view.getScaleY(),i}const Jg=t("convertUtils",{WorldNode3DToLocalNodeUI:Yg,WorldNode3DToWorldNodeUI:Kg});n.pipelineUtils=Jg,z(n.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction(...t){const e=t[0],i=t[3]||Xg;return e.convertToUINode(t[1],t[2],i),i.add(t[2].position),t[3]||i.clone()}}]),z(_p,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]);class $g{constructor(){this.support=void 0,this._intervalInSeconds=.2,this._intervalId=void 0,this._isEnabled=!1,this._eventTarget=new Zi,this._didAccelerateFunc=void 0;const t=hn.isMobile;this.support=t,this._didAccelerateFunc=this._didAccelerate.bind(this)}_didAccelerate(){const t=jsb.device.getDeviceMotionValue();let e=.1*t[3],i=.1*t[4];const n=.1*t[5],s=hn.getOrientation(),r=e;s===rn.LANDSCAPE_RIGHT?(e=-i,i=r):s===rn.LANDSCAPE_LEFT?(e=i,i=-r):s===rn.PORTRAIT_UPSIDE_DOWN&&(e=-e,i=-i),hn.os!==sn.ANDROID&&hn.os!==sn.OHOS||(e=-e,i=-i);const o={type:_p.DEVICEMOTION,x:e,y:i,z:n,timestamp:performance.now()};this._eventTarget.emit(_p.DEVICEMOTION,o)}start(){this._intervalId&&clearInterval(this._intervalId),this._intervalId=setInterval(this._didAccelerateFunc,1e3*this._intervalInSeconds),jsb.device.setAccelerometerInterval(this._intervalInSeconds),jsb.device.setAccelerometerEnabled(!0),this._isEnabled=!0}stop(){this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),jsb.device.setAccelerometerEnabled(!1),this._isEnabled=!1}setInterval(t){this._intervalInSeconds=t/1e3,jsb.device.setAccelerometerInterval(this._intervalInSeconds),this._isEnabled&&(jsb.device.setAccelerometerEnabled(!1),jsb.device.setAccelerometerEnabled(!0))}onChange(t){this._eventTarget.on(_p.DEVICEMOTION,t)}}class Zg{constructor(){this.support=void 0,this.support=!0}show(){throw new Error("Method not implemented.")}hide(){throw new Error("Method not implemented.")}onChange(){throw new Error("Method not implemented.")}onComplete(){throw new Error("Method not implemented.")}offChange(){throw new Error("Method not implemented.")}offComplete(){throw new Error("Method not implemented.")}}class Qg{constructor(){this.support=void 0,this._eventTarget=new Zi,this.support=!hn.isMobile,this._registerEvent()}_registerEvent(){jsb.onKeyDown=this._createCallback(_p.KEY_DOWN),jsb.onKeyUp=this._createCallback(_p.KEY_UP)}_createCallback(t){return e=>{const i={type:t,code:e.keyCode,timestamp:performance.now()};this._eventTarget.emit(t,i)}}onDown(t){this._eventTarget.on(_p.KEY_DOWN,t)}onUp(t){this._eventTarget.on(_p.KEY_UP,t)}}class ty{constructor(){this.support=void 0,this._eventTarget=new Zi,this.support=!hn.isMobile,this._registerEvent()}_getLocation(t){return new Ti(t.x,t.y)}_registerEvent(){jsb.onMouseDown=this._createCallback(_p.MOUSE_DOWN),jsb.onMouseMove=this._createCallback(_p.MOUSE_MOVE),jsb.onMouseUp=this._createCallback(_p.MOUSE_UP),jsb.onMouseWheel=t=>{const e=this._getLocation(t),i=hn.getViewSize(),n={type:_p.MOUSE_WHEEL,x:e.x,y:i.height-e.y,button:t.button,deltaX:120*t.wheelDeltaX,deltaY:120*t.wheelDeltaY,timestamp:performance.now()};this._eventTarget.emit(_p.MOUSE_WHEEL,n)}}_createCallback(t){return e=>{const i=this._getLocation(e),n=hn.getViewSize(),s={type:t,x:i.x,y:n.height-i.y,button:e.button,timestamp:performance.now()};this._eventTarget.emit(t,s)}}onDown(t){this._eventTarget.on(_p.MOUSE_DOWN,t)}onMove(t){this._eventTarget.on(_p.MOUSE_MOVE,t)}onUp(t){this._eventTarget.on(_p.MOUSE_UP,t)}onWheel(t){this._eventTarget.on(_p.MOUSE_WHEEL,t)}}class ey{constructor(){this.support=void 0,this._eventTarget=new Zi,this.support=!0,this._registerEvent()}_registerEvent(){jsb.onTouchStart=this._createCallback(_p.TOUCH_START),jsb.onTouchMove=this._createCallback(_p.TOUCH_MOVE),jsb.onTouchEnd=this._createCallback(_p.TOUCH_END),jsb.onTouchCancel=this._createCallback(_p.TOUCH_CANCEL)}_createCallback(t){return e=>{const i=[],n=e.length,s=hn.getViewSize();for(let t=0;t<n;++t){const n=e[t],r=this._getLocation(n),o=r.x,a=s.height-r.y,l={identifier:n.identifier,x:o,y:a,force:n.force};i.push(l)}const r={type:t,changedTouches:i,timestamp:performance.now()};this._eventTarget.emit(t,r)}}_getLocation(t){return new Ti(t.clientX,t.clientY)}onStart(t){this._eventTarget.on(_p.TOUCH_START,t)}onMove(t){this._eventTarget.on(_p.TOUCH_MOVE,t)}onEnd(t){this._eventTarget.on(_p.TOUCH_END,t)}onCancel(t){this._eventTarget.on(_p.TOUCH_CANCEL,t)}}const iy=new class{constructor(){this._touch=new ey,this._mouse=new ty,this._keyboard=new Qg,this._accelerometer=new $g,this._inputBox=new Zg,this._inputEventList=[],this._registerEvent()}_registerEvent(){}_pushEvent(t){this._inputEventList.push(t)}pollEvent(){return this._inputEventList.shift()}},ny=new Ti;class sy extends vu{constructor(t,e,i){super(vu.MOUSE,e),this.movementX=0,this.movementY=0,this.eventType=void 0,this._button=sy.BUTTON_MISSING,this._x=0,this._y=0,this._prevX=0,this._prevY=0,this._scrollX=0,this._scrollY=0,this.eventType=t,i&&(this._prevX=i.x,this._prevY=i.y)}setScrollData(t,e){this._scrollX=t,this._scrollY=e}getScrollX(){return this._scrollX}getScrollY(){return this._scrollY}setLocation(t,e){this._x=t,this._y=e}getLocation(t){return t||(t=new Ti),Ti.set(t,this._x,this._y),t}getLocationInView(t){return t||(t=new Ti),Ti.set(t,this._x,n.view._designResolutionSize.height-this._y),t}getUILocation(t){return t||(t=new Ti),Ti.set(t,this._x,this._y),n.view._convertPointWithScale(t),t}getPreviousLocation(t){return t||(t=new Ti),Ti.set(t,this._prevX,this._prevY),t}getUIPreviousLocation(t){return t||(t=new Ti),Ti.set(t,this._prevX,this._prevY),n.view._convertPointWithScale(t),t}getDelta(t){return t||(t=new Ti),Ti.set(t,this._x-this._prevX,this._y-this._prevY),t}getDeltaX(){return this._x-this._prevX}getDeltaY(){return this._y-this._prevY}getUIDelta(t){return t||(t=new Ti),Ti.set(t,(this._x-this._prevX)/n.view.getScaleX(),(this._y-this._prevY)/n.view.getScaleY()),t}getUIDeltaX(){return(this._x-this._prevX)/n.view.getScaleX()}getUIDeltaY(){return(this._y-this._prevY)/n.view.getScaleY()}setButton(t){this._button=t}getButton(){return this._button}getLocationX(){return this._x}getLocationY(){return this._y}getUILocationX(){const t=n.view.getViewportRect();return(this._x-t.x)/n.view.getScaleX()}getUILocationY(){const t=n.view.getViewportRect();return(this._y-t.y)/n.view.getScaleY()}}t("EventMouse",sy),sy.BUTTON_MISSING=-1,sy.BUTTON_LEFT=0,sy.BUTTON_RIGHT=2,sy.BUTTON_MIDDLE=1,sy.BUTTON_4=3,sy.BUTTON_5=4,sy.BUTTON_6=5,sy.BUTTON_7=6,sy.BUTTON_8=7;class ry extends vu{constructor(t,e,i,n){super(vu.TOUCH,e),this.touch=null,this.simulate=!1,this._eventCode=void 0,this._touches=void 0,this._allTouches=void 0,this._eventCode=i||"",this._touches=t||[],this._allTouches=n||[]}getEventCode(){return this._eventCode}getTouches(){return this._touches}getAllTouches(){return this._allTouches}setLocation(t,e){this.touch&&this.touch.setTouchInfo(this.touch.getID(),t,e)}getLocation(t){return this.touch?this.touch.getLocation(t):new Ti}getUILocation(t){return this.touch?this.touch.getUILocation(t):new Ti}getLocationInView(t){return this.touch?this.touch.getLocationInView(t):new Ti}getPreviousLocation(t){return this.touch?this.touch.getPreviousLocation(t):new Ti}getStartLocation(t){return this.touch?this.touch.getStartLocation(t):new Ti}getUIStartLocation(t){return this.touch?this.touch.getUIStartLocation(t):new Ti}getID(){return this.touch?this.touch.getID():null}getDelta(t){return this.touch?this.touch.getDelta(t):new Ti}getUIDelta(t){return this.touch?this.touch.getUIDelta(t):new Ti}getDeltaX(){return this.touch?this.touch.getDelta(ny).x:0}getDeltaY(){return this.touch?this.touch.getDelta(ny).y:0}getLocationX(){return this.touch?this.touch.getLocationX():0}getLocationY(){return this.touch?this.touch.getLocationY():0}}t("EventTouch",ry),ry.MAX_TOUCHES=5;class oy extends vu{constructor(t,e){super(vu.ACCELERATION,e),this.acc=void 0,this.acc=t}}t("EventAcceleration",oy);class ay extends vu{constructor(t,e,i){super(vu.KEYBOARD,i),this.keyCode=void 0,this.rawEvent=void 0,this.isPressed=void 0,"number"==typeof t?this.keyCode=t:(this.keyCode=t.keyCode,this.rawEvent=t),this.isPressed=e}}t("EventKeyboard",ay),vu.EventMouse=sy,vu.EventTouch=ry,vu.EventAcceleration=oy,vu.EventKeyboard=ay;const ly=new Ti;class cy{get lastModified(){return this._lastModified}constructor(t,e,i=0){this._point=new Ti,this._prevPoint=new Ti,this._lastModified=0,this._id=0,this._startPoint=new Ti,this._startPointCaptured=!1,this.setTouchInfo(i,t,e)}getLocation(t){return t||(t=new Ti),t.set(this._point.x,this._point.y),t}getLocationX(){return this._point.x}getLocationY(){return this._point.y}getUILocation(t){return t||(t=new Ti),t.set(this._point.x,this._point.y),n.view._convertPointWithScale(t),t}getUILocationX(){const t=n.view.getViewportRect();return(this._point.x-t.x)/n.view.getScaleX()}getUILocationY(){const t=n.view.getViewportRect();return(this._point.y-t.y)/n.view.getScaleY()}getPreviousLocation(t){return t||(t=new Ti),t.set(this._prevPoint.x,this._prevPoint.y),t}getUIPreviousLocation(t){return t||(t=new Ti),t.set(this._prevPoint.x,this._prevPoint.y),n.view._convertPointWithScale(t),t}getStartLocation(t){return t||(t=new Ti),t.set(this._startPoint.x,this._startPoint.y),t}getUIStartLocation(t){return t||(t=new Ti),t.set(this._startPoint.x,this._startPoint.y),n.view._convertPointWithScale(t),t}getDelta(t){return t||(t=new Ti),t.set(this._point),t.subtract(this._prevPoint),t}getUIDelta(t){return t||(t=new Ti),ly.set(this._point),ly.subtract(this._prevPoint),t.set(n.view.getScaleX(),n.view.getScaleY()),Ti.divide(t,ly,t),t}getLocationInView(t){return t||(t=new Ti),t.set(this._point.x,n.view._designResolutionSize.height-this._point.y),t}getPreviousLocationInView(t){return t||(t=new Ti),t.set(this._prevPoint.x,n.view._designResolutionSize.height-this._prevPoint.y),t}getStartLocationInView(t){return t||(t=new Ti),t.set(this._startPoint.x,n.view._designResolutionSize.height-this._startPoint.y),t}getID(){return this._id}setTouchInfo(t=0,e,i){this._prevPoint=this._point,this._point=new Ti(e||0,i||0),this._id=t,this._startPointCaptured||(this._startPoint=new Ti(this._point),this._startPointCaptured=!0)}setPoint(t,e){"object"==typeof t?(this._point.x=t.x,this._point.y=t.y):(this._point.x=t||0,this._point.y=e||0),this._lastModified=n.director.getCurrentTime()}setPrevPoint(t,e){this._prevPoint="object"==typeof t?new Ti(t.x,t.y):new Ti(t||0,e||0),this._lastModified=n.director.getCurrentTime()}}t("Touch",cy),n.Touch=cy;class hy{constructor(t=0,e=0,i=0,n=0){this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=e,this.z=i,this.timestamp=n}}const _y=qt.TOUCH_TIMEOUT,uy=new Ti,my=new Ti,dy=new class{constructor(){this._isRegisterEvent=!1,this._preTouchPoint=new Ti,this._prevMousePoint=new Ti,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._glView=null}handleTouchesBegin(t){const e=[],i=this._touchesIntegerDict;for(let n=0;n<t.length;++n){const s=t[n],r=s.getID();if(null!==r&&void 0===i[r]){const t=this._getUnUsedIndex();if(-1===t){S(2300,t);continue}s.getLocation(uy);const n=new cy(uy.x,uy.y,r);this._touches[t]=n,s.getPreviousLocation(uy),n.setPrevPoint(uy),i[r]=t,e.push(n)}}if(e.length>0){const t=new ry(e,!1,_p.TOUCH_START,qt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);Sp.dispatchEvent(t)}}handleTouchesMove(t){const e=[],i=this._touches;for(let n=0;n<t.length;++n){const s=t[n],r=s.getID();if(null===r)continue;const o=this._touchesIntegerDict[r];void 0!==o&&i[o]&&(s.getLocation(uy),i[o].setPoint(uy),s.getPreviousLocation(uy),i[o].setPrevPoint(uy),e.push(i[o]))}if(e.length>0){const t=new ry(e,!1,_p.TOUCH_MOVE,qt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);Sp.dispatchEvent(t)}}handleTouchesEnd(t){const e=this.getSetOfTouchesEndOrCancel(t);if(e.length>0){const t=new ry(e,!1,_p.TOUCH_END,qt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);Sp.dispatchEvent(t)}this._preTouchPool.length=0}handleTouchesCancel(t){const e=this.getSetOfTouchesEndOrCancel(t);if(e.length>0){const t=new ry(e,!1,_p.TOUCH_CANCEL,qt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);Sp.dispatchEvent(t)}this._preTouchPool.length=0}getSetOfTouchesEndOrCancel(t){const e=[],i=this._touches,n=this._touchesIntegerDict;for(let s=0;s<t.length;++s){const r=t[s],o=r.getID();if(null===o)continue;const a=n[o];void 0!==a&&i[a]&&(r.getLocation(uy),i[a].setPoint(uy),r.getPreviousLocation(uy),i[a].setPrevPoint(uy),e.push(i[a]),this._removeUsedIndexBit(a),delete n[o])}return e}_getPreTouch(t){let e=null;const i=this._preTouchPool,n=t.getID();for(let t=i.length-1;t>=0;t--)if(i[t].getID()===n){e=i[t];break}return e||(e=t),e}_setPreTouch(t){let e=!1;const i=this._preTouchPool,n=t.getID();for(let s=i.length-1;s>=0;s--)if(i[s].getID()===n){i[s]=t,e=!0;break}e||(i.length<=50?i.push(t):(i[this._preTouchPoolPointer]=t,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}_getViewPixelRatio(){return this._glView?this._glView._devicePixelRatio:1}_getTouch(t){const e=this._preTouchPoint,i=this._getViewPixelRatio(),n=t.x*i,s=t.y*i,r=new cy(n,s,0);return r.setPrevPoint(e.x,e.y),e.x=n,e.y=s,r}_getMouseEvent(t){const e=this._prevMousePoint,i=new sy(t.type,!1,e),s=this._getViewPixelRatio();return e.x=t.x*s,e.y=t.y*s,n.GAME_VIEW&&(e.x/=n.gameView.canvas.width/n.game.canvas.width,e.y/=n.gameView.canvas.height/n.game.canvas.height),i.setLocation(e.x,e.y),i.setButton(t.button),t.movementX&&(i.movementX=t.movementX),t.movementY&&(i.movementY=t.movementY),i}_getTouchList(t){const e=[],i=this._preTouchPoint,n=t.changedTouches.length,s=this._getViewPixelRatio();for(let r=0;r<n;r++){const n=t.changedTouches[r],o=n.x*s,a=n.y*s,l=new cy(o,a,n.identifier);if(this._getPreTouch(l).getLocation(my),l.setPrevPoint(my.x,my.y),this._setPreTouch(l),i.x=o,i.y=a,e.push(l),!qt.ENABLE_MULTI_TOUCH)break}return e}_getUnUsedIndex(){let t=this._indexBitsUsed;const e=n.director.getCurrentTime();for(let i=0;i<this._maxTouches;i++){if(!(1&t))return this._indexBitsUsed|=1<<i,i;{const t=this._touches[i];if(e-t.lastModified>_y){this._removeUsedIndexBit(i);const e=t.getID();return null!==e&&delete this._touchesIntegerDict[e],i}}t>>=1}return-1}_removeUsedIndexBit(t){if(t<0||t>=this._maxTouches)return;let e=1<<t;e=~e,this._indexBitsUsed&=e}_getUsefulTouches(){const t=[],e=this._touchesIntegerDict;for(const i in e){const n=e[parseInt(i)];if(null==n)continue;const s=this._touches[n];t.push(s)}return t}setAccelerometerEnabled(t){t?iy._accelerometer.start():iy._accelerometer.stop()}setAccelerometerInterval(t){iy._accelerometer.setInterval(t)}registerSystemEvent(){this._isRegisterEvent||(this._glView=n.view,iy._mouse.support&&this._registerMouseEvents(),iy._touch.support&&this._registerTouchEvents(),iy._keyboard.support&&this._registerKeyboardEvent(),iy._accelerometer.support&&this._registerAccelerometerEvent(),this._isRegisterEvent=!0)}_registerMouseEvents(){iy._mouse.onDown((t=>{const e=this._getMouseEvent(t),i=this._getTouch(t);this.handleTouchesBegin([i]),Sp.dispatchEvent(e)})),iy._mouse.onMove((t=>{const e=this._getMouseEvent(t),i=this._getTouch(t);this.handleTouchesMove([i]),Sp.dispatchEvent(e)})),iy._mouse.onUp((t=>{const e=this._getMouseEvent(t),i=this._getTouch(t);this.handleTouchesEnd([i]),Sp.dispatchEvent(e)})),iy._mouse.onWheel((t=>{const e=this._getMouseEvent(t);e.setScrollData(t.deltaX,t.deltaY),Sp.dispatchEvent(e)}))}_registerTouchEvents(){iy._touch.onStart((t=>{const e=this._getTouchList(t);this.handleTouchesBegin(e)})),iy._touch.onMove((t=>{const e=this._getTouchList(t);this.handleTouchesMove(e)})),iy._touch.onEnd((t=>{const e=this._getTouchList(t);this.handleTouchesEnd(e)})),iy._touch.onCancel((t=>{const e=this._getTouchList(t);this.handleTouchesCancel(e)}))}_registerKeyboardEvent(){iy._keyboard.onDown((t=>{Sp.dispatchEvent(new ay(t.code,!0))})),iy._keyboard.onUp((t=>{Sp.dispatchEvent(new ay(t.code,!1))}))}_registerAccelerometerEvent(){iy._accelerometer.onChange((t=>{const{x:e,y:i,z:n,timestamp:s}=t;Sp.dispatchEvent(new oy(new hy(e,i,n,s)))}))}};n.internal.inputManager=dy;let py=null,fy=null,gy=null,yy=null;class vy extends Zi{constructor(){super()}setAccelerometerEnabled(t){t&&window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((t=>{S(3520,t),dy.setAccelerometerEnabled("granted"===t)})).catch((t=>{C(3521,t.message),dy.setAccelerometerEnabled(!1)})):dy.setAccelerometerEnabled(t)}setAccelerometerInterval(t){dy.setAccelerometerInterval(t)}on(t,e,i,s){return super.on(t,e,i,s),t!==_p.KEY_DOWN&&t!==_p.KEY_UP||py||(py=up.create({event:up.KEYBOARD,onKeyPressed(t,e){e.type=_p.KEY_DOWN,xy.emit(e.type,e)},onKeyReleased(t,e){e.type=_p.KEY_UP,xy.emit(e.type,e)}}),Sp.addListener(py,256)),t===_p.DEVICEMOTION&&(fy||(fy=up.create({event:up.ACCELERATION,callback(t,e){e.type=_p.DEVICEMOTION,n.systemEvent.emit(e.type,e)}}),Sp.addListener(fy,256))),t!==_p.TOUCH_START&&t!==_p.TOUCH_MOVE&&t!==_p.TOUCH_END&&t!==_p.TOUCH_CANCEL||gy||(gy=up.create({event:up.TOUCH_ONE_BY_ONE,onTouchBegan:(t,e)=>(e.type=_p.TOUCH_START,n.systemEvent.emit(e.type,t,e),!0),onTouchMoved(t,e){e.type=_p.TOUCH_MOVE,n.systemEvent.emit(e.type,t,e)},onTouchEnded(t,e){e.type=_p.TOUCH_END,n.systemEvent.emit(e.type,t,e)},onTouchCancelled(t,e){e.type=_p.TOUCH_CANCEL,n.systemEvent.emit(e.type,t,e)}}),Sp.addListener(gy,256)),t!==_p.MOUSE_DOWN&&t!==_p.MOUSE_MOVE&&t!==_p.MOUSE_UP&&t!==_p.MOUSE_WHEEL||yy||(yy=up.create({event:up.MOUSE,onMouseDown(t){t.type=_p.MOUSE_DOWN,n.systemEvent.emit(t.type,t)},onMouseMove(t){t.type=_p.MOUSE_MOVE,n.systemEvent.emit(t.type,t)},onMouseUp(t){t.type=_p.MOUSE_UP,n.systemEvent.emit(t.type,t)},onMouseScroll(t){t.type=_p.MOUSE_WHEEL,n.systemEvent.emit(t.type,t)}}),Sp.addListener(yy,256)),e}off(t,e,i){if(super.off(t,e,i),py&&(t===_p.KEY_DOWN||t===_p.KEY_UP)){const t=this.hasEventListener(_p.KEY_DOWN),e=this.hasEventListener(_p.KEY_UP);t||e||(Sp.removeListener(py),py=null)}if(fy&&t===_p.DEVICEMOTION&&(Sp.removeListener(fy),fy=null),gy&&(t===_p.TOUCH_START||t===_p.TOUCH_MOVE||t===_p.TOUCH_END||t===_p.TOUCH_CANCEL)){const t=this.hasEventListener(_p.TOUCH_START),e=this.hasEventListener(_p.TOUCH_MOVE),i=this.hasEventListener(_p.TOUCH_END),n=this.hasEventListener(_p.TOUCH_CANCEL);t||e||i||n||(Sp.removeListener(gy),gy=null)}if(yy&&(t===_p.MOUSE_DOWN||t===_p.MOUSE_MOVE||t===_p.MOUSE_UP||t===_p.MOUSE_WHEEL)){const t=this.hasEventListener(_p.MOUSE_DOWN),e=this.hasEventListener(_p.MOUSE_MOVE),i=this.hasEventListener(_p.MOUSE_UP),n=this.hasEventListener(_p.MOUSE_WHEEL);t||e||i||n||(Sp.removeListener(yy),yy=null)}}}t("SystemEvent",vy),vy.EventType=_p,n.SystemEvent=vy;const xy=t("systemEvent",new vy);n.systemEvent=xy;const Sy=hn.getViewSize(),Ay=hn.pixelRatio,Cy=t("sys",{NetworkType:nn,Language:en,OS:sn,Platform:on,BrowserType:Qi,isNative:hn.isNative,isBrowser:hn.isBrowser,isMobile:hn.isMobile,isLittleEndian:hn.isLittleEndian,platform:hn.platform,language:hn.language,languageCode:hn.nativeLanguage,os:hn.os,osVersion:hn.osVersion,osMainVersion:hn.osMainVersion,browserType:hn.browserType,browserVersion:hn.browserVersion,windowPixelResolution:{width:Sy.width*Ay,height:Sy.height*Ay},capabilities:{canvas:hn.supportCapability.canvas,opengl:hn.supportCapability.gl,webp:hn.supportCapability.webp,imageBitmap:hn.supportCapability.imageBitmap,touches:!1,mouse:!1,keyboard:!1,accelerometer:!1},localStorage:null,getNetworkType:()=>hn.networkType,getBatteryLevel:()=>hn.getBatteryLevel(),garbageCollect(){hn.triggerGC()},isObjectValid:t=>null!=t,dump(){let t="";t+=`isMobile : ${this.isMobile}\r\n`,t+=`language : ${this.language}\r\n`,t+=`browserType : ${this.browserType}\r\n`,t+=`browserVersion : ${this.browserVersion}\r\n`,t+=`capabilities : ${JSON.stringify(this.capabilities)}\r\n`,t+=`os : ${this.os}\r\n`,t+=`osVersion : ${this.osVersion}\r\n`,t+=`platform : ${this.platform}\r\n`,t+=`Using ${n.game.renderType===n.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS"} renderer.\r\n`,u(t)},openURL(t){hn.openURL(t)},now:()=>hn.now(),restartVM(){hn.restartJSVM()},getSafeAreaRect(){const t=n.view,e=hn.getSafeAreaEdge(),i=hn.getViewSize(),s=new Ti(e.left,i.height-e.bottom),r=new Ti(i.width-e.right,e.top),o={left:0,top:0,width:i.width,height:i.height};t.convertToLocationInView(s.x,s.y,o,s),t.convertToLocationInView(r.x,r.y,o,r),t._convertPointWithScale(s),t._convertPointWithScale(r);const a=s.x,l=s.y,c=r.x-s.x,h=r.y-s.y;return new Oi(a,l,c,h)},__init(){try{let t=Cy.localStorage=window.localStorage;t.setItem("storage",""),t.removeItem("storage"),t=null}catch(t){const e=function(){C(5200)};Cy.localStorage={getItem:e,setItem:e,removeItem:e,clear:e}}const t=window,e=t.navigator,i=document,n=i.documentElement,s=Cy.capabilities;(void 0!==n.ontouchstart||void 0!==i.ontouchstart||e.msPointerEnabled)&&(s.touches=!0),void 0!==n.onmouseup&&(s.mouse=!0),void 0!==n.onkeyup&&(s.keyboard=!0),(t.DeviceMotionEvent||t.DeviceOrientationEvent)&&(s.accelerometer=!0),Cy.__isWebIOS14OrIPadOS14Env=(Cy.os===sn.IOS||Cy.os===sn.OSX)&&hn.isBrowser&&/(OS 1[4-9])|(Version\/1[4-9])/.test(window.navigator.userAgent),hn.onViewResize((()=>{const t=hn.getViewSize();Cy.windowPixelResolution={width:Math.round(t.width*Ay),height:Math.round(t.height*Ay)}}))}});Cy.__init(),n.sys=Cy;const by=Gt({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),Ty=by.LAYERED+1;class wy{set enabled(t){zs.set(this._handle,Ls.ENABLE,t?1:0),t||zs.set(this._handle,Ls.TYPE,Ty),t?this.activate():this._updatePipeline()}get enabled(){return zs.get(this._handle,Ls.ENABLE)}set fogColor(t){this._fogColor.set(t),si.toArray(this._colorArray,this._fogColor),zs.setVec4(this._handle,Ls.COLOR,this._fogColor)}get fogColor(){return this._fogColor}get type(){return zs.get(this._handle,Ls.TYPE)}set type(t){zs.set(this._handle,Ls.TYPE,this.enabled?t:Ty),this.enabled&&this._updatePipeline()}get fogDensity(){return zs.get(this._handle,Ls.DENSITY)}set fogDensity(t){zs.set(this._handle,Ls.DENSITY,t)}get fogStart(){return zs.get(this._handle,Ls.START)}set fogStart(t){zs.set(this._handle,Ls.START,t)}get fogEnd(){return zs.get(this._handle,Ls.END)}set fogEnd(t){zs.set(this._handle,Ls.END,t)}get fogAtten(){return zs.get(this._handle,Ls.ATTEN)}set fogAtten(t){zs.set(this._handle,Ls.ATTEN,t)}get fogTop(){return zs.get(this._handle,Ls.TOP)}set fogTop(t){zs.set(this._handle,Ls.TOP,t)}get fogRange(){return zs.get(this._handle,Ls.RANGE)}set fogRange(t){zs.set(this._handle,Ls.RANGE,t)}get colorArray(){return this._colorArray}get handle(){return this._handle}constructor(){this._fogColor=new si("#C8C8C8"),this._colorArray=new Float32Array([.2,.2,.2,1]),this._handle=0,this._handle=zs.alloc()}initialize(t){zs.set(this._handle,Ls.ENABLE,t.enabled?1:0),zs.set(this._handle,Ls.TYPE,t.enabled?t.type:Ty),this._fogColor.set(t.fogColor),si.toArray(this._colorArray,this._fogColor),zs.setVec4(this._handle,Ls.COLOR,this._fogColor),zs.set(this._handle,Ls.DENSITY,t.fogDensity),zs.set(this._handle,Ls.START,t.fogStart),zs.set(this._handle,Ls.END,t.fogEnd),zs.set(this._handle,Ls.ATTEN,t.fogAtten),zs.set(this._handle,Ls.TOP,t.fogTop),zs.set(this._handle,Ls.RANGE,t.fogRange)}activate(){this._updatePipeline()}_updatePipeline(){const t=n.director.root,e=this.enabled?this.type:Ty,i=t.pipeline;i.macros.CC_USE_FOG!==e&&(i.macros.CC_USE_FOG=e,t.onGlobalPipelineStateChanged())}destroy(){this._handle&&(zs.free(this._handle),this._handle=0)}}var Ey,Py,Iy,Dy,Ry,My,By,Oy;n.Fog=wy;let Ny=t("EffectAsset",u_("cc.EffectAsset")((Oy=By=class t extends xu{constructor(...t){super(...t),i_(this,"techniques",Iy,this),i_(this,"shaders",Dy,this),i_(this,"combinations",Ry,this),i_(this,"hideInEditor",My,this)}static register(e){t._effects[e.name]=e}static remove(e){if(t._effects[e])delete t._effects[e];else for(const i in t._effects)if(t._effects[i]._uuid===e)return void delete t._effects[i]}static get(e){if(t._effects[e])return t._effects[e];for(const i in t._effects)if(t._effects[i]._uuid===e)return t._effects[i];return null}static getAll(){return t._effects}onLoaded(){Rd.register(this),t.register(this),n.game.once(n.Game.EVENT_ENGINE_INITED,this._precompile,this)}_precompile(){const t=n.director.root;for(let e=0;e<this.shaders.length;e++){const i=this.shaders[e],n=this.combinations[e];n&&Object.keys(n).reduce(((t,e)=>t.reduce(((t,i)=>{const s=n[e];for(let n=0;n<s.length;++n){const r={...i};r[e]=s[n],t.push(r)}return t}),[])),[{}]).forEach((e=>Rd.getGFXShader(t.device,i.name,e,t.pipeline)))}}destroy(){return t.remove(this.name),super.destroy()}initDefault(e){super.initDefault(e);const i=t.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques}validate(){return this.techniques.length>0&&this.shaders.length>0}},By._effects={},Iy=n_((Py=Oy).prototype,"techniques",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Dy=n_(Py.prototype,"shaders",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ry=n_(Py.prototype,"combinations",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),My=n_(Py.prototype,"hideInEditor",[g_,y_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ey=Py))||Ey);var Ly,Fy,zy,Vy,Uy,Gy,Hy,ky,jy;n.EffectAsset=Ny;const Wy=new Q("RenderTex"),qy=new sa;qy.endAccesses=[_o.FRAGMENT_SHADER_READ_TEXTURE];const Xy=new ra,Yy=new aa([qy],Xy),Ky={width:1,height:1,renderPassInfo:Yy};let Jy=t("RenderTexture",(Ly=u_("cc.RenderTexture"),Fy=R_(),zy=M_(),Vy=R_(),Uy=M_(),Ly((ky=n_((Hy=class extends xu{constructor(){super(),i_(this,"_width",ky,this),i_(this,"_height",jy,this),this._textureHash=0,this._id=void 0,this._window=null,this._id=Wy.getNewId(),this._textureHash=qa(this._id,666)}getHash(){return this._textureHash}get width(){return this._width}get height(){return this._height}get window(){return this._window}initialize(t){this._name=t.name||"",this._width=t.width,this._height=t.height,this._initWindow(t)}reset(t){this.initialize(t)}destroy(){return this._window&&(n.director.root.destroyWindow(this._window),this._window=null),super.destroy()}resize(t,e){this._width=t,this._height=e,this._window&&this._window.resize(t,e),this.emit("resize",this._window)}getGFXTexture(){return this._window&&this._window.framebuffer.colorTextures[0]}getGFXSampler(){const t=n.director.root;return Fu.getSampler(t.device,Bu)}getSamplerHash(){return Bu}onLoaded(){this._initWindow(),this.loaded=!0,this.emit("load")}_initWindow(t){const e=n.director.root;Ky.title=this._name,Ky.width=this._width,Ky.height=this._height,Ky.renderPassInfo=t&&t.passInfo?t.passInfo:Yy,this._window?(this._window.destroy(),this._window.initialize(e.device,Ky)):this._window=e.createWindow(Ky)}initDefault(t){super.initDefault(t),this._width=this._height=1,this._initWindow()}validate(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048}}).prototype,"_width",[g_,Fy,zy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),jy=n_(Hy.prototype,"_height",[g_,Vy,Uy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Gy=Hy))||Gy));var $y,Zy,Qy,tv,ev,iv,nv,sv,rv;n.RenderTexture=Jy;let ov=t("Material",($y=u_("cc.Material"),Zy=H_(Ny),$y((ev=n_((tv=class t extends xu{static getHash(t){let e=0;for(const i of t.passes)e^=i.hash;return e}constructor(){super(),i_(this,"_effectAsset",ev,this),i_(this,"_techIdx",iv,this),i_(this,"_defines",nv,this),i_(this,"_states",sv,this),i_(this,"_props",rv,this),this._passes=[],this._hash=0,this.loaded=!1}get effectAsset(){return this._effectAsset}get effectName(){return this._effectAsset?this._effectAsset.name:""}get technique(){return this._techIdx}get passes(){return this._passes}get hash(){return this._hash}get parent(){return null}get owner(){return null}initialize(t){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==t.technique&&(this._techIdx=t.technique),t.effectAsset?this._effectAsset=t.effectAsset:t.effectName&&(this._effectAsset=Ny.get(t.effectName)),t.defines&&this._prepareInfo(t.defines,this._defines),t.states&&this._prepareInfo(t.states,this._states),this._update()}reset(t){this.initialize(t)}destroy(){return this._doDestroy(),super.destroy()}recompileShaders(t,e){console.warn(`Shaders in material asset '${this.name}' cannot be modified at runtime, please instantiate the material first.`)}overridePipelineStates(t,e){console.warn(`Pipeline states in material asset '${this.name}' cannot be modified at runtime, please instantiate the material first.`)}onLoaded(){this._update(),this.loaded=!0,this.emit("load")}resetUniforms(t=!0){this._props.length=this._passes.length;for(let t=0;t<this._props.length;t++)this._props[t]={};if(t)for(const t of this._passes)t.resetUBOs(),t.resetTextures()}setProperty(t,e,i){let n=!1;if(void 0===i){const i=this._passes,s=i.length;for(let r=0;r<s;r++){const s=i[r];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,n=!0)}}else{if(i>=this._passes.length)return void console.warn(`illegal pass index: ${i}.`);const s=this._passes[i];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,n=!0)}n||console.warn(`illegal property name: ${t}.`)}getProperty(t,e){if(void 0===e){const e=this._props,i=e.length;for(let n=0;n<i;n++){const i=e[n];if(t in i)return i[t]}}else{if(e>=this._props.length)return console.warn(`illegal pass index: ${e}.`),null;const i=this._props[this._passes[e].propertyIndex];if(t in i)return i[t]}return null}copy(t){this._techIdx=t._techIdx,this._props.length=t._props.length;for(let e=0;e<t._props.length;e++)this._props[e]={...t._props[e]};this._defines.length=t._defines.length;for(let e=0;e<t._defines.length;e++)this._defines[e]={...t._defines[e]};this._states.length=t._states.length;for(let e=0;e<t._states.length;e++)this._states[e]={...t._states[e]};this._effectAsset=t._effectAsset,this._update()}_prepareInfo(t,e){let i=t;if(!Array.isArray(i)){const t=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;i=Array(t).fill(i)}for(let t=0;t<i.length;++t)Object.assign(e[t]||(e[t]={}),i[t])}_createPasses(){const t=this._effectAsset.techniques[this._techIdx||0];if(!t)return[];const e=t.passes.length,i=[];for(let s=0;s<e;++s){const e=t.passes[s],r=e.passIndex=s,o=e.defines=this._defines[r]||(this._defines[r]={}),a=e.stateOverrides=this._states[r]||(this._states[r]={});if(void 0!==e.propertyIndex&&(Object.assign(o,this._defines[e.propertyIndex]),Object.assign(a,this._states[e.propertyIndex])),void 0!==e.embeddedMacros&&Object.assign(o,e.embeddedMacros),e.switch&&!o[e.switch])continue;const l=new Vd(n.director.root);l.initialize(e),i.push(l)}return i}_update(e=!0){if(this._effectAsset){if(this._passes&&this._passes.length)for(const t of this._passes)t.destroy();this._passes=this._createPasses();const t=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=t,e)this._passes.forEach(((t,e)=>{let i=this._props[e];i||(i=this._props[e]={}),void 0!==t.propertyIndex&&Object.assign(i,this._props[t.propertyIndex]);for(const e in i)this._uploadProperty(t,e,i[e])}));else for(let t=0;t<this._props.length;t++)this._props[t]={}}this._hash=t.getHash(this)}_uploadProperty(t,e,i){const n=t.getHandle(e);if(!n)return!1;const s=Vd.getPropertyTypeFromHandle(n);if(s===ud.BUFFER)Array.isArray(i)?t.setUniformArray(n,i):null!==i?t.setUniform(n,i):t.resetUniform(e);else if(s===ud.TEXTURE)if(Array.isArray(i))for(let e=0;e<i.length;e++)this._bindTexture(t,n,i[e],e);else i?this._bindTexture(t,n,i):t.resetTexture(e);return!0}_bindTexture(t,e,i,n){const s=Vd.getBindingFromHandle(e);if(i instanceof tl)t.bindTexture(s,i,n);else if(i instanceof $u||i instanceof Jy){const e=i.getGFXTexture();if(!e||!e.width||!e.height)return;t.bindTexture(s,e,n),t.bindSampler(s,i.getGFXSampler(),n)}}_doDestroy(){if(this._passes&&this._passes.length)for(const t of this._passes)t.destroy();this._effectAsset=null,this._passes.length=0,this._props.length=0,this._defines.length=0,this._states.length=0}initDefault(t){super.initDefault(t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new si("#ff00ff"))}validate(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0}}).prototype,"_effectAsset",[Zy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iv=n_(tv.prototype,"_techIdx",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nv=n_(tv.prototype,"_defines",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sv=n_(tv.prototype,"_states",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rv=n_(tv.prototype,"_props",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qy=tv))||Qy));n.Material=ov;class av extends Vd{get parent(){return this._parent}constructor(t,e){super(t.root),this._parent=void 0,this._owner=void 0,this._dontNotify=!1,this._parent=t,this._owner=e,this._doInit(this._parent,!0);for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t],i=this._blocks[e.binding],n=this._parent.blocks[e.binding];i.set(n)}this._rootBufferDirty=!0;const i=this._parent;for(let t=0;t<this._shaderInfo.samplerTextures.length;t++){const e=this._shaderInfo.samplerTextures[t];for(let t=0;t<e.count;t++){const n=i._descriptorSet.getSampler(e.binding,t),s=i._descriptorSet.getTexture(e.binding,t);this._descriptorSet.bindSampler(e.binding,n,t),this._descriptorSet.bindTexture(e.binding,s,t)}}super.tryCompile()}overridePipelineStates(t,e){this._bs.reset(),this._rs.reset(),this._dss.reset(),Vd.fillPipelineInfo(this,t),Vd.fillPipelineInfo(this,e),this._onStateChange()}tryCompile(t){if(t&&!Cd(this._defines,t))return!1;const e=super.tryCompile();return this._onStateChange(),e}beginChangeStatesSilently(){this._dontNotify=!0}endChangeStatesSilently(){this._dontNotify=!1}_syncBatchingScheme(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,Qn.set(this._handle,$n.BATCHING_SCHEME,0)}_onStateChange(){Qn.set(this._handle,$n.HASH,Vd.getPassHash(this,this._hShaderDefault)),this._owner.onPassStateChange(this._dontNotify)}}class lv extends ov{get parent(){return this._parent}get owner(){return this._owner}constructor(t){super(),this._passes=[],this._parent=void 0,this._owner=void 0,this._subModelIdx=0,this._parent=t.parent,this._owner=t.owner||null,this._subModelIdx=t.subModelIdx||0,this.copy(this._parent)}recompileShaders(t,e){if(this._passes&&this.effectAsset)if(void 0===e)for(const e of this._passes)e.tryCompile(t);else this._passes[e].tryCompile(t)}overridePipelineStates(t,e){if(!this._passes||!this.effectAsset)return;const i=this.effectAsset.techniques[this.technique].passes;if(void 0===e)for(let e=0;e<this._passes.length;e++){const n=this._passes[e],s=this._states[e]||(this._states[e]={});for(const e in t)s[e]=t[e];n.overridePipelineStates(i[n.passIndex],s)}else{const n=this._states[e]||(this._states[e]={});for(const e in t)n[e]=t[e];this._passes[e].overridePipelineStates(i[e],n)}}destroy(){return this._doDestroy(),!0}onPassStateChange(t){this._hash=ov.getHash(this),!t&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}_createPasses(){const t=[],e=this._parent.passes;if(!e)return t;for(let i=0;i<e.length;++i)t.push(new av(e[i],this));return t}}let cv=null,hv=null;class _v{get model(){return this._model}get enabled(){return Ns.get(this._handle,Bs.ENABLE)}set enabled(t){t?this.activate():this._updatePipeline(),Ns.set(this._handle,Bs.ENABLE,t?1:0)}get useIBL(){return Ns.get(this._handle,Bs.USE_IBL)}set useIBL(t){Ns.set(this._handle,Bs.USE_IBL,t?1:0),this._updatePipeline()}get isRGBE(){return Ns.get(this._handle,Bs.IS_RGBE)}set isRGBE(t){t&&(hv&&hv.recompileShaders({USE_RGBE_CUBEMAP:t}),this._model&&this._model.setSubModelMaterial(0,hv)),Ns.set(this._handle,Bs.IS_RGBE,t?1:0),this._updatePipeline()}get envmap(){return this._envmap}set envmap(t){this._envmap=t||this._default,this._envmap&&(n.director.root.pipeline.pipelineSceneData.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}get handle(){return this._handle}constructor(){this._envmap=null,this._globalDescriptorSet=null,this._model=null,this._default=null,this._handle=0,this._handle=Ns.alloc()}initialize(t){Ns.set(this._handle,Bs.ENABLE,t.enabled?1:0),Ns.set(this._handle,Bs.USE_IBL,t.useIBL?1:0),Ns.set(this._handle,Bs.IS_RGBE,t.isRGBE?1:0),this._envmap=t.envmap}activate(){const t=n.director.root.pipeline,e=t.pipelineSceneData.ambient;if(this._globalDescriptorSet=t.descriptorSet,this._default=Bd.get("default-cube-texture"),this._model||(this._model=n.director.root.createModel(n.renderer.scene.Model),this._model._initLocalDescriptors=()=>{}),Ns.set(this._handle,Bs.MODEL,this._model.handle),this._envmap||(this._envmap=this._default),e.albedoArray[3]=this._envmap.mipmapLevel,hv)hv.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE});else{const t=new ov;t.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:this.isRGBE}}),hv=new lv({parent:t})}this.enabled&&(cv||(cv=n.utils.createMesh(n.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,cv.renderingSubMeshes[0],hv)),this._updateGlobalBinding(),this._updatePipeline()}_updatePipeline(){const t=this.useIBL?this.isRGBE?2:1:0,e=n.director.root,i=e.pipeline;i.macros.CC_USE_IBL!==t&&(i.macros.CC_USE_IBL=t,e.onGlobalPipelineStateChanged())}_updateGlobalBinding(){const t=this.envmap.getGFXTexture(),e=Fu.getSampler(n.director._device,this.envmap.getSamplerHash());this._globalDescriptorSet.bindSampler(ah,e),this._globalDescriptorSet.bindTexture(ah,t)}destroy(){this._handle&&(Ns.free(this._handle),this._handle=0)}}n.Skybox=_v;const uv=Gt({Planar:0,ShadowMap:1}),mv=Gt({HARD:0,FILTER_X5:1,FILTER_X9:2,FILTER_X25:3}),dv=uv.ShadowMap+1;class pv{get enabled(){return!!Gs.get(this._handle,Vs.ENABLE)}set enabled(t){Gs.set(this._handle,Vs.ENABLE,t?1:0),t||Gs.set(this._handle,Vs.TYPE,dv),this.activate()}get normal(){return this._normal}set normal(t){oi.copy(this._normal,t),Gs.setVec3(this._handle,Vs.NORMAL,this._normal)}get distance(){return Gs.get(this._handle,Vs.DISTANCE)}set distance(t){Gs.set(this._handle,Vs.DISTANCE,t)}get shadowColor(){return this._shadowColor}set shadowColor(t){this._shadowColor=t,Gs.setVec4(this._handle,Vs.COLOR,t)}get type(){return Gs.get(this._handle,Vs.TYPE)}set type(t){Gs.set(this._handle,Vs.TYPE,this.enabled?t:dv),this.activate()}get near(){return Gs.get(this._handle,Vs.NEAR)}set near(t){Gs.set(this._handle,Vs.NEAR,t)}get far(){return Gs.get(this._handle,Vs.FAR)}set far(t){Gs.set(this._handle,Vs.FAR,t)}get aspect(){return Gs.get(this._handle,Vs.ASPECT)}set aspect(t){Gs.set(this._handle,Vs.ASPECT,t)}get orthoSize(){return Gs.get(this._handle,Vs.ORTHO_SIZE)}set orthoSize(t){Gs.set(this._handle,Vs.ORTHO_SIZE,t)}get size(){return this._size}set size(t){this._size=t,Gs.setVec2(this._handle,Vs.SIZE,this._size)}get pcf(){return Gs.get(this._handle,Vs.PCF_TYPE)}set pcf(t){Gs.set(this._handle,Vs.PCF_TYPE,t)}get shadowMapDirty(){return!!Gs.get(this._handle,Vs.SHADOW_MAP_DIRTY)}set shadowMapDirty(t){Gs.set(this._handle,Vs.SHADOW_MAP_DIRTY,t?1:0)}get bias(){return Gs.get(this._handle,Vs.BIAS)}set bias(t){Gs.set(this._handle,Vs.BIAS,t)}get packing(){return!!Gs.get(this._handle,Vs.PACKING)}set packing(t){Gs.set(this._handle,Vs.PACKING,t?1:0)}get linear(){return!!Gs.get(this._handle,Vs.LINEAR)}set linear(t){Gs.set(this._handle,Vs.LINEAR,t?1:0)}get selfShadow(){return!!Gs.get(this._handle,Vs.SELF_SHADOW)}set selfShadow(t){Gs.set(this._handle,Vs.SELF_SHADOW,t?1:0)}get normalBias(){return Gs.get(this._handle,Vs.NORMAL_BIAS)}set normalBias(t){Gs.set(this._handle,Vs.NORMAL_BIAS,t)}get autoAdapt(){return!!Gs.get(this._handle,Vs.AUTO_ADAPT)}set autoAdapt(t){Gs.set(this._handle,Vs.AUTO_ADAPT,t?1:0)}get matLight(){return this._matLight}get material(){return this._material}get instancingMaterial(){return this._instancingMaterial}get handle(){return this._handle}constructor(){this.sphere=new Lr(0,0,0,.01),this.maxReceived=4,this._normal=new oi(0,1,0),this._shadowColor=new si(0,0,0,76),this._matLight=new Si,this._material=null,this._instancingMaterial=null,this._size=new Ti(512,512),this._handle=0,this._handle=Gs.alloc()}getPlanarShader(t){return this._material||(this._material=new ov,this._material.initialize({effectName:"planar-shadow"}),Gs.set(this._handle,Vs.PLANAR_PASS,this._material.passes[0].handle)),this._material.passes[0].getShaderVariant(t)}getPlanarInstanceShader(t){return this._instancingMaterial||(this._instancingMaterial=new ov,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),Gs.set(this._handle,Vs.INSTANCE_PASS,this._instancingMaterial.passes[0].handle)),this._instancingMaterial.passes[0].getShaderVariant(t)}initialize(t){Gs.set(this._handle,Vs.TYPE,t.enabled?t.type:dv),Gs.set(this._handle,Vs.NEAR,t.near),Gs.set(this._handle,Vs.FAR,t.far),Gs.set(this._handle,Vs.ASPECT,t.aspect),Gs.set(this._handle,Vs.ORTHO_SIZE,t.orthoSize),this._size=t.shadowMapSize,Gs.setVec2(this._handle,Vs.SIZE,this._size),Gs.set(this._handle,Vs.PCF_TYPE,t.pcf),oi.copy(this._normal,t.normal),Gs.setVec3(this._handle,Vs.NORMAL,this._normal),Gs.set(this._handle,Vs.DISTANCE,t.distance),this._shadowColor.set(t.shadowColor),Gs.setVec4(this._handle,Vs.COLOR,this._shadowColor),Gs.set(this._handle,Vs.BIAS,t.bias),Gs.set(this._handle,Vs.PACKING,t.packing?1:0),Gs.set(this._handle,Vs.LINEAR,t.linear?1:0),Gs.set(this._handle,Vs.SELF_SHADOW,t.selfShadow?1:0),Gs.set(this._handle,Vs.NORMAL_BIAS,t.normalBias),Gs.set(this._handle,Vs.ENABLE,t.enabled?1:0),this.maxReceived=t.maxReceived,Gs.set(this._handle,Vs.AUTO_ADAPT,t.autoAdapt?1:0)}activate(){if(this.enabled)this.type===uv.ShadowMap?this._updatePipeline():this._updatePlanarInfo();else{const t=n.director.root;t.pipeline.macros.CC_RECEIVE_SHADOW=0,t.onGlobalPipelineStateChanged()}}_updatePlanarInfo(){this._material||(this._material=new ov,this._material.initialize({effectName:"planar-shadow"}),Gs.set(this._handle,Vs.PLANAR_PASS,this._material.passes[0].handle)),this._instancingMaterial||(this._instancingMaterial=new ov,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),Gs.set(this._handle,Vs.INSTANCE_PASS,this._instancingMaterial.passes[0].handle));const t=n.director.root;t.pipeline.macros.CC_RECEIVE_SHADOW=0,t.onGlobalPipelineStateChanged()}_updatePipeline(){const t=n.director.root;t.pipeline.macros.CC_RECEIVE_SHADOW=1,t.onGlobalPipelineStateChanged()}destroy(){this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this._handle&&(Gs.free(this._handle),this._handle=0),this.sphere.destroy()}}pv.MAX_FAR=2e3,pv.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),n.Shadows=pv;class fv{get handle(){return this._handle}get isHDR(){return js.get(this._handle,Hs.IS_HDR)}set isHDR(t){js.set(this._handle,Hs.IS_HDR,t?1:0)}get shadingScale(){return js.get(this._handle,Hs.SHADING_SCALE)}set shadingScale(t){js.set(this._handle,Hs.SHADING_SCALE,t)}get fpScale(){return js.get(this._handle,Hs.FP_SCALE)}set fpScale(t){js.set(this._handle,Hs.FP_SCALE,t)}constructor(){this.fog=new wy,this.ambient=new pr,this.skybox=new _v,this.shadows=new pv,this.renderObjects=[],this.shadowObjects=[],this.shadowFrameBufferMap=new Map,this._handle=js.alloc(),js.set(this._handle,Hs.AMBIENT,this.ambient.handle),js.set(this._handle,Hs.SKYBOX,this.skybox.handle),js.set(this._handle,Hs.FOG,this.fog.handle),js.set(this._handle,Hs.SHADOW,this.shadows.handle),js.set(this._handle,Hs.IS_HDR,0),js.set(this._handle,Hs.SHADING_SCALE,1),js.set(this._handle,Hs.FP_SCALE,1/1024)}get deferredLightPassHandle(){return js.get(this._handle,Hs.DEFERRED_LIGHT_PASS)}get deferredLightPassShaderHandle(){return js.get(this._handle,Hs.DEFERRED_LIGHT_PASS_SHADER)}get deferredPostPassHandle(){return js.get(this._handle,Hs.DEFERRED_POST_PASS)}get deferredPostPassShaderHandle(){return js.get(this._handle,Hs.DEFERRED_POST_PASS_SHADER)}initDeferredPassInfo(){const t=Bd.get("builtin-deferred-material");if(t){const e=t.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}const e=Bd.get("builtin-post-process-material");if(e){const t=e.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}if(t){const e=t.passes[0];js.set(this._handle,Hs.DEFERRED_LIGHT_PASS,e.handle),js.set(this._handle,Hs.DEFERRED_LIGHT_PASS_SHADER,e.getShaderVariant())}if(e){const t=e.passes[0];js.set(this._handle,Hs.DEFERRED_POST_PASS,t.handle),js.set(this._handle,Hs.DEFERRED_POST_PASS_SHADER,t.getShaderVariant())}}activate(t,e){return this._device=t,this._pipeline=e,this.initDeferredPassInfo(),!0}destroy(){this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this._handle&&js.free(this._handle)}}nr.getPhaseID=Od;const gv=t("RenderPipeline",nr.RenderPipeline),yv=(t("RenderFlow",nr.RenderFlow),t("RenderStage",nr.RenderStage),t("InstancedBuffer",nr.InstancedBuffer),t("PipelineStateManager",nr.PipelineStateManager));let vv=nr.InstancedBuffer,xv=vv.get;vv.get=function(t){return xv.call(this,t.handle)};let Sv=nr.PipelineStateManager.getOrCreatePipelineState;function Av(){const t=new Cv;return t.init(),t}nr.PipelineStateManager.getOrCreatePipelineState=function(t,e,i,n,s){return Sv.call(this,e.handle,i,n,s)};class Cv extends nr.ForwardPipeline{constructor(){super(),this.pipelineSceneData=new fv,this._tag=0,this._flows=[],this.renderTextures=[],this.materials=[]}init(){this.setPipelineSharedSceneData(this.pipelineSceneData.handle);for(let t=0;t<this._flows.length;t++)this._flows[t].init();const t=new nr.RenderPipelineInfo(this._tag,this._flows);this.initialize(t)}activate(){return super.activate()&&this.pipelineSceneData.activate(n.director.root.device,this)}render(t){let e=[];for(let i=0,n=t.length;i<n;++i)e.push(t[i].handle);super.render(e)}destroy(){this.pipelineSceneData.destroy(),super.destroy()}}t("ForwardPipeline",Cv),Cv.prototype.onAfterDeserialize_JSB=Cv.prototype.init;class bv extends nr.ForwardFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(){for(let t=0;t<this._stages.length;t++)this._stages[t].init();const t=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(t)}}t("ForwardFlow",bv);class Tv extends nr.ShadowFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(){for(let t=0;t<this._stages.length;t++)this._stages[t].init();const t=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(t)}}t("ShadowFlow",Tv);class wv extends nr.ForwardStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[]}init(){const t=[];for(let e=0;e<this.renderQueues.length;e++)t.push(this.renderQueues[e].init());const e=new nr.RenderStageInfo(this._name,this._priority,this._tag,t);this.initialize(e)}}t("ForwardStage",wv);class Ev extends nr.ShadowStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0}init(){const t=new nr.RenderStageInfo(this._name,this._priority,this._tag,[]);this.initialize(t)}}t("ShadowStage",Ev);class Pv{constructor(){this.isTransparent=!1,this.sortMode=0,this.stages=[],this.isTransparent=!1,this.sortMode=0,this.stages=[]}init(){return new nr.RenderQueueDesc(this.isTransparent,this.sortMode,this.stages)}}t("RenderQueueDesc",Pv);class Iv extends nr.DeferredPipeline{constructor(){super(),this.pipelineSceneData=new fv,this._tag=0,this._flows=[],this.renderTextures=[],this.materials=[]}init(){this.setPipelineSharedSceneData(this.pipelineSceneData.handle);for(let t=0;t<this._flows.length;t++)this._flows[t].init();let t=new nr.RenderPipelineInfo(this._tag,this._flows);this.initialize(t)}activate(){return super.activate()&&this.pipelineSceneData.activate(n.director.root.device,this)}render(t){let e=[];for(let i=0,n=t.length;i<n;++i)e.push(t[i].handle);super.render(e)}destroy(){this.fog.destroy(),this.ambient.destroy(),this.skybox.destroy(),this.shadows.destroy(),this.pipelineSceneData.destroy(),super.destroy()}}t("DeferredPipeline",Iv),Iv.prototype.onAfterDeserialize_JSB=Iv.prototype.init;class Dv extends nr.GbufferFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(){for(let t=0;t<this._stages.length;t++)this._stages[t].init();let t=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(t)}}t("GbufferFlow",Dv);class Rv extends nr.GbufferStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[]}init(){const t=[];for(let e=0;e<this.renderQueues.length;e++)t.push(this.renderQueues[e].init());let e=new nr.RenderStageInfo(this._name,this._priority,this._tag,t);this.initialize(e)}}t("GbufferStage",Rv);class Mv extends nr.LightingFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(){for(let t=0;t<this._stages.length;t++)this._stages[t].init();let t=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(t)}}class Bv extends nr.LightingStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[]}init(){const t=[];for(let e=0;e<this.renderQueues.length;e++)t.push(this.renderQueues[e].init());let e=new nr.RenderStageInfo(this._name,this._priority,this._tag,t);this.initialize(e)}}t("LightingStage",Bv);class Ov extends nr.PostprocessStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[]}init(){const t=[];for(let e=0;e<this.renderQueues.length;e++)t.push(this.renderQueues[e].init());let e=new nr.RenderStageInfo(this._name,this._priority,this._tag,t);this.initialize(e)}}t("PostprocessStage",Ov),Rt("DeferredPipeline",Iv),Rt("GbufferFlow",Dv),Rt("GbufferStage",Rv),Rt("LightingFlow",Mv),Rt("LightingStage",Bv),Rt("PostprocessStage",Ov),Rt("ForwardPipeline",Cv),Rt("ForwardFlow",bv),Rt("ShadowFlow",Tv),Rt("ForwardStage",wv),Rt("ShadowStage",Ev),Rt("RenderQueueDesc",Pv);class Nv extends Zi{constructor(...t){super(...t),this.frame=null,this.container=null,this.canvas=null,this.renderType=-1,this.eventTargetOn=super.on,this.eventTargetOnce=super.once,this.config={},this.onStart=null,this.collisionMatrix=[],this.groupList=[],this._persistRootNodes={},this._paused=!0,this._configLoaded=!1,this._isCloning=!1,this._inited=!1,this._engineInited=!1,this._rendererInitialized=!1,this._gfxDevice=null,this._intervalId=null}get inited(){return this._inited}get frameTime(){return this._frameTime}setFrameRate(t){const e=this.config;"number"!=typeof t&&(t=parseInt(t,10),Number.isNaN(t)&&(t=60)),e.frameRate=t,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}getFrameRate(){return this.config.frameRate||0}step(){n.director.mainLoop()}pause(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))}resume(){this._paused&&this._runMainLoop()}isPaused(){return this._paused}restart(){return new Promise((t=>n.director.once(n.Director.EVENT_AFTER_DRAW,(()=>t())))).then((()=>{for(const t in this._persistRootNodes)this.removePersistRootNode(this._persistRootNodes[t]);return n.director.getScene().destroy(),n.Object._deferredDestroy(),n.director.reset(),this.pause(),this._setRenderPipelineNShowSplash().then((()=>{this.resume(),this._safeEmit(Nv.EVENT_RESTART)}))}))}end(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),window.close()}on(t,e,i,n){return this._engineInited&&t===Nv.EVENT_ENGINE_INITED?e.call(i):this.eventTargetOn(t,e,i,n)}once(t,e,i){return this._engineInited&&t===Nv.EVENT_ENGINE_INITED?e.call(i):this.eventTargetOnce(t,e,i)}init(t){return this._initConfig(t),this.config.assetOptions&&n.assetManager.init(this.config.assetOptions),this._initEngine().then((()=>(this._initEvents(),n.director.root.dataPoolManager&&n.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(t.customJointTextureLayouts),this._engineInited)))}run(t,e){let i;return"function"!=typeof t&&t?(i=this.init(t),this.onStart=null!=e?e:null):this.onStart=null!=t?t:null,Promise.resolve(i).then((()=>(Lv.config.registerSystemEvent&&dy.registerSystemEvent(),this._setRenderPipelineNShowSplash())))}addPersistRootNode(t){if(!n.Node.isNode(t)||!t.uuid)return void C(3800);const e=t.uuid;if(!this._persistRootNodes[e]){const i=n.director._scene;if(n.isValid(i))if(t.parent){if(!(t.parent instanceof n.Scene))return void C(3801);if(t.parent!==i)return void C(3802);t._originalSceneId=i.uuid}else t.parent=i;this._persistRootNodes[e]=t,t._persistNode=!0,n.assetManager._releaseManager._addPersistNodeRef(t)}}removePersistRootNode(t){const e=t.uuid||"";t===this._persistRootNodes[e]&&(delete this._persistRootNodes[e],t._persistNode=!1,t._originalSceneId="",n.assetManager._releaseManager._removePersistNodeRef(t))}isPersistRootNode(t){return!!t._persistNode}_initEngine(){return this._initDevice(),Promise.resolve(n.director._init()).then((()=>{u(`Cocos Creator v${s}`),this.emit(Nv.EVENT_ENGINE_INITED),this._engineInited=!0,n.internal.dynamicAtlasManager.enabled=!qt.CLEANUP_IMAGE_CACHE}))}_setAnimFrame(){this._lastTime=performance.now();const t=this.config.frameRate;this._frameTime=1e3/t,jsb.setPreferredFramesPerSecond(t),window.rAF=window.requestAnimationFrame,window.cAF=window.cancelAnimationFrame}_stTimeWithRAF(t){const e=performance.now(),i=Math.max(0,e-Lv._lastTime),n=Math.max(0,Lv._frameTime-i),s=window.setTimeout((()=>{window.requestAnimationFrame(t)}),n);return Lv._lastTime=e+n,s}_stTime(t){const e=performance.now(),i=Math.max(0,e-Lv._lastTime),n=Math.max(0,Lv._frameTime-i),s=window.setTimeout(t,n);return Lv._lastTime=e+n,s}_ctTime(t){window.clearTimeout(t)}_runMainLoop(){if(!this._inited)return;const t=this.config,e=n.director;let i;t.frameRate,R(!!t.showFPS),e.startAnimation(),i=t=>{this._intervalId=window.rAF(i),e.mainLoop(t)},this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._intervalId=window.rAF(i),this._paused=!1}_initConfig(t){"number"!=typeof t.debugMode&&(t.debugMode=P.NONE),t.exposeClassName=!!t.exposeClassName,"number"!=typeof t.frameRate&&(t.frameRate=60);const e=t.renderMode;("number"!=typeof e||e>2||e<0)&&(t.renderMode=0),"boolean"!=typeof t.registerSystemEvent&&(t.registerSystemEvent=!0),t.showFPS=!!t.showFPS,this.collisionMatrix=t.collisionMatrix||[],this.groupList=t.groupList||[],g(t.debugMode),this.config=t,this._configLoaded=!0,this._setAnimFrame()}_determineRenderType(){const t=this.config,e=parseInt(t.renderMode,10);this.renderType=Nv.RENDER_TYPE_CANVAS;let i=!1;if(0===e?n.sys.capabilities.opengl?(this.renderType=Nv.RENDER_TYPE_WEBGL,i=!0):n.sys.capabilities.canvas&&(this.renderType=Nv.RENDER_TYPE_CANVAS,i=!0):1===e&&n.sys.capabilities.canvas?(this.renderType=Nv.RENDER_TYPE_CANVAS,i=!0):2===e&&n.sys.capabilities.opengl&&(this.renderType=Nv.RENDER_TYPE_WEBGL,i=!0),!i)throw new Error(I(3820,e))}_initDevice(){if(!this._rendererInitialized){if(this.canvas=this.config.adapter.canvas,this.frame=this.config.adapter.frame,this.container=this.config.adapter.container,this._determineRenderType(),this.renderType===Nv.RENDER_TYPE_WEBGL){const t=[];if(window.gfx)this._gfxDevice=gfx.deviceInstance;else{let e=!!window.WebGL2RenderingContext;const i=window.navigator.userAgent.toLowerCase();(-1!==i.indexOf("safari")&&-1===i.indexOf("chrome")||hn.browserType===Qi.UC)&&(e=!1),e&&n.WebGL2Device&&t.push(n.WebGL2Device),n.WebGLDevice&&t.push(n.WebGLDevice);const s=new Sa(this.canvas,qt.ENABLE_WEBGL_ANTIALIAS,!1,window.devicePixelRatio,Cy.windowPixelResolution.width,Cy.windowPixelResolution.height,Vc);for(let e=0;e<t.length&&(this._gfxDevice=new t[e],!this._gfxDevice.initialize(s));e++);}}if(!this._gfxDevice)return d("can not support canvas rendering in 3D"),void(this.renderType=Nv.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=()=>!1}}_initEvents(){hn.onShow(this._onShow.bind(this)),hn.onHide(this._onHide.bind(this))}_onHide(){this.emit(Nv.EVENT_HIDE),this.pause()}_onShow(){this.emit(Nv.EVENT_SHOW),this.resume()}_setRenderPipelineNShowSplash(){return Promise.resolve(this._setupRenderPipeline()).then((()=>Promise.resolve(this._showSplashScreen()).then((()=>{this._inited=!0,this._setAnimFrame(),this._runMainLoop(),this._safeEmit(Nv.EVENT_GAME_INITED),this.onStart&&this.onStart()}))))}_setupRenderPipeline(){const{renderPipeline:t}=this.config;return t?new Promise(((e,i)=>{n.assetManager.loadAny(t,((t,n)=>!t&&n instanceof gv?e(n):i(t)))})).then((t=>{this._setRenderPipeline(t)})).catch((e=>{m(e),m(`Failed load render pipeline: ${t}, engine failed to initialize, will fallback to default pipeline`),this._setRenderPipeline()})):this._setRenderPipeline()}_showSplashScreen(){if(n.internal.SplashScreen){const t=n.internal.SplashScreen.instance;return t.main(n.director.root),new Promise((e=>{t.setOnFinish((()=>e())),t.loadFinish=!0}))}return null}_setRenderPipeline(t){n.director.root.setRenderPipeline(t)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(Nv.EVENT_RENDERER_INITED)}_safeEmit(t){this.emit(t)}}t("Game",Nv),Nv.EVENT_HIDE="game_on_hide",Nv.EVENT_SHOW="game_on_show",Nv.EVENT_LOW_MEMORY="game_on_low_memory",Nv.EVENT_GAME_INITED="game_inited",Nv.EVENT_ENGINE_INITED="engine_inited",Nv.EVENT_RENDERER_INITED="renderer_inited",Nv.EVENT_RESTART="game_on_restart",Nv.RENDER_TYPE_CANVAS=0,Nv.RENDER_TYPE_WEBGL=1,Nv.RENDER_TYPE_OPENGL=2,n.Game=Nv;const Lv=t("game",n.game=new Nv),Fv={topLeft:n.v2(0,0),topRight:n.v2(0,0),top:n.v2(0,0),bottomLeft:n.v2(0,0),bottomRight:n.v2(0,0),bottom:n.v2(0,0),center:n.v2(0,0),left:n.v2(0,0),right:n.v2(0,0),width:0,height:0,init(t){const e=this.width=t.width,i=this.height=t.height,n=t.x,s=t.y,r=s+i,o=n+e;this.topLeft.x=n,this.topLeft.y=r,this.topRight.x=o,this.topRight.y=r,this.top.x=n+e/2,this.top.y=r,this.bottomLeft.x=n,this.bottomLeft.y=s,this.bottomRight.x=o,this.bottomRight.y=s,this.bottom.x=n+e/2,this.bottom.y=s,this.center.x=n+e/2,this.center.y=s+i/2,this.left.x=n,this.left.y=s+i/2,this.right.x=o,this.right.y=s+i/2}};n.visibleRect=Fv;const zv=new class{constructor(){this.html=void 0,this.meta={width:"device-width"},this.adaptationType=n.sys.browserType}init(){this.html=document.getElementsByTagName("html")[0]}availWidth(t){return n.sys.isMobile||!t||t===this.html?window.innerWidth:t.clientWidth}availHeight(t){return n.sys.isMobile||!t||t===this.html?window.innerHeight:t.clientHeight}};switch(hn.os===sn.IOS&&(zv.adaptationType=Qi.SAFARI),zv.adaptationType){case Qi.SAFARI:zv.meta["minimal-ui"]="true",zv.availWidth=t=>t.clientWidth,zv.availHeight=t=>t.clientHeight;break;case Qi.SOUGOU:case Qi.UC:zv.availWidth=t=>t.clientWidth,zv.availHeight=t=>t.clientHeight}class Vv extends Zi{constructor(){super(),this._resizeWithBrowserSize=void 0,this._designResolutionSize=void 0,this._originalDesignResolutionSize=void 0,this._frameSize=void 0,this._scaleX=void 0,this._scaleY=void 0,this._viewportRect=void 0,this._visibleRect=void 0,this._autoFullScreen=void 0,this._devicePixelRatio=void 0,this._maxPixelRatio=void 0,this._retinaEnabled=void 0,this._resizeCallback=void 0,this._resizing=void 0,this._orientationChanging=void 0,this._isRotated=void 0,this._orientation=void 0,this._isAdjustViewport=void 0,this._resolutionPolicy=void 0,this._rpExactFit=void 0,this._rpShowAll=void 0,this._rpNoBorder=void 0,this._rpFixedHeight=void 0,this._rpFixedWidth=void 0;const t=Uv,e=Gv;this._frameSize=new Mi(0,0),this._designResolutionSize=new Mi(0,0),this._originalDesignResolutionSize=new Mi(0,0),this._scaleX=1,this._scaleY=1,this._viewportRect=new Oi(0,0,0,0),this._visibleRect=new Oi(0,0,0,0),this._autoFullScreen=!1,this._devicePixelRatio=1,this._maxPixelRatio=4,this._retinaEnabled=!1,this._resizeCallback=null,this._resizing=!1,this._resizeWithBrowserSize=!1,this._orientationChanging=!0,this._isRotated=!1,this._orientation=n.macro.ORIENTATION_AUTO,this._isAdjustViewport=!0,this._rpExactFit=new Hv(t.EQUAL_TO_FRAME,e.EXACT_FIT),this._rpShowAll=new Hv(t.EQUAL_TO_FRAME,e.SHOW_ALL),this._rpNoBorder=new Hv(t.EQUAL_TO_FRAME,e.NO_BORDER),this._rpFixedHeight=new Hv(t.EQUAL_TO_FRAME,e.FIXED_HEIGHT),this._rpFixedWidth=new Hv(t.EQUAL_TO_FRAME,e.FIXED_WIDTH),this._resolutionPolicy=this._rpShowAll,n.game.once(n.Game.EVENT_ENGINE_INITED,this.init,this)}init(){zv.init(),this._initFrameSize();const t=n.game.canvas.width,e=n.game.canvas.height;this._designResolutionSize.width=t,this._designResolutionSize.height=e,this._originalDesignResolutionSize.width=t,this._originalDesignResolutionSize.height=e,this._viewportRect.width=t,this._viewportRect.height=e,this._visibleRect.width=t,this._visibleRect.height=e,n.winSize.width=this._visibleRect.width,n.winSize.height=this._visibleRect.height,n.visibleRect&&n.visibleRect.init(this._visibleRect)}resizeWithBrowserSize(t){t?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,hn.onViewResize(this._resizeEvent),hn.onOrientationChange(this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,hn.offViewResize(this._resizeEvent),hn.offOrientationChange(this._orientationChange))}setResizeCallback(t){"function"!=typeof t&&null!=t||(this._resizeCallback=t)}setOrientation(t){(t&=n.macro.ORIENTATION_AUTO)&&this._orientation!==t&&(this._orientation=t)}adjustViewportMeta(t){this._isAdjustViewport=t}enableRetina(t){this._retinaEnabled=!!t}isRetinaEnabled(){return this._retinaEnabled}enableAutoFullScreen(t){t&&t!==this._autoFullScreen&&n.sys.isMobile&&hn.browserType!==Qi.WECHAT?(this._autoFullScreen=!0,n.screen.autoFullScreen(n.game.frame)):this._autoFullScreen=!1}isAutoFullScreenEnabled(){return this._autoFullScreen}setCanvasSize(t,e){const i=n.game.canvas,s=n.game.container;this._devicePixelRatio=window.devicePixelRatio,i.width=Cy.windowPixelResolution.width,i.height=Cy.windowPixelResolution.height,i.style.width=`${t}px`,i.style.height=`${e}px`,s.style.width=`${t}px`,s.style.height=`${e}px`,this._resizeEvent()}getCanvasSize(){return new Mi(n.game.canvas.width,n.game.canvas.height)}getFrameSize(){return new Mi(this._frameSize.width,this._frameSize.height)}setFrameSize(t,e){this._frameSize.width=t,this._frameSize.height=e,n.game.frame.style.width=`${t}px`,n.game.frame.style.height=`${e}px`,this._resizeEvent()}getVisibleSize(){return new Mi(this._visibleRect.width,this._visibleRect.height)}getVisibleSizeInPixel(){return new Mi(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}getVisibleOrigin(){return new Ti(this._visibleRect.x,this._visibleRect.y)}getVisibleOriginInPixel(){return new Ti(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}getResolutionPolicy(){return this._resolutionPolicy}setResolutionPolicy(t){if(t instanceof Hv)this._resolutionPolicy=t;else{const e=Hv;t===e.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),t===e.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),t===e.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),t===e.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),t===e.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}}setDesignResolutionSize(t,e,i){if(!(t>0&&e>0))return void T(2200);this.setResolutionPolicy(i);const s=this._resolutionPolicy;if(s&&s.preApply(this),n.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),!s)return void S(2201);this._originalDesignResolutionSize.width=this._designResolutionSize.width=t,this._originalDesignResolutionSize.height=this._designResolutionSize.height=e;const r=s.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){const t=this._viewportRect,e=this._visibleRect,i=r.viewport;t.x=i.x,t.y=i.y,t.width=i.width,t.height=i.height,e.x=0,e.y=0,e.width=i.width/this._scaleX,e.height=i.height/this._scaleY}s.postApply(this),n.winSize.width=this._visibleRect.width,n.winSize.height=this._visibleRect.height,Fv&&Fv.init(this._visibleRect),this.emit("design-resolution-changed")}getDesignResolutionSize(){return new Mi(this._designResolutionSize.width,this._designResolutionSize.height)}setRealPixelResolution(t,e,i){this.setDesignResolutionSize(t,e,i)}getViewportRect(){return this._viewportRect}getScaleX(){return this._scaleX}getScaleY(){return this._scaleY}getDevicePixelRatio(){return this._devicePixelRatio}convertToLocationInView(t,e,i,s){const r=s||new Ti,o=this._devicePixelRatio*(t-i.left),a=this._devicePixelRatio*(i.top+i.height-e);return this._isRotated?(r.x=n.game.canvas.width-a,r.y=o):(r.x=o,r.y=a),n.GAME_VIEW&&(r.x/=n.gameView.canvas.width/n.game.canvas.width,r.y/=n.gameView.canvas.height/n.game.canvas.height),r}_convertPointWithScale(t){const e=this._viewportRect;t.x=(t.x-e.x)/this._scaleX,t.y=(t.y-e.y)/this._scaleY}_resizeEvent(){const t=n.view;if(t._frameSize.width,t._frameSize.height,t._isRotated,n.sys.isMobile){const e=n.game.container.style,i=e.margin;e.margin="0",e.display="none",t._initFrameSize(),e.margin=i,e.display="block"}else t._initFrameSize();const e=t._originalDesignResolutionSize.width,i=t._originalDesignResolutionSize.height;t._resizing=!0,e>0&&t.setDesignResolutionSize(e,i,t._resolutionPolicy),t._resizing=!1,t.emit("canvas-resize"),t._resizeCallback&&t._resizeCallback.call()}_orientationChange(){n.view._orientationChanging=!0,n.view._resizeEvent()}_initFrameSize(){const t=this._frameSize,e=zv.availWidth(n.game.frame),i=zv.availHeight(n.game.frame),s=e>=i;!n.sys.isMobile||s&&this._orientation&n.macro.ORIENTATION_LANDSCAPE||!s&&this._orientation&n.macro.ORIENTATION_PORTRAIT?(t.width=e,t.height=i,n.game.container.style["-webkit-transform"]="rotate(0deg)",n.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(t.width=i,t.height=e,n.game.container.style["-webkit-transform"]="rotate(90deg)",n.game.container.style.transform="rotate(90deg)",n.game.container.style["-webkit-transform-origin"]="0px 0px 0px",n.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,n.game.canvas.style["-webkit-transform"]="translateZ(0px)",n.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout((()=>{n.view._orientationChanging=!1}),1e3)}_adjustSizeKeepCanvasSize(){const t=this._originalDesignResolutionSize.width,e=this._originalDesignResolutionSize.height;t>0&&this.setDesignResolutionSize(t,e,this._resolutionPolicy)}_setViewportMeta(t,e){let i=document.getElementById("cocosMetaElement");i&&e&&document.head.removeChild(i);const n=document.getElementsByName("viewport"),s=n?n[0]:null;let r,o,a;for(o in r=s?s.content:"",i=i||document.createElement("meta"),i.id="cocosMetaElement",i.name="viewport",i.content="",t)-1===r.indexOf(o)?r+=`,${o}=${t[o]}`:e&&(a=new RegExp(`${o}s*=s*[^,]+`),r=r.replace(a,`${o}=${t[o]}`));/^,/.test(r)&&(r=r.substr(1)),i.content=r,s&&(s.content=r),document.head.appendChild(i)}_adjustViewportMeta(){this._isAdjustViewport}_convertMouseToLocation(t,e){t.x=this._devicePixelRatio*(t.x-e.left),t.y=this._devicePixelRatio*(e.top+e.height-t.y),n.GAME_VIEW&&(t.x/=n.gameView.canvas.width/n.game.canvas.width,t.y/=n.gameView.canvas.height/n.game.canvas.height)}_convertTouchWidthScale(t){const e=this._viewportRect,i=this._scaleX,n=this._scaleY;t._point.x=(t._point.x-e.x)/i,t._point.y=(t._point.y-e.y)/n,t._prevPoint.x=(t._prevPoint.x-e.x)/i,t._prevPoint.y=(t._prevPoint.y-e.y)/n}_convertTouchesWithScale(t){const e=this._viewportRect,i=this._scaleX,n=this._scaleY;let s,r;for(let o=0;o<t.length;o++){const a=t[o];s=a._point,r=a._prevPoint,s.x=(s.x-e.x)/i,s.y=(s.y-e.y)/n,r.x=(r.x-e.x)/i,r.y=(r.y-e.y)/n}}}t("View",Vv),Vv.instance=void 0;class Uv{constructor(){this.name="ContainerStrategy"}preApply(t){}apply(t,e){}postApply(t){}_setupContainer(t,e,i){const s=n.game.canvas,r=n.game.container;hn.os!==sn.ANDROID&&hn.os!==sn.OHOS||(document.body.style.width=`${t._isRotated?i:e}px`,document.body.style.height=`${t._isRotated?e:i}px`),r.style.width=s.style.width=`${e}px`,r.style.height=s.style.height=`${i}px`,t._devicePixelRatio=1,t.isRetinaEnabled()&&(t._devicePixelRatio=Math.min(t._maxPixelRatio,window.devicePixelRatio||1)),s.width=Cy.windowPixelResolution.width,s.height=Cy.windowPixelResolution.height}_fixContainer(){document.body.insertBefore(n.game.container,document.body.firstChild);const t=document.body.style;t.width=`${window.innerWidth}px`,t.height=`${window.innerHeight}px`,t.overflow="hidden";const e=n.game.container.style;e.position="fixed",e.left=e.top="0px",document.body.scrollTop=0}}Uv.EQUAL_TO_FRAME=void 0,Uv.PROPORTION_TO_FRAME=void 0;class Gv{constructor(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}preApply(t){}apply(t,e){return{scale:[1,1]}}postApply(t){}_buildResult(t,e,i,n,s,r){Math.abs(t-i)<2&&(i=t),Math.abs(e-n)<2&&(n=e);const o=new Oi(Math.round((t-i)/2),Math.round((e-n)/2),i,n);return this._result.scale=[s,r],this._result.viewport=o,this._result}}Gv.EXACT_FIT=void 0,Gv.SHOW_ALL=void 0,Gv.NO_BORDER=void 0,Gv.FIXED_HEIGHT=void 0,Gv.FIXED_WIDTH=void 0,(()=>{const t=("undefined"==typeof window?global:window).__globalAdapter;t&&(t.adaptContainerStrategy&&t.adaptContainerStrategy(Uv.prototype),t.adaptView&&t.adaptView(Vv.prototype)),Uv.EQUAL_TO_FRAME=new class extends Uv{constructor(...t){super(...t),this.name="EqualToFrame"}apply(t){const e=t._frameSize.height,i=n.game.container.style;this._setupContainer(t,t._frameSize.width,t._frameSize.height),t._isRotated?i.margin=`0 0 0 ${e}px`:i.margin="0px",i.padding="0px"}},Uv.PROPORTION_TO_FRAME=new class extends Uv{constructor(...t){super(...t),this.name="ProportionalToFrame"}apply(t,e){const i=t._frameSize.width,s=t._frameSize.height,r=n.game.container.style,o=e.width,a=e.height,l=i/o,c=s/a;let h,_;l<c?(h=i,_=a*l):(h=o*c,_=s);const u=Math.round((i-h)/2),m=Math.round((s-_)/2);h=i-2*u,_=s-2*m,this._setupContainer(t,h,_),t._isRotated?r.margin=`0 0 0 ${s}px`:r.margin="0px",r.paddingLeft=`${u}px`,r.paddingRight=`${u}px`,r.paddingTop=`${m}px`,r.paddingBottom=`${m}px`}},Gv.EXACT_FIT=new class extends Gv{constructor(...t){super(...t),this.name="ExactFit"}apply(t,e){const i=n.game.canvas.width,s=n.game.canvas.height,r=i/e.width,o=s/e.height;return this._buildResult(i,s,i,s,r,o)}},Gv.SHOW_ALL=new class extends Gv{constructor(...t){super(...t),this.name="ShowAll"}apply(t,e){const i=n.game.canvas.width,s=n.game.canvas.height,r=e.width,o=e.height,a=i/r,l=s/o;let c,h,_=0;return a<l?(_=a,c=i,h=o*_):(_=l,c=r*_,h=s),this._buildResult(i,s,c,h,_,_)}},Gv.NO_BORDER=new class extends Gv{constructor(...t){super(...t),this.name="NoBorder"}apply(t,e){const i=n.game.canvas.width,s=n.game.canvas.height,r=e.width,o=e.height,a=i/r,l=s/o;let c,h,_;return a<l?(c=l,h=r*c,_=s):(c=a,h=i,_=o*c),this._buildResult(i,s,h,_,c,c)}},Gv.FIXED_HEIGHT=new class extends Gv{constructor(...t){super(...t),this.name="FixedHeight"}apply(t,e){const i=n.game.canvas.width,s=n.game.canvas.height,r=s/e.height,o=i,a=s;return this._buildResult(i,s,o,a,r,r)}},Gv.FIXED_WIDTH=new class extends Gv{constructor(...t){super(...t),this.name="FixedWidth"}apply(t,e){const i=n.game.canvas.width,s=n.game.canvas.height,r=i/e.width,o=i,a=s;return this._buildResult(i,s,o,a,r,r)}}})();class Hv{constructor(t,e){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(e)}get canvasSize(){return new Ti(n.game.canvas.width,n.game.canvas.height)}preApply(t){this._containerStrategy.preApply(t),this._contentStrategy.preApply(t)}apply(t,e){return this._containerStrategy.apply(t,e),this._contentStrategy.apply(t,e)}postApply(t){this._containerStrategy.postApply(t),this._contentStrategy.postApply(t)}setContainerStrategy(t){t instanceof Uv&&(this._containerStrategy=t)}setContentStrategy(t){t instanceof Gv&&(this._contentStrategy=t)}}t("ResolutionPolicy",Hv),Hv.EXACT_FIT=0,Hv.NO_BORDER=1,Hv.SHOW_ALL=2,Hv.FIXED_HEIGHT=3,Hv.FIXED_WIDTH=4,Hv.UNKNOWN=5,Hv.ContainerStrategy=Uv,Hv.ContentStrategy=Gv,n.ResolutionPolicy=Hv;const kv=t("view",Vv.instance=n.view=new Vv);n.winSize=new Mi,V(Vv.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),z(sy,"EventMouse",["DOWN","UP","MOVE"].map((t=>({name:t,newName:`MOUSE_${t}`,target:vy.EventType,targetName:"SystemEvent.EventType"})))),z(sy,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:vy.EventType,targetName:"SystemEvent.EventType"}]),z(ry,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:vy.EventType,targetName:"SystemEvent.EventType"}]),z(ry,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:vy.EventType,targetName:"SystemEvent.EventType"}]),z(ry,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:vy.EventType,targetName:"SystemEvent.EventType"}]),z(ry,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:vy.EventType,targetName:"SystemEvent.EventType"}]),z(Cy,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((t=>({name:`LANGUAGE_${t}`,newName:t,target:Cy.Language,targetName:"sys.Language"})))),z(Cy,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((t=>({name:`OS_${t}`,newName:t,target:Cy.OS,targetName:"sys.OS"})))),z(Cy,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((t=>({name:`BROWSER_TYPE_${t}`,newName:t,target:Cy.BrowserType,targetName:"sys.BrowserType"})))),z(Cy,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:Cy.BrowserType,targetName:"sys.BrowserType"}]),z(Cy,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((t=>({name:t,target:Cy.Platform,targetName:"sys.Platform"})))),z(Cy,"sys",[{name:"IPHONE",newName:"IOS",target:Cy.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:Cy.Platform,targetName:"sys.Platform"}]),V(Cy,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((t=>({name:t}))));const jv=t("screen",{_supportsFullScreen:!1,_onfullscreenchange:null,_onfullscreenerror:null,_preOnFullScreenError:null,_preOnTouch:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init(){let t,e,i;this._fn={};const n=this._fnMap;let s;for(t=0,e=n.length;t<e;t++)if(i=n[t],i&&void 0!==document[i[1]]){for(t=0,s=i.length;t<s;t++)this._fn[n[0][t]]=i[t];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},get supportsFullScreen(){return this._supportsFullScreen},fullScreen(){return!!this._supportsFullScreen&&void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement]},requestFullScreen(t,e,i){if(!this._supportsFullScreen)return;if(t=t||document.documentElement,e){const t=this._fn.fullscreenchange;this._onfullscreenchange&&document.removeEventListener(t,this._onfullscreenchange),this._onfullscreenchange=e,document.addEventListener(t,e,!1)}if(i){const t=this._fn.fullscreenerror;this._onfullscreenerror&&document.removeEventListener(t,this._onfullscreenerror),this._onfullscreenerror=i,document.addEventListener(t,i,{once:!0})}const n=t[this._fn.requestFullscreen]();return window.Promise&&n instanceof Promise&&n.catch((()=>{})),n},exitFullScreen(){let t;return this.fullScreen()&&(t=document[this._fn.exitFullscreen](),t.catch((()=>{}))),t},autoFullScreen(t,e){t=t||document.body,this._ensureFullScreen(t,e),this.requestFullScreen(t,e)},disableAutoFullScreen(t){if(this._preOnTouch){const e=n.game.canvas||t,i=this._touchEvent;e.removeEventListener(i,this._preOnTouch),this._preOnTouch=null}},_ensureFullScreen(t,e){const i=n.game.canvas||t,s=this._fn.fullscreenerror,r=this._touchEvent,o=()=>{this._preOnFullScreenError=null,this._preOnTouch&&i.removeEventListener(r,this._preOnTouch),this._preOnTouch=()=>{this._preOnTouch=null,this.requestFullScreen(t,e)},i.addEventListener(r,this._preOnTouch,{once:!0})};this._preOnFullScreenError&&t.removeEventListener(s,this._preOnFullScreenError),this._preOnFullScreenError=o,t.addEventListener(s,o,{once:!0})}});jv.init(),n.screen=jv;const Wv=new ma(null);class qv{constructor(){this._device=null,this._passes=null,this._subMesh=null,this._patches=null,this._handle=0,this._priority=Ic.DEFAULT,this._inputAssembler=null,this._descriptorSet=null}set passes(t){if(t.length>8)T(12004,8);else if(this._passes=t,this._flushPassInfo(),this._descriptorSet){zn.free(is.get(this._handle,ts.DESCRIPTOR_SET)),Wv.layout=t[0].localSetLayout;const e=zn.alloc(this._device,Wv);is.set(this._handle,ts.DESCRIPTOR_SET,e),this._descriptorSet=zn.get(e)}}get passes(){return this._passes}set subMesh(t){this._subMesh=t,this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===zd.VB_MERGING&&this._subMesh.genFlatBuffers(),is.set(this._handle,ts.SUB_MESH,t.handle)}get subMesh(){return this._subMesh}set priority(t){this._priority=t,is.set(this._handle,ts.PRIORITY,t)}get priority(){return this._priority}get handle(){return this._handle}get inputAssembler(){return this._inputAssembler}get descriptorSet(){return this._descriptorSet}get patches(){return this._patches}get planarShaderHandle(){return is.get(this._handle,ts.PLANAR_SHADER)}get planarInstanceShaderHandle(){return is.get(this._handle,ts.PLANAR_INSTANCE_SHADER)}initialize(t,e,i=null){this._device=n.director.root.device,this._subMesh=t,this._patches=i,this._passes=e,this._handle=is.alloc(),this._flushPassInfo(),e[0].batchingScheme===zd.VB_MERGING&&this._subMesh.genFlatBuffers(),Wv.layout=e[0].localSetLayout;const s=zn.alloc(this._device,Wv),r=Vn.alloc(this._device,t.iaInfo);is.set(this._handle,ts.PRIORITY,Ic.DEFAULT),is.set(this._handle,ts.INPUT_ASSEMBLER,r),is.set(this._handle,ts.DESCRIPTOR_SET,s),is.set(this._handle,ts.SUB_MESH,t.handle),this._inputAssembler=Vn.get(r),this._descriptorSet=zn.get(s)}initPlanarShadowShader(){const t=n.director.root.pipeline.pipelineSceneData.shadows.getPlanarShader(this._patches);is.set(this._handle,ts.PLANAR_SHADER,t)}initPlanarShadowInstanceShader(){const t=n.director.root.pipeline.pipelineSceneData.shadows.getPlanarInstanceShader(this._patches);is.set(this._handle,ts.PLANAR_INSTANCE_SHADER,t)}destroy(){zn.free(is.get(this._handle,ts.DESCRIPTOR_SET)),Vn.free(is.get(this._handle,ts.INPUT_ASSEMBLER)),is.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=Ic.DEFAULT,this._handle=0,this._patches=null,this._subMesh=null,this._passes=null}update(){for(let t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update()}onPipelineStateChanged(){const t=this._passes;if(t){for(let e=0;e<t.length;e++){const i=t[e];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}onMacroPatchesStateChanged(t){this._patches=t;const e=this._passes;if(e){for(let t=0;t<e.length;t++){const i=e[t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}_flushPassInfo(){const t=this._passes;if(!t)return;is.set(this._handle,ts.PASS_COUNT,t.length);let e=ts.PASS_0,i=ts.SHADER_0;for(let n=0;n<t.length;n++,e++,i++)is.set(this._handle,e,t[n].handle),is.set(this._handle,i,t[n].getShaderVariant(this._patches))}}class Xv{static get(t,e=0){const i=Xv._buffers;i.has(t)||i.set(t,{});const n=i.get(t);return n[e]||(n[e]=new Xv(t))}constructor(t){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.pass=t}destroy(){for(let t=0;t<this.instances.length;++t){const e=this.instances[t];e.vb.destroy(),e.ia.destroy()}this.instances.length=0}merge(t,e,i,n=null){const s=e.buffer.length;if(!s)return;const r=t.inputAssembler,o=t.descriptorSet.getTexture(Mh);let a=n;a||(a=is.get(t.handle,ts.SHADER_0+i));const l=is.get(t.handle,ts.DESCRIPTOR_SET);for(let t=0;t<this.instances.length;++t){const i=this.instances[t];if(!(i.ia.indexBuffer!==r.indexBuffer||i.count>=1024)&&i.lightingMap===o){if(i.stride!==s)return;if(i.count>=i.capacity){i.capacity<<=1;const t=i.stride*i.capacity,e=i.data;i.data=new Uint8Array(t),i.data.set(e),i.vb.resize(t)}return i.hShader!==a&&(i.hShader=a),i.hDescriptorSet!==l&&(i.hDescriptorSet=l),i.data.set(e.buffer,i.stride*i.count++),void(this.hasPendingModels=!0)}}const c=this._device.createBuffer(new zo(Xr.VERTEX|Xr.TRANSFER_DST,Jr.HOST|Jr.DEVICE,32*s,s)),h=new Uint8Array(32*s),_=r.vertexBuffers.slice(),u=r.attributes.slice(),m=r.indexBuffer;for(let t=0;t<e.attributes.length;t++){const i=e.attributes[t],n=new rl(i.name,i.format,i.isNormalized,_.length,!0);u.push(n)}h.set(e.buffer),_.push(c);const d=new na(u,_,m),p=this._device.createInputAssembler(d);this.instances.push({count:1,capacity:32,vb:c,data:h,ia:p,stride:s,hShader:a,hDescriptorSet:l,lightingMap:o}),this.hasPendingModels=!0}uploadBuffers(t){for(let e=0;e<this.instances.length;++e){const i=this.instances[e];i.count&&(i.ia.instanceCount=i.count,t.updateBuffer(i.vb,i.data))}}clear(){for(let t=0;t<this.instances.length;++t)this.instances[t].count=0;this.hasPendingModels=!1}}Xv._buffers=new Map;const Yv=new Mn(Ln.ATTRIBUTE,((t,e)=>e||new rl)),Kv=new Si,Jv=new Fi((()=>new qv),32),$v=[{name:"CC_RECEIVE_SHADOW",value:!0}];let Zv;!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(Zv||(Zv={}));const Qv=Lu([eo.LINEAR,eo.LINEAR,eo.NONE,io.CLAMP,io.CLAMP,io.CLAMP]),tx=Lu([eo.LINEAR,eo.LINEAR,eo.LINEAR,io.CLAMP,io.CLAMP,io.CLAMP]);class ex{get subModels(){return this._subModels}get inited(){return this._inited}get worldBounds(){return this._worldBounds}get modelBounds(){return this._modelBounds}get localBuffer(){return this._localBuffer}get updateStamp(){return this._updateStamp}get isInstancingEnabled(){return this._instMatWorldIdx>=0}get receiveShadow(){return!!rs.get(this._handle,ns.RECEIVE_SHADOW)}set receiveShadow(t){rs.set(this._handle,ns.RECEIVE_SHADOW,t?1:0),this.onMacroPatchesStateChanged()}get castShadow(){return!!rs.get(this._handle,ns.CAST_SHADOW)}set castShadow(t){rs.set(this._handle,ns.CAST_SHADOW,t?1:0)}get handle(){return this._handle}get node(){return this._node}set node(t){this._node=t,rs.set(this._handle,ns.NODE,t.handle)}get transform(){return this._transform}set transform(t){this._transform=t,rs.set(this._handle,ns.TRANSFORM,t.handle)}get visFlags(){return rs.get(this._handle,ns.VIS_FLAGS)}set visFlags(t){rs.set(this._handle,ns.VIS_FLAGS,t)}get enabled(){return!!rs.get(this._handle,ns.ENABLED)}set enabled(t){rs.set(this._handle,ns.ENABLED,t?1:0)}constructor(){this.type=Zv.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._handle=0,this._hWorldBounds=0,this._localData=new Float32Array(mh.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Ii,this._device=n.director.root.device}initialize(){if(!this._inited){this._handle=rs.alloc();const t=Hn.alloc(),e=jn.alloc();rs.set(this._handle,ns.INSTANCED_ATTR_ARRAY,e),rs.set(this._handle,ns.SUB_MODEL_ARRAY,t),rs.set(this._handle,ns.VIS_FLAGS,Ec.Enum.NONE),rs.set(this._handle,ns.ENABLED,1),rs.set(this._handle,ns.RECEIVE_SHADOW,1),rs.set(this._handle,ns.CAST_SHADOW,0),this._inited=!0}}destroy(){const t=this._subModels;for(let e=0;e<t.length;e++){const t=this._subModels[e];t.destroy(),Jv.free(t)}if(this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._handle){const t=rs.get(this._handle,ns.SUB_MODEL_ARRAY);t&&Hn.free(t);const e=rs.get(this._handle,ns.INSTANCED_BUFFER);e&&Kn.free(e);const i=rs.get(this._handle,ns.INSTANCED_ATTR_ARRAY);i&&Nn(i,jn,Yv),rs.free(this._handle),this._handle=0}this._hWorldBounds&&(_s.free(this._hWorldBounds),this._hWorldBounds=0)}attachToScene(t){this.scene=t}detachFromScene(){this.scene=null}updateTransform(t){const e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._transformUpdated=!0;const t=this._worldBounds;this._modelBounds&&t&&(this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t),_s.setVec3(this._hWorldBounds,cs.CENTER,t.center),_s.setVec3(this._hWorldBounds,cs.HALF_EXTENSION,t.halfExtents))}}updateWorldBound(){const t=this.transform;if(null!==t){t.updateWorldTransform(),this._transformUpdated=!0;const e=this._worldBounds;this._modelBounds&&e&&(this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e),_s.setVec3(this._hWorldBounds,cs.CENTER,e.center),_s.setVec3(this._hWorldBounds,cs.HALF_EXTENSION,e.halfExtents))}}updateUBOs(t){const e=this._subModels;for(let t=0;t<e.length;t++)e[t].update();if(this._updateStamp=t,!this._transformUpdated)return;this._transformUpdated=!1;const i=this.transform._mat,n=this._instMatWorldIdx;if(n>=0){const t=this.instancedAttributes.views;!function(t,e,i,n){e[0]=t.m00,e[1]=t.m01,e[2]=t.m02,e[3]=t.m12,i[0]=t.m04,i[1]=t.m05,i[2]=t.m06,i[3]=t.m13,n[0]=t.m08,n[1]=t.m09,n[2]=t.m10,n[3]=t.m14}(i,t[n],t[n+1],t[n+2])}else this._localBuffer&&(Si.toArray(this._localData,i,mh.MAT_WORLD_OFFSET),Si.inverseTranspose(Kv,i),Si.toArray(this._localData,Kv,mh.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData))}createBoundingShape(t,e){t&&e&&(this._modelBounds=lc.fromPoints(lc.create(),t,e),this._worldBounds=lc.clone(this._modelBounds),0===this._hWorldBounds&&(this._hWorldBounds=_s.alloc(),rs.set(this._handle,ns.WORLD_BOUNDS,this._hWorldBounds)),_s.setVec3(this._hWorldBounds,cs.CENTER,this._worldBounds.center),_s.setVec3(this._hWorldBounds,cs.HALF_EXTENSION,this._worldBounds.halfExtents))}initSubModel(t,e,i){this.initialize();let n=!1;if(null==this._subModels[t]?(this._subModels[t]=Jv.alloc(),n=!0):this._subModels[t].destroy(),this._subModels[t].initialize(e,i.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._subModels[t].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(t),n){const e=rs.get(this._handle,ns.SUB_MODEL_ARRAY);Hn.assign(e,t,this._subModels[t].handle)}}setSubModelMesh(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)}setSubModelMaterial(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))}onGlobalPipelineStateChanged(){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].onPipelineStateChanged()}onMacroPatchesStateChanged(){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))}updateLightingmap(t,e){Ii.toArray(this._localData,e,mh.LIGHTINGMAP_UVPARAM),this._lightmap=t,this._lightmapUVParam=e,null===t&&(t=Bd.get("empty-texture"));const i=t.getGFXTexture();if(i){const e=Fu.getSampler(this._device,t.mipmaps.length>1?tx:Qv),n=this._subModels;for(let t=0;t<n.length;t++){const{descriptorSet:s}=n[t];s.bindTexture(Mh,i),s.bindSampler(Mh,e),s.update()}}}getMacroPatches(t){return this.receiveShadow?$v:null}_updateAttributesAndBinding(t){const e=this._subModels[t];if(!e)return;this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet);const i=Fn.get(is.get(e.handle,ts.SHADER_0));this._updateInstancedAttributes(i.attributes,e.passes[0])}_getInstancedAttributeIndex(t){const{attributes:e}=this.instancedAttributes;for(let i=0;i<e.length;i++)if(e[i].name===t)return i;return-1}_updateInstancedAttributes(t,e){if(!e.device.hasFeature(kr.INSTANCED_ARRAYS))return;const i=rs.get(this._handle,ns.INSTANCED_BUFFER);i&&Kn.free(i);const n=rs.get(this._handle,ns.INSTANCED_ATTR_ARRAY);n&&Nn(n,jn,Yv,!1);let s=0;for(let e=0;e<t.length;e++){const i=t[e];i.isInstanced&&(s+=Aa[i.format].size)}const r=Kn.alloc(s),o=Kn.getBuffer(r);rs.set(this._handle,ns.INSTANCED_BUFFER,r);const a=this.instancedAttributes;a.buffer=new Uint8Array(o),a.views.length=a.attributes.length=0;let l=0;for(let e=0;e<t.length;e++){const i=t[e];if(!i.isInstanced)continue;const s=Yv.alloc(),r=Yv.get(s);r.format=i.format,r.name=i.name,r.isNormalized=i.isNormalized,r.location=i.location,a.attributes.push(r),jn.push(n,s);const c=Aa[i.format];a.views.push(new(Ra(c))(o,l,c.count)),l+=c.size}e.batchingScheme===zd.INSTANCING&&Xv.get(e).destroy(),this._instMatWorldIdx=this._getInstancedAttributeIndex("a_matWorld0"),this._transformUpdated=!0}_initLocalDescriptors(t){this._localBuffer||(this._localBuffer=this._device.createBuffer(new zo(Xr.UNIFORM|Xr.TRANSFER_DST,Jr.HOST|Jr.DEVICE,mh.SIZE,mh.SIZE)))}_updateLocalDescriptors(t,e){this._localBuffer&&e.bindBuffer(mh.BINDING,this._localBuffer)}}const ix=new oi(0,0,-1),nx=new mi,sx=new Si,rx=new Si,ox=new Si,ax=new Si;var lx=Object.freeze({__proto__:null,Ambient:pr,get CameraFOVAxis(){return Vh},get CameraProjection(){return Uh},get CameraAperture(){return Gh},get CameraISO(){return Hh},get CameraShutter(){return kh},SKYBOX_FLAG:Jh,Camera:Zh,CameraVisFlags:Ud,VisibilityFlags:Gd,DirectionalLight:class extends Wd{set direction(t){oi.normalize(this._dir,t),Xs.setVec3(this._handle,Ws.DIRECTION,this._dir)}get direction(){return this._dir}set illuminance(t){Xs.set(this._handle,Ws.ILLUMINANCE,t)}get illuminance(){return Xs.get(this._handle,Ws.ILLUMINANCE)}constructor(){super(),this._dir=new oi(1,-1,-1)}initialize(){super.initialize(),Xs.set(this._handle,Ws.ILLUMINANCE,pr.SUN_ILLUM),Xs.setVec3(this._handle,Ws.DIRECTION,this._dir),Xs.set(this._handle,Ws.TYPE,kd.DIRECTIONAL)}update(){this._node&&this._node.hasChangedFlags&&(this.direction=oi.transformQuat(Xd,qd,this._node.worldRotation))}},ColorTemperatureToRGB:Hd,get LightType(){return kd},nt2lm:jd,Light:Wd,get ModelType(){return Zv},Model:ex,ShadowType:uv,PCFType:mv,Shadows:pv,RenderScene:e_,Skybox:_v,SphereLight:class extends Wd{get position(){return this._pos}set size(t){Xs.set(this._handle,Ws.SIZE,t)}get size(){return Xs.get(this._handle,Ws.SIZE)}set range(t){Xs.set(this._handle,Ws.RANGE,t),this._needUpdate=!0}get range(){return Xs.get(this._handle,Ws.RANGE)}set luminance(t){Xs.set(this._handle,Ws.ILLUMINANCE,t)}get luminance(){return Xs.get(this._handle,Ws.ILLUMINANCE)}get aabb(){return this._aabb}constructor(){super(),this._needUpdate=!1,this._pos=void 0,this._aabb=void 0,this._hAABB=0,this._aabb=lc.create(),this._pos=new oi}initialize(){super.initialize(),this._hAABB=_s.alloc(),Xs.set(this._handle,Ws.TYPE,kd.SPHERE),Xs.set(this._handle,Ws.SIZE,.15),Xs.set(this._handle,Ws.RANGE,1),Xs.set(this._handle,Ws.AABB,this._hAABB),Xs.set(this._handle,Ws.ILLUMINANCE,1700/jd(.15))}update(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);const t=Xs.get(this._handle,Ws.RANGE);lc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1,Xs.setVec3(this._handle,Ws.POSITION,this._pos),_s.setVec3(this._hAABB,cs.CENTER,this._aabb.center),_s.setVec3(this._hAABB,cs.HALF_EXTENSION,this._aabb.halfExtents)}}destroy(){return this._hAABB&&(_s.free(this._hAABB),this._hAABB=0),super.destroy()}},SpotLight:class extends Wd{get position(){return this._pos}set size(t){Xs.set(this._handle,Ws.SIZE,t)}get size(){return Xs.get(this._handle,Ws.SIZE)}set range(t){this._range=t,Xs.set(this._handle,Ws.RANGE,t),this._needUpdate=!0}get range(){return Xs.get(this._handle,Ws.RANGE)}set luminance(t){Xs.set(this._handle,Ws.ILLUMINANCE,t)}get luminance(){return Xs.get(this._handle,Ws.ILLUMINANCE)}get direction(){return this._dir}get spotAngle(){return Xs.get(this._handle,Ws.SPOT_ANGLE)}set spotAngle(t){this._angle=t,Xs.set(this._handle,Ws.SPOT_ANGLE,Math.cos(.5*t)),this._needUpdate=!0}set aspect(t){Xs.set(this._handle,Ws.ASPECT,t),this._needUpdate=!0}get aspect(){return Xs.get(this._handle,Ws.ASPECT)}get aabb(){return this._aabb}get frustum(){return this._frustum}constructor(){super(),this._dir=new oi(1,-1,-1),this._range=5,this._spotAngle=Math.cos(Math.PI/6),this._pos=void 0,this._aabb=void 0,this._frustum=void 0,this._angle=0,this._needUpdate=!1,this._hAABB=0,this._hFrustum=0,this._aabb=lc.create(),this._frustum=pc.create(),this._pos=new oi}initialize(){super.initialize(),this._hAABB=_s.alloc(),this._hFrustum=Is.alloc(),Xs.set(this._handle,Ws.TYPE,kd.SPOT),Xs.set(this._handle,Ws.SIZE,.15),Xs.set(this._handle,Ws.AABB,this._hAABB),Xs.set(this._handle,Ws.ILLUMINANCE,1700/jd(.15)),Xs.set(this._handle,Ws.RANGE,Math.cos(Math.PI/6)),Xs.set(this._handle,Ws.ASPECT,1),Xs.setVec3(this._handle,Ws.DIRECTION,this._dir),Xs.set(this._handle,Ws.FRUSTUM,this._hFrustum)}update(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),oi.transformQuat(this._dir,ix,this._node.getWorldRotation(nx)),oi.normalize(this._dir,this._dir),Xs.setVec3(this._handle,Ws.DIRECTION,this._dir),lc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(sx),Si.invert(sx,sx),Si.perspective(rx,this._angle,1,.001,this._range),Si.multiply(ox,rx,sx),this._frustum.update(ox,ax),this._needUpdate=!1,Xs.setVec3(this._handle,Ws.POSITION,this._pos),_s.setVec3(this._hAABB,cs.CENTER,this._aabb.center),_s.setVec3(this._hAABB,cs.HALF_EXTENSION,this._aabb.halfExtents),fc(this._hFrustum,this._frustum))}destroy(){return this._hAABB&&(_s.free(this._hAABB),this._hAABB=0),this._hFrustum&&(Is.free(this._hFrustum),this._hFrustum=0),super.destroy()}},SubModel:qv});let cx,hx;function _x(t){return--t,t|=t>>16,t|=t>>8,t|=t>>4,t|=t>>2,t|=t>>1,++t}function ux(t,e){return Math.ceil(t/e)*e}!function(t){t[t.OPAQUE=0]="OPAQUE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OVERLAY=2]="OVERLAY"}(cx||(cx={})),function(t){t[t.DEFAULT=1]="DEFAULT",t[t.FORWARD=2]="FORWARD",t[t.SHADOWCAST=4]="SHADOWCAST"}(hx||(hx={}));const mx=wn.addStage;var dx=Object.freeze({__proto__:null,addStage:mx,scene:lx,createIA:function(t,e){if(!e.positions)return console.error("The data must have positions field"),null;const i=[],n=e.positions.length/3;for(let t=0;t<n;++t)i.push(e.positions[3*t],e.positions[3*t+1],e.positions[3*t+2]),e.normals&&i.push(e.normals[3*t],e.normals[3*t+1],e.normals[3*t+2]),e.uvs&&i.push(e.uvs[2*t],e.uvs[2*t+1]),e.colors&&i.push(e.colors[3*t],e.colors[3*t+1],e.colors[3*t+2]);const s=[];s.push(new rl(bo.ATTR_POSITION,jr.RGB32F)),e.normals&&s.push(new rl(bo.ATTR_NORMAL,jr.RGB32F)),e.uvs&&s.push(new rl(bo.ATTR_TEX_COORD,jr.RG32F)),e.colors&&s.push(new rl(bo.ATTR_COLOR,jr.RGB32F));const r=t.createBuffer(new zo(Xr.VERTEX|Xr.TRANSFER_DST,Jr.HOST|Jr.DEVICE,4*i.length,4*i.length/n));r.update(new Float32Array(i));let o=null;return e.indices&&(o=t.createBuffer(new zo(Xr.INDEX|Xr.TRANSFER_DST,Jr.HOST|Jr.DEVICE,2*e.indices.length,2)),o.update(new Uint16Array(e.indices))),t.createInputAssembler(new na(s,[r],o))},get RenderQueue(){return cx},get PassStage(){return hx},get PropertyType(){return ud},genHandle:md,getPropertyTypeFromHandle:dd,getTypeFromHandle:pd,getSetIndexFromHandle:t=>(t&hd)>>>20,getBindingFromHandle:fd,getOffsetFromHandle:gd,customizeType:yd,type2reader:vd,type2writer:xd,getDefaultFromType:Ad,overrideMacros:Cd,get BatchingSchemes(){return zd},Pass:Vd,getDeviceShaderVersion:Dd,programLib:Rd,get SamplerInfoIndex(){return Du},defaultSamplerHash:Bu,genSamplerHash:Lu,samplerLib:Fu,nearestPOT:_x,TextureBufferPool:class{constructor(t){this._device=void 0,this._format=jr.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new Oo,this._region1=new Oo,this._region2=new Oo,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}initialize(t){const e=Aa[t.format];this._format=t.format,this._formatSize=e.size,this._channels=e.count,this._bufferViewCtor=Ra(e),this._roundUpFn=t.roundUpFn||null,this._alignment=t.alignment||1,t.inOrderFree&&(this.alloc=this._McDonaldAlloc)}destroy(){for(let t=0;t<this._chunkCount;++t)this._chunks[t].texture.destroy();this._chunks.length=0,this._handles.length=0}alloc(t,e){t=ux(t,this._alignment);let i=-1,n=-1;if(void 0!==e&&(i=e,n=this._findAvailableSpace(t,i)),n<0)for(let e=0;e<this._chunkCount&&(i=e,n=this._findAvailableSpace(t,i),!(n>=0));++e);if(n>=0){const e=this._chunks[i];e.start+=t;const s={chunkIdx:i,start:n,end:n+t,texture:e.texture};return this._handles.push(s),s}const s=Math.sqrt(t/this._formatSize),r=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,_x(s)),o=this._chunks[this.createChunk(r)];o.start+=t;const a={chunkIdx:this._chunkCount-1,start:0,end:t,texture:o.texture};return this._handles.push(a),a}free(t){for(let e=0;e<this._handles.length;++e)if(this._handles[e]===t)return this._chunks[t.chunkIdx].end=t.end,void this._handles.splice(e,1)}createChunk(t){const e=t*t*this._formatSize;console.info(`TextureBufferPool: Allocate chunk ${this._chunkCount}, size: ${e}, format: ${this._format}`);const i={texture:this._device.createTexture(new ko($r.TEX2D,Zr.SAMPLED|Zr.TRANSFER_DST,this._format,t,t,Qr.IMMUTABLE)),size:e,start:0,end:e};return this._chunks[this._chunkCount]=i,this._chunkCount++}update(t,e){const i=[],n=[],s=t.start/this._formatSize;let r=e.byteLength/this._formatSize,o=s%t.texture.width,a=Math.floor(s/t.texture.width),l=Math.min(t.texture.width-o,r),c=0;o>0&&(this._region0.texOffset.x=o,this._region0.texOffset.y=a,this._region0.texExtent.width=l,this._region0.texExtent.height=1,i.push(new this._bufferViewCtor(e,c*this._formatSize,l*this._channels)),n.push(this._region0),o=0,a+=1,r-=l,c+=l),r>0&&(this._region1.texOffset.x=o,this._region1.texOffset.y=a,r>t.texture.width?(this._region1.texExtent.width=t.texture.width,this._region1.texExtent.height=Math.floor(r/t.texture.width),l=this._region1.texExtent.width*this._region1.texExtent.height):(l=r,this._region1.texExtent.width=l,this._region1.texExtent.height=1),i.push(new this._bufferViewCtor(e,c*this._formatSize,l*this._channels)),n.push(this._region1),o=0,a+=this._region1.texExtent.height,r-=l,c+=l),r>0&&(this._region2.texOffset.x=o,this._region2.texOffset.y=a,this._region2.texExtent.width=r,this._region2.texExtent.height=1,i.push(new this._bufferViewCtor(e,c*this._formatSize,r*this._channels)),n.push(this._region2)),this._device.copyBuffersToTexture(i,t.texture,n)}_findAvailableSpace(t,e){const i=this._chunks[e];let n=!1,s=i.start;if(s+t<=i.size)n=!0;else{s=0;const r=this._handles.filter((t=>t.chunkIdx===e)).sort(((t,e)=>t.start-e.start));for(let e=0;e<r.length;e++){const i=r[e];if(s+t<=i.start){n=!0;break}s=i.end}!n&&s+t<=i.size&&(n=!0)}return n?s:-1}_McDonaldAlloc(t){t=ux(t,this._alignment);for(let e=0;e<this._chunkCount;++e){const i=this._chunks[e];let n=!1,s=i.start;if(s+t<=i.end?n=!0:s>i.end?s+t<=i.size?n=!0:t<=i.end&&(i.start=s=0,n=!0):s===i.end&&(i.start=s=0,i.end=i.size,t<=i.end&&(n=!0)),n){i.start+=t;const n={chunkIdx:e,start:s,end:s+t,texture:i.texture};return this._handles.push(n),n}}const e=Math.sqrt(t/this._formatSize),i=this._roundUpFn&&this._roundUpFn(e,this._formatSize)||Math.max(1024,_x(e)),n=this._chunks[this.createChunk(i)];n.start+=t;const s={chunkIdx:this._chunkCount,start:0,end:t,texture:n.texture};return this._handles.push(s),s}},MaterialInstance:lv,PassInstance:av,ObjectPool:Mn,freeHandleArray:Nn,get PoolType(){return Ln},NULL_HANDLE:0,ShaderPool:Fn,DSPool:zn,IAPool:Vn,PipelineLayoutPool:Un,FramebufferPool:Gn,SubModelArrayPool:Hn,ModelArrayPool:kn,AttributeArrayPool:jn,FlatBufferArrayPool:Wn,LightArrayPool:qn,BlendTargetArrayPool:Xn,UIBatchArrayPool:Yn,RawBufferPool:Kn,RawObjectPool:Jn,get PassView(){return $n},PassPool:Qn,get SubModelView(){return ts},SubModelPool:is,get ModelView(){return ns},ModelPool:rs,get BatchView2D(){return os},BatchPool2D:ls,get AABBView(){return cs},AABBPool:_s,get SceneView(){return us},ScenePool:ds,get CameraView(){return ps},CameraPool:gs,get NodeView(){return ys},NodePool:xs,get RootView(){return Ss},RootPool:Cs,get RenderWindowView(){return bs},RenderWindowPool:ws,get FrustumView(){return Es},FrustumPool:Is,get AmbientView(){return Ds},AmbientPool:Ms,get SkyboxView(){return Bs},SkyboxPool:Ns,get FogView(){return Ls},FogPool:zs,get ShadowsView(){return Vs},ShadowsPool:Gs,get PipelineSceneDataView(){return Hs},PipelineSceneDataPool:js,get LightView(){return Ws},LightPool:Xs,get SphereView(){return Ys},SpherePool:Js,get FlatBufferView(){return $s},FlatBufferPool:Qs,get SubMeshView(){return tr},SubMeshPool:ir,get RasterizerStateView(){return sr},RasterizerStatePool:or,get DepthStencilStateView(){return ar},DepthStencilStatePool:cr,get BlendTargetView(){return hr},BlendTargetPool:_r,get BlendStateView(){return ur},BlendStatePool:dr});function px(t){return t*t}function fx(t){return t*(2-t)}function gx(t){return t*t*t}function yx(t){return--t*t*t+1}function vx(t){return t*t*t*t}function xx(t){return 1- --t*t*t*t}function Sx(t){return t*t*t*t*t}function Ax(t){return--t*t*t*t*t+1}function Cx(t){return 1===t?1:1-Math.cos(t*Math.PI/2)}function bx(t){return Math.sin(t*Math.PI/2)}function Tx(t){return 0===t?0:Math.pow(1024,t-1)}function wx(t){return 1===t?1:1-Math.pow(2,-10*t)}function Ex(t){return 1-Math.sqrt(1-t*t)}function Px(t){return Math.sqrt(1- --t*t)}function Ix(t){let e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4))}function Dx(t){let e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*t)*Math.sin(2*(t-e)*Math.PI/.4)+1)}function Rx(t){if(1===t)return 1;const e=1.70158;return t*t*((e+1)*t-e)}function Mx(t){if(0===t)return 0;const e=1.70158;return--t*t*((e+1)*t+e)+1}function Bx(t){return 1-Ox(1-t)}function Ox(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}t("renderer",dx);const Nx=Wx(px,fx),Lx=Wx(gx,yx),Fx=Wx(vx,xx),zx=Wx(Sx,Ax),Vx=Wx(Cx,bx),Ux=Wx(Tx,wx),Gx=Wx(Ex,Px),Hx=Wx(Ix,Dx),kx=Wx(Rx,Mx),jx=Wx(Bx,Ox);function Wx(t,e){return i=>i<.5?e(2*i)/2:t(2*i-1)/2+.5}var qx=Object.freeze({__proto__:null,constant:function(){return 0},linear:function(t){return t},quadIn:px,quadOut:fx,quadInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},cubicIn:gx,cubicOut:yx,cubicInOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},quartIn:vx,quartOut:xx,quartInOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},quintIn:Sx,quintOut:Ax,quintInOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},sineIn:Cx,sineOut:bx,sineInOut:function(t){return.5*(1-Math.cos(Math.PI*t))},expoIn:Tx,expoOut:wx,expoInOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))},circIn:Ex,circOut:Px,circInOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},elasticIn:Ix,elasticOut:Dx,elasticInOut:function(t){let e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),(t*=2)<1?i*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*-.5:i*Math.pow(2,-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*.5+1)},backIn:Rx,backOut:Mx,backInOut:function(t){const e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)},bounceIn:Bx,bounceOut:Ox,bounceInOut:function(t){return t<.5?.5*Bx(2*t):.5*Ox(2*t-1)+.5},smooth:function(t){return t<=0?0:t>=1?1:t*t*(3-2*t)},fade:function(t){return t<=0?0:t>=1?1:t*t*t*(t*(6*t-15)+10)},quadOutIn:Nx,cubicOutIn:Lx,quartOutIn:Fx,quintOutIn:zx,sineOutIn:Vx,expoOutIn:Ux,circOutIn:Gx,elasticOutIn:Hx,backOutIn:kx,bounceOutIn:jx});t("easing",qx);const Xx=new Ti;class Yx{set splashFinish(t){this._splashFinish=t,this._tryToStart()}set loadFinish(t){this._loadFinish=t,this._tryToStart()}main(t){if(null!=t){if(window._CCSettings&&window._CCSettings.splashScreen){const t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new Lo(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new Lo(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{n.view.enableRetina(!0),n.view.resizeWithBrowserSize(!0);const e=window._CCSettings.designResolution;e?n.view.setDesignResolutionSize(e.width,e.height,e.policy):n.view.setDesignResolutionSize(960,640,4),this.root=t,this.device=t.device,n.game.once(n.Game.EVENT_GAME_INITED,(()=>{n.director._lateUpdate=performance.now()}),n.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else d("RENDER ROOT IS NULL.")}setOnFinish(t){if(this._directCall&&t)return Yx._ins=void 0,void t();this.callBack=t}_tryToStart(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),n.game.resume())}preInit(){const t=this.settings.clearColor;this.clearColors=[new Lo(t.x,t.y,t.z,t.w)];const e=this.device;this.renderArea=new Po(0,0,e.width,e.height),this.framebuffer=this.root.mainWindow.framebuffer,this.cmdBuff=e.commandBuffer;const i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),n=4*Float32Array.BYTES_PER_ELEMENT,s=4*n;this.vertexBuffers=e.createBuffer(new zo(Xr.VERTEX|Xr.TRANSFER_DST,Jr.HOST|Jr.DEVICE,s,n)),this.vertexBuffers.update(i);const r=new Uint16Array([0,1,2,1,3,2]),o=Uint16Array.BYTES_PER_ELEMENT,a=6*o;this.indicesBuffers=e.createBuffer(new zo(Xr.INDEX|Xr.TRANSFER_DST,Jr.HOST|Jr.DEVICE,a,o)),this.indicesBuffers.update(r);const l=[new rl("a_position",jr.RG32F),new rl("a_texCoord",jr.RG32F)],c=new na(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=e.createInputAssembler(c),this.projection=new Si,Si.ortho(this.projection,-1,1,-1,1,-1,1,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY,e.surfaceTransform)}init(){this.initLogo(),this.settings.displayWatermark&&this.initWarterMark();const t=e=>{if(this.cancelAnimate)return;const i=this.settings,n=this.device;Si.ortho(this.projection,-1,1,-1,1,-1,1,n.capabilities.clipSpaceMinZ,n.capabilities.clipSpaceSignY,n.surfaceTransform);const s=n.width,r=n.height,o=s<r?s:r;this.startTime<0&&(this.startTime=e);const a=e-this.startTime;let l=yx(Ge(a/i.totalTime));"NONE"===i.effect&&(l=1);const c=this.logoTexture.width,h=this.logoTexture.height,_=o*i.displayRatio;let u=_*c/h,m=_;if(n.surfaceTransform!==Hr.ROTATE_90&&n.surfaceTransform!==Hr.ROTATE_270||(u=_*s/r,m=_*h/c*r/s),this.logoMat.setProperty("resolution",Xx.set(s,r),0),this.logoMat.setProperty("scale",Xx.set(u,m),0),this.logoMat.setProperty("translate",Xx.set(.5*s,.5*r),0),this.logoMat.setProperty("precent",l),this.logoMat.setProperty("u_projection",this.projection),this.logoMat.passes[0].update(),i.displayWatermark&&this.watermarkMat){const t=.5*o,e=this.watermarkTexture.width;let i=t,a=t*this.watermarkTexture.height/e;n.surfaceTransform!==Hr.ROTATE_90&&n.surfaceTransform!==Hr.ROTATE_270||(i=.5*t,a=t*s/r*.5),this.watermarkMat.setProperty("resolution",Xx.set(s,r),0),this.watermarkMat.setProperty("scale",Xx.set(i,a),0),this.watermarkMat.setProperty("translate",Xx.set(.5*s,.1*r),0),this.watermarkMat.setProperty("precent",l),this.watermarkMat.setProperty("u_projection",this.projection),this.watermarkMat.passes[0].update()}this.frame(),a>i.totalTime&&(this.splashFinish=!0),requestAnimationFrame(t)};n.game.pause(),this.handle=requestAnimationFrame(t)}hide(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))}initLogo(){const t=this.device;this.logoMat=new ov,this.logoMat.initialize({effectName:"splash-screen"});const e=new Wo;e.addressU=io.CLAMP,e.addressV=io.CLAMP,e.addressW=io.CLAMP,this.sampler=t.createSampler(e),this.logoTexture=t.createTexture(new ko($r.TEX2D,Zr.SAMPLED|Zr.TRANSFER_DST,jr.RGBA8,this.logoImage.width,this.logoImage.height));const i=this.logoMat.passes[0],n=i.getBinding("mainTexture");i.bindTexture(n,this.logoTexture),this.shader=Fn.get(i.getShaderVariant());const s=zn.get(Qn.get(i.handle,$n.DESCRIPTOR_SET));s.bindSampler(n,this.sampler),s.update();const r=new Oo;r.texExtent.width=this.logoImage.width,r.texExtent.height=this.logoImage.height,r.texExtent.depth=1,t.copyTexImagesToTexture([this.logoImage],this.logoTexture,[r])}initWarterMark(){const t=document.createElement("canvas");t.width=330,t.height=30,t.style.width=`${t.width}`,t.style.height=`${t.height}`;const e=t.getContext("2d");e.font="18px Arial",e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`";const i="Powered by Cocos Creator",n=e.measureText(i);e.fillText(i,(330-n.width)/2,6);const s=new Oo;s.texExtent.width=t.width,s.texExtent.height=t.height,s.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new ko($r.TEX2D,Zr.SAMPLED|Zr.TRANSFER_DST,jr.RGBA8,t.width,t.height)),this.device.copyTexImagesToTexture([t],this.watermarkTexture,[s]),this.watermarkMat=new ov,this.watermarkMat.initialize({effectName:"splash-screen"});const r=this.watermarkMat.passes[0],o=r.getBinding("mainTexture");r.bindTexture(o,this.watermarkTexture),zn.get(Qn.get(r.handle,$n.DESCRIPTOR_SET)).update()}frame(){const t=this.device;t.acquire();const e=this.cmdBuff,i=this.framebuffer,n=this.renderArea;n.width=t.nativeWidth,n.height=t.nativeHeight,e.begin(),e.beginRenderPass(i.renderPass,i,n,this.clearColors,1,0);const s=this.logoMat.passes[0],r=yv.getOrCreatePipelineState(t,s,this.shader,i.renderPass,this.quadAssmebler);if(e.bindPipelineState(r),e.bindDescriptorSet(zc.MATERIAL,s.descriptorSet),e.bindInputAssembler(this.quadAssmebler),e.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){const n=this.watermarkMat.passes[0],s=yv.getOrCreatePipelineState(t,n,this.shader,i.renderPass,this.quadAssmebler);e.bindPipelineState(s),e.bindDescriptorSet(zc.MATERIAL,n.descriptorSet),e.bindInputAssembler(this.quadAssmebler),e.draw(this.quadAssmebler)}e.endRenderPass(),e.end(),t.flushCommands([e]),t.queue.submit([e]),t.present()}destroy(){this.callBack=null,this.root=null,this.device=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler.destroy(),this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,Yx._ins=void 0}static get instance(){return Yx._ins||(Yx._ins=new Yx),Yx._ins}constructor(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}}Yx._ins=void 0,n.internal.SplashScreen=Yx;class Kx{constructor(){this._id="",this._priority=0,this._executeInEditMode=!1}set priority(t){this._priority=t}get priority(){return this._priority}set id(t){this._id=t}get id(){return this._id}static sortByPriority(t,e){return t._priority<e._priority?1:t._priority>e.priority?-1:0}init(){}update(t){}postUpdate(t){}}t("System",Kx);const Jx=new Q("Scheduler");class $x{constructor(t,e,i,n){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=e,this.paused=i,this.markedForDeletion=n}}$x.get=(t,e,i,n)=>{let s=$x._listEntries.pop();return s?(s.target=t,s.priority=e,s.paused=i,s.markedForDeletion=n):s=new $x(t,e,i,n),s},$x.put=t=>{$x._listEntries.length<20&&(t.target=null,$x._listEntries.push(t))},$x._listEntries=[];class Zx{constructor(t,e,i,n){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=e,this.target=i,this.callback=n}}Zx.get=(t,e,i,n)=>{let s=Zx._hashUpdateEntries.pop();return s?(s.list=t,s.entry=e,s.target=i,s.callback=n):s=new Zx(t,e,i,n),s},Zx.put=t=>{Zx._hashUpdateEntries.length<20&&(t.list=t.entry=t.target=t.callback=null,Zx._hashUpdateEntries.push(t))},Zx._hashUpdateEntries=[];class Qx{constructor(t,e,i,n,s,r){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=e,this.timerIndex=i,this.currentTimer=n,this.currentTimerSalvaged=s,this.paused=r}}Qx.get=(t,e,i,n,s,r)=>{let o=Qx._hashTimerEntries.pop();return o?(o.timers=t,o.target=e,o.timerIndex=i,o.currentTimer=n,o.currentTimerSalvaged=s,o.paused=r):o=new Qx(t,e,i,n,s,r),o},Qx.put=t=>{Qx._hashTimerEntries.length<20&&(t.timers=t.target=t.currentTimer=null,Qx._hashTimerEntries.push(t))},Qx._hashTimerEntries=[];class tS{constructor(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}initWithCallback(t,e,i,s,r,o){return this._lock=!1,this._scheduler=t,this._target=i,this._callback=e,this._elapsed=-1,this._interval=s,this._delay=o,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===n.macro.REPEAT_FOREVER,!0}getInterval(){return this._interval}setInterval(t){this._interval=t}update(t){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=t,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}getCallback(){return this._callback}trigger(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}cancel(){this._scheduler.unschedule(this._callback,this._target)}}tS._timers=[],tS.get=()=>tS._timers.pop()||new tS,tS.put=t=>{tS._timers.length<20&&!t._lock&&(t._scheduler=t._target=t._callback=null,tS._timers.push(t))};class eS extends Kx{static enableForTarget(t){let e=!1;(t.uuid||t.id)&&(e=!0),e||(t.__instanceId?C(1513):t.id=Jx.getNewId())}constructor(){super(),this._timeScale=void 0,this._updatesNegList=void 0,this._updates0List=void 0,this._updatesPosList=void 0,this._hashForUpdates=void 0,this._hashForTimers=void 0,this._currentTarget=void 0,this._currentTargetSalvaged=void 0,this._updateHashLocked=void 0,this._arrayForTimers=void 0,this._timeScale=1,this._updatesNegList=[],this._updates0List=[],this._updatesPosList=[],this._hashForUpdates=ht(!0),this._hashForTimers=ht(!0),this._currentTarget=null,this._currentTargetSalvaged=!1,this._updateHashLocked=!1,this._arrayForTimers=[]}setTimeScale(t){this._timeScale=t}getTimeScale(){return this._timeScale}update(t){let e,i,n,s,r;for(this._updateHashLocked=!0,1!==this._timeScale&&(t*=this._timeScale),e=0,i=this._updatesNegList,n=i.length;e<n;e++)s=i[e],s.paused||s.markedForDeletion||s.target.update(t);for(e=0,i=this._updates0List,n=i.length;e<n;e++)s=i[e],s.paused||s.markedForDeletion||s.target.update(t);for(e=0,i=this._updatesPosList,n=i.length;e<n;e++)s=i[e],s.paused||s.markedForDeletion||s.target.update(t);const o=this._arrayForTimers;for(e=0;e<o.length;e++){if(r=o[e],this._currentTarget=r,this._currentTargetSalvaged=!1,!r.paused)for(r.timerIndex=0;r.timerIndex<r.timers.length;++r.timerIndex)r.currentTimer=r.timers[r.timerIndex],r.currentTimerSalvaged=!1,r.currentTimer.update(t),r.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--e)}for(e=0,i=this._updatesNegList;e<i.length;)s=i[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;for(e=0,i=this._updates0List;e<i.length;)s=i[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;for(e=0,i=this._updatesPosList;e<i.length;)s=i[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;this._updateHashLocked=!1,this._currentTarget=null}schedule(t,e,i,s,r,o){if("function"!=typeof t){const i=t;t=e,e=i}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!s,s=n.macro.REPEAT_FOREVER,r=0),E(e,1502);const a=e.uuid||e.id;if(!a)return void T(1510);let l,c,h=this._hashForTimers[a];if(h?h.paused!==o&&C(1511):(h=Qx.get(null,e,0,null,null,o),this._arrayForTimers.push(h),this._hashForTimers[a]=h),null==h.timers)h.timers=[];else for(c=0;c<h.timers.length;++c)if(l=h.timers[c],l&&t===l._callback)return S(1507,l.getInterval(),i),void(l._interval=i);l=tS.get(),l.initWithCallback(this,t,e,i,s,r),h.timers.push(l),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}scheduleUpdate(t,e,i){const n=t.uuid||t.id;if(!n)return void T(1510);const s=this._hashForUpdates[n];if(s&&s.entry){if(s.entry.priority===e)return s.entry.markedForDeletion=!1,void(s.entry.paused=i);if(this._updateHashLocked)return S(1506),s.entry.markedForDeletion=!1,void(s.entry.paused=i);this.unscheduleUpdate(t)}const r=$x.get(t,e,i,!1);let o;0===e?(o=this._updates0List,this._appendIn(o,r)):(o=e<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,r,e)),this._hashForUpdates[n]=Zx.get(o,r,t,null)}unschedule(t,e){if(!e||!t)return;const i=e.uuid||e.id;if(!i)return void T(1510);const n=this,s=n._hashForTimers[i];if(s){const e=s.timers;for(let i=0,r=e.length;i<r;i++){const r=e[i];if(t===r._callback)return r!==s.currentTimer||s.currentTimerSalvaged||(s.currentTimerSalvaged=!0),e.splice(i,1),tS.put(r),s.timerIndex>=i&&s.timerIndex--,void(0===e.length&&(n._currentTarget===s?n._currentTargetSalvaged=!0:n._removeHashElement(s)))}}}unscheduleUpdate(t){if(!t)return;const e=t.uuid||t.id;if(!e)return void T(1510);const i=this._hashForUpdates[e];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}unscheduleAllForTarget(t){if(!t)return;const e=t.uuid||t.id;if(!e)return void T(1510);const i=this._hashForTimers[e];if(i){const t=i.timers;t.indexOf(i.currentTimer)>-1&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(let e=0,i=t.length;e<i;e++)tS.put(t[e]);t.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(t)}unscheduleAll(){this.unscheduleAllWithMinPriority(n.Scheduler.PRIORITY_SYSTEM)}unscheduleAllWithMinPriority(t){let e,i;const n=this._arrayForTimers;for(e=n.length-1;e>=0;e--)i=n[e],this.unscheduleAllForTarget(i.target);let s,r=0;if(t<0)for(e=0;e<this._updatesNegList.length;)r=this._updatesNegList.length,s=this._updatesNegList[e],s&&s.priority>=t&&this.unscheduleUpdate(s.target),r===this._updatesNegList.length&&e++;if(t<=0)for(e=0;e<this._updates0List.length;)r=this._updates0List.length,s=this._updates0List[e],s&&this.unscheduleUpdate(s.target),r===this._updates0List.length&&e++;for(e=0;e<this._updatesPosList.length;)r=this._updatesPosList.length,s=this._updatesPosList[e],s&&s.priority>=t&&this.unscheduleUpdate(s.target),r===this._updatesPosList.length&&e++}isScheduled(t,e){E(t,1508),E(e,1509);const i=e.uuid||e.id;if(!i)return void T(1510);const n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;{const e=n.timers;for(let i=0;i<e.length;++i)if(t===e[i]._callback)return!0;return!1}}pauseAllTargets(){return this.pauseAllTargetsWithMinPriority(n.Scheduler.PRIORITY_SYSTEM)}pauseAllTargetsWithMinPriority(t){const e=[];let i;const n=this._arrayForTimers;let s,r,o;for(s=0,r=n.length;s<r;s++)i=n[s],i&&(i.paused=!0,e.push(i.target));if(t<0)for(s=0;s<this._updatesNegList.length;s++)o=this._updatesNegList[s],o&&o.priority>=t&&(o.paused=!0,e.push(o.target));if(t<=0)for(s=0;s<this._updates0List.length;s++)o=this._updates0List[s],o&&(o.paused=!0,e.push(o.target));for(s=0;s<this._updatesPosList.length;s++)o=this._updatesPosList[s],o&&o.priority>=t&&(o.paused=!0,e.push(o.target));return e}resumeTargets(t){if(t)for(let e=0;e<t.length;e++)this.resumeTarget(t[e])}pauseTarget(t){E(t,1503);const e=t.uuid||t.id;if(!e)return void T(1510);const i=this._hashForTimers[e];i&&(i.paused=!0);const n=this._hashForUpdates[e];n&&(n.entry.paused=!0)}resumeTarget(t){E(t,1504);const e=t.uuid||t.id;if(!e)return void T(1510);const i=this._hashForTimers[e];i&&(i.paused=!1);const n=this._hashForUpdates[e];n&&(n.entry.paused=!1)}isTargetPaused(t){E(t,1505);const e=t.uuid||t.id;if(!e)return T(1510),!1;const i=this._hashForTimers[e];if(i)return i.paused;const n=this._hashForUpdates[e];return!!n&&n.entry.paused}_removeHashElement(t){const e=t.target.uuid||t.target.id;delete this._hashForTimers[e];const i=this._arrayForTimers;for(let e=0,n=i.length;e<n;e++)if(i[e]===t){i.splice(e,1);break}Qx.put(t)}_removeUpdateFromHash(t){const e=t.target.uuid||t.target.id,i=this,n=i._hashForUpdates[e];if(n){const t=n.list,s=n.entry;for(let e=0,i=t.length;e<i;e++)if(t[e]===s){t.splice(e,1);break}delete i._hashForUpdates[e],$x.put(s),Zx.put(n)}}_priorityIn(t,e,i){for(let n=0;n<t.length;n++)if(i<t[n].priority)return void t.splice(n,0,e);t.push(e)}_appendIn(t,e){t.push(e)}}t("Scheduler",eS),eS.PRIORITY_SYSTEM=1<<31,eS.PRIORITY_NON_SYSTEM=eS.PRIORITY_SYSTEM+1,eS.ID="scheduler",n.Scheduler=eS;class iS{get width(){return this._width}get height(){return this._height}get framebuffer(){return Gn.get(ws.get(this._poolHandle,bs.FRAMEBUFFER))}get shouldSyncSizeWithSwapchain(){return this._shouldSyncSizeWithSwapchain}get hasOnScreenAttachments(){return 1===ws.get(this._poolHandle,bs.HAS_ON_SCREEN_ATTACHMENTS)}get hasOffScreenAttachments(){return 1===ws.get(this._poolHandle,bs.HAS_OFF_SCREEN_ATTACHMENTS)}get handle(){return this._poolHandle}get cameras(){return this._cameras}static registerCreateFunc(t){t._createWindowFun=t=>new iS(t)}constructor(t){this._title="",this._width=1,this._height=1,this._nativeWidth=1,this._nativeHeight=1,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._swapchainBufferIndices=0,this._shouldSyncSizeWithSwapchain=!1,this._poolHandle=0,this._cameras=[]}initialize(t,e){this._poolHandle=ws.alloc(),void 0!==e.title&&(this._title=e.title),void 0!==e.swapchainBufferIndices&&(this._swapchainBufferIndices=e.swapchainBufferIndices),void 0!==e.shouldSyncSizeWithSwapchain&&(this._shouldSyncSizeWithSwapchain=e.shouldSyncSizeWithSwapchain),this._width=e.width,this._height=e.height,this._nativeWidth=this._width,this._nativeHeight=this._height;const{colorAttachments:i,depthStencilAttachment:n}=e.renderPassInfo;for(let e=0;e<i.length;e++)i[e].format===jr.UNKNOWN&&(i[e].format=t.colorFormat);n&&n.format===jr.UNKNOWN&&(n.format=t.depthStencilFormat),this._renderPass=t.createRenderPass(e.renderPassInfo);for(let e=0;e<i.length;e++){let n=null;this._swapchainBufferIndices&1<<e?ws.set(this._poolHandle,bs.HAS_ON_SCREEN_ATTACHMENTS,1):(n=t.createTexture(new ko($r.TEX2D,Zr.COLOR_ATTACHMENT|Zr.SAMPLED,i[e].format,this._width,this._height)),ws.set(this._poolHandle,bs.HAS_OFF_SCREEN_ATTACHMENTS,1)),this._colorTextures.push(n)}n&&(this._swapchainBufferIndices>=0?(this._depthStencilTexture=t.createTexture(new ko($r.TEX2D,Zr.DEPTH_STENCIL_ATTACHMENT|Zr.SAMPLED,n.format,this._width,this._height)),ws.set(this._poolHandle,bs.HAS_OFF_SCREEN_ATTACHMENTS,1)):ws.set(this._poolHandle,bs.HAS_ON_SCREEN_ATTACHMENTS,1));const s=Gn.alloc(t,new ha(this._renderPass,this._colorTextures,this._depthStencilTexture));return ws.set(this._poolHandle,bs.FRAMEBUFFER,s),!0}destroy(){this.clearCameras(),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(let t=0;t<this._colorTextures.length;t++){const e=this._colorTextures[t];e&&e.destroy()}this._colorTextures.length=0,this._poolHandle&&(Gn.get(ws.get(this._poolHandle,bs.FRAMEBUFFER)).destroy(),this._poolHandle=0)}resize(t,e){if(this._width=t,this._height=e,t>this._nativeWidth||e>this._nativeHeight){this._nativeWidth=t,this._nativeHeight=e;let i=!1;this._depthStencilTexture&&(this._depthStencilTexture.resize(t,e),i=!0);for(let n=0;n<this._colorTextures.length;n++){const s=this._colorTextures[n];s&&(s.resize(t,e),i=!0)}const n=Gn.get(ws.get(this._poolHandle,bs.FRAMEBUFFER));i&&n&&(n.destroy(),n.initialize(new ha(this._renderPass,this._colorTextures,this._depthStencilTexture)))}for(const i of this._cameras)i.isWindowSize&&i.resize(t,e)}extractRenderCameras(t){for(let e=0;e<this._cameras.length;e++){const i=this._cameras[e];i.enabled&&(i.update(),t.push(i))}}attachCamera(t){for(let e=0;e<this._cameras.length;e++)if(this._cameras[e]===t)return;this._cameras.push(t),this.sortCameras()}detachCamera(t){for(let e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return void this._cameras.splice(e,1)}clearCameras(){this._cameras.length=0}sortCameras(){this._cameras.sort(((t,e)=>t.priority-e.priority))}}class nS{get device(){return this._device}get mainWindow(){return this._mainWindow}set curWindow(t){this._curWindow=t}get curWindow(){return this._curWindow}set tempWindow(t){this._tempWindow=t}get tempWindow(){return this._tempWindow}get windows(){return this._windows}get pipeline(){return this._pipeline}get batcher2D(){return this._batcher}get scenes(){return this._scenes}get cumulativeTime(){return Cs.get(this._poolHandle,Ss.CUMULATIVE_TIME)}get frameTime(){return Cs.get(this._poolHandle,Ss.FRAME_TIME)}get frameCount(){return this._frameCount}get fps(){return this._fps}set fixedFPS(t){t>0?(this._fixedFPS=t,this._fixedFPSFrameTime=1e3/t):this._fixedFPSFrameTime=0}get fixedFPS(){return this._fixedFPS}get dataPoolManager(){return this._dataPoolMgr}get handle(){return this._poolHandle}get useDeferredPipeline(){return this._useDeferredPipeline}constructor(t){this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._fixedFPSFrameTime=0,this._poolHandle=0,this._useDeferredPipeline=!1,this._device=t,this._dataPoolMgr=n.internal.DataPoolManager&&new n.internal.DataPoolManager(t),e_.registerCreateFunc(this),iS.registerCreateFunc(this),this._cameraPool=new Fi((()=>new Zh(this._device)),4)}initialize(t){this._poolHandle=Cs.alloc();const e=new sa,i=new ra;i.depthStoreOp=ho.DISCARD,i.stencilStoreOp=ho.DISCARD;const s=new aa([e],i);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:this._device.width,height:this._device.height,renderPassInfo:s,swapchainBufferIndices:-1}),this._curWindow=this._mainWindow,Promise.resolve(Bd.initBuiltinRes(this._device)).then((()=>{n.view.on("design-resolution-changed",(()=>{const t=n.game.canvas.width,e=n.game.canvas.height;this.resize(t,e)}),this)}))}destroy(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._poolHandle&&(Cs.free(this._poolHandle),this._poolHandle=0)}resize(t,e){this._device.resize(t,e),this._mainWindow.resize(t,e);for(const i of this._windows)i.shouldSyncSizeWithSwapchain&&i.resize(t,e);this._pipeline&&this._pipeline.resize(t,e)}setRenderPipeline(t){if(t instanceof Iv&&(this._useDeferredPipeline=!0),t||(t=Av()),this._pipeline=t,!this._pipeline.activate())return!1;const e=n.director.getScene();return e&&e.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&n.internal.Batcher2D&&(this._batcher=new n.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))}onGlobalPipelineStateChanged(){for(let t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.initDeferredPassInfo()}activeWindow(t){this._curWindow=t}resetCumulativeTime(){Cs.set(this._poolHandle,Ss.CUMULATIVE_TIME,0)}frameMove(t){Cs.set(this._poolHandle,Ss.FRAME_TIME,t),++this._frameCount,Cs.set(this._poolHandle,Ss.CUMULATIVE_TIME,Cs.get(this._poolHandle,Ss.CUMULATIVE_TIME)+t),this._fpsTime+=t,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(let t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();this._batcher&&this._batcher.update();const e=this._windows,i=[];for(let t=0;t<e.length;t++)e[t].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire();const t=this._scenes,e=n.director.getTotalFrames();this._batcher&&this._batcher.uploadBuffers();for(let i=0;i<t.length;i++)t[i].update(e);n.director.emit(n.Director.EVENT_BEFORE_COMMIT),i.sort(((t,e)=>t.priority-e.priority)),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()}createWindow(t){const e=this._createWindowFun(this);return e.initialize(this.device,t),this._windows.push(e),e}destroyWindow(t){for(let e=0;e<this._windows.length;++e)if(this._windows[e]===t)return t.destroy(),void this._windows.splice(e,1)}destroyWindows(){for(const t of this._windows)t.destroy();this._windows=[]}createScene(t){const e=this._createSceneFun(this);return e.initialize(t),this._scenes.push(e),e}destroyScene(t){for(let e=0;e<this._scenes.length;++e)if(this._scenes[e]===t)return t.destroy(),void this._scenes.splice(e,1)}destroyScenes(){for(const t of this._scenes)t.destroy();this._scenes=[]}createModel(t){let e=this._modelPools.get(t);e||(this._modelPools.set(t,new Fi((()=>new t),10)),e=this._modelPools.get(t));const i=e.alloc();return i.initialize(),i}destroyModel(t){const e=this._modelPools.get(t.constructor);e?(e.free(t),t.destroy(),t.scene&&t.scene.removeModel(t)):C(1300,t.constructor.name)}createCamera(){return this._cameraPool.alloc()}createLight(t){let e=this._lightPools.get(t);e||(this._lightPools.set(t,new Fi((()=>new t),4)),e=this._lightPools.get(t));const i=e.alloc();return i.initialize(),i}destroyLight(t){const e=this._lightPools.get(t.constructor);if(t.destroy(),e&&(e.free(t),t.scene))switch(t.type){case kd.SPHERE:t.scene.removeSphereLight(t);break;case kd.SPOT:t.scene.removeSpotLight(t)}}}n.Root=nS;const sS={};z(sS,"vmath",[{name:"vec2",newName:"Vec2",target:Li,targetName:"math"},{name:"vec3",newName:"Vec3",target:Li,targetName:"math"},{name:"vec4",newName:"Vec4",target:Li,targetName:"math"},{name:"quat",newName:"Quat",target:Li,targetName:"math"},{name:"mat3",newName:"Mat3",target:Li,targetName:"math"},{name:"mat4",newName:"Mat4",target:Li,targetName:"math"},{name:"color4",newName:"Color",target:Li,targetName:"math"},{name:"rect",newName:"Rect",target:Li,targetName:"math"},{name:"approx",newName:"approx",target:Li,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:Li,targetName:"math"},{name:"equals",newName:"equals",target:Li,targetName:"math"},{name:"clamp",newName:"clamp",target:Li,targetName:"math"},{name:"clamp01",newName:"clamp01",target:Li,targetName:"math"},{name:"lerp",newName:"lerp",target:Li,targetName:"math"},{name:"toRadian",newName:"toRadian",target:Li,targetName:"math"},{name:"toDegree",newName:"toDegree",target:Li,targetName:"math"},{name:"random",newName:"random",target:Li,targetName:"math"},{name:"randomRange",newName:"randomRange",target:Li,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:Li,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:Li,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:Li,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:Li,targetName:"math"},{name:"repeat",newName:"repeat",target:Li,targetName:"math"},{name:"pingPong",newName:"pingPong",target:Li,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:Li,targetName:"math"}]),n.vmath=sS,z(eS.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:eS,targetName:"Scheduler"}]),z(ry.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:ry,targetName:"EventTouch"}]),z(qv.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),V(qv.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),z(nS.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]);var rS=Object.freeze({__proto__:null,ccclass:u_,property:f_,requireComponent:m_,executionOrder:d_,disallowMultiple:p_,executeInEditMode:x_,menu:S_,playOnFocus:A_,inspector:C_,icon:b_,help:T_,type:H_,integer:z_,float:V_,boolean:U_,string:G_});t("_decorator",rS);const oS=Gi.Flags.Destroyed,aS=Gi.Flags.PersistentMask,lS=[];function cS(t){let e;if(t instanceof Gi){if(t._instantiate)return n.game._isCloning=!0,e=t._instantiate(null,!0),n.game._isCloning=!1,e;if(t instanceof n.Asset)throw new TypeError(I(6903))}return n.game._isCloning=!0,e=hS(t),n.game._isCloning=!1,e}function hS(t,e){let i;i=t._iN$t?t._iN$t:t.constructor?new(0,t.constructor):Object.create(null),_S(t,i,e);for(let t=0,e=lS.length;t<e;++t)lS[t]._iN$t=null;return lS.length=0,i}function _S(t,e,i){Vt.value(t,"_iN$t",e,!0),lS.push(t);const s=t.constructor;if(n.Class._isCCClass(s))!function(t,e,i,n){const s=t.__values__;for(let t=0;t<s.length;t++){const r=s[t],o=e[r];if("object"==typeof o&&o){const t=i[r];t instanceof Wt&&t.constructor===o.constructor?t.set(o):i[r]=o._iN$t||uS(o,n)}else i[r]=o}}(s,t,e,i);else for(const n in t){if(!t.hasOwnProperty(n)||95===n.charCodeAt(0)&&95===n.charCodeAt(1)&&"__type__"!==n)continue;const s=t[n];if("object"==typeof s&&s){if(s===e)continue;e[n]=s._iN$t||uS(s,i)}else e[n]=s}t instanceof Gi&&(e._objFlags&=aS)}function uS(t,e){if(t instanceof Wt)return t.clone();if(t instanceof n.Asset)return t;let i;if(ArrayBuffer.isView(t)){const e=t.length;i=new t.constructor(e),t._iN$t=i,lS.push(t);for(let n=0;n<e;++n)i[n]=t[n];return i}if(Array.isArray(t)){const n=t.length;i=new Array(n),t._iN$t=i,lS.push(t);for(let s=0;s<n;++s){const n=t[s];i[s]="object"==typeof n&&n?n._iN$t||uS(n,e):n}return i}if(t._objFlags&oS)return null;const s=t.constructor;if(n.Class._isCCClass(s)){if(e)if(e instanceof n.Component){if(t instanceof n._BaseNode||t instanceof n.Component)return t}else if(e instanceof n._BaseNode)if(t instanceof n._BaseNode){if(!t.isChildOf(e))return t}else if(t instanceof n.Component&&t.node&&!t.node.isChildOf(e))return t;i=new s}else if(s===Object)i={};else{if(s)return t;i=Object.create(null)}return _S(t,i,e),i}var mS,dS,pS,fS,gS,yS,vS,xS;let SS,AS;function CS(t,e){return(e<<3)+t}cS._clone=hS,n.instantiate=cS,function(t){t[t.Uint8=0]="Uint8",t[t.Uint16=1]="Uint16",t[t.Uint32=2]="Uint32",t[t.Int8=3]="Int8",t[t.Int16=4]="Int16",t[t.Int32=5]="Int32",t[t.Float32=6]="Float32",t[t.Float64=7]="Float64"}(SS||(SS={})),function(t){t[t.Scalar=0]="Scalar",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Quat=4]="Quat",t[t.Mat4=5]="Mat4"}(AS||(AS={}));let bS=t("CompactValueTypeArray",u_("cc.CompactValueTypeArray")((xS=vS=class t{constructor(){i_(this,"_byteOffset",pS,this),i_(this,"_unitCount",fS,this),i_(this,"_unitElement",gS,this),i_(this,"_length",yS,this)}static lengthFor(t,e,i){return TS(e).requiredUnits*t.length*wS(i).BYTES_PER_ELEMENT}static compress(e,i,n,s,r,o){const a=TS(i),l=wS(n),c=a.requiredUnits*e.length,h=new l(s,r,c);for(let t=0;t<e.length;++t)a.compress(h,t,e[t]);const _=new t;return _._unitElement=CS(n,i),_._byteOffset=o,_._unitCount=c,_._length=e.length,_}decompress(t){const{storageUnit:e,elementType:i}={storageUnit:7&(n=this._unitElement),elementType:n>>3};var n;const s=TS(i),r=new(wS(e))(t,this._byteOffset,this._unitCount),o=new Array(this._length);for(let t=0;t<this._length;++t)o[t]=s.decompress(r,t);return o}},vS.StorageUnit=SS,vS.ElementType=AS,pS=n_((dS=xS).prototype,"_byteOffset",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fS=n_(dS.prototype,"_unitCount",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gS=n_(dS.prototype,"_unitElement",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CS(SS.Uint8,AS.Scalar)}}),yS=n_(dS.prototype,"_length",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mS=dS))||mS);function TS(t){return ES[t]}function wS(t){switch(t){case SS.Uint8:return Uint8Array;case SS.Uint16:return Uint16Array;case SS.Uint32:return Uint32Array;case SS.Int8:return Int8Array;case SS.Int16:return Int16Array;case SS.Int32:return Int32Array;case SS.Float32:return Float32Array;case SS.Float64:return Float64Array}}const ES={[AS.Scalar]:{requiredUnits:1,compress(t,e,i){t[e]=i},decompress:(t,e)=>t[e]},[AS.Vec2]:{requiredUnits:2,compress(t,e,i){t[2*e]=i.x,t[2*e+1]=i.y},decompress:(t,e)=>new oi(t[2*e],t[2*e+1])},[AS.Vec3]:{requiredUnits:3,compress(t,e,i){t[3*e]=i.x,t[3*e+1]=i.y,t[3*e+2]=i.z},decompress:(t,e)=>new oi(t[3*e],t[3*e+1],t[3*e+2])},[AS.Vec4]:{requiredUnits:4,compress(t,e,i){t[4*e]=i.x,t[4*e+1]=i.y,t[4*e+2]=i.z,t[4*e+3]=i.w},decompress:(t,e)=>new Ii(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])},[AS.Quat]:{requiredUnits:4,compress(t,e,i){t[4*e]=i.x,t[4*e+1]=i.y,t[4*e+2]=i.z,t[4*e+3]=i.w},decompress:(t,e)=>new mi(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])},[AS.Mat4]:{requiredUnits:16,compress(t,e,i){Si.toArray(t,i,16*e)},decompress:(t,e)=>Si.fromArray(new Si,t,16*e)}};var PS,IS;n._decorator=rS,V($u.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),z(Jy.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction(){return this._window}}]);let DS=t("BufferAsset",u_("cc.BufferAsset")((n_((IS=class extends xu{constructor(...t){super(...t),this._buffer=null}get _nativeAsset(){return this._buffer}set _nativeAsset(t){t instanceof ArrayBuffer?this._buffer=t:this._buffer=t.buffer}buffer(){return this._buffer}validate(){return!!this.buffer}}).prototype,"_nativeAsset",[k_],Object.getOwnPropertyDescriptor(IS.prototype,"_nativeAsset"),IS.prototype),PS=IS))||PS);n.BufferAsset=DS;const RS={[Wr.UNORM]:"Uint",[Wr.SNORM]:"Int",[Wr.UINT]:"Uint",[Wr.INT]:"Int",[Wr.UFLOAT]:"Float",[Wr.FLOAT]:"Float",default:"Uint"};function MS(t){return`${RS[t.type]||RS.default}${t.size/t.count*8}`}function BS(t,e,i=jr.R32F,n=0,s=0){const r=Aa[i];s||(s=r.size);const o=`set${MS(r)}`,a=r.size/r.count,l=Math.floor(e.length/r.count),c=Cy.isLittleEndian;for(let i=0;i<l;++i){const l=n+s*i;for(let n=0;n<r.count;++n){const s=l+a*n;t[o](s,e[r.count*i+n],c)}}}function OS(t,e,i=jr.R32F,n=0,s=t.byteLength-n,r=0,o){o||(o=new DataView(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)));const a=Aa[i];r||(r=a.size);const l=`set${MS(a)}`,c=`get${MS(a)}`,h=a.size/a.count,_=Math.floor(s/r),u=Cy.isLittleEndian;for(let i=0;i<_;++i){const s=n+r*i;for(let i=0;i<a.count;++i){const n=s+h*i,r=t[c](n,u);o[l](n,e(r,i,t),u)}}return o}class NS{constructor(t,e,i,n=null,s=null){this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._handle=0,this._attributes=e,this._vertexBuffers=t,this._indexBuffer=n,this._indirectBuffer=s,this._primitiveMode=i,this._iaInfo=new na(e,t,n,s),this._handle=ir.alloc();const r=Wn.alloc();ir.set(this._handle,tr.FLAT_BUFFER_ARRAY,r)}get attributes(){return this._attributes}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get indirectBuffer(){return this._indirectBuffer}get primitiveMode(){return this._primitiveMode}get geometricInfo(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:oi.ZERO,max:oi.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:oi.ZERO,max:oi.ZERO}};const{mesh:t}=this,e=this.subMeshIdx,i=t.readAttribute(e,bo.ATTR_POSITION),n=t.readIndices(e),s=new oi,r=new oi,o=this.attributes.find((t=>t.name===bo.ATTR_POSITION));if(o){const t=Aa[o.format].count;2===t?(s.set(i[0],i[1],0),r.set(i[0],i[1],0)):(s.set(i[0],i[1],i[2]),r.set(i[0],i[1],i[2]));for(let e=0;e<i.length;e+=t)2===t?(s.x=i[e]>s.x?i[e]:s.x,s.y=i[e+1]>s.y?i[e+1]:s.y,r.x=i[e]<r.x?i[e]:r.x,r.y=i[e+1]<r.y?i[e+1]:r.y):(s.x=i[e]>s.x?i[e]:s.x,s.y=i[e+1]>s.y?i[e+1]:s.y,s.z=i[e+2]>s.z?i[e+2]:s.z,r.x=i[e]<r.x?i[e]:r.x,r.y=i[e+1]<r.y?i[e+1]:r.y,r.z=i[e+2]<r.z?i[e+2]:r.z)}return this._geometricInfo={positions:i,indices:n,boundingBox:{max:s,min:r}},this._geometricInfo}get flatBuffers(){return this._flatBuffers}genFlatBuffers(){if(this._flatBuffers.length||!this.mesh||void 0===this.subMeshIdx)return;const{mesh:t}=this;let e=0;const i=t.struct.primitives[this.subMeshIdx],n=ir.get(this._handle,tr.FLAT_BUFFER_ARRAY);i.indexView&&(e=i.indexView.count);for(let s=0;s<i.vertexBundelIndices.length;s++){const r=i.vertexBundelIndices[s],o=t.struct.vertexBundles[r],a=i.indexView?i.indexView.count:o.view.count,l=o.view.stride,c=l*a,h=new Uint8Array(t.data.buffer,o.view.offset,o.view.length),_=Kn.alloc(i.indexView?c:o.view.length),u=Qs.alloc();Qs.set(u,$s.STRIDE,l),Qs.set(u,$s.AMOUNT,a),Qs.set(u,$s.BUFFER,_),Wn.push(n,u);const m=Kn.getBuffer(_),d=new Uint8Array(m);if(!i.indexView){d.set(t.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:l,count:a,buffer:d});continue}const p=t.readIndices(this.subMeshIdx);for(let t=0;t<e;++t){const e=t*l,i=p[t]*l;for(let t=0;t<l;++t)d[e+t]=h[i+t]}this._flatBuffers.push({stride:l,count:a,buffer:d})}}get jointMappedBuffers(){if(this._jointMappedBuffers)return this._jointMappedBuffers;const t=this._jointMappedBuffers=[],e=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;const{struct:i}=this.mesh,s=i.primitives[this.subMeshIdx];if(!i.jointMaps||void 0===s.jointMapIndex||!i.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;let r,o;const{device:a}=n.director.root;for(let n=0;n<s.vertexBundelIndices.length;n++){const l=i.vertexBundles[s.vertexBundelIndices[n]];o=0,r=jr.UNKNOWN;for(let t=0;t<l.attributes.length;t++){const e=l.attributes[t];if(e.name===bo.ATTR_JOINTS){r=e.format;break}o+=Aa[e.format].size}if(r){const c=new Uint8Array(this.mesh.data.buffer,l.view.offset,l.view.length),h=new DataView(c.slice().buffer),_=i.jointMaps[s.jointMapIndex];OS(h,(t=>_.indexOf(t)),r,o,l.view.length,l.view.stride,h);const u=a.createBuffer(new zo(Xr.VERTEX|Xr.TRANSFER_DST,Jr.DEVICE,l.view.length,l.view.stride));u.update(h.buffer),t.push(u),e.push(n)}else t.push(this.vertexBuffers[s.vertexBundelIndices[n]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(a)),t}get iaInfo(){return this._iaInfo}get handle(){return this._handle}destroy(){for(let t=0;t<this.vertexBuffers.length;t++)this.vertexBuffers[t].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(let t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null),this._handle&&(Nn(ir.get(this._handle,tr.FLAT_BUFFER_ARRAY),Wn,Qs),ir.free(this._handle),this._handle=0)}enableVertexIdChannel(t){if(this._vertexIdChannel)return;const e=this.vertexBuffers.length,i=this.attributes.length,n=this._allocVertexIdBuffer(t);this._vertexBuffers.push(n),this._attributes.push(new rl("a_vertexId",jr.R32F,!1,e)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:e,index:i}}_allocVertexIdBuffer(t){const e=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,i=new Float32Array(e);for(let t=0;t<e;++t)i[t]=t+.5;const n=t.createBuffer(new zo(Xr.VERTEX|Xr.TRANSFER_DST,Jr.DEVICE,i.byteLength,i.BYTES_PER_ELEMENT));return n.update(i),n}}t("RenderingSubMesh",NS);const LS=new Array(16);let FS=null,zS=new Ti;const VS=[_p.TOUCH_START.toString(),_p.TOUCH_MOVE.toString(),_p.TOUCH_END.toString(),_p.TOUCH_CANCEL.toString()],US=[_p.MOUSE_DOWN.toString(),_p.MOUSE_ENTER.toString(),_p.MOUSE_MOVE.toString(),_p.MOUSE_LEAVE.toString(),_p.MOUSE_UP.toString(),_p.MOUSE_WHEEL.toString()];function GS(t,e){const i=this.owner;return!(!i||!i._uiProps.uiTransformComp||(t.getUILocation(zS),!i._uiProps.uiTransformComp.isHit(zS,this)||(e.type=_p.TOUCH_START.toString(),e.touch=t,e.bubbles=!0,i.dispatchEvent(e),0)))}function HS(t,e){const i=this.owner;return!(!i||!i._uiProps.uiTransformComp||(e.type=_p.TOUCH_MOVE.toString(),e.touch=t,e.bubbles=!0,i.dispatchEvent(e),0))}function kS(t,e){const i=this.owner;i&&i._uiProps.uiTransformComp&&(t.getUILocation(zS),i._uiProps.uiTransformComp.isHit(zS,this)?e.type=_p.TOUCH_END.toString():e.type=_p.TOUCH_CANCEL.toString(),e.touch=t,e.bubbles=!0,i.dispatchEvent(e))}function jS(t,e){const i=this.owner;i&&i._uiProps.uiTransformComp&&(e.type=_p.TOUCH_CANCEL.toString(),e.touch=t,e.bubbles=!0,i.dispatchEvent(e))}function WS(t){const e=this.owner;e&&e._uiProps.uiTransformComp&&(zS=t.getUILocation(),e._uiProps.uiTransformComp.isHit(zS,this)&&(t.type=_p.MOUSE_DOWN.toString(),t.bubbles=!0,e.dispatchEvent(t)))}function qS(t){const e=this.owner;if(e&&e._uiProps.uiTransformComp){if(zS=t.getUILocation(),e._uiProps.uiTransformComp.isHit(zS,this))this._previousIn||(FS&&FS.eventProcessor.mouseListener&&(t.type=_p.MOUSE_LEAVE,FS.dispatchEvent(t),FS.eventProcessor.mouseListener&&(FS.eventProcessor.mouseListener._previousIn=!1)),FS=e,t.type=_p.MOUSE_ENTER.toString(),e.dispatchEvent(t),this._previousIn=!0),t.type=_p.MOUSE_MOVE.toString(),t.bubbles=!0,e.dispatchEvent(t);else{if(!this._previousIn)return;t.type=_p.MOUSE_LEAVE.toString(),e.dispatchEvent(t),this._previousIn=!1,FS=null}t.propagationStopped=!0}}function XS(t){const e=this.owner;e&&e._uiProps.uiTransformComp&&(zS=t.getUILocation(),e._uiProps.uiTransformComp.isHit(zS,this)&&(t.type=_p.MOUSE_UP.toString(),t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0))}function YS(t){const e=this.owner;e&&e._uiProps.uiTransformComp&&(zS=t.getUILocation(),e._uiProps.uiTransformComp.isHit(zS,this)&&(t.type=_p.MOUSE_WHEEL.toString(),t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0))}function KS(t,e){if(e){let i=0,n=[];for(let s=t;s&&uf.isNode(s);s=s.parent,++i){const t=s.getComponent(e);if(t){const e={index:i,comp:t};n?n.push(e):n=[e]}}return n.length>0?n:null}return null}function JS(t,e){if(!t._persistNode){if(t.eventProcessor.bubblingTargets)for(let i=0;i<e.length;++i)if(t.eventProcessor.bubblingTargets.hasEventListener(e[i]))return!0;if(t.eventProcessor.capturingTargets)for(let i=0;i<e.length;++i)if(t.eventProcessor.capturingTargets.hasEventListener(e[i]))return!0;return!1}return!0}class $S{get node(){return this._node}constructor(t){this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=t}reattach(){let t;this.node.walk((e=>{t||(t=KS(e,$S._comp)),e.eventProcessor.touchListener&&(e.eventProcessor.touchListener.mask=t),e.eventProcessor.mouseListener&&(e.eventProcessor.mouseListener.mask=t)}))}destroy(){FS===this._node&&(FS=null),(this.touchListener||this.mouseListener)&&(Sp.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null)),this.capturingTargets&&this.capturingTargets.clear(),this.bubblingTargets&&this.bubblingTargets.clear()}on(t,e,i,n){return this._checknSetupSysEvent(t)?this._onDispatch(t,e,i,n):(this.bubblingTargets||(this.bubblingTargets=new Ji),this.bubblingTargets.on(t,e,i))}once(t,e,i,n){let s;s=this._checknSetupSysEvent(t)&&n?this.capturingTargets=this.capturingTargets||new Ji:this.bubblingTargets=this.bubblingTargets||new Ji,s.on(t,e,i,!0),s.on(t,(()=>{this.off(t,e,i)}),void 0,!0)}off(t,e,i,n){const s=-1!==VS.indexOf(t),r=!s&&-1!==US.indexOf(t);s||r?(this._offDispatch(t,e,i,n),s?this.touchListener&&!JS(this._node,VS)&&(Sp.removeListener(this.touchListener),this.touchListener=null):r&&this.mouseListener&&!JS(this._node,US)&&(Sp.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(t,e,i)}emit(t,e,i,n,s,r){this.bubblingTargets&&this.bubblingTargets.emit(t,e,i,n,s,r)}dispatchEvent(t){!function(t,e){let i,n=0;for(e.target=t,LS.length=0,t.eventProcessor.getCapturingTargets(e.type,LS),e.eventPhase=1,n=LS.length-1;n>=0;--n)if(i=LS[n],i.eventProcessor.capturingTargets&&(e.currentTarget=i,i.eventProcessor.capturingTargets.emit(e.type,e,LS),e.propagationStopped))return void(LS.length=0);if(LS.length=0,e.eventPhase=2,e.currentTarget=t,t.eventProcessor.capturingTargets&&t.eventProcessor.capturingTargets.emit(e.type,e),!e.propagationImmediateStopped&&t.eventProcessor.bubblingTargets&&t.eventProcessor.bubblingTargets.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(t.eventProcessor.getBubblingTargets(e.type,LS),e.eventPhase=3,n=0;n<LS.length;++n)if(i=LS[n],i.eventProcessor.bubblingTargets&&(e.currentTarget=i,i.eventProcessor.bubblingTargets.emit(e.type,e),e.propagationStopped))return void(LS.length=0);LS.length=0}(this._node,t),LS.length=0}hasEventListener(t,e,i){let n=!1;return this.bubblingTargets&&(n=this.bubblingTargets.hasEventListener(t,e,i)),!n&&this.capturingTargets&&(n=this.capturingTargets.hasEventListener(t,e,i)),n}targetOff(t){this.capturingTargets&&this.capturingTargets.removeAll(t),this.bubblingTargets&&this.bubblingTargets.removeAll(t),this.touchListener&&!JS(this.node,VS)&&(Sp.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!JS(this.node,US)&&(Sp.removeListener(this.mouseListener),this.mouseListener=null)}getCapturingTargets(t,e){let i=this._node.parent;for(;i;)i.eventProcessor.capturingTargets&&i.eventProcessor.capturingTargets.hasEventListener(t)&&e.push(i),i=i.parent}getBubblingTargets(t,e){let i=this._node.parent;for(;i;)i.eventProcessor.bubblingTargets&&i.eventProcessor.bubblingTargets.hasEventListener(t)&&e.push(i),i=i.parent}_checknSetupSysEvent(t){let e=!1,i=!1;return-1!==VS.indexOf(t)?(this.touchListener||(this.touchListener=n.EventListener.create({event:n.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:KS(this._node,$S._comp),onTouchBegan:GS,onTouchMoved:HS,onTouchEnded:kS,onTouchCancelled:jS}),Sp.addListener(this.touchListener,this._node),e=!0),i=!0):-1!==US.indexOf(t)&&(this.mouseListener||(this.mouseListener=n.EventListener.create({event:n.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:KS(this._node,$S._comp),onMouseDown:WS,onMouseMove:qS,onMouseUp:XS,onMouseScroll:YS}),Sp.addListener(this.mouseListener,this._node),e=!0),i=!0),e&&!this._node.activeInHierarchy&&n.director.getScheduler().schedule((()=>{this._node.activeInHierarchy||Sp.pauseTarget(this._node)}),this._node,0,0,0,!1),i}_onDispatch(t,e,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,!e)return void T(6800);let s=null;return s=n?this.capturingTargets=this.capturingTargets||new Ji:this.bubblingTargets=this.bubblingTargets||new Ji,s.hasEventListener(t,e,i)||s.on(t,e,i),e}_offDispatch(t,e,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,e){const s=n?this.capturingTargets:this.bubblingTargets;s&&s.off(t,e,i)}else this.capturingTargets&&this.capturingTargets.removeAll(t),this.bubblingTargets&&this.bubblingTargets.removeAll(t)}}var ZS;$S._comp=null,n.NodeEventProcessor=$S,z(Lp.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter(){return this.children.length}}]),z(uf.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.width},customSetter(t){this._uiProps.uiTransformComp.width=t}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.height},customSetter(t){this._uiProps.uiTransformComp.height=t}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.anchorX},customSetter(t){this._uiProps.uiTransformComp.anchorX=t}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.anchorY},customSetter(t){this._uiProps.uiTransformComp.anchorY=t}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction(t){return t||(t=new Ti),t.set(this._uiProps.uiTransformComp.anchorPoint),t}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction(t,e){this._uiProps.uiTransformComp.setAnchorPoint(t,e)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction(t){return t||(t=new Mi),t.set(this._uiProps.uiTransformComp.contentSize),t}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction(t,e){"number"==typeof t?this._uiProps.uiTransformComp.setContentSize(t,e):this._uiProps.uiTransformComp.setContentSize(t)}}]),V(uf.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),V(Ec,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),z(Ec,"Layers",[{name:"Default",newName:"DEFAULT",target:Ec.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Ec.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Ec.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Ec.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Ec.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Ec.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Ec.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Ec.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Ec,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Ec,targetName:"Layers"}]),V(Ec.Enum,"Layers.Enum",[{name:"ALWAYS"}]),V(Ec.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);const QS=Gi.Flags.HideInHierarchy,tA=Gi.Flags.DontSave;let eA=t("PrivateNode",u_("cc.PrivateNode")(ZS=class extends uf{constructor(t){super(t),C(12003,this.name),this.hideFlags|=tA|QS}})||ZS);var iA,nA,sA,rA,oA,aA,lA,cA,hA,_A,uA,mA,dA,pA,fA,gA,yA,vA,xA,SA,AA,CA,bA,TA,wA,EA,PA,IA,DA,RA,MA,BA,OA,NA,LA,FA,zA,VA,UA,GA,HA,kA,jA,WA,qA,XA,YA,KA,JA,$A,ZA,QA,tC,eC,iC,nC,sC,rC,oC,aC,lC,cC,hC,_C,uC,mC,dC,pC,fC,gC,yC,vC,xC,SC,AC,CC,bC,TC,wC,EC,PC,IC,DC,RC,MC,BC,OC,NC,LC,FC,zC,VC,UC,GC,HC,kC,jC,WC,qC,XC,YC,KC,JC,$C,ZC,QC,tb,eb,ib,nb,sb,rb,ob,ab,lb;n.PrivateNode=eA;const cb=new oi(0,1,0),hb=new oi,_b=new mi;let ub=(iA=u_("cc.AmbientInfo"),nA=H_(me),iA((oA=n_((rA=class{constructor(){i_(this,"_skyColor",oA,this),i_(this,"_skyIllum",aA,this),i_(this,"_groundAlbedo",lA,this),this._resource=null}set skyColor(t){this._skyColor.set(t),this._resource&&(this._resource.skyColor=this._skyColor)}get skyColor(){return this._skyColor}set skyIllum(t){this._skyIllum=t,this._resource&&(this._resource.skyIllum=this.skyIllum)}get skyIllum(){return this._skyIllum}set groundAlbedo(t){this._groundAlbedo.set(t),this._resource&&(this._resource.groundAlbedo=this._groundAlbedo)}get groundAlbedo(){return this._groundAlbedo}activate(t){this._resource=t,this._resource.initialize(this)}}).prototype,"_skyColor",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new si(51,128,204,1)}}),aA=n_(rA.prototype,"_skyIllum",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pr.SKY_ILLUM}}),lA=n_(rA.prototype,"_groundAlbedo",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new si(51,51,51,255)}}),n_(rA.prototype,"skyColor",[w_],Object.getOwnPropertyDescriptor(rA.prototype,"skyColor"),rA.prototype),n_(rA.prototype,"skyIllum",[w_,nA],Object.getOwnPropertyDescriptor(rA.prototype,"skyIllum"),rA.prototype),n_(rA.prototype,"groundAlbedo",[w_],Object.getOwnPropertyDescriptor(rA.prototype,"groundAlbedo"),rA.prototype),sA=rA))||sA);n.AmbientInfo=ub;let mb=(cA=u_("cc.SkyboxInfo"),hA=H_(rd),_A=H_(rd),cA((dA=n_((mA=class{constructor(){i_(this,"_envmap",dA,this),i_(this,"_isRGBE",pA,this),i_(this,"_enabled",fA,this),i_(this,"_useIBL",gA,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=this._enabled))}get enabled(){return this._enabled}set useIBL(t){this._useIBL=t,this._resource&&(this._resource.useIBL=this._useIBL)}get useIBL(){return this._useIBL}set envmap(t){this._envmap=t,this._resource&&(this._resource.envmap=this._envmap)}get envmap(){return this._envmap}set isRGBE(t){this._isRGBE=t,this._resource&&(this._resource.isRGBE=this._isRGBE)}get isRGBE(){return this._isRGBE}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}}).prototype,"_envmap",[hA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pA=n_(mA.prototype,"_isRGBE",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fA=n_(mA.prototype,"_enabled",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gA=n_(mA.prototype,"_useIBL",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),n_(mA.prototype,"enabled",[w_],Object.getOwnPropertyDescriptor(mA.prototype,"enabled"),mA.prototype),n_(mA.prototype,"useIBL",[w_],Object.getOwnPropertyDescriptor(mA.prototype,"useIBL"),mA.prototype),n_(mA.prototype,"envmap",[w_,_A],Object.getOwnPropertyDescriptor(mA.prototype,"envmap"),mA.prototype),n_(mA.prototype,"isRGBE",[w_],Object.getOwnPropertyDescriptor(mA.prototype,"isRGBE"),mA.prototype),uA=mA))||uA);n.SkyboxInfo=mb;let db=(yA=u_("cc.FogInfo"),vA=H_(by),xA=E_(),SA=H_(me),AA=D_(),CA=B_(),bA=N_(),TA=E_(),wA=H_(me),EA=B_(),PA=N_(),IA=E_(),DA=H_(me),RA=B_(),MA=N_(),BA=E_(),OA=H_(me),NA=R_(),LA=B_(),FA=N_(),zA=E_(),VA=H_(me),UA=B_(),GA=N_(),HA=E_(),kA=H_(me),jA=B_(),WA=N_(),yA((sC=nC=class{constructor(){i_(this,"_type",YA,this),i_(this,"_fogColor",KA,this),i_(this,"_enabled",JA,this),i_(this,"_fogDensity",$A,this),i_(this,"_fogStart",ZA,this),i_(this,"_fogEnd",QA,this),i_(this,"_fogAtten",tC,this),i_(this,"_fogTop",eC,this),i_(this,"_fogRange",iC,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}get enabled(){return this._enabled}set fogColor(t){this._fogColor.set(t),this._resource&&(this._resource.fogColor=this._fogColor)}get fogColor(){return this._fogColor}get type(){return this._type}set type(t){this._type=t,this._resource&&(this._resource.type=t)}get fogDensity(){return this._fogDensity}set fogDensity(t){this._fogDensity=t,this._resource&&(this._resource.fogDensity=t)}get fogStart(){return this._fogStart}set fogStart(t){this._fogStart=t,this._resource&&(this._resource.fogStart=t)}get fogEnd(){return this._fogEnd}set fogEnd(t){this._fogEnd=t,this._resource&&(this._resource.fogEnd=t)}get fogAtten(){return this._fogAtten}set fogAtten(t){this._fogAtten=t,this._resource&&(this._resource.fogAtten=t)}get fogTop(){return this._fogTop}set fogTop(t){this._fogTop=t,this._resource&&(this._resource.fogTop=t)}get fogRange(){return this._fogRange}set fogRange(t){this._fogRange=t,this._resource&&(this._resource.fogRange=t)}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}},nC.FogType=by,YA=n_((XA=sC).prototype,"_type",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return by.LINEAR}}),KA=n_(XA.prototype,"_fogColor",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new si("#C8C8C8")}}),JA=n_(XA.prototype,"_enabled",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$A=n_(XA.prototype,"_fogDensity",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),ZA=n_(XA.prototype,"_fogStart",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),QA=n_(XA.prototype,"_fogEnd",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),tC=n_(XA.prototype,"_fogAtten",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),eC=n_(XA.prototype,"_fogTop",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),iC=n_(XA.prototype,"_fogRange",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),n_(XA.prototype,"enabled",[w_],Object.getOwnPropertyDescriptor(XA.prototype,"enabled"),XA.prototype),n_(XA.prototype,"fogColor",[w_],Object.getOwnPropertyDescriptor(XA.prototype,"fogColor"),XA.prototype),n_(XA.prototype,"type",[w_,vA],Object.getOwnPropertyDescriptor(XA.prototype,"type"),XA.prototype),n_(XA.prototype,"fogDensity",[xA,SA,AA,CA,O_,bA],Object.getOwnPropertyDescriptor(XA.prototype,"fogDensity"),XA.prototype),n_(XA.prototype,"fogStart",[TA,wA,EA,PA],Object.getOwnPropertyDescriptor(XA.prototype,"fogStart"),XA.prototype),n_(XA.prototype,"fogEnd",[IA,DA,RA,MA],Object.getOwnPropertyDescriptor(XA.prototype,"fogEnd"),XA.prototype),n_(XA.prototype,"fogAtten",[BA,OA,NA,LA,FA],Object.getOwnPropertyDescriptor(XA.prototype,"fogAtten"),XA.prototype),n_(XA.prototype,"fogTop",[zA,VA,UA,GA],Object.getOwnPropertyDescriptor(XA.prototype,"fogTop"),XA.prototype),n_(XA.prototype,"fogRange",[HA,kA,jA,WA],Object.getOwnPropertyDescriptor(XA.prototype,"fogRange"),XA.prototype),qA=XA))||qA),pb=(rC=u_("cc.ShadowsInfo"),oC=H_(uv),aC=E_(),lC=H_(me),cC=E_(),hC=H_(mv),_C=E_(),uC=H_(ue),mC=E_(),dC=H_(me),pC=E_(),fC=H_(de),gC=E_(),yC=H_(de),vC=E_(),xC=H_(de),SC=E_(),AC=H_(me),CC=E_(),bC=H_(de),TC=E_(),wC=H_(me),EC=E_(),PC=H_(me),IC=E_(),DC=H_(me),RC=E_(),MC=E_(),BC=H_(me),OC=E_(),rC((FC=n_((LC=class{constructor(){i_(this,"_type",FC,this),i_(this,"_enabled",zC,this),i_(this,"_normal",VC,this),i_(this,"_distance",UC,this),i_(this,"_shadowColor",GC,this),i_(this,"_autoAdapt",HC,this),i_(this,"_pcf",kC,this),i_(this,"_bias",jC,this),i_(this,"_packing",WC,this),i_(this,"_linear",qC,this),i_(this,"_selfShadow",XC,this),i_(this,"_normalBias",YC,this),i_(this,"_near",KC,this),i_(this,"_far",JC,this),i_(this,"_aspect",$C,this),i_(this,"_orthoSize",ZC,this),i_(this,"_maxReceived",QC,this),i_(this,"_size",tb,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}get enabled(){return this._enabled}set type(t){this._type=t,this._resource&&(this._resource.type=t)}get type(){return this._type}set shadowColor(t){this._shadowColor.set(t),this._resource&&(this._resource.shadowColor=t)}get shadowColor(){return this._shadowColor}set normal(t){oi.copy(this._normal,t),this._resource&&(this._resource.normal=t)}get normal(){return this._normal}set distance(t){this._distance=t,this._resource&&(this._resource.distance=t)}get distance(){return this._distance}set pcf(t){this._pcf=t,this._resource&&(this._resource.pcf=t)}get pcf(){return this._pcf}set maxReceived(t){this._maxReceived=t,this._resource&&(this._resource.maxReceived=t)}get maxReceived(){return this._maxReceived}set bias(t){this._bias=t,this._resource&&(this._resource.bias=t)}get bias(){return this._bias}set packing(t){this._packing=t,t&&(this._linear=!this._linear&&this._linear,this._resource&&(this._resource.linear=this._linear)),this._resource&&(this._resource.packing=t,this._resource.shadowMapDirty=!0)}get packing(){return this._packing}set linear(t){this._linear=t,t&&(this._packing=!this._packing&&this._packing,this._resource&&(this._resource.packing=this._packing)),this._resource&&(this._resource.linear=t)}get linear(){return this._linear}set selfShadow(t){this._selfShadow=t,this._resource&&(this._resource.selfShadow=t)}get selfShadow(){return this._selfShadow}set normalBias(t){this._normalBias=t,this._resource&&(this._resource.normalBias=t)}get normalBias(){return this._normalBias}set autoAdapt(t){this._autoAdapt=t,this._resource&&(this._resource.autoAdapt=t)}get autoAdapt(){return this._autoAdapt}set near(t){this._near=t,this._resource&&(this._resource.near=t)}get near(){return this._near}set far(t){this._far=t,this._resource&&(this._resource.far=t)}get far(){return this._far}set orthoSize(t){this._orthoSize=t,this._resource&&(this._resource.orthoSize=t)}get orthoSize(){return this._orthoSize}set shadowMapSize(t){this._size.set(t),this._resource&&(this._resource.size=t,this._resource.shadowMapDirty=!0)}get shadowMapSize(){return this._size}set aspect(t){this._aspect=t,this._resource&&(this._resource.aspect=t)}get aspect(){return this._aspect}setPlaneFromNode(t){t.getWorldRotation(_b),this.normal=oi.transformQuat(hb,cb,_b),t.getWorldPosition(hb),this.distance=oi.dot(this._normal,hb)}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}}).prototype,"_type",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uv.Planar}}),zC=n_(LC.prototype,"_enabled",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),VC=n_(LC.prototype,"_normal",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oi(0,1,0)}}),UC=n_(LC.prototype,"_distance",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GC=n_(LC.prototype,"_shadowColor",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new si(0,0,0,76)}}),HC=n_(LC.prototype,"_autoAdapt",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kC=n_(LC.prototype,"_pcf",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mv.HARD}}),jC=n_(LC.prototype,"_bias",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),WC=n_(LC.prototype,"_packing",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qC=n_(LC.prototype,"_linear",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),XC=n_(LC.prototype,"_selfShadow",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),YC=n_(LC.prototype,"_normalBias",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KC=n_(LC.prototype,"_near",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),JC=n_(LC.prototype,"_far",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),$C=n_(LC.prototype,"_aspect",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ZC=n_(LC.prototype,"_orthoSize",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),QC=n_(LC.prototype,"_maxReceived",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),tb=n_(LC.prototype,"_size",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti(512,512)}}),n_(LC.prototype,"enabled",[w_],Object.getOwnPropertyDescriptor(LC.prototype,"enabled"),LC.prototype),n_(LC.prototype,"type",[w_,oC],Object.getOwnPropertyDescriptor(LC.prototype,"type"),LC.prototype),n_(LC.prototype,"shadowColor",[w_],Object.getOwnPropertyDescriptor(LC.prototype,"shadowColor"),LC.prototype),n_(LC.prototype,"normal",[aC],Object.getOwnPropertyDescriptor(LC.prototype,"normal"),LC.prototype),n_(LC.prototype,"distance",[lC,cC],Object.getOwnPropertyDescriptor(LC.prototype,"distance"),LC.prototype),n_(LC.prototype,"pcf",[hC,_C],Object.getOwnPropertyDescriptor(LC.prototype,"pcf"),LC.prototype),n_(LC.prototype,"maxReceived",[uC,mC],Object.getOwnPropertyDescriptor(LC.prototype,"maxReceived"),LC.prototype),n_(LC.prototype,"bias",[dC,pC],Object.getOwnPropertyDescriptor(LC.prototype,"bias"),LC.prototype),n_(LC.prototype,"packing",[fC,gC],Object.getOwnPropertyDescriptor(LC.prototype,"packing"),LC.prototype),n_(LC.prototype,"linear",[yC,vC],Object.getOwnPropertyDescriptor(LC.prototype,"linear"),LC.prototype),n_(LC.prototype,"selfShadow",[xC,SC],Object.getOwnPropertyDescriptor(LC.prototype,"selfShadow"),LC.prototype),n_(LC.prototype,"normalBias",[AC,CC],Object.getOwnPropertyDescriptor(LC.prototype,"normalBias"),LC.prototype),n_(LC.prototype,"autoAdapt",[bC,TC],Object.getOwnPropertyDescriptor(LC.prototype,"autoAdapt"),LC.prototype),n_(LC.prototype,"near",[wC,EC],Object.getOwnPropertyDescriptor(LC.prototype,"near"),LC.prototype),n_(LC.prototype,"far",[PC,IC],Object.getOwnPropertyDescriptor(LC.prototype,"far"),LC.prototype),n_(LC.prototype,"orthoSize",[DC,RC],Object.getOwnPropertyDescriptor(LC.prototype,"orthoSize"),LC.prototype),n_(LC.prototype,"shadowMapSize",[MC],Object.getOwnPropertyDescriptor(LC.prototype,"shadowMapSize"),LC.prototype),n_(LC.prototype,"aspect",[BC,OC],Object.getOwnPropertyDescriptor(LC.prototype,"aspect"),LC.prototype),NC=LC))||NC);n.ShadowsInfo=pb;let fb=(eb=u_("cc.SceneGlobals"),ib=H_(mb),eb((rb=n_((sb=class{constructor(){i_(this,"ambient",rb,this),i_(this,"shadows",ob,this),i_(this,"_skybox",ab,this),i_(this,"fog",lb,this)}get skybox(){return this._skybox}set skybox(t){this._skybox=t}activate(){const t=n.director.root.pipeline.pipelineSceneData;this.ambient.activate(t.ambient),this.skybox.activate(t.skybox),this.shadows.activate(t.shadows),this.fog.activate(t.fog)}}).prototype,"ambient",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ub}}),ob=n_(sb.prototype,"shadows",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new pb}}),ab=n_(sb.prototype,"_skybox",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mb}}),lb=n_(sb.prototype,"fog",[w_,g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new db}}),n_(sb.prototype,"skybox",[w_,ib],Object.getOwnPropertyDescriptor(sb.prototype,"skybox"),sb.prototype),nb=sb))||nb);var gb,yb,vb,xb;n.SceneGlobals=fb;let Sb=t("Scene",u_("cc.Scene")((n_((yb=class extends Lp{get renderScene(){return this._renderScene}get globals(){return this._globals}_updateScene(){this._scene=this}constructor(t){super(t),i_(this,"autoReleaseAssets",vb,this),i_(this,"_globals",xb,this),this._renderScene=null,this.dependAssets=null,this._inited=void 0,this._prefabSyncedInLiveReload=!1,this._pos=oi.ZERO,this._rot=mi.IDENTITY,this._scale=oi.ONE,this._mat=Si.IDENTITY,this._dirtyFlags=0,this._activeInHierarchy=!1,n.director&&n.director.root&&(this._renderScene=n.director.root.createScene({})),this._inited=!n.game||!n.game._isCloning}destroy(){const t=Gi.prototype.destroy.call(this);if(t){const t=this._children;for(let e=0;e<t.length;++e)t[e].active=!1}return n.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,t}addComponent(){throw new Error(I(3822))}_onHierarchyChanged(){}_onBatchCreated(t){super._onBatchCreated(t);const e=this._children.length;for(let i=0;i<e;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t);jp(this)}getPosition(t){return oi.copy(t||new oi,oi.ZERO)}getRotation(t){return mi.copy(t||new mi,mi.IDENTITY)}getScale(t){return oi.copy(t||new oi,oi.ONE)}getWorldPosition(t){return oi.copy(t||new oi,oi.ZERO)}getWorldRotation(t){return mi.copy(t||new mi,mi.IDENTITY)}getWorldScale(t){return oi.copy(t||new oi,oi.ONE)}getWorldMatrix(t){return Si.copy(t||new Si,Si.IDENTITY)}getWorldRS(t){return Si.copy(t||new Si,Si.IDENTITY)}getWorldRT(t){return Si.copy(t||new Si,Si.IDENTITY)}get position(){return oi.ZERO}get worldPosition(){return oi.ZERO}get rotation(){return mi.IDENTITY}get worldRotation(){return mi.IDENTITY}get scale(){return oi.ONE}get worldScale(){return oi.ONE}get eulerAngles(){return oi.ZERO}get worldMatrix(){return Si.IDENTITY}updateWorldTransform(){}_instantiate(){}_load(){this._inited||(this._onBatchCreated(false),this._inited=!0),this.walk(Lp._setScene)}_activate(t){t=!1!==t,n.director._nodeActivator.activateNode(this,t),this._globals.activate()}}).prototype,"globals",[w_],Object.getOwnPropertyDescriptor(yb.prototype,"globals"),yb.prototype),vb=n_(yb.prototype,"autoReleaseAssets",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xb=n_(yb.prototype,"_globals",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fb}}),gb=yb))||gb);function Ab(t,e){if(!e){const t=n.director.getScene();if(!t)return null;e=t}return e.getChildByPath(t)}n.Scene=Sb,n.find=Ab;const Cb=zt.fastRemoveAt,bb=Gi.Flags.IsStartCalled,Tb=Gi.Flags.IsOnEnableCalled;function wb(t,e){const i=e.constructor._executionOrder,n=e._id;let s=0;for(let e=t.length-1,r=e>>>1;s<=e;r=s+e>>>1){const o=t[r],a=o.constructor._executionOrder;if(a>i)e=r-1;else if(a<i)s=r+1;else{const t=o._id;if(t>n)e=r-1;else{if(!(t<n))return r;s=r+1}}}return~s}function Eb(t,e){const i=t.array;let n=t.i+1;for(;n<i.length;){const s=i[n];s.node._activeInHierarchy?++n:(t.removeAt(n),e&&(s._objFlags&=~e))}}Gi.Flags.IsEditorOnEnableCalled;class Pb{constructor(t){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;const e=X;this._zero=new e([]),this._neg=new e([]),this._pos=new e([]),this._invoke=t}}function Ib(t,e){return t.constructor._executionOrder-e.constructor._executionOrder}Pb.stableRemoveInactive=Eb;class Db extends Pb{add(t){const e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).array.push(t)}remove(t){const e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).fastRemove(t)}cancelInactive(t){Eb(this._zero,t),Eb(this._neg,t),Eb(this._pos,t)}invoke(){const t=this._neg;t.array.length>0&&(t.array.sort(Ib),this._invoke(t),t.array.length=0),this._invoke(this._zero),this._zero.array.length=0;const e=this._pos;e.array.length>0&&(e.array.sort(Ib),this._invoke(e),e.array.length=0)}}class Rb extends Pb{add(t){const e=t.constructor._executionOrder;if(0===e)this._zero.array.push(t);else{const i=e<0?this._neg.array:this._pos.array,n=wb(i,t);n<0&&i.splice(~n,0,t)}}remove(t){const e=t.constructor._executionOrder;if(0===e)this._zero.fastRemove(t);else{const i=e<0?this._neg:this._pos,n=wb(i.array,t);n>=0&&i.removeAt(n)}}invoke(t){this._neg.array.length>0&&this._invoke(this._neg,t),this._invoke(this._zero,t),this._pos.array.length>0&&this._invoke(this._pos,t)}}function Mb(t,e,i){const s=`var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];${t}}`,r=e?Function("it","dt",s):Function("it",s);return function(t,e,i){return(s,r)=>{try{e(s,r)}catch(e){n._throw(e);const o=s.array;for(i&&(o[s.i]._objFlags|=i),++s.i;s.i<o.length;++s.i)try{t(o[s.i],r)}catch(t){n._throw(t),i&&(o[s.i]._objFlags|=i)}}}}(Function("c","dt",t),r,i)}const Bb=Mb(`c.start();c._objFlags|=${bb}`,!1,bb),Ob=Mb("c.update(dt)",!0),Nb=Mb("c.lateUpdate(dt)",!0),Lb=t=>{const e=n.director._compScheduler,i=t.array;for(t.i=0;t.i<i.length;++t.i){const n=i[t.i];n._enabled&&(n.onEnable(),!n.node._activeInHierarchy||e._onEnabled(n))}};class Fb{constructor(){this._deferredComps=[],this.unscheduleAll()}unscheduleAll(){this.startInvoker=new Db(Bb),this.updateInvoker=new Rb(Ob),this.lateUpdateInvoker=new Rb(Nb),this._updating=!1}_onEnabled(t){n.director.getScheduler().resumeTarget(t),t._objFlags|=Tb,this._updating?this._deferredComps.push(t):this._scheduleImmediate(t)}_onDisabled(t){n.director.getScheduler().pauseTarget(t),t._objFlags&=~Tb;const e=this._deferredComps.indexOf(t);e>=0?Cb(this._deferredComps,e):(!t.start||t._objFlags&bb||this.startInvoker.remove(t),t.update&&this.updateInvoker.remove(t),t.lateUpdate&&this.lateUpdateInvoker.remove(t))}enableComp(t,e){if(!(t._objFlags&Tb)){if(t.onEnable){if(e)return void e.add(t);if(t.onEnable(),!t.node._activeInHierarchy)return}this._onEnabled(t)}}disableComp(t){t._objFlags&Tb&&(t.onDisable&&t.onDisable(),this._onDisabled(t))}startPhase(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()}updatePhase(t){this.updateInvoker.invoke(t)}lateUpdatePhase(t){this.lateUpdateInvoker.invoke(t),this._updating=!1,this._startForNewComps()}_startForNewComps(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())}_scheduleImmediate(t){"function"!=typeof t.start||t._objFlags&bb||this.startInvoker.add(t),"function"==typeof t.update&&this.updateInvoker.add(t),"function"==typeof t.lateUpdate&&this.lateUpdateInvoker.add(t)}_deferredSchedule(){const t=this._deferredComps;for(let e=0,i=t.length;e<i;e++)this._scheduleImmediate(t[e]);t.length=0}}const zb=Gi.Flags.IsPreloadStarted,Vb=Gi.Flags.IsOnLoadStarted,Ub=Gi.Flags.IsOnLoadCalled,Gb=Gi.Flags.Deactivating;class Hb extends Pb{add(t){this._zero.array.push(t)}remove(t){this._zero.fastRemove(t)}cancelInactive(t){Pb.stableRemoveInactive(this._zero,t)}invoke(){this._invoke(this._zero),this._zero.array.length=0}}const kb=Mb("c.__preload();"),jb=Mb(`c.onLoad();c._objFlags|=${Ub}`,!1,Ub),Wb=new Ft(4);function qb(t,e,i){e?t._removeComponent(e):zt.removeAt(t._components,i)}Wb.get=function(){const t=this._get()||{preload:new Hb(kb),onLoad:new Db(jb),onEnable:new Db(Lb)};t.preload._zero.i=-1;let e=t.onLoad;return e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,e=t.onEnable,e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,t};class Xb{constructor(){this.resetComp=void 0,this.reset()}reset(){this._activatingStack=[]}activateNode(t,e){if(e){const e=Wb.get();this._activatingStack.push(e),this._activateNodeRecursively(t,e.preload,e.onLoad,e.onEnable),e.preload.invoke(),e.onLoad.invoke(),e.onEnable.invoke(),this._activatingStack.pop(),Wb.put(e)}else{this._deactivateNodeRecursively(t);const e=this._activatingStack;for(const t of e)t.preload.cancelInactive(zb),t.onLoad.cancelInactive(Vb),t.onEnable.cancelInactive()}t.emit("active-in-hierarchy-changed",t)}activateComp(t,e,i,s){if(ki(t,!0)&&(t._objFlags&zb||(t._objFlags|=zb,t.__preload&&(e?e.add(t):t.__preload())),t._objFlags&Vb||(t._objFlags|=Vb,t.onLoad?i?i.add(t):(t.onLoad(),t._objFlags|=Ub):t._objFlags|=Ub),t._enabled)){if(!t.node._activeInHierarchy)return;n.director._compScheduler.enableComp(t,s)}}destroyComp(t){n.director._compScheduler.disableComp(t),t.onDestroy&&t._objFlags&Ub&&t.onDestroy()}_activateNodeRecursively(t,e,i,s){if(t._objFlags&Gb)return void T(3816,t.name);t._activeInHierarchy=!0;let r=t._components.length;for(let o=0;o<r;++o){const a=t._components[o];a instanceof n.Component?this.activateComp(a,e,i,s):(qb(t,a,o),--o,--r)}t._childArrivalOrder=t._children.length;for(let n=0,r=t._children.length;n<r;++n){const r=t._children[n];r._active&&this._activateNodeRecursively(r,e,i,s)}t._onPostActivated(!0)}_deactivateNodeRecursively(t){t._objFlags|=Gb,t._activeInHierarchy=!1;const e=t._components.length;for(let i=0;i<e;++i){const e=t._components[i];if(e._enabled&&(n.director._compScheduler.disableComp(e),t._activeInHierarchy))return void(t._objFlags&=~Gb)}for(let e=0,i=t._children.length;e<i;++e){const i=t._children[e];if(i._activeInHierarchy&&(this._deactivateNodeRecursively(i),t._activeInHierarchy))return void(t._objFlags&=~Gb)}t._onPostActivated(!1),t._objFlags&=~Gb}}var Yb,Kb,Jb;t("NodeActivator",Xb);let $b=t("SceneAsset",u_("cc.SceneAsset")((Jb=n_((Kb=class extends xu{constructor(...t){super(...t),i_(this,"scene",Jb,this)}initDefault(t){super.initDefault(t),this.scene=new Sb("New Scene")}validate(){return!!this.scene}}).prototype,"scene",[w_,g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yb=Kb))||Yb);var Zb,Qb,tT;n.SceneAsset=$b;let eT=t("TextAsset",u_("cc.TextAsset")((tT=n_((Qb=class extends xu{constructor(...t){super(...t),i_(this,"text",tT,this)}toString(){return this.text}}).prototype,"text",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Zb=Qb))||Zb);var iT,nT,sT;n.TextAsset=eT;let rT=t("JsonAsset",u_("cc.JsonAsset")((sT=n_((nT=class extends xu{constructor(...t){super(...t),i_(this,"json",sT,this)}}).prototype,"json",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iT=nT))||iT);n.JsonAsset=rT;class oT extends Zi{constructor(){super(),this._compScheduler=void 0,this._nodeActivator=void 0,this._invalid=void 0,this._paused=void 0,this._purgeDirectorInNextLoop=void 0,this._root=void 0,this._loadingScene=void 0,this._scene=void 0,this._totalFrames=void 0,this._lastUpdate=void 0,this._deltaTime=void 0,this._startTime=void 0,this._scheduler=void 0,this._systems=void 0,this._invalid=!1,this._paused=!1,this._purgeDirectorInNextLoop=!1,this._root=null,this._loadingScene="",this._scene=null,this._totalFrames=0,this._lastUpdate=0,this._deltaTime=0,this._startTime=0,this._scheduler=new eS,this._compScheduler=new Fb,this._nodeActivator=new Xb,this._systems=[],n.game.once(Nv.EVENT_RENDERER_INITED,this._initOnRendererInitialized,this)}calculateDeltaTime(t){t||(t=performance.now()),this._deltaTime=t>this._lastUpdate?(t-this._lastUpdate)/1e3:0,this._lastUpdate=t}convertToGL(t){const e=n.game.container,i=n.view,s=e.getBoundingClientRect(),r=s.left+window.pageXOffset-e.clientLeft,o=s.top+window.pageYOffset-e.clientTop,a=i._devicePixelRatio*(t.x-r),l=i._devicePixelRatio*(o+s.height-t.y);return i._isRotated?Pi(i._viewportRect.width-l,a):Pi(a,l)}convertToUI(t){const e=n.game.container,i=n.view,s=e.getBoundingClientRect(),r=s.left+window.pageXOffset-e.clientLeft,o=s.top+window.pageYOffset-e.clientTop,a=Pi(0,0);return i._isRotated?(a.x=r+t.y/i._devicePixelRatio,a.y=o+s.height-(i._viewportRect.width-t.x)/i._devicePixelRatio):(a.x=r+t.x*i._devicePixelRatio,a.y=o+s.height-t.y*i._devicePixelRatio),a}end(){this._purgeDirectorInNextLoop=!0}getWinSize(){return Bi(n.winSize)}getWinSizeInPixels(){return Bi(n.winSize)}pause(){this._paused||(this._paused=!0)}purgeCachedData(){n.assetManager.releaseAll()}purgeDirector(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),Sp&&Sp.setEnabled(!1),n.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),n.assetManager.releaseAll()}reset(){this.purgeDirector(),this.emit(oT.EVENT_RESET),Sp&&Sp.setEnabled(!0),this.startAnimation()}runSceneImmediate(t,e,i){t instanceof $b&&(t=t.scene),E(t instanceof Sb,1216),t._load();const s=Object.keys(n.game._persistRootNodes).map((t=>n.game._persistRootNodes[t]));for(let e=0;e<s.length;e++){const i=s[e];i.emit(n.Node.SCENE_CHANGED_FOR_PERSISTS,t.renderScene);const r=t.uuid===i._originalSceneId&&t.getChildByUuid(i.uuid);if(r){const e=r.getSiblingIndex();r._destroyImmediate(),t.insertChild(i,e)}else i.parent=t}const r=this._scene;n.isValid(r)&&r.destroy(),n.assetManager._releaseManager._autoRelease(r,t,n.game._persistRootNodes),this._scene=null,Gi._deferredDestroy(),e&&e(),this.emit(n.Director.EVENT_BEFORE_SCENE_LAUNCH,t),this._scene=t,t._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,t),this.emit(n.Director.EVENT_AFTER_SCENE_LAUNCH,t)}runScene(t,e,i){t instanceof $b&&(t=t.scene),E(t,1205),E(t instanceof Sb,1216),t._load(),this.once(n.Director.EVENT_AFTER_DRAW,(()=>{this.runSceneImmediate(t,e,i)}))}loadScene(t,e,i){if(this._loadingScene)return C(1208,t,this._loadingScene),!1;const s=n.assetManager.bundles.find((e=>!!e.getSceneInfo(t)));return s?(this.emit(n.Director.EVENT_BEFORE_SCENE_LOADING,t),this._loadingScene=t,console.time(`LoadScene ${t}`),s.loadScene(t,((n,s)=>{console.timeEnd(`LoadScene ${t}`),this._loadingScene="",n?(d(n),e&&e(n)):this.runSceneImmediate(s,i,e)})),!0):(T(1209,t),!1)}preloadScene(t,e,i){const s=n.assetManager.bundles.find((e=>!!e.getSceneInfo(t)));if(s)s.preloadScene(t,null,e,i);else{const e=`Can not preload the scene "${t}" because it is not in the build settings.`;i&&i(new Error(e)),d(`preloadScene: ${e}`)}}resume(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||S(1200),this._paused=!1,this._deltaTime=0)}setDepthTest(t){n.Camera.main&&(n.Camera.main.depth=!!t)}setClearColor(t){n.Camera.main&&(n.Camera.main.backgroundColor=t)}get root(){return this._root}getRunningScene(){return this._scene}getScene(){return this._scene}getAnimationInterval(){return 1e3/n.game.getFrameRate()}setAnimationInterval(t){n.game.setFrameRate(Math.round(1e3/t))}getDeltaTime(){return this._deltaTime}getTotalTime(){return performance.now()-this._startTime}getCurrentTime(){return this._lastUpdate}getTotalFrames(){return this._totalFrames}isPaused(){return this._paused}getScheduler(){return this._scheduler}setScheduler(t){this._scheduler!==t&&(this.unregisterSystem(this._scheduler),this._scheduler=t,this.registerSystem(eS.ID,t,200))}registerSystem(t,e,i){e.id=t,e.priority=i,e.init(),this._systems.push(e),this._systems.sort(Kx.sortByPriority)}unregisterSystem(t){zt.fastRemove(this._systems,t),this._systems.sort(Kx.sortByPriority)}getSystem(t){return this._systems.find((e=>e.id===t))}getAnimationManager(){return this.getSystem(n.AnimationManager.ID)}startAnimation(){this._invalid=!1,this._lastUpdate=performance.now()}stopAnimation(){this._invalid=!0}mainLoop(t){if(this._purgeDirectorInNextLoop)this._purgeDirectorInNextLoop=!1,this.purgeDirector();else if(!this._invalid){this.calculateDeltaTime(t),this.emit(oT.EVENT_BEGIN_FRAME);const e=this._deltaTime;if(!this._paused){this.emit(oT.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(let t=0;t<this._systems.length;++t)this._systems[t].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(oT.EVENT_AFTER_UPDATE),Gi._deferredDestroy();for(let t=0;t<this._systems.length;++t)this._systems[t].postUpdate(e)}this.emit(oT.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this.emit(oT.EVENT_AFTER_DRAW),Sp.frameUpdateListeners(),uf.clearBooks(),this.emit(oT.EVENT_END_FRAME),this._totalFrames++}}_initOnRendererInitialized(){this._totalFrames=0,this._lastUpdate=performance.now(),this._startTime=this._lastUpdate,this._paused=!1,this._purgeDirectorInNextLoop=!1,Sp&&Sp.setEnabled(!0),this.registerSystem(eS.ID,this._scheduler,200),this.emit(oT.EVENT_INIT)}_init(){return this._root=new nS(n.game._gfxDevice),this._root.initialize({}).catch((t=>(T(1217),Promise.reject(t))))}}t("Director",oT),oT.EVENT_INIT="director_init",oT.EVENT_RESET="director_reset",oT.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",oT.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",oT.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",oT.EVENT_BEFORE_UPDATE="director_before_update",oT.EVENT_AFTER_UPDATE="director_after_update",oT.EVENT_BEFORE_DRAW="director_before_draw",oT.EVENT_AFTER_DRAW="director_after_draw",oT.EVENT_BEFORE_COMMIT="director_before_commit",oT.EVENT_BEFORE_PHYSICS="director_before_physics",oT.EVENT_AFTER_PHYSICS="director_after_physics",oT.EVENT_BEGIN_FRAME="director_begin_frame",oT.EVENT_END_FRAME="director_end_frame",oT.instance=void 0,n.Director=oT;const aT=t("director",oT.instance=n.director=new oT);class lT{constructor(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new j_,this.scenes=new j_,this.paths=new j_}init(t){(t=>{let e=t.uuids;const i=t.paths,n=t.types,s=t.deps,r=t.paths=Object.create(null);if(!1===t.debug){for(let t=0,i=e.length;t<i;t++)e[t]=au(e[t]);for(const t in i){const e=i[t],s=e[1];e[1]=n[s]}}else{const t=Object.create(null);for(let i=0,n=e.length;i<n;i++){const n=e[i];e[i]=t[n]=au(n)}e=t}for(const t in i){const n=i[t];r[e[t]]=n}const o=t.scenes;for(const t in o){const i=o[t];o[t]=e[i]}const a=t.packs;for(const t in a){const i=a[t];for(let t=0;t<i.length;++t)i[t]=e[i[t]]}const l=t.versions;if(l)for(const t in l){const i=l[t];for(let t=0;t<i.length;t+=2){const n=i[t];i[t]=e[n]||n}}const c=t.redirect;if(c)for(let t=0;t<c.length;t+=2)c[t]=e[c[t]],c[t+1]=s[c[t+1]]})(t),this.importBase=t.importBase||"",this.nativeBase=t.nativeBase||"",this.base=t.base||"",this.name=t.name||"",this.deps=t.deps||[],this._initUuid(t.uuids),this._initPath(t.paths),this._initScene(t.scenes),this._initPackage(t.packs),this._initVersion(t.versions),this._initRedirect(t.redirect)}getInfoWithPath(t,e){if(!t)return null;t=uu(t);const i=this.paths.get(t);if(i){if(!e)return i[0];for(let t=0,n=i.length;t<n;t++){const n=i[t];if(Vt.isChildClassOf(n.ctor,e))return n}}return null}getDirWithPath(t,e,i){"/"===(t=uu(t))[t.length-1]&&(t=t.slice(0,-1));const n=i||[];return this.paths.forEach(((i,s)=>{if(s.startsWith(t)&&((t,e)=>!(t.length>e.length)||47===t.charCodeAt(e.length))(s,t)||!t)for(let t=0,s=i.length;t<s;t++){const s=i[t];e&&!Vt.isChildClassOf(s.ctor,e)||n.push(s)}})),n}getAssetInfo(t){return this.assetInfos.get(t)||null}getSceneInfo(t){return t.endsWith(".scene")||(t+=".scene"),"/"===t[0]||t.startsWith("db://")||(t=`/${t}`),this.scenes.find(((e,i)=>i.endsWith(t)))}destroy(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()}_initUuid(t){if(t){this.assetInfos.clear();for(let e=0,i=t.length;e<i;e++){const i=t[e];this.assetInfos.add(i,{uuid:i})}}}_initPath(t){if(!t)return;const e=this.paths;e.clear();for(const i in t){const n=t[i],s=n[0],r=n[1],o=3===n.length,a=this.assetInfos.get(i);a.path=s,a.ctor=Vt._getClassById(r),e.has(s)?o?e.get(s).push(a):e.get(s).splice(0,0,a):e.add(s,[a])}}_initScene(t){if(!t)return;const e=this.scenes;e.clear();const i=this.assetInfos;for(const n in t){const s=t[n],r=i.get(s);r.url=n,e.add(n,r)}}_initPackage(t){if(!t)return;const e=this.assetInfos;for(const i in t){const n=t[i],s={uuid:i,packedUuids:n,ext:".json"};e.add(i,s);for(let t=0,i=n.length;t<i;t++){const r=n[t],o=e.get(r),a=o.packs;a?1===i?a.splice(0,0,s):a.push(s):o.packs=[s]}}}_initVersion(t){if(!t)return;const e=this.assetInfos;let i=t.import;if(i)for(let t=0,n=i.length;t<n;t+=2){const n=i[t];e.get(n).ver=i[t+1]}if(i=t.native,i)for(let t=0,n=i.length;t<n;t+=2){const n=i[t];e.get(n).nativeVer=i[t+1]}}_initRedirect(t){if(!t)return;const e=this.assetInfos;for(let i=0,n=t.length;i<n;i+=2){const n=t[i];e.get(n).redirect=t[i+1]}}}function cT(t,e){t._uuid&&e.push(t._uuid)}function hT(t,e){const i=Object.getOwnPropertyNames(t);for(let n=0;n<i.length;n++){const s=i[n];if("node"===s||"__eventTargets"===s)continue;const r=t[s];if("object"==typeof r&&r)if(Array.isArray(r))for(let t=0;t<r.length;t++){const i=r[t];i instanceof xu&&cT(i,e)}else if(r.constructor&&r.constructor!==Object)r instanceof xu&&cT(r,e);else{const t=Object.getOwnPropertyNames(r);for(let i=0;i<t.length;i++){const n=r[t[i]];n instanceof xu&&cT(n,e)}}}}function _T(t,e){for(let i=0;i<t._components.length;i++)hT(t._components[i],e);for(let i=0;i<t._children.length;i++)_T(t._children[i],e)}function uT(t,e,i,n){i.push(t._uuid);const s=km.getDeps(t._uuid);for(let t=0,r=s.length;t<r;t++){const r=q_.get(s[t]);if(!r)continue;const o=r._uuid;o in e?e[o]+=n:e[o]=r.refCount+n,i.includes(o)||uT(r,e,i,n)}}const mT=[];var dT=new class{constructor(){this._persistNodeDeps=new j_,this._toDelete=new j_,this._eventListener=!1}init(){this._persistNodeDeps.clear(),this._toDelete.clear()}_addPersistNodeRef(t){const e=[];_T(t,e);for(let t=0,i=e.length;t<i;t++){const i=q_.get(e[t]);i&&i.addRef()}this._persistNodeDeps.add(t.uuid,e)}_removePersistNodeRef(t){if(!this._persistNodeDeps.has(t.uuid))return;const e=this._persistNodeDeps.get(t.uuid);for(let t=0,i=e.length;t<i;t++){const i=q_.get(e[t]);i&&i.decRef()}this._persistNodeDeps.remove(t.uuid)}_autoRelease(t,e,i){if(t){const i=km.getDeps(t.uuid);for(let e=0,n=i.length;e<n;e++){const n=q_.get(i[e]);n&&n.decRef(t.autoReleaseAssets)}const n=km._depends.get(t.uuid);if(n&&n.persistDeps){const e=n.persistDeps;for(let i=0,n=e.length;i<n;i++){const n=q_.get(e[i]);n&&n.decRef(t.autoReleaseAssets)}}t.uuid!==e.uuid&&km.remove(t.uuid)}const n=km._depends.get(e.uuid);n&&(n.persistDeps=[]);for(const t in i){const e=i[t],s=this._persistNodeDeps.get(e.uuid);for(const t of s){const e=q_.get(t);e&&e.addRef()}n&&n.persistDeps.push(...s)}}tryRelease(t,e=!1){t instanceof xu&&(e?this._free(t,e):(this._toDelete.add(t._uuid,t),this._eventListener||(this._eventListener=!0,te(this._freeAssets.bind(this)))))}_freeAssets(){this._eventListener=!1,this._toDelete.forEach((t=>{this._free(t)})),this._toDelete.clear()}_free(t,e=!1){const i=t._uuid;if(this._toDelete.remove(i),!ki(t,!0))return;if(!e&&t.refCount>0&&function(t){const e=Object.create(null);if(e[t._uuid]=t.refCount,uT(t,e,mT,-1),mT.length=0,0!==e[t._uuid])return e[t._uuid];for(const t in e)0!==e[t]&&uT(q_.get(t),e,mT,1);return mT.length=0,e[t._uuid]}(t)>0)return;q_.remove(i);const n=km.getDeps(i);for(let t=0,e=n.length;t<e;t++){const e=q_.get(n[t]);e&&(e.decRef(!1),this._free(e,!1))}t.destroy(),km.remove(i)}};let pT=null;function fT(t,e){for(let i=0,n=t.input.length;i<n;i++){const n=t.input[i];e&&!n.isNative&&n.content instanceof xu&&n.content.decRef(!1),n.recycle()}t.input=null}function gT(t,e){return e?/\?/.test(t)?`${t}&_t=${Date.now()}`:`${t}?_t=${Date.now()}`:t}function yT(t,e,i,n,s=0){t(s,((r,o)=>{s++,!r||s>e?n&&n(r,o):setTimeout((()=>{yT(t,e,i,n,s)}),i)}))}function vT(t,e,i,n,s){try{const r=km.parse(t,e);for(let t=0,e=r.deps.length;t<e;t++){const e=r.deps[t];e in i||(i[e]=!0,n.push({uuid:e,bundle:s&&s.name}))}r.nativeDep&&(s&&(r.nativeDep.bundle=s.name),n.push({...r.nativeDep}))}catch(t){d(t.message,t.stack)}}function xT(t,e,i){e&&(i=void 0!==i?i:n.assetManager.cacheAsset,_u(e)||!i||e.isDefault||q_.add(t,e))}function ST(t,e,i){let n=0;const s=[],r=t.length;0===r&&i&&i(s);const o=t=>{t&&s.push(t),n++,n===r&&i&&i(s)};for(let i=0;i<r;i++)e(t[i],o)}function AT(t,e,i){let n=t,s=e,r=i;if(void 0===i){const i="function"==typeof t;e?(r=e,i||(s=null)):void 0===e&&i&&(r=t,n=null,s=null),void 0!==e&&i&&(s=t,n=null)}return{options:n||Object.create(null),onProgress:s,onComplete:r}}function CT(t,e,i){let n=t,s=e,r=i;if(void 0===i){const i=Vt.isChildClassOf(t,xu);e?(r=e,i&&(s=null)):void 0!==e||i||(r=t,s=null,n=null),void 0===e||i||(s=t,n=null)}return{type:n,onProgress:s||pT,onComplete:r}}function bT(t,e,i,n={}){if(!i[e]||n[e])return!1;n[e]=!0;let s=!1;const r=km.getDeps(e);if(r)for(let e=0,o=r.length;e<o;e++){const o=r[e];if(o===t||bT(t,o,i,n)){s=!0;break}}return s}function TT(t){return(e,i)=>{if(!t)return;const n=[];Array.isArray(i)?i.forEach((t=>t instanceof xu&&n.push(t.addRef()))):i instanceof xu&&n.push(i.addRef()),te((()=>{n.forEach((t=>t.decRef(!1))),t(e,i)}))}}class wT{constructor(){this._config=new lT}get config(){return this._config}get name(){return this._config.name}get deps(){return this._config.deps}get base(){return this._config.base}getInfoWithPath(t,e){return this._config.getInfoWithPath(t,e)}getDirWithPath(t,e,i){return this._config.getDirWithPath(t,e,i)}getAssetInfo(t){return this._config.getAssetInfo(t)}getSceneInfo(t){return this._config.getSceneInfo(t)}init(t){this._config.init(t),K_.add(t.name,this)}load(t,e,i,s){const{type:r,onProgress:o,onComplete:a}=CT(e,i,s),l={__requestType__:Q_.PATH,type:r,bundle:this.name,__outputAsArray__:Array.isArray(t)};n.assetManager.loadAny(t,l,o,a)}preload(t,e,i,s){const{type:r,onProgress:o,onComplete:a}=CT(e,i,s);n.assetManager.preloadAny(t,{__requestType__:Q_.PATH,type:r,bundle:this.name},o,a)}loadDir(t,e,i,s){const{type:r,onProgress:o,onComplete:a}=CT(e,i,s);n.assetManager.loadAny(t,{__requestType__:Q_.DIR,type:r,bundle:this.name,__outputAsArray__:!0},o,a)}preloadDir(t,e,i,s){const{type:r,onProgress:o,onComplete:a}=CT(e,i,s);n.assetManager.preloadAny(t,{__requestType__:Q_.DIR,type:r,bundle:this.name},o,a)}loadScene(t,e,i,s){const{options:r,onProgress:o,onComplete:a}=AT(e,i,s);r.preset=r.preset||"scene",r.bundle=this.name,n.assetManager.loadAny({scene:t},r,o,((t,e)=>{if(t)d(t.message,t.stack);else if(e instanceof $b&&e.scene){const t=e.scene;t._id=e._uuid,t.name=e.name}else t=new Error(`The asset ${e._uuid} is not a scene`);a&&a(t,e)}))}preloadScene(t,e,i,s){const{options:r,onProgress:o,onComplete:a}=AT(e,i,s);r.bundle=this.name,n.assetManager.preloadAny({scene:t},r,o,(e=>{e&&T(1210,t,e.message),a&&a(e)}))}get(t,e){const i=this.getInfoWithPath(t,e);return i&&q_.get(i.uuid)||null}release(t,e){const i=this.get(t,e);i&&dT.tryRelease(i,!0)}releaseUnusedAssets(){q_.forEach((t=>{const e=this.getAssetInfo(t._uuid);e&&!e.redirect&&dT.tryRelease(t)}))}releaseAll(){q_.forEach((t=>{const e=this.getAssetInfo(t._uuid);e&&!e.redirect&&dT.tryRelease(t,!0)}))}_destroy(){this._config.destroy()}}const ET=t("resources",new wT);function PT(t,e,i){const n=new Image;function s(){n.removeEventListener("load",s),n.removeEventListener("error",r),i&&i(null,n)}function r(){n.removeEventListener("load",s),n.removeEventListener("error",r),i&&i(new Error(I(4930,t)))}return"file:"!==window.location.protocol&&(n.crossOrigin="anonymous"),n.addEventListener("load",s),n.addEventListener("error",r),n.src=t,n}function IT(t,e,i,n){const s=new XMLHttpRequest,r=`download failed: ${t}, status: `;if(s.open("GET",t,!0),void 0!==e.xhrResponseType&&(s.responseType=e.xhrResponseType),void 0!==e.xhrWithCredentials&&(s.withCredentials=e.xhrWithCredentials),void 0!==e.xhrMimeType&&s.overrideMimeType&&s.overrideMimeType(e.xhrMimeType),void 0!==e.xhrTimeout&&(s.timeout=e.xhrTimeout),e.xhrHeader)for(const t in e.xhrHeader)s.setRequestHeader(t,e.xhrHeader[t]);return s.onload=()=>{200===s.status||0===s.status?n&&n(null,s.response):n&&n(new Error(`${r}${s.status}(no response)`))},i&&(s.onprogress=t=>{t.lengthComputable&&i(t.loaded,t.total)}),s.onerror=()=>{n&&n(new Error(`${r}${s.status}(error)`))},s.ontimeout=()=>{n&&n(new Error(`${r}${s.status}(time out)`))},s.onabort=()=>{n&&n(new Error(`${r}${s.status}(abort)`))},s.send(null),s}n.resources=ET;const DT={};function RT(t,e,i){if(DT[t])return i&&i(null),null;const n=document.createElement("script");function s(){n.parentNode.removeChild(n),n.removeEventListener("load",s,!1),n.removeEventListener("error",r,!1),DT[t]=!0,i&&i(null)}function r(){n.parentNode.removeChild(n),n.removeEventListener("load",s,!1),n.removeEventListener("error",r,!1),i&&i(new Error(I(4928,t)))}return"file:"!==window.location.protocol&&(n.crossOrigin="anonymous"),n.async=e.scriptAsyncLoading||!1,n.src=t,n.addEventListener("load",s,!1),n.addEventListener("error",r,!1),document.body.appendChild(n),n}const MT=/^(?:\w+:\/\/|\.+\/).+/,BT=(t,e,i)=>{(Cy.capabilities.imageBitmap&&n.assetManager.allowImageBitmap?OT:PT)(t,e,i)},OT=(t,e,i)=>{e.xhrResponseType="blob",IT(t,e,e.onFileProgress,i)},NT=(t,e,i)=>{e.xhrResponseType="json",IT(t,e,e.onFileProgress,i)},LT=(t,e,i)=>{e.xhrResponseType="arraybuffer",IT(t,e,e.onFileProgress,i)},FT=(t,e,i)=>{e.xhrResponseType="text",IT(t,e,e.onFileProgress,i)},zT=(t,e,i)=>{const n=gn(t);let s=t;MT.test(s)||(s=-1!==VT.remoteBundles.indexOf(n)?`${VT.remoteServerAddress}remote/${n}`:`assets/${n}`);const r=e.version||VT.bundleVers[n];let o=0,a=null,l=null;NT(`${s}/config.${r?`${r}.`:""}json`,e,((t,e)=>{l=t,a=e,a&&(a.base=`${s}/`),2==++o&&i(l,a)})),RT(`${s}/index.${r?`${r}.`:""}js`,e,(t=>{l=t,2==++o&&i(t,a)}))},VT=new class{constructor(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=PT,this.downloadDomAudio=null,this.downloadFile=IT,this.downloadScript=RT,this._downloaders={".png":BT,".jpg":BT,".bmp":BT,".jpeg":BT,".gif":BT,".ico":BT,".tiff":BT,".webp":BT,".image":BT,".pvr":LT,".pkm":LT,".astc":LT,".txt":FT,".xml":FT,".vsh":FT,".fsh":FT,".atlas":FT,".tmx":FT,".tsx":FT,".json":NT,".ExportJson":NT,".plist":FT,".fnt":FT,".binary":LT,".bin":LT,".dbbin":LT,".skel":LT,".js":RT,bundle:zT,default:FT},this._downloading=new j_,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}get remoteServerAddress(){return this._remoteServerAddress}init(t="",e={},i=[]){this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=t,this.bundleVers=e,this.remoteBundles=i}register(t,e){"object"==typeof t?St(this._downloaders,t):this._downloaders[t]=e}download(t,e,i,n,s){const r=X_.get(t);if(r)return void s(null,r);const o=this._downloading.get(t);if(o){o.push(s);const e=this._queue.find((e=>e.id===t));if(!e)return;const i=n.priority||0;return void(e.priority<i&&(e.priority=i,this._queueDirty=!0))}const a=void 0!==n.maxRetryCount?n.maxRetryCount:this.maxRetryCount,l=void 0!==n.maxConcurrency?n.maxConcurrency:this.maxConcurrency,c=void 0!==n.maxRequestsPerFrame?n.maxRequestsPerFrame:this.maxRequestsPerFrame,h=this._downloaders[i]||this._downloaders.default;yT(((i,r)=>{if(0===i&&this._downloading.add(t,[s]),!this.limited)return void h(gT(e,this.appendTimeStamp),n,r);this._updateTime();const o=(t,e)=>{this._totalNum--,this._handleQueueInNextFrame(l,c),r(t,e)};this._totalNum<l&&this._totalNumThisPeriod<c?(h(gT(e,this.appendTimeStamp),n,o),this._totalNum++,this._totalNumThisPeriod++):(this._queue.push({id:t,priority:n.priority||0,url:e,options:n,done:o,handler:h}),this._queueDirty=!0,this._totalNum<l&&this._handleQueueInNextFrame(l,c))}),a,this.retryInterval,((e,i)=>{e||X_.add(t,i);const n=this._downloading.remove(t);for(let t=0,s=n.length;t<s;t++)n[t](e,i)}))}loadSubpackage(t,e){n.assetManager.loadBundle(t,null,e)}_updateTime(){const t=Date.now(),e=n.director.getDeltaTime(),i=e>this._maxInterval?this._maxInterval:e;t-this._lastDate>1e3*i&&(this._totalNumThisPeriod=0,this._lastDate=t)}_handleQueue(t,e){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<t&&this._totalNumThisPeriod<e;){this._queueDirty&&(this._queue.sort(((t,e)=>t.priority-e.priority)),this._queueDirty=!1);const t=this._queue.pop();if(!t)break;this._totalNum++,this._totalNumThisPeriod++,t.handler(gT(t.url,this.appendTimeStamp),t.options,t.done)}this._handleQueueInNextFrame(t,e)}_handleQueueInNextFrame(t,e){!this._checkNextPeriod&&this._queue.length>0&&(te(this._handleQueue.bind(this),t,e),this._checkNextPeriod=!0)}};function UT(t,e,i,n){let s=null,r=null;try{s=new Ru,s._nativeUrl=t,s._nativeAsset=e}catch(t){r=t}n(r,s)}function GT(t,e,i,n){const s=new rT;s.json=e,n(null,s)}function HT(t,e,i,n){const s=new eT;s.text=e,n(null,s)}function kT(t,e,i,n){const s=new DS;s._nativeUrl=t,s._nativeAsset=e,n(null,s)}function jT(t,e,i,n){const s=new xu;s._nativeUrl=t,s._nativeAsset=e,n(null,s)}function WT(t,i,n,s){let r=K_.get(i.name);r||(r=i.name===eu.RESOURCES?ET:new wT,i.base=i.base||`${t}/`,r.init(i)),e.import(`virtual:///prerequisite-imports/${r.name}`).then((()=>{s(null,r)})).catch(s)}var qT=new class{constructor(){this._creating=new j_,this._producers={".png":UT,".jpg":UT,".bmp":UT,".jpeg":UT,".gif":UT,".ico":UT,".tiff":UT,".webp":UT,".image":UT,".pvr":UT,".pkm":UT,".txt":HT,".xml":HT,".vsh":HT,".fsh":HT,".atlas":HT,".tmx":HT,".tsx":HT,".fnt":HT,".json":GT,".ExportJson":GT,".binary":kT,".bin":kT,".dbbin":kT,".skel":kT,bundle:WT,default:jT}}register(t,e){"object"==typeof t?Vt.mixin(this._producers,t):this._producers[t]=e}create(t,e,i,n,s){const r=this._producers[i]||this._producers.default,o=q_.get(t);if(!n.reloadAsset&&o)return void s(null,o);const a=this._creating.get(t);a?a.push(s):(this._creating.add(t,[s]),r(t,e,n,((e,i)=>{!e&&i instanceof xu&&(i._uuid=t,xT(t,i,n.cacheAsset));const s=this._creating.remove(t);for(let t=0,n=s.length;t<n;t++)s[t](e,i)})))}},XT=new class{constructor(){this._loading=new j_,this._unpackers={".json":this.unpackJson}}unpackJson(t,e,i,n){let s=Vt.createMap(!0),r=null;if(Array.isArray(e)){(e=function(t){if(t[0]<1)throw new Error(I(5304,t[0]));_m(t,!0,void 0),um(t);const e=new dm(t[0]),i=t[1],n=t[2],s=t[3],r=t[4],o=t[5];for(let t=0;t<o.length;++t)o[t].unshift(e,i,n,s,r);return o}(e)).length!==t.length&&T(4915);for(let i=0;i<t.length;i++)s[`${t[i]}@import`]=e[i]}else{const i=Vt._getClassId(Zm),n=Vt._getClassId(Ru);if(e.type===i&&e.data){const n=e.data;n.length!==t.length&&T(4915);for(let e=0;e<t.length;e++)s[`${t[e]}@import`]=pm(i,{base:n[e][0],mipmaps:n[e][1]})}else if(e.type===n&&e.data){const i=e.data;i.length!==t.length&&T(4915);for(let e=0;e<t.length;e++)s[`${t[e]}@import`]=i[e]}else r=new Error("unmatched type pack!"),s=null}n(r,s)}init(){this._loading.clear()}register(t,e){"object"==typeof t?Vt.mixin(this._unpackers,t):this._unpackers[t]=e}unpack(t,e,i,n,s){e?(0,this._unpackers[i])(t,e,n,s):s(new Error("package data is wrong!"))}load(t,e,i){if(t.isNative||!t.info||!t.info.packs)return void VT.download(t.id,t.url,t.ext,t.options,i);if(X_.has(t.id))return void i(null,X_.get(t.id));const n=t.info.packs;let s=n.find((t=>this._loading.has(t.uuid)));if(s)return void this._loading.get(s.uuid).push({onComplete:i,id:t.id});s=n[0],this._loading.add(s.uuid,[{onComplete:i,id:t.id}]);const r=mu(s.uuid,{ext:s.ext,bundle:t.config.name});VT.download(s.uuid,r,s.ext,t.options,((e,i)=>{X_.remove(s.uuid),e&&d(e.message,e.stack),this.unpack(s.packedUuids,i,s.ext,t.options,((t,i)=>{if(!t)for(const t in i)X_.add(t,i[t]);const n=this._loading.remove(s.uuid);for(let s=0,r=n.length;s<r;s++){const r=n[s];if(e||t){r.onComplete(e||t);continue}const o=i[r.id];o?r.onComplete(null,o):r.onComplete(new Error("can not retrieve data from package"))}}))}))}};function YT(t,e){let i=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},i=!0);const{options:s,progress:r}=t,o=[],a=r.total,l=s.__exclude__=s.__exclude__||Object.create(null);t.output=[],ST(t.input,((s,c)=>{if(!s.isNative&&q_.has(s.uuid)){const e=q_.get(s.uuid);return s.content=e.addRef(),t.output.push(s),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,s),void c()}XT.load(s,t.options,((h,_)=>{h?t.isFinish||(!n.assetManager.force||i?(d(h.message,h.stack),r.canInvoke=!1,e(h)):(t.output.push(s),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,s))):t.isFinish||(s.file=_,t.output.push(s),s.isNative||(l[s.uuid]=!0,vT(s.uuid,_,l,o,s.config),r.total=a+o.length),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,s)),c()}))}),(()=>{if(t.isFinish)return fT(t,!0),void t.dispatch("error");if(o.length>0){const n=iu.create({input:o,progress:r,options:s,onProgress:t.onProgress,onError:iu.prototype.recycle,onComplete:s=>{s||(t.output.push(...n.output),n.recycle()),i&&KT(t),e(s)}});$_.async(n)}else i&&KT(t),e()}))}function KT(t){const e=t.output;for(let t=0,i=e.length;t<i;t++)e[t].content&&e[t].content.decRef(!1)}class JT{constructor(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}parse(t){return this._parseXML(t)}_parseXML(t){if(this._parser)return this._parser.parseFromString(t,"text/xml");throw new Error("Dom parser is not supported in this platform!")}}const $T=new class extends JT{parse(t){const e=this._parseXML(t).documentElement;if("plist"!==e.tagName)return C(5100),{};let i=null;for(let t=0,n=e.childNodes.length;t<n&&(i=e.childNodes[t],1!==i.nodeType);t++);return this._parseNode(i)}_parseNode(t){let e=null;const i=t.tagName;if("dict"===i)e=this._parseDict(t);else if("array"===i)e=this._parseArray(t);else if("string"===i)if(1===t.childNodes.length)e=t.firstChild.nodeValue;else{e="";for(let i=0;i<t.childNodes.length;i++)e+=t.childNodes[i].nodeValue}else"false"===i?e=!1:"true"===i?e=!0:"real"===i?e=parseFloat(t.firstChild.nodeValue):"integer"===i&&(e=parseInt(t.firstChild.nodeValue,10));return e}_parseArray(t){const e=[];for(let i=0,n=t.childNodes.length;i<n;i++){const n=t.childNodes[i];1===n.nodeType&&e.push(this._parseNode(n))}return e}_parseDict(t){const e={};let i="";for(let n=0,s=t.childNodes.length;n<s;n++){const s=t.childNodes[n];1===s.nodeType&&("key"===s.tagName?i=s.firstChild.nodeValue:e[i]=this._parseNode(s))}return e}};function ZT(t,e){return t[e]<<8|t[e+1]}var QT=new class{constructor(){this._parsing=new j_,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".mp3":this.parseAudio,".ogg":this.parseAudio,".wav":this.parseAudio,".m4a":this.parseAudio,".plist":this.parsePlist,import:this.parseImport}}parseImage(t,e,i){t instanceof HTMLImageElement?i(null,t):createImageBitmap(t,{premultiplyAlpha:"none"}).then((t=>{i(null,t)}),(t=>{i(t,null)}))}parseAudio(t,e,i){t instanceof ArrayBuffer?Cy.__audioSupport.context.decodeAudioData(t,(t=>{i(null,t)}),(t=>{i(new Error(`Error with decoding audio data${t.err}`),null)})):i(null,t)}parsePVRTex(t,e,i){let n=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,i=new Int32Array(e,0,13);if(55727696===i[0]){const t=i[7],n=i[6],r=i[12]+52;s={_data:new Uint8Array(e,r),_compressed:!0,width:t,height:n,format:0}}else{if(559044176!==i[11])throw new Error("Invalid magic number in PVR header");{const t=i[0],n=i[1],r=i[2];s={_data:new Uint8Array(e,t),_compressed:!0,width:r,height:n,format:0}}}}catch(t){n=t}i(n,s)}parsePKMTex(t,e,i){let n=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,i=new Uint8Array(e),n=ZT(i,6);if(0!==n&&1!==n&&3!==n)throw new Error("Invalid magic number in ETC header");const r=ZT(i,12),o=ZT(i,14);ZT(i,8),ZT(i,10),s={_data:new Uint8Array(e,16),_compressed:!0,width:r,height:o,format:0}}catch(t){n=t}i(n,s)}parseASTCTex(t,e,i){let n=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,i=new Uint8Array(e);if(1554098963!==i[0]+(i[1]<<8)+(i[2]<<16)+(i[3]<<24))throw new Error("Invalid magic number in ASTC header");const n=i[4],r=i[5],o=i[6];if((n<3||n>6||r<3||r>6||o<3||o>6)&&(n<4||7===n||9===n||11===n||n>12||r<4||7===r||9===r||11===r||r>12||1!==o))throw new Error("Invalid block number in ASTC header");const a=function(t,e){return 4===t?Su.RGBA_ASTC_4x4:5===t?4===e?Su.RGBA_ASTC_5x4:Su.RGBA_ASTC_5x5:6===t?5===e?Su.RGBA_ASTC_6x5:Su.RGBA_ASTC_6x6:8===t?5===e?Su.RGBA_ASTC_8x5:6===e?Su.RGBA_ASTC_8x6:Su.RGBA_ASTC_8x8:10===t?5===e?Su.RGBA_ASTC_10x5:6===e?Su.RGBA_ASTC_10x6:8===e?Su.RGBA_ASTC_10x8:Su.RGBA_ASTC_10x10:10===e?Su.RGBA_ASTC_12x10:Su.RGBA_ASTC_12x12}(n,r),l=i[7]+(i[8]<<8)+(i[9]<<16),c=i[10]+(i[11]<<8)+(i[12]<<16);i[13],i[14],i[15],s={_data:new Uint8Array(e,16),_compressed:!0,width:l,height:c,format:a}}catch(t){n=t}i(n,s)}parsePlist(t,e,i){let n=null;const s=$T.parse(t);s||(n=new Error("parse failed")),i(n,s)}parseImport(t,e,i){if(!t)return void i(new Error(`The json file of asset ${e.__uuid__} is empty or missing`));let n=null,s=null;try{n=Gm(t,e)}catch(t){s=t}i(s,n)}init(){this._parsing.clear()}register(t,e){"object"==typeof t?St(this._parsers,t):this._parsers[t]=e}parse(t,e,i,n,s){const r=Y_.get(t);if(r)return void s(null,r);const o=this._parsing.get(t);if(o)return void o.push(s);const a=this._parsers[i];a?(this._parsing.add(t,[s]),a(e,n,((e,i)=>{e?X_.remove(t):_u(i)||Y_.add(t,i);const n=this._parsing.remove(t);for(let t=0,s=n.length;t<s;t++)n[t](e,i)}))):s(null,e)}};function tw(t,e){let i=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},i=!0);const{options:s,progress:r}=t;s.__exclude__=s.__exclude__||Object.create(null),t.output=[],ST(t.input,((o,a)=>{const l=iu.create({input:o,onProgress:t.onProgress,options:s,progress:r,onComplete:(s,c)=>{s&&!t.isFinish&&(!n.assetManager.force||i?(d(s.message,s.stack),r.canInvoke=!1,e(s)):r.canInvoke&&t.dispatch("progress",++r.finish,r.total,o)),t.output.push(c),l.recycle(),a(null)}});ew.async(l)}),(()=>{if(s.__exclude__=null,t.isFinish)return fT(t,!0),void t.dispatch("error");!function(t){const e=t.source;if(t.options.__outputAsArray__||1!==e.length){const i=t.output=[];for(let t=0,n=e.length;t<n;t++)i.push(e[t].content)}else t.output=e[0].content}(t),fT(t,!0),e()}))}const ew=new W_("loadOneAsset",[function(t,e){const i=t.output=t.input,{options:n,isNative:s,uuid:r,file:o}=i,{reloadAsset:a}=n;o||!a&&!s&&q_.has(r)?e():XT.load(i,t.options,((t,n)=>{i.file=n,e(t)}))},function(t,e){const i=t.output=t.input,n=t.progress,s=t.options.__exclude__,{id:r,file:o,options:a}=i;if(i.isNative)QT.parse(r,o,i.ext,a,((s,o)=>{s?e(s):(i.content=o,n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),X_.remove(r),Y_.remove(r),e())}));else{const{uuid:l}=i;if(l in s){const{finish:r,content:o,err:a,callbacks:c}=s[l];n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),r||bT(l,l,s)?(o&&o.addRef(),i.content=o,e(a)):c.push({done:e,item:i})}else if(!a.reloadAsset&&q_.has(l)){const s=q_.get(l);i.content=s.addRef(),n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),e()}else a.__uuid__=l,QT.parse(r,o,"import",a,((i,n)=>{i?e(i):function(t,e,i){const{input:n,progress:s}=t,{uuid:r,id:o,options:a,config:l}=n,{cacheAsset:c}=a,h=[];e.addRef&&e.addRef(),vT(r,e,Object.create(null),h,l),s.canInvoke&&t.dispatch("progress",++s.finish,s.total+=h.length,n);const _=t.options.__exclude__[r]={content:e,finish:!1,callbacks:[{done:i,item:n}]},u=iu.create({input:h,options:t.options,onProgress:t.onProgress,onError:iu.prototype.recycle,progress:s,onComplete:t=>{if(e.decRef&&e.decRef(!1),_.finish=!0,_.err=t,!t){const t=Array.isArray(u.output)?u.output:[u.output],i=Object.create(null);for(const e of t)e&&(i[e instanceof xu?`${e._uuid}@import`:`${r}@native`]=e);!function(t,e,i){let n=!1;const s=e.__depends__;if(s){for(let t=0,e=s.length;t<e;t++){const e=s[t],r=i[`${e.uuid}@import`];if(r)e.owner[e.prop]=r.addRef();else{if(d(`The asset ${e.uuid} is missing!`),e.type&&e.type!==xu){const t=new e.type;t.initDefault(e.uuid),e.owner[e.prop]=t}n=!0}}e.__depends__=null}e.__nativeDepend__&&(i[`${t}@native`]?e._nativeAsset=i[`${t}@native`]:(n=!0,console.error(`the native asset of ${t} is missing!`)),e.__nativeDepend__=!1)}(r,e,i);try{"function"!=typeof e.onLoaded||e.__onLoadedInvoked__||e.__nativeDepend__||(e.onLoaded(),e.__onLoadedInvoked__=!0)}catch(t){d(`The asset ${r} is invalid for some reason, detail message: ${t.message}, stack: ${t.stack}`)}X_.remove(o),Y_.remove(o),xT(r,e,c),u.recycle()}const i=_.callbacks;for(let n=0,s=i.length;n<s;n++){const s=i[n];e.addRef&&e.addRef(),s.item.content=e,s.done(t)}i.length=0}});J_.async(u)}(t,n,e)}))}}]);function iw(t,e){const i=t.options,n=Object.create(null),s=Object.create(null);for(const t in i)switch(t){case Q_.PATH:case Q_.UUID:case Q_.DIR:case Q_.SCENE:case Q_.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":n[t]=i[t];break;case"__exclude__":case"__outputAsArray__":s[t]=i[t];break;default:n[t]=i[t],s[t]=i[t]}t.options=s;const r=iu.create({input:t.input,options:n});let o=null;try{t.output=t.source=Z_.sync(r)}catch(t){o=t;for(let t=0,e=r.output.length;t<e;t++)r.output[t].recycle()}r.recycle(),e(o)}class nw{constructor(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}get id(){return this._id||(this._id=`${this.uuid}@${this.isNative?"native":"import"}`),this._id}static create(){let t;return t=0!==nw._deadPool.length?nw._deadPool.pop():new nw,t}recycle(){nw._deadPool.length!==nw.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),nw._deadPool.push(this))}}nw.MAX_DEAD_NUM=500,nw._deadPool=[];const sw=[];function rw(t){const e=t.options,i=Array.isArray(t.input)?t.input:[t.input];t.output=[];for(let n=0;n<i.length;n++){let s=i[n],r=nw.create(),o=null,a=null;if("string"==typeof s&&(s=Object.create(null),s[e.__requestType__||Q_.UUID]=i[n]),"object"==typeof s){xt(s,e),s.preset&&xt(s,tu[s.preset]);for(const t in s){switch(t){case Q_.UUID:{const t=r.uuid=au(s.uuid);if(!s.bundle){const e=K_.find((e=>!!e.getAssetInfo(t)));s.bundle=e&&e.name}if(K_.has(s.bundle)){if(o=K_.get(s.bundle).config,a=o.getAssetInfo(t),a&&a.redirect){if(!K_.has(a.redirect))throw new Error(`Please load bundle ${a.redirect} first`);o=K_.get(a.redirect).config,a=o.getAssetInfo(t)}r.config=o,r.info=a}r.ext=s.ext||".json";break}case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case Q_.DIR:if(K_.has(s.bundle)){K_.get(s.bundle).config.getDirWithPath(s.dir,s.type,sw);for(const t of sw)i.push({uuid:t.uuid,__isNative__:!1,ext:".json",bundle:s.bundle});sw.length=0}r.recycle(),r=null;break;case Q_.PATH:if(K_.has(s.bundle)){if(o=K_.get(s.bundle).config,a=o.getInfoWithPath(s.path,s.type),a&&a.redirect){if(!K_.has(a.redirect))throw new Error(`you need to load bundle ${a.redirect} first`);o=K_.get(a.redirect).config,a=o.getAssetInfo(a.uuid)}if(!a)throw r.recycle(),new Error(`Bundle ${s.bundle} doesn't contain ${s.path}`);r.config=o,r.uuid=a.uuid,r.info=a}r.ext=s.ext||".json";break;case Q_.SCENE:if(!s.bundle){const t=K_.find((t=>!!t.getSceneInfo(s.scene)));s.bundle=t&&t.name}if(K_.has(s.bundle)){if(o=K_.get(s.bundle).config,a=o.getSceneInfo(s.scene),a&&a.redirect){if(!K_.has(a.redirect))throw new Error(`you need to load bundle ${a.redirect} first`);o=K_.get(a.redirect).config,a=o.getAssetInfo(a.uuid)}if(!a)throw r.recycle(),new Error(`Bundle ${o.name} doesn't contain scene ${s.scene}`);r.config=o,r.uuid=a.uuid,r.info=a}break;case"__isNative__":r.isNative=s.__isNative__;break;case Q_.URL:r.url=s.url,r.uuid=s.uuid||s.url,r.ext=s.ext||pn(s.url),r.isNative=void 0===s.__isNative__||s.__isNative__;break;default:r.options[t]=s[t]}if(!r)break}}if(r&&(t.output.push(r),!r.uuid&&!r.url))throw new Error(`Can not parse this input:${JSON.stringify(s)}`)}return null}function ow(t){const e=t.output=t.input;for(let t=0;t<e.length;t++){const i=e[t];if(i.url)continue;let s="",r="";const o=i.config;r=i.isNative?o&&o.nativeBase?o.base+o.nativeBase:n.assetManager.generalNativeBase:o&&o.importBase?o.base+o.importBase:n.assetManager.generalImportBase;const a=i.uuid;let l="";i.info&&(l=i.isNative?i.info.nativeVer?`.${i.info.nativeVer}`:"":i.info.ver?`.${i.info.ver}`:""),s=".ttf"===i.ext?`${r}/${a.slice(0,2)}/${a}${l}/${i.options.__nativeName__}`:`${r}/${a.slice(0,2)}/${a}${l}${i.ext}`,i.url=s}return null}class aw{constructor(){this.pipeline=J_.append(iw).append(tw),this.fetchPipeline=$_.append(iw).append(YT),this.transformPipeline=Z_.append(rw).append(ow),this.bundles=K_,this.assets=q_,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=km,this.force=!1,this.allowImageBitmap=!Cy.isMobile,this.utils=yu,this.downloader=VT,this.parser=QT,this.packManager=XT,this.cacheAsset=!0,this.cacheManager=null,this.presets=tu,this.factory=qT,this.preprocessPipe=iw,this.fetchPipe=YT,this.loadPipe=tw,this.references=null,this._releaseManager=dT,this._files=X_,this._parsed=Y_,this._parsePipeline=null}get main(){return K_.get(eu.MAIN)||null}get resources(){return K_.get(eu.RESOURCES)||null}init(t={}){this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(t.server,t.bundleVers,t.remoteBundles),this.parser.init(),this.dependUtil.init();let e=t.importBase||"";e&&e.endsWith("/")&&(e=e.substr(0,e.length-1));let i=t.nativeBase||"";i&&i.endsWith("/")&&(i=i.substr(0,i.length-1)),this.generalImportBase=e,this.generalNativeBase=i}getBundle(t){return K_.get(t)||null}removeBundle(t){t._destroy(),K_.remove(t.name)}loadAny(t,e,i,n){const{options:s,onProgress:r,onComplete:o}=AT(e,i,n);s.preset=s.preset||"default",t=Array.isArray(t)?t.slice():t;const a=iu.create({input:t,onProgress:r,onComplete:TT(o),options:s});J_.async(a)}preloadAny(t,e,i,n){const{options:s,onProgress:r,onComplete:o}=AT(e,i,n);s.preset=s.preset||"preload",t=Array.isArray(t)?t.slice():t;const a=iu.create({input:t,onProgress:r,onComplete:TT(o),options:s});$_.async(a)}postLoadNative(t,e,i){const{options:n,onComplete:s}=AT(e,void 0,i);if(!t._native||!t.__nativeDepend__)return void TT(s)(null);const r=km.getNativeDep(t._uuid);if(r){if(!K_.has(r.bundle)){const e=K_.find((e=>!!e.getAssetInfo(t._uuid)));e&&(r.bundle=e.name)}this.loadAny(r,n,((e,i)=>{e?d(e.message,e.stack):t.isValid&&t.__nativeDepend__&&(t._nativeAsset=i,t.__nativeDepend__=!1),s&&s(e)}))}}loadRemote(t,e,i){const{options:n,onComplete:s}=AT(e,void 0,i);n.reloadAsset||!this.assets.has(t)?(n.__isNative__=!0,n.preset=n.preset||"remote",this.loadAny({url:t},n,null,((e,i)=>{e?(d(e.message,e.stack),s&&s(e,i)):qT.create(t,i,n.ext||pn(t),n,((t,e)=>{s&&s(t,e)}))}))):TT(s)(null,this.assets.get(t))}loadBundle(t,e,i){const{options:n,onComplete:s}=AT(e,void 0,i),r=gn(t);this.bundles.has(r)?TT(s)(null,this.getBundle(r)):(n.preset=n.preset||"bundle",n.ext="bundle",n.__isNative__=!0,this.loadAny({url:t},n,null,((e,i)=>{e?(d(e.message,e.stack),s&&s(e,i)):qT.create(t,i,"bundle",n,((t,e)=>{s&&s(t,e)}))})))}releaseAsset(t){dT.tryRelease(t,!0)}releaseUnusedAssets(){q_.forEach((t=>{dT.tryRelease(t)}))}releaseAll(){q_.forEach((t=>{dT.tryRelease(t,!0)}))}loadWithJson(t,e,i,n){throw new Error("Only valid in Editor")}}t("AssetManager",aw),aw.Pipeline=W_,aw.Task=iu,aw.Cache=j_,aw.RequestItem=nw,aw.Bundle=wT,aw.BuiltinBundleName=eu;var lw=t("assetManager",n.assetManager=new aw);n.AssetManager=aw;const cw=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],hw=[".mp3",".ogg",".wav",".m4a"];function _w(){return!0}const uw={transformURL(t){const e=cu(t);if(!e)return t;const i=K_.find((t=>!!t.getAssetInfo(e)));if(!i)return t;let n="";const s=i.getAssetInfo(e);if(n=t.startsWith(i.base+i.config.nativeBase)?s.nativeVer||"":s.ver||"",!n||-1!==t.indexOf(n))return t;let r=!1;if(".ttf"===pn(t)&&(r=!0),r){const e=yn(t),i=gn(t);t=`${e}.${n}/${i}`}else t=t.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/,(t=>`${t}.${n}`));return t}};class mw{constructor(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=CT}set onProgress(t){pT=t}get _cache(){return q_._map}load(t,e,i){void 0===i&&void 0!==e&&(i=e,e=null);const n=Array.isArray(t)?t:[t];for(let t=0;t<n.length;t++){const e=n[t];"string"==typeof e?n[t]={url:e,__isNative__:!0}:(e.type&&(e.ext=`.${e.type}`,e.type=void 0),e.url&&(e.__isNative__=!0))}const s=[],r=[];lw.loadAny(n,null,((t,i,n)=>{n.content&&(cw.includes(n.ext)?s.push(n.content):hw.includes(n.ext)&&r.push(n.content)),e&&e(t,i,n)}),((t,e)=>{let o=null;if(!t){e=Array.isArray(e)?e:[e];for(let t=0;t<e.length;t++){const i=e[t];if(!(i instanceof xu)){let o=i;const a=n[t].url;s.includes(o)?qT.create(a,i,".png",{},((i,n)=>{o=e[t]=n})):r.includes(o)&&qT.create(a,i,".mp3",{},((i,n)=>{o=e[t]=n})),q_.add(a,o)}}if(e.length>1){const t=Object.create(null);e.forEach((e=>{t[e._uuid]=e})),o={isCompleted:_w,_map:t}}else o=e[0]}i&&i(t,o)}))}getXMLHttpRequest(){return new XMLHttpRequest}getItem(t){return lw.assets.has(t)?{content:lw.assets.get(t)}:null}loadRes(t,e,i,n){const{type:s,onProgress:r,onComplete:o}=this._parseLoadResArgs(e,i,n),a=pn(t);a&&!ET.getInfoWithPath(t,s)&&(t=t.slice(0,-a.length)),ET.load(t,s,r,o)}loadResArray(t,e,i,n){const{type:s,onProgress:r,onComplete:o}=this._parseLoadResArgs(e,i,n);t.forEach(((e,i)=>{const n=pn(e);n&&!ET.getInfoWithPath(e,s)&&(t[i]=e.slice(0,-n.length))})),ET.load(t,s,r,o)}loadResDir(t,e,i,n){const{type:s,onProgress:r,onComplete:o}=this._parseLoadResArgs(e,i,n);ET.loadDir(t,s,r,((e,i)=>{let n=[];e||(n=ET.getDirWithPath(t,s).map((t=>t.path))),o&&o(e,i,n)}))}getRes(t,e){return q_.has(t)?q_.get(t):ET.get(t,e)}getResCount(){return q_.count}getDependsRecursively(t){if(!t)return[];const e="string"==typeof t?t:t._uuid;return km.getDepsRecursively(e).concat([e])}get md5Pipe(){return uw}get downloader(){return VT}get loader(){return lw.parser}addDownloadHandlers(t){const e=Object.create(null);for(const i in t){const n=t[i];e[`.${i}`]=(t,e,i)=>{n({url:t},i)}}VT.register(e)}addLoadHandlers(t){const e=Object.create(null);for(const i in t){const n=t[i];e[`.${i}`]=(t,e,i)=>{n({content:t},i)}}QT.register(e)}release(t){if(Array.isArray(t))for(let e=0;e<t.length;e++){let i=t[e];"string"==typeof i&&(i=q_.get(i)),lw.releaseAsset(i)}else t&&("string"==typeof t&&(t=q_.get(t)),lw.releaseAsset(t))}releaseAsset(t){lw.releaseAsset(t)}releaseRes(t,e){ET.release(t,e)}releaseAll(){lw.releaseAll(),q_.clear()}removeItem(t){return!!q_.remove(t)}setAutoRelease(t,e){"object"==typeof t&&(t=t._uuid),this._autoReleaseSetting[t]=!!e}setAutoReleaseRecursively(t,e){"object"==typeof t&&(t=t._uuid),e=!!e,this._autoReleaseSetting[t]=e;const i=km.getDepsRecursively(t);for(let t=0;t<i.length;t++)this._autoReleaseSetting[i[t]]=e}isAutoRelease(t){return"object"==typeof t&&(t=t._uuid),!!this._autoReleaseSetting[t]}}t("CCLoader",mw);const dw=t("loader",new mw),pw=t("AssetLibrary",{init(t){t.importBase=t.libraryPath,t.nativeBase=t.rawAssetsBase,lw.init(t),t.rawAssets&&ET.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:eu.RESOURCES,importBase:t.importBase,nativeBase:t.nativeBase,paths:t.rawAssets.assets,uuids:Object.keys(t.rawAssets.assets)})},loadAsset(t,e,i){lw.loadAny(t,e)}}),fw=t("url",{});z(fw,"url",[{name:"normalize",target:lw.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:t=>t.startsWith("resources/")?mu({path:vn(t.substr(10)),bundle:eu.RESOURCES,__isNative__:!0,ext:pn(t)}):""}]),V(pw,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),V(dw,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),z(n,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:()=>dw},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:()=>pw},{name:"Pipeline",target:aw,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:()=>fw}]),V(n,"cc",[{name:"LoadingItems",suggest:I(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),z(qt,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:VT,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),z(aT,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:t=>{var e;return lw.main?null===(e=lw.main.getSceneInfo(t))||void 0===e?void 0:e.uuid:""}}]),z(Lv,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:()=>{const t=[];return lw.main&&lw.main.config.scenes.forEach((e=>{t.push(e)})),t}}]);const gw=dT._autoRelease;var yw,vw,xw,Sw,Aw,Cw,bw,Tw,ww,Ew,Pw,Iw,Dw;dT._autoRelease=function(t,e,i){gw.call(dT,t,e,i);const n=dw._autoReleaseSetting,s=Object.keys(n);for(let t=0;t<s.length;t++){const e=s[t];if(!0===n[e]){const t=q_.get(e);t&&dT.tryRelease(t)}}};let Rw=t("EventHandler",(yw=u_("cc.ClickEvent"),vw=H_(n.Node),xw=I_(),Sw=I_(),Aw=I_(),Cw=I_(),yw((ww=n_((Tw=class t{constructor(){i_(this,"target",ww,this),i_(this,"component",Ew,this),i_(this,"_componentId",Pw,this),i_(this,"handler",Iw,this),i_(this,"customEventData",Dw,this)}get _componentName(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)}set _componentName(t){this._componentId=this._compName2Id(t)}static emitEvents(e,...i){for(let n=0,s=e.length;n<s;n++){const s=e[n];s instanceof t&&s.emit(i)}}emit(t){const e=this.target;if(!n.isValid(e))return;this._genCompIdIfNeeded();const i=n.js._getClassById(this._componentId),s=e.getComponent(i);if(!n.isValid(s))return;const r=s[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(t=t.slice()).push(this.customEventData),r.apply(s,t))}_compName2Id(t){const e=n.js.getClassByName(t);return n.js._getClassId(e)}_compId2Name(t){const e=n.js._getClassById(t);return n.js.getClassName(e)}_genCompIdIfNeeded(){this._componentId||(this._componentName=this.component,this.component="")}}).prototype,"target",[g_,vw,xw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ew=n_(Tw.prototype,"component",[g_,w_,Sw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Pw=n_(Tw.prototype,"_componentId",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Iw=n_(Tw.prototype,"handler",[g_,w_,Aw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Dw=n_(Tw.prototype,"customEventData",[g_,w_,Cw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bw=Tw))||bw));var Mw,Bw,Ow,Nw,Lw,Fw,zw,Vw,Uw,Gw,Hw,kw,jw,Ww,qw,Xw,Yw,Kw,Jw,$w,Zw,Qw,tE,eE,iE,nE,sE,rE,oE,aE,lE,cE,hE,_E,uE,mE,dE,pE,fE,gE,yE,vE,xE,SE,AE,CE,bE,TE,wE,EE,PE,IE,DE,RE,ME,BE,OE,NE,LE,FE,zE,VE,UE,GE,HE,kE,jE;n.Component.EventHandler=Rw;const WE=new oi,qE=Gt(Uh),XE=Gt(Vh),YE=Gt(Gh),KE=Gt(kh),JE=Gt(Hh),$E=Gt({SKYBOX:Jh|Co.DEPTH_STENCIL,SOLID_COLOR:Co.ALL,DEPTH_ONLY:Co.DEPTH_STENCIL,DONT_CLEAR:Co.NONE});let ZE=(Mw=u_("cc.Camera"),Bw=T_(),Ow=S_(),Nw=N_(),Lw=I_(),Fw=H_(Ec.BitMask),zw=N_(),Vw=I_(),Uw=H_($E),Gw=N_(),Hw=I_(),kw=N_(),jw=I_(),Ww=N_(),qw=I_(),Xw=N_(),Yw=I_(),Kw=H_(qE),Jw=N_(),$w=I_(),Zw=H_(XE),Qw=N_(),tE=I_(),eE=N_(),iE=I_(),nE=N_(),sE=I_(),rE=N_(),oE=I_(),aE=N_(),lE=I_(),cE=H_(YE),hE=N_(),_E=I_(),uE=H_(KE),mE=N_(),dE=I_(),pE=H_(JE),fE=N_(),gE=I_(),yE=N_(),vE=I_(),xE=H_(Jy),SE=N_(),AE=I_(),QE=Mw(CE=Bw(CE=Ow(CE=x_((jE=kE=class extends Nm{constructor(...t){super(...t),i_(this,"_projection",TE,this),i_(this,"_priority",wE,this),i_(this,"_fov",EE,this),i_(this,"_fovAxis",PE,this),i_(this,"_orthoHeight",IE,this),i_(this,"_near",DE,this),i_(this,"_far",RE,this),i_(this,"_color",ME,this),i_(this,"_depth",BE,this),i_(this,"_stencil",OE,this),i_(this,"_clearFlags",NE,this),i_(this,"_rect",LE,this),i_(this,"_aperture",FE,this),i_(this,"_shutter",zE,this),i_(this,"_iso",VE,this),i_(this,"_screenScale",UE,this),i_(this,"_visibility",GE,this),i_(this,"_targetTexture",HE,this),this._camera=null,this._inEditorMode=!1,this._flows=void 0}get camera(){return this._camera}get priority(){return this._priority}set priority(t){this._priority=t,this._camera&&(this._camera.priority=t)}get visibility(){return this._visibility}set visibility(t){this._visibility=t,this._camera&&(this._camera.visibility=t)}get clearFlags(){return this._clearFlags}set clearFlags(t){this._clearFlags=t,this._camera&&(this._camera.clearFlag=t)}get clearColor(){return this._color}set clearColor(t){this._color.set(t),this._camera&&(this._camera.clearColor=this._color)}get clearDepth(){return this._depth}set clearDepth(t){this._depth=t,this._camera&&(this._camera.clearDepth=t)}get clearStencil(){return this._stencil}set clearStencil(t){this._stencil=t,this._camera&&(this._camera.clearStencil=t)}get projection(){return this._projection}set projection(t){this._projection=t,this._camera&&(this._camera.projectionType=t)}get fovAxis(){return this._fovAxis}set fovAxis(t){t!==this._fovAxis&&(this._fovAxis=t,this._camera&&(this._camera.fovAxis=t,t===Vh.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}get fov(){return this._fov}set fov(t){this._fov=t,this._camera&&(this._camera.fov=ke(t))}get orthoHeight(){return this._orthoHeight}set orthoHeight(t){this._orthoHeight=t,this._camera&&(this._camera.orthoHeight=t)}get near(){return this._near}set near(t){this._near=t,this._camera&&(this._camera.nearClip=t)}get far(){return this._far}set far(t){this._far=t,this._camera&&(this._camera.farClip=t)}get aperture(){return this._aperture}set aperture(t){this._aperture=t,this._camera&&(this._camera.aperture=t)}get shutter(){return this._shutter}set shutter(t){this._shutter=t,this._camera&&(this._camera.shutter=t)}get iso(){return this._iso}set iso(t){this._iso=t,this._camera&&(this._camera.iso=t)}get rect(){return this._rect}set rect(t){this._rect=t,this._camera&&(this._camera.viewport=t)}get targetTexture(){return this._targetTexture}set targetTexture(t){if(this._targetTexture===t)return;const e=this._targetTexture;this._targetTexture=t,this._chechTargetTextureEvent(e),this._updateTargetTexture(),!t&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0)}get screenScale(){return this._screenScale}set screenScale(t){this._screenScale=t,this._camera&&(this._camera.screenScale=t)}get inEditorMode(){return this._inEditorMode}set inEditorMode(t){this._inEditorMode=t,this._camera&&this._camera.changeTargetWindow(t?n.director.root&&n.director.root.mainWindow:n.director.root&&n.director.root.tempWindow)}onLoad(){this._createCamera()}onEnable(){this.node.hasChangedFlags|=t_.POSITION,this._camera&&this._attachToScene()}onDisable(){this._camera&&this._detachFromScene()}onDestroy(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}screenPointToRay(t,e,i){return i||(i=Dr.create()),this._camera&&this._camera.screenPointToRay(i,t,e),i}worldToScreen(t,e){return e||(e=new oi),this._camera&&this._camera.worldToScreen(e,t),e}screenToWorld(t,e){return e||(e=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(e,t),e}convertToUINode(t,e,i){if(i||(i=new oi),!this._camera)return i;this.worldToScreen(t,WE);const s=e.getComponent("cc.UITransform"),r=kv.getVisibleSize(),o=WE.x-.5*this._camera.width,a=WE.y-.5*this._camera.height;return WE.x=o/n.view.getScaleX()+.5*r.width,WE.y=a/n.view.getScaleY()+.5*r.height,s&&s.convertToNodeSpaceAR(WE,i),i}_createCamera(){this._camera||(this._camera=n.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?n.director.root&&n.director.root.mainWindow:n.director.root&&n.director.root.tempWindow,priority:this._priority}),this._camera.viewport=this._rect,this._camera.fovAxis=this._fovAxis,this._camera.fov=ke(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()}_attachToScene(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))}_detachFromScene(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)}_chechTargetTextureEvent(t){t&&t.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(t=>{this._camera&&this._camera.setFixedSize(t.width,t.height)}),this)}_updateTargetTexture(){if(this._camera&&this._targetTexture){const t=this._targetTexture.window;this._camera.changeTargetWindow(t),this._camera.setFixedSize(t.width,t.height)}}},kE.ProjectionType=qE,kE.FOVAxis=XE,kE.ClearFlag=$E,kE.Aperture=YE,kE.Shutter=KE,kE.ISO=JE,TE=n_((bE=jE).prototype,"_projection",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qE.PERSPECTIVE}}),wE=n_(bE.prototype,"_priority",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EE=n_(bE.prototype,"_fov",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),PE=n_(bE.prototype,"_fovAxis",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XE.VERTICAL}}),IE=n_(bE.prototype,"_orthoHeight",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),DE=n_(bE.prototype,"_near",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),RE=n_(bE.prototype,"_far",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),ME=n_(bE.prototype,"_color",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new si("#333333")}}),BE=n_(bE.prototype,"_depth",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),OE=n_(bE.prototype,"_stencil",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NE=n_(bE.prototype,"_clearFlags",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $E.SOLID_COLOR}}),LE=n_(bE.prototype,"_rect",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Oi(0,0,1,1)}}),FE=n_(bE.prototype,"_aperture",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YE.F16_0}}),zE=n_(bE.prototype,"_shutter",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KE.D125}}),VE=n_(bE.prototype,"_iso",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return JE.ISO100}}),UE=n_(bE.prototype,"_screenScale",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),GE=n_(bE.prototype,"_visibility",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zh}}),HE=n_(bE.prototype,"_targetTexture",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),n_(bE.prototype,"priority",[Nw,Lw],Object.getOwnPropertyDescriptor(bE.prototype,"priority"),bE.prototype),n_(bE.prototype,"visibility",[Fw,zw,Vw],Object.getOwnPropertyDescriptor(bE.prototype,"visibility"),bE.prototype),n_(bE.prototype,"clearFlags",[Uw,Gw,Hw],Object.getOwnPropertyDescriptor(bE.prototype,"clearFlags"),bE.prototype),n_(bE.prototype,"clearColor",[kw,jw],Object.getOwnPropertyDescriptor(bE.prototype,"clearColor"),bE.prototype),n_(bE.prototype,"clearDepth",[Ww,qw],Object.getOwnPropertyDescriptor(bE.prototype,"clearDepth"),bE.prototype),n_(bE.prototype,"clearStencil",[Xw,Yw],Object.getOwnPropertyDescriptor(bE.prototype,"clearStencil"),bE.prototype),n_(bE.prototype,"projection",[Kw,Jw,$w],Object.getOwnPropertyDescriptor(bE.prototype,"projection"),bE.prototype),n_(bE.prototype,"fovAxis",[Zw,Qw,tE],Object.getOwnPropertyDescriptor(bE.prototype,"fovAxis"),bE.prototype),n_(bE.prototype,"fov",[eE,iE],Object.getOwnPropertyDescriptor(bE.prototype,"fov"),bE.prototype),n_(bE.prototype,"orthoHeight",[nE,sE],Object.getOwnPropertyDescriptor(bE.prototype,"orthoHeight"),bE.prototype),n_(bE.prototype,"near",[rE,oE],Object.getOwnPropertyDescriptor(bE.prototype,"near"),bE.prototype),n_(bE.prototype,"far",[aE,lE],Object.getOwnPropertyDescriptor(bE.prototype,"far"),bE.prototype),n_(bE.prototype,"aperture",[cE,hE,_E],Object.getOwnPropertyDescriptor(bE.prototype,"aperture"),bE.prototype),n_(bE.prototype,"shutter",[uE,mE,dE],Object.getOwnPropertyDescriptor(bE.prototype,"shutter"),bE.prototype),n_(bE.prototype,"iso",[pE,fE,gE],Object.getOwnPropertyDescriptor(bE.prototype,"iso"),bE.prototype),n_(bE.prototype,"rect",[yE,vE],Object.getOwnPropertyDescriptor(bE.prototype,"rect"),bE.prototype),n_(bE.prototype,"targetTexture",[xE,SE,AE],Object.getOwnPropertyDescriptor(bE.prototype,"targetTexture"),bE.prototype),CE=bE))||CE)||CE)||CE)||CE,t({Camera:QE,CameraComponent:QE}),QE);var QE,tP,eP,iP,nP,sP,rP,oP,aP,lP;n.Camera=ZE;const cP={parent:null,owner:null,subModelIdx:0};let hP=t("RenderableComponent",(tP=u_("cc.RenderableComponent"),eP=H_([ov]),iP=H_(ov),nP=N_(),sP=P_(),tP((aP=n_((oP=class extends Nm{constructor(...t){super(...t),i_(this,"_materials",aP,this),i_(this,"_visFlags",lP,this),this._materialInstances=[],this._models=[]}get visibility(){return this._visFlags}set visibility(t){this._visFlags=t,this._onVisibilityChange(t)}get sharedMaterials(){return this._materials}set sharedMaterials(t){for(let e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(let e=t.length;e<this._materials.length;e++)this.setMaterial(null,e);this._materials.splice(t.length)}}get materials(){for(let t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances}set materials(t){const e=t.length-this._materials.length;if(e>0)this._materials.length=t.length,this._materialInstances.length=t.length;else if(e<0)for(let t=this._materials.length-e;t<this._materials.length;++t)this.setMaterialInstance(t,null);for(let e=0;e<this._materialInstances.length;e++)this._materialInstances[e]!=t[e]&&this.setMaterialInstance(e,t[e])}get sharedMaterial(){return this.getMaterial(0)}getMaterial(t){return t<0||t>=this._materials.length?null:this._materials[t]}setMaterial(t,e){t&&t instanceof lv&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;const i=this._materialInstances[e];i?i.parent!==this._materials[e]&&(i.destroy(),this._materialInstances[e]=null,this._onMaterialModified(e,this._materials[e])):this._onMaterialModified(e,this._materials[e])}get material(){return this.getMaterialInstance(0)}set material(t){1===this._materials.length&&this._materials[0]===t||this.setMaterialInstance(0,t)}getMaterialInstance(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){cP.parent=this._materials[t],cP.owner=this,cP.subModelIdx=t;const e=new lv(cP);this.setMaterialInstance(t,e)}return this._materialInstances[t]}setMaterialInstance(t,e){e&&e.parent?e!==this._materialInstances[t]&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):e!==this._materials[t]&&this.setMaterial(e,t)}getRenderMaterial(t){return this._materialInstances[t]||this._materials[t]}_collectModels(){return this._models}_attachToScene(){}_detachFromScene(){}_onMaterialModified(t,e){}_onRebuildPSO(t,e){}_clearMaterials(){}_onVisibilityChange(t){}}).prototype,"_materials",[eP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lP=n_(oP.prototype,"_visFlags",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ec.Enum.NONE}}),n_(oP.prototype,"sharedMaterials",[iP,nP,sP],Object.getOwnPropertyDescriptor(oP.prototype,"sharedMaterials"),oP.prototype),rP=oP))||rP));var _P,uP,mP,dP,pP,fP;function gP(t){return"string"==typeof t||"number"==typeof t}function yP(t,e){return t instanceof e}n.RenderableComponent=hP,z(ZE,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),z(ZE.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),n.CameraComponent=ZE,Vt.setClassAlias(ZE,"cc.CameraComponent");let vP=u_("cc.animation.HierarchyPath")((mP=n_((uP=class{constructor(t){i_(this,"path",mP,this),this.path=t||""}get(t){if(!(t instanceof uf))return m("Target of hierarchy path should be of type Node."),null;return t.getChildByPath(this.path)||(m(`Node "${t.name}" has no path "${this.path}"`),null)}}).prototype,"path",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_P=uP))||_P,xP=u_("cc.animation.ComponentPath")((fP=n_((pP=class{constructor(t){i_(this,"component",fP,this),this.component=t||""}get(t){if(!(t instanceof uf))return m("Target of component path should be of type Node."),null;return t.getComponent(this.component)||(m(`Node "${t.name}" has no component "${this.component}"`),null)}}).prototype,"component",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),dP=pP))||dP;function SP(t,...e){let i=t;for(let t=0;t<e.length;++t){const n=e[t];if(gP(n)){if(!(n in i))return m(`Target object has no property "${n}"`),null;i=i[n]}else i=n.get(i);if(null===i)break}return i}var AP,CP,bP,TP,wP;let EP=u_("cc.animation.UniformProxyFactory")((bP=n_((CP=class{constructor(t,e){i_(this,"passIndex",bP,this),i_(this,"uniformName",TP,this),i_(this,"channelIndex",wP,this),this.passIndex=e||0,this.uniformName=t||""}forTarget(t){const e=t.passes[this.passIndex],i=e.getHandle(this.uniformName);if(!i)throw new Error(`Material "${t.name}" has no uniform "${this.uniformName}"`);const s=Vd.getPropertyTypeFromHandle(i);if(s===ud.BUFFER){const n=void 0===this.channelIndex?i:e.getHandle(this.uniformName,this.channelIndex,qr.FLOAT);if(!n)throw new Error(`Uniform "${this.uniformName} (in material ${t.name}) has no channel ${this.channelIndex}"`);return function(t,e){for(const i of t.shaderInfo.blocks)for(const t of i.members)if(t.name===e)return t.count>1;return!1}(e,this.uniformName)?{set:t=>{e.setUniformArray(n,t)}}:{set:t=>{e.setUniform(n,t)}}}if(s===ud.TEXTURE){const t=Vd.getBindingFromHandle(i),s=e.properties[this.uniformName],r=s&&s.value?`${s.value}-texture`:Ad(s.type);let o=Bd.get(r);return o||(m(`Illegal texture default value: ${r}.`),o=Bd.get("default-texture")),{set:i=>{i||(i=o);const s=i.getGFXTexture();s&&s.width&&s.height&&(e.bindTexture(t,s),i instanceof $u&&e.bindSampler(t,Fu.getSampler(n.game._gfxDevice,i.getSamplerHash())))}}}throw new Error(`Animations are not available for uniforms with property type ${s}.`)}}).prototype,"passIndex",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),TP=n_(CP.prototype,"uniformName",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wP=n_(CP.prototype,"channelIndex",[V_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),AP=CP))||AP;var PP,IP,DP,RP;let MP=u_("cc.animation.MorphWeightsValueProxy")((DP=n_((IP=class{constructor(){i_(this,"subMeshIndex",DP,this)}forTarget(t){return{set:e=>{t.setWeights(e,this.subMeshIndex)}}}}).prototype,"subMeshIndex",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PP=IP))||PP,BP=u_("cc.animation.MorphWeightsAllValueProxy")(RP=class{forTarget(t){return{set:e=>{var i,n;const s=null!==(i=null===(n=t.mesh)||void 0===n?void 0:n.struct.primitives.length)&&void 0!==i?i:0;for(let i=0;i<s;++i)t.setWeights(e,i)}}}})||RP;var OP,NP,LP,FP,zP;function VP(t,e,i,n){var s,r,o,a,l;let c=new e,h=new e,_=new e,u=u_(t)((o=n_((r=class{constructor(t,i,n){i_(this,"dataPoint",o,this),i_(this,"inTangent",a,this),i_(this,"outTangent",l,this),this.dataPoint=t||new e,this.inTangent=i||new e,this.outTangent=n||new e}lerp(t,e,s){const r=this.dataPoint,o=t.dataPoint;h=i(h,this.inTangent,s),_=i(_,t.outTangent,s);const a=e*e*e,l=e*e,u=a-2*l+e,m=-2*a+3*l,d=a-l;return c=i(c,r,2*a-3*l+1),c=n(c,c,h,u),c=n(c,c,o,m),c=n(c,c,_,d),c}getNoLerp(){return this.dataPoint}}).prototype,"dataPoint",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),a=n_(r.prototype,"inTangent",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),l=n_(r.prototype,"outTangent",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),s=r))||s;if(e===mi){const t=u.prototype.lerp;u.prototype.lerp=function(e,i,n){const s=t.call(this,e,i,n);return mi.normalize(s,s),s}}return u}const UP=t("CubicSplineVec2Value",VP("cc.CubicSplineVec2Value",Ti,Ti.multiplyScalar,Ti.scaleAndAdd));n.CubicSplineVec2Value=UP;const GP=t("CubicSplineVec3Value",VP("cc.CubicSplineVec3Value",oi,oi.multiplyScalar,oi.scaleAndAdd));n.CubicSplineVec3Value=GP;const HP=t("CubicSplineVec4Value",VP("cc.CubicSplineVec4Value",Ii,Ii.multiplyScalar,Ii.scaleAndAdd));n.CubicSplineVec4Value=HP;const kP=t("CubicSplineQuatValue",VP("cc.CubicSplineQuatValue",mi,mi.multiplyScalar,mi.scaleAndAdd));n.CubicSplineQuatValue=kP;let jP=t("CubicSplineNumberValue",u_("cc.CubicSplineNumberValue")((LP=n_((NP=class{constructor(t,e,i){i_(this,"dataPoint",LP,this),i_(this,"inTangent",FP,this),i_(this,"outTangent",zP,this),this.dataPoint=t,this.inTangent=e,this.outTangent=i}lerp(t,e,i){const n=this.dataPoint,s=t.dataPoint,r=e*e*e,o=e*e;return n*(2*r-3*o+1)+this.outTangent*i*(r-2*o+e)+s*(-2*r+3*o)+t.inTangent*i*(r-o)}getNoLerp(){return this.dataPoint}}).prototype,"dataPoint",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FP=n_(NP.prototype,"inTangent",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zP=n_(NP.prototype,"outTangent",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OP=NP))||OP);function WP(t,e,i=1e-6){let n=0,s=t.length-1,r=s>>>1;for(;n<=s;r=n+s>>>1){const o=t[r];if(o>e+i)s=r-1;else{if(!(o<e-i))return r;n=r+1}}return~n}function qP(t,e,i,n,s){const r=1-s;return r*(r*(t+(3*e-t)*s)+3*i*s*s)+n*s*s*s}n.CubicSplineNumberValue=jP,t("animation",Object.freeze({__proto__:null,UniformProxyFactory:EP,MorphWeightsValueProxy:MP,MorphWeightsAllValueProxy:BP,isPropertyPath:gP,isCustomPath:yP,HierarchyPath:vP,ComponentPath:xP,evaluatePath:SP,CubicSplineVec2Value:UP,CubicSplineVec3Value:GP,CubicSplineVec4Value:HP,CubicSplineQuatValue:kP,CubicSplineNumberValue:jP})),n.bezier=qP;const XP=Math.cos,YP=Math.acos,KP=Math.max,JP=2*Math.PI,$P=Math.sqrt;function ZP(t){return t<0?-Math.pow(-t,1/3):Math.pow(t,1/3)}function QP(t,e){const i=function(t,e){const i=e-0,n=e-t[0],s=3*i,r=3*n,o=3*(e-t[2]),a=1/(-i+r-o+(e-1)),l=1/3,c=(s-6*n+o)*a,h=c*l,_=(-s+r)*a,u=(3*_-c*c)*l,m=u*l,d=(2*c*c*c-9*c*_+i*a*27)/27,p=d/2,f=p*p+m*m*m;let g,y,v,x,S;if(f<0){const t=-u*l,e=$P(t*t*t),i=-d/(2*e),n=YP(i<-1?-1:i>1?1:i),s=2*ZP(e);return v=s*XP(n*l)-h,x=s*XP((n+JP)*l)-h,S=s*XP((n+2*JP)*l)-h,v>=0&&v<=1?x>=0&&x<=1?S>=0&&S<=1?KP(v,x,S):KP(v,x):S>=0&&S<=1?KP(v,S):v:x>=0&&x<=1?S>=0&&S<=1?KP(x,S):x:S}if(0===f)return g=p<0?ZP(-p):-ZP(p),v=2*g-h,x=-g-h,v>=0&&v<=1?x>=0&&x<=1?KP(v,x):v:x;{const t=$P(f);return g=ZP(-p+t),y=ZP(p+t),v=g-y-h,v}}(t,e),n=t[1];return((1-i)*(n+(t[3]-n)*i)*3+i*i)*i}n.bezierByTime=QP;class tI{constructor(t){let e,i;this.ratios=void 0,this._findRatio=void 0,this.ratios=t;let n=!0;for(let s=1,r=t.length;s<r;s++)if(e=t[s]-t[s-1],1===s)i=e;else if(Math.abs(e-i)>1e-6){n=!1;break}this._findRatio=n?sI:WP}sample(t){return this._findRatio(this.ratios,t)}}t("RatioSampler",tI),n.RatioSampler=tI;class eI{static Bezier(t){return t}constructor(t,e){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=e,this._values=t.values;const i=t=>"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?eI.Linear:eI.Bezier(t):eI.Linear;if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(const e of Object.keys(t.easingMethods))this.types[e]=i(t.easingMethods[e])}else this.type=null;const n=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=rI(n)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}hasLerp(){return!!this._lerp}valueAt(t){if(void 0===this._array){const e=this._values[t];return e&&e.getNoLerp?e.getNoLerp():e}for(let e=0;e<this._array.length;++e)this._array[e]=this._values[this._array.length*t+e];return this._array}valueBetween(t,e,i,n,s){if(this._lerp){const r=this.types?this.types[e]:this.type,o=s-i;let a=(t-i)/o;if(r&&(a=nI(a,r)),void 0===this._array){const t=this._values[e],i=this._values[n];return this._lerp(t,i,a,o*this._duration)}for(let t=0;t<this._array.length;++t){const i=this._values[this._array.length*e+t],s=this._values[this._array.length*n+t];this._array[t]=this._lerp(i,s,a,o*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(e);for(let t=0;t<this._array.length;++t)this._array[t]=this._values[this._array.length*e+t];return this._array}empty(){return 0===this._values.length}constant(){return 1===this._values.length}}function iI(t,e,i){let n=e.sample(i);if(n<0)if(n=~n,n<=0)n=0;else{if(!(n>=e.ratios.length))return t.valueBetween(i,n-1,e.ratios[n-1],n,e.ratios[n]);n=e.ratios.length-1}return t.valueAt(n)}function nI(t,e){if("string"==typeof e){const i=qx[e];i?t=i(t):T(3906,e)}else Array.isArray(e)&&(t=QP(e,t));return t}function sI(t,e){const i=t.length-1;if(0===i)return 0;const n=t[0];if(e<n)return 0;const s=t[i];if(e>s)return i;const r=(e=(e-n)/(s-n))/(1/i),o=0|r,a=1e-6;return r-o<a?o:o+1-r<a?o+1:~(o+1)}t("AnimCurve",eI),eI.Linear=null,n.AnimCurve=eI,t("EventInfo",class{constructor(){this.events=[]}add(t,e){this.events.push({func:t||"",params:e||[]})}}),n.sampleAnimationCurve=iI;const rI=(()=>{function t(t,e,i,n){return t.lerp(e,i,n)}return e=>{if(null!==e){if("number"==typeof e)return He;if("object"==typeof e&&e.constructor){if(e instanceof mi)return function(){const t=new mi;return(e,i,n)=>mi.slerp(t,e,i,n)}();if(e instanceof Wt)return function(t){const e=new t;return(i,n,s)=>(t.lerp(e,i,n,s),e)}(e.constructor);if(e.constructor===Number)return He;if("function"==typeof e.lerp)return t}}}})();class oI{static getOrExtract(t){let e=oI.pool.get(t);return e&&e.info.sample===t.sample||(e&&n.director.root.dataPoolManager.releaseAnimationClip(t),e=function(t){const e={};t.curves.forEach((t=>{if(!t.valueAdapter&&yP(t.modifiers[0],vP)&&gP(t.modifiers[1])){const{path:i}=t.modifiers[0];let n=e[i];n||(n=e[i]={}),n[t.modifiers[1]]={values:t.data.values,keys:t.data.keys}}}));const i=Math.ceil(t.sample*t.duration)+1;for(const n of Object.keys(e)){const s=e[n];s&&Object.defineProperty(s,"worldMatrix",{get:()=>{if(!s._worldMatrix){const{position:r,rotation:o,scale:a}=s;aI(t,r,i),aI(t,o,i),aI(t,a,i),lI(e,n,s)}return s._worldMatrix}})}return{info:{frames:i,sample:t.sample},data:e}}(t),oI.pool.set(t,e)),e}static destroy(t){oI.pool.delete(t)}}function aI(t,e,i){const n=t.keys[e.keys],s=[];if(n&&1!==n.length){const r=e.values[0]instanceof mi;for(let o=0,a=0;o<i;o++){let i=o/t.sample;for(;n[a]<=i;)a++;a>n.length-1?(a=n.length-1,i=n[a]):0===a&&(a=1);const l=e.values[a-1].clone(),c=n[a]-n[a-1],h=c?Ge((i-n[a-1])/c):1;r?l.slerp(e.values[a],h):l.lerp(e.values[a],h),s[o]=l}}else for(let t=0;t<i;t++)s[t]=e.values[0].clone();e.values=s}function lI(t,e,i){const n=i.position.values,s=i.rotation.values,r=i.scale.values,o=n.map((()=>new Si)),a=e.lastIndexOf("/");let l=null;if(a>0){const i=t[e.substring(0,a)];if(!i)return void console.warn("no data for parent bone?");l=i.worldMatrix.values}for(let t=0;t<n.length;t++){const e=n[t],i=s[t],a=r[t],c=o[t];Si.fromRTS(c,i,e,a),l&&Si.multiply(c,l[t],c)}Object.keys(i).forEach((t=>delete i[t])),i._worldMatrix={keys:0,interpolate:!1,values:o}}var cI,hI,_I,uI,mI,dI,pI,fI,gI,yI,vI,xI,SI,AI,CI;oI.pool=new Map;let bI=t("AnimationClip",u_("cc.AnimationClip")((CI=AI=class t extends xu{constructor(...t){super(...t),i_(this,"sample",_I,this),i_(this,"speed",uI,this),i_(this,"wrapMode",mI,this),i_(this,"events",dI,this),i_(this,"enableTrsBlending",pI,this),i_(this,"_duration",fI,this),i_(this,"_keys",gI,this),i_(this,"_stepness",yI,this),i_(this,"_curves",vI,this),i_(this,"_commonTargets",xI,this),i_(this,"_hash",SI,this),this.frameRate=0,this._ratioSamplers=[],this._runtimeCurves=void 0,this._runtimeEvents=void 0,this._data=null}static createWithSpriteFrames(e,i){if(!Array.isArray(e))return T(3905),null;const n=new t;n.sample=i||n.sample,n.duration=e.length/n.sample;const s=1/n.sample,r=new Array(e.length),o=new Array(r.length);for(let t=0;t<e.length;t++)r[t]=t*s,o[t]=e[t];return n.keys=[r],n.curves=[{modifiers:[new xP("cc.Sprite"),"spriteFrame"],data:{keys:0,values:o}}],n}get duration(){return this._duration}set duration(t){this._duration=t}get keys(){return this._keys}set keys(t){this._keys=t}get eventGroups(){return this._runtimeEvents||this._createRuntimeEvents(),this._runtimeEvents.eventGroups}get stepness(){return this._stepness}set stepness(t){this._stepness=t,this._applyStepness()}get hash(){if(this._hash)return this._hash;const t=this._nativeAsset,e=new Uint8Array(ArrayBuffer.isView(t)?t.buffer:t);return this._hash=qa(e,666)}get curves(){return this._curves}set curves(t){this._curves=t,delete this._runtimeCurves}get data(){return this._data}get commonTargets(){return this._commonTargets}set commonTargets(t){this._commonTargets=t}onLoaded(){this.frameRate=this.sample,this._decodeCVTAs()}getPropertyCurves(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}updateEventDatas(){delete this._runtimeEvents}getEventGroupIndexAtRatio(t){return this._runtimeEvents||this._createRuntimeEvents(),WP(this._runtimeEvents.ratios,t)}hasEvents(){return 0!==this.events.length}destroy(){return n.director.root.dataPoolManager&&n.director.root.dataPoolManager.releaseAnimationClip(this),oI.destroy(this),super.destroy()}_createPropertyCurves(){this._ratioSamplers=this._keys.map((t=>new tI(t.map((t=>t/this._duration))))),this._runtimeCurves=this._curves.map((t=>({curve:new eI(t.data,this._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:this._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}))),this._applyStepness()}_createRuntimeEvents(){const t=[],e=[],i=this.events.sort(((t,e)=>t.frame-e.frame));for(const n of i){const i=n.frame/this._duration;let s=t.findIndex((t=>t===i));s<0&&(s=t.length,t.push(i),e.push({events:[]})),e[s].events.push({functionName:n.func,parameters:n.params})}this._runtimeEvents={ratios:t,eventGroups:e}}_applyStepness(){}_decodeCVTAs(){const t=ArrayBuffer.isView(this._nativeAsset)?this._nativeAsset.buffer:this._nativeAsset;if(!t)return;const e=this._keys;for(let i=0;i<e.length;++i){const n=e[i];n instanceof bS&&(e[i]=n.decompress(t))}for(let e=0;e<this._curves.length;++e){const i=this._curves[e];i.data.values instanceof bS&&(i.data.values=i.data.values.decompress(t))}}validate(){return this.keys.length>0&&this.curves.length>0}},AI.WrapMode=yc,_I=n_((hI=CI).prototype,"sample",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),uI=n_(hI.prototype,"speed",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mI=n_(hI.prototype,"wrapMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yc.Normal}}),dI=n_(hI.prototype,"events",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pI=n_(hI.prototype,"enableTrsBlending",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fI=n_(hI.prototype,"_duration",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gI=n_(hI.prototype,"_keys",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yI=n_(hI.prototype,"_stepness",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vI=n_(hI.prototype,"_curves",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xI=n_(hI.prototype,"_commonTargets",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),SI=n_(hI.prototype,"_hash",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cI=hI))||cI);function TI(t,e,i){const n=e[e.length-1];if(0!==e.length&&gP(n)&&!i){const i=SP(t,...e.slice(0,e.length-1));return null===i?null:{setValue:t=>{i[n]=t},getValue:()=>i[n]}}if(i){const n=SP(t,...e);if(null===n)return null;const s=i.forTarget(n);return{setValue:t=>{s.set(t)},getValue:()=>s.get?s.get():(d("Target doesn't provide a get method."),null)}}return d("Empty animation curve."),null}function wI(t,e,i){const n=TI(t,e,i);if(null===n)return null;const s=n.getValue(),r=PI(s);if(!r)return d("Value is not copyable!"),null;const o=r.createBuffer(),a=r.copy;return Object.assign(n,{peek:()=>o,pull:()=>{const t=n.getValue();a(o,t)},push:()=>{n.setValue(o)}})}function EI(t,e){return t.set(e)}n.AnimationClip=bI;const PI=(()=>{const t=new Map;return t.set(Ti,{createBuffer:()=>new Ti,copy:Ti.copy}),t.set(oi,{createBuffer:()=>new oi,copy:oi.copy}),t.set(Ii,{createBuffer:()=>new Ii,copy:Ii.copy}),t.set(si,{createBuffer:()=>new si,copy:si.copy}),t.set(Mi,{createBuffer:()=>new Mi,copy:EI}),e=>t.get(null==e?void 0:e.constructor)})();class II{constructor(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get isMotionless(){return!this.isPlaying||this.isPaused}play(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(I(3912)):(this._isPlaying=!0,this.onPlay())}stop(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}pause(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}resume(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}step(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}update(t){}onPlay(){}onPause(){}onResume(){}onStop(){}onError(t){}}class DI{constructor(){this._nodeBlendStates=new Map,this._states=new Set}ref(t,e){let i=this._nodeBlendStates.get(t);i||(i={dirty:!1,properties:{}},this._nodeBlendStates.set(t,i));let n=i.properties[e];return n||(n=i.properties[e]=new MI(i,RI(e)?new oi:new mi)),++n.refCount,n}deRef(t,e){const i=this._nodeBlendStates.get(t);if(!i)return;const n=i.properties[e];n&&(--n.refCount,n.refCount>0||(delete i.properties[e],function(t){return!(t.properties.position||t.properties.rotation||t.properties.eulerAngles||t.properties.scale)}(i)&&this._nodeBlendStates.delete(t)))}apply(){this._nodeBlendStates.forEach(((t,e)=>{if(!t.dirty)return;t.dirty=!1;const{position:i,scale:n,rotation:s,eulerAngles:r}=t.properties;let o,a,l,c=!1;i&&0!==i.weight&&(i.weight=0,o=i.value,c=!0),n&&0!==n.weight&&(n.weight=0,a=n.value,c=!0),s&&0!==s.weight&&(s.weight=0,l=s.value,c=!0),r&&0!==r.weight&&(r.weight=0,l=r.value,c=!0),c&&e.setRTS(l,o,a)})),this._states.forEach((t=>{t.onBlendFinished()}))}bindState(t){this._states.add(t)}unbindState(t){this._states.delete(t)}}function RI(t){return!function(t){return"rotation"===t}(t)}class MI{constructor(t,e){this.weight=0,this.value=void 0,this.refCount=0,this._node=void 0,this._node=t,this.value=e}markAsDirty(){this._node.dirty=!0}}function BI(t,e,i){return 0===i.weight&&oi.zero(i.value),0===e?i.value:1===e?oi.copy(i.value,t):oi.scaleAndAdd(i.value,i.value,t,e)}function OI(t,e,i){if(0===i.weight&&mi.identity(i.value),0===e)return i.value;if(1===e)return mi.copy(i.value,t);const n=e/(i.weight+e);return mi.slerp(i.value,i.value,t,n)}let NI;!function(t){t.PLAY="play",t.STOP="stop",t.PAUSE="pause",t.RESUME="resume",t.LASTFRAME="lastframe",t.FINISHED="finished"}(NI||(NI={})),jt(NI);class LI{constructor(t,e,i){this.commonTargetIndex=void 0,this._curve=void 0,this._boundTarget=void 0,this._rootTargetProperty=void 0,this._curveDetail=void 0,this._curve=t.curve,this._curveDetail=t,this._boundTarget=i,this._shouldLerp=t.curve.hasLerp()}applySample(t,e,i,n,s){let r;r=this._shouldLerp&&i?this._curve.valueBetween(t,n.from,n.fromRatio,n.to,n.toRatio):this._curve.valueAt(e),this._setValue(r,s)}_setValue(t,e){this._boundTarget.setValue(t)}get propertyName(){return this._rootTargetProperty||""}get curveDetail(){return this._curveDetail}}class FI extends II{get clip(){return this._clip}get name(){return this._name}get length(){return this.duration}get wrapMode(){return this._wrapMode}set wrapMode(t){this._wrapMode=t,this.time=0,t&gc.Loop?this.repeatCount=1/0:this.repeatCount=1}get repeatCount(){return this._repeatCount}set repeatCount(t){this._repeatCount=t;const e=this._wrapMode&gc.ShouldWrap,i=(this.wrapMode&gc.Reverse)===gc.Reverse;this._process=t!==1/0||e||i?this.process:this.simpleProcess}get delay(){return this._delay}set delay(t){this._delayTime=this._delay=t}get playbackRange(){return this._playbackRange}set playbackRange(t){t.max,t.min,this._playbackRange.min=Math.max(t.min,0),this._playbackRange.max=Math.min(t.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}get current(){return this.getWrappedInfo(this.time).time}get ratio(){return this.current/this.duration}constructor(t,e=""){super(),this.duration=1,this.speed=1,this.time=0,this.weight=0,this.frameRate=0,this._targetNode=null,this._curveLoaded=!1,this._clip=void 0,this._process=this.process,this._samplerSharedGroups=[],this._target=null,this._ignoreIndex=-1,this._commonTargetStatuses=[],this._wrapMode=yc.Normal,this._repeatCount=1,this._delay=0,this._delayTime=0,this._currentFramePlayed=!1,this._name=void 0,this._lastIterations=void 0,this._lastWrapInfo=null,this._lastWrapInfoEvent=null,this._wrappedInfo=new vc,this._blendStateBuffer=null,this._blendStateWriters=[],this._allowLastFrame=!1,this._blendStateWriterHost={weight:0,enabled:!1},this._playbackRange=void 0,this._playbackDuration=0,this._invDuration=1,this._clip=t,this._name=e||t&&t.name,this._playbackRange={min:0,max:this._clip.duration},this._playbackDuration=t.duration,t.duration||f(`Clip ${t.name} has zero duration.`)}get curveLoaded(){return this._curveLoaded}initialize(t,e){var i,s;if(this._curveLoaded)return;this._curveLoaded=!0,this._destroyBlendStateWriters(),this._samplerSharedGroups.length=0,this._blendStateBuffer=null!==(i=null===(s=n.director.getAnimationManager())||void 0===s?void 0:s.blendState)&&void 0!==i?i:null,this._blendStateBuffer&&this._blendStateBuffer.bindState(this),this._targetNode=t;const r=this._clip;this.duration=r.duration,this._invDuration=1/this.duration,this.speed=r.speed,this.wrapMode=r.wrapMode,this.frameRate=r.sample,this._playbackRange={min:0,max:r.duration},this._playbackDuration=r.duration,(this.wrapMode&gc.Loop)===gc.Loop?this.repeatCount=1/0:this.repeatCount=1;const o=(t,e,i,n,s)=>{if(!(r.enableTrsBlending&&function(t){let e;if(1===t.length&&"string"==typeof t[0])e=t[0];else if(t.length>1){for(let e=0;e<t.length-1;++e)if(!(t[e]instanceof vP))return!1;e=t[t.length-1]}switch(e){case"position":case"scale":case"rotation":case"eulerAngles":return!0;default:return!1}}(i)&&this._blendStateBuffer))return t(e,i,n);{const n=SP(e,...i.slice(0,i.length-1));if(null!==n&&n instanceof uf){const r=i[i.length-1],o=function(t,e,i,n,s){const r=RI(i)?BI:OI;let o=t.ref(e,i),a=!1,l=-1;return{destroy(){o&&(t.deRef(e,i),o=null)},forTarget:()=>({get:()=>e[i],set:t=>{if(!o||!n.enabled)return;const e=n.weight;if(s)if(1!==e||e!==l)a=!1;else if(a)return;r(t,e,o),o.weight+=e,o.markAsDirty(),a=!0,l=e}})}}(this._blendStateBuffer,n,r,this._blendStateWriterHost,s);return this._blendStateWriters.push(o),t(e,[],o)}}return null};this._commonTargetStatuses=r.commonTargets.map((e=>{const i=o(wI,t,e.modifiers,e.valueAdapter,!1);return null===i?null:{target:i,changed:!1}})),e||(e=r.getPropertyCurves());for(let i=0;i<e.length;++i){const n=e[i];if(n.curve.empty())continue;let s,r=this._samplerSharedGroups.find((t=>t.sampler===n.sampler));if(r||(r={sampler:n.sampler,curves:[],samplerResultCache:{from:0,fromRatio:0,to:0,toRatio:0}},this._samplerSharedGroups.push(r)),void 0===n.commonTarget)s=t;else{const t=this._commonTargetStatuses[n.commonTarget];if(!t)continue;s=t.target.peek()}const a=o(TI,s,n.modifiers,n.valueAdapter,n.curve.constant());if(null===a);else{const t=new LI(n,s,a);t.commonTargetIndex=n.commonTarget,r.curves.push(t)}}}destroy(){this._destroyBlendStateWriters()}onBlendFinished(){this._blendStateWriterHost.enabled=!1}emit(...t){n.director.getAnimationManager().pushDelayEvent(this._emit,this,t)}on(t,e,i){return this._target&&this._target.isValid?this._target.on(t,e,i):null}once(t,e,i){return this._target&&this._target.isValid?this._target.once(t,e,i):null}off(t,e,i){this._target&&this._target.isValid&&this._target.off(t,e,i)}allowLastFrameEvent(t){this._allowLastFrame=t}_setEventTarget(t){this._target=t}setTime(t){this._currentFramePlayed=!1,this.time=t||0;{this._lastWrapInfoEvent=null,this._ignoreIndex=-1;const e=this.getWrappedInfo(t,this._wrappedInfo),i=e.direction;let n=this._clip.getEventGroupIndexAtRatio(e.ratio);n<0&&(n=~n-1,i<0&&(n+=1),this._ignoreIndex=n)}}update(t){this._delayTime>0&&(this._delayTime-=t,this._delayTime>0)||(this._currentFramePlayed?this.time+=t*this.speed:this._currentFramePlayed=!0,this._process())}sample(){const t=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(t.ratio),this._sampleEvents(t),t}onPlay(){this.setTime(0),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(NI.PLAY,this)}onStop(){this.isPaused||this._onPauseOrStop(),this.emit(NI.STOP,this)}onResume(){this._onReplayOrResume(),this.emit(NI.RESUME,this)}onPause(){this._onPauseOrStop(),this.emit(NI.PAUSE,this)}_sampleCurves(t){this._blendStateWriterHost.weight=this.weight,this._blendStateWriterHost.enabled=!0;const e=this._commonTargetStatuses;for(let t=0,i=e.length;t<i;++t){const i=e[t];i&&(i.target.pull(),i.changed=!1)}let i=0,n=!1;const s=this._samplerSharedGroups;for(let r=0,o=s.length;r<o;++r){const o=s[r],{sampler:a,samplerResultCache:l}=o;n=!1,a?(i=a.sample(t),i<0&&(i=~i,i<=0?i=0:i>=a.ratios.length?i=a.ratios.length-1:(n=!0,l.from=i-1,l.fromRatio=a.ratios[l.from],l.to=i,l.toRatio=a.ratios[l.to],i=l.from))):i=0;const c=o.curves;for(let s=0,r=c.length;s<r;++s){const r=c[s];if(r.applySample(t,i,n,l,this.weight),void 0!==r.commonTargetIndex){const t=e[r.commonTargetIndex];t&&(t.changed=!0)}}}for(let t=0,i=e.length;t<i;++t){const i=e[t];i&&i.changed&&i.target.push()}}process(){const t=this.sample();if(this._allowLastFrame){let e;e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new vc(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(NI.LASTFRAME,this),e.set(t)}t.stopped&&(this.stop(),this.emit(NI.FINISHED,this))}simpleProcess(){const t=this._playbackRange.min,e=this._playbackDuration;let i=this.time%e;i<0&&(i+=e);const n=(t+i)*this._invDuration;this._sampleCurves(n),this._clip.hasEvents()&&this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(void 0===this._lastIterations&&(this._lastIterations=n),(this.time>0&&this._lastIterations>n||this.time<0&&this._lastIterations<n)&&this.emit(NI.LASTFRAME,this),this._lastIterations=n)}cache(t){}_needReverse(t){const e=this.wrapMode;let i=!1;return(e&gc.PingPong)===gc.PingPong&&(t-(0|t)==0&&t>0&&(t-=1),1&t&&(i=!i)),(e&gc.Reverse)===gc.Reverse&&(i=!i),i}getWrappedInfo(t,e){e=e||new vc;const i=this._getPlaybackStart(),n=this._getPlaybackEnd()-i;let s=!1;const r=this.repeatCount;let o=t>0?t/n:-t/n;if(o>=r){o=r,s=!0;let e=r-(0|r);0===e&&(e=1),t=e*n*(t>0?1:-1)}if(t>n){const e=t%n;t=0===e?n:e}else t<0&&0!=(t%=n)&&(t+=n);let a=!1;const l=this._wrapMode&gc.ShouldWrap;l&&(a=this._needReverse(o));let c=a?-1:1;return this.speed<0&&(c*=-1),l&&a&&(t=n-t),e.time=i+t,e.ratio=e.time/this.duration,e.direction=c,e.stopped=s,e.iterations=o,e}_getPlaybackStart(){return this._playbackRange.min}_getPlaybackEnd(){return this._playbackRange.max}_sampleEvents(t){const e=this._clip.eventGroups.length;let i=t.direction,s=this._clip.getEventGroupIndexAtRatio(t.ratio);if(s<0&&(s=~s-1,i<0&&(s+=1)),this._ignoreIndex!==s&&(this._ignoreIndex=-1),t.frameIndex=s,!this._lastWrapInfoEvent)return this._fireEvent(s),void(this._lastWrapInfoEvent=new vc(t));const r=this.wrapMode,o=zI(t.iterations),a=this._lastWrapInfoEvent;let l=zI(a.iterations),c=a.frameIndex;const h=a.direction,_=-1!==l&&o!==l;if(c===s&&_&&1===e)this._fireEvent(0);else if(c!==s||_){i=h;do{if(c!==s){if(-1===i&&0===c&&s>0?((r&gc.PingPong)===gc.PingPong?i*=-1:c=e,l++):1===i&&c===e-1&&s<e-1&&((r&gc.PingPong)===gc.PingPong?i*=-1:c=-1,l++),c===s)break;if(l>o)break}c+=i,n.director.getAnimationManager().pushDelayEvent(this._fireEvent,this,[c])}while(c!==s&&c>-1&&c<e)}this._lastWrapInfoEvent.set(t)}_emit(t,e){this._target&&this._target.isValid&&this._target.emit(t,t,e)}_fireEvent(t){if(!this._targetNode||!this._targetNode.isValid)return;const{eventGroups:e}=this._clip;if(t<0||t>=e.length||this._ignoreIndex===t)return;const i=e[t],n=this._targetNode.components;for(const t of i.events){const{functionName:e}=t;for(const i of n){const n=i[e];"function"==typeof n&&n.apply(i,t.parameters)}}}_onReplayOrResume(){n.director.getAnimationManager().addAnimation(this)}_onPauseOrStop(){n.director.getAnimationManager().removeAnimation(this)}_destroyBlendStateWriters(){for(let t=0;t<this._blendStateWriters.length;++t)this._blendStateWriters[t].destroy();this._blendStateWriters.length=0,this._blendStateBuffer&&(this._blendStateBuffer.unbindState(this),this._blendStateBuffer=null),this._blendStateWriterHost.enabled=!1}}function zI(t){return t-(0|t)==0&&(t-=1),0|t}t("AnimationState",FI),n.AnimationState=FI;class VI extends II{constructor(){super(),this._managedStates=[],this._fadings=[]}update(t){if(this.isMotionless)return;const e=this._managedStates,i=this._fadings;if(1===e.length&&1===i.length){const t=e[0].state;t&&(t.weight=1)}else this._calculateWeights(t);for(let t=0;t<e.length;++t){const i=e[t].state;i&&i.isMotionless&&i.sample()}}crossFade(t,e){var i;0===this._managedStates.length&&(e=0),0===e&&this.clear();let n=this._managedStates.find((e=>e.state===t));n?(null===(i=n.state)||void 0===i?void 0:i.isMotionless)&&n.state.play():(n={state:t,reference:0},t&&t.play(),this._managedStates.push(n)),++n.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:n})}clear(){for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.stop()}this._managedStates.length=0,this._fadings.length=0}onPlay(){super.onPlay(),n.director.getAnimationManager().addCrossFade(this)}onPause(){super.onPause(),n.director.getAnimationManager().removeCrossFade(this);for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.pause()}}onResume(){super.onResume(),n.director.getAnimationManager().addCrossFade(this);for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.resume()}}onStop(){super.onStop(),n.director.getAnimationManager().removeCrossFade(this),this.clear()}_calculateWeights(t){const e=this._managedStates;this._fadings;for(let t=0;t<e.length;++t){const i=e[t].state;i&&(i.weight=0)}let i=1,n=this._fadings.length;for(let e=0;e<this._fadings.length;++e){const s=this._fadings[e];s.easeTime+=t;const r=0===s.easeDuration?1:Ge(s.easeTime/s.easeDuration),o=r*i;if(i*=1-r,s.target.state&&(s.target.state.weight+=o),s.easeTime>=s.easeDuration){n=e+1,s.easeTime=s.easeDuration;break}}if(n!==this._fadings.length){for(let t=n;t<this._fadings.length;++t){const e=this._fadings[t];--e.target.reference,e.target.reference<=0&&(e.target.state&&e.target.state.stop(),J(this._managedStates,e.target))}this._fadings.splice(n)}}}var UI,GI,HI,kI,jI,WI,qI,XI,YI,KI,JI,$I,ZI,QI,tD,eD,iD;let nD=function(e){return t({AnimationComponent:e,Animation:e}),e}((UI=u_("cc.Animation"),GI=T_(),HI=d_(99),kI=S_(),jI=H_([bI]),WI=I_(),qI=H_(bI),XI=I_(),YI=I_(),KI=H_([bI]),UI(JI=GI(JI=HI(JI=x_(JI=kI((iD=eD=class extends($i(Nm)){constructor(...t){super(...t),i_(this,"playOnLoad",ZI,this),this._crossFade=new VI,this._nameToState=ht(!0),i_(this,"_clips",QI,this),i_(this,"_defaultClip",tD,this),this._hasBeenPlayed=!1}get clips(){return this._clips}set clips(t){this._crossFade&&this._crossFade.clear();for(const t of this._clips)t&&this._removeStateOfAutomaticClip(t);for(const e of t)e&&this.createState(e);const e=t.find((t=>sD(t,this._defaultClip)));this._defaultClip=e||null,this._clips=t}get defaultClip(){return this._defaultClip}set defaultClip(t){this._defaultClip=t,t&&(this._clips.findIndex((e=>sD(e,t)))>=0||(this._clips.push(t),this.createState(t)))}onLoad(){this.clips=this._clips;for(const t in this._nameToState)this._nameToState[t].initialize(this.node)}start(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}onEnable(){this._crossFade.resume()}onDisable(){this._crossFade.pause()}onDestroy(){this._crossFade.stop();for(const t in this._nameToState)this._nameToState[t].destroy();this._nameToState=ht(!0)}play(t){if(this._hasBeenPlayed=!0,!t){if(!this._defaultClip)return;t=this._defaultClip.name}this.crossFade(t,0)}crossFade(t,e=.3){this._hasBeenPlayed=!0;const i=this._nameToState[t];i&&(this._crossFade.play(),this._crossFade.crossFade(i,e))}pause(){this._crossFade.pause()}resume(){this._crossFade.resume()}stop(){this._crossFade.stop()}getAnimationState(t){return this.getState(t)}getState(t){const e=this._nameToState[t];return e&&!e.curveLoaded&&e.initialize(this.node),e||null}createState(t,e){return e=e||t.name,this.removeState(e),this._doCreateState(t,e)}removeState(t){const e=this._nameToState[t];e&&(e.allowLastFrameEvent(!1),e.stop(),delete this._nameToState[t])}addClip(t,e){return $(this._clips,t)||this._clips.push(t),this.createState(t,e)}removeClip(t,e){let i;for(const e in this._nameToState){const n=this._nameToState[e];if(n.clip===t){i=n;break}}if(t===this._defaultClip){if(!e)return void C(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!e)return void C(3903);i.stop()}this._clips=this._clips.filter((e=>e!==t)),i&&delete this._nameToState[i.name]}on(t,e,i,n){const s=super.on(t,e,i,n);return t===NI.LASTFRAME&&this._syncAllowLastFrameEvent(),s}once(t,e,i){const n=super.once(t,e,i);return t===NI.LASTFRAME&&this._syncAllowLastFrameEvent(),n}off(t,e,i){super.off(t,e,i),t===NI.LASTFRAME&&this._syncDisallowLastFrameEvent()}_createState(t,e){return new FI(t,e)}_doCreateState(t,e){const i=this._createState(t,e);return i._setEventTarget(this),i.allowLastFrameEvent(this.hasEventListener(NI.LASTFRAME)),this.node&&i.initialize(this.node),this._nameToState[i.name]=i,i}_getStateByNameOrDefaultClip(t){if(!t){if(!this._defaultClip)return null;t=this._defaultClip.name}return this._nameToState[t]||null}_removeStateOfAutomaticClip(t){for(const e in this._nameToState){const i=this._nameToState[e];sD(t,i.clip)&&(i.stop(),delete this._nameToState[e])}}_syncAllowLastFrameEvent(){if(this.hasEventListener(NI.LASTFRAME))for(const t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!0)}_syncDisallowLastFrameEvent(){if(!this.hasEventListener(NI.LASTFRAME))for(const t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!1)}},eD.EventType=NI,n_(($I=iD).prototype,"clips",[jI,WI],Object.getOwnPropertyDescriptor($I.prototype,"clips"),$I.prototype),n_($I.prototype,"defaultClip",[qI,XI],Object.getOwnPropertyDescriptor($I.prototype,"defaultClip"),$I.prototype),ZI=n_($I.prototype,"playOnLoad",[g_,YI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),QI=n_($I.prototype,"_clips",[KI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tD=n_($I.prototype,"_defaultClip",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JI=$I))||JI)||JI)||JI)||JI)||JI));function sD(t,e){return t===e||!!t&&!!e&&t._uuid===e._uuid&&t._uuid}z(nD.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction(...t){const e=t[0];return nD.prototype.removeState.call(this,e.name)}}]),n.AnimationComponent=nD,Vt.setClassAlias(nD,"cc.AnimationComponent");const rD=[],oD=new Map;function aD(t,e){let i=0,n=Si.IDENTITY;for(;t;){if(t.stamp===e||t.stamp+1===e&&!t.node.hasChangedFlags){n=t.world,t.stamp=e;break}t.stamp=e,rD[i++]=t,t=t.parent}for(;i>0;){const e=(t=rD[--i]).node;Si.fromRTS(t.local,e.rotation,e.position,e.scale),n=Si.multiply(t.world,n,t.local)}return n}function lD(t,e){let i,n=null,s=0;for(;t!==e;){const e=t.uuid;if(oD.has(e)){n=oD.get(e);break}n={node:t,local:new Si,world:new Si,stamp:-1,parent:null},oD.set(e,n),rD[s++]=n,t=t.parent,n=null}for(;s>0;)i=rD[--s],i.parent=n,n=i;return n}function cD(t){let e=oD.get(t.uuid)||null;for(;e;)oD.delete(e.node.uuid),e=e.parent}var hD,_D,uD;let mD=t("AnimationManager",u_((uD=_D=class extends Kx{constructor(...t){super(...t),this._anims=new X([]),this._delayEvents=[],this._blendStateBuffer=new DI,this._crossFades=[],this._sockets=[]}get blendState(){return this._blendStateBuffer}addCrossFade(t){this._crossFades.push(t)}removeCrossFade(t){J(this._crossFades,t)}update(t){const{_delayEvents:e,_crossFades:i,_sockets:s}=this;for(let e=0,n=i.length;e<n;e++)i[e].update(t);const r=this._anims,o=r.array;for(r.i=0;r.i<o.length;++r.i){const e=o[r.i];e.isMotionless||e.update(t)}this._blendStateBuffer.apply();const a=n.director.getTotalFrames();for(let t=0,e=s.length;t<e;t++){const{target:e,transform:i}=s[t];e.matrix=aD(i,a)}for(let t=0,i=e.length;t<i;t++){const i=e[t];i.fn.apply(i.thisArg,i.args)}e.length=0}destruct(){}addAnimation(t){-1===this._anims.array.indexOf(t)&&this._anims.push(t)}removeAnimation(t){const e=this._anims.array.indexOf(t);e>=0?this._anims.fastRemoveAt(e):T(3907)}pushDelayEvent(t,e,i){this._delayEvents.push({fn:t,thisArg:e,args:i})}addSockets(t,e){for(let i=0;i<e.length;++i){const n=e[i];if(this._sockets.find((t=>t.target===n.target)))continue;const s=t.getChildByPath(n.path),r=n.target&&s&&lD(s,t);r&&this._sockets.push({target:n.target,transform:r})}}removeSockets(t,e){for(let t=0;t<e.length;++t){const i=e[t];for(let t=0;t<this._sockets.length;++t){const e=this._sockets[t];if(e.target===i.target){cD(e.transform.node),this._sockets[t]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}}}},_D.ID="animation",hD=uD))||hD);aT.on(oT.EVENT_INIT,(()=>{const t=new mD;aT.registerSystem(mD.ID,t,eS.PRIORITY_SYSTEM)})),n.AnimationManager=mD;const dD=new Si;var pD,fD,gD,yD;n.easing=qx;let vD=t("HierachyModifier",u_("cc.HierachyModifier")(pD=class extends vP{})||pD);n.HierachyModifier=vD;let xD=t("ComponentModifier",u_("cc.ComponentModifier")(fD=class extends xP{})||fD);n.ComponentModifier=xD;let SD=t("CurveValueAdapter",u_("cc.CurveValueAdapter")(gD=class{forTarget(t){return{set:()=>{}}}})||gD);n.CurveValueAdapter=SD;let AD,CD=t("UniformCurveValueAdapter",u_("cc.UniformCurveValueAdapter")(yD=class extends EP{})||yD);function bD(t){return"string"==typeof t}function TD(t){return"number"==typeof t}function wD(t,e){return t instanceof e}n.UniformCurveValueAdapter=CD,n.isPropertyModifier=bD,n.isElementModifier=TD,n.isCustomTargetModifier=wD,n.math=Li,n.geometry=Tc;class ED{constructor(t){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}size(){return this._pool.length}clear(){const t=this._pool.length;for(let e=0;e<t;++e)this._pool[e].destroy();this._pool.length=0}put(t){if(t&&-1===this._pool.indexOf(t)){t.removeFromParent();const e=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;e&&e.unuse&&e.unuse(),this._pool.push(t)}}get(...t){const e=this._pool.length-1;if(e<0)return null;{const t=this._pool[e];this._pool.length=e;const i=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;return i&&i.reuse&&i.reuse(arguments),t}}}t("NodePool",ED),n.NodePool=ED,n.renderer=dx;class PD extends Va{constructor(...t){super(...t),this._gpuDescriptorSet=null}get gpuDescriptorSet(){return this._gpuDescriptorSet}initialize(t){this._layout=t.layout;const{bindings:e,descriptorIndices:i,descriptorCount:n}=t.layout.gpuDescriptorSetLayout;this._buffers=Array(n).fill(null),this._textures=Array(n).fill(null),this._samplers=Array(n).fill(null);const s=[];this._gpuDescriptorSet={gpuDescriptors:s,descriptorIndices:i};for(let t=0;t<e.length;++t){const i=e[t];for(let t=0;t<i.count;t++)s.push({type:i.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})}return!0}destroy(){this._layout=null,this._gpuDescriptorSet=null}update(){if(this._isDirty&&this._gpuDescriptorSet){const t=this._gpuDescriptorSet.gpuDescriptors;for(let e=0;e<t.length;++e)if(t[e].type&Ca){const i=this._buffers[e];i&&(t[e].gpuBuffer=i.gpuBuffer||i.gpuBufferView)}else t[e].type&ba&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}}}function ID(t,e){switch(t){case jr.R8:return e.UNSIGNED_BYTE;case jr.R8SN:return e.BYTE;case jr.R8UI:return e.UNSIGNED_BYTE;case jr.R8I:return e.BYTE;case jr.R16F:return AD.HALF_FLOAT_OES;case jr.R16UI:return e.UNSIGNED_SHORT;case jr.R16I:return e.SHORT;case jr.R32F:return e.FLOAT;case jr.R32UI:return e.UNSIGNED_INT;case jr.R32I:return e.INT;case jr.RG8:return e.UNSIGNED_BYTE;case jr.RG8SN:return e.BYTE;case jr.RG8UI:return e.UNSIGNED_BYTE;case jr.RG8I:return e.BYTE;case jr.RG16F:return AD.HALF_FLOAT_OES;case jr.RG16UI:return e.UNSIGNED_SHORT;case jr.RG16I:return e.SHORT;case jr.RG32F:return e.FLOAT;case jr.RG32UI:return e.UNSIGNED_INT;case jr.RG32I:return e.INT;case jr.RGB8:case jr.SRGB8:return e.UNSIGNED_BYTE;case jr.RGB8SN:return e.BYTE;case jr.RGB8UI:return e.UNSIGNED_BYTE;case jr.RGB8I:return e.BYTE;case jr.RGB16F:return AD.HALF_FLOAT_OES;case jr.RGB16UI:return e.UNSIGNED_SHORT;case jr.RGB16I:return e.SHORT;case jr.RGB32F:return e.FLOAT;case jr.RGB32UI:return e.UNSIGNED_INT;case jr.RGB32I:return e.INT;case jr.BGRA8:case jr.RGBA8:case jr.SRGB8_A8:return e.UNSIGNED_BYTE;case jr.RGBA8SN:return e.BYTE;case jr.RGBA8UI:return e.UNSIGNED_BYTE;case jr.RGBA8I:return e.BYTE;case jr.RGBA16F:return AD.HALF_FLOAT_OES;case jr.RGBA16UI:return e.UNSIGNED_SHORT;case jr.RGBA16I:return e.SHORT;case jr.RGBA32F:return e.FLOAT;case jr.RGBA32UI:return e.UNSIGNED_INT;case jr.RGBA32I:return e.INT;case jr.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case jr.R11G11B10F:return e.FLOAT;case jr.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case jr.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case jr.RGB10A2:return e.UNSIGNED_BYTE;case jr.RGB10A2UI:return e.UNSIGNED_INT;case jr.RGB9E5:return e.UNSIGNED_BYTE;case jr.D16:return e.UNSIGNED_SHORT;case jr.D16S8:return AD.UNSIGNED_INT_24_8_WEBGL;case jr.D24:return e.UNSIGNED_INT;case jr.D24S8:return AD.UNSIGNED_INT_24_8_WEBGL;case jr.D32F:return e.UNSIGNED_INT;case jr.D32F_S8:return AD.UNSIGNED_INT_24_8_WEBGL;case jr.BC1:case jr.BC1_SRGB:case jr.BC2:case jr.BC2_SRGB:case jr.BC3:case jr.BC3_SRGB:case jr.BC4:return e.UNSIGNED_BYTE;case jr.BC4_SNORM:return e.BYTE;case jr.BC5:return e.UNSIGNED_BYTE;case jr.BC5_SNORM:return e.BYTE;case jr.BC6H_SF16:case jr.BC6H_UF16:return e.FLOAT;case jr.BC7:case jr.BC7_SRGB:case jr.ETC_RGB8:case jr.ETC2_RGB8:case jr.ETC2_SRGB8:case jr.ETC2_RGB8_A1:case jr.ETC2_SRGB8_A1:case jr.EAC_R11:return e.UNSIGNED_BYTE;case jr.EAC_R11SN:return e.BYTE;case jr.EAC_RG11:return e.UNSIGNED_BYTE;case jr.EAC_RG11SN:return e.BYTE;case jr.PVRTC_RGB2:case jr.PVRTC_RGBA2:case jr.PVRTC_RGB4:case jr.PVRTC_RGBA4:case jr.PVRTC2_2BPP:case jr.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case jr.ASTC_RGBA_4x4:case jr.ASTC_RGBA_5x4:case jr.ASTC_RGBA_5x5:case jr.ASTC_RGBA_6x5:case jr.ASTC_RGBA_6x6:case jr.ASTC_RGBA_8x5:case jr.ASTC_RGBA_8x6:case jr.ASTC_RGBA_8x8:case jr.ASTC_RGBA_10x5:case jr.ASTC_RGBA_10x6:case jr.ASTC_RGBA_10x8:case jr.ASTC_RGBA_10x10:case jr.ASTC_RGBA_12x10:case jr.ASTC_RGBA_12x12:case jr.ASTC_SRGBA_4x4:case jr.ASTC_SRGBA_5x4:case jr.ASTC_SRGBA_5x5:case jr.ASTC_SRGBA_6x5:case jr.ASTC_SRGBA_6x6:case jr.ASTC_SRGBA_8x5:case jr.ASTC_SRGBA_8x6:case jr.ASTC_SRGBA_8x8:case jr.ASTC_SRGBA_10x5:case jr.ASTC_SRGBA_10x6:case jr.ASTC_SRGBA_10x8:case jr.ASTC_SRGBA_10x10:case jr.ASTC_SRGBA_12x10:case jr.ASTC_SRGBA_12x12:default:return e.UNSIGNED_BYTE}}function DD(t,e){switch(t){case jr.A8:return e.ALPHA;case jr.L8:return e.LUMINANCE;case jr.LA8:return e.LUMINANCE_ALPHA;case jr.RGB8:case jr.RGB16F:case jr.RGB32F:return e.RGB;case jr.BGRA8:case jr.RGBA8:case jr.RGBA16F:case jr.RGBA32F:return e.RGBA;case jr.R5G6B5:return e.RGB565;case jr.RGB5A1:return e.RGB5_A1;case jr.RGBA4:return e.RGBA4;case jr.D16:return e.DEPTH_COMPONENT;case jr.D16S8:return e.DEPTH_STENCIL;case jr.D24:return e.DEPTH_COMPONENT;case jr.D24S8:return e.DEPTH_STENCIL;case jr.D32F:return e.DEPTH_COMPONENT;case jr.D32F_S8:return e.DEPTH_STENCIL;case jr.BC1:return AD.COMPRESSED_RGB_S3TC_DXT1_EXT;case jr.BC1_ALPHA:return AD.COMPRESSED_RGBA_S3TC_DXT1_EXT;case jr.BC1_SRGB:return AD.COMPRESSED_SRGB_S3TC_DXT1_EXT;case jr.BC1_SRGB_ALPHA:return AD.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case jr.BC2:return AD.COMPRESSED_RGBA_S3TC_DXT3_EXT;case jr.BC2_SRGB:return AD.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case jr.BC3:return AD.COMPRESSED_RGBA_S3TC_DXT5_EXT;case jr.BC3_SRGB:return AD.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case jr.ETC_RGB8:return AD.COMPRESSED_RGB_ETC1_WEBGL;case jr.ETC2_RGB8:return AD.COMPRESSED_RGB8_ETC2;case jr.ETC2_SRGB8:return AD.COMPRESSED_SRGB8_ETC2;case jr.ETC2_RGB8_A1:return AD.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case jr.ETC2_SRGB8_A1:return AD.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case jr.ETC2_RGBA8:return AD.COMPRESSED_RGBA8_ETC2_EAC;case jr.ETC2_SRGB8_A8:return AD.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case jr.EAC_R11:return AD.COMPRESSED_R11_EAC;case jr.EAC_R11SN:return AD.COMPRESSED_SIGNED_R11_EAC;case jr.EAC_RG11:return AD.COMPRESSED_RG11_EAC;case jr.EAC_RG11SN:return AD.COMPRESSED_SIGNED_RG11_EAC;case jr.PVRTC_RGB2:return AD.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case jr.PVRTC_RGBA2:return AD.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case jr.PVRTC_RGB4:return AD.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case jr.PVRTC_RGBA4:return AD.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case jr.ASTC_RGBA_4x4:return AD.COMPRESSED_RGBA_ASTC_4x4_KHR;case jr.ASTC_RGBA_5x4:return AD.COMPRESSED_RGBA_ASTC_5x4_KHR;case jr.ASTC_RGBA_5x5:return AD.COMPRESSED_RGBA_ASTC_5x5_KHR;case jr.ASTC_RGBA_6x5:return AD.COMPRESSED_RGBA_ASTC_6x5_KHR;case jr.ASTC_RGBA_6x6:return AD.COMPRESSED_RGBA_ASTC_6x6_KHR;case jr.ASTC_RGBA_8x5:return AD.COMPRESSED_RGBA_ASTC_8x5_KHR;case jr.ASTC_RGBA_8x6:return AD.COMPRESSED_RGBA_ASTC_8x6_KHR;case jr.ASTC_RGBA_8x8:return AD.COMPRESSED_RGBA_ASTC_8x8_KHR;case jr.ASTC_RGBA_10x5:return AD.COMPRESSED_RGBA_ASTC_10x5_KHR;case jr.ASTC_RGBA_10x6:return AD.COMPRESSED_RGBA_ASTC_10x6_KHR;case jr.ASTC_RGBA_10x8:return AD.COMPRESSED_RGBA_ASTC_10x8_KHR;case jr.ASTC_RGBA_10x10:return AD.COMPRESSED_RGBA_ASTC_10x10_KHR;case jr.ASTC_RGBA_12x10:return AD.COMPRESSED_RGBA_ASTC_12x10_KHR;case jr.ASTC_RGBA_12x12:return AD.COMPRESSED_RGBA_ASTC_12x12_KHR;case jr.ASTC_SRGBA_4x4:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case jr.ASTC_SRGBA_5x4:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case jr.ASTC_SRGBA_5x5:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case jr.ASTC_SRGBA_6x5:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case jr.ASTC_SRGBA_6x6:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case jr.ASTC_SRGBA_8x5:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case jr.ASTC_SRGBA_8x6:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case jr.ASTC_SRGBA_8x8:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case jr.ASTC_SRGBA_10x5:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case jr.ASTC_SRGBA_10x6:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case jr.ASTC_SRGBA_10x8:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case jr.ASTC_SRGBA_10x10:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case jr.ASTC_SRGBA_12x10:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case jr.ASTC_SRGBA_12x12:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}function RD(t,e){switch(t){case jr.A8:return e.ALPHA;case jr.L8:return e.LUMINANCE;case jr.LA8:return e.LUMINANCE_ALPHA;case jr.RGB8:case jr.RGB16F:case jr.RGB32F:return e.RGB;case jr.BGRA8:case jr.RGBA8:case jr.RGBA16F:case jr.RGBA32F:return e.RGBA;case jr.R5G6B5:return e.RGB;case jr.RGB5A1:case jr.RGBA4:return e.RGBA;case jr.D16:return e.DEPTH_COMPONENT;case jr.D16S8:return e.DEPTH_STENCIL;case jr.D24:return e.DEPTH_COMPONENT;case jr.D24S8:return e.DEPTH_STENCIL;case jr.D32F:return e.DEPTH_COMPONENT;case jr.D32F_S8:return e.DEPTH_STENCIL;case jr.BC1:return AD.COMPRESSED_RGB_S3TC_DXT1_EXT;case jr.BC1_ALPHA:return AD.COMPRESSED_RGBA_S3TC_DXT1_EXT;case jr.BC1_SRGB:return AD.COMPRESSED_SRGB_S3TC_DXT1_EXT;case jr.BC1_SRGB_ALPHA:return AD.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case jr.BC2:return AD.COMPRESSED_RGBA_S3TC_DXT3_EXT;case jr.BC2_SRGB:return AD.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case jr.BC3:return AD.COMPRESSED_RGBA_S3TC_DXT5_EXT;case jr.BC3_SRGB:return AD.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case jr.ETC_RGB8:return AD.COMPRESSED_RGB_ETC1_WEBGL;case jr.ETC2_RGB8:return AD.COMPRESSED_RGB8_ETC2;case jr.ETC2_SRGB8:return AD.COMPRESSED_SRGB8_ETC2;case jr.ETC2_RGB8_A1:return AD.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case jr.ETC2_SRGB8_A1:return AD.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case jr.ETC2_RGBA8:return AD.COMPRESSED_RGBA8_ETC2_EAC;case jr.ETC2_SRGB8_A8:return AD.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case jr.EAC_R11:return AD.COMPRESSED_R11_EAC;case jr.EAC_R11SN:return AD.COMPRESSED_SIGNED_R11_EAC;case jr.EAC_RG11:return AD.COMPRESSED_RG11_EAC;case jr.EAC_RG11SN:return AD.COMPRESSED_SIGNED_RG11_EAC;case jr.PVRTC_RGB2:return AD.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case jr.PVRTC_RGBA2:return AD.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case jr.PVRTC_RGB4:return AD.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case jr.PVRTC_RGBA4:return AD.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case jr.ASTC_RGBA_4x4:return AD.COMPRESSED_RGBA_ASTC_4x4_KHR;case jr.ASTC_RGBA_5x4:return AD.COMPRESSED_RGBA_ASTC_5x4_KHR;case jr.ASTC_RGBA_5x5:return AD.COMPRESSED_RGBA_ASTC_5x5_KHR;case jr.ASTC_RGBA_6x5:return AD.COMPRESSED_RGBA_ASTC_6x5_KHR;case jr.ASTC_RGBA_6x6:return AD.COMPRESSED_RGBA_ASTC_6x6_KHR;case jr.ASTC_RGBA_8x5:return AD.COMPRESSED_RGBA_ASTC_8x5_KHR;case jr.ASTC_RGBA_8x6:return AD.COMPRESSED_RGBA_ASTC_8x6_KHR;case jr.ASTC_RGBA_8x8:return AD.COMPRESSED_RGBA_ASTC_8x8_KHR;case jr.ASTC_RGBA_10x5:return AD.COMPRESSED_RGBA_ASTC_10x5_KHR;case jr.ASTC_RGBA_10x6:return AD.COMPRESSED_RGBA_ASTC_10x6_KHR;case jr.ASTC_RGBA_10x8:return AD.COMPRESSED_RGBA_ASTC_10x8_KHR;case jr.ASTC_RGBA_10x10:return AD.COMPRESSED_RGBA_ASTC_10x10_KHR;case jr.ASTC_RGBA_12x10:return AD.COMPRESSED_RGBA_ASTC_12x10_KHR;case jr.ASTC_RGBA_12x12:return AD.COMPRESSED_RGBA_ASTC_12x12_KHR;case jr.ASTC_SRGBA_4x4:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case jr.ASTC_SRGBA_5x4:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case jr.ASTC_SRGBA_5x5:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case jr.ASTC_SRGBA_6x5:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case jr.ASTC_SRGBA_6x6:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case jr.ASTC_SRGBA_8x5:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case jr.ASTC_SRGBA_8x6:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case jr.ASTC_SRGBA_8x8:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case jr.ASTC_SRGBA_10x5:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case jr.ASTC_SRGBA_10x6:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case jr.ASTC_SRGBA_10x8:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case jr.ASTC_SRGBA_10x10:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case jr.ASTC_SRGBA_12x10:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case jr.ASTC_SRGBA_12x12:return AD.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}function MD(t,e){switch(t){case qr.BOOL:return e.BOOL;case qr.BOOL2:return e.BOOL_VEC2;case qr.BOOL3:return e.BOOL_VEC3;case qr.BOOL4:return e.BOOL_VEC4;case qr.INT:return e.INT;case qr.INT2:return e.INT_VEC2;case qr.INT3:return e.INT_VEC3;case qr.INT4:return e.INT_VEC4;case qr.UINT:return e.UNSIGNED_INT;case qr.FLOAT:return e.FLOAT;case qr.FLOAT2:return e.FLOAT_VEC2;case qr.FLOAT3:return e.FLOAT_VEC3;case qr.FLOAT4:return e.FLOAT_VEC4;case qr.MAT2:return e.FLOAT_MAT2;case qr.MAT3:return e.FLOAT_MAT3;case qr.MAT4:return e.FLOAT_MAT4;case qr.SAMPLER2D:return e.SAMPLER_2D;case qr.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),qr.UNKNOWN}}function BD(t){switch(t){case qr.BOOL:case qr.BOOL2:case qr.BOOL3:case qr.BOOL4:case qr.INT:case qr.INT2:case qr.INT3:case qr.INT4:case qr.UINT:return Int32Array;case qr.FLOAT:case qr.FLOAT2:case qr.FLOAT3:case qr.FLOAT4:case qr.MAT2:case qr.MAT3:case qr.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function OD(t,e){switch(t){case e.BOOL:return qr.BOOL;case e.BOOL_VEC2:return qr.BOOL2;case e.BOOL_VEC3:return qr.BOOL3;case e.BOOL_VEC4:return qr.BOOL4;case e.INT:return qr.INT;case e.INT_VEC2:return qr.INT2;case e.INT_VEC3:return qr.INT3;case e.INT_VEC4:return qr.INT4;case e.UNSIGNED_INT:return qr.UINT;case e.FLOAT:return qr.FLOAT;case e.FLOAT_VEC2:return qr.FLOAT2;case e.FLOAT_VEC3:return qr.FLOAT3;case e.FLOAT_VEC4:return qr.FLOAT4;case e.FLOAT_MAT2:return qr.MAT2;case e.FLOAT_MAT3:return qr.MAT3;case e.FLOAT_MAT4:return qr.MAT4;case e.SAMPLER_2D:return qr.SAMPLER2D;case e.SAMPLER_CUBE:return qr.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),qr.UNKNOWN}}function ND(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function LD(t,e){switch(t){case e.FLOAT_MAT2:return 2;case e.FLOAT_MAT3:return 3;case e.FLOAT_MAT4:return 4;default:return 1}}!function(t){t[t.RGBA16F_EXT=34842]="RGBA16F_EXT",t[t.RGB16F_EXT=34843]="RGB16F_EXT",t[t.RGBA32F_EXT=34836]="RGBA32F_EXT",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",t[t.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",t[t.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",t[t.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(AD||(AD={}));const FD=[512,513,514,515,516,517,518,519],zD=[0,7680,7681,7682,7683,5386,34055,34056],VD=[32774,32778,32779,32775,32776],UD=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];let GD;!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(GD||(GD={}));class HD{constructor(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t}}class kD extends HD{constructor(){super(GD.BEGIN_RENDER_PASS),this.gpuRenderPass=null,this.gpuFramebuffer=null,this.renderArea=new Po,this.clearFlag=Co.NONE,this.clearColors=[],this.clearDepth=1,this.clearStencil=0}clear(){this.gpuFramebuffer=null,this.clearColors.length=0}}class jD extends HD{constructor(){super(GD.BIND_STATES),this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets=[],this.dynamicOffsets=[],this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=[],this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}clear(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants.length=0,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}class WD extends HD{constructor(){super(GD.DRAW),this.drawInfo=new Uo}clear(){}}class qD extends HD{constructor(){super(GD.UPDATE_BUFFER),this.gpuBuffer=null,this.buffer=null,this.offset=0,this.size=0}clear(){this.gpuBuffer=null,this.buffer=null}}class XD extends HD{constructor(){super(GD.COPY_BUFFER_TO_TEXTURE),this.gpuTexture=null,this.buffers=[],this.regions=[]}clear(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}class YD{constructor(){this.cmds=new Vi(1),this.beginRenderPassCmds=new Vi(1),this.bindStatesCmds=new Vi(1),this.drawCmds=new Vi(1),this.updateBufferCmds=new Vi(1),this.copyBufferToTextureCmds=new Vi(1)}clearCmds(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}function KD(t,e,i,n,s){if(e.usage&Xr.UNIFORM)ArrayBuffer.isView(i)?e.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):e.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(e.usage&Xr.INDIRECT)e.indirects.length=n,Array.prototype.push.apply(e.indirects,i.drawInfos);else{const r=i,{gl:o}=t,a=t.stateCache;switch(e.glTarget){case o.ARRAY_BUFFER:t.useVAO&&a.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=JD.gpuInputAssembler=null),t.stateCache.glArrayBuffer!==e.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer);break;case o.ELEMENT_ARRAY_BUFFER:t.useVAO&&a.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=JD.gpuInputAssembler=null),t.stateCache.glElementArrayBuffer!==e.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}s===r.byteLength?o.bufferSubData(e.glTarget,n,r):o.bufferSubData(e.glTarget,n,r.slice(0,s))}}const JD={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function $D(t,e,i,n,s,r,o){const{gl:a}=t,l=t.stateCache;let c=0;if(i&&e){l.glFramebuffer!==i.glFramebuffer&&(a.bindFramebuffer(a.FRAMEBUFFER,i.glFramebuffer),l.glFramebuffer=i.glFramebuffer),l.viewport.left===n.x&&l.viewport.top===n.y&&l.viewport.width===n.width&&l.viewport.height===n.height||(a.viewport(n.x,n.y,n.width,n.height),l.viewport.left=n.x,l.viewport.top=n.y,l.viewport.width=n.width,l.viewport.height=n.height),l.scissorRect.x===n.x&&l.scissorRect.y===n.y&&l.scissorRect.width===n.width&&l.scissorRect.height===n.height||(a.scissor(n.x,n.y,n.width,n.height),l.scissorRect.x=n.x,l.scissorRect.y=n.y,l.scissorRect.width=n.width,l.scissorRect.height=n.height);let h=s.length;t.WEBGL_draw_buffers||(h=1);for(let t=0;t<h;++t){const i=e.colorAttachments[t];if(i.format!==jr.UNKNOWN)switch(i.loadOp){case co.LOAD:break;case co.CLEAR:{l.bs.targets[0].blendColorMask!==ao.ALL&&a.colorMask(!0,!0,!0,!0);const t=s[0];a.clearColor(t.x,t.y,t.z,t.w),c|=a.COLOR_BUFFER_BIT;break}case co.DISCARD:}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==jr.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case co.LOAD:break;case co.CLEAR:l.dss.depthWrite||a.depthMask(!0),a.clearDepth(r),c|=a.DEPTH_BUFFER_BIT;break;case co.DISCARD:}if(Aa[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case co.LOAD:break;case co.CLEAR:l.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,65535),l.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,65535),a.clearStencil(o),c|=a.STENCIL_BUFFER_BIT;break;case co.DISCARD:}}if(c&&a.clear(c),c&a.COLOR_BUFFER_BIT){const t=l.bs.targets[0].blendColorMask;if(t!==ao.ALL){const e=(t&ao.R)!==ao.NONE,i=(t&ao.G)!==ao.NONE,n=(t&ao.B)!==ao.NONE,s=(t&ao.A)!==ao.NONE;a.colorMask(e,i,n,s)}}c&a.DEPTH_BUFFER_BIT&&!l.dss.depthWrite&&a.depthMask(!1),c&a.STENCIL_BUFFER_BIT&&(l.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,0),l.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,0))}}function ZD(t,e,i,n,s,r,o,a,l,c,h,_,u){const{gl:m}=t,p=t.stateCache,f=e&&e.gpuShader;let g,y,v,x=!1;if(e&&JD.gpuPipelineState!==e){if(JD.gpuPipelineState=e,JD.glPrimitive=e.glPrimitive,e.gpuShader){const{glProgram:t}=e.gpuShader;p.glProgram!==t&&(m.useProgram(t),p.glProgram=t,x=!0)}const{rs:t}=e;if(t){if(p.rs.cullMode!==t.cullMode){switch(t.cullMode){case go.NONE:m.disable(m.CULL_FACE);break;case go.FRONT:m.enable(m.CULL_FACE),m.cullFace(m.FRONT);break;case go.BACK:m.enable(m.CULL_FACE),m.cullFace(m.BACK)}p.rs.cullMode=t.cullMode}const e=t.isFrontFaceCCW;p.rs.isFrontFaceCCW!==e&&(m.frontFace(e?m.CCW:m.CW),p.rs.isFrontFaceCCW=e),p.rs.depthBias===t.depthBias&&p.rs.depthBiasSlop===t.depthBiasSlop||(m.polygonOffset(t.depthBias,t.depthBiasSlop),p.rs.depthBias=t.depthBias,p.rs.depthBiasSlop=t.depthBiasSlop),p.rs.lineWidth!==t.lineWidth&&(m.lineWidth(t.lineWidth),p.rs.lineWidth=t.lineWidth)}const{dss:i}=e;i&&(p.dss.depthTest!==i.depthTest&&(i.depthTest?m.enable(m.DEPTH_TEST):m.disable(m.DEPTH_TEST),p.dss.depthTest=i.depthTest),p.dss.depthWrite!==i.depthWrite&&(m.depthMask(i.depthWrite),p.dss.depthWrite=i.depthWrite),p.dss.depthFunc!==i.depthFunc&&(m.depthFunc(FD[i.depthFunc]),p.dss.depthFunc=i.depthFunc),p.dss.stencilTestFront===i.stencilTestFront&&p.dss.stencilTestBack===i.stencilTestBack||(i.stencilTestFront||i.stencilTestBack?m.enable(m.STENCIL_TEST):m.disable(m.STENCIL_TEST),p.dss.stencilTestFront=i.stencilTestFront,p.dss.stencilTestBack=i.stencilTestBack),p.dss.stencilFuncFront===i.stencilFuncFront&&p.dss.stencilRefFront===i.stencilRefFront&&p.dss.stencilReadMaskFront===i.stencilReadMaskFront||(m.stencilFuncSeparate(m.FRONT,FD[i.stencilFuncFront],i.stencilRefFront,i.stencilReadMaskFront),p.dss.stencilFuncFront=i.stencilFuncFront,p.dss.stencilRefFront=i.stencilRefFront,p.dss.stencilReadMaskFront=i.stencilReadMaskFront),p.dss.stencilFailOpFront===i.stencilFailOpFront&&p.dss.stencilZFailOpFront===i.stencilZFailOpFront&&p.dss.stencilPassOpFront===i.stencilPassOpFront||(m.stencilOpSeparate(m.FRONT,zD[i.stencilFailOpFront],zD[i.stencilZFailOpFront],zD[i.stencilPassOpFront]),p.dss.stencilFailOpFront=i.stencilFailOpFront,p.dss.stencilZFailOpFront=i.stencilZFailOpFront,p.dss.stencilPassOpFront=i.stencilPassOpFront),p.dss.stencilWriteMaskFront!==i.stencilWriteMaskFront&&(m.stencilMaskSeparate(m.FRONT,i.stencilWriteMaskFront),p.dss.stencilWriteMaskFront=i.stencilWriteMaskFront),p.dss.stencilFuncBack===i.stencilFuncBack&&p.dss.stencilRefBack===i.stencilRefBack&&p.dss.stencilReadMaskBack===i.stencilReadMaskBack||(m.stencilFuncSeparate(m.BACK,FD[i.stencilFuncBack],i.stencilRefBack,i.stencilReadMaskBack),p.dss.stencilFuncBack=i.stencilFuncBack,p.dss.stencilRefBack=i.stencilRefBack,p.dss.stencilReadMaskBack=i.stencilReadMaskBack),p.dss.stencilFailOpBack===i.stencilFailOpBack&&p.dss.stencilZFailOpBack===i.stencilZFailOpBack&&p.dss.stencilPassOpBack===i.stencilPassOpBack||(m.stencilOpSeparate(m.BACK,zD[i.stencilFailOpBack],zD[i.stencilZFailOpBack],zD[i.stencilPassOpBack]),p.dss.stencilFailOpBack=i.stencilFailOpBack,p.dss.stencilZFailOpBack=i.stencilZFailOpBack,p.dss.stencilPassOpBack=i.stencilPassOpBack),p.dss.stencilWriteMaskBack!==i.stencilWriteMaskBack&&(m.stencilMaskSeparate(m.BACK,i.stencilWriteMaskBack),p.dss.stencilWriteMaskBack=i.stencilWriteMaskBack));const{bs:n}=e;if(n){p.bs.isA2C!==n.isA2C&&(n.isA2C?m.enable(m.SAMPLE_ALPHA_TO_COVERAGE):m.disable(m.SAMPLE_ALPHA_TO_COVERAGE),p.bs.isA2C=n.isA2C),p.bs.blendColor.x===n.blendColor.x&&p.bs.blendColor.y===n.blendColor.y&&p.bs.blendColor.z===n.blendColor.z&&p.bs.blendColor.w===n.blendColor.w||(m.blendColor(n.blendColor.x,n.blendColor.y,n.blendColor.z,n.blendColor.w),p.bs.blendColor.x=n.blendColor.x,p.bs.blendColor.y=n.blendColor.y,p.bs.blendColor.z=n.blendColor.z,p.bs.blendColor.w=n.blendColor.w);const t=n.targets[0],e=p.bs.targets[0];e.blend!==t.blend&&(t.blend?m.enable(m.BLEND):m.disable(m.BLEND),e.blend=t.blend),e.blendEq===t.blendEq&&e.blendAlphaEq===t.blendAlphaEq||(m.blendEquationSeparate(VD[t.blendEq],VD[t.blendAlphaEq]),e.blendEq=t.blendEq,e.blendAlphaEq=t.blendAlphaEq),e.blendSrc===t.blendSrc&&e.blendDst===t.blendDst&&e.blendSrcAlpha===t.blendSrcAlpha&&e.blendDstAlpha===t.blendDstAlpha||(m.blendFuncSeparate(UD[t.blendSrc],UD[t.blendDst],UD[t.blendSrcAlpha],UD[t.blendDstAlpha]),e.blendSrc=t.blendSrc,e.blendDst=t.blendDst,e.blendSrcAlpha=t.blendSrcAlpha,e.blendDstAlpha=t.blendDstAlpha),e.blendColorMask!==t.blendColorMask&&(m.colorMask((t.blendColorMask&ao.R)!==ao.NONE,(t.blendColorMask&ao.G)!==ao.NONE,(t.blendColorMask&ao.B)!==ao.NONE,(t.blendColorMask&ao.A)!==ao.NONE),e.blendColorMask=t.blendColorMask)}}if(e&&e.gpuPipelineLayout&&f){const i=f.glBlocks.length,{dynamicOffsetIndices:r}=e.gpuPipelineLayout;for(let t=0;t<i;t++){const e=f.glBlocks[t],i=n[e.set],o=i&&i.descriptorIndices[e.binding],a=o>=0&&i.gpuDescriptors[o];let l=null,c=0;if(a&&a.gpuBuffer){const{gpuBuffer:t}=a,i=r[e.set],n=i&&i[e.binding];n>=0&&(c=s[n]),"vf32"in t?l=t.vf32:(c+=t.offset,l=t.gpuBuffer.vf32),c>>=2}if(!l){d(`Buffer binding '${e.name}' at set ${e.set} binding ${e.binding} is not bounded`);continue}const h=e.glActiveUniforms.length;for(let t=0;t<h;t++){const i=e.glActiveUniforms[t];switch(i.glType){case m.BOOL:case m.INT:for(let t=0;t<i.array.length;++t){const e=i.begin+c+t;if(l[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=l[s];m.uniform1iv(i.glLoc,i.array);break}}break;case m.BOOL_VEC2:case m.INT_VEC2:for(let t=0;t<i.array.length;++t){const e=i.begin+c+t;if(l[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=l[s];m.uniform2iv(i.glLoc,i.array);break}}break;case m.BOOL_VEC3:case m.INT_VEC3:for(let t=0;t<i.array.length;++t){const e=i.begin+c+t;if(l[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=l[s];m.uniform3iv(i.glLoc,i.array);break}}break;case m.BOOL_VEC4:case m.INT_VEC4:for(let t=0;t<i.array.length;++t){const e=i.begin+c+t;if(l[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=l[s];m.uniform4iv(i.glLoc,i.array);break}}break;case m.FLOAT:for(let t=0;t<i.array.length;++t){const e=i.begin+c+t;if(l[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=l[s];m.uniform1fv(i.glLoc,i.array);break}}break;case m.FLOAT_VEC2:for(let t=0;t<i.array.length;++t){const e=i.begin+c+t;if(l[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=l[s];m.uniform2fv(i.glLoc,i.array);break}}break;case m.FLOAT_VEC3:for(let t=0;t<i.array.length;++t){const e=i.begin+c+t;if(l[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=l[s];m.uniform3fv(i.glLoc,i.array);break}}break;case m.FLOAT_VEC4:for(let t=0;t<i.array.length;++t){const e=i.begin+c+t;if(l[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=l[s];m.uniform4fv(i.glLoc,i.array);break}}break;case m.FLOAT_MAT2:for(let t=0;t<i.array.length;++t){const e=i.begin+c+t;if(l[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=l[s];m.uniformMatrix2fv(i.glLoc,!1,i.array);break}}break;case m.FLOAT_MAT3:for(let t=0;t<i.array.length;++t){const e=i.begin+c+t;if(l[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=l[s];m.uniformMatrix3fv(i.glLoc,!1,i.array);break}}break;case m.FLOAT_MAT4:for(let t=0;t<i.array.length;++t){const e=i.begin+c+t;if(l[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=l[s];m.uniformMatrix4fv(i.glLoc,!1,i.array);break}}}}}const o=f.glSamplerTextures.length;for(let e=0;e<o;e++){const i=f.glSamplerTextures[e],s=n[i.set];let r=s&&s.descriptorIndices[i.binding],o=r>=0&&s.gpuDescriptors[r];const a=i.units.length;for(let e=0;e<a;e++){const n=i.units[e];if(o&&o.gpuSampler){if(o.gpuTexture&&o.gpuTexture.size>0){const{gpuTexture:e}=o,i=p.glTexUnits[n];i.glTexture!==e.glTexture&&(p.texUnit!==n&&(m.activeTexture(m.TEXTURE0+n),p.texUnit=n),e.glTexture?m.bindTexture(e.glTarget,e.glTexture):m.bindTexture(e.glTarget,t.nullTex2D.gpuTexture.glTexture),i.glTexture=e.glTexture);const{gpuSampler:s}=o;e.isPowerOf2?(g=s.glWrapS,y=s.glWrapT):(g=m.CLAMP_TO_EDGE,y=m.CLAMP_TO_EDGE),v=e.isPowerOf2?e.mipLevel<=1&&(s.glMinFilter===m.LINEAR_MIPMAP_NEAREST||s.glMinFilter===m.LINEAR_MIPMAP_LINEAR)?m.LINEAR:s.glMinFilter:s.glMinFilter===m.LINEAR||s.glMinFilter===m.LINEAR_MIPMAP_NEAREST||s.glMinFilter===m.LINEAR_MIPMAP_LINEAR?m.LINEAR:m.NEAREST,e.glWrapS!==g&&(p.texUnit!==n&&(m.activeTexture(m.TEXTURE0+n),p.texUnit=n),m.texParameteri(e.glTarget,m.TEXTURE_WRAP_S,g),e.glWrapS=g),e.glWrapT!==y&&(p.texUnit!==n&&(m.activeTexture(m.TEXTURE0+n),p.texUnit=n),m.texParameteri(e.glTarget,m.TEXTURE_WRAP_T,y),e.glWrapT=y),e.glMinFilter!==v&&(p.texUnit!==n&&(m.activeTexture(m.TEXTURE0+n),p.texUnit=n),m.texParameteri(e.glTarget,m.TEXTURE_MIN_FILTER,v),e.glMinFilter=v),e.glMagFilter!==s.glMagFilter&&(p.texUnit!==n&&(m.activeTexture(m.TEXTURE0+n),p.texUnit=n),m.texParameteri(e.glTarget,m.TEXTURE_MAG_FILTER,s.glMagFilter),e.glMagFilter=s.glMagFilter)}o=s.gpuDescriptors[++r]}else d(`Sampler binding '${i.name}' at set ${i.set} binding ${i.binding} index ${e} is not bounded`)}}}if(i&&f&&(x||JD.gpuInputAssembler!==i)){JD.gpuInputAssembler=i;const e=t.ANGLE_instanced_arrays;if(t.useVAO){const n=t.OES_vertex_array_object;let s=i.glVAOs.get(f.glProgram);if(!s){let t;s=n.createVertexArrayOES(),i.glVAOs.set(f.glProgram,s),n.bindVertexArrayOES(s),m.bindBuffer(m.ARRAY_BUFFER,null),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null),p.glArrayBuffer=null,p.glElementArrayBuffer=null;const r=f.glInputs.length;for(let n=0;n<r;n++){const s=f.glInputs[n];t=null;const r=i.glAttribs.length;for(let e=0;e<r;e++){const n=i.glAttribs[e];if(n.name===s.name){t=n;break}}if(t){p.glArrayBuffer!==t.glBuffer&&(m.bindBuffer(m.ARRAY_BUFFER,t.glBuffer),p.glArrayBuffer=t.glBuffer);for(let i=0;i<t.componentCount;++i){const n=s.glLoc+i,r=t.offset+t.size*i;m.enableVertexAttribArray(n),p.glCurrentAttribLocs[n]=!0,m.vertexAttribPointer(n,t.count,t.glType,t.isNormalized,t.stride,r),e&&e.vertexAttribDivisorANGLE(n,t.isInstanced?1:0)}}}const o=i.gpuIndexBuffer;o&&m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,o.glBuffer),n.bindVertexArrayOES(null),m.bindBuffer(m.ARRAY_BUFFER,null),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null),p.glArrayBuffer=null,p.glElementArrayBuffer=null}p.glVAO!==s&&(n.bindVertexArrayOES(s),p.glVAO=s)}else{for(let e=0;e<t.capabilities.maxVertexAttributes;++e)p.glCurrentAttribLocs[e]=!1;const n=f.glInputs.length;for(let t=0;t<n;t++){const n=f.glInputs[t];let s=null;const r=i.glAttribs.length;for(let t=0;t<r;t++){const e=i.glAttribs[t];if(e.name===n.name){s=e;break}}if(s){p.glArrayBuffer!==s.glBuffer&&(m.bindBuffer(m.ARRAY_BUFFER,s.glBuffer),p.glArrayBuffer=s.glBuffer);for(let t=0;t<s.componentCount;++t){const i=n.glLoc+t,r=s.offset+s.size*t;!p.glEnabledAttribLocs[i]&&i>=0&&(m.enableVertexAttribArray(i),p.glEnabledAttribLocs[i]=!0),p.glCurrentAttribLocs[i]=!0,m.vertexAttribPointer(i,s.count,s.glType,s.isNormalized,s.stride,r),e&&e.vertexAttribDivisorANGLE(i,s.isInstanced?1:0)}}}const s=i.gpuIndexBuffer;s&&p.glElementArrayBuffer!==s.glBuffer&&(m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,s.glBuffer),p.glElementArrayBuffer=s.glBuffer);for(let e=0;e<t.capabilities.maxVertexAttributes;++e)p.glEnabledAttribLocs[e]!==p.glCurrentAttribLocs[e]&&(m.disableVertexAttribArray(e),p.glEnabledAttribLocs[e]=!1)}}if(e&&e.dynamicStates.length){const t=e.dynamicStates.length;for(let i=0;i<t;i++)switch(e.dynamicStates[i]){case yo.VIEWPORT:r&&(p.viewport.left===r.left&&p.viewport.top===r.top&&p.viewport.width===r.width&&p.viewport.height===r.height||(m.viewport(r.left,r.top,r.width,r.height),p.viewport.left=r.left,p.viewport.top=r.top,p.viewport.width=r.width,p.viewport.height=r.height));break;case yo.SCISSOR:o&&(p.scissorRect.x===o.x&&p.scissorRect.y===o.y&&p.scissorRect.width===o.width&&p.scissorRect.height===o.height||(m.scissor(o.x,o.y,o.width,o.height),p.scissorRect.x=o.x,p.scissorRect.y=o.y,p.scissorRect.width=o.width,p.scissorRect.height=o.height));break;case yo.LINE_WIDTH:a&&p.rs.lineWidth!==a&&(m.lineWidth(a),p.rs.lineWidth=a);break;case yo.DEPTH_BIAS:l&&(p.rs.depthBias===l.constantFactor&&p.rs.depthBiasSlop===l.slopeFactor||(m.polygonOffset(l.constantFactor,l.slopeFactor),p.rs.depthBias=l.constantFactor,p.rs.depthBiasSlop=l.slopeFactor));break;case yo.BLEND_CONSTANTS:p.bs.blendColor.x===c[0]&&p.bs.blendColor.y===c[1]&&p.bs.blendColor.z===c[2]&&p.bs.blendColor.w===c[3]||(m.blendColor(c[0],c[1],c[2],c[3]),[p.bs.blendColor.x,p.bs.blendColor.y,p.bs.blendColor.z,p.bs.blendColor.w]=c);break;case yo.STENCIL_WRITE_MASK:if(_)switch(_.face){case vo.FRONT:p.dss.stencilWriteMaskFront!==_.writeMask&&(m.stencilMaskSeparate(m.FRONT,_.writeMask),p.dss.stencilWriteMaskFront=_.writeMask);break;case vo.BACK:p.dss.stencilWriteMaskBack!==_.writeMask&&(m.stencilMaskSeparate(m.BACK,_.writeMask),p.dss.stencilWriteMaskBack=_.writeMask);break;case vo.ALL:p.dss.stencilWriteMaskFront===_.writeMask&&p.dss.stencilWriteMaskBack===_.writeMask||(m.stencilMask(_.writeMask),p.dss.stencilWriteMaskFront=_.writeMask,p.dss.stencilWriteMaskBack=_.writeMask)}break;case yo.STENCIL_COMPARE_MASK:if(u)switch(u.face){case vo.FRONT:p.dss.stencilRefFront===u.reference&&p.dss.stencilReadMaskFront===u.compareMask||(m.stencilFuncSeparate(m.FRONT,FD[p.dss.stencilFuncFront],u.reference,u.compareMask),p.dss.stencilRefFront=u.reference,p.dss.stencilReadMaskFront=u.compareMask);break;case vo.BACK:p.dss.stencilRefBack===u.reference&&p.dss.stencilReadMaskBack===u.compareMask||(m.stencilFuncSeparate(m.BACK,FD[p.dss.stencilFuncBack],u.reference,u.compareMask),p.dss.stencilRefBack=u.reference,p.dss.stencilReadMaskBack=u.compareMask);break;case vo.ALL:p.dss.stencilRefFront===u.reference&&p.dss.stencilReadMaskFront===u.compareMask&&p.dss.stencilRefBack===u.reference&&p.dss.stencilReadMaskBack===u.compareMask||(m.stencilFunc(FD[p.dss.stencilFuncBack],u.reference,u.compareMask),p.dss.stencilRefFront=u.reference,p.dss.stencilReadMaskFront=u.compareMask,p.dss.stencilRefBack=u.reference,p.dss.stencilReadMaskBack=u.compareMask)}}}}function QD(t,e){const{gl:i}=t,n=t.ANGLE_instanced_arrays,{gpuInputAssembler:s,glPrimitive:r}=JD;if(s)if(s.gpuIndirectBuffer){const t=s.gpuIndirectBuffer.indirects.length;for(let e=0;e<t;e++){const t=s.gpuIndirectBuffer.indirects[e],o=s.gpuIndexBuffer;if(t.instanceCount&&n)if(o){if(t.indexCount>0){const e=t.firstIndex*o.stride;n.drawElementsInstancedANGLE(r,t.indexCount,s.glIndexType,e,t.instanceCount)}}else t.vertexCount>0&&n.drawArraysInstancedANGLE(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(o){if(t.indexCount>0){const e=t.firstIndex*o.stride;i.drawElements(r,t.indexCount,s.glIndexType,e)}}else t.vertexCount>0&&i.drawArrays(r,t.firstVertex,t.vertexCount)}}else{const t=s.gpuIndexBuffer;if(e.instanceCount&&n)if(t){if(e.indexCount>0){const i=e.firstIndex*t.stride;n.drawElementsInstancedANGLE(r,e.indexCount,s.glIndexType,i,e.instanceCount)}}else e.vertexCount>0&&n.drawArraysInstancedANGLE(r,e.firstVertex,e.vertexCount,e.instanceCount);else if(t){if(e.indexCount>0){const n=e.firstIndex*t.stride;i.drawElements(r,e.indexCount,s.glIndexType,n)}}else e.vertexCount>0&&i.drawArrays(r,e.firstVertex,e.vertexCount)}}const tR=new Array(GD.COUNT);function eR(t,e){tR.fill(0);for(let i=0;i<e.cmds.length;++i){const n=e.cmds.array[i],s=tR[n]++;switch(n){case GD.BEGIN_RENDER_PASS:{const i=e.beginRenderPassCmds.array[s];$D(t,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break}case GD.BIND_STATES:{const i=e.bindStatesCmds.array[s];ZD(t,i.gpuPipelineState,i.gpuInputAssembler,i.gpuDescriptorSets,i.dynamicOffsets,i.viewport,i.scissor,i.lineWidth,i.depthBias,i.blendConstants,i.depthBounds,i.stencilWriteMask,i.stencilCompareMask);break}case GD.DRAW:QD(t,e.drawCmds.array[s].drawInfo);break;case GD.UPDATE_BUFFER:{const i=e.updateBufferCmds.array[s];KD(t,i.gpuBuffer,i.buffer,i.offset,i.size);break}case GD.COPY_BUFFER_TO_TEXTURE:{const i=e.copyBufferToTextureCmds.array[s];iR(t,i.buffers,i.gpuTexture,i.regions);break}}}}function iR(t,e,i,n){const{gl:s}=t,r=t.stateCache.glTexUnits[t.stateCache.texUnit];r.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),r.glTexture=i.glTexture);let o=0,a=1,l=1,c=0;const h=Aa[i.format],{isCompressed:_}=h;switch(i.glTarget){case s.TEXTURE_2D:for(let r=0;r<n.length;r++){const c=n[r];a=c.texExtent.width,l=c.texExtent.height;const h=e[o++];_?i.glInternalFmt===AD.COMPRESSED_RGB_ETC1_WEBGL||t.noCompressedTexSubImage2D?s.compressedTexImage2D(s.TEXTURE_2D,c.texSubres.mipLevel,i.glInternalFmt,a,l,0,h):s.compressedTexSubImage2D(s.TEXTURE_2D,c.texSubres.mipLevel,c.texOffset.x,c.texOffset.y,a,l,i.glFormat,h):s.texSubImage2D(s.TEXTURE_2D,c.texSubres.mipLevel,c.texOffset.x,c.texOffset.y,a,l,i.glFormat,i.glType,h)}break;case s.TEXTURE_CUBE_MAP:for(let r=0;r<n.length;r++){const h=n[r],u=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(c=h.texSubres.baseArrayLayer;c<u;++c){a=h.texExtent.width,l=h.texExtent.height;const n=e[o++];_?i.glInternalFmt===AD.COMPRESSED_RGB_ETC1_WEBGL||t.noCompressedTexSubImage2D?s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+c,h.texSubres.mipLevel,i.glInternalFmt,a,l,0,n):s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+c,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,a,l,i.glFormat,n):s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+c,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,a,l,i.glFormat,i.glType,n)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Qr.GEN_MIPMAP&&s.generateMipmap(i.glTarget)}class nR extends Ua{constructor(...t){super(...t),this._gpuBuffer=null,this._gpuBufferView=null,this._uniformBuffer=null}get gpuBuffer(){return this._gpuBuffer}get gpuBufferView(){return this._gpuBufferView}initialize(t){if("buffer"in t){this._isBufferView=!0;const e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBufferView={gpuBuffer:e.gpuBuffer,offset:t.offset,range:t.range}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._usage&Xr.INDIRECT&&(this._indirectBuffer=new Ho),this._usage&Xr.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},t.usage&Xr.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),this._usage&Xr.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(t,e){const{gl:i}=t,n=t.stateCache,s=e.memUsage&Jr.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(e.usage&Xr.VERTEX){e.glTarget=i.ARRAY_BUFFER;const r=i.createBuffer();r&&(e.glBuffer=r,e.size>0&&(t.useVAO&&n.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=JD.gpuInputAssembler=null),t.stateCache.glArrayBuffer!==e.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),i.bufferData(i.ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&Xr.INDEX){e.glTarget=i.ELEMENT_ARRAY_BUFFER;const r=i.createBuffer();r&&(e.glBuffer=r,e.size>0&&(t.useVAO&&n.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=JD.gpuInputAssembler=null),t.stateCache.glElementArrayBuffer!==e.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else e.usage&Xr.UNIFORM?(e.glTarget=i.NONE,e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer))):(e.usage&Xr.INDIRECT||e.usage&Xr.TRANSFER_DST||e.usage&Xr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0}destroy(){var t,e;this._gpuBuffer&&(t=this._device,(e=this._gpuBuffer).glBuffer&&(t.gl.deleteBuffer(e.glBuffer),e.glBuffer=null),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)}resize(t){if(this._isBufferView)return void console.warn("cannot resize buffer views!");const e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(t)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=t,t>0&&(function(t,e){const{gl:i}=t,n=t.stateCache,s=e.memUsage&Jr.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;e.usage&Xr.VERTEX?(t.useVAO&&n.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=JD.gpuInputAssembler=null),t.stateCache.glArrayBuffer!==e.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,e.glBuffer),e.buffer?i.bufferData(i.ARRAY_BUFFER,e.buffer,s):i.bufferData(i.ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):e.usage&Xr.INDEX?(t.useVAO&&n.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=JD.gpuInputAssembler=null),t.stateCache.glElementArrayBuffer!==e.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.buffer,s):i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&Xr.UNIFORM?e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer)):(e.usage&Xr.INDIRECT||e.usage&Xr.TRANSFER_DST||e.usage&Xr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=e,this._device.memoryStatus.bufferSize+=t)))}update(t,e){if(this._isBufferView)return void console.warn("cannot update through buffer views!");let i;i=void 0!==e?e:this._usage&Xr.INDIRECT?0:t.byteLength,KD(this._device,this._gpuBuffer,t,0,i)}}class sR{constructor(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new Vi(e);for(let i=0;i<e;++i)this._frees[i]=new t;this._freeIdx=e-1}alloc(t){if(this._freeIdx<0){const e=2*this._frees.length,i=this._frees;this._frees=new Array(e);const n=e-i.length;for(let e=0;e<n;++e)this._frees[e]=new t;for(let t=n,s=0;t<e;++t,++s)this._frees[t]=i[s];this._freeIdx+=n}const e=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++e.refCount,e}free(t){0==--t.refCount&&this._freeCmds.push(t)}freeCmds(t){for(let e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])}release(){for(let t=0;t<this._freeCmds.length;++t){const e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()}}class rR{constructor(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new sR(kD,1),this.bindStatesCmdPool=new sR(jD,1),this.drawCmdPool=new sR(WD,1),this.updateBufferCmdPool=new sR(qD,1),this.copyBufferToTextureCmdPool=new sR(XD,1)}clearCmds(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()}releaseCmds(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}class oR extends Ga{constructor(...t){super(...t),this.cmdPackage=new YD,this._webGLAllocator=null,this._isInRenderPass=!1,this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets=[],this._curDynamicOffsets=[],this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._isStateInvalied=!1}initialize(t){this._type=t.type,this._queue=t.queue,this._webGLAllocator=this._device.cmdAllocator;const e=this._device.bindingMappingInfo.bufferOffsets.length;for(let t=0;t<e;t++)this._curGPUDescriptorSets.push(null),this._curDynamicOffsets.push([]);return!0}destroy(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)}begin(t,e=0,i){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0;for(let t=0;t<this._curDynamicOffsets.length;t++)this._curDynamicOffsets[t].length=0;this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants.length=0,this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}end(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}beginRenderPass(t,e,i,n,s,r){const o=this._webGLAllocator.beginRenderPassCmdPool.alloc(kD);o.gpuRenderPass=t.gpuRenderPass,o.gpuFramebuffer=e.gpuFramebuffer,o.renderArea=i,o.clearColors.length=n.length;for(let t=0;t<n.length;++t)o.clearColors[t]=n[t];o.clearDepth=s,o.clearStencil=r,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(GD.BEGIN_RENDER_PASS),this._isInRenderPass=!0}endRenderPass(){this._isInRenderPass=!1}bindPipelineState(t){const e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)}bindDescriptorSet(t,e,i){const n=e.gpuDescriptorSet;if(n!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=n,this._isStateInvalied=!0),i){const e=this._curDynamicOffsets[t];for(let t=0;t<i.length;t++)e[t]=i[t];e.length=i.length,this._isStateInvalied=!0}}bindInputAssembler(t){const e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0}setViewport(t){this._curViewport?this._curViewport.left===t.left&&this._curViewport.top===t.top&&this._curViewport.width===t.width&&this._curViewport.height===t.height&&this._curViewport.minDepth===t.minDepth&&this._curViewport.maxDepth===t.maxDepth||(this._curViewport.left=t.left,this._curViewport.top=t.top,this._curViewport.width=t.width,this._curViewport.height=t.height,this._curViewport.minDepth=t.minDepth,this._curViewport.maxDepth=t.maxDepth,this._isStateInvalied=!0):this._curViewport=new No(t.left,t.top,t.width,t.height,t.minDepth,t.maxDepth)}setScissor(t){this._curScissor?this._curScissor.x===t.x&&this._curScissor.y===t.y&&this._curScissor.width===t.width&&this._curScissor.height===t.height||(this._curScissor.x=t.x,this._curScissor.y=t.y,this._curScissor.width=t.width,this._curScissor.height=t.height,this._isStateInvalied=!0):this._curScissor=new Po(t.x,t.y,t.width,t.height)}setLineWidth(t){this._curLineWidth!==t&&(this._curLineWidth=t,this._isStateInvalied=!0)}setDepthBias(t,e,i){this._curDepthBias?this._curDepthBias.constantFactor===t&&this._curDepthBias.clamp===e&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=t,this._curDepthBias.clamp=e,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:t,clamp:e,slopeFactor:i},this._isStateInvalied=!0)}setBlendConstants(t){4!==t.length||this._curBlendConstants[0]===t[0]&&this._curBlendConstants[1]===t[1]&&this._curBlendConstants[2]===t[2]&&this._curBlendConstants[3]===t[3]||(this._curBlendConstants.length=0,Array.prototype.push.apply(this._curBlendConstants,t),this._isStateInvalied=!0)}setDepthBound(t,e){this._curDepthBounds&&this._curDepthBounds.minBounds===t&&this._curDepthBounds.maxBounds===e||(this._curDepthBounds={minBounds:t,maxBounds:e},this._isStateInvalied=!0)}setStencilWriteMask(t,e){this._curStencilWriteMask?this._curStencilWriteMask.face===t&&this._curStencilWriteMask.writeMask===e||(this._curStencilWriteMask.face=t,this._curStencilWriteMask.writeMask=e,this._isStateInvalied=!0):(this._curStencilWriteMask={face:t,writeMask:e},this._isStateInvalied=!0)}setStencilCompareMask(t,e,i){this._curStencilCompareMask?this._curStencilCompareMask.face===t&&this._curStencilCompareMask.reference===e&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=t,this._curStencilCompareMask.reference=e,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:t,reference:e,compareMask:i},this._isStateInvalied=!0)}draw(t){if(this._type===Ao.PRIMARY&&this._isInRenderPass||this._type===Ao.SECONDARY){this._isStateInvalied&&this.bindStates();const e=this._webGLAllocator.drawCmdPool.alloc(WD);e.drawInfo.vertexCount=t.vertexCount,e.drawInfo.firstVertex=t.firstVertex,e.drawInfo.indexCount=t.indexCount,e.drawInfo.firstIndex=t.firstIndex,e.drawInfo.vertexOffset=t.vertexOffset,e.drawInfo.instanceCount=t.instanceCount,e.drawInfo.firstInstance=t.firstInstance,this.cmdPackage.drawCmds.push(e),this.cmdPackage.cmds.push(GD.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;const i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(t,e,i){if(this._type===Ao.PRIMARY&&!this._isInRenderPass||this._type===Ao.SECONDARY){const n=t.gpuBuffer;if(n){const s=this._webGLAllocator.updateBufferCmdPool.alloc(qD);let r=0,o=null;t.usage&Xr.INDIRECT||(r=void 0!==i?i:e.byteLength),o=e,s.gpuBuffer=n,s.buffer=o,s.offset=0,s.size=r,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(GD.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}copyBuffersToTexture(t,e,i){if(this._type===Ao.PRIMARY&&!this._isInRenderPass||this._type===Ao.SECONDARY){const n=e.gpuTexture;if(n){const e=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(XD);e&&(e.gpuTexture=n,e.regions=i,e.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(e),this.cmdPackage.cmds.push(GD.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}execute(t,e){for(let i=0;i<e;++i){const e=t[i];for(let t=0;t<e.cmdPackage.beginRenderPassCmds.length;++t){const i=e.cmdPackage.beginRenderPassCmds.array[t];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(let t=0;t<e.cmdPackage.bindStatesCmds.length;++t){const i=e.cmdPackage.bindStatesCmds.array[t];++i.refCount,this.cmdPackage.bindStatesCmds.push(i)}for(let t=0;t<e.cmdPackage.drawCmds.length;++t){const i=e.cmdPackage.drawCmds.array[t];++i.refCount,this.cmdPackage.drawCmds.push(i)}for(let t=0;t<e.cmdPackage.updateBufferCmds.length;++t){const i=e.cmdPackage.updateBufferCmds.array[t];++i.refCount,this.cmdPackage.updateBufferCmds.push(i)}for(let t=0;t<e.cmdPackage.copyBufferToTextureCmds.length;++t){const i=e.cmdPackage.copyBufferToTextureCmds.array[t];++i.refCount,this.cmdPackage.copyBufferToTextureCmds.push(i)}this.cmdPackage.cmds.concat(e.cmdPackage.cmds.array),this._numDrawCalls+=e._numDrawCalls,this._numInstances+=e._numInstances,this._numTris+=e._numTris}}pipelineBarrier(t,e){}get webGLDevice(){return this._device}bindStates(){const t=this._webGLAllocator.bindStatesCmdPool.alloc(jD);if(t){t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets);for(let e=0;e<this._curDynamicOffsets.length;e++)Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets[e]);t.gpuInputAssembler=this._curGPUInputAssembler,t.viewport=this._curViewport,t.scissor=this._curScissor,t.lineWidth=this._curLineWidth,t.depthBias=this._curDepthBias,Array.prototype.push.apply(t.blendConstants,this._curBlendConstants),t.depthBounds=this._curDepthBounds,t.stencilWriteMask=this._curStencilWriteMask,t.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(GD.BIND_STATES),this._isStateInvalied=!1}}}class aR extends ka{constructor(...t){super(...t),this._gpuFramebuffer=null}get gpuFramebuffer(){return this._gpuFramebuffer}initialize(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null,0!==t.depthStencilMipmapLevel&&console.warn("The mipmap level of th texture image to be attached of depth stencil attachment should be 0. Convert to 0.");for(let e=0;e<t.colorMipmapLevels.length;++e)0!==t.colorMipmapLevels[e]&&console.warn(`The mipmap level of th texture image to be attached of color attachment ${e} should be 0. Convert to 0.`);const e=[];for(let i=0;i<t.colorTextures.length;++i){const n=t.colorTextures[i];n&&e.push(n.gpuTexture)}let i=null;return t.depthStencilTexture&&(i=t.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:e,gpuDepthStencilTexture:i,glFramebuffer:null},function(t,e){if(!e.gpuColorTextures.length&&!e.gpuDepthStencilTexture)return;const{gl:i}=t,n=[],s=i.createFramebuffer();if(s){e.glFramebuffer=s,t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.glFramebuffer);for(let t=0;t<e.gpuColorTextures.length;++t){const s=e.gpuColorTextures[t];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+t,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+t,i.RENDERBUFFER,s.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+t))}const r=e.gpuDepthStencilTexture;if(r){const t=Aa[r.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;r.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,t,r.glTarget,r.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,t,i.RENDERBUFFER,r.glRenderbuffer)}t.WEBGL_draw_buffers&&t.WEBGL_draw_buffers.drawBuffersWEBGL(n);const o=i.checkFramebufferStatus(i.FRAMEBUFFER);if(o!==i.FRAMEBUFFER_COMPLETE)switch(o){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(this._device,this._gpuFramebuffer),!0}destroy(){var t,e;this._gpuFramebuffer&&(t=this._device,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),e.glFramebuffer=null),this._gpuFramebuffer=null)}}class lR extends Xa{constructor(...t){super(...t),this._gpuInputAssembler=null}get gpuInputAssembler(){return this._gpuInputAssembler}initialize(t){if(0===t.vertexBuffers.length)return console.error("InputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{const t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;const e=new Array(t.vertexBuffers.length);for(let i=0;i<t.vertexBuffers.length;++i){const n=t.vertexBuffers[i];n.gpuBuffer&&(e[i]=n.gpuBuffer)}let i=null,n=0;if(t.indexBuffer&&(i=t.indexBuffer.gpuBuffer,i))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Error index buffer stride.")}let s=null;return t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:e,gpuIndexBuffer:i,gpuIndirectBuffer:s,glAttribs:[],glIndexType:n,glVAOs:new Map},function(t,e){const{gl:i}=t;e.glAttribs=new Array(e.attributes.length);const n=[0,0,0,0,0,0,0,0];for(let t=0;t<e.attributes.length;++t){const s=e.attributes[t],r=void 0!==s.stream?s.stream:0,o=e.gpuVertexBuffers[r],a=ID(s.format,i),{size:l}=Aa[s.format];e.glAttribs[t]={name:s.name,glBuffer:o.glBuffer,glType:a,size:l,count:Aa[s.format].count,stride:o.stride,componentCount:LD(a,i),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:n[r]},n[r]+=l}}(this._device,this._gpuInputAssembler),!0}destroy(){const t=this._device;this._gpuInputAssembler&&t.useVAO&&function(t,e){const i=e.glVAOs.values();let n=i.next();for(;!n.done;)t.OES_vertex_array_object.deleteVertexArrayOES(n.value),n=i.next();e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null}}class cR extends Ya{constructor(...t){super(...t),this._gpuDescriptorSetLayout=null}get gpuDescriptorSetLayout(){return this._gpuDescriptorSetLayout}initialize(t){Array.prototype.push.apply(this._bindings,t.bindings);let e=0,i=-1;const n=[];for(let t=0;t<this._bindings.length;t++){const s=this._bindings[t];n.push(e),e+=s.count,s.binding>i&&(i=s.binding)}this._bindingIndices=Array(i+1).fill(-1);const s=this._descriptorIndices=Array(i+1).fill(-1);for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];this._bindingIndices[e.binding]=t,s[e.binding]=n[t]}const r=[];for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];if(e.descriptorType&Ta)for(let t=0;t<e.count;t++)r.push(e.binding)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:r,descriptorIndices:s,descriptorCount:e},!0}destroy(){this._bindings.length=0}}class hR extends Ka{constructor(...t){super(...t),this._gpuPipelineLayout=null}get gpuPipelineLayout(){return this._gpuPipelineLayout}initialize(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);const e=[],i=[];let n=0;for(let t=0;t<this._setLayouts.length;t++){const s=this._setLayouts[t],r=s.gpuDescriptorSetLayout.dynamicBindings,o=Array(s.bindingIndices.length).fill(-1);for(let t=0;t<r.length;t++){const e=r[t];o[e]<0&&(o[e]=n+t)}i.push(s.gpuDescriptorSetLayout),e.push(o),n+=r.length}return this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetIndices:e,dynamicOffsetCount:n},!0}destroy(){this._setLayouts.length=0}}class _R{constructor(t=!1,e=po.FILL,i=fo.GOURAND,n=go.BACK,s=!0,r=!1,o=0,a=0,l=0,c=!0,h=!1,_=1){this.isDiscard=t,this.polygonMode=e,this.shadeModel=i,this.cullMode=n,this.isFrontFaceCCW=s,this.depthBiasEnabled=r,this.depthBias=o,this.depthBiasClamp=a,this.depthBiasSlop=l,this.isDepthClip=c,this.isMultisample=h,this.lineWidth=_}reset(){this.isDiscard=!1,this.polygonMode=po.FILL,this.shadeModel=fo.GOURAND,this.cullMode=go.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}assign(t){Object.assign(this,t)}get handle(){return 0}destroy(){}}class uR{constructor(t=!0,e=!0,i=no.LESS,n=!1,s=no.ALWAYS,r=65535,o=65535,a=so.KEEP,l=so.KEEP,c=so.KEEP,h=1,_=!1,u=no.ALWAYS,m=65535,d=65535,p=so.KEEP,f=so.KEEP,g=so.KEEP,y=1){this.depthTest=t,this.depthWrite=e,this.depthFunc=i,this.stencilTestFront=n,this.stencilFuncFront=s,this.stencilReadMaskFront=r,this.stencilWriteMaskFront=o,this.stencilFailOpFront=a,this.stencilZFailOpFront=l,this.stencilPassOpFront=c,this.stencilRefFront=h,this.stencilTestBack=_,this.stencilFuncBack=u,this.stencilReadMaskBack=m,this.stencilWriteMaskBack=d,this.stencilFailOpBack=p,this.stencilZFailOpBack=f,this.stencilPassOpBack=g,this.stencilRefBack=y}reset(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=no.LESS,this.stencilTestFront=!1,this.stencilFuncFront=no.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=so.KEEP,this.stencilZFailOpFront=so.KEEP,this.stencilPassOpFront=so.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=no.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=so.KEEP,this.stencilZFailOpBack=so.KEEP,this.stencilPassOpBack=so.KEEP,this.stencilRefBack=1}assign(t){Object.assign(this,t)}get handle(){return 0}destroy(){}}class mR{constructor(t=!1,e=ro.ONE,i=ro.ZERO,n=oo.ADD,s=ro.ONE,r=ro.ZERO,o=oo.ADD,a=ao.ALL){this.blend=t,this.blendSrc=e,this.blendDst=i,this.blendEq=n,this.blendSrcAlpha=s,this.blendDstAlpha=r,this.blendAlphaEq=o,this.blendColorMask=a}reset(){this.blend=!1,this.blendSrc=ro.ONE,this.blendDst=ro.ZERO,this.blendEq=oo.ADD,this.blendSrcAlpha=ro.ONE,this.blendDstAlpha=ro.ZERO,this.blendAlphaEq=oo.ADD,this.blendColorMask=ao.ALL}assign(t){Object.assign(this,t)}get handle(){return 0}destroy(){}}class dR{constructor(t=!1,e=!1,i=new Lo,n=[new mR]){this.isA2C=t,this.isIndepend=e,this.blendColor=i,this.targets=n}setTarget(t,e){let i=this.targets[t];i||(i=this.targets[t]=new mR),Object.assign(i,e)}reset(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()}get handle(){return 0}destroy(){}}class pR extends xa{get shader(){return this._shader}get pipelineLayout(){return this._pipelineLayout}get primitive(){return this._primitive}get rasterizerState(){return this._rs}get depthStencilState(){return this._dss}get blendState(){return this._bs}get inputState(){return this._is}get dynamicStates(){return this._dynamicStates}get renderPass(){return this._renderPass}constructor(t){super(Vr.PIPELINE_STATE),this._device=void 0,this._shader=null,this._pipelineLayout=null,this._primitive=mo.TRIANGLE_LIST,this._is=null,this._rs=new _R,this._dss=new uR,this._bs=new dR,this._dynamicStates=yo.NONE,this._renderPass=null,this._device=t}}const fR=[0,1,3,2,0,0,0,4,5,6,0,0,0,0];class gR extends pR{constructor(...t){super(...t),this._gpuPipelineState=null}get gpuPipelineState(){return this._gpuPipelineState}initialize(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;const e=this._bs;if(t.blendState){const i=t.blendState,{targets:n}=i;n&&n.forEach(((t,i)=>{e.setTarget(i,t)})),void 0!==i.isA2C&&(e.isA2C=i.isA2C),void 0!==i.isIndepend&&(e.isIndepend=i.isIndepend),void 0!==i.blendColor&&(e.blendColor=i.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;const i=[];for(let t=0;t<31;t++)this._dynamicStates&1<<t&&i.push(1<<t);return this._gpuPipelineState={glPrimitive:fR[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:i},!0}destroy(){this._gpuPipelineState=null}}const yR=[];class vR extends oR{beginRenderPass(t,e,i,n,s,r){$D(this._device,t.gpuRenderPass,e.gpuFramebuffer,i,n,s,r),this._isInRenderPass=!0}draw(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),QD(this._device,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;const e=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=e/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(e-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(t,e,i){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{const n=t.gpuBuffer;if(n){let s;s=void 0!==i?i:t.usage&Xr.INDIRECT?0:e.byteLength,KD(this._device,n,e,0,s)}}}copyBuffersToTexture(t,e,i){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{const n=e.gpuTexture;n&&iR(this._device,t,n,i)}}execute(t,e){for(let i=0;i<e;++i){const e=t[i];eR(this._device,e.cmdPackage),this._numDrawCalls+=e._numDrawCalls,this._numInstances+=e._numInstances,this._numTris+=e._numTris}}bindStates(){yR.length=0;for(let t=0;t<this._curDynamicOffsets.length;t++)Array.prototype.push.apply(yR,this._curDynamicOffsets[t]);ZD(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,yR,this._curViewport,this._curScissor,this._curLineWidth,this._curDepthBias,this._curBlendConstants,this._curDepthBounds,this._curStencilWriteMask,this._curStencilCompareMask),this._isStateInvalied=!1}}class xR extends Ja{constructor(...t){super(...t),this.numDrawCalls=0,this.numInstances=0,this.numTris=0}initialize(t){return this._type=t.type,!0}destroy(){}submit(t){if(!this._isAsync){const e=t.length;for(let i=0;i<e;i++){const e=t[i];this.numDrawCalls+=e.numDrawCalls,this.numInstances+=e.numInstances,this.numTris+=e.numTris}}}clear(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}class SR extends $a{constructor(...t){super(...t),this._gpuRenderPass=null}get gpuRenderPass(){return this._gpuRenderPass}initialize(t){return this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,t.subpasses&&(this._subpasses=t.subpasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0}destroy(){this._gpuRenderPass=null}}const AR=[10497,33648,33071,33071];class CR extends Za{constructor(...t){super(...t),this._gpuSampler=null}get gpuSampler(){return this._gpuSampler}initialize(t){this._minFilter=t.minFilter,this._magFilter=t.magFilter,this._mipFilter=t.mipFilter,this._addressU=t.addressU,this._addressV=t.addressV,this._addressW=t.addressW,this._maxAnisotropy=t.maxAnisotropy,this._cmpFunc=t.cmpFunc,this._borderColor=t.borderColor,this._mipLODBias=t.mipLODBias;let e=0,i=0;const n=this._minFilter,s=this._magFilter,r=this._mipFilter;e=n===eo.LINEAR||n===eo.ANISOTROPIC?r===eo.LINEAR||r===eo.ANISOTROPIC?9987:r===eo.POINT?9985:9729:r===eo.LINEAR||r===eo.ANISOTROPIC?9986:r===eo.POINT?9984:9728,i=s===eo.LINEAR||s===eo.ANISOTROPIC?9729:9728;const o=AR[this._addressU],a=AR[this._addressV],l=AR[this._addressW];return this._gpuSampler={glMinFilter:e,glMagFilter:i,glWrapS:o,glWrapT:a,glWrapR:l},!0}destroy(){this._gpuSampler=null}}class bR extends Qa{constructor(...t){super(...t),this._gpuShader=null}get gpuShader(){return this._gpuShader}initialize(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks,samplerTextures:t.samplerTextures,gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(let e=0;e<t.stages.length;++e){const i=t.stages[e];this._gpuShader.gpuStages[e]={type:i.stage,source:i.source,glShader:null}}return function(t,e){const{gl:i}=t;for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];let s=0,r="",o=1;switch(n.type){case lo.VERTEX:r="VertexShader",s=i.VERTEX_SHADER;break;case lo.FRAGMENT:r="FragmentShader",s=i.FRAGMENT_SHADER;break;default:return void console.error("Unsupported ShaderType.")}const a=i.createShader(s);if(a&&(n.glShader=a,i.shaderSource(n.glShader,n.source),i.compileShader(n.glShader),!i.getShaderParameter(n.glShader,i.COMPILE_STATUS))){console.error(`${r} in '${e.name}' compilation failed.`),console.error("Shader source dump:",n.source.replace(/^|\n/g,(()=>`\n${o++} `))),console.error(i.getShaderInfoLog(n.glShader));for(let n=0;n<e.gpuStages.length;n++){const n=e.gpuStages[t];n.glShader&&(i.deleteShader(n.glShader),n.glShader=null)}return}}const n=i.createProgram();if(!n)return;e.glProgram=n;for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];i.attachShader(e.glProgram,n.glShader)}if(i.linkProgram(e.glProgram),t.destroyShadersImmediately)for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];n.glShader&&(i.detachShader(e.glProgram,n.glShader),i.deleteShader(n.glShader),n.glShader=null)}if(!i.getProgramParameter(e.glProgram,i.LINK_STATUS))return console.error(`Failed to link shader '${e.name}'.`),void console.error(i.getProgramInfoLog(e.glProgram));console.info(`Shader '${e.name}' compilation succeeded.`);const s=i.getProgramParameter(e.glProgram,i.ACTIVE_ATTRIBUTES);e.glInputs=new Array(s);for(let t=0;t<s;++t){const n=i.getActiveAttrib(e.glProgram,t);if(n){let s;const r=n.name.indexOf("[");s=-1!==r?n.name.substr(0,r):n.name;const o=i.getAttribLocation(e.glProgram,s),a=OD(n.type,i),l=ND(n.type,i);e.glInputs[t]={binding:o,name:s,type:a,stride:l,count:n.size,size:l*n.size,glType:n.type,glLoc:o}}}if(e.blocks.length>0){e.glBlocks=new Array(e.blocks.length);for(let t=0;t<e.blocks.length;++t){const n=e.blocks[t],s={set:n.set,binding:n.binding,name:n.name,size:0,glUniforms:new Array(n.members.length),glActiveUniforms:[]};e.glBlocks[t]=s;for(let t=0;t<n.members.length;++t){const e=n.members[t],r=MD(e.type,i),o=BD(e.type),a=ND(r,i),l=a*e.count,c=s.size/4,h=new o(l/4);s.glUniforms[t]={binding:-1,name:e.name,type:e.type,stride:a,count:e.count,size:l,offset:s.size,glType:r,glLoc:-1,array:h,begin:c},s.size+=l}}}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(let t=0;t<e.samplerTextures.length;++t){const n=e.samplerTextures[t];e.glSamplerTextures[t]={set:n.set,binding:n.binding,name:n.name,type:n.type,count:n.count,units:[],glUnits:null,glType:MD(n.type,i),glLoc:null}}}const r=i.getProgramParameter(e.glProgram,i.ACTIVE_UNIFORMS);for(let t=0;t<r;++t){const n=i.getActiveUniform(e.glProgram,t);if(n&&n.type!==i.SAMPLER_2D&&n.type!==i.SAMPLER_CUBE){const t=i.getUniformLocation(e.glProgram,n.name);if(null!==t&&("number"==typeof t||-1!==t.id)){let i;const s=n.name.indexOf("[");i=-1!==s?n.name.substr(0,s):n.name;for(let n=0;n<e.glBlocks.length;n++){const s=e.glBlocks[n];for(let e=0;e<s.glUniforms.length;e++){const n=s.glUniforms[e];if(n.name===i){n.glLoc=t,s.glActiveUniforms.push(n);break}}}}}}const o=[],a=[],{bindingMappingInfo:l}=t,{texUnitCacheMap:c}=t.stateCache;let h=0;for(let t=0;t<e.blocks.length;++t)e.blocks[t].set===l.flexibleSet&&h++;let _=0;for(let n=0;n<e.samplerTextures.length;++n){const s=e.samplerTextures[n],r=i.getUniformLocation(e.glProgram,s.name);if(null===r||"number"!=typeof r&&-1===r.id||(o.push(e.glSamplerTextures[n]),a.push(r)),void 0===c[s.name]){let e=s.binding+l.samplerOffsets[s.set]+_;s.set===l.flexibleSet&&(e-=h),c[s.name]=e%t.capabilities.maxTextureUnits,_+=s.count-1}}if(o.length){const n=[];for(let e=0;e<o.length;++e){const i=o[e];let s=c[i.name];if(void 0!==s){i.glLoc=a[e];for(let e=0;e<i.count;++e){for(;n[s];)s=(s+1)%t.capabilities.maxTextureUnits;i.units.push(s),n[s]=!0}}}let s=0;for(let e=0;e<o.length;++e){const i=o[e];if(!i.glLoc){i.glLoc=a[e];for(let e=0;e<i.count;++e){for(;n[s];)s=(s+1)%t.capabilities.maxTextureUnits;void 0===c[i.name]&&(c[i.name]=s),i.units.push(s),n[s]=!0}}}t.stateCache.glProgram!==e.glProgram&&i.useProgram(e.glProgram);for(let t=0;t<o.length;t++){const e=o[t];e.glUnits=new Int32Array(e.units),i.uniform1iv(e.glLoc,e.glUnits)}t.stateCache.glProgram!==e.glProgram&&i.useProgram(t.stateCache.glProgram)}for(let t=0;t<e.glBlocks.length;)e.glBlocks[t].glActiveUniforms.length?t++:(e.glBlocks[t]=e.glBlocks[e.glBlocks.length-1],e.glBlocks.length--);e.glSamplerTextures=o}(this._device,this._gpuShader),!0}destroy(){this._gpuShader&&(function(t,e){if(e.glProgram){const{gl:i}=t;if(!t.destroyShadersImmediately)for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];n.glShader&&(i.detachShader(e.glProgram,n.glShader),i.deleteShader(n.glShader),n.glShader=null)}i.deleteProgram(e.glProgram),e.glProgram=null}}(this._device,this._gpuShader),this._gpuShader=null)}}class TR{constructor(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new No,this.scissorRect=new Po(0,0,0,0),this.rs=new _R,this.dss=new uR,this.bs=new dR,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}initialize(t,e){for(let e=0;e<t;++e)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=e,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=e,this.glCurrentAttribLocs.fill(!1)}}class wR extends tl{constructor(...t){super(...t),this._gpuTexture=null}get gpuTexture(){return this._gpuTexture}initialize(t){return"texture"in t?(console.log("WebGL does not support texture view."),!1):(this._type=t.type,this._usage=t.usage,this._format=t.format,this._width=t.width,this._height=t.height,this._depth=t.depth,this._layerCount=t.layerCount,this._levelCount=t.levelCount,this._samples=t.samples,this._flags=t.flags,this._isPowerOf2=wa(this._width)&&wa(this._height),this._size=Pa(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(t,e){const{gl:i}=t;e.glInternalFmt=DD(e.format,i),e.glFormat=RD(e.format,i),e.glType=ID(e.format,i);let n=e.width,s=e.height;switch(e.type){case $r.TEX2D:{e.glTarget=i.TEXTURE_2D;const r=Math.max(n,s);if(r>t.capabilities.maxTextureSize&&T(9100,r,t.capabilities.maxTextureSize),!t.WEBGL_depth_texture&&Aa[e.format].hasDepth){const r=i.createRenderbuffer();r&&e.size>0&&(e.glRenderbuffer=r,t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),e.glInternalFmt===i.DEPTH_COMPONENT&&(e.glInternalFmt=i.DEPTH_COMPONENT16),i.renderbufferStorage(i.RENDERBUFFER,e.glInternalFmt,n,s))}else if(e.samples===to.X1){const r=i.createTexture();if(r&&e.size>0){e.glTexture=r;const o=t.stateCache.glTexUnits[t.stateCache.texUnit];if(o.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_2D,e.glTexture),o.glTexture=e.glTexture),Aa[e.format].isCompressed)if(e.glInternalFmt!==AD.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<e.mipLevel;++t){const r=Ea(e.format,n,s,1),o=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_2D,t,e.glInternalFmt,n,s,0,o),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else{const t=Ea(e.format,2,2,1),n=new Uint8Array(t);i.compressedTexImage2D(i.TEXTURE_2D,0,e.glInternalFmt,2,2,0,n)}else for(let t=0;t<e.mipLevel;++t)i.texImage2D(i.TEXTURE_2D,t,e.glInternalFmt,n,s,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1);e.isPowerOf2?(e.glWrapS=i.REPEAT,e.glWrapT=i.REPEAT):(e.glWrapS=i.CLAMP_TO_EDGE,e.glWrapT=i.CLAMP_TO_EDGE),e.glMinFilter=i.LINEAR,e.glMagFilter=i.LINEAR,i.texParameteri(e.glTarget,i.TEXTURE_WRAP_S,e.glWrapS),i.texParameteri(e.glTarget,i.TEXTURE_WRAP_T,e.glWrapT),i.texParameteri(e.glTarget,i.TEXTURE_MIN_FILTER,e.glMinFilter),i.texParameteri(e.glTarget,i.TEXTURE_MAG_FILTER,e.glMagFilter)}else i.deleteTexture(r)}break}case $r.CUBE:{e.glTarget=i.TEXTURE_CUBE_MAP;const r=Math.max(n,s);r>t.capabilities.maxCubeMapTextureSize&&T(9100,r,t.capabilities.maxTextureSize);const o=i.createTexture();if(o&&e.size>0){e.glTexture=o;const r=t.stateCache.glTexUnits[t.stateCache.texUnit];if(r.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,e.glTexture),r.glTexture=e.glTexture),Aa[e.format].isCompressed)if(e.glInternalFmt!==AD.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<6;++t){n=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r){const o=Ea(e.format,n,s,1),a=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,n,s,0,a),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}else for(let t=0;t<6;++t){const n=Ea(e.format,2,2,1),s=new Uint8Array(n);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,e.glInternalFmt,2,2,0,s)}else for(let t=0;t<6;++t){n=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,n,s,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}e.isPowerOf2?(e.glWrapS=i.REPEAT,e.glWrapT=i.REPEAT):(e.glWrapS=i.CLAMP_TO_EDGE,e.glWrapT=i.CLAMP_TO_EDGE),e.glMinFilter=i.LINEAR,e.glMagFilter=i.LINEAR,i.texParameteri(e.glTarget,i.TEXTURE_WRAP_S,e.glWrapS),i.texParameteri(e.glTarget,i.TEXTURE_WRAP_T,e.glWrapT),i.texParameteri(e.glTarget,i.TEXTURE_MIN_FILTER,e.glMinFilter),i.texParameteri(e.glTarget,i.TEXTURE_MAG_FILTER,e.glMagFilter)}break}default:console.error("Unsupported TextureType, create texture failed."),e.type=$r.TEX2D,e.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)}destroy(){var t,e;this._gpuTexture&&(t=this._device,(e=this._gpuTexture).glTexture&&(t.gl.deleteTexture(e.glTexture),e.glTexture=null),e.glRenderbuffer&&(t.gl.deleteRenderbuffer(e.glRenderbuffer),e.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null)}resize(t,e){const i=this._size;this._width=t,this._height=e,this._size=Pa(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){const{gl:i}=t;e.glInternalFmt=DD(e.format,i),e.glFormat=RD(e.format,i),e.glType=ID(e.format,i);let n=e.width,s=e.height;switch(e.type){case $r.TEX2D:{e.glTarget=i.TEXTURE_2D;const r=Math.max(n,s);if(r>t.capabilities.maxTextureSize&&T(9100,r,t.capabilities.maxTextureSize),e.glRenderbuffer)t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,e.glInternalFmt,n,s);else if(e.glTexture){const r=t.stateCache.glTexUnits[t.stateCache.texUnit];if(r.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_2D,e.glTexture),r.glTexture=e.glTexture),Aa[e.format].isCompressed){if(e.glInternalFmt!==AD.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<e.mipLevel;++t){const r=Ea(e.format,n,s,1),o=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_2D,t,e.glInternalFmt,n,s,0,o),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}else for(let t=0;t<e.mipLevel;++t)i.texImage2D(i.TEXTURE_2D,t,e.glInternalFmt,n,s,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}break}case $r.CUBE:{e.glTarget=i.TEXTURE_CUBE_MAP;const r=Math.max(n,s);r>t.capabilities.maxCubeMapTextureSize&&T(9100,r,t.capabilities.maxTextureSize);const o=t.stateCache.glTexUnits[t.stateCache.texUnit];if(o.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,e.glTexture),o.glTexture=e.glTexture),Aa[e.format].isCompressed){if(e.glInternalFmt!==AD.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<6;++t){n=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r){const o=Ea(e.format,n,s,1),a=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,n,s,0,a),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}}else for(let t=0;t<6;++t){n=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,n,s,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}break}default:console.error("Unsupported TextureType, create texture failed."),e.type=$r.TEX2D,e.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size)}}const ER="webglcontextlost";class PR extends Ha{constructor(...t){super(...t),this.stateCache=new TR,this.cmdAllocator=new rR,this.nullTex2D=null,this.nullTexCube=null,this._webGLRC=null,this._isAntialias=!0,this._isPremultipliedAlpha=!0,this._useVAO=!1,this._destroyShadersImmediately=!0,this._noCompressedTexSubImage2D=!1,this._bindingMappingInfo=new Fo,this._webGLContextLostHandler=null,this._extensions=null,this._EXT_texture_filter_anisotropic=null,this._EXT_blend_minmax=null,this._EXT_frag_depth=null,this._EXT_shader_texture_lod=null,this._EXT_sRGB=null,this._OES_vertex_array_object=null,this._EXT_color_buffer_half_float=null,this._WEBGL_color_buffer_float=null,this._WEBGL_compressed_texture_etc1=null,this._WEBGL_compressed_texture_etc=null,this._WEBGL_compressed_texture_pvrtc=null,this._WEBGL_compressed_texture_astc=null,this._WEBGL_compressed_texture_s3tc=null,this._WEBGL_compressed_texture_s3tc_srgb=null,this._WEBGL_debug_shaders=null,this._WEBGL_draw_buffers=null,this._WEBGL_lose_context=null,this._WEBGL_depth_texture=null,this._WEBGL_debug_renderer_info=null,this._OES_texture_half_float=null,this._OES_texture_half_float_linear=null,this._OES_texture_float=null,this._OES_texture_float_linear=null,this._OES_standard_derivatives=null,this._OES_element_index_uint=null,this._ANGLE_instanced_arrays=null}get gl(){return this._webGLRC}get webGLQueue(){return this._queue}get isAntialias(){return this._isAntialias}get isPremultipliedAlpha(){return this._isPremultipliedAlpha}get useVAO(){return this._useVAO}get destroyShadersImmediately(){return this._destroyShadersImmediately}get noCompressedTexSubImage2D(){return this._noCompressedTexSubImage2D}get bindingMappingInfo(){return this._bindingMappingInfo}get EXT_texture_filter_anisotropic(){return this._EXT_texture_filter_anisotropic}get EXT_blend_minmax(){return this._EXT_blend_minmax}get EXT_frag_depth(){return this._EXT_frag_depth}get EXT_shader_texture_lod(){return this._EXT_shader_texture_lod}get EXT_sRGB(){return this._EXT_sRGB}get OES_vertex_array_object(){return this._OES_vertex_array_object}get WEBGL_color_buffer_float(){return this._WEBGL_color_buffer_float}get WEBGL_compressed_texture_etc1(){return this._WEBGL_compressed_texture_etc1}get WEBGL_compressed_texture_pvrtc(){return this._WEBGL_compressed_texture_pvrtc}get WEBGL_compressed_texture_astc(){return this._WEBGL_compressed_texture_astc}get WEBGL_compressed_texture_s3tc(){return this._WEBGL_compressed_texture_s3tc}get WEBGL_compressed_texture_s3tc_srgb(){return this._WEBGL_compressed_texture_s3tc_srgb}get WEBGL_debug_shaders(){return this._WEBGL_debug_shaders}get WEBGL_draw_buffers(){return this._WEBGL_draw_buffers}get WEBGL_lose_context(){return this._WEBGL_lose_context}get WEBGL_depth_texture(){return this._WEBGL_depth_texture}get WEBGL_debug_renderer_info(){return this._WEBGL_debug_renderer_info}get OES_texture_half_float(){return this._OES_texture_half_float}get OES_texture_half_float_linear(){return this._OES_texture_half_float_linear}get OES_texture_float(){return this._OES_texture_float}get OES_standard_derivatives(){return this._OES_standard_derivatives}get OES_element_index_uint(){return this._OES_element_index_uint}get ANGLE_instanced_arrays(){return this._ANGLE_instanced_arrays}initialize(t){this._canvas=t.canvasElm,this._isAntialias=t.isAntialias,this._isPremultipliedAlpha=t.isPremultipliedAlpha,this._bindingMappingInfo=t.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{const t={alpha:qt.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(t){return console.error(t),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(ER,this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=Gr.WEBGL,this._deviceName="WebGL";const e=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=e.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR)),this._version=e.getParameter(e.VERSION),this._caps.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.depthBits=e.getParameter(e.DEPTH_BITS),this._caps.stencilBits=e.getParameter(e.STENCIL_BITS),this.stateCache.initialize(this._caps.maxTextureUnits,this._caps.maxVertexAttributes),this._devicePixelRatio=t.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(t.nativeWidth||this._width,0),this._nativeHeight=Math.max(t.nativeHeight||this._height,0),this._colorFmt=jr.RGBA8,24===this._caps.depthBits?8===this._caps.stencilBits?this._depthStencilFmt=jr.D24S8:this._depthStencilFmt=jr.D24:8===this._caps.stencilBits?this._depthStencilFmt=jr.D16S8:this._depthStencilFmt=jr.D16,this._extensions=e.getSupportedExtensions();let i="";if(this._extensions){for(const t of this._extensions)i+=`${t} `;console.debug(`EXTENSIONS: ${i}`)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_blend_minmax=this.getExtension("EXT_blend_minmax"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),hn.os===sn.IOS&&14===Cy.osMainVersion&&Cy.isBrowser||(this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc")),hn.browserType===Qi.UC&&(this._ANGLE_instanced_arrays=null),hn.os===sn.IOS&&Cy.osMainVersion<=10&&(this._destroyShadersImmediately=!1),this._features.fill(!1),this._EXT_blend_minmax&&(this._features[kr.BLEND_MINMAX]=!0),this._WEBGL_color_buffer_float&&(this._features[kr.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[kr.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[kr.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[kr.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[kr.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[kr.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[kr.FORMAT_RGB8]=!0,this._WEBGL_depth_texture&&(this._features[kr.FORMAT_D16]=!0,this._features[kr.FORMAT_D24]=!0,this._features[kr.FORMAT_D24S8]=!0),this._OES_element_index_uint&&(this._features[kr.ELEMENT_INDEX_UINT]=!0),this._ANGLE_instanced_arrays&&(this._features[kr.INSTANCED_ARRAYS]=!0),this._WEBGL_draw_buffers&&(this._features[kr.MULTIPLE_RENDER_TARGETS]=!0);let n="";this._WEBGL_compressed_texture_etc1&&(this._features[kr.FORMAT_ETC1]=!0,n+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[kr.FORMAT_ETC2]=!0,n+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[kr.FORMAT_DXT]=!0,n+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[kr.FORMAT_PVRTC]=!0,n+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[kr.FORMAT_ASTC]=!0,n+="astc "),this._OES_vertex_array_object&&(this._useVAO=!0),console.info(`RENDERER: ${this._renderer}`),console.info(`VENDOR: ${this._vendor}`),console.info(`VERSION: ${this._version}`),console.info(`DPR: ${this._devicePixelRatio}`),console.info(`SCREEN_SIZE: ${this._width} x ${this._height}`),console.info(`NATIVE_SIZE: ${this._nativeWidth} x ${this._nativeHeight}`),console.info(`MAX_VERTEX_UNIFORM_VECTORS: ${this._caps.maxVertexUniformVectors}`),console.info(`DEPTH_BITS: ${this._caps.depthBits}`),console.info(`STENCIL_BITS: ${this._caps.stencilBits}`),this._EXT_texture_filter_anisotropic&&console.info(`MAX_TEXTURE_MAX_ANISOTROPY_EXT: ${this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT}`),console.info(`USE_VAO: ${this._useVAO}`),console.info(`COMPRESSED_FORMAT: ${n}`),this.initStates(e),this._queue=this.createQueue(new ga(So.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new fa(this._queue)),this.nullTex2D=this.createTexture(new ko($r.TEX2D,Zr.SAMPLED,jr.RGBA8,2,2,Qr.GEN_MIPMAP)),this.nullTexCube=this.createTexture(new ko($r.CUBE,Zr.SAMPLED,jr.RGBA8,2,2,Qr.GEN_MIPMAP,6));const s=new Oo;s.texExtent.width=2,s.texExtent.height=2;const r=new Uint8Array(this.nullTex2D.size);return r.fill(0),this.copyBuffersToTexture([r],this.nullTex2D,[s]),s.texSubres.layerCount=6,this.copyBuffersToTexture([r,r,r,r,r,r],this.nullTexCube,[s]),!0}destroy(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(ER,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._extensions=null,this._webGLRC=null}resize(t,e){this._width===t&&this._height===e||(console.info(`Resizing device: ${t}x${e}`),this._canvas.width=t,this._canvas.height=e,this._width=t,this._height=e)}flushCommands(t){}acquire(){this.cmdAllocator.releaseCmds()}present(){const t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()}createCommandBuffer(t){const e=new(t.type===Ao.PRIMARY?vR:oR)(this);return e.initialize(t),e}createBuffer(t){const e=new nR(this);return e.initialize(t)?e:null}createTexture(t){const e=new wR(this);return e.initialize(t)?e:null}createSampler(t){const e=new CR(this);return e.initialize(t)?e:null}createDescriptorSet(t){const e=new PD(this);return e.initialize(t)?e:null}createShader(t){const e=new bR(this);return e.initialize(t)?e:null}createInputAssembler(t){const e=new lR(this);return e.initialize(t)?e:null}createRenderPass(t){const e=new SR(this);return e.initialize(t)?e:null}createFramebuffer(t){const e=new aR(this);return e.initialize(t)?e:null}createDescriptorSetLayout(t){const e=new cR(this);return e.initialize(t)?e:null}createPipelineLayout(t){const e=new hR(this);return e.initialize(t)?e:null}createPipelineState(t){const e=new gR(this);return e.initialize(t)?e:null}createQueue(t){const e=new xR(this);return e.initialize(t)?e:null}createGlobalBarrier(t){const e=new el(this);return e.initialize(t)?e:null}createTextureBarrier(t){const e=new il(this);return e.initialize(t)?e:null}copyBuffersToTexture(t,e,i){iR(this,t,e.gpuTexture,i)}copyTexImagesToTexture(t,e,i){!function(t,e,i,n){const{gl:s}=t,r=t.stateCache.glTexUnits[t.stateCache.texUnit];r.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),r.glTexture=i.glTexture);let o=0,a=0;switch(i.glTarget){case s.TEXTURE_2D:for(let t=0;t<n.length;t++){const r=n[t];s.texSubImage2D(s.TEXTURE_2D,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,i.glFormat,i.glType,e[o++])}break;case s.TEXTURE_CUBE_MAP:for(let t=0;t<n.length;t++){const r=n[t],l=r.texSubres.baseArrayLayer+r.texSubres.layerCount;for(a=r.texSubres.baseArrayLayer;a<l;++a)s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,i.glFormat,i.glType,e[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Qr.GEN_MIPMAP&&i.isPowerOf2&&s.generateMipmap(i.glTarget)}(this,t,e.gpuTexture,i)}copyFramebufferToBuffer(t,e,i){const n=this._webGLRC,s=t.gpuFramebuffer,r=s.gpuColorTextures[0].format,o=RD(r,n),a=ID(r,n),l=Ra(Aa[r]),c=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==s.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,s.glFramebuffer),this.stateCache.glFramebuffer=s.glFramebuffer);const h=new l(e);for(const t of i){const e=t.texExtent.width,i=t.texExtent.height;n.readPixels(t.texOffset.x,t.texOffset.y,e,i,o,a,h)}this.stateCache.glFramebuffer!==c&&(n.bindFramebuffer(n.FRAMEBUFFER,c),this.stateCache.glFramebuffer=c)}blitFramebuffer(t,e,i,n,s){}getExtension(t){const e=["","WEBKIT_","MOZ_"];for(let i=0;i<e.length;++i){const n=this.gl.getExtension(e[i]+t);if(n)return n}return null}initStates(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.depthRange(0,1),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}_onWebGLContextLost(t){C(11e3),m(t)}}t("WebGLDevice",PR),n.WebGLDevice=PR;const IR=new oi,DR=new Si;function RR(t,e,i,n){const s=i.data;let r=e.acquireBufferBatch(),o=r.byteOffset>>2,a=i.vertexCount,l=r.indicesOffset,c=r.vertexOffset;r.request(a,i.indicesCount)||(r=e.currBufferBatch,a=0,l=0,c=0);const h=r.vData,_=r.iData;t.getWorldMatrix(DR);for(let t=0;t<a;t++){const e=s[t];oi.set(IR,e.x,e.y,0),oi.transformMat4(IR,IR,DR),h[o++]=IR.x,h[o++]=IR.y,h[o++]=IR.z,h[o++]=e.u,h[o++]=e.v,si.toArray(h,n,o),o+=4}for(let t=0,e=a/4;t<e;t++){const e=c+4*t;_[l++]=e,_[l++]=e+1,_[l++]=e+2,_[l++]=e+1,_[l++]=e+3,_[l++]=e+2}}class MR{constructor(t,e){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;const i=new BR;i.initWithSize(t,e),this._texture=i,this._width=t,this._height=e,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}insertSpriteFrame(t){const e=t.rect,i=t.texture,s=this._innerTextureInfos[i.getId()];let r=e.x,o=e.y;if(s)r+=s.x,o+=s.y;else{const t=i.width,e=i.height;if(this._x+t+2>this._width&&(this._x=2,this._y=this._nexty),this._y+e+2>this._nexty&&(this._nexty=this._y+e+2),this._nexty>this._height)return null;n.internal.dynamicAtlasManager.textureBleeding&&((t<=8||e<=8)&&(this._texture.drawTextureAt(i.image,this._x-1,this._y-1),this._texture.drawTextureAt(i.image,this._x-1,this._y+1),this._texture.drawTextureAt(i.image,this._x+1,this._y-1),this._texture.drawTextureAt(i.image,this._x+1,this._y+1)),this._texture.drawTextureAt(i.image,this._x-1,this._y),this._texture.drawTextureAt(i.image,this._x+1,this._y),this._texture.drawTextureAt(i.image,this._x,this._y-1),this._texture.drawTextureAt(i.image,this._x,this._y+1)),this._texture.drawTextureAt(i.image,this._x,this._y),this._innerTextureInfos[i.getId()]={x:this._x,y:this._y,texture:i},this._count++,r+=this._x,o+=this._y,this._x+=t+2}const a={x:r,y:o,texture:this._texture};return this._innerSpriteFrames.push(t),a}deleteInnerTexture(t){t&&this._innerTextureInfos[t.getId()]&&(delete this._innerTextureInfos[t.getId()],this._count--)}isEmpty(){return this._count<=0}reset(){this._x=2,this._y=2,this._nexty=2;const t=this._innerSpriteFrames;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}}destroy(){this.reset(),this._texture.destroy()}}class BR extends Zm{initWithSize(t,e,i=Su.RGBA8888){this.reset({width:t,height:e,format:i}),this.loaded=!0,this.emit("load")}drawTextureAt(t,e,i){const n=this.getGFXTexture();if(!t||!n)return;const s=this._getGFXDevice();if(!s)return void console.warn("Unable to get device");const r=new Oo;r.texOffset.x=e,r.texOffset.y=i,r.texExtent.width=t.width,r.texExtent.height=t.height,s.copyTexImagesToTexture([t.data],n,[r])}}class OR{constructor(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){this._enabled!==t&&(t?(this.reset(),n.director.on(n.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),n.director.off(n.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=t)}get maxAtlasCount(){return this._maxAtlasCount}set maxAtlasCount(t){this._maxAtlasCount=t}get atlasCount(){return this._atlases.length}get textureBleeding(){return this._textureBleeding}set textureBleeding(t){this._textureBleeding=t}get textureSize(){return this._textureSize}set textureSize(t){this._textureSize=t}get maxFrameSize(){return this._maxFrameSize}set maxFrameSize(t){this._maxFrameSize=t}newAtlas(){let t=this._atlases[++this._atlasIndex];return t||(t=new MR(this._textureSize,this._textureSize),this._atlases.push(t)),t}beforeSceneLoad(){this.reset()}insertSpriteFrame(t){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!t||t._original)return null;if(!t.packable)return null;let e=this._atlases[this._atlasIndex];e||(e=this.newAtlas());const i=e.insertSpriteFrame(t);return i||this._atlasIndex===this._maxAtlasCount?i:(e=this.newAtlas(),e.insertSpriteFrame(t))}reset(){for(let t=0,e=this._atlases.length;t<e;t++)this._atlases[t].destroy();this._atlases.length=0,this._atlasIndex=-1}deleteAtlasSpriteFrame(t){if(!t._original)return;const e=t._original._texture;this.deleteAtlasTexture(e)}deleteAtlasTexture(t){if(t)for(let e=this._atlases.length-1;e>=0;e--)this._atlases[e].deleteInnerTexture(t),this._atlases[e].isEmpty()&&(this._atlases[e].destroy(),this._atlases.splice(e,1),this._atlasIndex--)}packToDynamicAtlas(t,e){if(!e._original&&e.packable){const t=this.insertSpriteFrame(e);t&&e._setDynamicAtlasFrame(t)}}}OR.instance=void 0;const NR=t("dynamicAtlasManager",OR.instance=new OR);var LR;n.internal.dynamicAtlasManager=NR;const FR=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}];let zR=t("SpriteFrame",u_("cc.SpriteFrame")(LR=class t extends xu{static createWithImage(e){const i=e instanceof Ru?e:new Ru(e),n=new Zm;n.image=i;const s=new t;return s.texture=n,s}get insetTop(){return this._capInsets[1]}set insetTop(t){this._capInsets[1]!==t&&(this._capInsets[1]=t,this._texture&&this._calculateSlicedUV())}get insetBottom(){return this._capInsets[3]}set insetBottom(t){this._capInsets[3]!==t&&(this._capInsets[3]=t,this._texture&&this._calculateSlicedUV())}get insetLeft(){return this._capInsets[0]}set insetLeft(t){this._capInsets[0]!==t&&(this._capInsets[0]=t,this._texture&&this._calculateSlicedUV())}get insetRight(){return this._capInsets[2]}set insetRight(t){this._capInsets[2]!==t&&(this._capInsets[2]=t,this._texture&&this._calculateSlicedUV())}get rect(){return this._rect}set rect(t){this._rect.equals(t)||(this._rect.set(t),this._texture&&this._calculateUV())}get originalSize(){return this._originalSize}set originalSize(t){this._originalSize.equals(t)||(this._originalSize.set(t),this._texture&&this._calculateUV())}get offset(){return this._offset}set offset(t){this._offset.set(t)}get rotated(){return this._rotated}set rotated(t){this._rotated!==t&&(this._rotated=t,this._texture&&this._calculateUV())}get texture(){return this._texture}set texture(t){t?this.reset({texture:t},!0):console.warn(`Error Texture in ${this.name}`)}get atlasUuid(){return this._atlasUuid}set atlasUuid(t){this._atlasUuid=t}get width(){return this._texture.width}get height(){return this._texture.height}set _textureSource(t){window.Build?this._texture=t:t&&(this._refreshTexture(t),this._calculateUV())}get flipUVX(){return this._isFlipUVX}set flipUVX(t){this._isFlipUVX=t,this._calculateUV()}get flipUVY(){return this._isFlipUVY}set flipUVY(t){this._isFlipUVY=t,this._calculateUV()}get packable(){return this._packable}set packable(t){this._packable=t}get original(){return this._original}constructor(){super(),this.vertices=null,this.uv=[],this.uvHash=0,this.unbiasUV=[],this.uvSliced=[],this._rect=new Oi,this._offset=new Ti,this._originalSize=new Mi,this._rotated=!1,this._capInsets=[0,0,0,0],this._atlasUuid="",this._texture=void 0,this._isFlipUVY=!1,this._isFlipUVX=!1,this._original=null,this._packable=!0}textureLoaded(){return this.texture&&this.texture.loaded}isRotated(){return this._rotated}setRotated(t){this.rotated=t}getRect(t){return t?(t.set(this._rect),t):this._rect.clone()}setRect(t){this.rect=t}getOriginalSize(t){return t?(t.set(this._originalSize),t):this._originalSize.clone()}setOriginalSize(t){this.originalSize=t}getOffset(t){return t?(t.set(this._offset),t):this._offset.clone()}setOffset(t){this.offset=t}getGFXTexture(){return this._texture.getGFXTexture()}getGFXSampler(){return this._texture.getGFXSampler()}getHash(){return this._texture.getHash()}getSamplerHash(){return this._texture.getSamplerHash()}reset(t,e=!1){let i=!1;e&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,i=!0),t&&(t.texture&&(this.loaded=!1,this._rect.x=this._rect.y=0,this._rect.width=t.texture.width,this._rect.height=t.texture.height,this._refreshTexture(t.texture),this.checkRect(this._texture)),t.originalSize&&this._originalSize.set(t.originalSize),t.rect&&this._rect.set(t.rect),t.offset&&this._offset.set(t.offset),void 0!==t.borderTop&&(this._capInsets[1]=t.borderTop),void 0!==t.borderBottom&&(this._capInsets[3]=t.borderBottom),void 0!==t.borderLeft&&(this._capInsets[0]=t.borderLeft),void 0!==t.borderRight&&(this._capInsets[2]=t.borderRight),void 0!==t.isRotate&&(this._rotated=!!t.isRotate),void 0!==t.isFlipUv&&(this._isFlipUVY=!!t.isFlipUv),i=!0),i&&this.texture&&this._calculateUV()}checkRect(t){const e=this._rect;let i=e.x,n=e.y;return this._rotated?(i+=e.height,n+=e.width):(i+=e.width,n+=e.height),i>t.width?(T(3300,`${this.name}/${t.name}`,i,t.width),!1):!(n>t.height&&(T(3301,`${this.name}/${t.name}`,n,t.height),1))}onLoaded(){this.loaded=!0,this.emit("load")}destroy(){return this._packable&&NR&&NR.deleteAtlasSpriteFrame(this),super.destroy()}_calculateSlicedUV(){const t=this._rect,e=this.texture,i=e.width,n=e.height,s=this._capInsets[0],r=this._capInsets[2],o=t.width-s-r,a=this._capInsets[1],l=this._capInsets[3],c=t.height-a-l,h=this.uvSliced;if(h.length=0,this._rotated){FR[0].u=t.x/i,FR[1].u=(t.x+l)/i,FR[2].u=(t.x+l+c)/i,FR[3].u=(t.x+t.height)/i,FR[3].v=t.y/n,FR[2].v=(t.y+s)/n,FR[1].v=(t.y+s+o)/n,FR[0].v=(t.y+t.width)/n;for(let t=0;t<4;++t){const e=FR[t];for(let t=0;t<4;++t){const i=FR[3-t];h.push({u:e.u,v:i.v})}}}else{FR[0].u=t.x/i,FR[1].u=(t.x+s)/i,FR[2].u=(t.x+s+o)/i,FR[3].u=(t.x+t.width)/i,FR[3].v=t.y/n,FR[2].v=(t.y+a)/n,FR[1].v=(t.y+a+c)/n,FR[0].v=(t.y+t.height)/n;for(let t=0;t<4;++t){const e=FR[t];for(let t=0;t<4;++t){const i=FR[t];h.push({u:i.u,v:e.v})}}}}_calculateUV(){const t=this._rect,e=this.uv,i=this.unbiasUV,n=this.texture,s=n.width,r=n.height;if(this._rotated){const n=0===s?0:t.x/s,o=0===s?1:(t.x+t.height)/s,a=0===r?0:t.y/r,l=0===r?1:(t.y+t.width)/r;this._isFlipUVX&&this._isFlipUVY?(e[0]=o,e[1]=l,e[2]=o,e[3]=a,e[4]=n,e[5]=l,e[6]=n,e[7]=a):this._isFlipUVX?(e[0]=o,e[1]=a,e[2]=o,e[3]=l,e[4]=n,e[5]=a,e[6]=n,e[7]=l):this._isFlipUVY?(e[0]=n,e[1]=l,e[2]=n,e[3]=a,e[4]=o,e[5]=l,e[6]=o,e[7]=a):(e[0]=n,e[1]=a,e[2]=n,e[3]=l,e[4]=o,e[5]=a,e[6]=o,e[7]=l);const c=0===s?0:t.x/s,h=0===s?1:(t.x+t.height)/s,_=0===r?0:t.y/r,u=0===r?1:(t.y+t.width)/r;this._isFlipUVX&&this._isFlipUVY?(i[0]=h,i[1]=u,i[2]=h,i[3]=_,i[4]=c,i[5]=u,i[6]=c,i[7]=_):this._isFlipUVX?(i[0]=h,i[1]=_,i[2]=h,i[3]=u,i[4]=c,i[5]=_,i[6]=c,i[7]=u):this._isFlipUVY?(i[0]=c,i[1]=u,i[2]=c,i[3]=_,i[4]=h,i[5]=u,i[6]=h,i[7]=_):(i[0]=c,i[1]=_,i[2]=c,i[3]=u,i[4]=h,i[5]=_,i[6]=h,i[7]=u)}else{const n=0===s?0:t.x/s,o=0===s?1:(t.x+t.width)/s,a=0===r?1:(t.y+t.height)/r,l=0===r?0:t.y/r;this._isFlipUVX&&this._isFlipUVY?(e[0]=o,e[1]=l,e[2]=n,e[3]=l,e[4]=o,e[5]=a,e[6]=n,e[7]=a):this._isFlipUVX?(e[0]=o,e[1]=a,e[2]=n,e[3]=a,e[4]=o,e[5]=l,e[6]=n,e[7]=l):this._isFlipUVY?(e[0]=n,e[1]=l,e[2]=o,e[3]=l,e[4]=n,e[5]=a,e[6]=o,e[7]=a):(e[0]=n,e[1]=a,e[2]=o,e[3]=a,e[4]=n,e[5]=l,e[6]=o,e[7]=l);const c=0===s?0:t.x/s,h=0===s?1:(t.x+t.width)/s,_=0===r?1:(t.y+t.height)/r,u=0===r?0:t.y/r;this._isFlipUVX&&this._isFlipUVY?(i[0]=h,i[1]=u,i[2]=c,i[3]=u,i[4]=h,i[5]=_,i[6]=c,i[7]=_):this._isFlipUVX?(i[0]=h,i[1]=_,i[2]=c,i[3]=_,i[4]=h,i[5]=u,i[6]=c,i[7]=u):this._isFlipUVY?(i[0]=c,i[1]=u,i[2]=h,i[3]=u,i[4]=c,i[5]=_,i[6]=h,i[7]=_):(i[0]=c,i[1]=_,i[2]=h,i[3]=_,i[4]=c,i[5]=u,i[6]=h,i[7]=u)}let o="";for(let t=0;t<e.length;t++)o+=e[t];this.uvHash=qa(o,666);const a=this.vertices;if(a){a.nu.length=0,a.nv.length=0;for(let t=0;t<a.u.length;t++)a.nu[t]=a.u[t]/s,a.nv[t]=a.v[t]/r}this._calculateSlicedUV()}_setDynamicAtlasFrame(t){t&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=t.texture,this._rect.x=t.x,this._rect.y=t.y,this._calculateUV())}_resetDynamicAtlasFrame(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())}_checkPackable(){const t=NR;if(!t)return;const e=this._texture;if(!(e instanceof Zm)||e.isCompressed)return void(this._packable=!1);const i=this.width,n=this.height;!e.image||i>t.maxFrameSize||n>t.maxFrameSize?this._packable=!1:e.image&&e.image instanceof HTMLCanvasElement&&(this._packable=!0)}_serialize(t){return null}_deserialize(t,e){const i=t,n=i.rect;n&&(this._rect=new Oi(n.x,n.y,n.width,n.height));const s=i.offset;i.offset&&(this._offset=new Ti(s.x,s.y));const r=i.originalSize;i.originalSize&&(this._originalSize=new Mi(r.width,r.height)),this._rotated=!!i.rotated,this._name=i.name,this._packable=!!i.packable;const o=i.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=i.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}clone(){var e,i,n,s;const r=new t,o=this.vertices;return r.vertices=o?{x:o.x,y:o.y,triangles:o.triangles,nu:null===(e=o.nu)||void 0===e?void 0:e.slice(0),u:null===(i=o.u)||void 0===i?void 0:i.slice(0),nv:null===(n=o.nv)||void 0===n?void 0:n.slice(0),v:null===(s=o.v)||void 0===s?void 0:s.slice(0)}:null,r.uv.splice(0,r.uv.length,...this.uv),r.uvHash=this.uvHash,r.unbiasUV.splice(0,r.unbiasUV.length,...this.unbiasUV),r.uvSliced.splice(0,r.uvSliced.length,...this.uvSliced),r._rect.set(this._rect),r._offset.set(this._offset),r._originalSize.set(this._originalSize),r._rotated=this._rotated,r._capInsets.splice(0,r._capInsets.length,...this._capInsets),r._atlasUuid=this._atlasUuid,r._texture=this._texture,r._isFlipUVX=this._isFlipUVX,r._isFlipUVY=this._isFlipUVY,r}_textureLoaded(){const t=this._texture,e={};let i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(e.rect=new Oi(0,0,t.width,t.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(e.originalSize=new Mi(t.width,t.height),i=!0),i&&(this.reset(e),this.onLoaded()),this._checkPackable()}_refreshTexture(t){this._texture=t,t.loaded?this._textureLoaded():t.once("load",this._textureLoaded,this)}initDefault(t){super.initDefault(t);const e=new Zm;e.initDefault(),this._refreshTexture(e),this._calculateUV()}validate(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height}})||LR);var VR,UR,GR;n.SpriteFrame=zR;let HR=t("SpriteAtlas",u_("cc.SpriteAtlas")((GR=n_((UR=class extends xu{constructor(...t){super(...t),i_(this,"spriteFrames",GR,this)}getTexture(){const t=Object.keys(this.spriteFrames);if(t.length>0){const e=this.spriteFrames[t[0]];return e&&e.texture}return null}getSpriteFrame(t){const e=this.spriteFrames[t];return e?(e.name||(e.name=t),e):null}getSpriteFrames(){const t=[],e=this.spriteFrames;for(const i of Object.keys(e))t.push(e[i]);return t}_serialize(t){}_deserialize(t,e){const i=t;this._name=i.name;const n=i.spriteFrames;this.spriteFrames=ht();for(let t=0;t<n.length;t+=2)e.result.push(this.spriteFrames,n[t],n[t+1],Lt(zR))}}).prototype,"spriteFrames",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ht()}}),VR=UR))||VR);var kR;n.SpriteAtlas=HR;let jR=t("Font",u_("cc.Font")(kR=class extends xu{})||kR);var WR,qR,XR;n.Font=jR;let YR=t("TTFFont",u_("cc.TTFFont")((XR=n_((qR=class extends jR{constructor(...t){super(...t),i_(this,"_fontFamily",XR,this)}get _nativeAsset(){return this._fontFamily}set _nativeAsset(t){this._fontFamily=t||"Arial"}get _nativeDep(){return{uuid:this._uuid,__nativeName__:this._native,ext:pn(this._native),__isNative__:!0}}}).prototype,"_fontFamily",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),n_(qR.prototype,"_nativeAsset",[k_,G_],Object.getOwnPropertyDescriptor(qR.prototype,"_nativeAsset"),qR.prototype),n_(qR.prototype,"_nativeDep",[k_],Object.getOwnPropertyDescriptor(qR.prototype,"_nativeDep"),qR.prototype),WR=qR))||WR);var KR,JR,$R,ZR,QR,tM,eM,iM;n.TTFFont=YR;class nM{constructor(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0}}class sM{constructor(t){this.letterDefinitions={},this.texture=t}addLetterDefinitions(t,e){this.letterDefinitions[t]=e}cloneLetterDefinition(){const t={};for(const e of Object.keys(this.letterDefinitions)){const i=new nM;St(i,this.letterDefinitions[e]),t[e]=i}return t}getTexture(){return this.texture}getLetter(t){return this.letterDefinitions[t]}getLetterDefinitionForChar(t,e){const i=t.charCodeAt(0);let n;return n=this.letterDefinitions.hasOwnProperty(i)?this.letterDefinitions[i]:null,n}clear(){this.letterDefinitions={}}}let rM=t("BitmapFont",(KR=u_("cc.BitmapFont"),JR=H_(zR),KR((QR=n_((ZR=class extends jR{constructor(...t){super(...t),i_(this,"fntDataStr",QR,this),i_(this,"spriteFrame",tM,this),i_(this,"fontSize",eM,this),i_(this,"fntConfig",iM,this)}onLoaded(){const t=this.spriteFrame;!this.fontDefDictionary&&t&&(this.fontDefDictionary=new sM(t.texture));const e=this.fntConfig;if(!e)return void m("The fnt config is not exists!");const i=e.fontDefDictionary;for(const t in i){const e=new nM,n=i[t].rect;e.offsetX=i[t].xOffset,e.offsetY=i[t].yOffset,e.w=n.width,e.h=n.height,e.u=n.x,e.v=n.y,e.textureID=0,e.valid=!0,e.xAdvance=i[t].xAdvance,this.fontDefDictionary.addLetterDefinitions(t,e)}}}).prototype,"fntDataStr",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),tM=n_(ZR.prototype,"spriteFrame",[JR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eM=n_(ZR.prototype,"fontSize",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),iM=n_(ZR.prototype,"fntConfig",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$R=ZR))||$R));var oM;n.BitmapFont=rM;let aM=t("LabelAtlas",u_("cc.LabelAtlas")(oM=class extends rM{})||oM);n.LabelAtlas=aM;const lM=t("BASELINE_RATIO",.26),cM=t("MIDDLE_RATIO",(lM+1)/2-lM);const hM=new Ft(2);hM.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};const _M=new class{constructor(t){this.count=0,this.limit=0,this.datas={},this.limit=t}moveToHead(t){t.next=this.head,t.prev=null,this.head&&(this.head.prev=t),this.head=t,this.tail||(this.tail=t),this.count++,this.datas[t.key]=t}put(t,e){const i=hM.get();if(i.key=t,i.value=e,this.count>=this.limit){const t=this.tail;delete this.datas[t.key],this.count--,this.tail=t.prev,this.tail.next=null,t.prev=null,t.next=null,hM.put(t)}this.moveToHead(i)}remove(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,delete this.datas[t.key],this.count--}get(t){const e=this.datas[t];return e?(this.remove(e),this.moveToHead(e),e.value):null}clear(){this.count=0,this.datas={},this.head=null,this.tail=null}has(t){return!!this.datas[t]}delete(t){const e=this.datas[t];this.remove(e)}}(100),uM=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,mM=/^[!,.:;'}\]%\?>、‘“》？。，！]/,dM=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,pM=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,fM=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function gM(t){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(t)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(t)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(t)}function yM(t){const e=t.charCodeAt(0);return e>=9&&e<=13||32===e||133===e||160===e||5760===e||e>=8192&&e<=8202||8232===e||8233===e||8239===e||8287===e||12288===e}function vM(t,e,i){const n=`${i||t.font}🎮${e}`,s=_M.get(n);if(null!==s)return s;const r=t.measureText(e),o=r&&r.width||0;return _M.put(n,o),o}function xM(t,e,i){let n=e,s=i;const r=t[e];if(r>="\udc00"&&r<="\udfff"&&n--,void 0!==i)if(i-1!==e){const e=t[i-1];e>="\ud800"&&e<="\udbff"&&s--}else r>="\ud800"&&r<="\udbff"&&s++;return t.substring(n,s)}function SM(t,e,i,n){const s=[];if(0===t.length||i<0)return s.push(""),s;let r=t;for(;e>i&&r.length>1;){let t=r.length*(i/e)|0,o=xM(r,t),a=e-n(o),l=o,c=0,h=0;const _=10;for(;a>i&&h++<_;)t*=i/a,t|=0,o=xM(r,t),a=e-n(o);for(h=0;a<=i&&h++<_;){if(o){const t=uM.exec(o);c=t?t[0].length:1,l=o}t+=c,o=xM(r,t),a=e-n(o)}t-=c,0===t?(t=1,l=xM(r,1)):1===t&&r[0]>="\ud800"&&r[0]<="\udbff"&&(t=2,l=xM(r,2));let u,m=xM(r,0,t);mM.test(l||o)&&(u=dM.exec(m),t-=u?u[0].length:0,0===t&&(t=1),l=xM(r,t),m=xM(r,0,t)),fM.test(l)&&(u=pM.exec(m),u&&m!==u[0]&&(t-=u[0].length,l=xM(r,t),m=xM(r,0,t))),0===s.length?s.push(m):(m=m.trim(),m.length>0&&s.push(m)),r=l||o,e=n(r)}return 0===s.length?s.push(r):(r=r.trim(),r.length>0&&s.push(r)),s}let AM;class CM{constructor(){this.pool=[]}static getInstance(){return AM||(AM=new CM),AM}get(){let t=this.pool.pop();if(!t){const e=document.createElement("canvas"),i=e.getContext("2d");t={canvas:e,context:i}}return t}put(t){this.pool.length>=qt.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(t)}}t("CanvasPool",CM);const bM=si.WHITE.clone();class TM{constructor(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0}}const wM=`rgba(255, 255, 255, ${(1/255).toFixed(3)})`;class EM{constructor(t,e){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=t,this.labelInfo=e,this.hash=t.charCodeAt(0)+e.hash}updateRenderData(){this._updateProperties(),this._updateTexture()}destroy(){this.image=null}_updateProperties(){if(this.data=CM.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;const t=vM(this.context,this.char,this.labelInfo.fontDesc),e=2*this.labelInfo.margin+2;this.width=parseFloat(t.toFixed(2))+e,this.height=(1+lM)*this.labelInfo.fontSize+e,this.offsetY=-this.labelInfo.fontSize*lM/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new Ru),this.image.reset(this.canvas)}_updateTexture(){if(!this.context||!this.canvas)return;const t=this.context,e=this.labelInfo,i=this.canvas.width,n=this.canvas.height;t.textAlign="center",t.textBaseline="alphabetic",t.clearRect(0,0,i,n),t.fillStyle=wM,t.fillRect(0,0,i,n),t.font=e.fontDesc;const s=e.fontSize,r=i/2,o=n/2+s*cM+0*s,a=e.color;if(t.lineJoin="round",t.fillStyle=`rgba(${a.r}, ${a.g}, ${a.b}, 1)`,e.isOutlined){const i=e.out||bM;t.strokeStyle=`rgba(${i.r}, ${i.g}, ${i.b}, ${i.a/255})`,t.lineWidth=2*e.margin,t.strokeText(this.char,r,o)}t.fillText(this.char,r,o)}}class PM extends Zm{initWithSize(t,e,i=Su.RGBA8888){this.reset({width:t,height:e,format:i}),this.loaded=!0,this.emit("load")}drawTextureAt(t,e,i){const n=this.getGFXTexture();if(!t||!n)return;const s=this._getGFXDevice();if(!s)return void console.warn("Unable to get device");const r=new Oo;r.texOffset.x=e,r.texOffset.y=i,r.texExtent.width=t.width,r.texExtent.height=t.height,s.copyTexImagesToTexture([t.data],n,[r])}}class IM{get width(){return this._width}get height(){return this._height}constructor(t,e){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;const i=new PM;i.initWithSize(t,e),this.fontDefDictionary=new sM(i),this._halfBleed=1,this._width=t,this._height=e,aT.on(oT.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}insertLetterTexture(t){const e=t.image,i=aT.root.device;if(!e||!this.fontDefDictionary||!i)return null;const n=e.width,s=e.height;if(this._x+n+0>this._width&&(this._x=0,this._y=this._nextY),this._y+s>this._nextY&&(this._nextY=this._y+s+0),this._nextY>this._height)return C(12100),null;this.fontDefDictionary.texture.drawTextureAt(e,this._x,this._y),this._dirty=!0;const r=new TM;return r.u=this._x+this._halfBleed,r.v=this._y+this._halfBleed,r.texture=this.fontDefDictionary.texture,r.valid=!0,r.w=t.width-2,r.h=t.height-2,r.xAdvance=r.w,r.offsetY=t.offsetY,this._x+=n+0,this.fontDefDictionary.addLetterDefinitions(t.hash,r),r}update(){this._dirty&&(this._dirty=!1)}reset(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()}destroy(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)}getTexture(){return this.fontDefDictionary.getTexture()}beforeSceneLoad(){this.clearAllCache()}clearAllCache(){this.destroy();const t=new PM;t.initWithSize(this._width,this._height),this.fontDefDictionary.texture=t}getLetter(t){return this.fontDefDictionary.letterDefinitions[t]}getLetterDefinitionForChar(t,e){const i=t.charCodeAt(0)+e.hash;let n=this.fontDefDictionary.letterDefinitions[i];if(!n){const i=new EM(t,e);i.updateRenderData(),n=this.insertLetterTexture(i),i.destroy()}return n}}const DM={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:si.WHITE.clone(),isOutlined:!1,out:si.WHITE.clone(),margin:0};class RM{constructor(){this.material=null,this.vertexCount=0,this.indicesCount=0}}class MM extends RM{constructor(...t){super(...t),this.vData=null,this.uvDirty=!0,this.vertDirty=!0,this._data=[],this._indices=[],this._pivotX=0,this._pivotY=0,this._width=0,this._height=0}get dataLength(){return this._data.length}set dataLength(t){const e=this._data;if(e.length!==t){const i=e.length;let n=0;for(n=t;n<i;n++)OM.free(e[n]);for(n=i;n<t;n++)e[n]=OM.alloc();e.length=t}}get data(){return this._data}static add(){return NM.add()}static remove(t){const e=NM.data.indexOf(t);-1!==e&&(NM.data[e].clear(),NM.removeAt(e))}updateSizeNPivot(t,e,i,n){t===this._width&&e===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=t,this._height=e,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)}clear(){this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indicesCount=0}}class BM extends RM{constructor(t=9){super(),this.vData=void 0,this.iData=void 0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0,this.byteCount=0,this.lastFilledIndices=0,this.lastFilledVertex=0,this._formatByte=void 0,this._formatByte=t*Float32Array.BYTES_PER_ELEMENT,this.vData=new Float32Array(256*t*Float32Array.BYTES_PER_ELEMENT),this.iData=new Uint16Array(1536)}set formatByte(t){this._formatByte=t}get formatByte(){return this._formatByte}get floatStride(){return this._formatByte>>2}get vDataOffset(){return this.byteCount>>>2}static add(){return LM.add()}static remove(t){const e=LM.data.indexOf(t);-1!==e&&(LM.data[e].reset(),LM.removeAt(e))}request(t,e){const i=this.byteCount+t*this._formatByte;return this.reserve(t,e),this.vertexCount+=t,this.indicesCount+=e,this.byteCount=i,!0}reserve(t,e){const i=this.byteCount+t*this._formatByte,n=this.indicesCount+e;if(t+this.vertexCount>65535)return!1;let s=this.vData.byteLength,r=this.iData.length,o=this.vData.length,a=this.iData.length;if(i>s||n>r){for(;s<i||r<n;)o*=2,a*=2,s=4*o,r=a;this._reallocBuffer(o,a)}return!0}advance(t,e){this.vertexCount+=t,this.indicesCount+=e,this.byteCount+=t*this._formatByte}reset(){this.vertexCount=0,this.indicesCount=0,this.byteCount=0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0,this.lastFilledIndices=0,this.lastFilledVertex=0}_reallocBuffer(t,e){const i=this.vData;this.vData=new Float32Array(t),this.vData.set(i,0);const n=this.iData;this.iData=new Uint16Array(e),this.iData.set(n,0)}}const OM=new Fi((()=>({x:0,y:0,z:0,u:0,v:0,color:si.WHITE.clone()})),128),NM=new zi((()=>new MM),32),LM=new zi((()=>new BM),32);var FM,zM,VM,UM,GM,HM,kM,jM,WM,qM,XM,YM,KM,JM;const $M=new Ti,ZM=new Ti,QM=new Si,tB=new Si,eB=new Si,iB=new Si(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),nB=new Oi;let sB,rB=function(e){return t({UITransform:e,UITransformComponent:e}),e}((FM=u_("cc.UITransform"),zM=T_(),VM=d_(110),UM=S_(),GM=N_(),HM=I_(),kM=N_(),jM=I_(),FM(WM=zM(WM=VM(WM=UM(WM=p_(WM=x_((JM=KM=class t extends Nm{constructor(...t){super(...t),this._priority=0,i_(this,"_contentSize",XM,this),i_(this,"_anchorPoint",YM,this)}get contentSize(){return this._contentSize}set contentSize(t){this._contentSize.equals(t)||(this._contentSize.set(t),this.node.emit(_p.SIZE_CHANGED))}get width(){return this._contentSize.width}set width(t){this._contentSize.width!==t&&(this._contentSize.width=t,this.node.emit(_p.SIZE_CHANGED))}get height(){return this._contentSize.height}set height(t){this.contentSize.height!==t&&(this._contentSize.height=t,this.node.emit(_p.SIZE_CHANGED))}get anchorPoint(){return this._anchorPoint}set anchorPoint(t){this._anchorPoint.equals(t)||(this._anchorPoint.set(t),this.node.emit(_p.ANCHOR_CHANGED,this._anchorPoint))}get anchorX(){return this._anchorPoint.x}set anchorX(t){this._anchorPoint.x!==t&&(this._anchorPoint.x=t,this.node.emit(_p.ANCHOR_CHANGED,this._anchorPoint))}get anchorY(){return this._anchorPoint.y}set anchorY(t){this._anchorPoint.y!==t&&(this._anchorPoint.y=t,this.node.emit(_p.ANCHOR_CHANGED,this._anchorPoint))}get priority(){return this._priority}set priority(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?C(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}get visibility(){const t=aT.root.batcher2D.getFirstRenderCamera(this.node);return t?t.visibility:0}get cameraPriority(){const t=aT.root.batcher2D.getFirstRenderCamera(this.node);return t?t.priority:0}__preload(){this.node._uiProps.uiTransformComp=this}onLoad(){this.node.parent&&t.insertChangeMap(this.node.parent)}onEnable(){this.node.on(_p.PARENT_CHANGED,this._parentChanged,this)}onDisable(){this.node.off(_p.PARENT_CHANGED,this._parentChanged,this)}onDestroy(){this.node._uiProps.uiTransformComp=null}setContentSize(t,e){const i=this._contentSize;if(void 0===e){if((t=t).width===i.width&&t.height===i.height)return;i.width=t.width,i.height=t.height}else{if(t===i.width&&e===i.height)return;i.width=t,i.height=e}this.node.emit(_p.SIZE_CHANGED)}setAnchorPoint(t,e){const i=this._anchorPoint;if(void 0===e){if((t=t).x===i.x&&t.y===i.y)return;i.x=t.x,i.y=t.y}else{if(t===i.x&&e===i.y)return;i.x=t,i.y=e}this.node.emit(_p.ANCHOR_CHANGED,this._anchorPoint)}isHit(t,e){const i=this._contentSize.width,s=this._contentSize.height,r=$M,o=ZM,a=this._getRenderScene().cameras;for(let l=0;l<a.length;l++){const c=a[l];if(!(c.visibility&this.node.layer))continue;c.node.getWorldRT(QM);const h=QM.m12,_=QM.m13,u=n.visibleRect.center;if(QM.m12=u.x-(QM.m00*h+QM.m04*_),QM.m13=u.y-(QM.m01*h+QM.m05*_),Si.invert(QM,QM),Ti.transformMat4(r,t,QM),this.node.getWorldMatrix(eB),Si.invert(QM,eB),Si.strictEquals(QM,iB))continue;Ti.transformMat4(o,r,QM),o.x+=this._anchorPoint.x*i,o.y+=this._anchorPoint.y*s;let m=!1;if(o.x>=0&&o.y>=0&&o.x<=i&&o.y<=s&&(m=!0,e&&e.mask)){const t=e.mask;let i=this.node;const n=t?t.length:0;for(let e=0,s=0;i&&s<n;++e,i=i.parent){const n=t[s];if(e===n.index){if(i!==n.comp.node){t.length=s;break}{const t=n.comp;if(t&&t._enabled&&!t.isHit(r)){m=!1;break}s++}}else if(e>n.index){t.length=s;break}}}if(m)return!0}return!1}convertToNodeSpaceAR(t,e){return this.node.getWorldMatrix(eB),Si.invert(QM,eB),e||(e=new oi),oi.transformMat4(e,t,QM)}convertToWorldSpaceAR(t,e){return this.node.getWorldMatrix(eB),e||(e=new oi),oi.transformMat4(e,t,eB)}getBoundingBox(){Si.fromRTS(tB,this.node.getRotation(),this.node.getPosition(),this.node.getScale());const t=this._contentSize.width,e=this._contentSize.height,i=new Oi(-this._anchorPoint.x*t,-this._anchorPoint.y*e,t,e);return i.transformMat4(tB),i}getBoundingBoxToWorld(){return this.node.parent?(this.node.parent.getWorldMatrix(eB),this.getBoundingBoxTo(eB)):this.getBoundingBox()}getBoundingBoxTo(e){Si.fromRTS(tB,this.node.getRotation(),this.node.getPosition(),this.node.getScale());const i=this._contentSize.width,n=this._contentSize.height,s=new Oi(-this._anchorPoint.x*i,-this._anchorPoint.y*n,i,n);if(Si.multiply(eB,e,tB),s.transformMat4(eB),!this.node.children)return s;const r=this.node.children;for(const i of r)if(i&&i.active){const n=i.getComponent(t);if(n){const t=n.getBoundingBoxTo(e);t&&Oi.union(s,s,t)}}return s}getComputeAABB(t){const e=this._contentSize.width,i=this._contentSize.height;nB.set(-this._anchorPoint.x*e,-this._anchorPoint.y*i,e,i),nB.transformMat4(this.node.worldMatrix);const n=nB.x+.5*nB.width,s=nB.y+.5*nB.height,r=this.node.worldPosition.z,o=nB.width/2,a=nB.height/2;return null!=t?(lc.set(t,n,s,r,o,a,.001),t):new lc(n,s,r,o,a,.001)}_parentChanged(e){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)}static insertChangeMap(e){const i=e.uuid;t.priorityChangeNodeMap.has(i)||t.priorityChangeNodeMap.set(i,e)}static _sortChildrenSibling(t){const e=t.children;e&&e.sort(((t,e)=>{const i=t._uiProps.uiTransformComp,n=e._uiProps.uiTransformComp,s=(i?i._priority:0)-(n?n._priority:0);return 0===s?t.getSiblingIndex()-e.getSiblingIndex():s}))}static _sortSiblings(){t.priorityChangeNodeMap.forEach((e=>{t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()}static _cleanChangeMap(){t.priorityChangeNodeMap.clear()}},KM.EventType=_p,KM.priorityChangeNodeMap=new Map,n_((qM=JM).prototype,"contentSize",[GM,HM],Object.getOwnPropertyDescriptor(qM.prototype,"contentSize"),qM.prototype),n_(qM.prototype,"anchorPoint",[kM,jM],Object.getOwnPropertyDescriptor(qM.prototype,"anchorPoint"),qM.prototype),XM=n_(qM.prototype,"_contentSize",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(100,100)}}),YM=n_(qM.prototype,"_anchorPoint",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti(.5,.5)}}),WM=qM))||WM)||WM)||WM)||WM)||WM)||WM));aT.on(oT.EVENT_AFTER_UPDATE,rB._sortSiblings),aT.on(oT.EVENT_BEFORE_SCENE_LAUNCH,rB._cleanChangeMap),function(t){t[t.DISABLED=0]="DISABLED",t[t.CLEAR=1]="CLEAR",t[t.ENTER_LEVEL=2]="ENTER_LEVEL",t[t.ENABLED=3]="ENABLED",t[t.EXIT_LEVEL=4]="EXIT_LEVEL",t[t.CLEAR_INVERTED=5]="CLEAR_INVERTED",t[t.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(sB||(sB={}));class oB{constructor(){this.stage=sB.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:no.ALWAYS,stencilMask:65535,writeMask:65535,failOp:so.KEEP,zFailOp:so.KEEP,passOp:so.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}get pattern(){return this._stencilPattern}pushMask(t){this._maskStack.push(t)}clear(t){t.stencilStage=t.inverted?sB.CLEAR_INVERTED:sB.CLEAR}enterLevel(t){t.graphics.stencilStage=t.inverted?sB.ENTER_LEVEL_INVERTED:sB.ENTER_LEVEL}enableMask(){this.stage=sB.ENABLED}exitMask(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=sB.DISABLED:this.stage=sB.ENABLED)}getWriteMask(){return 1<<this._maskStack.length-1}getExitWriteMask(){return 1<<this._maskStack.length}getStencilRef(){let t=0;for(let e=0;e<this._maskStack.length;++e)t+=1<<e;return t}reset(){this._maskStack.length=0,this.stage=sB.DISABLED}destroy(){this.stencilStateMap.forEach((t=>{t.destroy()})),this.stencilStateMap.clear()}getStencilStage(t,e){let i=0,n=!1,s=!1,r=no.LESS,o=this.stencilStateMap;if(e&&e.passes[0]){const a=e.passes[0].depthStencilState;let l=0,c=0;a.depthTest&&(l=1),a.depthWrite&&(c=1),i=l|c<<1|a.depthFunc<<2|t<<6|this._maskStack.length<<9,n=a.depthTest,s=a.depthWrite,r=a.depthFunc,o=this.stencilStateMapWithDepth}else i=t<<16|this._maskStack.length;if(o&&o.has(i))return o.get(i);this.setStateFromStage(t);const a=new cl(n,s,r,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return o.set(i,a),a}getStencilHash(t){return t<<8|this._maskStack.length}setStateFromStage(t){const e=this._stencilPattern;t===sB.DISABLED?(e.stencilTest=!1,e.func=no.ALWAYS,e.failOp=so.KEEP,e.stencilMask=e.writeMask=65535,e.ref=1):(e.stencilTest=!0,t===sB.ENABLED?(e.func=no.EQUAL,e.failOp=so.KEEP,e.stencilMask=e.ref=this.getStencilRef(),e.writeMask=this.getWriteMask()):t===sB.CLEAR?(e.func=no.NEVER,e.failOp=so.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===sB.CLEAR_INVERTED||t===sB.ENTER_LEVEL?(e.func=no.NEVER,e.failOp=so.REPLACE,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===sB.ENTER_LEVEL_INVERTED&&(e.func=no.NEVER,e.failOp=so.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()))}}var aB,lB,cB,hB,_B,uB,mB,dB,pB,fB,gB,yB,vB,xB,SB,AB,CB,bB;let TB;t("StencilManager",oB),oB.sharedManager=null,oB.sharedManager=new oB,jt(ro),function(t){t[t.ADD_COLOR=0]="ADD_COLOR",t[t.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",t[t.GRAYSCALE=2]="GRAYSCALE",t[t.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",t[t.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(TB||(TB=t("InstanceMaterialType",{})));let wB=function(e){return t({Renderable2D:e,RenderComponent:e,UIRenderable:e}),e}((aB=u_("cc.Renderable2D"),lB=m_(rB),cB=E_(),hB=H_(ov),_B=H_(ov),uB=N_(),mB=P_(),dB=N_(),pB=I_(),aB(fB=lB(fB=p_(fB=x_((bB=CB=class t extends hP{constructor(...t){super(...t),i_(this,"_materials",yB,this),i_(this,"_customMaterial",vB,this),this.stencilStage=sB.DISABLED,i_(this,"_srcBlendFactor",xB,this),i_(this,"_dstBlendFactor",SB,this),i_(this,"_color",AB,this),this._assembler=null,this._postAssembler=null,this._renderData=null,this._renderDataFlag=!0,this._renderFlag=!0,this._delegateSrc=null,this._instanceMaterialType=TB.ADD_COLOR_AND_TEXTURE,this._blendState=new al,this._blendHash=0,this._colorDirty=!0,this._cacheAlpha=1,this._lastParent=null}get sharedMaterials(){return this._materials}set sharedMaterials(t){for(let e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(let e=t.length;e<this._materials.length;e++)this.setMaterial(null,e);this._materials.splice(t.length)}}get customMaterial(){return this._customMaterial}set customMaterial(t){this._customMaterial=t,this.updateMaterial()}updateMaterial(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),void(this._blendHash=-1);const t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._updateBlendFunc()}get srcBlendFactor(){return this._customMaterial&&C(12001),this._srcBlendFactor}set srcBlendFactor(t){this._customMaterial?C(12001):this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}get dstBlendFactor(){return this._customMaterial&&C(12001),this._dstBlendFactor}set dstBlendFactor(t){this._customMaterial?C(12001):this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}get color(){return this._color}set color(t){this._color.equals(t)||(this._color.set(t),this._colorDirty=!0)}get renderData(){return this._renderData}set delegateSrc(t){this._delegateSrc=t}get blendHash(){return this._blendHash}updateBlendHash(){const t=this._blendState.targets[0].blendDst<<4;this._blendHash=t|this._blendState.targets[0].blendSrc}__preload(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()}onEnable(){this.node.on(_p.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(_p.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()}onRestore(){this.updateMaterial(),this._renderFlag=this._canRender()}onDisable(){this.node.off(_p.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(_p.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}onDestroy(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(let t=0;t<this._materialInstances.length;t++)this._materialInstances[t]&&this._materialInstances[t].destroy();this._renderData=null,this._blendState&&this._blendState.destroy()}markForUpdateRenderData(t=!0){if(this._renderFlag=this._canRender(),t&&this._renderFlag){const e=this._renderData;e&&(e.vertDirty=!0),this._renderDataFlag=t}else t||(this._renderDataFlag=t)}requestRenderData(){const t=MM.add();return this._renderData=t,t}destroyRenderData(){this._renderData&&(MM.remove(this._renderData),this._renderData=null)}updateAssembler(t){this._updateColor(),this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(t))}postUpdateAssembler(t){this._renderFlag&&this._postRender(t)}_render(t){}_postRender(t){}_checkAndUpdateRenderData(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)}_canRender(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this.node._uiProps.opacity>0}_postCanRender(){}_updateColor(){this._updateWorldAlpha(),(this._colorDirty||this._cacheAlpha!==this.node._uiProps.opacity)&&this._renderFlag&&this._assembler&&this._assembler.updateColor&&(this._assembler.updateColor(this),this._cacheAlpha=this.node._uiProps.opacity,this._colorDirty=!1)}_updateWorldAlpha(){let t=this.color.a/255;1===t&&(t=this.node._uiProps.localOpacity),this.node._uiProps.opacity=this.node.parent&&this.node.parent._uiProps?this.node.parent._uiProps.opacity*t:t,this._renderFlag=this._canRender()}_updateBlendFunc(){let t=this._blendState.targets[0];t||(t=new ol,this._blendState.setTarget(0,t)),t.blendDst===this._dstBlendFactor&&t.blendSrc===this._srcBlendFactor||(t.blend=!0,t.blendDstAlpha=ro.ONE_MINUS_SRC_ALPHA,t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor),this.updateBlendHash()}getBlendState(){return this._blendState}_nodeStateChange(e){this._renderData&&this.markForUpdateRenderData();for(let e=0;e<this.node.children.length;++e){const i=this.node.children[e].getComponent(t);i&&i.markForUpdateRenderData()}}_updateBuiltinMaterial(){let t;switch(this._instanceMaterialType){case TB.ADD_COLOR:t=Bd.get("ui-base-material");break;case TB.GRAYSCALE:t=Bd.get("ui-sprite-gray-material");break;case TB.USE_ALPHA_SEPARATED:t=Bd.get("ui-sprite-alpha-sep-material");break;case TB.USE_ALPHA_SEPARATED_AND_GRAY:t=Bd.get("ui-sprite-gray-alpha-sep-material");break;default:t=Bd.get("ui-sprite-material")}return t}_setCacheAlpha(t){this._cacheAlpha=t}},CB.BlendState=ro,CB.Assembler=null,CB.PostAssembler=null,yB=n_((gB=bB).prototype,"_materials",[k_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),n_(gB.prototype,"sharedMaterials",[k_,cB],Object.getOwnPropertyDescriptor(gB.prototype,"sharedMaterials"),gB.prototype),vB=n_(gB.prototype,"_customMaterial",[hB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),n_(gB.prototype,"customMaterial",[_B,uB,mB],Object.getOwnPropertyDescriptor(gB.prototype,"customMaterial"),gB.prototype),n_(gB.prototype,"color",[dB,pB],Object.getOwnPropertyDescriptor(gB.prototype,"color"),gB.prototype),xB=n_(gB.prototype,"_srcBlendFactor",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ro.SRC_ALPHA}}),SB=n_(gB.prototype,"_dstBlendFactor",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ro.ONE_MINUS_SRC_ALPHA}}),AB=n_(gB.prototype,"_color",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return si.WHITE.clone()}}),fB=gB))||fB)||fB)||fB)||fB));var EB,PB,IB,DB,RB,MB,BB,OB,NB,LB,FB,zB,VB,UB,GB,HB,kB,jB,WB,qB,XB,YB,KB,JB,$B,ZB,QB,tO,eO,iO,nO,sO,rO,oO,aO,lO,cO,hO,_O,uO,mO,dO,pO,fO,gO,yO,vO,xO,SO,AO,CO,bO,TO,wO,EO,PO,IO,DO,RO,MO;let BO,OO,NO,LO;n.internal.Renderable2D=wB,function(t){t[t.LEFT=0]="LEFT",t[t.CENTER=1]="CENTER",t[t.RIGHT=2]="RIGHT"}(BO||(BO=t("HorizontalTextAlignment",{}))),jt(BO),function(t){t[t.TOP=0]="TOP",t[t.CENTER=1]="CENTER",t[t.BOTTOM=2]="BOTTOM"}(OO||(OO=t("VerticalTextAlignment",{}))),jt(OO),function(t){t[t.NONE=0]="NONE",t[t.CLAMP=1]="CLAMP",t[t.SHRINK=2]="SHRINK",t[t.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(NO||(NO=t("Overflow",{}))),jt(NO),function(t){t[t.NONE=0]="NONE",t[t.BITMAP=1]="BITMAP",t[t.CHAR=2]="CHAR"}(LO||(LO=t("CacheMode",{}))),jt(LO);let FO,zO,VO,UO=function(e){return t({Label:e,LabelComponent:e}),e}((EB=u_("cc.Label"),PB=T_(),IB=d_(110),DB=S_(),RB=N_(),MB=I_(),BB=H_(BO),OB=N_(),NB=I_(),LB=H_(OO),FB=N_(),zB=I_(),VB=N_(),UB=I_(),GB=N_(),HB=E_(),kB=I_(),jB=N_(),WB=I_(),qB=H_(NO),XB=N_(),YB=I_(),KB=N_(),JB=I_(),$B=H_(jR),ZB=N_(),QB=E_(),tO=I_(),eO=N_(),iO=I_(),nO=H_(LO),sO=N_(),rO=I_(),oO=N_(),aO=I_(),lO=N_(),cO=I_(),hO=N_(),_O=I_(),uO=E_(),EB(mO=PB(mO=IB(mO=DB((MO=RO=class t extends wB{get string(){return this._string}set string(t){t+="",this._string!==t&&(this._string=t,this.updateRenderData())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(t){this._horizontalAlign!==t&&(this._horizontalAlign=t,this.updateRenderData())}get verticalAlign(){return this._verticalAlign}set verticalAlign(t){this._verticalAlign!==t&&(this._verticalAlign=t,this.updateRenderData())}get actualFontSize(){return this._actualFontSize}set actualFontSize(t){this._actualFontSize=t}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this.updateRenderData())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this.updateRenderData())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this.updateRenderData())}get overflow(){return this._overflow}set overflow(t){this._overflow!==t&&(this._overflow=t,this.updateRenderData())}get enableWrapText(){return this._enableWrapText}set enableWrapText(t){this._enableWrapText!==t&&(this._enableWrapText=t,this.updateRenderData())}get font(){return this._font}set font(t){this._font!==t&&(this._isSystemFontUsed=!t,this._font=t,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(t){this._isSystemFontUsed!==t&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!t,t&&(this.font=null),this._flushAssembler(),this.updateRenderData())}get cacheMode(){return this._cacheMode}set cacheMode(t){this._cacheMode!==t&&(this._cacheMode!==LO.BITMAP||this._font instanceof rM||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===LO.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=t,this.updateRenderData(!0))}get spriteFrame(){return this._texture}get ttfSpriteFrame(){return this._ttfSpriteFrame}get isBold(){return this._isBold}set isBold(t){this._isBold!==t&&(this._isBold=t,this.updateRenderData())}get isItalic(){return this._isItalic}set isItalic(t){this._isItalic!==t&&(this._isItalic=t,this.updateRenderData())}get isUnderline(){return this._isUnderline}set isUnderline(t){this._isUnderline!==t&&(this._isUnderline=t,this.updateRenderData())}get underlineHeight(){return this._underlineHeight}set underlineHeight(t){this._underlineHeight!==t&&(this._underlineHeight=t,this.updateRenderData())}get assemblerData(){return this._assemblerData}get fontAtlas(){return this._fontAtlas}set fontAtlas(t){this._fontAtlas=t}get spacingX(){return this._spacingX}set spacingX(t){this._spacingX!==t&&(this._spacingX=t,this.updateRenderData())}get _bmFontOriginalSize(){return this._font instanceof rM?this._font.fontSize:-1}constructor(){super(),i_(this,"_string",pO,this),i_(this,"_horizontalAlign",fO,this),i_(this,"_verticalAlign",gO,this),i_(this,"_actualFontSize",yO,this),i_(this,"_fontSize",vO,this),i_(this,"_fontFamily",xO,this),i_(this,"_lineHeight",SO,this),i_(this,"_overflow",AO,this),i_(this,"_enableWrapText",CO,this),i_(this,"_font",bO,this),i_(this,"_isSystemFontUsed",TO,this),this._spacingX=0,i_(this,"_isItalic",wO,this),i_(this,"_isBold",EO,this),i_(this,"_isUnderline",PO,this),i_(this,"_underlineHeight",IO,this),i_(this,"_cacheMode",DO,this),this._N$file=null,this._texture=null,this._ttfSpriteFrame=null,this._userDefinedFont=null,this._assemblerData=null,this._fontAtlas=null,this._letterTexture=null,this._ttfSpriteFrame=null}onEnable(){super.onEnable(),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this.updateRenderData(!0)}onDisable(){super.onDisable()}onDestroy(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){const t=this._ttfSpriteFrame.texture;if(t&&null===this._ttfSpriteFrame.original){const e=t;e.image&&e.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,super.onDestroy()}updateRenderData(t=!1){this.markForUpdateRenderData(),t&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture())}_render(t){t.commitComp(this,this._texture,this._assembler,null)}_updateColor(){this._font instanceof rM?(this._updateWorldAlpha(),this._colorDirty=!1):(this._updateWorldAlpha(),this._colorDirty?(this.updateRenderData(!1),this._colorDirty=!1):this._cacheAlpha!==this.node._uiProps.opacity&&this._renderFlag&&this._assembler&&this._assembler.updateOpacity&&(this._assembler.updateOpacity(this),this._cacheAlpha=this.node._uiProps.opacity))}_canRender(){if(!super._canRender()||!this._string)return!1;const t=this._font;if(t&&t instanceof rM){const e=t.spriteFrame;if(!e||!e.textureLoaded())return!1}return!0}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)}_applyFontTexture(){const t=this._font;if(t instanceof rM){const e=t.spriteFrame,i=()=>{this._texture=e,this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this)};e&&(e.loaded||e.textureLoaded?i():e.once("load",i,this))}else{if(this.cacheMode===LO.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new zR,this._assemblerData=this._assembler.getAssemblerData();const t=new Ru(this._assemblerData.canvas)._texture;this._ttfSpriteFrame.texture=t}this.cacheMode!==LO.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this)}}changeMaterialForDefine(){if(!this._texture)return;let t=!1;if(this.cacheMode!==LO.CHAR){const e=this._texture.texture;if(e instanceof $u){const i=e.getPixelFormat();t=i===Su.RGBA_ETC1||i===Su.RGB_A_PVRTC_4BPPV1||i===Su.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=t?TB.USE_ALPHA_SEPARATED:TB.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},RO.HorizontalAlign=BO,RO.VerticalAlign=OO,RO.Overflow=NO,RO.CacheMode=LO,RO._canvasPool=CM.getInstance(),n_((dO=MO).prototype,"string",[RB,MB,L_],Object.getOwnPropertyDescriptor(dO.prototype,"string"),dO.prototype),n_(dO.prototype,"horizontalAlign",[BB,OB,NB],Object.getOwnPropertyDescriptor(dO.prototype,"horizontalAlign"),dO.prototype),n_(dO.prototype,"verticalAlign",[LB,FB,zB],Object.getOwnPropertyDescriptor(dO.prototype,"verticalAlign"),dO.prototype),n_(dO.prototype,"fontSize",[VB,UB],Object.getOwnPropertyDescriptor(dO.prototype,"fontSize"),dO.prototype),n_(dO.prototype,"fontFamily",[GB,HB,kB],Object.getOwnPropertyDescriptor(dO.prototype,"fontFamily"),dO.prototype),n_(dO.prototype,"lineHeight",[jB,WB],Object.getOwnPropertyDescriptor(dO.prototype,"lineHeight"),dO.prototype),n_(dO.prototype,"overflow",[qB,XB,YB],Object.getOwnPropertyDescriptor(dO.prototype,"overflow"),dO.prototype),n_(dO.prototype,"enableWrapText",[KB,JB],Object.getOwnPropertyDescriptor(dO.prototype,"enableWrapText"),dO.prototype),n_(dO.prototype,"font",[$B,ZB,QB,tO],Object.getOwnPropertyDescriptor(dO.prototype,"font"),dO.prototype),n_(dO.prototype,"useSystemFont",[eO,iO],Object.getOwnPropertyDescriptor(dO.prototype,"useSystemFont"),dO.prototype),n_(dO.prototype,"cacheMode",[nO,sO,rO],Object.getOwnPropertyDescriptor(dO.prototype,"cacheMode"),dO.prototype),n_(dO.prototype,"isBold",[oO,aO],Object.getOwnPropertyDescriptor(dO.prototype,"isBold"),dO.prototype),n_(dO.prototype,"isItalic",[lO,cO],Object.getOwnPropertyDescriptor(dO.prototype,"isItalic"),dO.prototype),n_(dO.prototype,"isUnderline",[hO,_O],Object.getOwnPropertyDescriptor(dO.prototype,"isUnderline"),dO.prototype),n_(dO.prototype,"underlineHeight",[uO,w_],Object.getOwnPropertyDescriptor(dO.prototype,"underlineHeight"),dO.prototype),pO=n_(dO.prototype,"_string",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),fO=n_(dO.prototype,"_horizontalAlign",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BO.CENTER}}),gO=n_(dO.prototype,"_verticalAlign",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OO.CENTER}}),yO=n_(dO.prototype,"_actualFontSize",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vO=n_(dO.prototype,"_fontSize",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),xO=n_(dO.prototype,"_fontFamily",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),SO=n_(dO.prototype,"_lineHeight",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),AO=n_(dO.prototype,"_overflow",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NO.NONE}}),CO=n_(dO.prototype,"_enableWrapText",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),bO=n_(dO.prototype,"_font",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TO=n_(dO.prototype,"_isSystemFontUsed",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wO=n_(dO.prototype,"_isItalic",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),EO=n_(dO.prototype,"_isBold",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),PO=n_(dO.prototype,"_isUnderline",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),IO=n_(dO.prototype,"_underlineHeight",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),DO=n_(dO.prototype,"_cacheMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LO.NONE}}),mO=dO))||mO)||mO)||mO)||mO));!function(t){t[t.BUTT=0]="BUTT",t[t.ROUND=1]="ROUND",t[t.SQUARE=2]="SQUARE"}(FO||(FO={})),jt(FO),function(t){t[t.BEVEL=0]="BEVEL",t[t.ROUND=1]="ROUND",t[t.MITER=2]="MITER"}(zO||(zO={})),jt(zO),function(t){t[t.PT_CORNER=1]="PT_CORNER",t[t.PT_LEFT=2]="PT_LEFT",t[t.PT_BEVEL=4]="PT_BEVEL",t[t.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(VO||(VO={})),jt(VO);const GO=Math.PI,HO=Math.min,kO=Math.max,jO=Math.cos,WO=Math.sin,qO=Math.abs,XO=Math.sign,YO=.5522847493;function KO(t,e,i,n,s){t.moveTo(e-n,i),t.bezierCurveTo(e-n,i+s*YO,e-n*YO,i+s,e,i+s),t.bezierCurveTo(e+n*YO,i+s,e+n,i+s*YO,e+n,i),t.bezierCurveTo(e+n,i-s*YO,e+n*YO,i-s,e,i-s),t.bezierCurveTo(e-n*YO,i-s,e-n,i-s*YO,e-n,i),t.close()}function JO(t,e,i,n,s,r,o,a,l,c,h){let _=0,u=0,m=0,d=0,p=0,f=0,g=0,y=0,v=0,x=0,S=0,A=0,C=0,b=0,T=0,w=0;c>10||(_=.5*(e+n),u=.5*(i+s),m=.5*(n+r),d=.5*(s+o),p=.5*(r+a),f=.5*(o+l),g=.5*(_+m),y=.5*(u+d),C=a-e,b=l-i,T=qO((n-a)*b-(s-l)*C),w=qO((r-a)*b-(o-l)*C),(T+w)*(T+w)<t.tessTol*(C*C+b*b)?t.addPoint(a,l,0===h?h|VO.PT_BEVEL:h):(v=.5*(m+p),x=.5*(d+f),S=.5*(g+v),A=.5*(y+x),JO(t,e,i,_,u,g,y,S,A,c+1,0),JO(t,S,A,v,x,p,f,a,l,c+1,h)))}class $O extends Ti{constructor(t,e){super(t,e),this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0,this.reset()}reset(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}class ZO{constructor(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}reset(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}class QO{constructor(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=si.WHITE.clone(),this.lineCap=FO.BUTT,this.strokeColor=si.BLACK.clone(),this.lineJoin=zO.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}moveTo(t,e){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(t,e,VO.PT_CORNER),this._commandX=t,this._commandY=e}lineTo(t,e){this.addPoint(t,e,VO.PT_CORNER),this._commandX=t,this._commandY=e}bezierCurveTo(t,e,i,n,s,r){const o=this._curPath,a=o.points[o.points.length-1];a&&(a.x!==t||a.y!==e||i!==s||n!==r?(JO(this,a.x,a.y,t,e,i,n,s,r,0,VO.PT_CORNER),this._commandX=s,this._commandY=r):this.lineTo(s,r))}quadraticCurveTo(t,e,i,n){const s=this._commandX,r=this._commandY;this.bezierCurveTo(s+2/3*(t-s),r+2/3*(e-r),i+2/3*(t-i),n+2/3*(e-n),i,n)}arc(t,e,i,n,s,r){!function(t,e,i,n,s,r,o){let a=0,l=0,c=0,h=0,_=0,u=0,m=0,d=0,p=0,f=0,g=0,y=0,v=0,x=0,S=0,A=0;if(l=r-s,o=o||!1)if(qO(l)>=2*GO)l=2*GO;else for(;l<0;)l+=2*GO;else if(qO(l)>=2*GO)l=2*-GO;else for(;l>0;)l-=2*GO;for(A=0|kO(1,HO(qO(l)/(.5*GO)+.5,5)),c=l/A/2,h=qO(4/3*(1-jO(c))/WO(c)),o||(h=-h),S=0;S<=A;S++)a=s+l*(S/A),_=jO(a),u=WO(a),m=e+_*n,d=i+u*n,p=-u*n*h,f=_*n*h,0===S?t.moveTo(m,d):t.bezierCurveTo(g+v,y+x,m-p,d-f,m,d),g=m,y=d,v=p,x=f}(this,t,e,i,n,s,r)}ellipse(t,e,i,n){KO(this,t,e,i,n),this._curPath.complex=!1}circle(t,e,i){KO(this,t,e,i,i),this._curPath.complex=!1}rect(t,e,i,n){this.moveTo(t,e),this.lineTo(t+i,e),this.lineTo(t+i,e+n),this.lineTo(t,e+n),this.close(),this._curPath.complex=!1}roundRect(t,e,i,n,s){!function(t,e,i,n,s,r){if(r<.1)t.rect(e,i,n,s);else{const o=HO(r,.5*qO(n))*XO(n),a=HO(r,.5*qO(s))*XO(s);t.moveTo(e,i+a),t.lineTo(e,i+s-a),t.bezierCurveTo(e,i+s-a*(1-YO),e+o*(1-YO),i+s,e+o,i+s),t.lineTo(e+n-o,i+s),t.bezierCurveTo(e+n-o*(1-YO),i+s,e+n,i+s-a*(1-YO),e+n,i+s-a),t.lineTo(e+n,i+a),t.bezierCurveTo(e+n,i+a*(1-YO),e+n-o*(1-YO),i,e+n-o,i),t.lineTo(e+o,i),t.bezierCurveTo(e+o*(1-YO),i,e,i+a*(1-YO),e,i+a),t.close()}}(this,t,e,i,n,s),this._curPath.complex=!1}clear(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;const t=this._renderDataList;for(let e=0,i=t.length;e<i;e++){const i=t[e];i&&BM.remove(i)}this._renderDataList.length=0}close(){this._curPath.closed=!0}requestRenderData(){const t=BM.add();return this._renderDataList.push(t),t}getRenderDataList(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList}addPoint(t,e,i){const n=this._curPath;if(!n)return;const s=this._points,r=n.points;let o=s[this.pointsOffset++];o?(o.x=t,o.y=e):(o=new $O(t,e),s.push(o)),o.flags=i,r.push(o)}_addPath(){const t=this.pathLength;let e=this.paths[t];return e?e.reset():(e=new ZO,this.paths.push(e)),this.pathLength++,this._curPath=e,e}}const tN=[new rl(bo.ATTR_POSITION,jr.RGB32F)],eN=[new rl(bo.ATTR_POSITION,jr.RGB32F),new rl(bo.ATTR_COLOR,jr.RGBA32F)],iN=[new rl(bo.ATTR_POSITION,jr.RGB32F),new rl(bo.ATTR_TEX_COORD,jr.RG32F),new rl(bo.ATTR_COLOR,jr.RGBA32F)],nN=[new rl(bo.ATTR_POSITION,jr.RGB32F),new rl(bo.ATTR_TEX_COORD,jr.RG32F),new rl(bo.ATTR_COLOR,jr.RGBA32F),new rl(bo.ATTR_COLOR2,jr.RGBA32F)];function sN(t){let e=0;for(let i=0;i<t.length;i++){const n=t[i];e+=Aa[n.format].count}return e}function rN(t){let e=0;for(let i=0;i<t.length;i++){const n=t[i];e+=Aa[n.format].size}return e}var oN,aN,lN,cN,hN,_N,uN,mN,dN,pN,fN,gN,yN,vN,xN,SN,AN,CN,bN,TN,wN,EN;n.internal.vfmtPosUvColor=iN,n.internal.vfmtPosUvTwoColor=nN,t("UIVertexFormat",Object.freeze({__proto__:null,vfmt:tN,vfmtPosColor:eN,vfmtPosUvColor:iN,vfmtPosUvTwoColor:nN,getComponentPerVertex:sN,getAttributeStride:rN}));const PN=eN.concat([new rl("a_dist",jr.R32F)]),IN=sN(PN),DN=rN(PN);let RN=function(e){return t({Graphics:e,GraphicsComponent:e}),e}((oN=u_("cc.Graphics"),aN=T_(),lN=d_(110),cN=S_(),hN=H_(zO),_N=I_(),uN=H_(FO),mN=I_(),dN=I_(),pN=I_(),fN=I_(),gN=E_(),oN(yN=aN(yN=lN(yN=cN((EN=wN=class t extends wB{get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.impl&&(this.impl.lineWidth=t)}get lineJoin(){return this._lineJoin}set lineJoin(t){this._lineJoin=t,this.impl&&(this.impl.lineJoin=t)}get lineCap(){return this._lineCap}set lineCap(t){this._lineCap=t,this.impl&&(this.impl.lineCap=t)}get strokeColor(){return this._strokeColor}set strokeColor(t){this.impl&&(this._strokeColor.set(t),this.impl.strokeColor=this._strokeColor)}get fillColor(){return this._fillColor}set fillColor(t){this.impl&&(this._fillColor.set(t),this.impl.fillColor=this._fillColor)}get miterLimit(){return this._miterLimit}set miterLimit(t){this._miterLimit=t}get color(){return this._color}set color(t){this._color!==t&&this._color.set(t)}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(t){}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(t){}constructor(){super(),this.impl=null,this.model=null,i_(this,"_lineWidth",xN,this),i_(this,"_strokeColor",SN,this),i_(this,"_lineJoin",AN,this),i_(this,"_lineCap",CN,this),i_(this,"_fillColor",bN,this),i_(this,"_miterLimit",TN,this),this._isDrawing=!1,this._isNeedUploadData=!0,this._instanceMaterialType=TB.ADD_COLOR,this.impl=new QO}onRestore(){this.impl||this._flushAssembler()}onLoad(){this.model=aT.root.createModel(ex),this.model.node=this.model.transform=this.node,this._flushAssembler()}onEnable(){super.onEnable(),this._updateMtlForGraphics()}onDisable(){super.onDisable()}onDestroy(){super.onDestroy(),this._sceneGetter=null,this.model&&(aT.root.destroyModel(this.model),this.model=null),this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null)}moveTo(t,e){this.impl&&this.impl.moveTo(t,e)}lineTo(t,e){this.impl&&this.impl.lineTo(t,e)}bezierCurveTo(t,e,i,n,s,r){this.impl&&this.impl.bezierCurveTo(t,e,i,n,s,r)}quadraticCurveTo(t,e,i,n){this.impl&&this.impl.quadraticCurveTo(t,e,i,n)}arc(t,e,i,n,s,r){this.impl&&this.impl.arc(t,e,i,n,s,r)}ellipse(t,e,i,n){this.impl&&this.impl.ellipse(t,e,i,n)}circle(t,e,i){this.impl&&this.impl.circle(t,e,i)}rect(t,e,i,n){this.impl&&this.impl.rect(t,e,i,n)}roundRect(t,e,i,n,s){this.impl&&this.impl.roundRect(t,e,i,n,s)}fillRect(t,e,i,n){this.rect(t,e,i,n),this.fill()}clear(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(let t=0;t<this.model.subModels.length;t++)this.model.subModels[t].inputAssembler.indexCount=0;this.markForUpdateRenderData()}}close(){this.impl&&this.impl.close()}stroke(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)}fill(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)}_updateMtlForGraphics(){let t;this._customMaterial?t=this.getMaterialInstance(0):(t=Bd.get("ui-graphics-material"),this.setMaterial(t,0),t=this.getMaterialInstance(0),t.recompileShaders({USE_LOCAL:!0}))}activeSubModel(t){if(this.model){if(this.model.subModels.length<=t){const e=n.director.root.device,i=e.createBuffer(new zo(Xr.VERTEX|Xr.TRANSFER_DST,Jr.DEVICE,65535*DN,DN)),s=e.createBuffer(new zo(Xr.INDEX|Xr.TRANSFER_DST,Jr.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new NS([i],PN,mo.TRIANGLE_LIST,s);r.subMeshIdx=0,this.model.initSubModel(t,r,this.getMaterialInstance(0))}}else C(4500,this.node.name)}_uploadData(t){const e=this.impl;if(!e)return;const i=e&&e.getRenderDataList();if(i.length<=0||!this.model)return;const n=this.model.subModels;for(let t=0;t<i.length;t++){const e=i[t],s=n[t].inputAssembler;if(e.lastFilledVertex===e.vertexStart)continue;const r=new Float32Array(e.vData.buffer,0,e.vertexStart*IN);s.vertexBuffers[0].update(r),s.vertexCount=e.vertexStart;const o=new Uint16Array(e.iData.buffer,0,e.indicesStart);s.indexBuffer.update(o),s.indexCount=e.indicesStart,e.lastFilledVertex=e.vertexStart,e.lastFilledIndices=e.indicesStart}t.removeUploadBuffersFunc(this),this._isNeedUploadData=!1}_render(t){if(this._isNeedUploadData){if(this.impl){const t=this.impl.getRenderDataList(),e=this.model.subModels.length;if(t.length>e)for(let i=e;i<t.length;i++)this.activeSubModel(i)}t.addUploadBuffersFunc(this,this._uploadData)}t.commitModel(this,this.model,this.getMaterialInstance(0))}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}_canRender(){return!!super._canRender()&&!!this.model&&this._isDrawing}},wN.LineJoin=zO,wN.LineCap=FO,n_((vN=EN).prototype,"lineWidth",[w_],Object.getOwnPropertyDescriptor(vN.prototype,"lineWidth"),vN.prototype),n_(vN.prototype,"lineJoin",[hN,_N],Object.getOwnPropertyDescriptor(vN.prototype,"lineJoin"),vN.prototype),n_(vN.prototype,"lineCap",[uN,mN],Object.getOwnPropertyDescriptor(vN.prototype,"lineCap"),vN.prototype),n_(vN.prototype,"strokeColor",[dN],Object.getOwnPropertyDescriptor(vN.prototype,"strokeColor"),vN.prototype),n_(vN.prototype,"fillColor",[pN],Object.getOwnPropertyDescriptor(vN.prototype,"fillColor"),vN.prototype),n_(vN.prototype,"miterLimit",[fN],Object.getOwnPropertyDescriptor(vN.prototype,"miterLimit"),vN.prototype),n_(vN.prototype,"color",[k_,gN],Object.getOwnPropertyDescriptor(vN.prototype,"color"),vN.prototype),xN=n_(vN.prototype,"_lineWidth",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),SN=n_(vN.prototype,"_strokeColor",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return si.BLACK.clone()}}),AN=n_(vN.prototype,"_lineJoin",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zO.MITER}}),CN=n_(vN.prototype,"_lineCap",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FO.BUTT}}),bN=n_(vN.prototype,"_fillColor",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return si.WHITE.clone()}}),TN=n_(vN.prototype,"_miterLimit",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),yN=vN))||yN)||yN)||yN)||yN));var MN,BN,ON,NN,LN,FN,zN,VN,UN,GN,HN,kN,jN,WN,qN,XN,YN,KN,JN,$N,ZN,QN,tL,eL,iL;const nL=new Si,sL=new Ti,rL=new Si,oL=[];let aL;!function(t){t[t.RECT=0]="RECT",t[t.ELLIPSE=1]="ELLIPSE",t[t.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",t[t.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(aL||(aL={})),jt(aL);let lL=function(e){return t({Mask:e,MaskComponent:e}),e}((MN=u_("cc.Mask"),BN=T_(),ON=d_(110),NN=S_(),LN=H_(aL),FN=N_(),zN=I_(),VN=N_(),UN=I_(),GN=E_(),HN=H_(zR),kN=E_(),jN=E_(),WN=D_(),qN=E_(),XN=E_(),MN(YN=BN(YN=ON(YN=NN((iL=eL=class t extends wB{get type(){return this._type}set type(t){this._type!==t&&(this._type=t,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==aL.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}get inverted(){return this._inverted}set inverted(t){n.game.renderType!==Nv.RENDER_TYPE_CANVAS?(this._inverted=t,this.stencilStage=sB.DISABLED,this._graphics&&(this._graphics.stencilStage=sB.DISABLED)):C(4202)}get segments(){return this._segments}set segments(t){this._segments!==t&&(this._segments=Ue(t,3,1e4),this._updateGraphics())}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){if(this._spriteFrame===t)return;const e=this._spriteFrame;this._spriteFrame=t,this._type===aL.IMAGE_STENCIL&&!e&&t&&this.markForUpdateRenderData()}get alphaThreshold(){return this._alphaThreshold}set alphaThreshold(t){this._alphaThreshold!==t&&(this._alphaThreshold=t,this.type===aL.IMAGE_STENCIL&&this._graphics)&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold)}get graphics(){return this._graphics}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(t){this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(t){this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this.markForUpdateRenderData())}get customMaterial(){return this._customMaterial}set customMaterial(t){}constructor(){super(),this._clearStencilMtl=null,this._clearModel=null,i_(this,"_type",JN,this),i_(this,"_inverted",$N,this),i_(this,"_segments",ZN,this),i_(this,"_spriteFrame",QN,this),i_(this,"_alphaThreshold",tL,this),this._graphics=null,this._instanceMaterialType=TB.ADD_COLOR}onLoad(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()}onEnable(){super.onEnable(),this._updateGraphics()}onRestore(){this._createGraphics(),super.updateMaterial(),this._updateGraphics(),this._renderFlag=this._canRender()}onDisable(){super.onDisable(),this._disableGraphics()}onDestroy(){super.onDestroy(),this._clearModel&&aT.root.destroyModel(this._clearModel),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics()}isHit(t){const e=this.node._uiProps.uiTransformComp,i=e.contentSize,n=i.width,s=i.height,r=sL;this.node.getWorldMatrix(nL),Si.invert(rL,nL),Ti.transformMat4(r,t,rL);const o=e.anchorPoint;r.x+=o.x*n,r.y+=o.y*s;let a=!1;if(this.type===aL.RECT||this.type===aL.GRAPHICS_STENCIL)a=r.x>=0&&r.y>=0&&r.x<=n&&r.y<=s;else if(this.type===aL.ELLIPSE){const t=n/2,e=s/2,i=r.x-.5*n,o=r.y-.5*s;a=i*i/(t*t)+o*o/(e*e)<1}return this._inverted&&(a=!a),a}_render(t){t.commitComp(this,null,this._assembler,null)}_postRender(t){this._postAssembler&&t.commitComp(this,null,this._postAssembler,null)}_nodeStateChange(t){super._nodeStateChange(t),this._updateGraphics()}_canRender(){return!!super._canRender()&&null!==this._graphics&&(this._type!==aL.IMAGE_STENCIL||null!==this._spriteFrame)}_flushAssembler(){const e=t.Assembler.getAssembler(this),i=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==i&&(this._postAssembler=i),this._useRenderData()}_createGraphics(){if(!this._graphics){const t=this._graphics=new RN;t._objFlags|=Gi.Flags.IsOnLoadCalled,t.node=this.node,t.node.getWorldMatrix(),t.lineWidth=0;const e=si.WHITE.clone();e.a=0,t.fillColor=e}this._updateMaterial()}_updateGraphics(){if(!this._graphics||this._type!==aL.RECT&&this._type!==aL.ELLIPSE)return;const t=this.node._uiProps.uiTransformComp,e=this._graphics;e.clear();const i=t.contentSize,n=i.width,s=i.height,r=t.anchorPoint,o=-n*r.x,a=-s*r.y;if(this._type===aL.RECT)e.rect(o,a,n,s);else if(this._type===aL.ELLIPSE){const t=function(t,e,i){oL.length=0;const n=2*Math.PI/i;for(let s=0;s<i;++s)oL.push(new oi(e.x*Math.cos(n*s)+t.x,e.y*Math.sin(n*s)+t.y,0));return oL}(new oi(o+n/2,a+s/2,0),new oi(n/2,s/2,0),this._segments);for(let i=0;i<t.length;++i){const n=t[i];0===i?e.moveTo(n.x,n.y):e.lineTo(n.x,n.y)}e.close()}e.fill()}_createClearModel(){if(!this._clearModel){const t=Bd.get("default-clear-stencil");this._clearStencilMtl=new lv({parent:t,owner:this,subModelIdx:0}),this._clearModel=aT.root.createModel(ex),this._clearModel.node=this._clearModel.transform=this.node;const e=rN(tN),i=n.director.root.device,s=i.createBuffer(new zo(Xr.VERTEX|Xr.TRANSFER_DST,Jr.DEVICE,4*e,e)),r=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);s.update(r);const o=i.createBuffer(new zo(Xr.INDEX|Xr.TRANSFER_DST,Jr.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new Uint16Array([0,1,2,2,1,3]);o.update(a);const l=new NS([s],tN,mo.TRIANGLE_LIST,o);l.subMeshIdx=0,this._clearModel.initSubModel(0,l,this._clearStencilMtl)}}_updateMaterial(){if(this._graphics){const t=this._graphics;let e;t.stencilStage=sB.DISABLED,this._type===aL.IMAGE_STENCIL?(e=Bd.get("ui-alpha-test-material"),t.setMaterial(e,0),e=t.getMaterialInstance(0),e.setProperty("alphaThreshold",this._alphaThreshold)):(e=Bd.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}}_disableGraphics(){this._graphics&&this._graphics.onDisable()}_removeGraphics(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)}_useRenderData(){this._type!==aL.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())}},eL.Type=aL,n_((KN=iL).prototype,"type",[LN,FN,zN],Object.getOwnPropertyDescriptor(KN.prototype,"type"),KN.prototype),n_(KN.prototype,"inverted",[VN,UN],Object.getOwnPropertyDescriptor(KN.prototype,"inverted"),KN.prototype),n_(KN.prototype,"segments",[GN],Object.getOwnPropertyDescriptor(KN.prototype,"segments"),KN.prototype),n_(KN.prototype,"spriteFrame",[HN,kN],Object.getOwnPropertyDescriptor(KN.prototype,"spriteFrame"),KN.prototype),n_(KN.prototype,"alphaThreshold",[jN,WN,O_],Object.getOwnPropertyDescriptor(KN.prototype,"alphaThreshold"),KN.prototype),n_(KN.prototype,"color",[k_,qN],Object.getOwnPropertyDescriptor(KN.prototype,"color"),KN.prototype),n_(KN.prototype,"customMaterial",[k_,XN],Object.getOwnPropertyDescriptor(KN.prototype,"customMaterial"),KN.prototype),JN=n_(KN.prototype,"_type",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return aL.RECT}}),$N=n_(KN.prototype,"_inverted",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZN=n_(KN.prototype,"_segments",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),QN=n_(KN.prototype,"_spriteFrame",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tL=n_(KN.prototype,"_alphaThreshold",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),YN=KN))||YN)||YN)||YN)||YN));$S._comp=lL,n.Mask=lL;const cL=/^(click)(\s)*=|(param)(\s)*=/,hL=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;class _L{constructor(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}parse(t){this._resultObjectArray.length=0,this._stack.length=0;let e=0;const i=t.length;for(;e<i;){let n=t.indexOf(">",e),s=-1;if(n>=0&&(s=t.lastIndexOf("<",n),s<e-1&&(s=t.indexOf("<",n+1),n=t.indexOf(">",s+1))),s<0)this._stack.pop(),this._processResult(t.substring(e)),e=i;else{let i=t.substring(e,s);const r=t.substring(s+1,n);""===r&&(i=t.substring(e,n+1)),this._processResult(i),-1===n?n=s:"/"===t.charAt(s+1)?this._stack.pop():this._addToStack(r),e=n+1}}return this._resultObjectArray}_attributeToObject(t){t=t.trim();const e={};let i=/^(color|size)(\s)*=/.exec(t),n="",s=0,r="";if(i){if(n=i[0],""===(t=t.substring(n.length).trim()))return e;switch(s=t.indexOf(" "),n[0]){case"c":e.color=s>-1?t.substring(0,s).trim():t;break;case"s":e.size=parseInt(t)}return s>-1&&(r=t.substring(s+1).trim(),e.event=this._processEventHandler(r)),e}if(i=/^(br(\s)*\/)/.exec(t),i&&i[0].length>0&&(n=i[0].trim(),n.startsWith("br")&&"/"===n[n.length-1]))return e.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),e;i=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(t);let o="";if(i&&i[0].length>0&&(n=i[0].trim(),n.startsWith("img")&&"/"===n[n.length-1])){let r;i=hL.exec(t);let a=!1;for(;i;){if(n=(t=t.substring(t.indexOf(i[0]))).substr(0,i[0].length),o=t.substring(n.length).trim(),s=o.indexOf(" "),r=s>-1?o.substr(0,s):o,n=n.replace(/[^a-zA-Z]/g,"").trim(),n=n.toLowerCase(),t=o.substring(s).trim(),r.endsWith("/")&&(r=r.slice(0,-1)),"src"===n){switch(r.charCodeAt(0)){case 34:case 39:a=!0,r=r.slice(1,-1)}e.isImage=!0,e.src=r}else if("height"===n)e.imageHeight=parseInt(r);else if("width"===n)e.imageWidth=parseInt(r);else if("align"===n){switch(r.charCodeAt(0)){case 34:case 39:r=r.slice(1,-1)}e.imageAlign=r.toLowerCase()}else"offset"===n?e.imageOffset=r:"click"===n&&(e.event=this._processEventHandler(`${n}=${r}`));e.event&&"param"===n&&(e.event[n]=r.replace(/^"|"$/g,"")),i=hL.exec(t)}return a&&e.isImage&&this._resultObjectArray.push({text:"",style:e}),{}}if(i=/^(outline(\s)*[^>]*)/.exec(t),i){const r={color:"#ffffff",width:1};if(t=i[0].substring("outline".length).trim()){const a=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;let l;for(i=a.exec(t);i;)n=(t=t.substring(t.indexOf(i[0]))).substr(0,i[0].length),o=t.substring(n.length).trim(),s=o.indexOf(" "),l=s>-1?o.substr(0,s):o,n=n.replace(/[^a-zA-Z]/g,"").trim(),n=n.toLowerCase(),t=o.substring(s).trim(),"click"===n?e.event=this._processEventHandler(`${n}=${l}`):"color"===n?r.color=l:"width"===n&&(r.width=parseInt(l)),e.event&&"param"===n&&(e.event[n]=l.replace(/^"|"$/g,"")),i=a.exec(t)}e.outline=r}if(i=/^(on|u|b|i)(\s)*/.exec(t),i&&i[0].length>0){switch(n=i[0],t=t.substring(n.length).trim(),n[0]){case"u":e.underline=!0;break;case"i":e.italic=!0;break;case"b":e.bold=!0}if(""===t)return e;e.event=this._processEventHandler(t)}return e}_processEventHandler(t){const e={};let i=0,n=!1,s=cL.exec(t);for(;s;){let r=s[0],o="";if(n=!1,'"'===(t=t.substring(r.length).trim()).charAt(0))i=t.indexOf('"',1),i>-1&&(o=t.substring(1,i).trim(),n=!0),i++;else if("'"===t.charAt(0))i=t.indexOf("'",1),i>-1&&(o=t.substring(1,i).trim(),n=!0),i++;else{const e=/(\S)+/.exec(t);o=e?e[0]:"",i=o.length}n&&(r=r.substring(0,r.length-1).trim(),e[r]=o),t=t.substring(i).trim(),s=cL.exec(t)}return e}_addToStack(t){const e=this._attributeToObject(t);if(0===this._stack.length)this._stack.push(e);else{if(e.isNewLine||e.isImage)return;const t=this._stack[this._stack.length-1];for(const i in t)e[i]||(e[i]=t[i]);this._stack.push(e)}}_processResult(t){0!==t.length&&(t=this._escapeSpecialSymbol(t),this._stack.length>0?this._resultObjectArray.push({text:t,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:t}))}_escapeSpecialSymbol(t){for(const e of this._specialSymbolArray){const i=e[0],n=e[1];t=t.replace(i,n)}return t}}var uL,mL,dL,pL,fL,gL,yL,vL,xL,SL,AL;t("HtmlTextParser",_L);let CL=function(e){return t({LabelOutline:e,LabelOutlineComponent:e}),e}((uL=u_("cc.LabelOutline"),mL=T_(),dL=d_(110),pL=S_(),fL=m_(UO),gL=I_(),yL=I_(),uL(vL=mL(vL=dL(vL=pL(vL=fL(vL=x_((SL=n_((xL=class extends Nm{constructor(...t){super(...t),i_(this,"_color",SL,this),i_(this,"_width",AL,this)}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}get width(){return this._width}set width(t){this._width!==t&&(this._width=t,this._updateRenderData())}onEnable(){this._updateRenderData()}onDisable(){this._updateRenderData()}_updateRenderData(){const t=this.node.getComponent(UO);t&&t.updateRenderData(!0)}}).prototype,"_color",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new si(0,0,0,255)}}),AL=n_(xL.prototype,"_width",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),n_(xL.prototype,"color",[gL],Object.getOwnPropertyDescriptor(xL.prototype,"color"),xL.prototype),n_(xL.prototype,"width",[yL],Object.getOwnPropertyDescriptor(xL.prototype,"width"),xL.prototype),vL=xL))||vL)||vL)||vL)||vL)||vL)||vL));var bL,TL,wL,EL,PL,IL,DL,RL,ML,BL,OL,NL,LL,FL,zL,VL,UL,GL,HL,kL,jL,WL,qL,XL,YL,KL,JL,$L,ZL,QL,tF,eF,iF,nF,sF,rF,oF,aF,lF,cF,hF,_F,uF;!function(t){t[t.SIMPLE=0]="SIMPLE",t[t.SLICED=1]="SLICED",t[t.TILED=2]="TILED",t[t.FILLED=3]="FILLED"}(cF||(cF={})),jt(cF),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.RADIAL=2]="RADIAL"}(hF||(hF={})),jt(hF),function(t){t[t.CUSTOM=0]="CUSTOM",t[t.TRIMMED=1]="TRIMMED",t[t.RAW=2]="RAW"}(_F||(_F={})),jt(_F),function(t){t.SPRITE_FRAME_CHANGED="spriteframe-changed"}(uF||(uF={}));let mF=function(e){return t({Sprite:e,SpriteComponent:e}),e}((bL=u_("cc.Sprite"),TL=T_(),wL=d_(110),EL=S_(),PL=H_(HR),IL=N_(),DL=I_(),RL=H_(zR),ML=N_(),BL=I_(),OL=H_(cF),NL=N_(),LL=I_(),FL=H_(hF),zL=I_(),VL=I_(),UL=D_(),GL=I_(),HL=D_(),kL=I_(),jL=N_(),WL=I_(),qL=H_(_F),XL=N_(),YL=I_(),bL(KL=TL(KL=wL(KL=EL((lF=aF=class t extends wB{constructor(...t){super(...t),i_(this,"_spriteFrame",$L,this),i_(this,"_type",ZL,this),i_(this,"_fillType",QL,this),i_(this,"_sizeMode",tF,this),i_(this,"_fillCenter",eF,this),i_(this,"_fillStart",iF,this),i_(this,"_fillRange",nF,this),i_(this,"_isTrimmedMode",sF,this),i_(this,"_useGrayscale",rF,this),i_(this,"_atlas",oF,this)}get spriteAtlas(){return this._atlas}set spriteAtlas(t){this._atlas!==t&&(this._atlas=t)}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){if(this._spriteFrame===t)return;const e=this._spriteFrame;this._spriteFrame=t,this.markForUpdateRenderData(!1),this._applySpriteFrame(e)}get type(){return this._type}set type(t){this._type!==t&&(this._type=t,this._flushAssembler())}get fillType(){return this._fillType}set fillType(t){this._fillType!==t&&(t===hF.RADIAL||this._fillType===hF.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=t,this._flushAssembler()}get fillCenter(){return this._fillCenter}set fillCenter(t){this._fillCenter.x=t.x,this._fillCenter.y=t.y,this._type===cF.FILLED&&this._renderData&&this.markForUpdateRenderData()}get fillStart(){return this._fillStart}set fillStart(t){this._fillStart=Ue(t,-1,1),this._type===cF.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}get fillRange(){return this._fillRange}set fillRange(t){this._fillRange=Ue(t,-1,1),this._type===cF.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}get trim(){return this._isTrimmedMode}set trim(t){this._isTrimmedMode!==t&&(this._isTrimmedMode=t,this._type===cF.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}get grayscale(){return this._useGrayscale}set grayscale(t){this._useGrayscale!==t&&(this._useGrayscale=t,this._instanceMaterialType=!0===t?TB.GRAYSCALE:TB.ADD_COLOR_AND_TEXTURE,this.updateMaterial())}get sizeMode(){return this._sizeMode}set sizeMode(t){this._sizeMode!==t&&(this._sizeMode=t,t!==_F.CUSTOM&&this._applySpriteSize())}__preload(){this.changeMaterialForDefine(),super.__preload(),this._spriteFrame&&this._spriteFrame.once("load",this._onTextureLoaded,this)}onEnable(){super.onEnable(),this._activateMaterial(),this._markForUpdateUvDirty()}onDestroy(){this.destroyRenderData(),this._spriteFrame&&!this._spriteFrame.loaded&&this._spriteFrame.off("load",this._onTextureLoaded,this),super.onDestroy()}changeSpriteFrameFromAtlas(t){if(!this._atlas)return void console.warn("SpriteAtlas is null.");const e=this._atlas.getSpriteFrame(t);this.spriteFrame=e}changeMaterialForDefine(){let t;const e=this._instanceMaterialType;this._spriteFrame&&(t=this._spriteFrame.texture);let i=!1;if(t instanceof $u){const e=t.getPixelFormat();i=e===Su.RGBA_ETC1||e===Su.RGB_A_PVRTC_4BPPV1||e===Su.RGB_A_PVRTC_2BPPV1}i&&this.grayscale?this._instanceMaterialType=TB.USE_ALPHA_SEPARATED_AND_GRAY:i?this._instanceMaterialType=TB.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=TB.GRAYSCALE:this._instanceMaterialType=TB.ADD_COLOR_AND_TEXTURE,e!==this._instanceMaterialType&&this.updateMaterial()}_updateBuiltinMaterial(){let t=super._updateBuiltinMaterial();if(this.spriteFrame&&this.spriteFrame.texture instanceof Jy){const e={SAMPLE_FROM_RT:!0,...t.passes[0].defines},i=new ov;i.initialize({effectAsset:t.effectAsset,defines:e}),t=i}return t}_render(t){t.commitComp(this,this._spriteFrame,this._assembler,null)}_canRender(){if(!super._canRender())return!1;const t=this._spriteFrame;return!(!t||!t.textureLoaded())}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this._colorDirty=!0,this._updateColor())}_applySpriteSize(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(_F.RAW===this._sizeMode){const t=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(t)}else if(_F.TRIMMED===this._sizeMode){const t=this._spriteFrame.getRect();this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}}_resized(){}_activateMaterial(){const t=this._spriteFrame,e=this.getRenderMaterial(0);n.game.renderType!==n.game.RENDER_TYPE_CANVAS?(t&&e&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=e)):this.markForUpdateRenderData()}_onTextureLoaded(){this.isValid&&(this.changeMaterialForDefine(),this._applySpriteSize())}_applySpriteFrame(t){const e=this._spriteFrame;this._renderData&&(t&&!t.loaded&&t.off("load",this._onTextureLoaded,this),this._renderData.uvDirty||(this._renderData.uvDirty=!t||!e||t.uvHash!==e.uvHash),this._renderDataFlag=this._renderData.uvDirty),e&&(t&&e===t||(e.loaded?this._onTextureLoaded():e.once("load",this._onTextureLoaded,this)))}_markForUpdateUvDirty(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)}},aF.FillType=hF,aF.Type=cF,aF.SizeMode=_F,aF.EventType=uF,n_((JL=lF).prototype,"spriteAtlas",[PL,IL,DL],Object.getOwnPropertyDescriptor(JL.prototype,"spriteAtlas"),JL.prototype),n_(JL.prototype,"spriteFrame",[RL,ML,BL],Object.getOwnPropertyDescriptor(JL.prototype,"spriteFrame"),JL.prototype),n_(JL.prototype,"type",[OL,NL,LL],Object.getOwnPropertyDescriptor(JL.prototype,"type"),JL.prototype),n_(JL.prototype,"fillType",[FL,zL],Object.getOwnPropertyDescriptor(JL.prototype,"fillType"),JL.prototype),n_(JL.prototype,"fillCenter",[VL],Object.getOwnPropertyDescriptor(JL.prototype,"fillCenter"),JL.prototype),n_(JL.prototype,"fillStart",[UL,GL],Object.getOwnPropertyDescriptor(JL.prototype,"fillStart"),JL.prototype),n_(JL.prototype,"fillRange",[HL,kL],Object.getOwnPropertyDescriptor(JL.prototype,"fillRange"),JL.prototype),n_(JL.prototype,"trim",[jL,WL],Object.getOwnPropertyDescriptor(JL.prototype,"trim"),JL.prototype),n_(JL.prototype,"grayscale",[w_],Object.getOwnPropertyDescriptor(JL.prototype,"grayscale"),JL.prototype),n_(JL.prototype,"sizeMode",[qL,XL,YL],Object.getOwnPropertyDescriptor(JL.prototype,"sizeMode"),JL.prototype),$L=n_(JL.prototype,"_spriteFrame",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZL=n_(JL.prototype,"_type",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cF.SIMPLE}}),QL=n_(JL.prototype,"_fillType",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hF.HORIZONTAL}}),tF=n_(JL.prototype,"_sizeMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _F.TRIMMED}}),eF=n_(JL.prototype,"_fillCenter",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti(0,0)}}),iF=n_(JL.prototype,"_fillStart",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nF=n_(JL.prototype,"_fillRange",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sF=n_(JL.prototype,"_isTrimmedMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),rF=n_(JL.prototype,"_useGrayscale",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oF=n_(JL.prototype,"_atlas",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),KL=JL))||KL)||KL)||KL)||KL));var dF;let pF=t("RenderRoot2D",u_("cc.RenderRoot2D")(dF=d_(100)(dF=S_()(dF=m_(rB)(dF=p_(dF=x_(dF=class extends Nm{onEnable(){n.director.root.batcher2D.addScreen(this)}onDisable(){n.director.root.batcher2D.removeScreen(this)}onDestroy(){n.director.root.batcher2D.removeScreen(this)}})||dF)||dF)||dF)||dF)||dF)||dF);var fF,gF,yF,vF,xF,SF,AF,CF,bF,TF,wF,EF;const PF=new oi,IF=Gt({OVERLAY:0,INTERSPERSE:1});let DF=function(e){return t({Canvas:e,CanvasComponent:e}),e}((fF=u_("cc.Canvas"),gF=T_(),yF=d_(100),vF=S_(),xF=H_(ZE),SF=I_(),AF=I_(),CF=H_(ZE),fF(bF=gF(bF=yF(bF=vF(bF=x_(bF=p_((n_((TF=class extends pF{get renderMode(){return this._renderMode}set renderMode(t){this._renderMode=t,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}get cameraComponent(){return this._cameraComponent}set cameraComponent(t){this._cameraComponent!==t&&(this._cameraComponent=t,this._onResizeCamera())}get alignCanvasWithScreen(){return this._alignCanvasWithScreen}set alignCanvasWithScreen(t){this._alignCanvasWithScreen=t,this._onResizeCamera()}constructor(){super(),i_(this,"_cameraComponent",wF,this),i_(this,"_alignCanvasWithScreen",EF,this),this._thisOnCameraResized=void 0,this._fitDesignResolution=void 0,this._pos=new oi,this._renderMode=IF.OVERLAY,this._thisOnCameraResized=this._onResizeCamera.bind(this)}__preload(){const t=this.getComponent("cc.Widget");t&&t.updateAlignment(),this._cameraComponent&&this._cameraComponent._createCamera(),this._onResizeCamera(),this.node.on(_p.TRANSFORM_CHANGED,this._thisOnCameraResized)}onDestroy(){super.onDestroy(),this.node.off(_p.TRANSFORM_CHANGED,this._thisOnCameraResized)}_onResizeCamera(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture){const t=this._cameraComponent.targetTexture.window;this._cameraComponent.camera&&this._cameraComponent.camera.setFixedSize(t.width,t.height),this._cameraComponent.orthoHeight=Fv.height/2}else if(Lv.canvas){const t=Lv.canvas;this._cameraComponent.camera&&this._cameraComponent.camera.resize(t.width,t.height),this._cameraComponent.orthoHeight=Lv.canvas.height/kv.getScaleY()/2}this.node.getWorldPosition(PF),this._cameraComponent.node.setWorldPosition(PF.x,PF.y,1e3)}}_getViewPriority(){if(this._cameraComponent){var t;let e=null===(t=this.cameraComponent)||void 0===t?void 0:t.priority;return e=this._renderMode===IF.OVERLAY?e|1<<30:e&~(1<<30),e}return 0}}).prototype,"cameraComponent",[xF,SF],Object.getOwnPropertyDescriptor(TF.prototype,"cameraComponent"),TF.prototype),n_(TF.prototype,"alignCanvasWithScreen",[AF],Object.getOwnPropertyDescriptor(TF.prototype,"alignCanvasWithScreen"),TF.prototype),wF=n_(TF.prototype,"_cameraComponent",[CF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),EF=n_(TF.prototype,"_alignCanvasWithScreen",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),bF=TF))||bF)||bF)||bF)||bF)||bF)||bF));var RF;n.Canvas=DF;let MF=t("UIComponent",u_("cc.UIComponent")(RF=m_(rB)(RF=d_(110)(RF=p_(RF=x_(RF=class extends Nm{constructor(...t){super(...t),this._lastParent=null,this.stencilStage=sB.DISABLED}__preload(){this.node._uiProps.uiComp=this}onEnable(){}onDisable(){}onDestroy(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)}updateAssembler(t){}postUpdateAssembler(t){}})||RF)||RF)||RF)||RF)||RF);var BF,OF,NF,LF,FF,zF,VF,UF,GF,HF,kF,jF,WF,qF,XF,YF,KF,JF,$F,ZF,QF,tz,ez,iz,nz,sz,rz,oz,az,lz,cz,hz,_z,uz,mz;V(MF.prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),z(DF.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter(t){this._cameraComponent&&(this._cameraComponent.clearFlags=t)}},{name:"color",newName:"cameraComponent.clearColor",customGetter(){return this._cameraComponent?this._cameraComponent.clearColor:si.BLACK},customSetter(t){this._cameraComponent&&(this._cameraComponent.clearColor=t)}},{name:"priority",newName:"cameraComponent.priority",customGetter(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter(t){this._cameraComponent&&(this._cameraComponent.priority=t)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter(t){this._cameraComponent&&(this._cameraComponent.targetTexture=t)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),U(wB.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),U(rB.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),n.UITransformComponent=rB,Vt.setClassAlias(rB,"cc.UITransformComponent"),Vt.setClassAlias(wB,"cc.RenderComponent"),n.CanvasComponent=DF,Vt.setClassAlias(DF,"cc.CanvasComponent");const dz=new _L,pz="RICHTEXT_CHILD",fz="RICHTEXT_Image_CHILD",gz=new Ft((t=>{if(!n.isValid(t.node))return!1;{const e=t.node.getComponent(CL);e&&(e.width=0)}return!0}),20),yz=new Ft((t=>n.isValid(t.node)),10);function vz(t){return{node:new uf(t),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:t}}function xz(t,e){let i;t===pz?i=gz._get():t===fz&&(i=yz._get()),i=i||vz(t);let n=i.node;return n||(n=new uf(t)),n.hideFlags|=Gi.Flags.DontSave|Gi.Flags.HideInHierarchy,t===fz?(i.comp=n.getComponent(mF)||n.addComponent(mF),i.comp.spriteFrame=e,i.comp.type=mF.Type.SLICED,i.comp.sizeMode=mF.SizeMode.CUSTOM):(i.comp=n.getComponent(UO)||n.addComponent(UO),i.comp.string=e,i.comp.horizontalAlign=BO.LEFT,i.comp.verticalAlign=OO.TOP),n.setPosition(0,0,0),n._uiProps.uiTransformComp.setAnchorPoint(.5,.5),i.node=n,i.lineCount=0,i.styleIndex=0,i.imageOffset="",i.clickParam="",i.clickHandler="",i}let Sz=function(e){return t({RichText:e,RichTextComponent:e}),e}((BF=u_("cc.RichText"),OF=T_(),NF=d_(110),LF=S_(),FF=I_(),zF=H_(BO),VF=I_(),UF=I_(),GF=I_(),HF=H_(jR),kF=I_(),jF=I_(),WF=H_(LO),qF=I_(),XF=I_(),YF=I_(),KF=H_(HR),JF=I_(),$F=I_(),BF(ZF=OF(ZF=NF(ZF=LF(ZF=x_((mz=uz=class extends MF{get string(){return this._string}set string(t){this._string!==t&&(this._string=t,this._updateRichTextStatus())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(t){this.horizontalAlign!==t&&(this._horizontalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this._layoutDirty=!0,this._updateRichTextStatus())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this._layoutDirty=!0,this._updateRichTextStatus())}get font(){return this._font}set font(t){this._font!==t&&(this._font=t,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(t){this._isSystemFontUsed!==t&&(this._isSystemFontUsed=t,this._layoutDirty=!0,this._updateRichTextStatus())}get cacheMode(){return this._cacheMode}set cacheMode(t){this._cacheMode!==t&&(this._cacheMode=t,this._updateRichTextStatus())}get maxWidth(){return this._maxWidth}set maxWidth(t){this._maxWidth!==t&&(this._maxWidth=t,this._layoutDirty=!0,this._updateRichTextStatus())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this._layoutDirty=!0,this._updateRichTextStatus())}get imageAtlas(){return this._imageAtlas}set imageAtlas(t){this._imageAtlas!==t&&(this._imageAtlas=t,this._layoutDirty=!0,this._updateRichTextStatus())}get handleTouchEvent(){return this._handleTouchEvent}set handleTouchEvent(t){this._handleTouchEvent!==t&&(this._handleTouchEvent=t,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}constructor(){super(),i_(this,"_lineHeight",tz,this),i_(this,"_string",ez,this),i_(this,"_horizontalAlign",iz,this),i_(this,"_fontSize",nz,this),i_(this,"_maxWidth",sz,this),i_(this,"_fontFamily",rz,this),i_(this,"_font",oz,this),i_(this,"_isSystemFontUsed",az,this),i_(this,"_userDefinedFont",lz,this),i_(this,"_cacheMode",cz,this),i_(this,"_imageAtlas",hz,this),i_(this,"_handleTouchEvent",_z,this),this._textArray=[],this._segments=[],this._labelSegmentsCache=[],this._linesWidth=[],this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0,this._lineOffsetX=0,this._updateRichTextStatus=void 0,this._updateRichTextStatus=this._updateRichText}onLoad(){this.node.on(_p.LAYER_CHANGED,this._applyLayer,this)}onEnable(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}onDisable(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}start(){this._onTTFLoaded(),this.node.on(uf.EventType.ANCHOR_CHANGED,this._updateRichTextPosition,this)}onRestore(){}onDestroy(){for(const t of this._segments)t.node.removeFromParent(),t.type===pz?gz.put(t):t.type===fz&&yz.put(t);this.node.off(uf.EventType.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(_p.LAYER_CHANGED,this._applyLayer,this)}_addEventListeners(){this.node.on(uf.EventType.TOUCH_END,this._onTouchEnded,this)}_removeEventListeners(){this.node.off(uf.EventType.TOUCH_END,this._onTouchEnded,this)}_updateLabelSegmentTextAttributes(){this._segments.forEach((t=>{this._applyTextAttribute(t)}))}_createFontLabel(t){return xz(pz,t)}_createImage(t){return xz(fz,t)}_onTTFLoaded(){this._font instanceof YR?this._font._nativeAsset?(this._layoutDirty=!0,this._updateRichText()):lw.postLoadNative(this._font,(()=>{this.isValid&&(this._layoutDirty=!0,this._updateRichText())})):(this._layoutDirty=!0,this._updateRichText())}_measureText(t,e){const i=e=>{let i;return 0===this._labelSegmentsCache.length?(i=this._createFontLabel(e),this._labelSegmentsCache.push(i)):(i=this._labelSegmentsCache[0],i.node.getComponent(UO).string=e),i.styleIndex=t,this._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return e?i(e):i}_onTouchEnded(t){const e=this.node.getComponents(Nm);for(const i of this._segments){const n=i.clickHandler,s=i.clickParam;n&&this._containsTouchLocation(i,t.touch.getUILocation())&&(e.forEach((e=>{const i=e[n];e.enabledInHierarchy&&i&&i.call(e,t,s)})),t.propagationStopped=!0)}}_containsTouchLocation(t,e){const i=t.node.getComponent(rB);return!!i&&i.getBoundingBoxToWorld().contains(e)}_resetState(){const t=this.node.children;for(let e=t.length-1;e>=0;e--){const i=t[e];if(i.name===pz||i.name===fz){i.parent===this.node?i.parent=null:t.splice(e,1);const n=vz(i.name);n.node=i,i.name===pz?(n.comp=i.getComponent(UO),gz.put(n)):(n.comp=i.getComponent(mF),yz.put(n))}}t.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}_activateChildren(t){for(let e=this.node.children.length-1;e>=0;e--){const i=this.node.children[e];i.name!==pz&&i.name!==fz||(i.active=t)}}_addLabelSegment(t,e){let i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(t);else{i=this._labelSegmentsCache.pop();const e=i.node.getComponent(UO);e&&(e.string=t)}return i.styleIndex=e,i.lineCount=this._lineCount,i.node._uiProps.uiTransformComp.setAnchorPoint(0,0),i.node.layer=this.node.layer,this._applyTextAttribute(i),this.node.addChild(i.node),this._segments.push(i),i}_updateRichTextWithMaxWidth(t,e,i){let n,s=e;if(this._lineOffsetX>0&&s+this._lineOffsetX>this._maxWidth){let e=0;for(;this._lineOffsetX<=this._maxWidth;){const n=this._getFirstWordLen(t,e,t.length),r=t.substr(e,n),o=this._measureText(i,r);if(!(this._lineOffsetX+o<=this._maxWidth)){if(e>0){const n=t.substr(0,e);this._addLabelSegment(n,i),t=t.substr(e,t.length),s=this._measureText(i,t)}this._updateLineInfo();break}this._lineOffsetX+=o,e+=n}}if(s>this._maxWidth){const e=SM(t,s,this._maxWidth,this._measureText(i));for(let t=0;t<e.length;++t){const s=e[t];n=this._addLabelSegment(s,i);const r=n.node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=r.width,e.length>1&&t<e.length-1&&this._updateLineInfo()}}else this._lineOffsetX+=s,this._addLabelSegment(t,i)}_isLastComponentCR(t){return t.length-1===t.lastIndexOf("\n")}_updateLineInfo(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}_needsUpdateTextLayout(t){if(this._layoutDirty||!this._textArray||!t)return!0;if(this._textArray.length!==t.length)return!0;for(let e=0;e<this._textArray.length;e++){const i=this._textArray[e],n=t[e];if(i.text!==n.text)return!0;{const t=i.style,e=n.style;if(t){if(e){if(!!e.outline!=!!t.outline)return!0;if(t.size!==e.size||t.italic!==e.italic||t.isImage!==e.isImage)return!0;if(t.src!==e.src||t.imageAlign!==e.imageAlign||t.imageHeight!==e.imageHeight||t.imageWidth!==e.imageWidth||t.imageOffset!==e.imageOffset)return!0}else if(t.size||t.italic||t.isImage||t.outline)return!0}else if(e&&(e.size||e.italic||e.isImage||e.outline))return!0}}return!1}_addRichTextImageElement(t){if(!t.style)return;const e=t.style,i=e.src,n=this._imageAtlas&&i&&this._imageAtlas.getSpriteFrame(i);if(n){const t=this._createImage(n);switch(t.comp,e.imageAlign){case"top":t.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":t.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:t.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.node.layer=this.node.layer,this.node.addChild(t.node),this._segments.push(t);const i=n.rect.clone();let s=1,r=i.width,o=i.height;const a=e.imageWidth||0,l=e.imageHeight||0;l>0?(s=l/o,r*=s,o*=s):(s=this._lineHeight/o,r*=s,o*=s),a>0&&(r=a),this._maxWidth>0?(this._lineOffsetX+r>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=r):(this._lineOffsetX+=r,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),t.node._uiProps.uiTransformComp.setContentSize(r,o),t.lineCount=this._lineCount,t.clickHandler="",t.clickParam="";const c=e.event;c&&(t.clickHandler=c.click,t.clickParam=c.param)}else C(4400)}_updateRichText(){if(!this.enabledInHierarchy)return;const t=dz.parse(this._string);if(!this._needsUpdateTextLayout(t))return this._textArray=t.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=t.slice(),this._resetState();let e,i=!1;for(let t=0;t<this._textArray.length;++t){const n=this._textArray[t],s=n.text;if(void 0===s)continue;if(""===s){if(n.style&&n.style.isNewLine){this._updateLineInfo();continue}if(n.style&&n.style.isImage&&this._imageAtlas){this._addRichTextImageElement(n);continue}}const r=s.split("\n");for(let n=0;n<r.length;++n){const o=r[n];if(""!==o)if(i=!1,this._maxWidth>0){const e=this._measureText(t,o);this._updateRichTextWithMaxWidth(o,e,t),r.length>1&&n<r.length-1&&this._updateLineInfo()}else e=this._addLabelSegment(o,t),this._lineOffsetX+=e.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),r.length>1&&n<r.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(s)&&n===r.length-1)continue;this._updateLineInfo(),i=!0}}}i||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+lM)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}_getFirstWordLen(t,e,i){let n=t.charAt(e);if(gM(n)||yM(n))return 1;let s=1;for(let r=e+1;r<i&&(n=t.charAt(r),!yM(n)&&!gM(n));++r)s++;return s}_updateRichTextPosition(){let t=0,e=1;const i=this._lineCount,n=this.node._uiProps.uiTransformComp,s=n.anchorX,r=n.anchorY;for(let n=0;n<this._segments.length;++n){const o=this._segments[n],a=o.lineCount;a>e&&(t=0,e=a);let l=this._labelWidth*(.5*this._horizontalAlign-s);switch(this._horizontalAlign){case BO.LEFT:break;case BO.CENTER:l-=this._linesWidth[a-1]/2;break;case BO.RIGHT:l-=this._linesWidth[a-1]}const c=o.node.position;if(o.node.setPosition(t+l,this._lineHeight*(i-a)-this._labelHeight*r,c.z),a===e&&(t+=o.node._uiProps.uiTransformComp.width),o.node.getComponent(mF)){const t=o.node.position.clone(),e=this._lineHeight,i=this._lineHeight*(1+lM);switch(o.node._uiProps.uiTransformComp.anchorY){case 1:t.y+=e+(i-e)/2;break;case.5:t.y+=i/2;break;default:t.y+=(i-e)/2}if(o.imageOffset){const e=o.imageOffset.split(",");if(1===e.length&&e[0]){const i=parseFloat(e[0]);Number.isInteger(i)&&(t.y+=i)}else if(2===e.length){const i=parseFloat(e[0]),n=parseFloat(e[1]);Number.isInteger(i)&&(t.x+=i),Number.isInteger(n)&&(t.y+=n)}}o.node.position=t}const h=o.node.getComponent(CL);if(h){const t=o.node.position.clone();t.y-=h.width,o.node.position=t}}}_convertLiteralColorValue(t){const e=t.toUpperCase();return si[e]?si[e]:(new si).fromHEX(t)}_applyTextAttribute(t){const e=t.node.getComponent(UO);if(!e)return;const i=t.styleIndex;let n;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(e.color=this._convertLiteralColorValue(n.color||"white"),e.isBold=!!n.bold,e.isItalic=!!n.italic,e.isUnderline=!!n.underline,n.outline){let e=t.node.getComponent(CL);e||(e=t.node.addComponent(CL)),e.color=this._convertLiteralColorValue(n.outline.color),e.width=n.outline.width}e.fontSize=n.size||this._fontSize,t.clickHandler="",t.clickParam="";const i=n.event;i&&(t.clickHandler=i.click||"",t.clickParam=i.param||"")}else e.fontSize=this._fontSize;e.cacheMode=this._cacheMode,this._font instanceof jR&&!this._isSystemFontUsed?e.font=this._font:e.fontFamily=this._fontFamily,e.useSystemFont=this._isSystemFontUsed,e.lineHeight=this._lineHeight,e.updateRenderData(!0);const s=e._assembler;s&&s.updateRenderData(e)}_applyLayer(){for(const t of this._segments)t.node.layer=this.node.layer}},uz.HorizontalAlign=BO,uz.VerticalAlign=OO,n_((QF=mz).prototype,"string",[L_,FF],Object.getOwnPropertyDescriptor(QF.prototype,"string"),QF.prototype),n_(QF.prototype,"horizontalAlign",[zF,VF],Object.getOwnPropertyDescriptor(QF.prototype,"horizontalAlign"),QF.prototype),n_(QF.prototype,"fontSize",[UF],Object.getOwnPropertyDescriptor(QF.prototype,"fontSize"),QF.prototype),n_(QF.prototype,"fontFamily",[GF],Object.getOwnPropertyDescriptor(QF.prototype,"fontFamily"),QF.prototype),n_(QF.prototype,"font",[HF,kF],Object.getOwnPropertyDescriptor(QF.prototype,"font"),QF.prototype),n_(QF.prototype,"useSystemFont",[jF],Object.getOwnPropertyDescriptor(QF.prototype,"useSystemFont"),QF.prototype),n_(QF.prototype,"cacheMode",[WF,qF],Object.getOwnPropertyDescriptor(QF.prototype,"cacheMode"),QF.prototype),n_(QF.prototype,"maxWidth",[XF],Object.getOwnPropertyDescriptor(QF.prototype,"maxWidth"),QF.prototype),n_(QF.prototype,"lineHeight",[YF],Object.getOwnPropertyDescriptor(QF.prototype,"lineHeight"),QF.prototype),n_(QF.prototype,"imageAtlas",[KF,JF],Object.getOwnPropertyDescriptor(QF.prototype,"imageAtlas"),QF.prototype),n_(QF.prototype,"handleTouchEvent",[$F],Object.getOwnPropertyDescriptor(QF.prototype,"handleTouchEvent"),QF.prototype),tz=n_(QF.prototype,"_lineHeight",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),ez=n_(QF.prototype,"_string",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),iz=n_(QF.prototype,"_horizontalAlign",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BO.LEFT}}),nz=n_(QF.prototype,"_fontSize",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),sz=n_(QF.prototype,"_maxWidth",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rz=n_(QF.prototype,"_fontFamily",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),oz=n_(QF.prototype,"_font",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),az=n_(QF.prototype,"_isSystemFontUsed",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lz=n_(QF.prototype,"_userDefinedFont",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cz=n_(QF.prototype,"_cacheMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LO.NONE}}),hz=n_(QF.prototype,"_imageAtlas",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_z=n_(QF.prototype,"_handleTouchEvent",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ZF=QF))||ZF)||ZF)||ZF)||ZF)||ZF));var Az;let Cz=function(e){return t({UIMeshRenderer:e,UIModelComponent:e}),e}(u_("cc.UIMeshRenderer")(Az=T_()(Az=d_(110)(Az=S_()(Az=class extends MF{constructor(...t){super(...t),this._models=null,this._modelComponent=null}get modelComponent(){return this._modelComponent}onLoad(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn(`node '${this.node&&this.node.name}' doesn't have any renderable component`)}onEnable(){super.onEnable()}onDisable(){super.onDisable()}onDestroy(){super.onDestroy(),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)}updateAssembler(t){if(this._models){this._modelComponent._detachFromScene();for(const e of this._models)t.commitModel.call(t,this,e,this._modelComponent.material);return!0}return!1}update(){this._fitUIRenderQueue()}_fitUIRenderQueue(){if(!this._modelComponent)return;const t=this._modelComponent.sharedMaterials.length;for(let e=0;e<t;e++){const t=this._modelComponent.getMaterialInstance(e);if(null==t)continue;const i=t.passes,n=i.length;for(let e=0;e<n;e++){const n=i[e];n._priority=Ic.MAX-11,n.blendState.targets[0].blend||t.overridePipelineStates({blendState:{targets:[{blend:!0}]}},e)}}}})||Az)||Az)||Az)||Az);class bz{get attributes(){return this._attributes}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}constructor(t){this.vData=null,this.iData=null,this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=1,this._attributes=null,this._vertexBuffers=[],this._indexBuffer=null,this._iaInfo=null,this._batcher=void 0,this._dirty=!1,this._vertexFormatBytes=0,this._initVDataCount=0,this._initIDataCount=1536,this._outOfCallback=null,this._hInputAssemblers=[],this._nextFreeIAHandle=0,this._batcher=t}get vertexFormatBytes(){return this._vertexFormatBytes}initialize(t,e){this._outOfCallback=e;const i=sN(t);this._vertexFormatBytes=i*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes;const n=Float32Array.BYTES_PER_ELEMENT*i;this.vertexBuffers.length||this.vertexBuffers.push(this._batcher.device.createBuffer(new zo(Xr.VERTEX|Xr.TRANSFER_DST,Jr.HOST|Jr.DEVICE,n,n)));const s=Uint16Array.BYTES_PER_ELEMENT;this.indexBuffer||(this._indexBuffer=this._batcher.device.createBuffer(new zo(Xr.INDEX|Xr.TRANSFER_DST,Jr.HOST|Jr.DEVICE,s,s))),this._attributes=t,this._iaInfo=new na(this.attributes,this.vertexBuffers,this.indexBuffer),this._reallocBuffer()}request(t=4,e=6){this.lastByteOffset=this.byteOffset;const i=this.byteOffset+t*this._vertexFormatBytes,n=this.indicesOffset+e;if(t+this.vertexOffset>65535)return this._outOfCallback&&this._outOfCallback.call(this._batcher,t,e),!1;let s=this.vData.byteLength,r=this.iData.length;if(i>s||n>r){for(;s<i||r<n;)this._initVDataCount*=2,this._initIDataCount*=2,s=4*this._initVDataCount,r=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=t,this.indicesOffset+=e,this.byteOffset=i,this._dirty=!0,!0}reset(){this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=0,this._nextFreeIAHandle=0,this._dirty=!1}destroy(){this._attributes=null,this.vertexBuffers[0].destroy(),this.vertexBuffers.length=0,this.indexBuffer.destroy(),this._indexBuffer=null;for(let t=0;t<this._hInputAssemblers.length;t++)Vn.free(this._hInputAssemblers[t]);this._hInputAssemblers.length=0}recordBatch(){const t=this.indicesOffset-this.indicesStart;if(!t)return 0;this._hInputAssemblers.length<=this._nextFreeIAHandle&&this._hInputAssemblers.push(Vn.alloc(this._batcher.device,this._iaInfo));const e=this._hInputAssemblers[this._nextFreeIAHandle++],i=Vn.get(e);return i.firstIndex=this.indicesStart,i.indexCount=t,e}uploadBuffers(){if(0===this.byteOffset||!this._dirty)return;const t=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),e=new Uint16Array(this.iData.buffer,0,this.indicesOffset);this.byteOffset>this.vertexBuffers[0].size&&this.vertexBuffers[0].resize(this.byteOffset),this.vertexBuffers[0].update(t),2*this.indicesOffset>this.indexBuffer.size&&this.indexBuffer.resize(2*this.indicesOffset),this.indexBuffer.update(e),this._dirty=!1}_reallocBuffer(){this._reallocVData(!0),this._reallocIData(!0)}_reallocVData(t){let e;if(this.vData&&(e=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),e&&t){const t=new Uint8Array(this.vData.buffer);for(let i=0,n=e.length;i<n;i++)t[i]=e[i]}}_reallocIData(t){const e=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),e&&t){const t=this.iData;for(let i=0,n=e.length;i<n;i++)t[i]=e[i]}}}t("MeshBuffer",bz),bz.OPACITY_OFFSET=8;const Tz=Ec.Enum.NONE|Ec.Enum.UI_3D;class wz{get handle(){return this._handle}get hInputAssembler(){return ls.get(this._handle,os.INPUT_ASSEMBLER)}set hInputAssembler(t){ls.set(this._handle,os.INPUT_ASSEMBLER,t)}get hDescriptorSet(){return ls.get(this._handle,os.DESCRIPTOR_SET)}set hDescriptorSet(t){ls.set(this._handle,os.DESCRIPTOR_SET,t)}get visFlags(){return ls.get(this._handle,os.VIS_FLAGS)}set visFlags(t){ls.set(this._handle,os.VIS_FLAGS,t)}get passes(){return this._passes}constructor(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._handle=0,this._passes=[],this._handle=ls.alloc(),ls.set(this._handle,os.VIS_FLAGS,Tz),ls.set(this._handle,os.INPUT_ASSEMBLER,0),ls.set(this._handle,os.DESCRIPTOR_SET,0)}destroy(t){if(this._handle){const t=this.passes.length;for(let e=0;e<t;e++)this.passes[e]._destroyHandle();this._passes=[],ls.free(this._handle),this._handle=0}}clear(){this.bufferBatch=null,this.hInputAssembler=0,this.hDescriptorSet=0,this.camera=null,this.texture=null,this.sampler=null,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=Tz}fillPasses(t,e,i,s,r,o){if(t){const a=t.passes;if(!a)return;ls.set(this._handle,os.PASS_COUNT,a.length);let l=os.PASS_0,c=os.SHADER_0,h=0;for(let t=0;t<a.length;t++,l++,c++){this._passes[t]||(this._passes[t]=new Vd(n.director.root),this._passes[t]._handle=Qn.alloc());const _=a[t],u=this._passes[t];e||(e=_.depthStencilState,i=0),s||(s=_.blendState,r=0),-1===r&&(r=0),h=i<<16|r,_.update(),u._initPassFromTarget(_,e,s,h),ls.set(this._handle,l,u.handle),ls.set(this._handle,c,u.getShaderVariant(o))}}}}var Ez,Pz,Iz,Dz,Rz,Mz,Bz;t("UIDrawBatch",wz);let Oz=function(e){return t({UIStaticBatch:e,UIStaticBatchComponent:e}),e}((Ez=u_("cc.UIStaticBatch"),Pz=T_(),Iz=S_(),Dz=d_(110),Rz=E_(),Ez(Mz=Pz(Mz=Iz(Mz=Dz((n_((Bz=class extends wB{constructor(...t){super(...t),this._init=!1,this._meshBuffer=null,this._dirty=!0,this._lastMeshBuffer=null,this._uiDrawBatchList=[]}get color(){return this._color}set color(t){this._color!==t&&this._color.set(t)}get drawBatchList(){return this._uiDrawBatchList}onLoad(){const t=this._getBatcher();if(!t)return;const e=iN,i=new bz(t);i.initialize(e,this._arrivalMaxBuffer.bind(this)),this._meshBuffer=i}onDestroy(){super.onDestroy(),this._clearData(),this._meshBuffer&&(this._meshBuffer.destroy(),this._meshBuffer=null)}updateAssembler(t){t.currIsStatic=!0,this._dirty&&(t.finishMergeBatches(),this._lastMeshBuffer=t.currBufferBatch,t.currBufferBatch=this._meshBuffer,t.currStaticRoot=this),this._init&&(t.finishMergeBatches(),t.commitStaticBatch(this))}postUpdateAssembler(t){this._dirty&&(t.finishMergeBatches(),t.currBufferBatch=this._lastMeshBuffer,t.currStaticRoot=null,this._dirty=!1,this._init=!0,this.node._static=!0,this._meshBuffer.uploadBuffers()),t.currIsStatic=!1}markAsDirty(){this._getBatcher()&&(this.node._static=!1,this._dirty=!0,this._init=!1,this._clearData())}_requireDrawBatch(){const t=new wz;return t.isStatic=!0,this._uiDrawBatchList.push(t),t}_clearData(){if(this._meshBuffer){this._meshBuffer.reset();const t=this._getBatcher();for(let e=0;e<this._uiDrawBatchList.length;e++)this._uiDrawBatchList[e].destroy(t)}this._uiDrawBatchList.length=0,this._init=!1}_getBatcher(){return aT.root&&aT.root.batcher2D?aT.root.batcher2D:(C(9301),null)}_arrivalMaxBuffer(){const t=this._getBatcher();t&&t.autoMergeBatches(),C(9300)}}).prototype,"color",[k_,Rz],Object.getOwnPropertyDescriptor(Bz.prototype,"color"),Bz.prototype),Mz=Bz))||Mz)||Mz)||Mz)||Mz));var Nz,Lz,Fz,zz,Vz,Uz,Gz,Hz,kz,jz,Wz,qz,Xz;let Yz=t("LabelShadow",(Nz=u_("cc.LabelShadow"),Lz=T_(),Fz=d_(110),zz=S_(),Vz=m_(UO),Uz=I_(),Gz=I_(),Hz=I_(),Nz(kz=Lz(kz=Fz(kz=zz(kz=Vz(kz=x_((Wz=n_((jz=class extends Nm{constructor(...t){super(...t),i_(this,"_color",Wz,this),i_(this,"_offset",qz,this),i_(this,"_blur",Xz,this)}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}get offset(){return this._offset}set offset(t){this._offset=t,this._updateRenderData()}get blur(){return this._blur}set blur(t){this._blur=t,this._updateRenderData()}onEnable(){this._updateRenderData()}onDisable(){this._updateRenderData()}_updateRenderData(){const t=this.node.getComponent(UO);t&&t.updateRenderData(!0)}}).prototype,"_color",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new si(0,0,0,255)}}),qz=n_(jz.prototype,"_offset",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti(2,2)}}),Xz=n_(jz.prototype,"_blur",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),n_(jz.prototype,"color",[Uz],Object.getOwnPropertyDescriptor(jz.prototype,"color"),jz.prototype),n_(jz.prototype,"offset",[Gz],Object.getOwnPropertyDescriptor(jz.prototype,"offset"),jz.prototype),n_(jz.prototype,"blur",[Hz],Object.getOwnPropertyDescriptor(jz.prototype,"blur"),jz.prototype),kz=jz))||kz)||kz)||kz)||kz)||kz)||kz));var Kz,Jz,$z;let Zz=function(e){return t({UIOpacity:e,UIOpacityComponent:e}),e}(u_("cc.UIOpacity")(Kz=T_()(Kz=d_(110)(Kz=S_()(Kz=x_((n_((Jz=class extends Nm{constructor(...t){super(...t),i_(this,"_opacity",$z,this)}get opacity(){return this._opacity}set opacity(t){this._opacity!==t&&(t=ie(t,0,255),this._opacity=t,this.node._uiProps.localOpacity=t/255)}onEnable(){this.node._uiProps.localOpacity=this._opacity/255}onDisable(){this.node._uiProps.localOpacity=1}}).prototype,"opacity",[w_],Object.getOwnPropertyDescriptor(Jz.prototype,"opacity"),Jz.prototype),$z=n_(Jz.prototype,"_opacity",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),Kz=Jz))||Kz)||Kz)||Kz)||Kz)||Kz);n.MaskComponent=lL,Vt.setClassAlias(lL,"cc.MaskComponent"),n.LabelComponent=UO,Vt.setClassAlias(UO,"cc.LabelComponent"),n.LabelOutlineComponent=CL,Vt.setClassAlias(CL,"cc.LabelOutlineComponent"),n.RichTextComponent=Sz,Vt.setClassAlias(Sz,"cc.RichTextComponent"),n.SpriteComponent=mF,Vt.setClassAlias(mF,"cc.SpriteComponent"),n.UIModelComponent=Cz,Vt.setClassAlias(Cz,"cc.UIModelComponent"),n.GraphicsComponent=RN,Vt.setClassAlias(RN,"cc.GraphicsComponent"),Vt.setClassAlias(Oz,"cc.UIStaticBatchComponent"),Vt.setClassAlias(Zz,"cc.UIOpacityComponent");class Qz{constructor(t,e,i){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=e,this.y=i}}function tV(t,e,i,n,s){let r=0,o=null;if(s===function(t,e,i,n){let s=0;for(let r=e,o=i-n;r<i;r+=n)s+=(t[o]-t[r])*(t[r+1]+t[o+1]),o=r;return s}(t,e,i,n)>0)for(r=e;r<i;r+=n)o=yV(r,t[r],t[r+1],o);else for(r=i-n;r>=e;r-=n)o=yV(r,t[r],t[r+1],o);return o&&dV(o,o.next)&&(vV(o),o=o.next),o}function eV(t,e=null){if(!t)return t;e||(e=t);let i=t,n=!1;do{if(n=!1,i.steiner||!dV(i,i.next)&&0!==mV(i.prev,i,i.next))i=i.next;else{if(vV(i),i=e=i.prev,i===i.next)return null;n=!0}}while(n||i!==e);return e}function iV(t,e,i,n,s,r,o=0){if(!t)return;!o&&r&&function(t,e,i,n){let s=t;do{null===s.z&&(s.z=cV(s.x,s.y,e,i,n)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==t);s.prevZ.nextZ=null,s.prevZ=null,function(t){let e=0,i=null,n=null,s=null,r=null,o=0,a=0,l=0,c=1;do{for(i=t,t=null,r=null,o=0;i;){for(o++,n=i,a=0,e=0;e<c&&(a++,n=n.nextZ,n);e++);for(l=c;a>0||l>0&&n;)0===a?(s=n,n=n.nextZ,l--):0!==l&&n?i.z<=n.z?(s=i,i=i.nextZ,a--):(s=n,n=n.nextZ,l--):(s=i,i=i.nextZ,a--),r?r.nextZ=s:t=s,s.prevZ=r,r=s;i=n}r.nextZ=null,c*=2}while(o>1)}(s)}(t,n,s,r);let a=t,l=null,c=null;for(;t.prev!==t.next;)if(l=t.prev,c=t.next,r?sV(t,n,s,r):nV(t))e.push(l.i/i),e.push(t.i/i),e.push(c.i/i),vV(t),t=c.next,a=c.next;else if((t=c)===a){o?1===o?iV(t=rV(t,e,i),e,i,n,s,r,2):2===o&&oV(t,e,i,n,s,r):iV(eV(t),e,i,n,s,r,1);break}}function nV(t){const e=t.prev,i=t,n=t.next;if(mV(e,i,n)>=0)return!1;let s=t.next.next;for(;s!==t.prev;){if(_V(e.x,e.y,i.x,i.y,n.x,n.y,s.x,s.y)&&mV(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function sV(t,e,i,n){const s=t.prev,r=t,o=t.next;if(mV(s,r,o)>=0)return!1;const a=s.x<r.x?s.x<o.x?s.x:o.x:r.x<o.x?r.x:o.x,l=s.y<r.y?s.y<o.y?s.y:o.y:r.y<o.y?r.y:o.y,c=s.x>r.x?s.x>o.x?s.x:o.x:r.x>o.x?r.x:o.x,h=s.y>r.y?s.y>o.y?s.y:o.y:r.y>o.y?r.y:o.y,_=cV(a,l,e,i,n),u=cV(c,h,e,i,n);let m=t.nextZ;for(;m&&m.z<=u;){if(m!==t.prev&&m!==t.next&&_V(s.x,s.y,r.x,r.y,o.x,o.y,m.x,m.y)&&mV(m.prev,m,m.next)>=0)return!1;m=m.nextZ}for(m=t.prevZ;m&&m.z>=_;){if(m!==t.prev&&m!==t.next&&_V(s.x,s.y,r.x,r.y,o.x,o.y,m.x,m.y)&&mV(m.prev,m,m.next)>=0)return!1;m=m.prevZ}return!0}function rV(t,e,i){let n=t;do{const s=n.prev,r=n.next.next;!dV(s,r)&&pV(s,n,n.next,r)&&fV(s,r)&&fV(r,s)&&(e.push(s.i/i),e.push(n.i/i),e.push(r.i/i),vV(n),vV(n.next),n=t=r),n=n.next}while(n!==t);return n}function oV(t,e,i,n,s,r){let o=t;do{let t=o.next.next;for(;t!==o.prev;){if(o.i!==t.i&&uV(o,t)){let a=gV(o,t);return o=eV(o,o.next),a=eV(a,a.next),iV(o,e,i,n,s,r),void iV(a,e,i,n,s,r)}t=t.next}o=o.next}while(o!==t)}function aV(t,e){return t.x-e.x}function lV(t,e){if(e=function(t,e){let i=e;const n=t.x,s=t.y;let r=-1/0,o=null;do{if(s<=i.y&&s>=i.next.y){const t=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(t<=n&&t>r){if(r=t,t===n){if(s===i.y)return i;if(s===i.next.y)return i.next}o=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!o)return null;if(n===r)return o.prev;const a=o,l=o.x,c=o.y;let h,_=1/0;for(i=o.next;i!==a;)n>=i.x&&i.x>=l&&_V(s<c?n:r,s,l,c,s<c?r:n,s,i.x,i.y)&&(h=Math.abs(s-i.y)/(n-i.x),(h<_||h===_&&i.x>o.x)&&fV(i,t)&&(o=i,_=h)),i=i.next;return o}(t,e)){const i=gV(e,t);eV(i,i.next)}}function cV(t,e,i,n,s){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/s)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/s)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function hV(t){let e=t,i=t;do{e.x<i.x&&(i=e),e=e.next}while(e!==t);return i}function _V(t,e,i,n,s,r,o,a){return(s-o)*(e-a)-(t-o)*(r-a)>=0&&(t-o)*(n-a)-(i-o)*(e-a)>=0&&(i-o)*(r-a)-(s-o)*(n-a)>=0}function uV(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&pV(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&fV(t,e)&&fV(e,t)&&function(t,e){let i=t,n=!1;const s=(t.x+e.x)/2,r=(t.y+e.y)/2;do{i.y>r!=i.next.y>r&&s<(i.next.x-i.x)*(r-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}(t,e)}function mV(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function dV(t,e){return t.x===e.x&&t.y===e.y}function pV(t,e,i,n){return!!(dV(t,e)&&dV(i,n)||dV(t,n)&&dV(i,e))||mV(t,e,i)>0!=mV(t,e,n)>0&&mV(i,n,t)>0!=mV(i,n,e)>0}function fV(t,e){return mV(t.prev,t,t.next)<0?mV(t,e,t.next)>=0&&mV(t,t.prev,e)>=0:mV(t,e,t.prev)<0||mV(t,t.next,e)<0}function gV(t,e){const i=new Qz(t.i,t.x,t.y),n=new Qz(e.i,e.x,e.y),s=t.next,r=e.prev;return t.next=e,e.prev=t,i.next=s,s.prev=i,n.next=i,i.prev=n,r.next=n,n.prev=r,n}function yV(t,e,i,n){const s=new Qz(t,e,i);return n?(s.next=n.next,s.prev=n,n.next.prev=s,n.next=s):(s.prev=s,s.next=s),s}function vV(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function xV(t,e,i){i=i||3;const n=e?e.length:0,s=n?e[0]*i:t.length;let r=tV(t,0,s,i,!0);const o=[];if(!r)return o;let a=0,l=0,c=0,h=0,_=0,u=0,m=0;if(n&&(r=function(t,e,i,n){const s=[];let r=0,o=0,a=0,l=0,c=null;for(r=0,o=e.length;r<o;r++)a=e[r]*n,l=r<o-1?e[r+1]*n:t.length,c=tV(t,a,l,n,!1),c&&(c===c.next&&(c.steiner=!0),s.push(hV(c)));if(s.sort(aV),!i)return i;for(r=0;r<s.length;r++)lV(s[r],i),i=eV(i,i.next);return i}(t,e,r,i)),t.length>80*i){a=c=t[0],l=h=t[1];for(let e=i;e<s;e+=i)_=t[e],u=t[e+1],_<a&&(a=_),u<l&&(l=u),_>c&&(c=_),u>h&&(h=u);m=Math.max(c-a,h-l)}return iV(r,o,i,a,l,m),o}const SV=Math.PI,AV=Math.min,CV=Math.max,bV=Math.ceil,TV=Math.acos,wV=Math.cos,EV=Math.sin,PV=Math.atan2;let IV=null,DV=null;const RV=new si,MV=[];for(let t=0;t<4;t++)MV.push(new oi);function BV(t,e,i){return t<e?e:t>i?i:t}const OV={useModel:!0,updateRenderData(t){},fillBuffers(t,e){},renderIA(t,e){},getRenderData(t,e){if(!DV)return null;const i=DV.getRenderDataList();let n=i[DV.dataOffset];if(!n)return null;let s=n;const r=s?s.vertexStart+e:0;return(r>65535||3*r>131070)&&(++DV.dataOffset,DV.dataOffset<i.length?n=i[DV.dataOffset]:(n=DV.requestRenderData(),i[DV.dataOffset]=n),s=n),s&&s.vertexCount<r&&s.request(e,3*e),n},stroke(t){si.copy(RV,t.strokeColor),t.impl&&(this._flattenPaths(t.impl),this._expandStroke(t),t.impl.updatePathOffset=!0,this.end(t))},fill(t){si.copy(RV,t.fillColor),this._expandFill(t),t.impl&&(t.impl.updatePathOffset=!0),this.end(t)},end(t){t.markForUpdateRenderData()},_expandStroke(t){const e=.5*t.lineWidth,i=t.lineCap,n=t.lineJoin,s=t.miterLimit;if(DV=t.impl,!DV)return;const r=function(t,e,i){const n=2*TV(t/(t+i));return CV(2,bV(e/n))}(e,SV,DV.tessTol);this._calculateJoins(DV,e,n,s);const o=DV.paths;let a=0;for(let t=DV.pathOffset,e=DV.pathLength;t<e;t++){const e=o[t],s=e.points.length;n===zO.ROUND?a+=2*(s+e.bevel*(r+2)+1):a+=2*(s+5*e.bevel+1),e.closed||(i===FO.ROUND?a+=2*(2*r+2):a+=12)}const l=IV=this.getRenderData(t,a);if(!l)return;const c=l.vData,h=l.iData;for(let t=DV.pathOffset,s=DV.pathLength;t<s;t++){const s=o[t],a=s.points,_=a.length,u=l.vertexStart;let m,d,p=0,f=0;const g=s.closed;if(g?(m=a[_-1],d=a[0],p=0,f=_):(m=a[0],d=a[1],p=1,f=_-1),d=d||m,!g){const t=new $O(d.x,d.y);t.subtract(m),t.normalize();const n=t.x,s=t.y;i===FO.BUTT?this._buttCapStart(m,n,s,e,0):i===FO.SQUARE?this._buttCapStart(m,n,s,e,e):i===FO.ROUND&&this._roundCapStart(m,n,s,e,r)}for(let t=p;t<f;++t)n===zO.ROUND?this._roundJoin(m,d,e,e,r):0!=(d.flags&(VO.PT_BEVEL|VO.PT_INNERBEVEL))?this._bevelJoin(m,d,e,e):(this._vSet(d.x+d.dmx*e,d.y+d.dmy*e,1),this._vSet(d.x-d.dmx*e,d.y-d.dmy*e,-1)),m=d,d=a[t+1];if(g){const t=8*u;this._vSet(c[t],c[t+1],1),this._vSet(c[t+8],c[t+8+1],-1)}else{const t=new $O(d.x,d.y);t.subtract(m),t.normalize();const n=t.x,s=t.y;i===FO.BUTT?this._buttCapEnd(d,n,s,e,0):i===FO.SQUARE?this._buttCapEnd(d,n,s,e,e):i===FO.ROUND&&this._roundCapEnd(d,n,s,e,r)}let y=l.indicesStart;for(let t=u+2,e=l.vertexStart;t<e;t++)h[y++]=t-2,h[y++]=t-1,h[y++]=t;l.indicesStart=y}IV=null,DV=null},_expandFill(t){if(DV=t.impl,!DV)return;const e=DV.paths;let i=0;for(let t=DV.pathOffset,n=DV.pathLength;t<n;t++)i+=e[t].points.length;const n=IV=this.getRenderData(t,i);if(!n)return;const s=n,r=s.vData,o=s.iData;for(let t=DV.pathOffset,i=DV.pathLength;t<i;t++){const i=e[t],a=i.points,l=a.length;if(0===l)continue;const c=n.vertexStart;for(let t=0;t<l;++t)this._vSet(a[t].x,a[t].y);let h=n.indicesStart;if(i.complex){const t=[];for(let e=c,i=n.vertexStart;e<i;e++){let i=8*e;t.push(r[i++]),t.push(r[i++]),t.push(r[i++])}const e=xV(t,null,3);if(!e||0===e.length)continue;for(let t=0,i=e.length;t<i;t++)o[h++]=e[t]+c}else{const t=c;for(let e=c+2,i=s.vertexStart;e<i;e++)o[h++]=t,o[h++]=e-1,o[h++]=e}s.indicesStart=h}IV=null,DV=null},_calculateJoins(t,e,i,n){let s=0;e>0&&(s=1/e);const r=t.paths;for(let e=t.pathOffset,o=t.pathLength;e<o;e++){const t=r[e],o=t.points,a=o.length;let l=o[a-1],c=o[0];t.bevel=0;for(let e=0;e<a;e++){let r=0,a=0,h=0;const _=l.dy,u=-l.dx,m=c.dy,d=-c.dx;if(c.dmx=.5*(_+m),c.dmy=.5*(u+d),r=c.dmx*c.dmx+c.dmy*c.dmy,r>1e-6){let t=1/r;t>600&&(t=600),c.dmx*=t,c.dmy*=t}a=c.dx*l.dy-l.dx*c.dy,a>0&&(c.flags|=VO.PT_LEFT),h=CV(11,AV(l.len,c.len)*s),r*h*h<1&&(c.flags|=VO.PT_INNERBEVEL),c.flags&VO.PT_CORNER&&(r*n*n<1||i===zO.BEVEL||i===zO.ROUND)&&(c.flags|=VO.PT_BEVEL),0!=(c.flags&(VO.PT_BEVEL|VO.PT_INNERBEVEL))&&t.bevel++,l=c,c=o[e+1]}}},_flattenPaths(t){const e=t.paths;for(let i=t.pathOffset,n=t.pathLength;i<n;i++){const t=e[i],n=t.points;let s=n[n.length-1],r=n[0];n.length>2&&s.equals(r)&&(t.closed=!0,n.pop(),s=n[n.length-1]);for(let t=0,e=n.length;t<e;t++){const e=new $O(r.x,r.y);e.subtract(s),s.len=e.length(),(e.x||e.y)&&e.normalize(),s.dx=e.x,s.dy=e.y,s=r,r=n[t+1]}}},_chooseBevel(t,e,i,n){const s=i.x,r=i.y;let o=0,a=0,l=0,c=0;return 0!==t?(o=s+e.dy*n,a=r-e.dx*n,l=s+i.dy*n,c=r-i.dx*n):(o=l=s+i.dmx*n,a=c=r+i.dmy*n),[o,a,l,c]},_buttCapStart(t,e,i,n,s){const r=t.x-e*s,o=t.y-i*s,a=i,l=-e;this._vSet(r+a*n,o+l*n,1),this._vSet(r-a*n,o-l*n,-1)},_buttCapEnd(t,e,i,n,s){const r=t.x+e*s,o=t.y+i*s,a=i,l=-e;this._vSet(r+a*n,o+l*n,1),this._vSet(r-a*n,o-l*n,-1)},_roundCapStart(t,e,i,n,s){const r=t.x,o=t.y,a=i,l=-e;for(let t=0;t<s;t++){const c=t/(s-1)*SV,h=wV(c)*n,_=EV(c)*n;this._vSet(r-a*h-e*_,o-l*h-i*_,1),this._vSet(r,o,0)}this._vSet(r+a*n,o+l*n,1),this._vSet(r-a*n,o-l*n,-1)},_roundCapEnd(t,e,i,n,s){const r=t.x,o=t.y,a=i,l=-e;this._vSet(r+a*n,o+l*n,1),this._vSet(r-a*n,o-l*n,-1);for(let t=0;t<s;t++){const c=t/(s-1)*SV,h=wV(c)*n,_=EV(c)*n;this._vSet(r,o,0),this._vSet(r-a*h+e*_,o-l*h+i*_,1)}},_roundJoin(t,e,i,n,s){const r=t.dy,o=-t.dx,a=e.dy,l=-e.dx,c=e.x,h=e.y;if(0!=(e.flags&VO.PT_LEFT)){const _=this._chooseBevel(e.flags&VO.PT_INNERBEVEL,t,e,i),u=_[0],m=_[1],d=_[2],p=_[3],f=PV(-o,-r);let g=PV(-l,-a);g>f&&(g-=2*SV),this._vSet(u,m,1),this._vSet(c-r*n,e.y-o*n,-1);const y=BV(bV((f-g)/SV)*s,2,s);for(let t=0;t<y;t++){const e=f+t/(y-1)*(g-f),i=c+wV(e)*n,s=h+EV(e)*n;this._vSet(c,h,0),this._vSet(i,s,-1)}this._vSet(d,p,1),this._vSet(c-a*n,h-l*n,-1)}else{const _=this._chooseBevel(e.flags&VO.PT_INNERBEVEL,t,e,-n),u=_[0],m=_[1],d=_[2],p=_[3],f=PV(o,r);let g=PV(l,a);g<f&&(g+=2*SV),this._vSet(c+r*n,h+o*n,1),this._vSet(u,m,-1);const y=BV(bV((g-f)/SV)*s,2,s);for(let t=0;t<y;t++){const e=f+t/(y-1)*(g-f),n=c+wV(e)*i,s=h+EV(e)*i;this._vSet(n,s,1),this._vSet(c,h,0)}this._vSet(c+a*n,h+l*n,1),this._vSet(d,p,-1)}},_bevelJoin(t,e,i,n){let s=0,r=0,o=0,a=0,l=0,c=0,h=0,_=0;const u=t.dy,m=-t.dx,d=e.dy,p=-e.dx;if(e.flags&VO.PT_LEFT){const s=this._chooseBevel(e.flags&VO.PT_INNERBEVEL,t,e,i);l=s[0],c=s[1],h=s[2],_=s[3],this._vSet(l,c,1),this._vSet(e.x-u*n,e.y-m*n,-1),this._vSet(h,_,1),this._vSet(e.x-d*n,e.y-p*n,-1)}else{const l=this._chooseBevel(e.flags&VO.PT_INNERBEVEL,t,e,-n);s=l[0],r=l[1],o=l[2],a=l[3],this._vSet(e.x+u*i,e.y+m*i,1),this._vSet(s,r,-1),this._vSet(e.x+d*i,e.y+p*i,1),this._vSet(o,a,-1)}},_vSet(t,e,i=0){if(!IV)return;const n=IV;let s=8*n.vertexStart;const r=n.vData;r[s++]=t,r[s++]=e,r[s++]=0,si.toArray(r,RV,s),s+=4,r[s++]=i,n.vertexStart++}},NV=t("graphicsAssembler",{getAssembler:()=>OV});RN.Assembler=NV;class LV{constructor(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""}}const FV=new Oi;let zV=null,VV=null;const UV=[],GV=[],HV=[],kV=[],jV=new Mi,WV=new Mi,qV=new Ti;let XV=null,YV=0,KV=0,JV=0,$V=0,ZV=0,QV=1,tU=null,eU="",iU=0,nU=0,sU=0,rU=0,oU=0,aU=0,lU=0,cU=!1,hU=0,_U=0,uU=0;const mU={updateRenderData(t){t.renderData&&t.renderData.vertDirty&&zV!==t&&(zV=t,VV=zV.node._uiProps.uiTransformComp,this._updateFontFamily(t),this._updateProperties(t),this._updateLabelInfo(t),this._updateContent(),zV.actualFontSize=iU,VV.setContentSize(WV),zV.renderData.vertDirty=zV.renderData.uvDirty=!1,zV.markForUpdateRenderData(!1),zV=null,this._resetProperties())},_updateFontScale(){QV=iU/nU},_updateFontFamily(t){const e=t.font;tU=e.spriteFrame,XV=e.fntConfig,DM.fontAtlas=e.fontDefDictionary,NR.packToDynamicAtlas(t,tU)},_updateLabelInfo(t){DM.hash="",DM.margin=0},_updateProperties(t){eU=t.string.toString(),iU=t.fontSize,nU=XV?XV.fontSize:t.fontSize,sU=t.horizontalAlign,rU=t.verticalAlign,oU=t.spacingX,lU=t.overflow,aU=t._lineHeight;const e=VV.contentSize;WV.width=e.width,WV.height=e.height,lU===NO.NONE?(cU=!1,WV.width+=2*DM.margin,WV.height+=2*DM.margin):lU===NO.RESIZE_HEIGHT?(cU=!0,WV.height+=2*DM.margin):cU=t.enableWrapText,DM.lineHeight=aU,DM.fontSize=iU,this._setupBMFontOverflowMetrics()},_resetProperties(){XV=null,tU=null,DM.hash="",DM.margin=0},_updateContent(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText(){const t=eU,e=t.length,i=XV.kerningDict,n=UV;let s=-1;for(let r=0;r<e;++r){const o=t.charCodeAt(r),a=i[s<<16|65535&o]||0;n[r]=r<e-1?a:0,s=o}},_multilineTextWrap(t){const e=eU.length;let i=0,n=0,s=0,r=0,o=0,a=0,l=0,c=null;for(let h=0;h<e;){let _=eU.charAt(h);if("\n"===_){HV.push(o),o=0,i++,n=0,s-=aU*this._getFontScale()+0,this._recordPlaceholderInfo(h,_),h++;continue}const u=t(eU,h,e);let m=a,d=l,p=o,f=n,g=!1;for(let t=0;t<u;++t){const r=h+t;if(_=eU.charAt(r),"\r"===_){this._recordPlaceholderInfo(r,_);continue}if(c=DM.fontAtlas.getLetterDefinitionForChar(_,DM),!c){this._recordPlaceholderInfo(r,_),console.log(`Can't find letter definition in texture atlas ${XV.atlasName} for letter:${_}`);continue}const a=f+c.offsetX*QV-DM.margin;if(cU&&uU>0&&n>0&&a+c.w*QV>uU&&!yM(_)){HV.push(o),o=0,i++,n=0,s-=aU*this._getFontScale()+0,g=!0;break}qV.x=a,qV.y=s-c.offsetY*QV,this._recordLetterInfo(qV,_,r,i),r+1<UV.length&&r<e-1&&(f+=UV[r+1]),f+=c.xAdvance*QV+oU,p=qV.x+c.w*QV,m<qV.y&&(m=qV.y),d>qV.y-c.h*QV&&(d=qV.y-c.h*QV)}g||(n=f,o=p,a<m&&(a=m),l>d&&(l=d),r<o&&(r=o),h+=u)}return HV.push(o),YV=i+1,KV=YV*aU*this._getFontScale(),YV>1&&(KV+=0*(YV-1)),WV.width=hU,WV.height=_U,hU<=0&&(WV.width=parseFloat(r.toFixed(2))+2*DM.margin),_U<=0&&(WV.height=parseFloat(KV.toFixed(2))+2*DM.margin),$V=WV.height,ZV=0,a>0&&($V=WV.height+a),l<-KV&&(ZV=KV+l),!0},_getFirstCharLen:()=>1,_getFontScale:()=>lU===NO.SHRINK?QV:1,_getFirstWordLen(t,e,i){let n=t.charAt(e);if(gM(n)||"\n"===n||yM(n))return 1;let s=1,r=DM.fontAtlas.getLetterDefinitionForChar(n,DM);if(!r)return s;let o=r.xAdvance*QV+oU,a=0;for(let l=e+1;l<i&&(n=t.charAt(l),r=DM.fontAtlas.getLetterDefinitionForChar(n,DM),r);++l){if(a=o+r.offsetX*QV,a+r.w*QV>uU&&!yM(n)&&uU>0)return s;if(o+=r.xAdvance*QV+oU,"\n"===n||yM(n)||gM(n))break;s++}return s},_multilineTextWrapByWord(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo(t,e){if(t>=GV.length){const t=new LV;GV.push(t)}GV[t].char=e,GV[t].hash=e.charCodeAt(0)+DM.hash,GV[t].valid=!1},_recordLetterInfo(t,e,i,n){if(i>=GV.length){const t=new LV;GV.push(t)}const s=e.charCodeAt(0)+DM.hash;GV[i].line=n,GV[i].char=e,GV[i].hash=s,GV[i].valid=DM.fontAtlas.getLetter(s).valid,GV[i].x=t.x,GV[i].y=t.y},_alignText(){KV=0,HV.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),lU===NO.SHRINK&&iU>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||lU===NO.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown(t){let e=!0;t||(t=.1,e=!1),iU=t,e&&this._updateContent()},_shrinkLabelToContentSize(t){let e=0,i=0|iU,n=0;for(;e<i;){n=e+i+1>>1;const s=n;if(s<=0)break;QV=s/nU,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),t()?i=n-1:e=n}e>=0&&this._scaleFontSizeDown(e)},_isVerticalClamp:()=>KV>WV.height,_isHorizontalClamp(){let t=!1;for(let e=0,i=eU.length;e<i;++e){const i=GV[e];if(i.valid){const e=DM.fontAtlas.getLetterDefinitionForChar(i.char,DM);if(!e)continue;const n=i.x+e.w/2*QV,s=i.line;if(hU>0)if(cU){if(HV[s]>WV.width&&(n>WV.width||n<0)){t=!0;break}}else if(n>WV.width){t=!0;break}}}return t},_isHorizontalClamped(t,e){const i=HV[e],n=t>WV.width||t<0;return cU?i>WV.width&&n:n},_updateQuads(){if(!zV)return!1;const t=tU?tU.texture:DM.fontAtlas.getTexture(),e=zV.renderData;e.dataLength=e.vertexCount=e.indicesCount=0;const i=VV.anchorPoint,n=WV,s=i.x*n.width,r=i.y*n.height;let o=!0;for(let e=0,i=eU.length;e<i;++e){const i=GV[e];if(!i.valid)continue;const n=DM.fontAtlas.getLetter(i.hash);if(!n){console.warn("Can't find letter in this bitmap-font");continue}FV.height=n.h,FV.width=n.w,FV.x=n.u,FV.y=n.v;let a=i.y+JV;if(_U>0){if(a>$V){const t=a-$V;FV.y+=t,FV.height-=t,a-=t}a-n.h*QV<ZV&&lU===NO.CLAMP&&(FV.height=a<ZV?0:(a-ZV)/QV)}const l=i.line,c=i.x+n.w/2*QV+kV[l];if(hU>0&&this._isHorizontalClamped(c,l))if(lU===NO.CLAMP)FV.width=0;else if(lU===NO.SHRINK){if(WV.width>n.w){o=!1;break}FV.width=0}if(FV.height>0&&FV.width>0){const e=this._determineRect(),n=i.x+kV[i.line];this.appendQuad(zV,t,FV,e,n-s,a-r,QV)}}return o},appendQuad(t,e,i,n,s,r,o){},_determineRect(){const t=tU.isRotated(),e=tU.getOriginalSize(),i=tU.getRect(),n=tU.getOffset(),s=n.x+(e.width-i.width)/2,r=n.y-(e.height-i.height)/2;if(t){const t=FV.x;FV.x=i.x+i.height-FV.y-FV.height-r,FV.y=t+i.y-s,FV.y<0&&(FV.height+=r)}else FV.x+=i.x-s,FV.y+=i.y+r;return t},_computeAlignmentOffset(){switch(kV.length=0,sU){case BO.LEFT:for(let t=0;t<YV;++t)kV.push(0);break;case BO.CENTER:for(let t=0,e=HV.length;t<e;t++)kV.push((WV.width-HV[t])/2);break;case BO.RIGHT:for(let t=0,e=HV.length;t<e;t++)kV.push(WV.width-HV[t])}if(JV=WV.height,rU!==OO.TOP){const t=WV.height-KV+aU*this._getFontScale()-nU*QV;rU===OO.BOTTOM?JV-=t:JV-=t/2}},_setupBMFontOverflowMetrics(){let t=WV.width,e=WV.height;lU===NO.RESIZE_HEIGHT&&(e=0),lU===NO.NONE&&(t=0,e=0),hU=t,_U=e,jV.width=t,jV.height=e,uU=t}},dU=new si(255,255,255,255),pU={createData:t=>t.requestRenderData(),fillBuffers(t,e){const i=t.node;t._setCacheAlpha(i._uiProps.opacity),dU.set(t.color),dU.a=255*i._uiProps.opacity,RR(i,e,t.renderData,dU)},appendQuad(t,e,i,n,s,r,o){const a=t.renderData;if(!a)return;const l=a.dataLength;a.dataLength+=4,a.vertexCount=a.dataLength,a.indicesCount=a.dataLength/2*3;const c=a.data,h=e.width,_=e.height,u=i.width,m=i.height;let d=0,p=0,f=0,g=0;n?(d=i.x/h,g=(i.x+m)/h,p=(i.y+u)/_,f=i.y/_,c[l].u=d,c[l].v=f,c[l+1].u=d,c[l+1].v=p,c[l+2].u=g,c[l+2].v=f,c[l+3].u=g,c[l+3].v=p):(d=i.x/h,g=(i.x+u)/h,p=(i.y+m)/_,f=i.y/_,c[l].u=d,c[l].v=p,c[l+1].u=g,c[l+1].v=p,c[l+2].u=d,c[l+2].v=f,c[l+3].u=g,c[l+3].v=f),c[l].x=s,c[l].y=r-m*o,c[l+1].x=s+u*o,c[l+1].y=r-m*o,c[l+2].x=s,c[l+2].y=r,c[l+3].x=s+u*o,c[l+3].y=r}};xt(pU,mU);let fU=null;const gU=St(mU,{getAssemblerData:()=>(fU||(fU=new IM(1024,1024)),fU.getTexture()),_updateFontFamily(t){DM.fontAtlas=fU,DM.fontFamily=this._getFontFamily(t);const e=t.getComponent(CL);e&&e.enabled?(DM.isOutlined=!0,DM.margin=e.width,DM.out=e.color.clone(),DM.out.a=e.color.a*t.color.a/255):(DM.isOutlined=!1,DM.margin=0)},_getFontFamily(t){let e="Arial";return t.useSystemFont?e=t.fontFamily||"Arial":t.font&&(t.font._nativeAsset?e=t.font._nativeAsset:lw.postLoadNative(t.font,(()=>{t.isValid&&(e=t.font._nativeAsset||"Arial",t.updateRenderData(!0))}))),e},_updateLabelInfo(t){DM.fontDesc=this._getFontDesc(),DM.color=t.color,DM.hash=function(t){const e=t.color.toHEX();let i="";return t.isOutlined&&t.margin>0&&(i=i+t.margin+t.out.toHEX()),""+t.fontSize+t.fontFamily+e+i}(DM)},_getFontDesc(){let t=`${DM.fontSize.toString()}px `;return t+=DM.fontFamily,t},_computeHorizontalKerningForText(){},_determineRect:()=>!1}),yU=new si(255,255,255,255),vU={createData:t=>t.requestRenderData(),fillBuffers(t,e){if(!t.renderData)return;const i=t.node;t._setCacheAlpha(i._uiProps.opacity),yU.a=255*i._uiProps.opacity,RR(i,e,t.renderData,yU)},appendQuad:pU.appendQuad};xt(vU,gU);const xU=UO.Overflow,SU=(1/255).toFixed(3);let AU=null,CU=null,bU=null,TU="",wU="",EU=0,PU=0,IU=[];const DU=new Mi;let RU=0,MU=0,BU=0,OU=new si,NU=1,LU="",FU=xU.NONE,zU=!1,VU=null;const UU=si.BLACK.clone();let GU=null;const HU=si.BLACK.clone(),kU=new Oi,jU=Mi.ZERO.clone(),WU=Mi.ZERO.clone(),qU=Ti.ZERO.clone(),XU=Ti.ZERO.clone();let YU=0,KU=0,JU=!1,$U=!1,ZU=!1;const QU=["left","center","right"],tG={getAssemblerData:()=>UO._canvasPool.get(),resetAssemblerData(t){t&&UO._canvasPool.put(t)},updateRenderData(t){if(!t.renderData||!t.renderData.vertDirty)return;const e=t.node._uiProps.uiTransformComp;this._updateFontFamily(t),this._updateProperties(t,e),this._calculateLabelFont(),this._updateLabelDimensions(),this._resetDynamicAtlas(t),this._updateTexture(t),this.updateOpacity(t),t._setCacheAlpha(NU),this._calDynamicAtlas(t),t.actualFontSize=EU,e.setContentSize(DU),this.updateVertexData(t),this.updateUvs(t),t.markForUpdateRenderData(!1),AU=null,CU=null,bU=null},updateVertexData(t){},updateUvs(t){},updateOpacity(t){const e=t.renderData.vData;let i=5;const n=t.node._uiProps.opacity;for(let t=0;t<4;t++)e[i+3]=n,i+=9},_updateFontFamily(t){t.useSystemFont?LU=t.fontFamily||"Arial":t.font?t.font._nativeAsset?LU=t.font._nativeAsset:(lw.postLoadNative(t.font,(()=>{t.isValid&&(LU=t.font._nativeAsset||"Arial",t.updateRenderData(!0))})),LU="Arial"):LU="Arial"},_updateProperties(t,e){const i=t.assemblerData;i&&(AU=i.context,CU=i.canvas,bU=t.spriteFrame,wU=t.string.toString(),EU=t.fontSize,PU=EU,FU=t.overflow,WU.width=DU.width=e.width,WU.height=DU.height=e.height,KU=t.underlineHeight,RU=t.lineHeight,MU=t.horizontalAlign,BU=t.verticalAlign,OU=t.color,NU=t.node._uiProps.opacity,JU=t.isBold,$U=t.isItalic,ZU=t.isUnderline,zU=FU!==xU.NONE&&(FU===xU.RESIZE_HEIGHT||t.enableWrapText),VU=CL&&t.getComponent(CL),VU=VU&&VU.enabled&&VU.width>0?VU:null,VU&&UU.set(VU.color),GU=Yz&&t.getComponent(Yz),GU=GU&&GU.enabled?GU:null,GU&&HU.set(GU.color),this._updatePaddingRect())},_updatePaddingRect(){let t=0,e=0,i=0,n=0,s=0;if(jU.width=jU.height=0,VU&&(s=VU.width,t=e=i=n=s,jU.width=jU.height=2*s),GU){const r=GU.blur+s,o=GU.offset.x,a=GU.offset.y;i=Math.max(i,-o+r),n=Math.max(n,o+r),t=Math.max(t,a+r),e=Math.max(e,-a+r)}if($U){const t=PU*Math.tan(.20943951);n+=t,jU.width+=t}kU.x=i,kU.y=t,kU.width=i+n,kU.height=t+e},_calculateFillTextStartPosition(){let t=0;MU===BO.RIGHT?t=DU.width-kU.width:MU===BO.CENTER&&(t=(DU.width-kU.width)/2);const e=this._getLineHeight()*(IU.length-1);let i=EU*(1-lM/2);if(BU!==OO.TOP){let t=e+kU.height+EU-DU.height;BU===OO.BOTTOM?(t+=lM/2*EU,i-=t):i-=t/2}i+=0*EU,qU.set(t+kU.x,i+kU.y)},_updateTexture(t){if(!AU||!CU)return;AU.clearRect(0,0,CU.width,CU.height),AU.font=TU,this._calculateFillTextStartPosition();const e=this._getLineHeight();AU.lineJoin="round",t._srcBlendFactor===ro.SRC_ALPHA&&(AU.fillStyle=`rgba(${OU.r}, ${OU.g}, ${OU.b}, ${SU})`,AU.fillRect(0,0,CU.width,CU.height)),AU.fillStyle=`rgb(${OU.r}, ${OU.g}, ${OU.b})`;const i=qU.x;let s=0;this._drawTextEffect(qU,e);for(let t=0;t<IU.length;++t)s=qU.y+t*e,VU&&AU.strokeText(IU[t],i,s),AU.fillText(IU[t],i,s);if(GU&&(AU.shadowColor="transparent"),bU){let t;t=bU instanceof zR?bU.texture:bU,0!==CU.width&&0!==CU.height&&(t.reset({width:CU.width,height:CU.height,mipmapLevel:1}),t.uploadData(CU),bU instanceof zR&&(bU.rect=new Oi(0,0,CU.width,CU.height),bU._calculateUV()),n.director.root&&n.director.root.batcher2D&&n.director.root.batcher2D._releaseDescriptorSetCache(t.getHash()))}},_resetDynamicAtlas(t){if(t.cacheMode!==UO.CacheMode.BITMAP)return;const e=t.ttfSpriteFrame;NR.deleteAtlasSpriteFrame(e),e._resetDynamicAtlasFrame()},_calDynamicAtlas(t){if(t.cacheMode!==UO.CacheMode.BITMAP)return;const e=t.ttfSpriteFrame;NR.packToDynamicAtlas(t,e),t.renderData.uvDirty=!0},_setupOutline(){AU.strokeStyle=`rgba(${UU.r}, ${UU.g}, ${UU.b}, ${UU.a/255})`,AU.lineWidth=2*VU.width},_setupShadow(){AU.shadowColor=`rgba(${HU.r}, ${HU.g}, ${HU.b}, ${HU.a/255})`,AU.shadowBlur=GU.blur,AU.shadowOffsetX=GU.offset.x,AU.shadowOffsetY=-GU.offset.y},_drawTextEffect(t,e){if(!GU&&!VU&&!ZU)return;const i=IU.length>1&&GU,n=this._measureText(AU,TU);let s=0,r=0;GU&&this._setupShadow(),VU&&this._setupOutline();for(let o=0;o<IU.length;++o)s=t.x,r=t.y+o*e,i&&(VU&&AU.strokeText(IU[o],s,r),AU.fillText(IU[o],s,r)),ZU&&(YU=n(IU[o]),MU===BO.RIGHT?XU.x=t.x-YU:MU===BO.CENTER?XU.x=t.x-YU/2:XU.x=t.x,XU.y=r+PU/8,AU.fillRect(XU.x,XU.y,YU,KU));i&&(AU.shadowColor="transparent")},_updateLabelDimensions(){DU.width=Math.min(DU.width,2048),DU.height=Math.min(DU.height,2048);let t=!1;CU.width!==DU.width&&(CU.width=DU.width,t=!0),CU.height!==DU.height&&(CU.height=DU.height,t=!0),t&&(AU.font=TU),AU.textAlign=QU[MU],AU.textBaseline="alphabetic"},_getFontDesc(){let t=`${EU.toString()}px `;return t+=LU,JU&&(t=`bold ${t}`),$U&&(t=`italic ${t}`),t},_getLineHeight(){let t=RU;return t=0===t?EU:t*EU/PU,0|t},_calculateParagraphLength(t,e){const i=[];for(const n of t){const t=vM(e,n,TU);i.push(t)}return i},_measureText:(t,e)=>i=>vM(t,i,e),_calculateShrinkFont(t){if(!AU)return;const e=this._calculateParagraphLength(t,AU);let i=0,n=0,s=0;if(zU){const e=WU.width,s=WU.height;if(e<0||s<0)return;n=s+1;let r=[],o=0,a=0|EU+1,l=0;for(;o<a;){if(l=o+a+1>>1,l<=0){S(4003);break}EU=l,TU=this._getFontDesc(),AU.font=TU;const c=this._getLineHeight();for(n=0,i=0;i<t.length;++i){const s=vM(AU,t[i],TU);r=SM(t[i],s,e,this._measureText(AU,TU)),n+=r.length*c}n>s?a=l-1:o=l}0===o?S(4003):(EU=o,TU=this._getFontDesc(),AU.font=TU)}else{for(n=t.length*this._getLineHeight(),i=0;i<t.length;++i)s<e[i]&&(s=e[i]);const r=(DU.width-kU.width)/s,o=DU.height/n;EU=PU*Math.min(1,r,o)|0,TU=this._getFontDesc(),AU.font=TU}},_calculateWrapText(t){if(!zU||!AU)return;IU=[];const e=WU.width;for(let i=0;i<t.length;++i){const n=vM(AU,t[i],TU),s=SM(t[i],n,e,this._measureText(AU,TU));IU=IU.concat(s)}},_calculateLabelFont(){if(!AU)return;const t=wU.split("\n");switch(IU=t,TU=this._getFontDesc(),AU.font=TU,FU){case xU.NONE:{let e=0,i=0;for(let i=0;i<t.length;++i){const n=vM(AU,t[i],TU);e=e>n?e:n}i=(IU.length+lM)*this._getLineHeight();const n=parseFloat(e.toFixed(2)),s=parseFloat(i.toFixed(2));DU.width=n+kU.width,DU.height=s+kU.height,WU.width=n+jU.width,WU.height=s+jU.height;break}case xU.SHRINK:this._calculateShrinkFont(t),this._calculateWrapText(t);break;case xU.CLAMP:this._calculateWrapText(t);break;case xU.RESIZE_HEIGHT:{this._calculateWrapText(t);const e=(IU.length+lM)*this._getLineHeight();DU.height=e+kU.height,WU.height=e+jU.height;break}}}},eG=si.WHITE.clone(),iG={createData(t){const e=t.requestRenderData();e.dataLength=4,e.vertexCount=4,e.indicesCount=6;const i=e.vData=new Float32Array(36);i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;let n=5;for(let t=0;t<4;t++)si.toArray(i,eG,n),n+=9;return e},fillBuffers(t,e){const i=t.renderData,n=i.data,s=t.node;let r=e.acquireBufferBatch(),o=r.byteOffset>>2,a=r.indicesOffset,l=r.vertexOffset;r.request()||(r=e.currBufferBatch,a=0,l=0,o=0);const c=r.vData,h=r.iData,_=i.vData,u=n[0],m=n[3];s.updateWorldTransform();const d=s._pos,p=s._rot,f=s._scale,g=u.x*f.x,y=m.x*f.x,v=u.y*f.y,x=m.y*f.y,S=p.x,A=p.y,C=p.z,b=p.w,T=S*A,w=C*b,E=S*S-A*A,P=b*b-C*C,I=P+E,D=2*(T-w),R=P-E,M=2*(T+w),B=d.x,O=d.y;_[0]=I*g+D*v+B,_[1]=R*v+M*g+O,_[9]=I*y+D*v+B,_[10]=R*v+M*y+O,_[18]=I*g+D*x+B,_[19]=R*x+M*g+O,_[27]=I*y+D*x+B,_[28]=R*x+M*y+O,c.set(_,o),h[a++]=l,h[a++]=l+1,h[a++]=l+2,h[a++]=l+2,h[a++]=l+1,h[a++]=l+3},updateVertexData(t){const e=t.renderData;if(!e)return;const i=t.node._uiProps.uiTransformComp,n=i.width,s=i.height,r=i.anchorX*n,o=i.anchorY*s,a=e.data;a[0].x=-r,a[0].y=-o,a[3].x=n-r,a[3].y=s-o},updateUvs(t){const e=t.renderData;if(!e)return;const i=e.vData;if(!i||!e.uvDirty)return;const n=t.ttfSpriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7],e.uvDirty=!1}};xt(iG,tG);const nG=t("labelAssembler",{getAssembler(t){let e=iG;return t.font instanceof rM?e=pU:t.cacheMode===UO.CacheMode.CHAR&&(e=vU),e}});UO.Assembler=nG;const sG=mF.FillType,rG=new Si,oG=new si(255,255,255,255),aG={useModel:!1,updateRenderData(t){const e=t.spriteFrame;NR.packToDynamicAtlas(t,e);const i=t.renderData;if(i&&e){const e=i.uvDirty,n=i.vertDirty;if(!e&&!n)return;let s=t.fillStart,r=t.fillRange;r<0&&(s+=r,r=-r),r=s+r,s=s>1?1:s,s=s<0?0:s,r=r>1?1:r,r=r<0?0:r,r-=s,r=r<0?0:r;let o=s+r;o=o>1?1:o,e&&this.updateUVs(t,s,o),n&&(this.updateVertexData&&this.updateVertexData(t,s,o),this.updateWorldVertexData(t))}},updateUVs(t,e,i){const n=t.spriteFrame,s=t.renderData,r=s.data,o=n.width,a=n.height,l=n.getRect();let c=0,h=0,_=0,u=0,m=0,d=0,p=0,f=0,g=0,y=0,v=0,x=0;switch(n.isRotated()?(c=l.x/o,h=(l.y+l.width)/a,_=(l.x+l.height)/o,u=l.y/a,m=p=c,g=v=_,f=x=h,d=y=u):(c=l.x/o,h=(l.y+l.height)/a,_=(l.x+l.width)/o,u=l.y/a,m=g=c,p=v=_,d=f=h,y=x=u),t.fillType){case sG.HORIZONTAL:r[0].u=m+(p-m)*e,r[0].v=d+(f-d)*e,r[1].u=m+(p-m)*i,r[1].v=d+(f-d)*i,r[2].u=g+(v-g)*e,r[2].v=y+(x-y)*e,r[3].u=g+(v-g)*i,r[3].v=y+(x-y)*i;break;case sG.VERTICAL:r[0].u=m+(g-m)*e,r[0].v=d+(y-d)*e,r[1].u=p+(v-p)*e,r[1].v=f+(x-f)*e,r[2].u=m+(g-m)*i,r[2].v=d+(y-d)*i,r[3].u=p+(v-p)*i,r[3].v=f+(x-f)*i;break;default:T(2626)}s.uvDirty=!1},updateVertexData(t,e,i){const n=t.renderData,s=n.data,r=t.node._uiProps.uiTransformComp,o=r.width,a=r.height,l=r.anchorX*o,c=r.anchorY*a;let h=-l,_=-c,u=o-l,m=a-c,d=0,p=0;switch(t.fillType){case sG.HORIZONTAL:d=h+(u-h)*e,p=h+(u-h)*i,h=d,u=p;break;case sG.VERTICAL:d=_+(m-_)*e,p=_+(m-_)*i,_=d,m=p;break;default:T(2626)}s[4].x=h,s[4].y=_,s[5].x=u,s[5].y=_,s[6].x=h,s[6].y=m,s[7].x=u,s[7].y=m,n.vertDirty=!1},createData(t){const e=t.requestRenderData();e.dataLength=8,e.vertexCount=4,e.indicesCount=6;const i=e.data;for(const t of i)t.z=0;return e},updateWorldVertexData(t){const e=t.node,i=t.renderData.data;e.getWorldMatrix(rG);for(let t=0;t<4;t++){const e=i[t+4],n=i[t];oi.transformMat4(n,e,rG)}},fillBuffers(t,e){t.node.hasChangedFlags&&this.updateWorldVertexData(t);const i=t.node;oG.set(t.color),oG.a=255*i._uiProps.opacity,function(t,e,i,n){const s=i.data;let r=e.acquireBufferBatch(),o=r.byteOffset>>2,a=i.vertexCount,l=r.indicesOffset,c=r.vertexOffset;r.request(a,i.indicesCount)||(r=e.currBufferBatch,a=0,l=0,c=0);const h=r.vData;for(let t=0;t<a;t++){const e=s[t];h[o++]=e.x,h[o++]=e.y,h[o++]=e.z,h[o++]=e.u,h[o++]=e.v,si.toArray(h,n,o),o+=4}const _=r.iData;_[l++]=c,_[l++]=c+1,_[l++]=c+2,_[l++]=c+1,_[l++]=c+3,_[l++]=c+2}(0,e,t.renderData,oG)},updateColor(t){}},lG=2*Math.PI,cG=1e-6,hG=new si(255,255,255,255),_G=[new Ti,new Ti,new Ti,new Ti],uG=new Array(4),mG=new Array(8),dG=[new Ti,new Ti,new Ti,new Ti],pG=[new Ti,new Ti,new Ti,new Ti],fG=new Ti,gG=[new Ti,new Ti,new Ti,new Ti];function yG(t,e,i,n,s,r,o){let a=Math.sin(r);a=Math.abs(a)>cG?a:0;let l=Math.cos(r);l=Math.abs(l)>cG?l:0;let c=0,h=0;if(0!==l){if(c=a/l,(t-s.x)*l>0){const e=s.y+c*(t-s.x);o[0].x=t,o[0].y=e}if((e-s.x)*l>0){const t=s.y+c*(e-s.x);o[2].x=e,o[2].y=t}}if(0!==a){if(h=l/a,(n-s.y)*a>0){const t=s.x+h*(n-s.y);o[3].x=t,o[3].y=n}if((i-s.y)*a>0){const t=s.x+h*(i-s.y);o[1].x=t,o[1].y=i}}}function vG(t,e){const i=e.x-t.x,n=e.y-t.y;if(0===i&&0===n)return 0;if(0===i)return n>0?.5*Math.PI:1.5*Math.PI;{let t=Math.atan(n/i);return i<0&&(t+=Math.PI),t}}function xG(t,e,i,n,s){const r=uG,o=r[0],a=r[1],l=r[2],c=r[3];t[e].x=i.x,t[e].y=i.y,t[e+1].x=n.x,t[e+1].y=n.y,t[e+2].x=s.x,t[e+2].y=s.y;let h=0,_=0;h=(i.x-o)/(l-o),_=(i.y-a)/(c-a),SG(h,_,t,e),h=(n.x-o)/(l-o),_=(n.y-a)/(c-a),SG(h,_,t,e+1),h=(s.x-o)/(l-o),_=(s.y-a)/(c-a),SG(h,_,t,e+2)}function SG(t,e,i,n){const s=mG,r=s[0]+(s[2]-s[0])*t,o=s[4]+(s[6]-s[4])*t,a=s[1]+(s[3]-s[1])*t,l=s[5]+(s[7]-s[5])*t,c=i[n];c.u=r+(o-r)*e,c.v=a+(l-a)*e}const AG={useModel:!1,createData:t=>t.requestRenderData(),updateRenderData(t){const e=t.spriteFrame;NR.packToDynamicAtlas(t,e);const i=t.renderData;if(i&&e&&(i.vertDirty||i.uvDirty)){const n=i.data;let s=t.fillStart,r=t.fillRange;for(r<0&&(s+=r,r=-r);s>=1;)s-=1;for(;s<0;)s+=1;s*=lG,r*=lG;const o=s+r;!function(t){const e=t.node._uiProps.uiTransformComp,i=e.width,n=e.height,s=e.anchorX*i,r=e.anchorY*n,o=-s,a=-r,l=i-s,c=n-r,h=uG;h[0]=o,h[1]=a,h[2]=l,h[3]=c;const _=t.fillCenter,u=fG.x=Math.min(Math.max(0,_.x),1)*(l-o)+o,m=fG.y=Math.min(Math.max(0,_.y),1)*(c-a)+a;_G[0].x=_G[3].x=o,_G[1].x=_G[2].x=l,_G[0].y=_G[1].y=a,_G[2].y=_G[3].y=c;for(const t of gG)Ti.set(t,0,0);u!==h[0]&&Ti.set(gG[0],3,0),u!==h[2]&&Ti.set(gG[2],1,2),m!==h[1]&&Ti.set(gG[1],0,1),m!==h[3]&&Ti.set(gG[3],2,3)}(t),function(t){const e=t.width,i=t.height,n=t.getRect();let s=0,r=0,o=0,a=0;const l=mG;t.isRotated()?(s=n.x/e,r=(n.x+n.height)/e,o=n.y/i,a=(n.y+n.width)/i,l[0]=l[2]=s,l[4]=l[6]=r,l[3]=l[7]=a,l[1]=l[5]=o):(s=n.x/e,r=(n.x+n.width)/e,o=n.y/i,a=(n.y+n.height)/i,l[0]=l[4]=s,l[2]=l[6]=r,l[1]=l[3]=a,l[5]=l[7]=o)}(e),yG(uG[0],uG[2],uG[1],uG[3],fG,s,dG),yG(uG[0],uG[2],uG[1],uG[3],fG,s+r,pG);let a=0;for(let t=0;t<4;++t){const e=gG[t];if(!e)continue;if(r>=lG){i.dataLength=a+3,xG(n,a,fG,_G[e.x],_G[e.y]),a+=3;continue}let l=vG(fG,_G[e.x]),c=vG(fG,_G[e.y]);c<l&&(c+=lG),l-=lG,c-=lG;for(let r=0;r<3;++r)l>=o||(l>=s?(i.dataLength=a+3,xG(n,a,fG,_G[e.x],c>=o?pG[t]:_G[e.y]),a+=3):c>s&&(c<=o?(i.dataLength=a+3,xG(n,a,fG,dG[t],_G[e.y]),a+=3):(i.dataLength=a+3,xG(n,a,fG,dG[t],pG[t]),a+=3))),l+=lG,c+=lG}i.indicesCount=i.vertexCount=a,i.vertDirty=i.uvDirty=!1}},fillBuffers(t,e){const i=t.node,n=t.renderData;hG.set(t.color),hG.a=255*i._uiProps.opacity,function(t,e,i,n){const s=i.data;let r=e.acquireBufferBatch(),o=r.byteOffset>>2,a=i.vertexCount,l=r.indicesOffset,c=r.vertexOffset;r.request(a,i.indicesCount)||(r=e.currBufferBatch,a=0,l=0,c=0);const h=r.vData;t.getWorldMatrix(DR);for(let t=0;t<a;t++){const e=s[t];oi.set(IR,e.x,e.y,0),oi.transformMat4(IR,IR,DR),h[o++]=IR.x,h[o++]=IR.y,h[o++]=IR.z,h[o++]=e.u,h[o++]=e.v,si.toArray(h,n,o),o+=4}const _=r.iData;for(let t=0;t<i.dataLength;t++)_[l+t]=c+t}(i,e,n,hG)},updateColor(t){}},CG=[];for(let t=0;t<4;t++)CG.push(new oi);const bG={createData(t){const e=t.requestRenderData();return e.dataLength=4,e.vertexCount=4,e.indicesCount=6,e.vData=new Float32Array(36),e},updateRenderData(t){const e=t.spriteFrame;NR.packToDynamicAtlas(t,e);const i=t.renderData;i&&e&&(i.vertDirty&&this.updateVertexData(t),i.uvDirty&&this.updateUvs(t))},fillBuffers(t,e){if(null===t)return;const i=t.renderData.data,n=t.node;let s=e.acquireBufferBatch(),r=s.byteOffset>>2,o=s.indicesOffset,a=s.vertexOffset;s.request()||(s=e.currBufferBatch,r=0,o=0,a=0);const l=s.vData,c=s.iData,h=t.renderData.vData,_=i[0],u=i[3],m=n.worldMatrix,d=m.m00,p=m.m01,f=m.m04,g=m.m05,y=m.m12,v=m.m13,x=_.x,S=u.x,A=_.y,C=u.y,b=d*x,T=d*S,w=p*x,E=p*S,P=f*A,I=f*C,D=g*A,R=g*C;h[0]=b+P+y,h[1]=w+D+v,h[9]=T+P+y,h[10]=E+D+v,h[18]=b+I+y,h[19]=w+R+v,h[27]=T+I+y,h[28]=E+R+v,l.set(h,r),c[o++]=a,c[o++]=a+1,c[o++]=a+2,c[o++]=a+2,c[o++]=a+1,c[o++]=a+3},updateVertexData(t){const e=t.renderData;if(!e)return;const i=t.node._uiProps.uiTransformComp,n=e.data,s=i.width,r=i.height,o=i.anchorX*s,a=i.anchorY*r;let l=0,c=0,h=0,_=0;if(t.trim)l=-o,c=-a,h=s-o,_=r-a;else{const e=t.spriteFrame,i=e.getOriginalSize(),n=e.getRect(),u=i.width,m=i.height,d=n.width,p=n.height,f=e.getOffset(),g=s/u,y=r/m,v=f.x+(u-d)/2,x=f.x-(u-d)/2;l=v*g-o,c=(f.y+(m-p)/2)*y-a,h=s+x*g-o,_=r+(f.y-(m-p)/2)*y-a}n[0].x=l,n[0].y=c,n[0].z=0,n[3].x=h,n[3].y=_,n[3].z=0,e.vertDirty=!1},updateUvs(t){const e=t.renderData,i=e.vData,n=t.spriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7],e.uvDirty=!1},updateColor(t){const e=t.renderData.vData;let i=5;const n=t.color,s=n.r/255,r=n.g/255,o=n.b/255,a=t.node._uiProps.opacity;for(let t=0;t<4;t++)e[i]=s,e[i+1]=r,e[i+2]=o,e[i+3]=a,i+=9}},TG=new oi,wG=new Si,EG={useModel:!1,createData(t){const e=t.requestRenderData();return e.dataLength=20,e.vertexCount=16,e.indicesCount=54,e},updateRenderData(t){const e=t.spriteFrame;NR.packToDynamicAtlas(t,e);const i=t.renderData;i&&e&&i.vertDirty&&(this.updateVertexData(t),this.updateWorldVertexData(t))},updateVertexData(t){const e=t.renderData,i=e.data,n=t.node._uiProps.uiTransformComp,s=n.width,r=n.height,o=n.anchorX*s,a=n.anchorY*r,l=t.spriteFrame,c=l.insetLeft,h=l.insetRight,_=l.insetTop,u=l.insetBottom;let m=s-c-h,d=r-_-u,p=s/(c+h),f=r/(_+u);p=Number.isNaN(p)||p>1?1:p,f=Number.isNaN(f)||f>1?1:f,m=m<0?0:m,d=d<0?0:d,i[0].x=-o,i[0].y=-a,i[1].x=c*p-o,i[1].y=u*f-a,i[2].x=i[1].x+m,i[2].y=i[1].y+d,i[3].x=s-o,i[3].y=r-a,e.vertDirty=!1},fillBuffers(t,e){t.node.hasChangedFlags&&this.updateWorldVertexData(t);let i=e.acquireBufferBatch();const n=t.renderData,s=n.data;let r=i.byteOffset>>2;const o=n.vertexCount;let a=i.indicesOffset,l=i.vertexOffset;const c=t.spriteFrame.uvSliced;i.request(o,n.indicesCount)||(i=e.currBufferBatch,r=0,a=0,l=0);const h=i.vData,_=i.iData;for(let t=4;t<20;++t){const e=s[t],i=c[t-4];h[r++]=e.x,h[r++]=e.y,h[r++]=e.z,h[r++]=i.u,h[r++]=i.v,si.toArray(h,s[t].color,r),r+=4}for(let t=0;t<3;++t)for(let e=0;e<3;++e){const i=l+4*t+e;_[a++]=i,_[a++]=i+1,_[a++]=i+4,_[a++]=i+1,_[a++]=i+5,_[a++]=i+4}},updateWorldVertexData(t){const e=t.node,i=t.renderData.data;e.getWorldMatrix(wG);for(let t=0;t<4;++t){const e=i[t];for(let n=0;n<4;++n){const s=i[n],r=i[4+4*t+n];oi.set(TG,s.x,e.y,0),oi.transformMat4(r,TG,wG)}}},updateColor(t){const e=t.renderData.data,i=t.color,n=i.r,s=i.g,r=i.b,o=255*t.node._uiProps.opacity;for(let t=4;t<20;t++)e[t].color.r=n,e[t].color.g=s,e[t].color.b=r,e[t].color.a=o}},PG=[];for(let t=0;t<4;t++)PG.push(new oi);const IG={createData:t=>t.requestRenderData(),updateRenderData(t){const e=t.renderData,i=t.spriteFrame;if(!i||!e||!e.uvDirty&&!e.vertDirty)return;const n=t.node._uiProps.uiTransformComp,s=Math.abs(n.width),r=Math.abs(n.height),o=i.getRect(),a=i.insetLeft,l=i.insetRight,c=o.width-a-l,h=i.insetTop,_=i.insetBottom,u=o.height-h-_;let m=s-a-l,d=r-h-_;m=m>0?m:0,d=d>0?d:0;const p=0===c?m:m/c,f=0===u?d:d/u,g=Math.ceil(f+2),y=Math.ceil(p+2);e.dataLength=Math.max(8,g+1,y+1),this.updateVerts(t,m,d,g,y),e.vertexCount=g*y*4,e.indicesCount=g*y*6,e.uvDirty=!1,e.vertDirty=!1,this.updateColor(t)},fillBuffers(t,e){const i=t.node,n=t.node._uiProps.uiTransformComp,s=Math.abs(n.width),r=Math.abs(n.height),o=t.renderData;let a=e.acquireBufferBatch(),l=a.indicesOffset,c=a.byteOffset>>2,h=a.vertexOffset;const _=o.vertexCount,u=o.indicesCount,m=a.vData,d=a.iData;a.request(_,u)||(a=e.currBufferBatch,c=0,l=0,h=0);const p=t.spriteFrame,f=p.isRotated(),g=p.uv,y=t.spriteFrame.uvSliced,v=p.getRect(),x=p.insetLeft,S=p.insetRight,A=v.width-x-S,C=p.insetTop,b=p.insetBottom,T=v.height-C-b;let w=s-x-S,E=r-C-b;w=w>0?w:0,E=E>0?E:0;const P=0===A?w:w/A,I=0===T?E:E/T,D=Math.ceil(I+2),R=Math.ceil(P+2),M=i.worldMatrix,B=o.data;this.fillVertices(m,c,M,D,R,B);let O=0,N=0;const L=[],F=[];for(let t=0,e=D;t<e;++t){N=E>T?E>=t*T?1:I%1:I;for(let e=0,i=R;e<i;++e){O=w>A?w>=e*A?1:P%1:P;const i=c+3,n=i+1;f?(0===t?(L[0]=y[0].u,L[1]=y[0].u,L[2]=y[4].u+(y[8].u-y[4].u)*N):t<D-1?(L[0]=y[4].u,L[1]=y[4].u,L[2]=y[4].u+(y[8].u-y[4].u)*N):t===D-1&&(L[0]=y[8].u,L[1]=y[8].u,L[2]=y[12].u),0===e?(F[0]=y[0].v,F[1]=y[1].v+(y[2].v-y[1].v)*O,F[2]=y[0].v):e<R-1?(F[0]=y[1].v,F[1]=y[1].v+(y[2].v-y[1].v)*O,F[2]=y[1].v):e===R-1&&(F[0]=y[2].v,F[1]=y[3].v,F[2]=y[2].v),L[3]=L[2],F[3]=F[1]):(0===e?(L[0]=y[0].u,L[1]=y[1].u+(y[2].u-y[1].u)*O,L[2]=g[0]):e<R-1?(L[0]=y[1].u,L[1]=y[1].u+(y[2].u-y[1].u)*O,L[2]=y[1].u):e===R-1&&(L[0]=y[2].u,L[1]=y[3].u,L[2]=y[2].u),0===t?(F[0]=y[0].v,F[1]=y[0].v,F[2]=y[4].v+(y[8].v-y[4].v)*N):t<D-1?(F[0]=y[4].v,F[1]=y[4].v,F[2]=y[4].v+(y[8].v-y[4].v)*N):t===D-1&&(F[0]=y[8].v,F[1]=y[8].v,F[2]=y[12].v),L[3]=L[1],F[3]=F[2]),m[i]=L[0],m[n]=F[0],m[i+9]=L[1],m[n+9]=F[1],m[i+18]=L[2],m[n+18]=F[2],m[i+27]=L[3],m[n+27]=F[3],si.toArray(m,B[0].color,n+1),si.toArray(m,B[0].color,n+9+1),si.toArray(m,B[0].color,n+18+1),si.toArray(m,B[0].color,n+27+1),c+=36}}for(let t=0;t<u;t+=6)d[l++]=h,d[l++]=h+1,d[l++]=h+2,d[l++]=h+1,d[l++]=h+3,d[l++]=h+2,h+=4},fillVertices(t,e,i,n,s,r){let o=0,a=0,l=0,c=0;for(let h=0,_=n;h<_;++h){l=r[h].y,c=r[h+1].y;for(let n=0,h=s;n<h;++n){o=r[n].x,a=r[n+1].x,oi.set(PG[0],o,l,0),oi.set(PG[1],a,l,0),oi.set(PG[2],o,c,0),oi.set(PG[3],a,c,0);for(let n=0;n<4;n++){const s=PG[n];oi.transformMat4(s,s,i);const r=9*n;t[e+r]=s.x,t[e+r+1]=s.y,t[e+r+2]=s.z}e+=36}}},updateVerts(t,e,i,n,s){const r=t.node._uiProps.uiTransformComp,o=t.renderData.data,a=t.spriteFrame,l=a.getRect(),c=Math.abs(r.width),h=Math.abs(r.height),_=r.anchorX*c,u=r.anchorY*h,m=a.insetLeft,d=a.insetRight,p=l.width-m-d,f=a.insetTop,g=a.insetBottom,y=l.height-f-g,v=r.width/(m+d)>1?1:r.width/(m+d),x=r.height/(f+g)>1?1:r.height/(f+g);let S=0,A=0;S=p>0?Math.floor(1e3*e)/1e3%p==0?p:e%p:e,A=y>0?Math.floor(1e3*i)/1e3%y==0?y:i%y:i;for(let t=0;t<=s;t++)0===t?o[t].x=-_:t>0&&t<s?o[t].x=1===t?m*v+Math.min(p,e)-_:p>0?t===s-1?m+S+p*(t-2)-_:m+Math.min(p,e)+p*(t-2)-_:m+e-_:t===s&&(o[t].x=Math.min(m+e+d,c)-_);for(let t=0;t<=n;t++)0===t?o[t].y=-u:t>0&&t<n?o[t].y=1===t?g*x+Math.min(y,i)-u:y>0?t===n-1?g+A+(t-2)*y-u:g+Math.min(y,i)+(t-2)*y-u:g+i-u:t===n&&(o[t].y=Math.min(g+i+f,h)-u)},updateColor(t){const e=t.renderData.data,i=e.length;if(0===i)return;const n=t.color,s=n.r,r=n.g,o=n.b,a=255*t.node._uiProps.opacity;for(let t=0;t<i;t++)e[t].color.r=s,e[t].color.g=r,e[t].color.b=o,e[t].color.a=a}},DG=mF.Type,RG=mF.FillType,MG=t("spriteAssembler",{getAssembler(t){let e=bG;const i=t;switch(i.type){case DG.SLICED:e=EG;break;case DG.TILED:e=IG;break;case DG.FILLED:e=i.fillType===RG.RADIAL?AG:aG}return e}});mF.Assembler=MG;const BG=oB.sharedManager,OG={createData(t){const e=t.requestRenderData();return e.dataLength=4,e.vertexCount=4,e.indicesCount=6,e.vData=new Float32Array(36),e},updateRenderData(t){t.type===aL.IMAGE_STENCIL&&(bG.updateRenderData(t),bG.updateColor(t))},fillBuffers(t,e){(t.type!==aL.IMAGE_STENCIL||t.spriteFrame)&&(BG.pushMask(t),e.finishMergeBatches(),function(t,e){BG.clear(t),e.commitModel(t,t._clearModel,t._clearStencilMtl)}(t,e),function(t,e){if(BG.enterLevel(t),t.type===aL.IMAGE_STENCIL){bG.fillBuffers(t,e);const i=t.graphics.getMaterialInstance(0);e.forceMergeBatches(i,t.spriteFrame,t.graphics)}else t.graphics.updateAssembler(e)}(t,e),BG.enableMask())}},NG={fillBuffers(t,e){BG.exitMask()}},LG={getAssembler:()=>OG},FG={getAssembler:()=>NG};lL.Assembler=LG,lL.PostAssembler=FG;const zG=new ma(null),VG=new Si;class UG{get currBufferBatch(){return this._currMeshBuffer||(this._currMeshBuffer=this.acquireBufferBatch()),this._currMeshBuffer}set currBufferBatch(t){t&&(this._currMeshBuffer=t)}get batches(){return this._batches}acquireBufferBatch(t=iN){const e=t===iN?36:rN(t);return this._currMeshBuffer&&this._currMeshBuffer.vertexFormatBytes===e||this._requireBufferBatch(t),this._currMeshBuffer}registerCustomBuffer(t,e){let i;t instanceof bz?i=t:(i=this._bufferBatchPool.add(),i.initialize(t,e||this._recreateMeshBuffer.bind(this,t)));const n=i.vertexFormatBytes;let s=this._customMeshBuffers.get(n);return s||(s=[],this._customMeshBuffers.set(n,s)),s.push(i),i}unRegisterCustomBuffer(t){const e=this._customMeshBuffers.get(t.vertexFormatBytes);if(e)for(let i=0;i<e.length;i++)if(e[i]===t){e.splice(i,1);break}}set currStaticRoot(t){this._currStaticRoot=t}set currIsStatic(t){this._currIsStatic=t}constructor(t){this.device=void 0,this._screens=[],this._bufferBatchPool=new zi((()=>new bz(this)),128),this._drawBatchPool=void 0,this._meshBuffers=new Map,this._customMeshBuffers=new Map,this._meshBufferUseCount=new Map,this._batches=void 0,this._doUploadBuffersCall=new Map,this._emptyMaterial=new ov,this._currScene=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currMeshBuffer=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currBlendTargetHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._descriptorSetCache=new HG,this._root=t,this.device=t.device,this._batches=new Vi(64),this._drawBatchPool=new Fi((()=>new wz),128)}initialize(){return!0}destroy(){for(let t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy();for(const t of this._meshBuffers.keys()){const e=this._meshBuffers.get(t);e&&e.forEach((t=>t.destroy()))}this._drawBatchPool&&this._drawBatchPool.destroy((t=>{t.destroy(this)})),this._descriptorSetCache.destroy(),this._meshBuffers.clear(),oB.sharedManager.destroy()}addScreen(t){this._screens.push(t),this._screens.sort(this._screenSort)}getFirstRenderCamera(t){if(t.scene&&t.scene.renderScene){const e=t.scene.renderScene.cameras;for(let i=0;i<e.length;i++){const n=e[i];if(n.visibility&t.layer)return n}}return null}removeScreen(t){const e=this._screens.indexOf(t);-1!==e&&this._screens.splice(e,1)}sortScreens(){this._screens.sort(this._screenSort)}addUploadBuffersFunc(t,e){this._doUploadBuffersCall.set(t,e)}removeUploadBuffersFunc(t){this._doUploadBuffersCall.delete(t)}update(){const t=this._screens;for(let e=0;e<t.length;++e){const i=t[e];i.enabledInHierarchy&&this._recursiveScreenNode(i.node)}let e=0;if(this._batches.length)for(let t=0;t<this._batches.length;++t){const i=this._batches.array[t];if(i.renderScene){if(i.model){const t=i.model.subModels;for(let i=0;i<t.length;i++)t[i].priority=e++}else i.hDescriptorSet=this._descriptorSetCache.getDescriptorSet(i);i.renderScene.addBatch(i)}}}uploadBuffers(){this._batches.length>0&&(this._doUploadBuffersCall.forEach(((t,e)=>{t.call(e,this)})),this._meshBuffers.forEach((t=>{t.forEach((t=>{t.uploadBuffers(),t.reset()}))})),this._customMeshBuffers.forEach((t=>{t.forEach((t=>{t.uploadBuffers(),t.reset()}))})),this._descriptorSetCache.update())}reset(){for(let t=0;t<this._batches.length;++t){const e=this._batches.array[t];e.isStatic||(e.clear(),this._drawBatchPool.free(e))}this._currLayer=0,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._currScene=null,this._currMeshBuffer=null,this._meshBufferUseCount.clear(),this._batches.clear(),oB.sharedManager.reset(),this._descriptorSetCache.reset()}commitComp(t,e,i,n){const s=t;let r,o,a=0,l=0;e?(r=e.getGFXTexture(),o=e.getGFXSampler(),a=e.getHash(),l=e.getSamplerHash()):(r=null,o=null);const c=s._getRenderScene(),h=s.getRenderMaterial(0);s.stencilStage=oB.sharedManager.stage;const _=s.blendHash,u=s.stencilStage;this._currScene===c&&this._currLayer===t.node.layer&&this._currMaterial===h&&this._currBlendTargetHash===_&&this._currDepthStencilStateStage===u&&this._currTextureHash===a&&this._currSamplerHash===l&&this._currTransform===n||(this.autoMergeBatches(this._currComponent),this._currScene=c,this._currComponent=s,this._currTransform=n,this._currMaterial=h,this._currTexture=r,this._currSampler=o,this._currTextureHash=a,this._currSamplerHash=l,this._currBlendTargetHash=_,this._currDepthStencilStateStage=u,this._currLayer=t.node.layer),i&&i.fillBuffers(s,this)}commitModel(t,e,i){let s;this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(this._currComponent);let r=0;i&&(t.stencilStage!==sB.ENABLED&&t.stencilStage!==sB.DISABLED||(t.stencilStage=oB.sharedManager.stage),s=oB.sharedManager.getStencilStage(t.stencilStage,i),r=oB.sharedManager.getStencilHash(t.stencilStage));const o=n.director.getTotalFrames();e&&(e.updateTransform(o),e.updateUBOs(o));for(let n=0;n<e.subModels.length;n++){const o=this._drawBatchPool.alloc(),a=e.subModels[n];o.renderScene=t._getRenderScene(),o.visFlags=t.node.layer,o.model=e,o.bufferBatch=null,o.texture=null,o.sampler=null,o.useLocalData=null,s||(s=null),o.fillPasses(i,s,r,null,0,a.patches),o.hDescriptorSet=is.get(a.handle,ts.DESCRIPTOR_SET),o.hInputAssembler=is.get(a.handle,ts.INPUT_ASSEMBLER),o.model.visFlags=o.visFlags,this._batches.push(o)}this._currMaterial=this._emptyMaterial,this._currScene=null,this._currComponent=null,this._currTransform=null,this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0}commitStaticBatch(t){this._batches.concat(t.drawBatchList),this.finishMergeBatches()}autoMergeBatches(t){const e=this.currBufferBatch,i=null==e?void 0:e.recordBatch(),n=this._currMaterial;if(!i||!n||!e)return;let s,r,o=0,a=0;t&&(s=-1===t.blendHash?null:t.getBlendState(),a=t.blendHash,r=null!==t.customMaterial?oB.sharedManager.getStencilStage(t.stencilStage,n):oB.sharedManager.getStencilStage(t.stencilStage),o=oB.sharedManager.getStencilHash(t.stencilStage));const l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.renderScene=this._currScene,l.visFlags=this._currLayer,l.bufferBatch=e,l.texture=this._currTexture,l.sampler=this._currSampler,l.hInputAssembler=i,l.useLocalData=this._currTransform,l.textureHash=this._currTextureHash,l.samplerHash=this._currSamplerHash,l.fillPasses(n,r,o,s,a,null),this._batches.push(l),e.vertexStart=e.vertexOffset,e.indicesStart=e.indicesOffset,e.byteStart=e.byteOffset,Cy.__isWebIOS14OrIPadOS14Env&&!this._currIsStatic&&(this._currMeshBuffer=null)}forceMergeBatches(t,e,i){this._currMaterial=t,e?(this._currTexture=e.getGFXTexture(),this._currSampler=e.getGFXSampler(),this._currTextureHash=e.getHash(),this._currSamplerHash=e.getSamplerHash()):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=i.node.layer,this._currScene=i._getRenderScene(),this.autoMergeBatches(i)}finishMergeBatches(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0}flushMaterial(t){this._currMaterial=t}walk(t,e=0){const i=t.children.length;if(this._preProcess(t),i>0&&!t._static){const i=t.children;for(let t=0;t<i.length;++t){const n=i[t];this.walk(n,e)}}this._postProcess(t),e+=1}_preProcess(t){const e=t._uiProps.uiComp;if(!e){const e=t._uiProps.localOpacity;t._uiProps.opacity=t.parent&&t.parent._uiProps?t.parent._uiProps.opacity*e:e}t._uiProps.uiTransformComp&&e&&e.enabledInHierarchy&&e.updateAssembler(this)}_postProcess(t){const e=t._uiProps.uiComp;e&&e.enabledInHierarchy&&e.postUpdateAssembler(this)}_recursiveScreenNode(t){this.walk(t),this.autoMergeBatches(this._currComponent)}_createMeshBuffer(t){const e=this._bufferBatchPool.add();e.initialize(t,this._recreateMeshBuffer.bind(this,t));const i=rN(t);let n=this._meshBuffers.get(i);return n||(n=[],this._meshBuffers.set(i,n)),n.push(e),e}_recreateMeshBuffer(t,e,i){this.autoMergeBatches(),this._requireBufferBatch(t,e,i)}_requireBufferBatch(t,e,i){const n=rN(t);let s=this._meshBuffers.get(n);s||(s=[],this._meshBuffers.set(n,s));const r=this._meshBufferUseCount.get(n)||0;r>=s.length?this._currMeshBuffer=this._createMeshBuffer(t):this._currMeshBuffer=s[r],this._meshBufferUseCount.set(n,r+1),e&&i&&this._currMeshBuffer.request(e,i)}_screenSort(t,e){return t.node.getSiblingIndex()-e.node.getSiblingIndex()}_releaseDescriptorSetCache(t){this._descriptorSetCache.releaseDescriptorSetCache(t)}}t("UI",UG);class GG{get handle(){return this._handle}constructor(){this._handle=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;const t=n.director.root.device;this._localData=new Float32Array(mh.COUNT),this._localBuffer=t.createBuffer(new zo(Xr.UNIFORM|Xr.TRANSFER_DST,Jr.HOST|Jr.DEVICE,mh.SIZE,mh.SIZE))}initialize(t){const e=n.director.root.device;this._transform=t.useLocalData,this._textureHash=t.textureHash,this._samplerHash=t.samplerHash,zG.layout=t.passes[0].localSetLayout,this._handle&&(zn.free(this._handle),this._handle=null),this._handle=zn.alloc(e,zG),this._descriptorSet=zn.get(this._handle),this._descriptorSet.bindBuffer(mh.BINDING,this._localBuffer);const i=Nc.SAMPLER_SPRITE;this._descriptorSet.bindTexture(i,t.texture),this._descriptorSet.bindSampler(i,t.sampler),this._descriptorSet.update(),this._transformUpdate=!0}updateTransform(t){t!==this._transform&&(this._transform=t,this._transformUpdate=!0,this.uploadLocalData())}updateLocal(){this._transform&&this.uploadLocalData()}equals(t,e,i){return this._transform===t&&this._textureHash===e&&this._samplerHash===i}reset(){this._transform=null,this._textureHash=0,this._samplerHash=0}destroy(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._handle&&(zn.free(this._handle),this._handle=null),this._localData=null}uploadLocalData(){const t=this._transform;if((t.hasChangedFlags||t._dirtyFlags)&&t.updateWorldTransform(),this._transformUpdate){const e=t._mat;Si.toArray(this._localData,e,mh.MAT_WORLD_OFFSET),Si.inverseTranspose(VG,e),Si.toArray(this._localData,VG,mh.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}}}class HG{constructor(){this._descriptorSetCache=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Fi((()=>new GG),16)}getDescriptorSet(t){const e=n.director.root;if(t.useLocalData){const e=this._localDescriptorSetCache;for(let i=0,n=e.length;i<n;i++){const n=e[i];if(n.equals(t.useLocalData,t.textureHash,t.samplerHash))return n.handle}const i=this._localCachePool.alloc();return i.initialize(t),this._localDescriptorSetCache.push(i),i.handle}{const i=this._descriptorSetCache.get(t.textureHash);if(i&&i.has(t.samplerHash))return i.get(t.samplerHash);{zG.layout=t.passes[0].localSetLayout;const n=zn.alloc(e.device,zG),s=zn.get(n),r=Nc.SAMPLER_SPRITE;return s.bindTexture(r,t.texture),s.bindSampler(r,t.sampler),s.update(),i?this._descriptorSetCache.get(t.textureHash).set(t.samplerHash,n):this._descriptorSetCache.set(t.textureHash,new Map([[t.samplerHash,n]])),n}}}update(){this._localDescriptorSetCache.forEach((t=>{t.updateLocal()}))}reset(){this._localDescriptorSetCache.forEach((t=>{this._localCachePool.free(t)})),this._localDescriptorSetCache.length=0}releaseDescriptorSetCache(t){this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).forEach((t=>{zn.free(t)})),this._descriptorSetCache.delete(t))}destroy(){this._descriptorSetCache.forEach((t=>{t.forEach((t=>{zn.free(t)}))})),this._descriptorSetCache.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy((t=>{t.destroy()}))}}n.internal.Batcher2D=UG;let kG=null,jG=-1;const WG="BES bswy:->@123丁ぁᄁ",qG=Object.create(null),XG=[],YG=3e3,KG=(()=>{let t;return()=>{if(void 0===t)if("FontFace"in window){const e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),i=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);t=e?parseInt(e[1],10)>42:!i}else t=!1;return t}})();function JG(){let t=!0;const e=Date.now();for(let i=XG.length-1;i>=0;i--){const n=XG[i],s=n.fontFamilyName;if(e-n.startTime>YG){C(4933,s),n.onComplete(null,s),XG.splice(i,1);continue}const r=n.refWidth,o=`40px ${s}`;kG.font=o,r!==vM(kG,WG,o)?(XG.splice(i,1),n.onComplete(null,s)):t=!1}t&&(clearInterval(jG),jG=-1)}function $G(t,e,i){const n=function(t){const e=t.lastIndexOf(".ttf");if(-1===e)return t;const i=t.lastIndexOf("/");let n;return n=-1===i?`${t.substring(0,e)}_LABEL`:`${t.substring(i+1,e)}_LABEL`,-1!==n.indexOf(" ")&&(n=`"${n}"`),n}(t);if(qG[n])return void i(null,n);if(!kG){const t=document.createElement("canvas");t.width=100,t.height=100,kG=t.getContext("2d")}const s=vM(kG,WG,`40px ${n}`),r=document.createElement("style");r.type="text/css";let o="";Number.isNaN(n)?o+=`@font-face { font-family:${n}; src:`:o+=`@font-face { font-family:"${n}"; src:`,o+=`url("${t}");`,r.textContent=`${o}}`,document.body.appendChild(r);const a=document.createElement("div"),l=a.style;if(l.fontFamily=n,a.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(a),KG())!function(t,e,i){const n=new Promise(((i,n)=>{const s=()=>{Date.now()-t>=YG?n():document.fonts.load(`40px ${e}`).then((t=>{t.length>=1?i():setTimeout(s,100)}),(()=>{n()}))};s()}));let s=null;const r=new Promise(((t,e)=>{s=setTimeout(e,YG)}));Promise.race([r,n]).then((()=>{s&&(clearTimeout(s),s=null),i(null,e)}),(()=>{C(4933,e),i(null,e)}))}(Date.now(),n,i);else{const t={fontFamilyName:n,refWidth:s,onComplete:i,startTime:Date.now()};XG.push(t),-1===jG&&(jG=setInterval(JG,100))}qG[n]=r}function ZG(t,e,i,n){const s=new YR;s._nativeUrl=t,s._nativeAsset=e,n(null,s)}var QG,tH,eH,iH,nH,sH,rH,oH,aH,lH,cH,hH,_H,uH,mH,dH,pH,fH,gH,yH,vH,xH,SH,AH,CH,bH,TH,wH,EH,PH,IH,DH,RH,MH,BH,OH,NH,LH,FH,zH,VH,UH,GH,HH,kH,jH,WH,qH,XH,YH;VT.register({".font":$G,".eot":$G,".ttf":$G,".woff":$G,".svg":$G,".ttc":$G}),qT.register({".font":ZG,".eot":ZG,".ttf":ZG,".woff":ZG,".svg":ZG,".ttc":ZG}),n.UI={MeshBuffer:bz,spriteAssembler:MG,graphicsAssembler:NV,labelAssembler:nG};const KH=new si;var JH,$H;let ZH;!function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.SPRITE=2]="SPRITE",t[t.SCALE=3]="SCALE"}(JH||(JH={})),jt(JH),function(t){t.NORMAL="normal",t.HOVER="hover",t.PRESSED="pressed",t.DISABLED="disabled"}($H||($H={})),function(t){t.CLICK="click"}(ZH||(ZH={}));let QH,tk,ek,ik=function(e){return t({Button:e,ButtonComponent:e}),e}((QG=u_("cc.Button"),tH=T_(),eH=d_(110),iH=S_(),nH=m_(rB),sH=H_(uf),rH=N_(),oH=I_(),aH=N_(),lH=I_(),cH=H_(JH),hH=N_(),_H=I_(),uH=I_(),mH=I_(),dH=I_(),pH=I_(),fH=R_(),gH=M_(),yH=I_(),vH=I_(),xH=H_(zR),SH=I_(),AH=H_(zR),CH=I_(),bH=H_(zR),TH=I_(),wH=H_(zR),EH=I_(),PH=H_([Rw]),IH=N_(),DH=I_(),QG(RH=tH(RH=eH(RH=iH(RH=nH(RH=x_((YH=XH=class extends Nm{constructor(...t){super(...t),i_(this,"clickEvents",BH,this),i_(this,"_interactable",OH,this),i_(this,"_transition",NH,this),i_(this,"_normalColor",LH,this),i_(this,"_hoverColor",FH,this),i_(this,"_pressedColor",zH,this),i_(this,"_disabledColor",VH,this),i_(this,"_normalSprite",UH,this),i_(this,"_hoverSprite",GH,this),i_(this,"_pressedSprite",HH,this),i_(this,"_disabledSprite",kH,this),i_(this,"_duration",jH,this),i_(this,"_zoomScale",WH,this),i_(this,"_target",qH,this),this._pressed=!1,this._hovered=!1,this._fromColor=new si,this._toColor=new si,this._time=0,this._transitionFinished=!0,this._fromScale=new oi,this._toScale=new oi,this._originalScale=null,this._sprite=null,this._targetScale=new oi}get target(){return this._target||this.node}set target(t){this._target!==t&&(this._target&&this._unregisterTargetEvent(this._target),this._target=t,this._applyTarget())}get interactable(){return this._interactable}set interactable(t){this._interactable=t,this._updateState(),this._interactable||this._resetState()}set _resizeToTarget(t){t&&this._resizeNodeToTargetNode()}get transition(){return this._transition}set transition(t){this._transition!==t&&(this._transition===JH.COLOR?this._updateColorTransition($H.NORMAL):this._transition===JH.SPRITE&&this._updateSpriteTransition($H.NORMAL),this._transition=t,this._updateState())}get normalColor(){return this._normalColor}set normalColor(t){this._normalColor!==t&&(this._normalColor.set(t),this._updateState())}get pressedColor(){return this._pressedColor}set pressedColor(t){this._pressedColor!==t&&this._pressedColor.set(t)}get hoverColor(){return this._hoverColor}set hoverColor(t){this._hoverColor!==t&&this._hoverColor.set(t)}get disabledColor(){return this._disabledColor}set disabledColor(t){this._disabledColor!==t&&(this._disabledColor.set(t),this._updateState())}get duration(){return this._duration}set duration(t){this._duration!==t&&(this._duration=t)}get zoomScale(){return this._zoomScale}set zoomScale(t){this._zoomScale!==t&&(this._zoomScale=t)}get normalSprite(){return this._normalSprite}set normalSprite(t){if(this._normalSprite===t)return;this._normalSprite=t;const e=this.node.getComponent(mF);e&&(e.spriteFrame=t),this._updateState()}get pressedSprite(){return this._pressedSprite}set pressedSprite(t){this._pressedSprite!==t&&(this._pressedSprite=t,this._updateState())}get hoverSprite(){return this._hoverSprite}set hoverSprite(t){this._hoverSprite!==t&&(this._hoverSprite=t,this._updateState())}get disabledSprite(){return this._disabledSprite}set disabledSprite(t){this._disabledSprite!==t&&(this._disabledSprite=t,this._updateState())}__preload(){this.target||(this.target=this.node);const t=this.node.getComponent(mF);t&&(this._normalSprite=t.spriteFrame),this._applyTarget(),this._resetState()}onEnable(){this._registerNodeEvent()}onDisable(){this._resetState(),this._unregisterNodeEvent()}update(t){const e=this.target;if(this._transitionFinished||!e)return;if(this._transition!==JH.COLOR&&this._transition!==JH.SCALE)return;this._time+=t;let i=1;if(this._duration>0&&(i=this._time/this._duration),i>=1&&(i=1),this._transition===JH.COLOR){const t=e._uiProps.uiComp;si.lerp(KH,this._fromColor,this._toColor,i),t&&(t.color=KH)}else this.transition===JH.SCALE&&(e.getScale(this._targetScale),this._targetScale.x=He(this._fromScale.x,this._toScale.x,i),this._targetScale.y=He(this._fromScale.y,this._toScale.y,i),e.setScale(this._targetScale));1===i&&(this._transitionFinished=!0)}_resizeNodeToTargetNode(){this.target&&this.target._uiProps.uiTransformComp}_resetState(){this._pressed=!1,this._hovered=!1;const t=this.target;if(!t)return;const e=t.getComponent(wB);if(!e)return;const i=this._transition;i===JH.COLOR&&this._interactable?e.color=this._normalColor:i===JH.SCALE&&this._originalScale&&t.setScale(this._originalScale),this._transitionFinished=!0}_registerNodeEvent(){this.node.on(_p.TOUCH_START,this._onTouchBegan,this),this.node.on(_p.TOUCH_MOVE,this._onTouchMove,this),this.node.on(_p.TOUCH_END,this._onTouchEnded,this),this.node.on(_p.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(_p.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(_p.MOUSE_LEAVE,this._onMouseMoveOut,this)}_registerTargetEvent(t){t.on(_p.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)}_unregisterNodeEvent(){this.node.off(_p.TOUCH_START,this._onTouchBegan,this),this.node.off(_p.TOUCH_MOVE,this._onTouchMove,this),this.node.off(_p.TOUCH_END,this._onTouchEnded,this),this.node.off(_p.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(_p.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(_p.MOUSE_LEAVE,this._onMouseMoveOut,this)}_unregisterTargetEvent(t){t.off(_p.TRANSFORM_CHANGED)}_getTargetSprite(t){let e=null;return t&&(e=t.getComponent(mF)),e}_applyTarget(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new oi),oi.copy(this._originalScale,this.target.getScale()))}_onTargetSpriteFrameChanged(t){this._transition===JH.SPRITE&&this._setCurrentStateSpriteFrame(t.spriteFrame)}_setCurrentStateSpriteFrame(t){if(t)switch(this._getButtonState()){case $H.NORMAL:this._normalSprite=t;break;case $H.HOVER:this._hoverSprite=t;break;case $H.PRESSED:this._pressedSprite=t;break;case $H.DISABLED:this._disabledSprite=t}}_onTargetColorChanged(t){this._transition===JH.COLOR&&this._setCurrentStateColor(t)}_setCurrentStateColor(t){switch(this._getButtonState()){case $H.NORMAL:this._normalColor=t;break;case $H.HOVER:this._hoverColor=t;break;case $H.PRESSED:this._pressedColor=t;break;case $H.DISABLED:this._disabledColor=t}}_onTargetTransformChanged(t){t|t_.SCALE&&this._originalScale&&this._transition===JH.SCALE&&this._transitionFinished&&oi.copy(this._originalScale,this.target.getScale())}_onTouchBegan(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),t&&(t.propagationStopped=!0))}_onTouchMove(t){if(!this._interactable||!this.enabledInHierarchy||!this._pressed)return;if(!t)return;const e=t.touch;if(!e)return;const i=this.node._uiProps.uiTransformComp.isHit(e.getUILocation());if(this._transition===JH.SCALE&&this.target&&this._originalScale)i?(oi.copy(this._fromScale,this._originalScale),oi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale));else{let t;t=i?$H.PRESSED:$H.NORMAL,this._applyTransition(t)}t&&(t.propagationStopped=!0)}_onTouchEnded(t){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(Rw.emitEvents(this.clickEvents,t),this.node.emit(ZH.CLICK,this)),this._pressed=!1,this._updateState(),t&&(t.propagationStopped=!0))}_onTouchCancel(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}_onMouseMoveIn(t){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==JH.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}_onMouseMoveOut(t){this._hovered&&(this._hovered=!1,this._updateState())}_updateState(){const t=this._getButtonState();this._applyTransition(t)}_getButtonState(){let t=$H.NORMAL;return this._interactable?this._pressed?t=$H.PRESSED:this._hovered&&(t=$H.HOVER):t=$H.DISABLED,t.toString()}_updateColorTransition(t){var e;const i=this[`${t}Color`],n=null===(e=this.target)||void 0===e?void 0:e.getComponent(wB);n&&(t===$H.DISABLED?n.color=i:(this._fromColor=n.color.clone(),this._toColor=i,this._time=0,this._transitionFinished=!1))}_updateSpriteTransition(t){const e=this[`${t}Sprite`];this._sprite&&e&&(this._sprite.spriteFrame=e)}_updateScaleTransition(t){this._interactable&&(t===$H.PRESSED?this._zoomUp():this._zoomBack())}_zoomUp(){this._originalScale&&(oi.copy(this._fromScale,this._originalScale),oi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)}_zoomBack(){this.target&&this._originalScale&&(oi.copy(this._fromScale,this.target.getScale()),oi.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}_applyTransition(t){const e=this._transition;e===JH.COLOR?this._updateColorTransition(t):e===JH.SPRITE?this._updateSpriteTransition(t):e===JH.SCALE&&this._updateScaleTransition(t)}},XH.Transition=JH,XH.EventType=ZH,n_((MH=YH).prototype,"target",[sH,rH,oH],Object.getOwnPropertyDescriptor(MH.prototype,"target"),MH.prototype),n_(MH.prototype,"interactable",[aH,lH],Object.getOwnPropertyDescriptor(MH.prototype,"interactable"),MH.prototype),n_(MH.prototype,"transition",[cH,hH,_H],Object.getOwnPropertyDescriptor(MH.prototype,"transition"),MH.prototype),n_(MH.prototype,"normalColor",[uH],Object.getOwnPropertyDescriptor(MH.prototype,"normalColor"),MH.prototype),n_(MH.prototype,"pressedColor",[mH],Object.getOwnPropertyDescriptor(MH.prototype,"pressedColor"),MH.prototype),n_(MH.prototype,"hoverColor",[dH],Object.getOwnPropertyDescriptor(MH.prototype,"hoverColor"),MH.prototype),n_(MH.prototype,"disabledColor",[pH],Object.getOwnPropertyDescriptor(MH.prototype,"disabledColor"),MH.prototype),n_(MH.prototype,"duration",[fH,gH,yH],Object.getOwnPropertyDescriptor(MH.prototype,"duration"),MH.prototype),n_(MH.prototype,"zoomScale",[vH],Object.getOwnPropertyDescriptor(MH.prototype,"zoomScale"),MH.prototype),n_(MH.prototype,"normalSprite",[xH,SH],Object.getOwnPropertyDescriptor(MH.prototype,"normalSprite"),MH.prototype),n_(MH.prototype,"pressedSprite",[AH,CH],Object.getOwnPropertyDescriptor(MH.prototype,"pressedSprite"),MH.prototype),n_(MH.prototype,"hoverSprite",[bH,TH],Object.getOwnPropertyDescriptor(MH.prototype,"hoverSprite"),MH.prototype),n_(MH.prototype,"disabledSprite",[wH,EH],Object.getOwnPropertyDescriptor(MH.prototype,"disabledSprite"),MH.prototype),BH=n_(MH.prototype,"clickEvents",[PH,g_,IH,DH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),OH=n_(MH.prototype,"_interactable",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),NH=n_(MH.prototype,"_transition",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return JH.NONE}}),LH=n_(MH.prototype,"_normalColor",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return si.WHITE.clone()}}),FH=n_(MH.prototype,"_hoverColor",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new si(211,211,211,255)}}),zH=n_(MH.prototype,"_pressedColor",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return si.WHITE.clone()}}),VH=n_(MH.prototype,"_disabledColor",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new si(124,124,124,255)}}),UH=n_(MH.prototype,"_normalSprite",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GH=n_(MH.prototype,"_hoverSprite",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HH=n_(MH.prototype,"_pressedSprite",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kH=n_(MH.prototype,"_disabledSprite",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jH=n_(MH.prototype,"_duration",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),WH=n_(MH.prototype,"_zoomScale",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),qH=n_(MH.prototype,"_target",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RH=MH))||RH)||RH)||RH)||RH)||RH)||RH));(function(t){t[t.DEFAULT=0]="DEFAULT",t[t.DONE=1]="DONE",t[t.SEND=2]="SEND",t[t.SEARCH=3]="SEARCH",t[t.GO=4]="GO",t[t.NEXT=5]="NEXT"})(QH||(QH={})),Gt(QH),function(t){t[t.ANY=0]="ANY",t[t.EMAIL_ADDR=1]="EMAIL_ADDR",t[t.NUMERIC=2]="NUMERIC",t[t.PHONE_NUMBER=3]="PHONE_NUMBER",t[t.URL=4]="URL",t[t.DECIMAL=5]="DECIMAL",t[t.SINGLE_LINE=6]="SINGLE_LINE"}(tk||(tk={})),Gt(tk),function(t){t[t.PASSWORD=0]="PASSWORD",t[t.SENSITIVE=1]="SENSITIVE",t[t.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",t[t.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",t[t.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",t[t.DEFAULT=5]="DEFAULT"}(ek||(ek={})),Gt(ek);var nk,sk,rk,ok,ak,lk,ck,hk,_k,uk,mk,dk,pk,fk,gk,yk,vk,xk,Sk,Ak,Ck,bk,Tk,wk,Ek,Pk,Ik,Dk,Rk,Mk,Bk,Ok,Nk,Lk,Fk,zk,Vk,Uk,Gk,Hk,kk,jk,Wk,qk,Xk,Yk,Kk,Jk,$k,Zk,Qk,tj,ej,ij,nj,sj,rj,oj,aj,lj,cj;new Si,new Si,new oi,function(t){t.EDITING_DID_BEGAN="editing-did-began",t.EDITING_DID_ENDED="editing-did-ended",t.TEXT_CHANGED="text-changed",t.EDITING_RETURN="editing-return"}(cj||(cj={}));let hj=function(e){return t({EditBox:e,EditBoxComponent:e}),e}((nk=u_("cc.EditBox"),sk=T_(),rk=d_(110),ok=S_(),ak=m_(rB),lk=N_(),ck=I_(),hk=N_(),_k=I_(),uk=H_(UO),mk=N_(),dk=I_(),pk=H_(UO),fk=N_(),gk=I_(),yk=H_(zR),vk=N_(),xk=I_(),Sk=H_(ek),Ak=N_(),Ck=I_(),bk=H_(tk),Tk=N_(),wk=I_(),Ek=H_(QH),Pk=N_(),Ik=I_(),Dk=N_(),Rk=I_(),Mk=N_(),Bk=I_(),Ok=H_([Rw]),Nk=N_(),Lk=I_(),Fk=H_([Rw]),zk=N_(),Vk=I_(),Uk=H_([Rw]),Gk=N_(),Hk=I_(),kk=H_([Rw]),jk=N_(),Wk=I_(),nk(qk=sk(qk=rk(qk=ok(qk=ak(qk=x_((lj=aj=class t extends Nm{constructor(...t){super(...t),i_(this,"editingDidBegan",Yk,this),i_(this,"textChanged",Kk,this),i_(this,"editingDidEnded",Jk,this),i_(this,"editingReturn",$k,this),this._impl=null,this._background=null,i_(this,"_textLabel",Zk,this),i_(this,"_placeholderLabel",Qk,this),i_(this,"_returnType",tj,this),i_(this,"_string",ej,this),i_(this,"_tabIndex",ij,this),i_(this,"_backgroundImage",nj,this),i_(this,"_inputFlag",sj,this),i_(this,"_inputMode",rj,this),i_(this,"_maxLength",oj,this),this._isLabelVisible=!1}get string(){return this._string}set string(t){this._maxLength>=0&&t.length>=this._maxLength&&(t=t.slice(0,this._maxLength)),this._string=t,this._updateString(t)}get placeholder(){return this._placeholderLabel?this._placeholderLabel.string:""}set placeholder(t){this._placeholderLabel&&(this._placeholderLabel.string=t)}get textLabel(){return this._textLabel}set textLabel(t){this._textLabel!==t&&(this._textLabel=t,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}get placeholderLabel(){return this._placeholderLabel}set placeholderLabel(t){this._placeholderLabel!==t&&(this._placeholderLabel=t,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}get backgroundImage(){return this._backgroundImage}set backgroundImage(t){this._backgroundImage!==t&&(this._backgroundImage=t,this._createBackgroundSprite())}get inputFlag(){return this._inputFlag}set inputFlag(t){this._inputFlag=t,this._updateString(this._string)}get inputMode(){return this._inputMode}set inputMode(t){this._inputMode!==t&&(this._inputMode=t,this._updateTextLabel(),this._updatePlaceholderLabel())}get returnType(){return this._returnType}set returnType(t){this._returnType=t}get maxLength(){return this._maxLength}set maxLength(t){this._maxLength=t}get tabIndex(){return this._tabIndex}set tabIndex(t){this._tabIndex!==t&&(this._tabIndex=t,this._impl&&this._impl.setTabIndex(t))}__preload(){this._init()}onEnable(){this._registerEvent(),this._impl&&this._impl.onEnable()}update(){this._impl&&this._impl.update()}onDisable(){this._unregisterEvent(),this._impl&&this._impl.onDisable()}onDestroy(){this._impl&&this._impl.clear()}setFocus(){this._impl&&this._impl.setFocus(!0)}focus(){this._impl&&this._impl.setFocus(!0)}blur(){this._impl&&this._impl.setFocus(!1)}isFocused(){return!!this._impl&&this._impl.isFocused()}_editBoxEditingDidBegan(){Rw.emitEvents(this.editingDidBegan,this),this.node.emit(cj.EDITING_DID_BEGAN,this)}_editBoxEditingDidEnded(){Rw.emitEvents(this.editingDidEnded,this),this.node.emit(cj.EDITING_DID_ENDED,this)}_editBoxTextChanged(t){t=this._updateLabelStringStyle(t,!0),this.string=t,Rw.emitEvents(this.textChanged,t,this),this.node.emit(cj.TEXT_CHANGED,this)}_editBoxEditingReturn(){Rw.emitEvents(this.editingReturn,this),this.node.emit(cj.EDITING_RETURN,this)}_showLabels(){this._isLabelVisible=!0,this._updateLabels()}_hideLabels(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}_onTouchBegan(t){t.propagationStopped=!0}_onTouchCancel(t){t.propagationStopped=!0}_onTouchEnded(t){this._impl&&this._impl.beginEditing(),t.propagationStopped=!0}_init(){this._createBackgroundSprite(),this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(_p.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()}_createBackgroundSprite(){this._background||(this._background=this.node.getComponent(mF),this._background||(this._background=this.node.addComponent(mF))),this._background.type=mF.Type.SLICED,this._background.spriteFrame=this._backgroundImage}_updateTextLabel(){let t=this._textLabel;if(!t){let e=this.node.getChildByName("TEXT_LABEL");e||(e=new uf("TEXT_LABEL")),t=e.getComponent(UO),t||(t=e.addComponent(UO)),e.parent=this.node,this._textLabel=t}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=UO.Overflow.CLAMP,this._inputMode===tk.ANY?(t.verticalAlign=OO.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this._updateLabelStringStyle(this._string)}_updatePlaceholderLabel(){let t=this._placeholderLabel;if(!t){let e=this.node.getChildByName("PLACEHOLDER_LABEL");e||(e=new uf("PLACEHOLDER_LABEL")),t=e.getComponent(UO),t||(t=e.addComponent(UO)),e.parent=this.node,this._placeholderLabel=t}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=UO.Overflow.CLAMP,this._inputMode===tk.ANY?(t.verticalAlign=OO.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this.placeholder}_syncSize(){const t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(this._background){const i=this._background.node._uiProps.uiTransformComp;i.anchorPoint=t.anchorPoint,i.setContentSize(e)}this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)}_updateLabels(){if(this._isLabelVisible){const t=this._string;this._textLabel&&(this._textLabel.node.active=""!==t),this._placeholderLabel&&(this._placeholderLabel.node.active=""===t)}}_updateString(t){const e=this._textLabel;if(!e)return;let i=t;i&&(i=this._updateLabelStringStyle(i)),e.string=i,this._updateLabels()}_updateLabelStringStyle(t,e=!1){const i=this._inputFlag;if(e||i!==ek.PASSWORD)i===ek.INITIAL_CAPS_ALL_CHARACTERS?t=t.toUpperCase():i===ek.INITIAL_CAPS_WORD?t=t.replace(/(?:^|\s)\S/g,(t=>t.toUpperCase())):i===ek.INITIAL_CAPS_SENTENCE&&(t=(n=t).charAt(0).toUpperCase()+n.slice(1));else{let e="";const i=t.length;for(let t=0;t<i;++t)e+="●";t=e}var n;return t}_registerEvent(){this.node.on(_p.TOUCH_START,this._onTouchBegan,this),this.node.on(_p.TOUCH_END,this._onTouchEnded,this)}_unregisterEvent(){this.node.off(_p.TOUCH_START,this._onTouchBegan,this),this.node.off(_p.TOUCH_END,this._onTouchEnded,this)}_updateLabelPosition(t){const e=this.node._uiProps.uiTransformComp,i=-e.anchorX*e.width,n=-e.anchorY*e.height,s=this._placeholderLabel,r=this._textLabel;r&&(r.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),r.node.setPosition(i+2,n+t.height,r.node.position.z),this._inputMode===tk.ANY&&(r.verticalAlign=OO.TOP),r.enableWrapText=this._inputMode===tk.ANY),s&&(s.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),s.lineHeight=t.height,s.node.setPosition(i+2,n+t.height,s.node.position.z),this._inputMode===tk.ANY&&(s.verticalAlign=OO.TOP),s.enableWrapText=this._inputMode===tk.ANY)}_resizeChildNodes(){const t=this.node._uiProps.uiTransformComp,e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-t.width/2,t.height/2,e.position.z),e._uiProps.uiTransformComp.setContentSize(t.contentSize));const i=this._placeholderLabel&&this._placeholderLabel.node;i&&(i.setPosition(-t.width/2,t.height/2,i.position.z),i._uiProps.uiTransformComp.setContentSize(t.contentSize));const n=this._background&&this._background.node;n&&n._uiProps.uiTransformComp.setContentSize(t.contentSize)}},aj._EditBoxImpl=class{constructor(){this._editing=!1,this._delegate=null}init(t){}onEnable(){}update(){}onDisable(){this._editing&&this.endEditing()}clear(){this._delegate=null}setTabIndex(t){}setSize(t,e){}setFocus(t){t?this.beginEditing():this.endEditing()}isFocused(){return this._editing}beginEditing(){}endEditing(){}},aj.KeyboardReturnType=QH,aj.InputFlag=ek,aj.InputMode=tk,aj.EventType=cj,n_((Xk=lj).prototype,"string",[lk,ck],Object.getOwnPropertyDescriptor(Xk.prototype,"string"),Xk.prototype),n_(Xk.prototype,"placeholder",[hk,_k],Object.getOwnPropertyDescriptor(Xk.prototype,"placeholder"),Xk.prototype),n_(Xk.prototype,"textLabel",[uk,mk,dk],Object.getOwnPropertyDescriptor(Xk.prototype,"textLabel"),Xk.prototype),n_(Xk.prototype,"placeholderLabel",[pk,fk,gk],Object.getOwnPropertyDescriptor(Xk.prototype,"placeholderLabel"),Xk.prototype),n_(Xk.prototype,"backgroundImage",[yk,vk,xk],Object.getOwnPropertyDescriptor(Xk.prototype,"backgroundImage"),Xk.prototype),n_(Xk.prototype,"inputFlag",[Sk,Ak,Ck],Object.getOwnPropertyDescriptor(Xk.prototype,"inputFlag"),Xk.prototype),n_(Xk.prototype,"inputMode",[bk,Tk,wk],Object.getOwnPropertyDescriptor(Xk.prototype,"inputMode"),Xk.prototype),n_(Xk.prototype,"returnType",[Ek,Pk,Ik],Object.getOwnPropertyDescriptor(Xk.prototype,"returnType"),Xk.prototype),n_(Xk.prototype,"maxLength",[Dk,Rk],Object.getOwnPropertyDescriptor(Xk.prototype,"maxLength"),Xk.prototype),n_(Xk.prototype,"tabIndex",[Mk,Bk],Object.getOwnPropertyDescriptor(Xk.prototype,"tabIndex"),Xk.prototype),Yk=n_(Xk.prototype,"editingDidBegan",[Ok,g_,Nk,Lk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kk=n_(Xk.prototype,"textChanged",[Fk,g_,zk,Vk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jk=n_(Xk.prototype,"editingDidEnded",[Uk,g_,Gk,Hk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$k=n_(Xk.prototype,"editingReturn",[kk,g_,jk,Wk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zk=n_(Xk.prototype,"_textLabel",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qk=n_(Xk.prototype,"_placeholderLabel",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tj=n_(Xk.prototype,"_returnType",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return QH.DEFAULT}}),ej=n_(Xk.prototype,"_string",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ij=n_(Xk.prototype,"_tabIndex",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nj=n_(Xk.prototype,"_backgroundImage",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sj=n_(Xk.prototype,"_inputFlag",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ek.DEFAULT}}),rj=n_(Xk.prototype,"_inputMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tk.ANY}}),oj=n_(Xk.prototype,"_maxLength",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),qk=Xk))||qk)||qk)||qk)||qk)||qk)||qk));var _j,uj,mj,dj,pj,fj,gj,yj,vj,xj,Sj,Aj,Cj,bj,Tj,wj,Ej,Pj,Ij,Dj,Rj,Mj,Bj,Oj,Nj,Lj,Fj,zj,Vj,Uj,Gj,Hj,kj,jj,Wj,qj,Xj,Yj,Kj,Jj,$j,Zj,Qj,tW,eW,iW,nW,sW,rW,oW,aW,lW,cW,hW;const _W=_p;var uW,mW,dW,pW,fW,gW;!function(t){t[t.NONE=0]="NONE",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.GRID=3]="GRID"}(uW||(uW={})),jt(uW),function(t){t[t.NONE=0]="NONE",t[t.CONTAINER=1]="CONTAINER",t[t.CHILDREN=2]="CHILDREN"}(mW||(mW={})),jt(mW),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(dW||(dW={})),jt(dW),function(t){t[t.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",t[t.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(pW||(pW={})),jt(pW),function(t){t[t.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",t[t.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(fW||(fW={})),jt(fW),function(t){t[t.NONE=0]="NONE",t[t.FIXED_ROW=1]="FIXED_ROW",t[t.FIXED_COL=2]="FIXED_COL"}(gW||(gW={})),jt(gW);const yW=new oi;let vW=function(e){return t({Layout:e,LayoutComponent:e}),e}((_j=u_("cc.Layout"),uj=T_(),mj=d_(110),dj=S_(),pj=m_(rB),fj=E_(),gj=I_(),yj=E_(),vj=I_(),xj=H_(uW),Sj=I_(),Aj=H_(mW),Cj=E_(),bj=I_(),Tj=E_(),wj=I_(),Ej=H_(dW),Pj=I_(),Ij=I_(),Dj=I_(),Rj=I_(),Mj=I_(),Bj=I_(),Oj=I_(),Nj=H_(pW),Lj=I_(),Fj=H_(fW),zj=I_(),Vj=H_(gW),Uj=E_(),Gj=I_(),Hj=E_(),kj=I_(),jj=I_(),_j(Wj=uj(Wj=mj(Wj=dj(Wj=pj(Wj=x_((hW=cW=class extends Nm{constructor(...t){super(...t),i_(this,"_resizeMode",Xj,this),i_(this,"_layoutType",Yj,this),i_(this,"_cellSize",Kj,this),i_(this,"_startAxis",Jj,this),i_(this,"_paddingLeft",$j,this),i_(this,"_paddingRight",Zj,this),i_(this,"_paddingTop",Qj,this),i_(this,"_paddingBottom",tW,this),i_(this,"_spacingX",eW,this),i_(this,"_spacingY",iW,this),i_(this,"_verticalDirection",nW,this),i_(this,"_horizontalDirection",sW,this),i_(this,"_constraint",rW,this),i_(this,"_constraintNum",oW,this),i_(this,"_affectedByScale",aW,this),i_(this,"_isAlign",lW,this),this._layoutSize=new Mi(300,200),this._layoutDirty=!0,this._childrenDirty=!1,this._usefulLayoutObj=[],this._init=!1}get alignHorizontal(){return this._isAlign}set alignHorizontal(t){this._layoutType===uW.HORIZONTAL&&(this._isAlign=t,this._doLayoutDirty())}get alignVertical(){return this._isAlign}set alignVertical(t){this._layoutType===uW.VERTICAL&&(this._isAlign=t,this._doLayoutDirty())}get type(){return this._layoutType}set type(t){this._layoutType=t,this._doLayoutDirty()}get resizeMode(){return this._resizeMode}set resizeMode(t){this._layoutType!==uW.NONE&&(this._resizeMode=t,this._doLayoutDirty())}get cellSize(){return this._cellSize}set cellSize(t){this._cellSize!==t&&(this._cellSize.set(t),this._doLayoutDirty())}get startAxis(){return this._startAxis}set startAxis(t){this._startAxis!==t&&(this._startAxis=t,this._doLayoutDirty())}get paddingLeft(){return this._paddingLeft}set paddingLeft(t){this._paddingLeft!==t&&(this._paddingLeft=t,this._doLayoutDirty())}get paddingRight(){return this._paddingRight}set paddingRight(t){this._paddingRight!==t&&(this._paddingRight=t,this._doLayoutDirty())}get paddingTop(){return this._paddingTop}set paddingTop(t){this._paddingTop!==t&&(this._paddingTop=t,this._doLayoutDirty())}get paddingBottom(){return this._paddingBottom}set paddingBottom(t){this._paddingBottom!==t&&(this._paddingBottom=t,this._doLayoutDirty())}get spacingX(){return this._spacingX}set spacingX(t){this._spacingX!==t&&(this._spacingX=t,this._doLayoutDirty())}get spacingY(){return this._spacingY}set spacingY(t){this._spacingY!==t&&(this._spacingY=t,this._doLayoutDirty())}get verticalDirection(){return this._verticalDirection}set verticalDirection(t){this._verticalDirection!==t&&(this._verticalDirection=t,this._doLayoutDirty())}get horizontalDirection(){return this._horizontalDirection}set horizontalDirection(t){this._horizontalDirection!==t&&(this._horizontalDirection=t,this._doLayoutDirty())}get padding(){return this._paddingLeft}set padding(t){this.paddingLeft===t&&this._paddingRight===t&&this._paddingTop===t&&this._paddingBottom===t||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=t,this._doLayoutDirty())}get constraint(){return this._constraint}set constraint(t){this._layoutType!==uW.NONE&&this._constraint!==t&&(this._constraint=t,this._doLayoutDirty())}get constraintNum(){return this._constraintNum}set constraintNum(t){this._constraint!==gW.NONE&&this._constraintNum!==t&&(t<=0&&m("Limit values to be greater than 0"),this._constraintNum=t,this._doLayoutDirty())}get affectedByScale(){return this._affectedByScale}set affectedByScale(t){this._affectedByScale=t,this._doLayoutDirty()}updateLayout(t=!1){(this._layoutDirty||t)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)}onEnable(){this._addEventListeners();const t=this.node._uiProps.uiTransformComp;t.contentSize.equals(Mi.ZERO)&&t.setContentSize(this._layoutSize),this._childrenChanged()}onDisable(){this._usefulLayoutObj.length=0,this._removeEventListeners()}_checkUsefulObj(){this._usefulLayoutObj.length=0;const t=this.node.children;for(let e=0;e<t.length;++e){const i=t[e],n=i._uiProps.uiTransformComp;i.activeInHierarchy&&n&&this._usefulLayoutObj.push(n)}}_addEventListeners(){aT.on(oT.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(_W.SIZE_CHANGED,this._resized,this),this.node.on(_W.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(_W.CHILD_ADDED,this._childAdded,this),this.node.on(_W.CHILD_REMOVED,this._childRemoved,this),this.node.on(_W.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()}_removeEventListeners(){aT.off(oT.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(_W.SIZE_CHANGED,this._resized,this),this.node.off(_W.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(_W.CHILD_ADDED,this._childAdded,this),this.node.off(_W.CHILD_REMOVED,this._childRemoved,this),this.node.off(_W.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()}_addChildrenEventListeners(){const t=this.node.children;for(let e=0;e<t.length;++e){const i=t[e];i.on(_W.SIZE_CHANGED,this._doLayoutDirty,this),i.on(_W.TRANSFORM_CHANGED,this._transformDirty,this),i.on(_W.ANCHOR_CHANGED,this._doLayoutDirty,this),i.on("active-in-hierarchy-changed",this._childrenChanged,this)}}_removeChildrenEventListeners(){const t=this.node.children;for(let e=0;e<t.length;++e){const i=t[e];i.off(_W.SIZE_CHANGED,this._doLayoutDirty,this),i.off(_W.TRANSFORM_CHANGED,this._transformDirty,this),i.off(_W.ANCHOR_CHANGED,this._doLayoutDirty,this),i.off("active-in-hierarchy-changed",this._childrenChanged,this)}}_childAdded(t){t.on(_W.SIZE_CHANGED,this._doLayoutDirty,this),t.on(_W.TRANSFORM_CHANGED,this._transformDirty,this),t.on(_W.ANCHOR_CHANGED,this._doLayoutDirty,this),t.on("active-in-hierarchy-changed",this._childrenChanged,this),this._childrenChanged()}_childRemoved(t){t.off(_W.SIZE_CHANGED,this._doLayoutDirty,this),t.off(_W.TRANSFORM_CHANGED,this._transformDirty,this),t.off(_W.ANCHOR_CHANGED,this._doLayoutDirty,this),t.off("active-in-hierarchy-changed",this._childrenChanged,this),this._childrenChanged()}_resized(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()}_doLayoutHorizontally(t,e,i,n){const s=this.node._uiProps.uiTransformComp.anchorPoint,r=this._getFixedBreakingNum();let o=1,a=this._paddingLeft;this._horizontalDirection===fW.RIGHT_TO_LEFT&&(o=-1,a=this._paddingRight);const l=(this._horizontalDirection-s.x)*t+o*a;let c=l-o*this._spacingX,h=0,_=0,u=0,m=0,d=!1;const p=this._usefulLayoutObj.length;let f=this._cellSize.width;const g=this._getPaddingH();this._layoutType!==uW.GRID&&this._resizeMode===mW.CHILDREN&&(f=(t-g-(p-1)*this._spacingX)/p);const y=this._usefulLayoutObj;for(let a=0;a<y.length;++a){const p=y[a],v=p.node,x=v.scale,S=this._getUsedScaleValue(x.x),A=this._getUsedScaleValue(x.y);this._resizeMode===mW.CHILDREN&&(p.width=f/S,this._layoutType===uW.GRID&&(p.height=this._cellSize.height/A));const C=Math.abs(this._horizontalDirection-p.anchorX),b=p.width*S,T=p.height*A;T>u&&(m=Math.max(u,m),_=u||T,u=T),c+=o*(C*b+this._spacingX);const w=o*(1-C)*b;if(e){if(r>0)d=a/r>0&&a%r==0,d&&(_=u>T?u:_);else if(b>t-g)c>l+o*C*b&&(d=!0);else{const e=(1-this._horizontalDirection-s.x)*t,i=c+w+o*(o>0?this._paddingRight:this._paddingLeft);d=Math.abs(i)>Math.abs(e)}d&&(c=l+o*C*b,T!==u&&(_=u),h+=_+this._spacingY,_=u=T)}const E=i(v,p,h);n&&v.setPosition(c,E),c+=w}return _=Math.max(_,u),Math.max(m,h+_)+this._getPaddingV()}_doLayoutVertically(t,e,i,n){const s=this.node._uiProps.uiTransformComp.anchorPoint,r=this._getFixedBreakingNum();let o=1,a=this._paddingBottom;this._verticalDirection===pW.TOP_TO_BOTTOM&&(o=-1,a=this._paddingTop);const l=(this._verticalDirection-s.y)*t+o*a;let c=l-o*this._spacingY,h=0,_=0,u=0,m=0,d=!1;const p=this._usefulLayoutObj.length;let f=this._cellSize.height;const g=this._getPaddingV();this._layoutType!==uW.GRID&&this._resizeMode===mW.CHILDREN&&(f=(t-g-(p-1)*this._spacingY)/p);const y=this._usefulLayoutObj;for(let a=0;a<y.length;++a){const p=y[a],v=p.node,x=v.scale,S=this._getUsedScaleValue(x.x),A=this._getUsedScaleValue(x.y);this._resizeMode===mW.CHILDREN&&(p.height=f/A,this._layoutType===uW.GRID&&(p.width=this._cellSize.width/S));const C=Math.abs(this._verticalDirection-p.anchorY),b=p.width*S,T=p.height*A;b>h&&(_=Math.max(h,_),u=h||b,h=b),c+=o*(C*T+this._spacingY);const w=o*(1-C)*T;if(e){if(r>0)d=a/r>0&&a%r==0,d&&(u=h>T?h:u);else if(T>t-g)c>l+o*C*T&&(d=!0);else{const e=(1-this._verticalDirection-s.y)*t,i=c+w+o*(o>0?this._paddingTop:this._paddingBottom);d=Math.abs(i)>Math.abs(e)}d&&(c=l+o*C*T,b!==h&&(u=h),m+=u+this._spacingX,u=h=b)}const E=i(v,p,m);n&&(v.getPosition(yW),v.setPosition(E,c,yW.z)),c+=w}return u=Math.max(u,h),Math.max(_,m+u)+this._getPaddingH()}_doLayoutGridAxisHorizontal(t,e){const i=e.width;let n=1,s=-t.y*e.height,r=this._paddingBottom;this._verticalDirection===pW.TOP_TO_BOTTOM&&(n=-1,s=(1-t.y)*e.height,r=this._paddingTop);const o=(t,e,i)=>s+n*(i+(1-e.anchorY)*e.height*this._getUsedScaleValue(t.scale.y)+r);let a=0;this._resizeMode===mW.CONTAINER&&(a=this._doLayoutHorizontally(i,!0,o,!1),s=-t.y*a,this._verticalDirection===pW.TOP_TO_BOTTOM&&(n=-1,s=(1-t.y)*a)),this._doLayoutHorizontally(i,!0,o,!0),this._resizeMode===mW.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,a)}_doLayoutGridAxisVertical(t,e){const i=e.height;let n=1,s=-t.x*e.width,r=this._paddingLeft;this._horizontalDirection===fW.RIGHT_TO_LEFT&&(n=-1,s=(1-t.x)*e.width,r=this._paddingRight);const o=(t,e,i)=>s+n*(i+(1-e.anchorX)*e.width*this._getUsedScaleValue(t.scale.x)+r);let a=0;this._resizeMode===mW.CONTAINER&&(a=this._doLayoutVertically(i,!0,o,!1),s=-t.x*a,this._horizontalDirection===fW.RIGHT_TO_LEFT&&(n=-1,s=(1-t.x)*a)),this._doLayoutVertically(i,!0,o,!0),this._resizeMode===mW.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(a,i)}_doLayoutGrid(){const t=this.node._uiProps.uiTransformComp,e=t.anchorPoint,i=t.contentSize;this.startAxis===dW.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,i):this.startAxis===dW.VERTICAL&&this._doLayoutGridAxisVertical(e,i)}_getHorizontalBaseWidth(t=!0){const e=this._usefulLayoutObj;let i=0;const n=e.length;if(this._resizeMode===mW.CONTAINER){for(let t=0;t<e.length;++t){const n=e[t],s=n.node.scale;i+=n.width*this._getUsedScaleValue(s.x)}i+=(n-1)*this._spacingX+this._getPaddingH()}else i=this.node._uiProps.uiTransformComp.width;return i}_getVerticalBaseHeight(){const t=this._usefulLayoutObj;let e=0;const i=t.length;if(this._resizeMode===mW.CONTAINER){for(let i=0;i<t.length;++i){const n=t[i],s=n.node.scale;e+=n.height*this._getUsedScaleValue(s.y)}e+=(i-1)*this._spacingY+this._getPaddingV()}else e=this.node._uiProps.uiTransformComp.height;return e}_doLayout(){if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===uW.HORIZONTAL){const t=this._getHorizontalBaseWidth(),e=t=>(this._isAlign?oi.ZERO:t.position).y;this._doLayoutHorizontally(t,!1,e,!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===uW.VERTICAL){const t=this._getVerticalBaseHeight(),e=t=>(this._isAlign?oi.ZERO:t.position).x;this._doLayoutVertically(t,!1,e,!0),this.node._uiProps.uiTransformComp.height=t}else this._layoutType===uW.GRID&&this._doLayoutGrid()}_getUsedScaleValue(t){return this._affectedByScale?Math.abs(t):1}_transformDirty(t){t&t_.SCALE&&t&t_.POSITION&&this._affectedByScale&&this._doLayoutDirty()}_doLayoutDirty(){this._layoutDirty=!0}_childrenChanged(){this._childrenDirty=!0,this._doLayoutDirty()}_getPaddingH(){return this._paddingLeft+this._paddingRight}_getPaddingV(){return this._paddingTop+this._paddingBottom}_getFixedBreakingNum(){if(this._layoutType!==uW.GRID||this._constraint===gW.NONE||this._constraintNum<=0)return 0;let t=this._constraint===gW.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===dW.VERTICAL&&(t=this._constraint===gW.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),t}},cW.Type=uW,cW.VerticalDirection=pW,cW.HorizontalDirection=fW,cW.ResizeMode=mW,cW.AxisDirection=dW,cW.Constraint=gW,n_((qj=hW).prototype,"alignHorizontal",[fj,gj],Object.getOwnPropertyDescriptor(qj.prototype,"alignHorizontal"),qj.prototype),n_(qj.prototype,"alignVertical",[yj,vj],Object.getOwnPropertyDescriptor(qj.prototype,"alignVertical"),qj.prototype),n_(qj.prototype,"type",[xj,Sj],Object.getOwnPropertyDescriptor(qj.prototype,"type"),qj.prototype),n_(qj.prototype,"resizeMode",[Aj,Cj,bj],Object.getOwnPropertyDescriptor(qj.prototype,"resizeMode"),qj.prototype),n_(qj.prototype,"cellSize",[Tj,wj],Object.getOwnPropertyDescriptor(qj.prototype,"cellSize"),qj.prototype),n_(qj.prototype,"startAxis",[Ej,Pj],Object.getOwnPropertyDescriptor(qj.prototype,"startAxis"),qj.prototype),n_(qj.prototype,"paddingLeft",[Ij],Object.getOwnPropertyDescriptor(qj.prototype,"paddingLeft"),qj.prototype),n_(qj.prototype,"paddingRight",[Dj],Object.getOwnPropertyDescriptor(qj.prototype,"paddingRight"),qj.prototype),n_(qj.prototype,"paddingTop",[Rj],Object.getOwnPropertyDescriptor(qj.prototype,"paddingTop"),qj.prototype),n_(qj.prototype,"paddingBottom",[Mj],Object.getOwnPropertyDescriptor(qj.prototype,"paddingBottom"),qj.prototype),n_(qj.prototype,"spacingX",[Bj],Object.getOwnPropertyDescriptor(qj.prototype,"spacingX"),qj.prototype),n_(qj.prototype,"spacingY",[Oj],Object.getOwnPropertyDescriptor(qj.prototype,"spacingY"),qj.prototype),n_(qj.prototype,"verticalDirection",[Nj,Lj],Object.getOwnPropertyDescriptor(qj.prototype,"verticalDirection"),qj.prototype),n_(qj.prototype,"horizontalDirection",[Fj,zj],Object.getOwnPropertyDescriptor(qj.prototype,"horizontalDirection"),qj.prototype),n_(qj.prototype,"constraint",[Vj,Uj,Gj],Object.getOwnPropertyDescriptor(qj.prototype,"constraint"),qj.prototype),n_(qj.prototype,"constraintNum",[Hj,kj],Object.getOwnPropertyDescriptor(qj.prototype,"constraintNum"),qj.prototype),n_(qj.prototype,"affectedByScale",[jj],Object.getOwnPropertyDescriptor(qj.prototype,"affectedByScale"),qj.prototype),Xj=n_(qj.prototype,"_resizeMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mW.NONE}}),Yj=n_(qj.prototype,"_layoutType",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uW.NONE}}),Kj=n_(qj.prototype,"_cellSize",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(40,40)}}),Jj=n_(qj.prototype,"_startAxis",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dW.HORIZONTAL}}),$j=n_(qj.prototype,"_paddingLeft",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zj=n_(qj.prototype,"_paddingRight",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qj=n_(qj.prototype,"_paddingTop",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tW=n_(qj.prototype,"_paddingBottom",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eW=n_(qj.prototype,"_spacingX",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iW=n_(qj.prototype,"_spacingY",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nW=n_(qj.prototype,"_verticalDirection",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pW.TOP_TO_BOTTOM}}),sW=n_(qj.prototype,"_horizontalDirection",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fW.LEFT_TO_RIGHT}}),rW=n_(qj.prototype,"_constraint",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gW.NONE}}),oW=n_(qj.prototype,"_constraintNum",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),aW=n_(qj.prototype,"_affectedByScale",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lW=n_(qj.prototype,"_isAlign",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wj=qj))||Wj)||Wj)||Wj)||Wj)||Wj)||Wj));var xW,SW,AW,CW,bW,TW,wW,EW,PW,IW,DW,RW,MW,BW,OW,NW,LW,FW,zW,VW,UW,GW,HW;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.FILLED=2]="FILLED"}(HW||(HW={})),Gt(HW);let kW=function(e){return t({ProgressBar:e,ProgressBarComponent:e}),e}((xW=u_("cc.ProgressBar"),SW=T_(),AW=d_(110),CW=S_(),bW=m_(rB),TW=H_(mF),wW=I_(),EW=H_(HW),PW=I_(),IW=I_(),DW=D_(),RW=I_(),MW=I_(),xW(BW=SW(BW=AW(BW=CW(BW=bW((GW=UW=class extends Nm{constructor(...t){super(...t),i_(this,"_barSprite",NW,this),i_(this,"_mode",LW,this),i_(this,"_totalLength",FW,this),i_(this,"_progress",zW,this),i_(this,"_reverse",VW,this)}get barSprite(){return this._barSprite}set barSprite(t){this._barSprite!==t&&(this._barSprite=t,this._initBarSprite())}get mode(){return this._mode}set mode(t){if(this._mode!==t&&(this._mode=t,this._barSprite)){const t=this._barSprite.node;if(!t)return;const e=t._uiProps.uiTransformComp.contentSize;this._mode===HW.HORIZONTAL?this.totalLength=e.width:this._mode===HW.VERTICAL?this.totalLength=e.height:this._mode===HW.FILLED&&(this.totalLength=this._barSprite.fillRange)}}get totalLength(){return this._totalLength}set totalLength(t){this._mode===HW.FILLED&&(t=Ge(t)),this._totalLength=t,this._updateBarStatus()}get progress(){return this._progress}set progress(t){this._progress!==t&&(this._progress=t,this._updateBarStatus())}get reverse(){return this._reverse}set reverse(t){this._reverse!==t&&(this._reverse=t,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}_initBarSprite(){if(this._barSprite){const t=this._barSprite.node;if(!t)return;const e=this.node._uiProps.uiTransformComp,i=e.contentSize,n=e.anchorPoint,s=t._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===mF.FillType.RADIAL&&(this._mode=HW.FILLED),this._mode===HW.HORIZONTAL?this.totalLength=s.width:this._mode===HW.VERTICAL?this.totalLength=s.height:this.totalLength=this._barSprite.fillRange,t.parent===this.node){const e=-i.width*n.x;t.setPosition(e,0,0)}}}_updateBarStatus(){if(this._barSprite){const t=this._barSprite.node;if(!t)return;const e=t._uiProps.uiTransformComp,i=e.anchorPoint,n=e.contentSize,s=t.getPosition();let r=new Ti(0,.5);const o=Ge(this._progress);let a=this._totalLength*o,l=n,c=0,h=0;switch(this._mode){case HW.HORIZONTAL:this._reverse&&(r=new Ti(1,.5)),l=new Mi(a,n.height),c=this._totalLength,h=n.height;break;case HW.VERTICAL:r=this._reverse?new Ti(.5,1):new Ti(.5,0),l=new Mi(n.width,a),c=n.width,h=this._totalLength}if(this._mode===HW.FILLED)this._barSprite.type!==mF.Type.FILLED?m("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(a*=-1),this._barSprite.fillRange=a);else if(this._barSprite.type!==mF.Type.FILLED){const n=r.x-i.x,o=r.y-i.y,a=new oi(c*n,h*o,0);t.setPosition(s.x+a.x,s.y+a.y,s.z),e.setAnchorPoint(r),e.setContentSize(l)}else m("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},UW.Mode=HW,n_((OW=GW).prototype,"barSprite",[TW,wW],Object.getOwnPropertyDescriptor(OW.prototype,"barSprite"),OW.prototype),n_(OW.prototype,"mode",[EW,PW],Object.getOwnPropertyDescriptor(OW.prototype,"mode"),OW.prototype),n_(OW.prototype,"totalLength",[IW],Object.getOwnPropertyDescriptor(OW.prototype,"totalLength"),OW.prototype),n_(OW.prototype,"progress",[DW,O_,RW],Object.getOwnPropertyDescriptor(OW.prototype,"progress"),OW.prototype),n_(OW.prototype,"reverse",[MW],Object.getOwnPropertyDescriptor(OW.prototype,"reverse"),OW.prototype),NW=n_(OW.prototype,"_barSprite",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LW=n_(OW.prototype,"_mode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HW.HORIZONTAL}}),FW=n_(OW.prototype,"_totalLength",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),zW=n_(OW.prototype,"_progress",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),VW=n_(OW.prototype,"_reverse",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BW=OW))||BW)||BW)||BW)||BW)||BW));var jW,WW,qW,XW,YW,KW,JW,$W,ZW,QW,tq,eq,iq,nq,sq,rq,oq,aq,lq,cq,hq,_q,uq,mq;const dq=new oi,pq=new oi,fq=new oi,gq=new Ti,yq=new si,vq=new Ti;var xq;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(xq||(xq={})),jt(xq);let Sq=function(e){return t({ScrollBar:e,ScrollBarComponent:e}),e}((jW=u_("cc.ScrollBar"),WW=T_(),qW=d_(110),XW=S_(),YW=m_(rB),KW=H_(mF),JW=N_(),$W=I_(),ZW=H_(xq),QW=N_(),tq=I_(),eq=N_(),iq=I_(),nq=N_(),sq=I_(),jW(rq=WW(rq=qW(rq=XW(rq=YW((mq=uq=class extends Nm{constructor(...t){super(...t),i_(this,"_scrollView",aq,this),i_(this,"_handle",lq,this),i_(this,"_direction",cq,this),i_(this,"_enableAutoHide",hq,this),i_(this,"_autoHideTime",_q,this),this._touching=!1,this._opacity=255,this._autoHideRemainingTime=0}get handle(){return this._handle}set handle(t){this._handle!==t&&(this._handle=t,this.onScroll(Ti.ZERO))}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this.onScroll(Ti.ZERO))}get enableAutoHide(){return this._enableAutoHide}set enableAutoHide(t){this._enableAutoHide!==t&&(this._enableAutoHide=t,this._enableAutoHide&&this._setOpacity(0))}get autoHideTime(){return this._autoHideTime}set autoHideTime(t){this._autoHideTime!==t&&(this._autoHideTime=t)}hide(){this._autoHideRemainingTime=0,this._setOpacity(0)}show(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}onScroll(t){if(!this._scrollView)return;const e=this._scrollView.content;if(!e)return;const i=e._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize,s=this.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(i,n))return;this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));let r=0,o=0,a=0,l=0,c=0;const h=vq;h.set(0,0),this._direction===xq.HORIZONTAL?(r=i.width,o=n.width,c=s.width,a=t.x,this._convertToScrollViewSpace(h,e),l=-h.x):this._direction===xq.VERTICAL&&(r=i.height,o=n.height,c=s.height,a=t.y,this._convertToScrollViewSpace(h,e),l=-h.y);const _=this._calculateLength(r,o,c,a),u=vq;this._calculatePosition(u,r,o,c,l,a,_),this._updateLength(_),this._updateHandlerPosition(u)}setScrollView(t){this._scrollView=t}onTouchBegan(){this._enableAutoHide&&(this._touching=!0)}onTouchEnded(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){const t=this._scrollView.content;if(t){const e=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(e,i))return}}this._autoHideRemainingTime=this._autoHideTime}}onEnable(){const t=this.node.getComponent(mF);t&&(this._opacity=t.color.a)}start(){this._enableAutoHide&&this._setOpacity(0)}update(t){this._processAutoHide(t)}_convertToScrollViewSpace(t,e){const i=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,n=e._uiProps.uiTransformComp;if(i&&n){dq.set(-n.anchorX*n.width,-n.anchorY*n.height,0),n.convertToWorldSpaceAR(dq,pq);const e=i.convertToNodeSpaceAR(pq);e.x+=i.anchorX*i.width,e.y+=i.anchorY*i.height,t.set(e.x,e.y)}else t.set(Ti.ZERO)}_setOpacity(t){if(this._handle){let e=this.node.getComponent(mF);e&&(yq.set(e.color),yq.a=t,e.color=yq),e=this._handle.getComponent(mF),e&&(yq.set(e.color),yq.a=t,e.color=yq)}}_updateHandlerPosition(t){if(this._handle){const e=fq;this._fixupHandlerPosition(e),this._handle.node.setPosition(t.x+e.x,t.y+e.y,e.z)}}_fixupHandlerPosition(t){const e=this.node._uiProps.uiTransformComp,i=e.contentSize,n=e.anchorPoint,s=this.handle.node._uiProps.uiTransformComp.contentSize,r=this.handle.node.parent;oi.set(dq,-i.width*n.x,-i.height*n.y,0);const o=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(dq,pq),a=t;a.set(0,0,0),r._uiProps.uiTransformComp.convertToNodeSpaceAR(o,a),this.direction===xq.HORIZONTAL?a.set(a.x,a.y+(i.height-s.height)/2,a.z):this.direction===xq.VERTICAL&&a.set(a.x+(i.width-s.width)/2,a.y,a.z),this.handle.node.setPosition(a)}_conditionalDisableScrollBar(t,e){return t.width<=e.width&&this._direction===xq.HORIZONTAL||t.height<=e.height&&this._direction===xq.VERTICAL}_calculateLength(t,e,i,n){let s=t;return n&&(s+=20*(n>0?n:-n)),i*(e/s)}_calculatePosition(t,e,i,n,s,r,o){let a=e-i;r&&(a+=Math.abs(r));let l=0;a&&(l=s/a,l=Ge(l));const c=(n-o)*l;this._direction===xq.VERTICAL?t.set(0,c):t.set(c,0)}_updateLength(t){if(this._handle){const e=this._handle.node._uiProps.uiTransformComp,i=e.contentSize,n=e.anchorPoint;n.x===gq.x&&n.y===gq.y||e.setAnchorPoint(gq),this._direction===xq.HORIZONTAL?e.setContentSize(t,i.height):e.setContentSize(i.width,t)}}_processAutoHide(t){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=t,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);const t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},uq.Direction=xq,n_((oq=mq).prototype,"handle",[KW,JW,$W],Object.getOwnPropertyDescriptor(oq.prototype,"handle"),oq.prototype),n_(oq.prototype,"direction",[ZW,QW,tq],Object.getOwnPropertyDescriptor(oq.prototype,"direction"),oq.prototype),n_(oq.prototype,"enableAutoHide",[eq,iq],Object.getOwnPropertyDescriptor(oq.prototype,"enableAutoHide"),oq.prototype),n_(oq.prototype,"autoHideTime",[nq,sq],Object.getOwnPropertyDescriptor(oq.prototype,"autoHideTime"),oq.prototype),aq=n_(oq.prototype,"_scrollView",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lq=n_(oq.prototype,"_handle",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cq=n_(oq.prototype,"_direction",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xq.HORIZONTAL}}),hq=n_(oq.prototype,"_enableAutoHide",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_q=n_(oq.prototype,"_autoHideTime",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),rq=oq))||rq)||rq)||rq)||rq)||rq));var Aq;let Cq=t("ViewGroup",u_("cc.ViewGroup")(Aq=d_(110)(Aq=class extends Nm{})||Aq)||Aq);var bq,Tq,wq,Eq,Pq,Iq,Dq,Rq,Mq,Bq,Oq,Nq,Lq,Fq,zq,Vq,Uq,Gq,Hq,kq,jq,Wq,qq,Xq,Yq,Kq,Jq,$q,Zq,Qq,tX,eX,iX,nX,sX,rX,oX,aX,lX,cX,hX,_X,uX,mX,dX,pX,fX,gX;n.ViewGroup=Cq;const yX=1e-4,vX=new oi,xX=new oi,SX=new Ti,AX=new Ti,CX=()=>(new Date).getMilliseconds(),bX={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};let TX;!function(t){t.SCROLL_TO_TOP="scroll-to-top",t.SCROLL_TO_BOTTOM="scroll-to-bottom",t.SCROLL_TO_LEFT="scroll-to-left",t.SCROLL_TO_RIGHT="scroll-to-right",t.SCROLL_BEGAN="scroll-began",t.SCROLL_ENDED="scroll-ended",t.BOUNCE_TOP="bounce-top",t.BOUNCE_BOTTOM="bounce-bottom",t.BOUNCE_LEFT="bounce-left",t.BOUNCE_RIGHT="bounce-right",t.SCROLLING="scrolling",t.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",t.TOUCH_UP="touch-up"}(TX||(TX={}));let wX=function(e){return t({ScrollView:e,ScrollViewComponent:e}),e}((bq=u_("cc.ScrollView"),Tq=T_(),wq=d_(110),Eq=S_(),Pq=m_(rB),Iq=D_(),Dq=N_(),Rq=I_(),Mq=D_(),Bq=N_(),Oq=I_(),Nq=N_(),Lq=I_(),Fq=N_(),zq=I_(),Vq=H_(uf),Uq=N_(),Gq=I_(),Hq=N_(),kq=I_(),jq=H_(Sq),Wq=N_(),qq=I_(),Xq=N_(),Yq=I_(),Kq=H_(Sq),Jq=N_(),$q=I_(),Zq=N_(),Qq=I_(),tX=H_([Rw]),eX=N_(),iX=I_(),bq(nX=Tq(nX=wq(nX=Eq(nX=Pq((gX=fX=class extends Cq{constructor(...t){super(...t),i_(this,"bounceDuration",rX,this),i_(this,"brake",oX,this),i_(this,"elastic",aX,this),i_(this,"inertia",lX,this),i_(this,"horizontal",cX,this),i_(this,"vertical",hX,this),i_(this,"cancelInnerEvents",_X,this),i_(this,"scrollEvents",uX,this),this._autoScrolling=!1,this._scrolling=!1,i_(this,"_content",mX,this),i_(this,"_horizontalScrollBar",dX,this),i_(this,"_verticalScrollBar",pX,this),this._topBoundary=0,this._bottomBoundary=0,this._leftBoundary=0,this._rightBoundary=0,this._touchMoveDisplacements=[],this._touchMoveTimeDeltas=[],this._touchMovePreviousTimestamp=0,this._touchMoved=!1,this._autoScrollAttenuate=!1,this._autoScrollStartPosition=new oi,this._autoScrollTargetDelta=new oi,this._autoScrollTotalTime=0,this._autoScrollAccumulatedTime=0,this._autoScrollCurrentlyOutOfBoundary=!1,this._autoScrollBraking=!1,this._autoScrollBrakingStartPosition=new oi,this._outOfBoundaryAmount=new oi,this._outOfBoundaryAmountDirty=!0,this._stopMouseWheel=!1,this._mouseWheelEventElapsedTime=0,this._isScrollEndedWithThresholdEventFired=!1,this._scrollEventEmitMask=0,this._isBouncing=!1,this._contentPos=new oi,this._deltaPos=new oi}get content(){return this._content}set content(t){if(this._content===t)return;const e=t&&t.parent&&t.parent._uiProps.uiTransformComp;!t||t&&e?(this._content=t,this._calculateBoundary()):S(4302)}get horizontalScrollBar(){return this._horizontalScrollBar}set horizontalScrollBar(t){this._horizontalScrollBar!==t&&(this._horizontalScrollBar=t,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(Ti.ZERO)))}get verticalScrollBar(){return this._verticalScrollBar}set verticalScrollBar(t){this._verticalScrollBar!==t&&(this._verticalScrollBar=t,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(Ti.ZERO)))}get view(){const t=this._content&&this._content.parent;return t?t._uiProps.uiTransformComp:null}scrollToBottom(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Ti(0,0),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i,!0)}scrollToTop(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Ti(0,1),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToLeft(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Ti(0,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToRight(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Ti(1,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToTopLeft(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Ti(0,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToTopRight(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Ti(1,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToBottomLeft(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Ti(0,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToBottomRight(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new Ti(1,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToOffset(t,e,i=!0){const n=this.getMaxScrollOffset(),s=new Ti(0,0);0===n.x?s.x=0:s.x=t.x/n.x,0===n.y?s.y=1:s.y=(n.y-t.y)/n.y,this.scrollTo(s,e,i)}getScrollOffset(){const t=this._getContentTopBoundary()-this._topBoundary,e=this._getContentLeftBoundary()-this._leftBoundary;return new Ti(e,t)}getMaxScrollOffset(){if(!this._content||!this.view)return Ti.ZERO;const t=this._content._uiProps.uiTransformComp.contentSize;let e=t.width-this.view.width,i=t.height-this.view.height;return e=e>=0?e:0,i=i>=0?i:0,new Ti(e,i)}scrollToPercentHorizontal(t,e,i){const n=this._calculateMovePercentDelta({anchor:new Ti(t,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==i):this._moveContent(n)}scrollTo(t,e,i){const n=this._calculateMovePercentDelta({anchor:new Ti(t),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,i):this._moveContent(n)}scrollToPercentVertical(t,e,i){const n=this._calculateMovePercentDelta({anchor:new Ti(0,t),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,i):this._moveContent(n)}stopAutoScroll(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}setContentPosition(t){this._setContentPosition(t)}_setContentPosition(t){if(!this._content)return;const e=this._getContentPosition();Math.abs(t.x-e.x)<yX&&Math.abs(t.y-e.y)<yX||(this._content.setPosition(t),this._outOfBoundaryAmountDirty=!0)}getContentPosition(){return this._getContentPosition()}_getContentPosition(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):oi.ZERO}isScrolling(){return this._scrolling}isAutoScrolling(){return this._autoScrolling}getScrollEndedEventTiming(){return yX}start(){this._calculateBoundary(),this._content&&aT.once(oT.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}onEnable(){this._registerEvent(),this._content&&(this._content.on(uf.EventType.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(uf.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(uf.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(uf.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()}update(t){this._autoScrolling&&this._processAutoScrolling(t)}onDisable(){this._unregisterEvent(),this._content&&(this._content.off(uf.EventType.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(uf.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(uf.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(uf.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()}_registerEvent(){this.node.on(uf.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(uf.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(uf.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(uf.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(uf.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}_unregisterEvent(){this.node.off(uf.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(uf.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(uf.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(uf.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(uf.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}_onMouseWheel(t,e){if(!this.enabledInHierarchy)return;if(this._hasNestedViewGroup(t,e))return;const i=new oi,n=t.getScrollY();this.vertical?i.set(0,-.1*n,0):this.horizontal&&i.set(-.1*n,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(t)}_onTouchBegan(t,e){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(t,e)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(t)))}_onTouchMoved(t,e){if(!this.enabledInHierarchy||!this._content)return;if(this._hasNestedViewGroup(t,e))return;const i=t.touch;if(this._handleMoveLogic(i),!this.cancelInnerEvents)return;const n=i.getUILocation(SX);if(n.subtract(i.getUIStartLocation(AX)),n.length()>7&&!this._touchMoved&&t.target!==this.node){const e=new ry(t.getTouches(),t.bubbles);e.type=uf.EventType.TOUCH_CANCEL,e.touch=t.touch,e.simulate=!0,t.target.dispatchEvent(e),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(t)}_onTouchEnded(t,e){if(!this.enabledInHierarchy||!this._content||!t)return;if(this._hasNestedViewGroup(t,e))return;this._dispatchEvent(TX.TOUCH_UP);const i=t.touch;this._handleReleaseLogic(i),this._touchMoved?t.propagationStopped=!0:this._stopPropagationIfTargetIsMe(t)}_onTouchCancelled(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){if(t&&!t.simulate){const e=t.touch;this._handleReleaseLogic(e)}this._stopPropagationIfTargetIsMe(t)}}_calculateBoundary(){if(this._content&&this.view){const t=this._content.getComponent(vW);t&&t.enabledInHierarchy&&t.updateLayout();const e=this.view,i=e.width*e.anchorX,n=e.height*e.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+e.width,this._topBoundary=this._bottomBoundary+e.height,this._moveContentToTopLeft(e.contentSize)}}_hasNestedViewGroup(t,e){if(!t||t.eventPhase!==vu.CAPTURING_PHASE)return!1;if(e)for(const i of e){const e=i;if(this.node===e)return!(!t.target||!t.target.getComponent(Cq));if(e.getComponent(Cq))return!0}return!1}_startInertiaScroll(t){const e=new oi(t);e.multiplyScalar(.7),this._startAttenuatingAutoScroll(e,t)}_calculateAttenuatedFactor(t){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*t+t*t*8e-9))}_startAttenuatingAutoScroll(t,e){const i=t.clone();if(i.normalize(),this._content&&this.view){const t=this._content._uiProps.uiTransformComp.contentSize,e=this.view.contentSize,n=t.width-e.width,s=t.height-e.height,r=this._calculateAttenuatedFactor(n),o=this._calculateAttenuatedFactor(s);i.x=i.x*n*(1-this.brake)*r,i.y=i.y*s*o*(1-this.brake),i.z=0}const n=t.length();let s=i.length()/n;if(i.add(t),this.brake>0&&s>7){s=Math.sqrt(s);const e=t.clone();e.multiplyScalar(s),i.set(e),i.add(t)}let r=this._calculateAutoScrollTimeByInitialSpeed(e.length());this.brake>0&&s>3&&(s=3,r*=s),0===this.brake&&s>1&&(r*=s),this._startAutoScroll(i,r,!0)}_calculateAutoScrollTimeByInitialSpeed(t){return Math.sqrt(Math.sqrt(t/5))}_startAutoScroll(t,e,i=!1){const n=this._flattenVectorByDirection(t);this._autoScrolling=!0,this._autoScrollTargetDelta=n,this._autoScrollAttenuate=i,oi.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=e,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(oi.ZERO,yX)||(this._autoScrollCurrentlyOutOfBoundary=!0)}_calculateTouchMoveVelocity(){const t=new oi;let e=0;if(e=this._touchMoveTimeDeltas.reduce(((t,e)=>t+e),e),e<=0||e>=.5)t.set(oi.ZERO);else{let i=new oi;i=this._touchMoveDisplacements.reduce(((t,e)=>(t.add(e),t)),i),t.set(i.x*(1-this.brake)/e,i.y*(1-this.brake)/e,i.z)}return t}_flattenVectorByDirection(t){const e=t;return e.x=this.horizontal?e.x:0,e.y=this.vertical?e.y:0,e}_moveContent(t,e){const i=this._flattenVectorByDirection(t);vX.set(this._getContentPosition()),vX.add(i),vX.set(Math.floor(1e4*vX.x)*yX,Math.floor(1e4*vX.y)*yX,vX.z),this._setContentPosition(vX);const n=this._getHowMuchOutOfBoundary();SX.set(n.x,n.y),this._updateScrollBar(SX),this.elastic&&e&&this._startBounceBackIfNeeded()}_getContentLeftBoundary(){if(!this._content)return-1;const t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.x-e.anchorX*e.width}_getContentRightBoundary(){if(!this._content)return-1;const t=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+t.width}_getContentTopBoundary(){if(!this._content)return-1;const t=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+t.height}_getContentBottomBoundary(){if(!this._content)return-1;const t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.y-e.anchorY*e.height}_getHowMuchOutOfBoundary(t){if((t=t||new oi).equals(oi.ZERO,yX)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;const e=new oi;return this._getContentLeftBoundary()+t.x>this._leftBoundary?e.x=this._leftBoundary-(this._getContentLeftBoundary()+t.x):this._getContentRightBoundary()+t.x<this._rightBoundary&&(e.x=this._rightBoundary-(this._getContentRightBoundary()+t.x)),this._getContentTopBoundary()+t.y<this._topBoundary?e.y=this._topBoundary-(this._getContentTopBoundary()+t.y):this._getContentBottomBoundary()+t.y>this._bottomBoundary&&(e.y=this._bottomBoundary-(this._getContentBottomBoundary()+t.y)),t.equals(oi.ZERO,yX)&&(this._outOfBoundaryAmount=e,this._outOfBoundaryAmountDirty=!1),this._clampDelta(e),e}_updateScrollBar(t){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(t),this.verticalScrollBar&&this.verticalScrollBar.onScroll(t)}_onScrollBarTouchBegan(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}_onScrollBarTouchEnded(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}_dispatchEvent(t){if(t===TX.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(t===TX.SCROLL_TO_TOP||t===TX.SCROLL_TO_BOTTOM||t===TX.SCROLL_TO_LEFT||t===TX.SCROLL_TO_RIGHT){const e=1<<bX[t];if(this._scrollEventEmitMask&e)return;this._scrollEventEmitMask|=e}Rw.emitEvents(this.scrollEvents,this,bX[t]),this.node.emit(t,this)}_adjustContentOutOfBoundary(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){const t=this._getHowMuchOutOfBoundary();vX.set(this._getContentPosition()),vX.add(t),this._content.setPosition(vX),this._updateScrollBar(Ti.ZERO)}}_hideScrollBar(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()}_updateScrollBarState(){if(!this._content||!this.view)return;const t=this.view,e=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(e.height<t.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(e.width<t.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}_stopPropagationIfTargetIsMe(t){t.eventPhase===vu.AT_TARGET&&t.target===this.node&&(t.propagationStopped=!0)}_processDeltaMove(t){this._scrollChildren(t),this._gatherTouchMove(t)}_handleMoveLogic(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._processDeltaMove(this._deltaPos)}_handleReleaseLogic(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(TX.SCROLL_ENDED))}_getLocalAxisAlignDelta(t,e){const i=this.node._uiProps.uiTransformComp,n=new oi;i&&(e.getUILocation(SX),e.getUIPreviousLocation(AX),vX.set(SX.x,SX.y,0),xX.set(AX.x,AX.y,0),i.convertToNodeSpaceAR(vX,vX),i.convertToNodeSpaceAR(xX,xX),oi.subtract(n,vX,xX)),t.set(n)}_scrollChildren(t){this._clampDelta(t);const e=t;let i,n;if(this.elastic&&(i=this._getHowMuchOutOfBoundary(),e.x*=0===i.x?1:.5,e.y*=0===i.y?1:.5),this.elastic||(i=this._getHowMuchOutOfBoundary(e),e.add(i)),this._content){const{anchorX:t,anchorY:i,width:s,height:r}=this._content._uiProps.uiTransformComp,o=this._content.position||oi.ZERO;e.y>0?o.y-i*r+e.y>=this._bottomBoundary&&(n=TX.SCROLL_TO_BOTTOM):e.y<0&&o.y-i*r+r+e.y<=this._topBoundary&&(n=TX.SCROLL_TO_TOP),e.x<0?o.x-t*s+s+e.x<=this._rightBoundary&&(n=TX.SCROLL_TO_RIGHT):e.x>0&&o.x-t*s+e.x>=this._leftBoundary&&(n=TX.SCROLL_TO_LEFT)}this._moveContent(e,!1),0===e.x&&0===e.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent(TX.SCROLL_BEGAN)),this._dispatchEvent(TX.SCROLLING)),n&&n.length>0&&this._dispatchEvent(n)}_handlePressLogic(){this._autoScrolling&&this._dispatchEvent(TX.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=CX(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}_clampDelta(t){if(this._content&&this.view){const e=this.view.contentSize,i=this._content._uiProps.uiTransformComp;i.width<e.width&&(t.x=0),i.height<e.height&&(t.y=0)}}_gatherTouchMove(t){const e=t.clone();for(this._clampDelta(e);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);const i=CX();this._touchMoveTimeDeltas.push((i-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=i}_startBounceBackIfNeeded(){if(!this.elastic)return!1;const t=this._getHowMuchOutOfBoundary();if(this._clampDelta(t),t.equals(oi.ZERO,yX))return!1;const e=Math.max(this.bounceDuration,0);return this._startAutoScroll(t,e,!0),this._isBouncing||(t.y>0&&this._dispatchEvent(TX.BOUNCE_TOP),t.y<0&&this._dispatchEvent(TX.BOUNCE_BOTTOM),t.x>0&&this._dispatchEvent(TX.BOUNCE_RIGHT),t.x<0&&this._dispatchEvent(TX.BOUNCE_LEFT),this._isBouncing=!0),!0}_processInertiaScroll(){if(!this._startBounceBackIfNeeded()&&this.inertia){const t=this._calculateTouchMoveVelocity();!t.equals(vX,yX)&&this.brake<1&&this._startInertiaScroll(t)}this._onScrollBarTouchEnded()}_isOutOfBoundary(){return!this._getHowMuchOutOfBoundary().equals(oi.ZERO,yX)}_isNecessaryAutoScrollBrake(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}_processAutoScrolling(t){const e=this._isNecessaryAutoScrollBrake(),i=e?.05:1;this._autoScrollAccumulatedTime+=t*(1/i);let n=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);var s;this._autoScrollAttenuate&&(s=n,n=(s-=1)*s*s*s*s+1);const r=this._autoScrollTargetDelta.clone();r.multiplyScalar(n);const o=this._autoScrollStartPosition.clone();o.add(r);let a=Math.abs(n-1)<=yX;if(Math.abs(n-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(TX.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){const t=o.clone();t.subtract(this._autoScrollBrakingStartPosition),e&&t.multiplyScalar(i),o.set(this._autoScrollBrakingStartPosition),o.add(t)}else{const t=o.clone();t.subtract(this.getContentPosition());const e=this._getHowMuchOutOfBoundary(t);e.equals(oi.ZERO,yX)||(o.add(e),a=!0)}a&&(this._autoScrolling=!1);const l=o.clone();l.subtract(this._getContentPosition()),this._clampDelta(l),this._moveContent(l,a),this._dispatchEvent(TX.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(TX.SCROLL_ENDED))}_checkMouseWheel(t){if(!this._getHowMuchOutOfBoundary().equals(oi.ZERO,yX))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(TX.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=t,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(TX.SCROLL_ENDED),this._stopMouseWheel=!1)}_calculateMovePercentDelta(t){const e=t.anchor,i=t.applyToHorizontal,n=t.applyToVertical;this._calculateBoundary(),e.clampf(Ti.ZERO,Ti.ONE);let s=this._getContentBottomBoundary()-this._bottomBoundary;s=-s;let r=this._getContentLeftBoundary()-this._leftBoundary;r=-r;const o=new oi;if(this._content&&this.view){let t=0;const a=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;i&&(t=a.width-l.width,o.x=r-t*e.x),n&&(t=a.height-l.height,o.y=s-t*e.y)}return o}_moveContentToTopLeft(t){let e=this._getContentBottomBoundary()-this._bottomBoundary;e=-e;const i=new oi;let n=0,s=this._getContentLeftBoundary()-this._leftBoundary;if(s=-s,this._content){const r=this._content._uiProps.uiTransformComp.contentSize;r.height<t.height&&(n=r.height-t.height,i.y=e-n),r.width<t.width&&(n=r.width-t.width,i.x=s)}this._updateScrollBarState(),this._moveContent(i),this._adjustContentOutOfBoundary()}_scaleChanged(t){t===t_.SCALE&&this._calculateBoundary()}},fX.EventType=TX,rX=n_((sX=gX).prototype,"bounceDuration",[g_,Iq,Dq,Rq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),oX=n_(sX.prototype,"brake",[g_,Mq,Bq,Oq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),aX=n_(sX.prototype,"elastic",[g_,Nq,Lq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lX=n_(sX.prototype,"inertia",[g_,Fq,zq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),n_(sX.prototype,"content",[Vq,Uq,Gq],Object.getOwnPropertyDescriptor(sX.prototype,"content"),sX.prototype),cX=n_(sX.prototype,"horizontal",[g_,Hq,kq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),n_(sX.prototype,"horizontalScrollBar",[jq,Wq,qq],Object.getOwnPropertyDescriptor(sX.prototype,"horizontalScrollBar"),sX.prototype),hX=n_(sX.prototype,"vertical",[g_,Xq,Yq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),n_(sX.prototype,"verticalScrollBar",[Kq,Jq,$q],Object.getOwnPropertyDescriptor(sX.prototype,"verticalScrollBar"),sX.prototype),_X=n_(sX.prototype,"cancelInnerEvents",[g_,Zq,Qq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),uX=n_(sX.prototype,"scrollEvents",[tX,g_,eX,iX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mX=n_(sX.prototype,"_content",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dX=n_(sX.prototype,"_horizontalScrollBar",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pX=n_(sX.prototype,"_verticalScrollBar",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nX=sX))||nX)||nX)||nX)||nX)||nX));var EX,PX,IX,DX,RX,MX,BX,OX,NX,LX,FX,zX,VX,UX,GX,HX,kX,jX,WX,qX,XX;const YX=new oi;var KX;!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(KX||(KX={})),jt(KX);let JX=function(e){return t({Slider:e,SliderComponent:e}),e}((EX=u_("cc.Slider"),PX=T_(),IX=d_(110),DX=S_(),RX=m_(rB),MX=H_(mF),BX=I_(),OX=H_(KX),NX=I_(),LX=D_(),FX=I_(),zX=H_([Rw]),VX=I_(),EX(UX=PX(UX=IX(UX=DX(UX=RX((XX=qX=class extends Nm{constructor(...t){super(...t),i_(this,"slideEvents",HX,this),i_(this,"_handle",kX,this),i_(this,"_direction",jX,this),i_(this,"_progress",WX,this),this._offset=new oi,this._dragging=!1,this._touchHandle=!1,this._handleLocalPos=new oi,this._touchPos=new oi}get handle(){return this._handle}set handle(t){this._handle!==t&&(this._handle=t)}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this._changeLayout())}get progress(){return this._progress}set progress(t){this._progress!==t&&(this._progress=t,this._updateHandlePosition())}__preload(){this._updateHandlePosition()}onEnable(){this._updateHandlePosition(),this.node.on(_p.TOUCH_START,this._onTouchBegan,this),this.node.on(_p.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(_p.TOUCH_END,this._onTouchEnded,this),this.node.on(_p.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(_p.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(_p.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(_p.TOUCH_END,this._onTouchEnded,this))}onDisable(){this.node.off(_p.TOUCH_START,this._onTouchBegan,this),this.node.off(_p.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(_p.TOUCH_END,this._onTouchEnded,this),this.node.off(_p.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(_p.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(_p.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(_p.TOUCH_END,this._onTouchEnded,this))}_onHandleDragStart(t){if(!t||!this._handle||!this._handle.node._uiProps.uiTransformComp)return;this._dragging=!0,this._touchHandle=!0;const e=t.touch.getUILocation();oi.set(this._touchPos,e.x,e.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),t.propagationStopped=!0}_onTouchBegan(t){this._handle&&t&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(t.touch),t.propagationStopped=!0)}_onTouchMoved(t){this._dragging&&t&&(this._handleSliderLogic(t.touch),t.propagationStopped=!0)}_onTouchEnded(t){this._dragging=!1,this._touchHandle=!1,this._offset=new oi,t&&(t.propagationStopped=!0)}_onTouchCancelled(t){this._dragging=!1,t&&(t.propagationStopped=!0)}_handleSliderLogic(t){this._updateProgress(t),this._emitSlideEvent()}_emitSlideEvent(){Rw.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}_updateProgress(t){if(!this._handle||!t)return;const e=t.getUILocation();oi.set(this._touchPos,e.x,e.y,0);const i=this.node._uiProps.uiTransformComp,n=i.convertToNodeSpaceAR(this._touchPos,YX);this.direction===KX.Horizontal?this.progress=Ge(.5+(n.x-this._offset.x)/i.width):this.progress=Ge(.5+(n.y-this._offset.y)/i.height)}_updateHandlePosition(){if(!this._handle)return;this._handleLocalPos.set(this._handle.node.getPosition());const t=this.node._uiProps.uiTransformComp;this._direction===KX.Horizontal?this._handleLocalPos.x=-t.width*t.anchorX+this.progress*t.width:this._handleLocalPos.y=-t.height*t.anchorY+this.progress*t.height,this._handle.node.setPosition(this._handleLocalPos)}_changeLayout(){const t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(t.setContentSize(e.height,e.width),this._handle){const t=this._handle.node.position;this._direction===KX.Horizontal?this._handle.node.setPosition(t.x,0,t.z):this._handle.node.setPosition(0,t.y,t.z),this._updateHandlePosition()}}},qX.Direction=KX,n_((GX=XX).prototype,"handle",[MX,BX],Object.getOwnPropertyDescriptor(GX.prototype,"handle"),GX.prototype),n_(GX.prototype,"direction",[OX,NX],Object.getOwnPropertyDescriptor(GX.prototype,"direction"),GX.prototype),n_(GX.prototype,"progress",[O_,LX,FX],Object.getOwnPropertyDescriptor(GX.prototype,"progress"),GX.prototype),HX=n_(GX.prototype,"slideEvents",[zX,g_,VX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kX=n_(GX.prototype,"_handle",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jX=n_(GX.prototype,"_direction",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KX.Horizontal}}),WX=n_(GX.prototype,"_progress",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),UX=GX))||UX)||UX)||UX)||UX)||UX));function $X(...t){return Object.assign({},...t)}var ZX,QX,tY,eY,iY,nY,sY,rY,oY,aY,lY,cY,hY,_Y,uY,mY,dY,pY,fY,gY;!function(t){t.TOGGLE="toggle"}(gY||(gY={}));let yY=function(e){return t({Toggle:e,ToggleComponent:e}),e}((ZX=u_("cc.Toggle"),QX=T_(),tY=d_(110),eY=S_(),iY=m_(rB),nY=N_(),sY=I_(),rY=H_(mF),oY=N_(),aY=I_(),lY=H_([Rw]),cY=I_(),ZX(hY=QX(hY=tY(hY=eY(hY=iY((fY=pY=class t extends ik{constructor(...t){super(...t),i_(this,"checkEvents",uY,this),i_(this,"_isChecked",mY,this),i_(this,"_checkMark",dY,this)}get isChecked(){return this._isChecked}set isChecked(t){this._set(t)}get checkMark(){return this._checkMark}set checkMark(t){this._checkMark!==t&&(this._checkMark=t)}set _resizeToTarget(t){t&&this._resizeNodeToTargetNode()}get _toggleContainer(){const t=this.node.parent;return n.Node.isNode(t)?t.getComponent("cc.ToggleContainer"):null}_internalToggle(){this.isChecked=!this.isChecked}_set(t,e=!0){if(this._isChecked==t)return;this._isChecked=t;const i=this._toggleContainer;i&&i.enabled&&this.enabled&&(t||!i.anyTogglesChecked()&&!i.allowSwitchOff)&&(this._isChecked=!0,i.notifyToggleCheck(this,e)),this.playEffect(),e&&this._emitToggleEvents()}playEffect(){this._checkMark&&(this._checkMark.node.active=this._isChecked)}setIsCheckedWithoutNotify(t){this._set(t,!1)}onEnable(){super.onEnable(),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)}onDisable(){super.onDisable(),this.node.off(t.EventType.CLICK,this._internalToggle,this)}OnDestroy(){const t=this._toggleContainer;t&&t.ensureValidState()}_emitToggleEvents(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&Rw.emitEvents(this.checkEvents,this)}},pY.EventType=$X(gY,ZH),n_((_Y=fY).prototype,"isChecked",[nY,sY],Object.getOwnPropertyDescriptor(_Y.prototype,"isChecked"),_Y.prototype),n_(_Y.prototype,"checkMark",[rY,oY,aY],Object.getOwnPropertyDescriptor(_Y.prototype,"checkMark"),_Y.prototype),uY=n_(_Y.prototype,"checkEvents",[lY,g_,cY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mY=n_(_Y.prototype,"_isChecked",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dY=n_(_Y.prototype,"_checkMark",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hY=_Y))||hY)||hY)||hY)||hY)||hY));var vY,xY,SY,AY,CY,bY,TY,wY,EY,PY,IY;let DY=function(e){return t({ToggleContainer:e,ToggleContainerComponent:e}),e}((vY=u_("cc.ToggleContainer"),xY=T_(),SY=d_(110),AY=S_(),CY=I_(),bY=H_([Rw]),TY=I_(),vY(wY=xY(wY=SY(wY=AY(wY=x_((PY=n_((EY=class extends Nm{constructor(...t){super(...t),i_(this,"_allowSwitchOff",PY,this),i_(this,"checkEvents",IY,this)}get allowSwitchOff(){return this._allowSwitchOff}set allowSwitchOff(t){this._allowSwitchOff=t}get toggleItems(){return this.node.children.map((t=>{const e=t.getComponent("cc.Toggle");return e&&e.enabled?e:null})).filter(Boolean)}onEnable(){this.ensureValidState(),this.node.on(_p.CHILD_ADDED,this.ensureValidState,this),this.node.on(_p.CHILD_REMOVED,this.ensureValidState,this)}onDisable(){this.node.off(_p.CHILD_ADDED,this.ensureValidState,this),this.node.off(_p.CHILD_REMOVED,this.ensureValidState,this)}activeToggles(){return this.toggleItems.filter((t=>t.isChecked))}anyTogglesChecked(){return!!this.toggleItems.find((t=>t.isChecked))}notifyToggleCheck(t,e=!0){if(this.enabledInHierarchy){for(let i=0;i<this.toggleItems.length;i++){const n=this.toggleItems[i];n!==t&&(e?n.isChecked=!1:n.setIsCheckedWithoutNotify(!1))}this.checkEvents&&n.Component.EventHandler.emitEvents(this.checkEvents,t)}}ensureValidState(){const t=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==t.length){const e=t[0];e.isChecked=!0,this.notifyToggleCheck(e)}const e=this.activeToggles();if(e.length>1){const t=e[0];for(let i=0;i<e.length;++i){const n=e[i];n!==t&&(n.isChecked=!1)}}}}).prototype,"_allowSwitchOff",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),n_(EY.prototype,"allowSwitchOff",[CY],Object.getOwnPropertyDescriptor(EY.prototype,"allowSwitchOff"),EY.prototype),IY=n_(EY.prototype,"checkEvents",[bY,g_,TY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wY=EY))||wY)||wY)||wY)||wY)||wY));var RY,MY,BY,OY,NY,LY,FY,zY,VY,UY,GY,HY,kY,jY,WY,qY,XY,YY,KY,JY,$Y,ZY,QY,tK,eK,iK,nK,sK,rK,oK,aK,lK,cK,hK,_K,uK,mK,dK,pK,fK,gK,yK,vK,xK,SK;const AK=new Ti;function CK(t){return t instanceof Sb?Fv:t._uiProps.uiTransformComp?t._uiProps.uiTransformComp.contentSize:Mi.ZERO}function bK(t,e,i,n){t.parent?AK.set(t.parent.getScale().x,t.parent.getScale().y):AK.set(0,0);let s=AK.x,r=AK.y,o=0,a=0;for(let l=t.parent;;){if(!l)return i.x=i.y=0,void(n.x=n.y=1);const t=l.getPosition();if(o+=t.x,a+=t.y,l=l.parent,l===e)break;{l?AK.set(l.getScale().x,l.getScale().y):AK.set(0,0);const t=AK.x,e=AK.y;o*=t,a*=e,s*=t,r*=e}}n.x=0!==s?1/s:1,n.y=0!==r?1/r:1,i.x=-o,i.y=-a}let TK,wK;!function(t){t[t.ONCE=0]="ONCE",t[t.ALWAYS=1]="ALWAYS",t[t.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(TK||(TK={})),jt(TK),function(t){t[t.TOP=1]="TOP",t[t.MID=2]="MID",t[t.BOT=4]="BOT",t[t.LEFT=8]="LEFT",t[t.CENTER=16]="CENTER",t[t.RIGHT=32]="RIGHT",t[t.HORIZONTAL=56]="HORIZONTAL",t[t.VERTICAL=7]="VERTICAL"}(wK||(wK={}));const EK=wK.TOP|wK.BOT,PK=wK.LEFT|wK.RIGHT;let IK=function(e){return t({Widget:e,WidgetComponent:e}),e}((RY=u_("cc.Widget"),MY=T_(),BY=d_(110),OY=S_(),NY=m_(rB),LY=H_(uf),FY=I_(),zY=I_(),VY=I_(),UY=I_(),GY=I_(),HY=I_(),kY=I_(),jY=E_(),WY=E_(),qY=I_(),XY=I_(),YY=I_(),KY=I_(),JY=I_(),$Y=I_(),ZY=H_(TK),QY=I_(),RY(tK=MY(tK=BY(tK=OY(tK=NY(tK=x_((SK=xK=class extends Nm{constructor(...t){super(...t),this._lastPos=new oi,this._lastSize=new Mi,this._dirty=!0,this._hadAlignOnce=!1,i_(this,"_alignFlags",iK,this),i_(this,"_target",nK,this),i_(this,"_left",sK,this),i_(this,"_right",rK,this),i_(this,"_top",oK,this),i_(this,"_bottom",aK,this),i_(this,"_horizontalCenter",lK,this),i_(this,"_verticalCenter",cK,this),i_(this,"_isAbsLeft",hK,this),i_(this,"_isAbsRight",_K,this),i_(this,"_isAbsTop",uK,this),i_(this,"_isAbsBottom",mK,this),i_(this,"_isAbsHorizontalCenter",dK,this),i_(this,"_isAbsVerticalCenter",pK,this),i_(this,"_originalWidth",fK,this),i_(this,"_originalHeight",gK,this),i_(this,"_alignMode",yK,this),i_(this,"_lockFlags",vK,this)}get target(){return this._target}set target(t){this._target!==t&&(this._unregisterTargetEvents(),this._target=t,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}get isAlignTop(){return(this._alignFlags&wK.TOP)>0}set isAlignTop(t){this._setAlign(wK.TOP,t),this._recursiveDirty()}get isAlignBottom(){return(this._alignFlags&wK.BOT)>0}set isAlignBottom(t){this._setAlign(wK.BOT,t),this._recursiveDirty()}get isAlignLeft(){return(this._alignFlags&wK.LEFT)>0}set isAlignLeft(t){this._setAlign(wK.LEFT,t),this._recursiveDirty()}get isAlignRight(){return(this._alignFlags&wK.RIGHT)>0}set isAlignRight(t){this._setAlign(wK.RIGHT,t),this._recursiveDirty()}get isAlignVerticalCenter(){return(this._alignFlags&wK.MID)>0}set isAlignVerticalCenter(t){t?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=wK.MID):this._alignFlags&=~wK.MID,this._recursiveDirty()}get isAlignHorizontalCenter(){return(this._alignFlags&wK.CENTER)>0}set isAlignHorizontalCenter(t){t?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=wK.CENTER):this._alignFlags&=~wK.CENTER,this._recursiveDirty()}get isStretchWidth(){return(this._alignFlags&PK)===PK}get isStretchHeight(){return(this._alignFlags&EK)===EK}get top(){return this._top}set top(t){this._top=t,this._recursiveDirty()}get editorTop(){return this._isAbsTop?this._top:100*this._top}set editorTop(t){this._top=this._isAbsTop?t:t/100,this._recursiveDirty()}get bottom(){return this._bottom}set bottom(t){this._bottom=t,this._recursiveDirty()}get editorBottom(){return this._isAbsBottom?this._bottom:100*this._bottom}set editorBottom(t){this._bottom=this._isAbsBottom?t:t/100,this._recursiveDirty()}get left(){return this._left}set left(t){this._left=t,this._recursiveDirty()}get editorLeft(){return this._isAbsLeft?this._left:100*this._left}set editorLeft(t){this._left=this._isAbsLeft?t:t/100,this._recursiveDirty()}get right(){return this._right}set right(t){this._right=t,this._recursiveDirty()}get editorRight(){return this._isAbsRight?this._right:100*this._right}set editorRight(t){this._right=this._isAbsRight?t:t/100,this._recursiveDirty()}get horizontalCenter(){return this._horizontalCenter}set horizontalCenter(t){this._horizontalCenter=t,this._recursiveDirty()}get editorHorizontalCenter(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter}set editorHorizontalCenter(t){this._horizontalCenter=this._isAbsHorizontalCenter?t:t/100,this._recursiveDirty()}get verticalCenter(){return this._verticalCenter}set verticalCenter(t){this._verticalCenter=t,this._recursiveDirty()}get editorVerticalCenter(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter}set editorVerticalCenter(t){this._verticalCenter=this._isAbsVerticalCenter?t:t/100,this._recursiveDirty()}get isAbsoluteTop(){return this._isAbsTop}set isAbsoluteTop(t){this._isAbsTop!==t&&(this._isAbsTop=t,this._autoChangedValue(wK.TOP,this._isAbsTop))}get isAbsoluteBottom(){return this._isAbsBottom}set isAbsoluteBottom(t){this._isAbsBottom!==t&&(this._isAbsBottom=t,this._autoChangedValue(wK.BOT,this._isAbsBottom))}get isAbsoluteLeft(){return this._isAbsLeft}set isAbsoluteLeft(t){this._isAbsLeft!==t&&(this._isAbsLeft=t,this._autoChangedValue(wK.LEFT,this._isAbsLeft))}get isAbsoluteRight(){return this._isAbsRight}set isAbsoluteRight(t){this._isAbsRight!==t&&(this._isAbsRight=t,this._autoChangedValue(wK.RIGHT,this._isAbsRight))}get isAbsoluteHorizontalCenter(){return this._isAbsHorizontalCenter}set isAbsoluteHorizontalCenter(t){this._isAbsHorizontalCenter!==t&&(this._isAbsHorizontalCenter=t,this._autoChangedValue(wK.CENTER,this._isAbsHorizontalCenter))}get isAbsoluteVerticalCenter(){return this._isAbsVerticalCenter}set isAbsoluteVerticalCenter(t){this._isAbsVerticalCenter!==t&&(this._isAbsVerticalCenter=t,this._autoChangedValue(wK.MID,this._isAbsVerticalCenter))}get alignMode(){return this._alignMode}set alignMode(t){this._alignMode=t,this._recursiveDirty()}get alignFlags(){return this._alignFlags}set alignFlags(t){this._alignFlags!==t&&(this._alignFlags=t,this._recursiveDirty())}updateAlignment(){n._widgetManager.updateAlignment(this.node)}_validateTargetInDEV(){}setDirty(){this._recursiveDirty()}onEnable(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),n._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()}onDisable(){n._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}onDestroy(){this._removeParentEvent()}_adjustWidgetToAllowMovingInEditor(t){}_adjustWidgetToAllowResizingInEditor(){}_adjustWidgetToAnchorChanged(){this.setDirty()}_adjustTargetToParentChanged(t){t&&this._unregisterOldParentEvents(t),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()}_registerEvent(){this.node.on(_p.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(_p.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(_p.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(_p.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}_unregisterEvent(){this.node.off(_p.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(_p.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(_p.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}_removeParentEvent(){this.node.off(_p.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}_autoChangedValue(t,e){if(!((this._alignFlags&t)>0))return;const i=this.node.parent&&this.node.parent._uiProps,n=i&&i.uiTransformComp,s=n?n.contentSize:Fv;this.isAlignLeft&&t===wK.LEFT?this._left=e?this._left*s.width:this._left/s.width:this.isAlignRight&&t===wK.RIGHT?this._right=e?this._right*s.width:this._right/s.width:this.isAlignHorizontalCenter&&t===wK.CENTER?this._horizontalCenter=e?this._horizontalCenter*s.width:this._horizontalCenter/s.width:this.isAlignTop&&t===wK.TOP?this._top=e?this._top*s.height:this._top/s.height:this.isAlignBottom&&t===wK.BOT?this._bottom=e?this._bottom*s.height:this._bottom/s.height:this.isAbsoluteVerticalCenter&&t===wK.MID&&(this._verticalCenter=this._verticalCenter/s.height),this._recursiveDirty()}_registerTargetEvents(){const t=this._target||this.node.parent;t&&t.getComponent(rB)&&(t.on(_p.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.on(_p.SIZE_CHANGED,this._setDirtyByMode,this))}_unregisterTargetEvents(){const t=this._target||this.node.parent;t&&(t.off(_p.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(_p.SIZE_CHANGED,this._setDirtyByMode,this))}_unregisterOldParentEvents(t){const e=this._target||t;e&&(e.off(_p.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(_p.SIZE_CHANGED,this._setDirtyByMode,this))}_setDirtyByMode(){this.alignMode===TK.ALWAYS&&this._recursiveDirty()}_setAlign(t,e){if(e===(this._alignFlags&t)>0)return;const i=(t&PK)>0,n=this.node._uiProps.uiTransformComp;e?(this._alignFlags|=t,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=n.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=n.height))):(i?this.isStretchWidth&&(n.width=this._originalWidth):this.isStretchHeight&&(n.height=this._originalHeight),this._alignFlags&=~t)}_recursiveDirty(){this._dirty||(this._dirty=!0)}},xK.AlignMode=TK,n_((eK=SK).prototype,"target",[LY,FY],Object.getOwnPropertyDescriptor(eK.prototype,"target"),eK.prototype),n_(eK.prototype,"isAlignTop",[zY],Object.getOwnPropertyDescriptor(eK.prototype,"isAlignTop"),eK.prototype),n_(eK.prototype,"isAlignBottom",[VY],Object.getOwnPropertyDescriptor(eK.prototype,"isAlignBottom"),eK.prototype),n_(eK.prototype,"isAlignLeft",[UY],Object.getOwnPropertyDescriptor(eK.prototype,"isAlignLeft"),eK.prototype),n_(eK.prototype,"isAlignRight",[GY],Object.getOwnPropertyDescriptor(eK.prototype,"isAlignRight"),eK.prototype),n_(eK.prototype,"isAlignVerticalCenter",[HY],Object.getOwnPropertyDescriptor(eK.prototype,"isAlignVerticalCenter"),eK.prototype),n_(eK.prototype,"isAlignHorizontalCenter",[kY],Object.getOwnPropertyDescriptor(eK.prototype,"isAlignHorizontalCenter"),eK.prototype),n_(eK.prototype,"isStretchWidth",[jY],Object.getOwnPropertyDescriptor(eK.prototype,"isStretchWidth"),eK.prototype),n_(eK.prototype,"isStretchHeight",[WY],Object.getOwnPropertyDescriptor(eK.prototype,"isStretchHeight"),eK.prototype),n_(eK.prototype,"top",[qY],Object.getOwnPropertyDescriptor(eK.prototype,"top"),eK.prototype),n_(eK.prototype,"editorTop",[w_],Object.getOwnPropertyDescriptor(eK.prototype,"editorTop"),eK.prototype),n_(eK.prototype,"bottom",[XY],Object.getOwnPropertyDescriptor(eK.prototype,"bottom"),eK.prototype),n_(eK.prototype,"editorBottom",[w_],Object.getOwnPropertyDescriptor(eK.prototype,"editorBottom"),eK.prototype),n_(eK.prototype,"left",[YY],Object.getOwnPropertyDescriptor(eK.prototype,"left"),eK.prototype),n_(eK.prototype,"editorLeft",[w_],Object.getOwnPropertyDescriptor(eK.prototype,"editorLeft"),eK.prototype),n_(eK.prototype,"right",[KY],Object.getOwnPropertyDescriptor(eK.prototype,"right"),eK.prototype),n_(eK.prototype,"editorRight",[w_],Object.getOwnPropertyDescriptor(eK.prototype,"editorRight"),eK.prototype),n_(eK.prototype,"horizontalCenter",[JY],Object.getOwnPropertyDescriptor(eK.prototype,"horizontalCenter"),eK.prototype),n_(eK.prototype,"editorHorizontalCenter",[w_],Object.getOwnPropertyDescriptor(eK.prototype,"editorHorizontalCenter"),eK.prototype),n_(eK.prototype,"verticalCenter",[$Y],Object.getOwnPropertyDescriptor(eK.prototype,"verticalCenter"),eK.prototype),n_(eK.prototype,"editorVerticalCenter",[w_],Object.getOwnPropertyDescriptor(eK.prototype,"editorVerticalCenter"),eK.prototype),n_(eK.prototype,"isAbsoluteTop",[w_],Object.getOwnPropertyDescriptor(eK.prototype,"isAbsoluteTop"),eK.prototype),n_(eK.prototype,"isAbsoluteBottom",[w_],Object.getOwnPropertyDescriptor(eK.prototype,"isAbsoluteBottom"),eK.prototype),n_(eK.prototype,"isAbsoluteLeft",[w_],Object.getOwnPropertyDescriptor(eK.prototype,"isAbsoluteLeft"),eK.prototype),n_(eK.prototype,"isAbsoluteRight",[w_],Object.getOwnPropertyDescriptor(eK.prototype,"isAbsoluteRight"),eK.prototype),n_(eK.prototype,"isAbsoluteHorizontalCenter",[w_],Object.getOwnPropertyDescriptor(eK.prototype,"isAbsoluteHorizontalCenter"),eK.prototype),n_(eK.prototype,"isAbsoluteVerticalCenter",[w_],Object.getOwnPropertyDescriptor(eK.prototype,"isAbsoluteVerticalCenter"),eK.prototype),n_(eK.prototype,"alignMode",[ZY,QY],Object.getOwnPropertyDescriptor(eK.prototype,"alignMode"),eK.prototype),n_(eK.prototype,"alignFlags",[w_],Object.getOwnPropertyDescriptor(eK.prototype,"alignFlags"),eK.prototype),iK=n_(eK.prototype,"_alignFlags",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nK=n_(eK.prototype,"_target",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sK=n_(eK.prototype,"_left",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rK=n_(eK.prototype,"_right",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oK=n_(eK.prototype,"_top",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aK=n_(eK.prototype,"_bottom",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lK=n_(eK.prototype,"_horizontalCenter",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cK=n_(eK.prototype,"_verticalCenter",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hK=n_(eK.prototype,"_isAbsLeft",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_K=n_(eK.prototype,"_isAbsRight",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),uK=n_(eK.prototype,"_isAbsTop",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),mK=n_(eK.prototype,"_isAbsBottom",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dK=n_(eK.prototype,"_isAbsHorizontalCenter",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),pK=n_(eK.prototype,"_isAbsVerticalCenter",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),fK=n_(eK.prototype,"_originalWidth",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gK=n_(eK.prototype,"_originalHeight",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yK=n_(eK.prototype,"_alignMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TK.ON_WINDOW_RESIZE}}),vK=n_(eK.prototype,"_lockFlags",[g_,y_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tK=eK))||tK)||tK)||tK)||tK)||tK)||tK));var DK,RK,MK,BK,OK,NK,LK,FK,zK,VK,UK,GK,HK,kK,jK,WK,qK,XK,YK;n.internal.computeInverseTransForTarget=bK,n.internal.getReadonlyNodeSize=CK;const KK=new si;var JK;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(JK||(JK={})),jt(JK);let $K=function(e){return t({PageViewIndicator:e,PageViewIndicatorComponent:e}),e}((DK=u_("cc.PageViewIndicator"),RK=T_(),MK=d_(110),BK=S_(),OK=H_(zR),NK=I_(),LK=H_(JK),FK=I_(),zK=H_(Mi),VK=I_(),UK=I_(),DK(GK=RK(GK=MK(GK=BK((YK=XK=class extends Nm{constructor(...t){super(...t),i_(this,"spacing",kK,this),i_(this,"_spriteFrame",jK,this),i_(this,"_direction",WK,this),i_(this,"_cellSize",qK,this),this._layout=null,this._pageView=null,this._indicators=[]}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){this._spriteFrame!==t&&(this._spriteFrame=t)}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t)}get cellSize(){return this._cellSize}set cellSize(t){this._cellSize!==t&&(this._cellSize=t)}onLoad(){this._updateLayout()}setPageView(t){this._pageView=t,this._refresh()}_updateLayout(){this._layout=this.getComponent(vW),this._layout||(this._layout=this.addComponent(vW));const t=this._layout;this.direction===JK.HORIZONTAL?(t.type=vW.Type.HORIZONTAL,t.spacingX=this.spacing):this.direction===JK.VERTICAL&&(t.type=vW.Type.VERTICAL,t.spacingY=this.spacing),t.resizeMode=vW.ResizeMode.CONTAINER}_createIndicator(){const t=new uf;t.layer=this.node.layer;const e=t.addComponent(mF);return e.spriteFrame=this.spriteFrame,e.sizeMode=mF.SizeMode.CUSTOM,t.parent=this.node,t._uiProps.uiTransformComp.setContentSize(this._cellSize),t}_changedState(){const t=this._indicators;if(0===t.length||!this._pageView)return;const e=this._pageView.curPageIdx;if(!(e>=t.length)){for(let e=0;e<t.length;++e){const i=t[e];if(!i._uiProps.uiComp)continue;const n=i._uiProps.uiComp;KK.set(n.color),KK.a=127.5,n.color=KK}if(t[e]._uiProps.uiComp){const i=t[e]._uiProps.uiComp;KK.set(i.color),KK.a=255,i.color=KK}}}_refresh(){if(!this._pageView)return;const t=this._indicators,e=this._pageView.getPages();if(e.length===t.length)return;let i=0;if(e.length>t.length)for(i=0;i<e.length;++i)t[i]||(t[i]=this._createIndicator());else for(i=t.length-e.length;i>0;--i){const e=t[i-1];this.node.removeChild(e),t.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}},XK.Direction=JK,n_((HK=YK).prototype,"spriteFrame",[OK,NK],Object.getOwnPropertyDescriptor(HK.prototype,"spriteFrame"),HK.prototype),n_(HK.prototype,"direction",[LK,FK],Object.getOwnPropertyDescriptor(HK.prototype,"direction"),HK.prototype),n_(HK.prototype,"cellSize",[zK,VK],Object.getOwnPropertyDescriptor(HK.prototype,"cellSize"),HK.prototype),kK=n_(HK.prototype,"spacing",[g_,UK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jK=n_(HK.prototype,"_spriteFrame",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WK=n_(HK.prototype,"_direction",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return JK.HORIZONTAL}}),qK=n_(HK.prototype,"_cellSize",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(20,20)}}),GK=HK))||GK)||GK)||GK)||GK));var ZK,QK,tJ,eJ,iJ,nJ,sJ,rJ,oJ,aJ,lJ,cJ,hJ,_J,uJ,mJ,dJ,pJ,fJ,gJ,yJ,vJ,xJ,SJ,AJ,CJ,bJ,TJ,wJ,EJ,PJ,IJ,DJ,RJ,MJ,BJ,OJ,NJ,LJ,FJ,zJ,VJ;const UJ=new Ti;var GJ,HJ,kJ;!function(t){t[t.Unified=0]="Unified",t[t.Free=1]="Free"}(GJ||(GJ={})),jt(GJ),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(HJ||(HJ={})),jt(HJ),function(t){t.PAGE_TURNING="page-turning"}(kJ||(kJ={}));let jJ=function(e){return t({PageView:e,PageViewComponent:e}),e}((ZK=u_("cc.PageView"),QK=T_(),tJ=d_(110),eJ=S_(),iJ=H_(GJ),nJ=I_(),sJ=H_(HJ),rJ=I_(),oJ=D_(),aJ=I_(),lJ=D_(),cJ=I_(),hJ=H_($K),_J=I_(),uJ=I_(),mJ=H_(Sq),dJ=E_(),pJ=H_(Sq),fJ=E_(),gJ=E_(),yJ=E_(),vJ=E_(),xJ=H_([Rw]),SJ=E_(),AJ=H_([Rw]),CJ=I_(),ZK(bJ=QK(bJ=tJ(bJ=eJ((VJ=zJ=class t extends wX{constructor(...t){super(...t),i_(this,"autoPageTurningThreshold",wJ,this),i_(this,"horizontal",EJ,this),i_(this,"vertical",PJ,this),i_(this,"cancelInnerEvents",IJ,this),i_(this,"scrollEvents",DJ,this),i_(this,"pageTurningSpeed",RJ,this),i_(this,"pageEvents",MJ,this),i_(this,"_sizeMode",BJ,this),i_(this,"_direction",OJ,this),i_(this,"_scrollThreshold",NJ,this),i_(this,"_pageTurningEventTiming",LJ,this),i_(this,"_indicator",FJ,this),this._curPageIdx=0,this._lastPageIdx=0,this._pages=[],this._initContentPos=new oi,this._scrollCenterOffsetX=[],this._scrollCenterOffsetY=[],this._touchBeganPosition=new Ti,this._touchEndPosition=new Ti}get sizeMode(){return this._sizeMode}set sizeMode(t){this._sizeMode!==t&&(this._sizeMode=t,this._syncSizeMode())}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this._syncScrollDirection())}get scrollThreshold(){return this._scrollThreshold}set scrollThreshold(t){this._scrollThreshold!==t&&(this._scrollThreshold=t)}get pageTurningEventTiming(){return this._pageTurningEventTiming}set pageTurningEventTiming(t){this._pageTurningEventTiming!==t&&(this._pageTurningEventTiming=t)}get indicator(){return this._indicator}set indicator(t){this._indicator!==t&&(this._indicator=t,this.indicator&&this.indicator.setPageView(this))}get curPageIdx(){return this._curPageIdx}get verticalScrollBar(){return super.verticalScrollBar}set verticalScrollBar(t){super.verticalScrollBar=t}get horizontalScrollBar(){return super.horizontalScrollBar}set horizontalScrollBar(t){super.horizontalScrollBar=t}onEnable(){super.onEnable(),this.node.on(_p.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onDisable(){super.onDisable(),this.node.off(_p.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onLoad(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}getCurrentPageIndex(){return this._curPageIdx}setCurrentPageIndex(t){this.scrollToPage(t,1)}getPages(){return this._pages}addPage(t){t&&-1===this._pages.indexOf(t)&&this.content&&(t._uiProps.uiTransformComp?(this.content.addChild(t),this._pages.push(t),this._updatePageView()):S(4301))}insertPage(t,e){if(!(e<0)&&t&&-1===this._pages.indexOf(t)&&this.content)if(e>=this._pages.length)this.addPage(t);else{if(!t._uiProps.uiTransformComp)return void S(4301);this._pages.splice(e,0,t),this.content.insertChild(t,e),this._updatePageView()}}removePage(t){if(!t||!this.content)return;const e=this._pages.indexOf(t);-1!==e?this.removePageAtIndex(e):C(4300,t.name)}removePageAtIndex(t){const e=this._pages;if(t<0||t>=e.length)return;const i=e[t];i&&this.content&&(this.content.removeChild(i),e.splice(t,1),this._updatePageView())}removeAllPages(){if(!this.content)return;const t=this._pages;for(let e=0,i=t.length;e<i;e++)this.content.removeChild(t[e]);this._pages.length=0,this._updatePageView()}scrollToPage(t,e=.3){t<0||t>=this._pages.length||(this._curPageIdx=t,this.scrollToOffset(this._moveOffsetValue(t),e,!0),this.indicator&&this.indicator._changedState())}getScrollEndedEventTiming(){return this.pageTurningEventTiming}_updatePageView(){if(!this.content)return;const t=this.content.getComponent(vW);t&&t.enabled&&t.updateLayout();const e=this._pages.length;this._curPageIdx>=e&&(this._curPageIdx=0===e?0:e-1,this._lastPageIdx=this._curPageIdx);const i=this._initContentPos;for(let t=0;t<e;++t){const e=this._pages[t].position;this.direction===HJ.Horizontal?this._scrollCenterOffsetX[t]=Math.abs(i.x+e.x):this._scrollCenterOffsetY[t]=Math.abs(i.y+e.y)}this.indicator&&this.indicator._refresh()}_updateAllPagesSize(){const t=this.view;if(!this.content||!t)return;if(this._sizeMode!==GJ.Unified)return;const e=this._pages,i=t.contentSize;for(let t=0,n=e.length;t<n;t++)e[t]._uiProps.uiTransformComp.setContentSize(i)}_handleReleaseLogic(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))}_onTouchBegan(t,e){t.touch.getUILocation(UJ),Ti.set(this._touchBeganPosition,UJ.x,UJ.y),super._onTouchBegan(t,e)}_onTouchMoved(t,e){super._onTouchMoved(t,e)}_onTouchEnded(t,e){t.touch.getUILocation(UJ),Ti.set(this._touchEndPosition,UJ.x,UJ.y),super._onTouchEnded(t,e)}_onTouchCancelled(t,e){t.touch.getUILocation(UJ),Ti.set(this._touchEndPosition,UJ.x,UJ.y),super._onTouchCancelled(t,e)}_onMouseWheel(){}_syncScrollDirection(){this.horizontal=this.direction===HJ.Horizontal,this.vertical=this.direction===HJ.Vertical}_syncSizeMode(){const t=this.view;if(!this.content||!t)return;const e=this.content.getComponent(vW);if(e){if(this._sizeMode===GJ.Free&&this._pages.length>0){const i=this._pages[0]._uiProps.uiTransformComp,n=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===HJ.Horizontal?(e.paddingLeft=(t.width-i.width)/2,e.paddingRight=(t.width-n.width)/2):this.direction===HJ.Vertical&&(e.paddingTop=(t.height-i.height)/2,e.paddingBottom=(t.height-n.height)/2)}e.updateLayout()}}_initPages(){if(!this.content)return;this._initContentPos=this.content.position;const t=this.content.children;for(let e=0;e<t.length;++e){const i=t[e];this._pages.indexOf(i)>=0||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}_dispatchPageTurningEvent(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,Rw.emitEvents(this.pageEvents,this,kJ.PAGE_TURNING),this.node.emit(kJ.PAGE_TURNING,this))}_isQuicklyScrollable(t){if(this.direction===HJ.Horizontal){if(Math.abs(t.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===HJ.Vertical&&Math.abs(t.y)>this.autoPageTurningThreshold)return!0;return!1}_moveOffsetValue(t){const e=new Ti;if(this._sizeMode===GJ.Free)this.direction===HJ.Horizontal?e.x=this._scrollCenterOffsetX[t]:this.direction===HJ.Vertical&&(e.y=this._scrollCenterOffsetY[t]);else{const i=this.view;if(!i)return e;this.direction===HJ.Horizontal?e.x=t*i.width:this.direction===HJ.Vertical&&(e.y=t*i.height)}return e}_getDragDirection(t){return this._direction===HJ.Horizontal?0===t.x?0:t.x>0?1:-1:0===t.y?0:t.y<0?1:-1}_isScrollable(t,e,i){if(this._sizeMode===GJ.Free){let n=0,s=0;if(this.direction===HJ.Horizontal)return n=this._scrollCenterOffsetX[e],s=this._scrollCenterOffsetX[i],Math.abs(t.x)>=Math.abs(n-s)*this.scrollThreshold;if(this.direction===HJ.Vertical)return n=this._scrollCenterOffsetY[e],s=this._scrollCenterOffsetY[i],Math.abs(t.y)>=Math.abs(n-s)*this.scrollThreshold}else{const e=this.view;if(!e)return!1;if(this.direction===HJ.Horizontal)return Math.abs(t.x)>=e.width*this.scrollThreshold;if(this.direction===HJ.Vertical)return Math.abs(t.y)>=e.height*this.scrollThreshold}return!1}_autoScrollToPage(){if(this._startBounceBackIfNeeded()){const t=this._getHowMuchOutOfBoundary();this._clampDelta(t),(t.x>0||t.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(t.x<0||t.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{const t=new Ti;Ti.subtract(t,this._touchBeganPosition,this._touchEndPosition);const e=this._curPageIdx,i=e+this._getDragDirection(t),n=this.pageTurningSpeed*Math.abs(e-i);if(i<this._pages.length){if(this._isScrollable(t,e,i))return void this.scrollToPage(i,n);{const t=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(t))return void this.scrollToPage(i,n)}}this.scrollToPage(e,n)}}},zJ.SizeMode=GJ,zJ.Direction=HJ,zJ.EventType=$X(kJ,TX),n_((TJ=VJ).prototype,"sizeMode",[iJ,nJ],Object.getOwnPropertyDescriptor(TJ.prototype,"sizeMode"),TJ.prototype),n_(TJ.prototype,"direction",[sJ,rJ],Object.getOwnPropertyDescriptor(TJ.prototype,"direction"),TJ.prototype),n_(TJ.prototype,"scrollThreshold",[O_,oJ,aJ],Object.getOwnPropertyDescriptor(TJ.prototype,"scrollThreshold"),TJ.prototype),n_(TJ.prototype,"pageTurningEventTiming",[O_,lJ,cJ],Object.getOwnPropertyDescriptor(TJ.prototype,"pageTurningEventTiming"),TJ.prototype),n_(TJ.prototype,"indicator",[hJ,_J],Object.getOwnPropertyDescriptor(TJ.prototype,"indicator"),TJ.prototype),wJ=n_(TJ.prototype,"autoPageTurningThreshold",[g_,uJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),n_(TJ.prototype,"verticalScrollBar",[mJ,k_,dJ],Object.getOwnPropertyDescriptor(TJ.prototype,"verticalScrollBar"),TJ.prototype),n_(TJ.prototype,"horizontalScrollBar",[pJ,k_,fJ],Object.getOwnPropertyDescriptor(TJ.prototype,"horizontalScrollBar"),TJ.prototype),EJ=n_(TJ.prototype,"horizontal",[k_,g_,gJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),PJ=n_(TJ.prototype,"vertical",[k_,g_,yJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),IJ=n_(TJ.prototype,"cancelInnerEvents",[k_,g_,vJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),DJ=n_(TJ.prototype,"scrollEvents",[xJ,g_,k_,SJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RJ=n_(TJ.prototype,"pageTurningSpeed",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),MJ=n_(TJ.prototype,"pageEvents",[AJ,g_,CJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BJ=n_(TJ.prototype,"_sizeMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GJ.Unified}}),OJ=n_(TJ.prototype,"_direction",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HJ.Horizontal}}),NJ=n_(TJ.prototype,"_scrollThreshold",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),LJ=n_(TJ.prototype,"_pageTurningEventTiming",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),FJ=n_(TJ.prototype,"_indicator",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bJ=TJ))||bJ)||bJ)||bJ)||bJ));const WJ=new oi,qJ=new Ti,XJ=new Ti,YJ=new Ti(1,1),KJ=new Ti,JJ=new Ti;function $J(t,e){if(e._hadAlignOnce)return;e.alignMode===TK.ONCE&&(e._hadAlignOnce=!0);const i=e.target;let n;const s=XJ,r=YJ;i?(n=i,bK(t,n,s,r)):n=t.parent;const o=CK(n),a=n instanceof Sb||!n.getComponent(rB),l=a?qJ:n.getComponent(rB).anchorPoint,c=a;t.getPosition(WJ);const h=t._uiProps.uiTransformComp;let _=WJ.x,u=WJ.y;const m=h.anchorPoint,d=t.getScale();if(e.alignFlags&wK.HORIZONTAL){let t=0,n=0;const a=o.width;c?(t=Fv.left.x,n=Fv.right.x):(t=-l.x*a,n=t+a),t+=e.isAbsoluteLeft?e.left:e.left*a,n-=e.isAbsoluteRight?e.right:e.right*a,i&&(t+=s.x,t*=r.x,n+=s.x,n*=r.x);let u=0,p=m.x,f=d.x;if(f<0&&(p=1-p,f=-f),e.isStretchWidth)u=n-t,0!==f&&(h.width=u/f),_=t+p*u;else if(u=h.width*f,e.isAlignHorizontalCenter){let t=e.isAbsoluteHorizontalCenter?e.horizontalCenter:e.horizontalCenter*a,n=(.5-l.x)*o.width;i&&(t*=r.x,n+=s.x,n*=r.x),_=n+(p-.5)*u+t}else _=e.isAlignLeft?t+p*u:n+(p-1)*u;e._lastSize.width=u}if(e.alignFlags&wK.VERTICAL){let t=0,n=0;const a=o.height;c?(n=Fv.bottom.y,t=Fv.top.y):(n=-l.y*a,t=n+a),n+=e.isAbsoluteBottom?e.bottom:e.bottom*a,t-=e.isAbsoluteTop?e.top:e.top*a,i&&(n+=s.y,n*=r.y,t+=s.y,t*=r.y);let _=0,p=m.y,f=d.y;if(f<0&&(p=1-p,f=-f),e.isStretchHeight)_=t-n,0!==f&&(h.height=_/f),u=n+p*_;else if(_=h.height*f,e.isAlignVerticalCenter){let t=e.isAbsoluteVerticalCenter?e.verticalCenter:e.verticalCenter*a,n=(.5-l.y)*o.height;i&&(t*=r.y,n+=s.y,n*=r.y),u=n+(p-.5)*_+t}else u=e.isAlignBottom?n+p*_:t+(p-1)*_;e._lastSize.height=_}t.setPosition(_,u,WJ.z),oi.set(e._lastPos,_,u,WJ.z)}function ZJ(t){const e=t.getComponent(IK);if(e&&e.enabled){if(!n.isValid(t,!0))return;t$.push(e)}const i=t.children;for(const t of i)t.active&&ZJ(t)}function QJ(){const t=aT.getScene();if(t){e$.isAligning=!0,e$._nodesOrderDirty&&(t$.length=0,ZJ(t),e$._nodesOrderDirty=!1);let e=null;const i=e$._activeWidgetsIterator;for(i.i=0;i.i<t$.length;++i.i)e=t$[i.i],e._dirty&&($J(e.node,e),e._dirty=!1);e$.isAligning=!1}}const t$=[],e$=t("widgetManager",n._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new zt.MutableForwardIterator(t$),animationState:null,init(){aT.on(oT.EVENT_AFTER_UPDATE,QJ),Vv.instance.on("design-resolution-changed",this.onResized,this);{const t=this.onResized.bind(this);Vv.instance.on("canvas-resize",t),hn.onOrientationChange(t)}},add(t){this._nodesOrderDirty=!0},remove(t){this._activeWidgetsIterator.remove(t)},onResized(){const t=aT.getScene();t&&this.refreshWidgetOnResized(t)},refreshWidgetOnResized(t){const e=uf.isNode(t)&&t.getComponent(IK);e&&e.enabled&&(e.alignMode===TK.ON_WINDOW_RESIZE||e.alignMode===TK.ALWAYS)&&e.setDirty();const i=t.children;for(const t of i)this.refreshWidgetOnResized(t)},updateOffsetsToStayPut(t,e){function i(t,e){return Math.abs(t-e)>1e-10?e:t}const n=t.node;let s=n.parent;if(s){const r=KJ;r.set(0,0);const o=JJ;if(o.set(1,1),t.target&&(s=t.target,bK(n,s,r,o)),!e)return;const a=s._uiProps&&s._uiProps.uiTransformComp,l=a?a.anchorPoint:qJ,c=n._uiProps.uiTransformComp,h=CK(s),_=c.anchorPoint,u=n.getPosition(),m=wK,d=n.getScale();let p=0;if(e&m.LEFT){let e=-l.x*h.width;e+=r.x,e*=o.x,p=u.x-_.x*c.width*d.x-e,t.isAbsoluteLeft||(p/=h.width),p/=o.x,t.left=i(t.left,p)}if(e&m.RIGHT){let e=(1-l.x)*h.width;e+=r.x,p=(e*=o.x)-(u.x+(1-_.x)*c.width*d.x),t.isAbsoluteRight||(p/=h.width),p/=o.x,t.right=i(t.right,p)}if(e&m.TOP){let e=(1-l.y)*h.height;e+=r.y,p=(e*=o.y)-(u.y+(1-_.y)*c.height*d.y),t.isAbsoluteTop||(p/=h.height),p/=o.y,t.top=i(t.top,p)}if(e&m.BOT){let e=-l.y*h.height;e+=r.y,e*=o.y,p=u.y-_.y*c.height*d.y-e,t.isAbsoluteBottom||(p/=h.height),p/=o.y,t.bottom=i(t.bottom,p)}}},updateAlignment:function t(e){const i=e.parent;i&&uf.isNode(i)&&t(i);const n=e.getComponent(IK);n&&i&&$J(e,n)},AlignMode:TK,AlignFlags:wK});var i$;aT.on(oT.EVENT_INIT,(()=>{e$.init()}));let n$=function(e){return t({SafeArea:e,SafeAreaComponent:e}),e}(u_("cc.SafeArea")(i$=T_()(i$=d_(110)(i$=x_(i$=S_()(i$=m_(IK)(i$=class extends Nm{onLoad(){this._boundUpdateArea=this.updateArea.bind(this)}onEnable(){this.updateArea(),hn.onViewResize(this._boundUpdateArea),hn.onOrientationChange(this._boundUpdateArea)}onDisable(){hn.offViewResize(this._boundUpdateArea),hn.offOrientationChange(this._boundUpdateArea)}updateArea(){const t=this.node.getComponent(IK),e=this.node.getComponent(rB);if(!t||!e)return;t.updateAlignment();const i=this.node.position.clone(),s=e.anchorPoint.clone();t.isAlignTop=t.isAlignBottom=t.isAlignLeft=t.isAlignRight=!0;const r=n.winSize.width,o=n.winSize.height,a=Cy.getSafeAreaRect();t.top=o-a.y-a.height,t.bottom=a.y,t.left=a.x,t.right=r-a.x-a.width,t.updateAlignment();const l=this.node.position.clone(),c=s.x-(l.x-i.x)/e.width,h=s.y-(l.y-i.y)/e.height;e.setAnchorPoint(c,h),e$.add(t)}})||i$)||i$)||i$)||i$)||i$)||i$);var s$,r$,o$,a$,l$,c$,h$,_$,u$,m$,d$,p$,f$,g$,y$,v$,x$,S$,A$;let C$=function(e){return t({UICoordinateTracker:e,UICoordinateTrackerComponent:e}),e}((s$=u_("cc.UICoordinateTracker"),r$=T_(),o$=S_(),a$=d_(110),l$=H_(uf),c$=I_(),h$=H_(ZE),_$=I_(),u$=I_(),m$=I_(),d$=H_([Rw]),p$=I_(),s$(f$=r$(f$=o$(f$=a$((n_((g$=class extends Nm{constructor(...t){super(...t),i_(this,"syncEvents",y$,this),i_(this,"_target",v$,this),i_(this,"_camera",x$,this),i_(this,"_useScale",S$,this),i_(this,"_distance",A$,this),this._transformPos=new oi,this._viewPos=new oi,this._canMove=!0,this._lastWPos=new oi,this._lastCameraPos=new oi}get target(){return this._target}set target(t){this._target!==t&&(this._target=t,this._checkCanMove())}get camera(){return this._camera}set camera(t){this._camera!==t&&(this._camera=t,this._checkCanMove())}get useScale(){return this._useScale}set useScale(t){this._useScale!==t&&(this._useScale=t)}get distance(){return this._distance}set distance(t){this._distance!==t&&(this._distance=t)}onEnable(){this._checkCanMove()}update(){const t=this.node.worldPosition,e=this._camera;if(this._canMove&&e&&e.camera&&(!this._lastWPos.equals(t)||!this._lastCameraPos.equals(e.node.worldPosition))&&(this._lastWPos.set(t),this._lastCameraPos.set(e.node.worldPosition),e.camera.update(),e.convertToUINode(t,this._target,this._transformPos),this._useScale&&oi.transformMat4(this._viewPos,this.node.worldPosition,e.camera.matView),this.syncEvents.length>0)){const t=this._distance/Math.abs(this._viewPos.z);Rw.emitEvents(this.syncEvents,this._transformPos,t)}}_checkCanMove(){this._canMove=!(!this._camera||!this._target)}}).prototype,"target",[l$,c$],Object.getOwnPropertyDescriptor(g$.prototype,"target"),g$.prototype),n_(g$.prototype,"camera",[h$,_$],Object.getOwnPropertyDescriptor(g$.prototype,"camera"),g$.prototype),n_(g$.prototype,"useScale",[u$],Object.getOwnPropertyDescriptor(g$.prototype,"useScale"),g$.prototype),n_(g$.prototype,"distance",[m$],Object.getOwnPropertyDescriptor(g$.prototype,"distance"),g$.prototype),y$=n_(g$.prototype,"syncEvents",[d$,g_,p$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),v$=n_(g$.prototype,"_target",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x$=n_(g$.prototype,"_camera",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S$=n_(g$.prototype,"_useScale",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),A$=n_(g$.prototype,"_distance",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),f$=g$))||f$)||f$)||f$)||f$));var b$;const T$=[_p.TOUCH_START,_p.TOUCH_END,_p.TOUCH_MOVE,_p.MOUSE_DOWN,_p.MOUSE_MOVE,_p.MOUSE_UP,_p.MOUSE_ENTER,_p.MOUSE_LEAVE,_p.MOUSE_WHEEL];function w$(t){t.propagationStopped=!0}let E$=function(e){return t({BlockInputEvents:e,BlockInputEventsComponent:e}),e}(u_("cc.BlockInputEvents")(b$=T_()(b$=S_()(b$=class extends Nm{onEnable(){for(let t=0;t<T$.length;t++)this.node.on(T$[t],w$,this)}onDisable(){for(let t=0;t<T$.length;t++)this.node.off(T$[t],w$,this)}})||b$)||b$)||b$);const P$={};var I$,D$,R$,M$,B$,O$,N$,L$,F$,z$,V$;let U$=t("SubContextView",(I$=u_("cc.SubContextView"),D$=T_(),R$=d_(110),M$=m_(rB),B$=S_(),O$=I_(),N$=I_(),I$(L$=D$(L$=R$(L$=M$(L$=B$((n_((F$=class extends Nm{get designResolutionSize(){return this._designResolutionSize}set designResolutionSize(t){}get fps(){return this._fps}set fps(t){this._fps!==t&&(this._fps=t,this._updateInterval=1e3/t)}constructor(){super(),i_(this,"_fps",z$,this),this._sprite=void 0,this._imageAsset=void 0,this._updatedTime=0,this._updateInterval=0,this._openDataContext=void 0,this._content=void 0,i_(this,"_designResolutionSize",V$,this),this._content=new uf("content"),this._content.hideFlags|=Gi.Flags.DontSave|Gi.Flags.HideInHierarchy,this._sprite=null,this._imageAsset=new Ru,this._openDataContext=null,this._updatedTime=performance.now()}onLoad(){P$.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=P$.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1}onEnable(){this._registerNodeEvent()}onDisable(){this._unregisterNodeEvent()}_initSharedCanvas(){if(this._openDataContext){const t=this._openDataContext.canvas;t.width=this._designResolutionSize.width,t.height=this._designResolutionSize.height}}_initContentNode(){if(this._openDataContext){const t=this._openDataContext.canvas,e=this._imageAsset;if(e.reset(t),e._texture.create(t.width,t.height),this._sprite=this._content.getComponent(mF),this._sprite||(this._sprite=this._content.addComponent(mF)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._imageAsset._texture;else{const t=new zR;t.texture=this._imageAsset._texture,this._sprite.spriteFrame=t}this._content.parent=this.node}}_updateSubContextView(){if(!this._openDataContext||!P$.getSystemInfoSync)return;const t=this.node.getComponent(rB),e=this._content.getComponent(rB),i=t.width/e.width,n=t.height/e.height,s=i>n?n:i;e.width*=s,e.height*=s;const r=P$.getSystemInfoSync(),o=e.getBoundingBoxToWorld(),a=kv.getVisibleSize(),l=r.screenWidth*(o.x/a.width),c=r.screenHeight*(o.y/a.height),h=r.screenWidth*(o.width/a.width),_=r.screenHeight*(o.height/a.height);this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:c,width:h,height:_})}_updateSubContextTexture(){const t=this._imageAsset;if(!t||!this._openDataContext)return;if(t.width<=0||t.height<=0)return;const e=this._openDataContext.canvas;t.reset(e),(e.width>t.width||e.height>t.height)&&this._imageAsset._texture.create(e.width,e.height),this._imageAsset._texture.uploadData(e)}_registerNodeEvent(){this.node.on(uf.EventType.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(uf.EventType.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(_p.LAYER_CHANGED,this._updateContentLayer,this)}_unregisterNodeEvent(){this.node.off(uf.EventType.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(uf.EventType.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(_p.LAYER_CHANGED,this._updateContentLayer,this)}_updateContentLayer(){this._content.layer=this.node.layer}update(t){void 0!==t?performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture()):this._updateSubContextTexture()}}).prototype,"designResolutionSize",[O$],Object.getOwnPropertyDescriptor(F$.prototype,"designResolutionSize"),F$.prototype),n_(F$.prototype,"fps",[N$],Object.getOwnPropertyDescriptor(F$.prototype,"fps"),F$.prototype),z$=n_(F$.prototype,"_fps",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),V$=n_(F$.prototype,"_designResolutionSize",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(640,960)}}),L$=F$))||L$)||L$)||L$)||L$)||L$));var G$;n.SubContextView=U$;let H$,k$,j$=t("UIReorderComponent",u_("cc.UIReorderComponent")(G$=class{constructor(){C(1408,"UIReorderComponent")}})||G$);n.UIReorderComponent=j$,n.ButtonComponent=ik,Vt.setClassAlias(ik,"cc.ButtonComponent"),n.EditBoxComponent=hj,Vt.setClassAlias(hj,"cc.EditBoxComponent"),n.LayoutComponent=vW,Vt.setClassAlias(vW,"cc.LayoutComponent"),n.ProgressBarComponent=kW,Vt.setClassAlias(kW,"cc.ProgressBarComponent"),n.ScrollViewComponent=wX,Vt.setClassAlias(wX,"cc.ScrollViewComponent"),n.ScrollBarComponent=Sq,Vt.setClassAlias(Sq,"cc.ScrollBarComponent"),n.SliderComponent=JX,Vt.setClassAlias(JX,"cc.SliderComponent"),n.ToggleComponent=yY,Vt.setClassAlias(yY,"cc.ToggleComponent"),n.ToggleContainerComponent=DY,Vt.setClassAlias(DY,"cc.ToggleContainerComponent"),n.WidgetComponent=IK,Vt.setClassAlias(IK,"cc.WidgetComponent"),n.PageViewComponent=jJ,Vt.setClassAlias(jJ,"cc.PageViewComponent"),n.PageViewIndicatorComponent=$K,Vt.setClassAlias($K,"cc.PageViewIndicatorComponent"),n.SafeAreaComponent=n$,Vt.setClassAlias(n$,"cc.SafeAreaComponent"),Vt.setClassAlias(C$,"cc.UICoordinateTrackerComponent"),n.BlockInputEventsComponent=E$,Vt.setClassAlias(E$,"cc.BlockInputEventsComponent"),"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var W$,q$=function(t,e){return function(t,e){!function(t){function e(t,...e){if(!t)throw new Error(...e)}function i(t,e){return void 0!==t?t:e}const n=1e37,s=1e-5,r=s*s,o=3.14159265359,a=2,l=8,c=.1,h=2,_=.008,u=2/180*o,m=2*_,d=8,p=32,f=1,g=.2,y=8/180*o,v=2,x=v*v,S=.5*o,A=S*S,C=.2,b=.75,T=-1,w=2147483647,E=.75,P=1,I=.25,D=.5,R=2,M=R*R,B=256,O=2.5,N=.5,L=.01,F=2/180*o;function z(){return null}function V(){}function U(){}class G{constructor(t=0,e=0,i=0){this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=i}toString(){return this.major+"."+this.minor+"."+this.revision}}const H=new G(2,3,2),k="master",j="fbf51801d80fc389d43dc46524520e89043b6faf";function W(t){return parseInt(t,10)}function q(t){return Math.abs(parseInt(t,10))}function X(t,e){const i=new Array(t);for(let n=0;n<t;++n)i[n]=e(n);return i}function Y(t){const e=new Array(t);for(let i=0;i<t;++i)e[i]=null;return e}function K(t,e=0){const i=new Array(t);for(let n=0;n<t;++n)i[n]=e;return i}const J=o/180,$=180/o,Z=2*o,Q=Math.abs;function tt(t,e){return t<e?t:e}function et(t,e){return t>e?t:e}function it(t,e,i){return t<e?e:t>i?i:t}function nt(t,e){const i=t[0];t[0]=e[0],e[0]=i}const st=isFinite;function rt(t){return t*t}function ot(t){return 1/Math.sqrt(t)}const at=Math.sqrt,lt=Math.pow;function ct(t){return t*J}function ht(t){return t*$}const _t=Math.cos,ut=Math.sin,mt=Math.acos,dt=Math.asin,pt=Math.atan2;function ft(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,1+((t|=t>>8&16777215)|t>>16&65535)}function gt(t){return t>0&&0==(t&t-1)}function yt(){return 2*Math.random()-1}function vt(t,e){return(e-t)*Math.random()+t}class xt{constructor(...t){if(t[0]instanceof Float32Array){if(2!==t[0].length)throw new Error;this.data=t[0]}else{const e="number"==typeof t[0]?t[0]:0,i="number"==typeof t[1]?t[1]:0;this.data=new Float32Array([e,i])}}get x(){return this.data[0]}set x(t){this.data[0]=t}get y(){return this.data[1]}set y(t){this.data[1]=t}Clone(){return new xt(this.x,this.y)}SetZero(){return this.x=0,this.y=0,this}Set(t,e){return this.x=t,this.y=e,this}Copy(t){return this.x=t.x,this.y=t.y,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this}SelfAddXY(t,e){return this.x+=t,this.y+=e,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this}SelfSubXY(t,e){return this.x-=t,this.y-=e,this}SelfMul(t){return this.x*=t,this.y*=t,this}SelfMulAdd(t,e){return this.x+=t*e.x,this.y+=t*e.y,this}SelfMulSub(t,e){return this.x-=t*e.x,this.y-=t*e.y,this}Dot(t){return this.x*t.x+this.y*t.y}Cross(t){return this.x*t.y-this.y*t.x}Length(){const t=this.x,e=this.y;return Math.sqrt(t*t+e*e)}LengthSquared(){const t=this.x,e=this.y;return t*t+e*e}Normalize(){const t=this.Length();if(t>=s){const e=1/t;this.x*=e,this.y*=e}return t}SelfNormalize(){const t=this.Length();if(t>=s){const e=1/t;this.x*=e,this.y*=e}return this}SelfRotate(t){const e=Math.cos(t),i=Math.sin(t),n=this.x;return this.x=e*n-i*this.y,this.y=i*n+e*this.y,this}SelfRotateCosSin(t,e){const i=this.x;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this}IsValid(){return isFinite(this.x)&&isFinite(this.y)}SelfCrossVS(t){const e=this.x;return this.x=t*this.y,this.y=-t*e,this}SelfCrossSV(t){const e=this.x;return this.x=-t*this.y,this.y=t*e,this}SelfMinV(t){return this.x=tt(this.x,t.x),this.y=tt(this.y,t.y),this}SelfMaxV(t){return this.x=et(this.x,t.x),this.y=et(this.y,t.y),this}SelfAbs(){return this.x=Q(this.x),this.y=Q(this.y),this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this}SelfSkew(){const t=this.x;return this.x=-this.y,this.y=t,this}static MakeArray(t){return X(t,(()=>new xt))}static AbsV(t,e){return e.x=Q(t.x),e.y=Q(t.y),e}static MinV(t,e,i){return i.x=tt(t.x,e.x),i.y=tt(t.y,e.y),i}static MaxV(t,e,i){return i.x=et(t.x,e.x),i.y=et(t.y,e.y),i}static ClampV(t,e,i,n){return n.x=it(t.x,e.x,i.x),n.y=it(t.y,e.y,i.y),n}static RotateV(t,e,i){const n=t.x,s=t.y,r=Math.cos(e),o=Math.sin(e);return i.x=r*n-o*s,i.y=o*n+r*s,i}static DotVV(t,e){return t.x*e.x+t.y*e.y}static CrossVV(t,e){return t.x*e.y-t.y*e.x}static CrossVS(t,e,i){const n=t.x;return i.x=e*t.y,i.y=-e*n,i}static CrossVOne(t,e){const i=t.x;return e.x=t.y,e.y=-i,e}static CrossSV(t,e,i){const n=e.x;return i.x=-t*e.y,i.y=t*n,i}static CrossOneV(t,e){const i=t.x;return e.x=-t.y,e.y=i,e}static AddVV(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i}static SubVV(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i}static MulSV(t,e,i){return i.x=e.x*t,i.y=e.y*t,i}static MulVS(t,e,i){return i.x=t.x*e,i.y=t.y*e,i}static AddVMulSV(t,e,i,n){return n.x=t.x+e*i.x,n.y=t.y+e*i.y,n}static SubVMulSV(t,e,i,n){return n.x=t.x-e*i.x,n.y=t.y-e*i.y,n}static AddVCrossSV(t,e,i,n){const s=i.x;return n.x=t.x-e*i.y,n.y=t.y+e*s,n}static MidVV(t,e,i){return i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i}static ExtVV(t,e,i){return i.x=.5*(e.x-t.x),i.y=.5*(e.y-t.y),i}static IsEqualToV(t,e){return t.x===e.x&&t.y===e.y}static DistanceVV(t,e){const i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)}static DistanceSquaredVV(t,e){const i=t.x-e.x,n=t.y-e.y;return i*i+n*n}static NegV(t,e){return e.x=-t.x,e.y=-t.y,e}}xt.ZERO=new xt(0,0),xt.UNITX=new xt(1,0),xt.UNITY=new xt(0,1),xt.s_t0=new xt,xt.s_t1=new xt,xt.s_t2=new xt,xt.s_t3=new xt;const St=new xt(0,0);class At{constructor(...t){if(t[0]instanceof Float32Array){if(3!==t[0].length)throw new Error;this.data=t[0]}else{const e="number"==typeof t[0]?t[0]:0,i="number"==typeof t[1]?t[1]:0,n="number"==typeof t[2]?t[2]:0;this.data=new Float32Array([e,i,n])}}get x(){return this.data[0]}set x(t){this.data[0]=t}get y(){return this.data[1]}set y(t){this.data[1]=t}get z(){return this.data[2]}set z(t){this.data[2]=t}Clone(){return new At(this.x,this.y,this.z)}SetZero(){return this.x=0,this.y=0,this.z=0,this}SetXYZ(t,e,i){return this.x=t,this.y=e,this.z=i,this}Copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}SelfAddXYZ(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}SelfSubXYZ(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this}SelfMul(t){return this.x*=t,this.y*=t,this.z*=t,this}static DotV3V3(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static CrossV3V3(t,e,i){const n=t.x,s=t.y,r=t.z,o=e.x,a=e.y,l=e.z;return i.x=s*l-r*a,i.y=r*o-n*l,i.z=n*a-s*o,i}}At.ZERO=new At(0,0,0),At.s_t0=new At;class Ct{constructor(){this.data=new Float32Array([1,0,0,1]),this.ex=new xt(this.data.subarray(0,2)),this.ey=new xt(this.data.subarray(2,4))}Clone(){return(new Ct).Copy(this)}static FromVV(t,e){return(new Ct).SetVV(t,e)}static FromSSSS(t,e,i,n){return(new Ct).SetSSSS(t,e,i,n)}static FromAngle(t){return(new Ct).SetAngle(t)}SetSSSS(t,e,i,n){return this.ex.Set(t,i),this.ey.Set(e,n),this}SetVV(t,e){return this.ex.Copy(t),this.ey.Copy(e),this}SetAngle(t){const e=Math.cos(t),i=Math.sin(t);return this.ex.Set(e,i),this.ey.Set(-i,e),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this}SetIdentity(){return this.ex.Set(1,0),this.ey.Set(0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this}GetAngle(){return Math.atan2(this.ex.y,this.ex.x)}GetInverse(t){const e=this.ex.x,i=this.ey.x,n=this.ex.y,s=this.ey.y;let r=e*s-i*n;return 0!==r&&(r=1/r),t.ex.x=r*s,t.ey.x=-r*i,t.ex.y=-r*n,t.ey.y=r*e,t}Solve(t,e,i){const n=this.ex.x,s=this.ey.x,r=this.ex.y,o=this.ey.y;let a=n*o-s*r;return 0!==a&&(a=1/a),i.x=a*(o*t-s*e),i.y=a*(n*e-r*t),i}SelfAbs(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this}SelfInv(){return this.GetInverse(this),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this}SelfSubM(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this}static AbsM(t,e){const i=t.ex,n=t.ey;return e.ex.x=Q(i.x),e.ex.y=Q(i.y),e.ey.x=Q(n.x),e.ey.y=Q(n.y),e}static MulMV(t,e,i){const n=t.ex,s=t.ey,r=e.x,o=e.y;return i.x=n.x*r+s.x*o,i.y=n.y*r+s.y*o,i}static MulTMV(t,e,i){const n=t.ex,s=t.ey,r=e.x,o=e.y;return i.x=n.x*r+n.y*o,i.y=s.x*r+s.y*o,i}static AddMM(t,e,i){const n=t.ex,s=t.ey,r=e.ex,o=e.ey;return i.ex.x=n.x+r.x,i.ex.y=n.y+r.y,i.ey.x=s.x+o.x,i.ey.y=s.y+o.y,i}static MulMM(t,e,i){const n=t.ex.x,s=t.ex.y,r=t.ey.x,o=t.ey.y,a=e.ex.x,l=e.ex.y,c=e.ey.x,h=e.ey.y;return i.ex.x=n*a+r*l,i.ex.y=s*a+o*l,i.ey.x=n*c+r*h,i.ey.y=s*c+o*h,i}static MulTMM(t,e,i){const n=t.ex.x,s=t.ex.y,r=t.ey.x,o=t.ey.y,a=e.ex.x,l=e.ex.y,c=e.ey.x,h=e.ey.y;return i.ex.x=n*a+s*l,i.ex.y=r*a+o*l,i.ey.x=n*c+s*h,i.ey.y=r*c+o*h,i}}Ct.IDENTITY=new Ct;class bt{constructor(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new At(this.data.subarray(0,3)),this.ey=new At(this.data.subarray(3,6)),this.ez=new At(this.data.subarray(6,9))}Clone(){return(new bt).Copy(this)}SetVVV(t,e,i){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(i),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this}SetIdentity(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this}Solve33(t,e,i,n){const s=this.ex.x,r=this.ex.y,o=this.ex.z,a=this.ey.x,l=this.ey.y,c=this.ey.z,h=this.ez.x,_=this.ez.y,u=this.ez.z;let m=s*(l*u-c*_)+r*(c*h-a*u)+o*(a*_-l*h);return 0!==m&&(m=1/m),n.x=m*(t*(l*u-c*_)+e*(c*h-a*u)+i*(a*_-l*h)),n.y=m*(s*(e*u-i*_)+r*(i*h-t*u)+o*(t*_-e*h)),n.z=m*(s*(l*i-c*e)+r*(c*t-a*i)+o*(a*e-l*t)),n}Solve22(t,e,i){const n=this.ex.x,s=this.ey.x,r=this.ex.y,o=this.ey.y;let a=n*o-s*r;return 0!==a&&(a=1/a),i.x=a*(o*t-s*e),i.y=a*(n*e-r*t),i}GetInverse22(t){const e=this.ex.x,i=this.ey.x,n=this.ex.y,s=this.ey.y;let r=e*s-i*n;0!==r&&(r=1/r),t.ex.x=r*s,t.ey.x=-r*i,t.ex.z=0,t.ex.y=-r*n,t.ey.y=r*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0}GetSymInverse33(t){let e=At.DotV3V3(this.ex,At.CrossV3V3(this.ey,this.ez,At.s_t0));0!==e&&(e=1/e);const i=this.ex.x,n=this.ey.x,s=this.ez.x,r=this.ey.y,o=this.ez.y,a=this.ez.z;t.ex.x=e*(r*a-o*o),t.ex.y=e*(s*o-n*a),t.ex.z=e*(n*o-s*r),t.ey.x=t.ex.y,t.ey.y=e*(i*a-s*s),t.ey.z=e*(s*n-i*o),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*r-n*n)}static MulM33V3(t,e,i){const n=e.x,s=e.y,r=e.z;return i.x=t.ex.x*n+t.ey.x*s+t.ez.x*r,i.y=t.ex.y*n+t.ey.y*s+t.ez.y*r,i.z=t.ex.z*n+t.ey.z*s+t.ez.z*r,i}static MulM33XYZ(t,e,i,n,s){return s.x=t.ex.x*e+t.ey.x*i+t.ez.x*n,s.y=t.ex.y*e+t.ey.y*i+t.ez.y*n,s.z=t.ex.z*e+t.ey.z*i+t.ez.z*n,s}static MulM33V2(t,e,i){const n=e.x,s=e.y;return i.x=t.ex.x*n+t.ey.x*s,i.y=t.ex.y*n+t.ey.y*s,i}static MulM33XY(t,e,i,n){return n.x=t.ex.x*e+t.ey.x*i,n.y=t.ex.y*e+t.ey.y*i,n}}bt.IDENTITY=new bt;class Tt{constructor(t=0){this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}Clone(){return(new Tt).Copy(this)}Copy(t){return this.s=t.s,this.c=t.c,this}SetAngle(t){return this.s=Math.sin(t),this.c=Math.cos(t),this}SetIdentity(){return this.s=0,this.c=1,this}GetAngle(){return Math.atan2(this.s,this.c)}GetXAxis(t){return t.x=this.c,t.y=this.s,t}GetYAxis(t){return t.x=-this.s,t.y=this.c,t}static MulRR(t,e,i){const n=t.c,s=t.s,r=e.c,o=e.s;return i.s=s*r+n*o,i.c=n*r-s*o,i}static MulTRR(t,e,i){const n=t.c,s=t.s,r=e.c,o=e.s;return i.s=n*o-s*r,i.c=n*r+s*o,i}static MulRV(t,e,i){const n=t.c,s=t.s,r=e.x,o=e.y;return i.x=n*r-s*o,i.y=s*r+n*o,i}static MulTRV(t,e,i){const n=t.c,s=t.s,r=e.x,o=e.y;return i.x=n*r+s*o,i.y=-s*r+n*o,i}}Tt.IDENTITY=new Tt;class wt{constructor(){this.p=new xt,this.q=new Tt}Clone(){return(new wt).Copy(this)}Copy(t){return this.p.Copy(t.p),this.q.Copy(t.q),this}SetIdentity(){return this.p.SetZero(),this.q.SetIdentity(),this}SetPositionRotation(t,e){return this.p.Copy(t),this.q.Copy(e),this}SetPositionAngle(t,e){return this.p.Copy(t),this.q.SetAngle(e),this}SetPosition(t){return this.p.Copy(t),this}SetPositionXY(t,e){return this.p.Set(t,e),this}SetRotation(t){return this.q.Copy(t),this}SetRotationAngle(t){return this.q.SetAngle(t),this}GetPosition(){return this.p}GetRotation(){return this.q}GetRotationAngle(){return this.q.GetAngle()}GetAngle(){return this.q.GetAngle()}static MulXV(t,e,i){const n=t.q.c,s=t.q.s,r=e.x,o=e.y;return i.x=n*r-s*o+t.p.x,i.y=s*r+n*o+t.p.y,i}static MulTXV(t,e,i){const n=t.q.c,s=t.q.s,r=e.x-t.p.x,o=e.y-t.p.y;return i.x=n*r+s*o,i.y=-s*r+n*o,i}static MulXX(t,e,i){return Tt.MulRR(t.q,e.q,i.q),xt.AddVV(Tt.MulRV(t.q,e.p,i.p),t.p,i.p),i}static MulTXX(t,e,i){return Tt.MulTRR(t.q,e.q,i.q),Tt.MulTRV(t.q,xt.SubVV(e.p,t.p,i.p),i.p),i}}wt.IDENTITY=new wt;class Et{constructor(){this.localCenter=new xt,this.c0=new xt,this.c=new xt,this.a0=0,this.a=0,this.alpha0=0}Clone(){return(new Et).Copy(this)}Copy(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this}GetTransform(t,e){const i=1-e;t.p.x=i*this.c0.x+e*this.c.x,t.p.y=i*this.c0.y+e*this.c.y;const n=i*this.a0+e*this.a;return t.q.SetAngle(n),t.p.SelfSub(Tt.MulRV(t.q,this.localCenter,xt.s_t0)),t}Advance(t){const e=(t-this.alpha0)/(1-this.alpha0),i=1-e;this.c0.x=i*this.c0.x+e*this.c.x,this.c0.y=i*this.c0.y+e*this.c.y,this.a0=i*this.a0+e*this.a,this.alpha0=t}Normalize(){const t=Z*Math.floor(this.a0/Z);this.a0-=t,this.a-=t}}class Pt{constructor(...t){if(t[0]instanceof Float32Array){if(4!==t[0].length)throw new Error;this.data=t[0]}else{const e="number"==typeof t[0]?t[0]:.5,i="number"==typeof t[1]?t[1]:.5,n="number"==typeof t[2]?t[2]:.5,s="number"==typeof t[3]?t[3]:1;this.data=new Float32Array([e,i,n,s])}}get r(){return this.data[0]}set r(t){this.data[0]=t}get g(){return this.data[1]}set g(t){this.data[1]=t}get b(){return this.data[2]}set b(t){this.data[2]=t}get a(){return this.data[3]}set a(t){this.data[3]=t}Clone(){return(new Pt).Copy(this)}Copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}IsEqual(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}IsZero(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a}Set(t,e,i,n=this.a){this.SetRGBA(t,e,i,n)}SetByteRGB(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this}SetByteRGBA(t,e,i,n){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=n/255,this}SetRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}SetRGBA(t,e,i,n){return this.r=t,this.g=e,this.b=i,this.a=n,this}SelfAdd(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this}Add(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e}SelfSub(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this}Sub(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e}SelfMul(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this}Mul(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e}Mix(t,e){Pt.MixColors(this,t,e)}static MixColors(t,e,i){const n=i*(e.r-t.r),s=i*(e.g-t.g),r=i*(e.b-t.b),o=i*(e.a-t.a);t.r+=n,t.g+=s,t.b+=r,t.a+=o,e.r-=n,e.g-=s,e.b-=r,e.a-=o}MakeStyleString(t=this.a){return Pt.MakeStyleString(this.r,this.g,this.b,t)}static MakeStyleString(t,e,i,n=1){return t*=255,e*=255,i*=255,n<1?`rgba(${t},${e},${i},${n})`:`rgb(${t},${e},${i})`}}var It;Pt.ZERO=new Pt(0,0,0,0),Pt.RED=new Pt(1,0,0),Pt.GREEN=new Pt(0,1,0),Pt.BLUE=new Pt(0,0,1),(It=t.b2DrawFlags||(t.b2DrawFlags={}))[It.e_none=0]="e_none",It[It.e_shapeBit=1]="e_shapeBit",It[It.e_jointBit=2]="e_jointBit",It[It.e_aabbBit=4]="e_aabbBit",It[It.e_pairBit=8]="e_pairBit",It[It.e_centerOfMassBit=16]="e_centerOfMassBit",It[It.e_particleBit=32]="e_particleBit",It[It.e_controllerBit=64]="e_controllerBit",It[It.e_all=63]="e_all";class Dt{constructor(){this.m_drawFlags=0}SetFlags(t){this.m_drawFlags=t}GetFlags(){return this.m_drawFlags}AppendFlags(t){this.m_drawFlags|=t}ClearFlags(t){this.m_drawFlags&=~t}}class Rt{constructor(){this.m_start=Date.now()}Reset(){return this.m_start=Date.now(),this}GetMilliseconds(){return Date.now()-this.m_start}}class Mt{constructor(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}GetCount(){return this.m_count}GetMinCount(){return this.m_min_count}GetMaxCount(){return this.m_max_count}ResetCount(){const t=this.m_count;return this.m_count=0,t}ResetMinCount(){this.m_min_count=0}ResetMaxCount(){this.m_max_count=0}Increment(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)}Decrement(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)}}class Bt{constructor(t){this.m_stack=[],this.m_count=0,this.m_stack=X(t,(()=>null)),this.m_count=0}Reset(){return this.m_count=0,this}Push(t){this.m_stack[this.m_count]=t,this.m_count++}Pop(){this.m_count--;const t=this.m_stack[this.m_count];if(this.m_stack[this.m_count]=null,null===t)throw new Error;return t}GetCount(){return this.m_count}}class Ot{}class Nt{}class Lt{constructor(){this.m_buffer=xt.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}Copy(t){return t.m_vertices===t.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(t.m_buffer[0]),this.m_buffer[1].Copy(t.m_buffer[1])):this.m_vertices=t.m_vertices,this.m_count=t.m_count,this.m_radius=t.m_radius,this}Reset(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this}SetShape(t,e){t.SetupDistanceProxy(this,e)}SetVerticesRadius(t,e,i){this.m_vertices=t,this.m_count=e,this.m_radius=i}GetSupport(t){let e=0,i=xt.DotVV(this.m_vertices[0],t);for(let n=1;n<this.m_count;++n){const s=xt.DotVV(this.m_vertices[n],t);s>i&&(e=n,i=s)}return e}GetSupportVertex(t){let e=0,i=xt.DotVV(this.m_vertices[0],t);for(let n=1;n<this.m_count;++n){const s=xt.DotVV(this.m_vertices[n],t);s>i&&(e=n,i=s)}return this.m_vertices[e]}GetVertexCount(){return this.m_count}GetVertex(t){return this.m_vertices[t]}}class Ft{constructor(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}Reset(){return this.metric=0,this.count=0,this}}class zt{constructor(){this.proxyA=new Lt,this.proxyB=new Lt,this.transformA=new wt,this.transformB=new wt,this.useRadii=!1}Reset(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this}}class Vt{constructor(){this.pointA=new xt,this.pointB=new xt,this.distance=0,this.iterations=0}Reset(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this}}class Ut{constructor(){this.proxyA=new Lt,this.proxyB=new Lt,this.transformA=new wt,this.transformB=new wt,this.translationB=new xt}}class Gt{constructor(){this.point=new xt,this.normal=new xt,this.lambda=0,this.iterations=0}}function Ht(){t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0}t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0;class kt{constructor(){this.wA=new xt,this.wB=new xt,this.w=new xt,this.a=0,this.indexA=0,this.indexB=0}Copy(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this}}class jt{constructor(){this.m_v1=new kt,this.m_v2=new kt,this.m_v3=new kt,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}ReadCache(t,e,i,n,r){this.m_count=t.count;const o=this.m_vertices;for(let s=0;s<this.m_count;++s){const a=o[s];a.indexA=t.indexA[s],a.indexB=t.indexB[s];const l=e.GetVertex(a.indexA),c=n.GetVertex(a.indexB);wt.MulXV(i,l,a.wA),wt.MulXV(r,c,a.wB),xt.SubVV(a.wB,a.wA,a.w),a.a=0}if(this.m_count>1){const e=t.metric,i=this.GetMetric();(i<.5*e||2*e<i||i<s)&&(this.m_count=0)}if(0===this.m_count){const t=o[0];t.indexA=0,t.indexB=0;const s=e.GetVertex(0),a=n.GetVertex(0);wt.MulXV(i,s,t.wA),wt.MulXV(r,a,t.wB),xt.SubVV(t.wB,t.wA,t.w),t.a=1,this.m_count=1}}WriteCache(t){t.metric=this.GetMetric(),t.count=this.m_count;const e=this.m_vertices;for(let i=0;i<this.m_count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB}GetSearchDirection(t){switch(this.m_count){case 1:return xt.NegV(this.m_v1.w,t);case 2:{const e=xt.SubVV(this.m_v2.w,this.m_v1.w,t);return xt.CrossVV(e,xt.NegV(this.m_v1.w,xt.s_t0))>0?xt.CrossOneV(e,t):xt.CrossVOne(e,t)}default:return t.SetZero()}}GetClosestPoint(t){switch(this.m_count){case 0:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);case 3:default:return t.SetZero()}}GetWitnessPoints(t,e){switch(this.m_count){case 0:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}}GetMetric(){switch(this.m_count){case 0:case 1:return 0;case 2:return xt.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return xt.CrossVV(xt.SubVV(this.m_v2.w,this.m_v1.w,xt.s_t0),xt.SubVV(this.m_v3.w,this.m_v1.w,xt.s_t1));default:return 0}}Solve2(){const t=this.m_v1.w,e=this.m_v2.w,i=xt.SubVV(e,t,jt.s_e12),n=-xt.DotVV(t,i);if(n<=0)return this.m_v1.a=1,void(this.m_count=1);const s=xt.DotVV(e,i);if(s<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);const r=1/(s+n);this.m_v1.a=s*r,this.m_v2.a=n*r,this.m_count=2}Solve3(){const t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w,n=xt.SubVV(e,t,jt.s_e12),s=xt.DotVV(t,n),r=xt.DotVV(e,n),o=-s,a=xt.SubVV(i,t,jt.s_e13),l=xt.DotVV(t,a),c=xt.DotVV(i,a),h=-l,_=xt.SubVV(i,e,jt.s_e23),u=xt.DotVV(e,_),m=xt.DotVV(i,_),d=-u,p=xt.CrossVV(n,a),f=p*xt.CrossVV(e,i),g=p*xt.CrossVV(i,t),y=p*xt.CrossVV(t,e);if(o<=0&&h<=0)return this.m_v1.a=1,void(this.m_count=1);if(r>0&&o>0&&y<=0){const t=1/(r+o);return this.m_v1.a=r*t,this.m_v2.a=o*t,void(this.m_count=2)}if(c>0&&h>0&&g<=0){const t=1/(c+h);return this.m_v1.a=c*t,this.m_v3.a=h*t,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(r<=0&&d<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(c<=0&&m<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(m>0&&d>0&&f<=0){const t=1/(m+d);return this.m_v2.a=m*t,this.m_v3.a=d*t,this.m_count=2,void this.m_v1.Copy(this.m_v3)}const v=1/(f+g+y);this.m_v1.a=f*v,this.m_v2.a=g*v,this.m_v3.a=y*v,this.m_count=3}}jt.s_e12=new xt,jt.s_e13=new xt,jt.s_e23=new xt;const Wt=new jt,qt=[0,0,0],Xt=[0,0,0],Yt=new xt,Kt=new xt,Jt=new xt,$t=new xt,Zt=new xt;function Qt(e,i,n){++t.b2_gjkCalls;const o=n.proxyA,a=n.proxyB,l=n.transformA,c=n.transformB,h=Wt;h.ReadCache(i,o,l,a,c);const _=h.m_vertices,u=20,m=qt,d=Xt;let p=0,f=0;for(;f<u;){p=h.m_count;for(let t=0;t<p;++t)m[t]=_[t].indexA,d[t]=_[t].indexB;switch(h.m_count){case 1:break;case 2:h.Solve2();break;case 3:h.Solve3()}if(3===h.m_count)break;const e=h.GetSearchDirection(Kt);if(e.LengthSquared()<r)break;const i=_[h.m_count];i.indexA=o.GetSupport(Tt.MulTRV(l.q,xt.NegV(e,xt.s_t0),$t)),wt.MulXV(l,o.GetVertex(i.indexA),i.wA),i.indexB=a.GetSupport(Tt.MulTRV(c.q,e,Zt)),wt.MulXV(c,a.GetVertex(i.indexB),i.wB),xt.SubVV(i.wB,i.wA,i.w),++f,++t.b2_gjkIters;let n=!1;for(let t=0;t<p;++t)if(i.indexA===m[t]&&i.indexB===d[t]){n=!0;break}if(n)break;++h.m_count}if(t.b2_gjkMaxIters=et(t.b2_gjkMaxIters,f),h.GetWitnessPoints(e.pointA,e.pointB),e.distance=xt.DistanceVV(e.pointA,e.pointB),e.iterations=f,h.WriteCache(i),n.useRadii){const t=o.m_radius,i=a.m_radius;if(e.distance>t+i&&e.distance>s){e.distance-=t+i;const n=xt.SubVV(e.pointB,e.pointA,Jt);n.Normalize(),e.pointA.SelfMulAdd(t,n),e.pointB.SelfMulSub(i,n)}else{const t=xt.MidVV(e.pointA,e.pointB,Yt);e.pointA.Copy(t),e.pointB.Copy(t),e.distance=0}}}const te=new xt,ee=new jt,ie=new xt,ne=new xt,se=new xt,re=new xt,oe=new xt,ae=new xt;function le(t,e){t.iterations=0,t.lambda=1,t.normal.SetZero(),t.point.SetZero();const i=e.proxyA,n=e.proxyB,s=et(i.m_radius,m)+et(n.m_radius,m),r=e.transformA,o=e.transformB,a=e.translationB,l=te.Set(0,0);let c=0;const h=ee;h.m_count=0;const u=h.m_vertices;let d=i.GetSupport(Tt.MulTRV(r.q,xt.NegV(a,xt.s_t1),xt.s_t0)),p=wt.MulXV(r,i.GetVertex(d),ie),f=n.GetSupport(Tt.MulTRV(o.q,a,xt.s_t0)),g=wt.MulXV(o,n.GetVertex(f),ne);const y=xt.SubVV(p,g,se),v=et(m,s-m),x=.5*_,S=20;let A=0;for(;A<S&&Q(y.Length()-v)>x;){t.iterations+=1,d=i.GetSupport(Tt.MulTRV(r.q,xt.NegV(y,xt.s_t1),xt.s_t0)),p=wt.MulXV(r,i.GetVertex(d),ie),f=n.GetSupport(Tt.MulTRV(o.q,y,xt.s_t0)),g=wt.MulXV(o,n.GetVertex(f),ne);const e=xt.SubVV(p,g,re);y.Normalize();const s=xt.DotVV(y,e),_=xt.DotVV(y,a);if(s-v>c*_){if(_<=0)return!1;if(c=(s-v)/_,c>1)return!1;l.Copy(y).SelfNeg(),h.m_count=0}const m=u[h.m_count];switch(m.indexA=f,m.wA.Copy(g).SelfMulAdd(c,a),m.indexB=d,m.wB.Copy(p),m.w.Copy(m.wB).SelfSub(m.wA),m.a=1,h.m_count+=1,h.m_count){case 1:break;case 2:h.Solve2();break;case 3:h.Solve3()}if(3===h.m_count)return!1;h.GetClosestPoint(y),++A}const C=oe,b=ae;return h.GetWitnessPoints(C,b),y.LengthSquared()>0&&(l.Copy(y).SelfNeg(),l.Normalize()),t.normal.Copy(l),t.lambda=c,t.iterations=A,!0}var ce,he,_e;(ce=t.b2ContactFeatureType||(t.b2ContactFeatureType={}))[ce.e_vertex=0]="e_vertex",ce[ce.e_face=1]="e_face";class ue{constructor(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}get key(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key}set key(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}get indexA(){return this._indexA}set indexA(t){this._indexA=t,this._key_invalid=!0}get indexB(){return this._indexB}set indexB(t){this._indexB=t,this._key_invalid=!0}get typeA(){return this._typeA}set typeA(t){this._typeA=t,this._key_invalid=!0}get typeB(){return this._typeB}set typeB(t){this._typeB=t,this._key_invalid=!0}}class me{constructor(){this.cf=new ue}Copy(t){return this.key=t.key,this}Clone(){return(new me).Copy(this)}get key(){return this.cf.key}set key(t){this.cf.key=t}}class de{constructor(){this.localPoint=new xt,this.normalImpulse=0,this.tangentImpulse=0,this.id=new me}static MakeArray(t){return X(t,(()=>new de))}Reset(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0}Copy(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this}}(he=t.b2ManifoldType||(t.b2ManifoldType={}))[he.e_unknown=-1]="e_unknown",he[he.e_circles=0]="e_circles",he[he.e_faceA=1]="e_faceA",he[he.e_faceB=2]="e_faceB";class pe{constructor(){this.points=de.MakeArray(a),this.localNormal=new xt,this.localPoint=new xt,this.type=t.b2ManifoldType.e_unknown,this.pointCount=0}Reset(){for(let t=0;t<a;++t)this.points[t].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=t.b2ManifoldType.e_unknown,this.pointCount=0}Copy(t){this.pointCount=t.pointCount;for(let e=0;e<a;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this}Clone(){return(new pe).Copy(this)}}class fe{constructor(){this.normal=new xt,this.points=xt.MakeArray(a),this.separations=K(a)}Initialize(e,i,n,s,o){if(0!==e.pointCount)switch(e.type){case t.b2ManifoldType.e_circles:{this.normal.Set(1,0);const t=wt.MulXV(i,e.localPoint,fe.Initialize_s_pointA),a=wt.MulXV(s,e.points[0].localPoint,fe.Initialize_s_pointB);xt.DistanceSquaredVV(t,a)>r&&xt.SubVV(a,t,this.normal).SelfNormalize();const l=xt.AddVMulSV(t,n,this.normal,fe.Initialize_s_cA),c=xt.SubVMulSV(a,o,this.normal,fe.Initialize_s_cB);xt.MidVV(l,c,this.points[0]),this.separations[0]=xt.DotVV(xt.SubVV(c,l,xt.s_t0),this.normal);break}case t.b2ManifoldType.e_faceA:{Tt.MulRV(i.q,e.localNormal,this.normal);const t=wt.MulXV(i,e.localPoint,fe.Initialize_s_planePoint);for(let i=0;i<e.pointCount;++i){const r=wt.MulXV(s,e.points[i].localPoint,fe.Initialize_s_clipPoint),a=n-xt.DotVV(xt.SubVV(r,t,xt.s_t0),this.normal),l=xt.AddVMulSV(r,a,this.normal,fe.Initialize_s_cA),c=xt.SubVMulSV(r,o,this.normal,fe.Initialize_s_cB);xt.MidVV(l,c,this.points[i]),this.separations[i]=xt.DotVV(xt.SubVV(c,l,xt.s_t0),this.normal)}break}case t.b2ManifoldType.e_faceB:{Tt.MulRV(s.q,e.localNormal,this.normal);const t=wt.MulXV(s,e.localPoint,fe.Initialize_s_planePoint);for(let s=0;s<e.pointCount;++s){const r=wt.MulXV(i,e.points[s].localPoint,fe.Initialize_s_clipPoint),a=o-xt.DotVV(xt.SubVV(r,t,xt.s_t0),this.normal),l=xt.AddVMulSV(r,a,this.normal,fe.Initialize_s_cB),c=xt.SubVMulSV(r,n,this.normal,fe.Initialize_s_cA);xt.MidVV(c,l,this.points[s]),this.separations[s]=xt.DotVV(xt.SubVV(c,l,xt.s_t0),this.normal)}this.normal.SelfNeg();break}}}}function ge(e,i,n,s){let r;for(r=0;r<n.pointCount;++r){const i=n.points[r].id.key;e[r]=t.b2PointState.b2_removeState;for(let n=0,o=s.pointCount;n<o;++n)if(s.points[n].id.key===i){e[r]=t.b2PointState.b2_persistState;break}}for(;r<a;++r)e[r]=t.b2PointState.b2_nullState;for(r=0;r<s.pointCount;++r){const e=s.points[r].id.key;i[r]=t.b2PointState.b2_addState;for(let s=0,o=n.pointCount;s<o;++s)if(n.points[s].id.key===e){i[r]=t.b2PointState.b2_persistState;break}}for(;r<a;++r)i[r]=t.b2PointState.b2_nullState}fe.Initialize_s_pointA=new xt,fe.Initialize_s_pointB=new xt,fe.Initialize_s_cA=new xt,fe.Initialize_s_cB=new xt,fe.Initialize_s_planePoint=new xt,fe.Initialize_s_clipPoint=new xt,(_e=t.b2PointState||(t.b2PointState={}))[_e.b2_nullState=0]="b2_nullState",_e[_e.b2_addState=1]="b2_addState",_e[_e.b2_persistState=2]="b2_persistState",_e[_e.b2_removeState=3]="b2_removeState";class ye{constructor(){this.v=new xt,this.id=new me}static MakeArray(t){return X(t,(()=>new ye))}Copy(t){return this.v.Copy(t.v),this.id.Copy(t.id),this}}class ve{constructor(){this.p1=new xt,this.p2=new xt,this.maxFraction=1}Copy(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this}}class xe{constructor(){this.normal=new xt,this.fraction=0}Copy(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this}}class Se{constructor(){this.lowerBound=new xt,this.upperBound=new xt,this.m_cache_center=new xt,this.m_cache_extent=new xt}Copy(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this}IsValid(){return!(!this.lowerBound.IsValid()||!this.upperBound.IsValid()||this.upperBound.x<this.lowerBound.x||this.upperBound.y<this.lowerBound.y)}GetCenter(){return xt.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)}GetExtents(){return xt.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)}GetPerimeter(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))}Combine1(t){return this.lowerBound.x=tt(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=tt(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=et(this.upperBound.x,t.upperBound.x),this.upperBound.y=et(this.upperBound.y,t.upperBound.y),this}Combine2(t,e){return this.lowerBound.x=tt(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=tt(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=et(t.upperBound.x,e.upperBound.x),this.upperBound.y=et(t.upperBound.y,e.upperBound.y),this}static Combine(t,e,i){return i.Combine2(t,e),i}Contains(t){return!(this.lowerBound.x<=t.lowerBound.x||this.lowerBound.y<=t.lowerBound.y||t.upperBound.x<=this.upperBound.x||t.upperBound.y<=this.upperBound.y)}RayCast(t,e){let i=-n,r=n;const o=e.p1.x,a=e.p1.y,l=e.p2.x-e.p1.x,c=e.p2.y-e.p1.y,h=Q(l),_=Q(c),u=t.normal;if(h<s){if(o<this.lowerBound.x||this.upperBound.x<o)return!1}else{const t=1/l;let e=(this.lowerBound.x-o)*t,n=(this.upperBound.x-o)*t,s=-1;if(e>n){const t=e;e=n,n=t,s=1}if(e>i&&(u.x=s,u.y=0,i=e),r=tt(r,n),i>r)return!1}if(_<s){if(a<this.lowerBound.y||this.upperBound.y<a)return!1}else{const t=1/c;let e=(this.lowerBound.y-a)*t,n=(this.upperBound.y-a)*t,s=-1;if(e>n){const t=e;e=n,n=t,s=1}if(e>i&&(u.x=0,u.y=s,i=e),r=tt(r,n),i>r)return!1}return!(i<0||e.maxFraction<i||(t.fraction=i,0))}TestContain(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x||t.y<this.lowerBound.y||this.upperBound.y<t.y)}TestOverlap(t){return!(this.upperBound.x<t.lowerBound.x||this.upperBound.y<t.lowerBound.y||t.upperBound.x<this.lowerBound.x||t.upperBound.y<this.lowerBound.y)}}function Ae(t,e){return!(t.upperBound.x<e.lowerBound.x||t.upperBound.y<e.lowerBound.y||e.upperBound.x<t.lowerBound.x||e.upperBound.y<t.lowerBound.y)}function Ce(e,i,n,s,r){let o=0;const a=i[0],l=i[1],c=xt.DotVV(n,a.v)-s,h=xt.DotVV(n,l.v)-s;if(c<=0&&e[o++].Copy(a),h<=0&&e[o++].Copy(l),c*h<0){const i=c/(c-h),n=e[o].v;n.x=a.v.x+i*(l.v.x-a.v.x),n.y=a.v.y+i*(l.v.y-a.v.y);const s=e[o].id;s.cf.indexA=r,s.cf.indexB=a.id.cf.indexB,s.cf.typeA=t.b2ContactFeatureType.e_vertex,s.cf.typeB=t.b2ContactFeatureType.e_face,++o}return o}const be=new zt,Te=new Ft,we=new Vt;function Ee(t,e,i,n,r,o){const a=be.Reset();a.proxyA.SetShape(t,e),a.proxyB.SetShape(i,n),a.transformA.Copy(r),a.transformB.Copy(o),a.useRadii=!0;const l=Te.Reset();l.count=0;const c=we.Reset();return Qt(c,l,a),c.distance<10*s}function Pe(t){if(null===t)throw new Error;return t}class Ie{constructor(t=0){this.m_id=0,this.aabb=new Se,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=t}get userData(){if(null===this._userData)throw new Error;return this._userData}set userData(t){if(null!==this._userData)throw new Error;this._userData=t}Reset(){this._userData=null}IsLeaf(){return null===this.child1}}class De{constructor(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0,this.m_stack=new Bt(256)}Query(t,e){const i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){const n=i.Pop();if(null!==n&&n.aabb.TestOverlap(t))if(n.IsLeaf()){if(!e(n))return}else i.Push(n.child1),i.Push(n.child2)}}QueryPoint(t,e){const i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){const n=i.Pop();if(null!==n&&n.aabb.TestContain(t))if(n.IsLeaf()){if(!e(n))return}else i.Push(n.child1),i.Push(n.child2)}}RayCast(t,e){const i=t.p1,n=t.p2,s=xt.SubVV(n,i,De.s_r);s.Normalize();const r=xt.CrossOneV(s,De.s_v),o=xt.AbsV(r,De.s_abs_v);let a=t.maxFraction;const l=De.s_segmentAABB;let c=i.x+a*(n.x-i.x),h=i.y+a*(n.y-i.y);l.lowerBound.x=tt(i.x,c),l.lowerBound.y=tt(i.y,h),l.upperBound.x=et(i.x,c),l.upperBound.y=et(i.y,h);const _=this.m_stack.Reset();for(_.Push(this.m_root);_.GetCount()>0;){const s=_.Pop();if(null===s)continue;if(!Ae(s.aabb,l))continue;const u=s.aabb.GetCenter(),m=s.aabb.GetExtents();if(!(Q(xt.DotVV(r,xt.SubVV(i,u,xt.s_t0)))-xt.DotVV(o,m)>0))if(s.IsLeaf()){const r=De.s_subInput;r.p1.Copy(t.p1),r.p2.Copy(t.p2),r.maxFraction=a;const o=e(r,s);if(0===o)return;o>0&&(a=o,c=i.x+a*(n.x-i.x),h=i.y+a*(n.y-i.y),l.lowerBound.x=tt(i.x,c),l.lowerBound.y=tt(i.y,h),l.upperBound.x=et(i.x,c),l.upperBound.y=et(i.y,h))}else _.Push(s.child1),_.Push(s.child2)}}AllocateNode(){if(null!==this.m_freeList){const t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t.height=0,t}return new Ie(De.s_node_id++)}FreeNode(t){t.parent=this.m_freeList,t.child1=null,t.child2=null,t.height=-1,t.Reset(),this.m_freeList=t}CreateProxy(t,e){const i=this.AllocateNode(),n=c,s=c;return i.aabb.lowerBound.x=t.lowerBound.x-n,i.aabb.lowerBound.y=t.lowerBound.y-s,i.aabb.upperBound.x=t.upperBound.x+n,i.aabb.upperBound.y=t.upperBound.y+s,i.userData=e,i.height=0,this.InsertLeaf(i),i}DestroyProxy(t){this.RemoveLeaf(t),this.FreeNode(t)}MoveProxy(t,e,i){if(t.aabb.Contains(e))return!1;this.RemoveLeaf(t);const n=c,s=c;t.aabb.lowerBound.x=e.lowerBound.x-n,t.aabb.lowerBound.y=e.lowerBound.y-s,t.aabb.upperBound.x=e.upperBound.x+n,t.aabb.upperBound.y=e.upperBound.y+s;const r=h*i.x,o=h*i.y;return r<0?t.aabb.lowerBound.x+=r:t.aabb.upperBound.x+=r,o<0?t.aabb.lowerBound.y+=o:t.aabb.upperBound.y+=o,this.InsertLeaf(t),!0}InsertLeaf(t){if(++this.m_insertionCount,null===this.m_root)return this.m_root=t,void(this.m_root.parent=null);const e=t.aabb;let i=this.m_root;for(;!i.IsLeaf();){const t=Pe(i.child1),n=Pe(i.child2),s=i.aabb.GetPerimeter(),r=De.s_combinedAABB;r.Combine2(i.aabb,e);const o=r.GetPerimeter(),a=2*o,l=2*(o-s);let c;const h=De.s_aabb;let _,u,m;if(t.IsLeaf()?(h.Combine2(e,t.aabb),c=h.GetPerimeter()+l):(h.Combine2(e,t.aabb),_=t.aabb.GetPerimeter(),u=h.GetPerimeter(),c=u-_+l),n.IsLeaf()?(h.Combine2(e,n.aabb),m=h.GetPerimeter()+l):(h.Combine2(e,n.aabb),_=n.aabb.GetPerimeter(),u=h.GetPerimeter(),m=u-_+l),a<c&&a<m)break;i=c<m?t:n}const n=i.parent,s=this.AllocateNode();s.parent=n,s.aabb.Combine2(e,i.aabb),s.height=i.height+1,null!==n?(n.child1===i?n.child1=s:n.child2=s,s.child1=i,s.child2=t,i.parent=s,t.parent=s):(s.child1=i,s.child2=t,i.parent=s,t.parent=s,this.m_root=s);let r=t.parent;for(;null!==r;){r=this.Balance(r);const t=Pe(r.child1),e=Pe(r.child2);r.height=1+et(t.height,e.height),r.aabb.Combine2(t.aabb,e.aabb),r=r.parent}}RemoveLeaf(t){if(t===this.m_root)return void(this.m_root=null);const e=Pe(t.parent),i=e&&e.parent,n=Pe(e.child1===t?e.child2:e.child1);if(null!==i){i.child1===e?i.child1=n:i.child2=n,n.parent=i,this.FreeNode(e);let t=i;for(;null!==t;){t=this.Balance(t);const e=Pe(t.child1),i=Pe(t.child2);t.aabb.Combine2(e.aabb,i.aabb),t.height=1+et(e.height,i.height),t=t.parent}}else this.m_root=n,n.parent=null,this.FreeNode(e)}Balance(t){if(t.IsLeaf()||t.height<2)return t;const e=Pe(t.child1),i=Pe(t.child2),n=i.height-e.height;if(n>1){const n=Pe(i.child1),s=Pe(i.child2);return i.child1=t,i.parent=t.parent,t.parent=i,null!==i.parent?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.m_root=i,n.height>s.height?(i.child2=n,t.child2=s,s.parent=t,t.aabb.Combine2(e.aabb,s.aabb),i.aabb.Combine2(t.aabb,n.aabb),t.height=1+et(e.height,s.height),i.height=1+et(t.height,n.height)):(i.child2=s,t.child2=n,n.parent=t,t.aabb.Combine2(e.aabb,n.aabb),i.aabb.Combine2(t.aabb,s.aabb),t.height=1+et(e.height,n.height),i.height=1+et(t.height,s.height)),i}if(n<-1){const n=Pe(e.child1),s=Pe(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,null!==e.parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,n.height>s.height?(e.child2=n,t.child1=s,s.parent=t,t.aabb.Combine2(i.aabb,s.aabb),e.aabb.Combine2(t.aabb,n.aabb),t.height=1+et(i.height,s.height),e.height=1+et(t.height,n.height)):(e.child2=s,t.child1=n,n.parent=t,t.aabb.Combine2(i.aabb,n.aabb),e.aabb.Combine2(t.aabb,s.aabb),t.height=1+et(i.height,n.height),e.height=1+et(t.height,s.height)),e}return t}GetHeight(){return null===this.m_root?0:this.m_root.height}static GetAreaNode(t){if(null===t)return 0;if(t.IsLeaf())return 0;let e=t.aabb.GetPerimeter();return e+=De.GetAreaNode(t.child1),e+=De.GetAreaNode(t.child2),e}GetAreaRatio(){if(null===this.m_root)return 0;const t=this.m_root.aabb.GetPerimeter();return De.GetAreaNode(this.m_root)/t}static ComputeHeightNode(t){return null===t||t.IsLeaf()?0:1+et(De.ComputeHeightNode(t.child1),De.ComputeHeightNode(t.child2))}ComputeHeight(){return De.ComputeHeightNode(this.m_root)}ValidateStructure(t){if(null===t)return;if(this.m_root,t.IsLeaf())return;const e=Pe(t.child1),i=Pe(t.child2);this.ValidateStructure(e),this.ValidateStructure(i)}ValidateMetrics(t){if(null===t)return;if(t.IsLeaf())return;const e=Pe(t.child1),i=Pe(t.child2);De.s_aabb.Combine2(e.aabb,i.aabb),this.ValidateMetrics(e),this.ValidateMetrics(i)}Validate(){}static GetMaxBalanceNode(t,e){if(null===t)return e;if(t.height<=1)return e;const i=Pe(t.child1),n=Pe(t.child2);return et(e,Q(n.height-i.height))}GetMaxBalance(){return De.GetMaxBalanceNode(this.m_root,0)}RebuildBottomUp(){this.Validate()}static ShiftOriginNode(t,e){if(null===t)return;if(t.height<=1)return;const i=t.child1,n=t.child2;De.ShiftOriginNode(i,e),De.ShiftOriginNode(n,e),t.aabb.lowerBound.SelfSub(e),t.aabb.upperBound.SelfSub(e)}ShiftOrigin(t){De.ShiftOriginNode(this.m_root,t)}}function Re(t,e,i){const n=t[e];t[e]=t[i],t[i]=n}function Me(t,e){return t<e}function Be(t,e=0,i=t.length-e,n=Me){let s=e;const r=[];let o=0;for(;;){for(;s+1<i;i++){const e=t[s+Math.floor(Math.random()*(i-s))];r[o++]=i;for(let r=s-1;;){for(;n(t[++r],e););for(;n(e,t[--i]););if(r>=i)break;Re(t,r,i)}}if(0===o)break;s=i,i=r[--o]}return t}De.s_r=new xt,De.s_v=new xt,De.s_abs_v=new xt,De.s_segmentAABB=new Se,De.s_subInput=new ve,De.s_combinedAABB=new Se,De.s_aabb=new Se,De.s_node_id=0;class Oe{constructor(t,e){this.proxyA=t,this.proxyB=e}}class Ne{constructor(){this.m_tree=new De,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}CreateProxy(t,e){const i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i}DestroyProxy(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)}MoveProxy(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)}TouchProxy(t){this.BufferMove(t)}GetProxyCount(){return this.m_proxyCount}UpdatePairs(t){this.m_pairCount=0;for(let t=0;t<this.m_moveCount;++t){const e=this.m_moveBuffer[t];if(null===e)continue;const i=e.aabb;this.m_tree.Query(i,(t=>{if(t.m_id===e.m_id)return!0;let i,n;if(t.m_id<e.m_id?(i=t,n=e):(i=e,n=t),this.m_pairCount===this.m_pairBuffer.length)this.m_pairBuffer[this.m_pairCount]=new Oe(i,n);else{const t=this.m_pairBuffer[this.m_pairCount];t.proxyA=i,t.proxyB=n}return++this.m_pairCount,!0}))}this.m_moveCount=0,Be(this.m_pairBuffer,0,this.m_pairCount,Le);let e=0;for(;e<this.m_pairCount;){const i=this.m_pairBuffer[e];for(t(i.proxyA.userData,i.proxyB.userData),++e;e<this.m_pairCount;){const t=this.m_pairBuffer[e];if(t.proxyA.m_id!==i.proxyA.m_id||t.proxyB.m_id!==i.proxyB.m_id)break;++e}}}Query(t,e){this.m_tree.Query(t,e)}QueryPoint(t,e){this.m_tree.QueryPoint(t,e)}RayCast(t,e){this.m_tree.RayCast(t,e)}GetTreeHeight(){return this.m_tree.GetHeight()}GetTreeBalance(){return this.m_tree.GetMaxBalance()}GetTreeQuality(){return this.m_tree.GetAreaRatio()}ShiftOrigin(t){this.m_tree.ShiftOrigin(t)}BufferMove(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount}UnBufferMove(t){const e=this.m_moveBuffer.indexOf(t);this.m_moveBuffer[e]=null}}function Le(t,e){return t.proxyA.m_id<e.proxyA.m_id||t.proxyA.m_id===e.proxyA.m_id&&t.proxyB.m_id<e.proxyB.m_id}function Fe(){t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0}t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0;const ze=new wt,Ve=new wt,Ue=new xt,Ge=new xt,He=new xt,ke=new xt,je=new xt;class We{constructor(){this.proxyA=new Lt,this.proxyB=new Lt,this.sweepA=new Et,this.sweepB=new Et,this.tMax=0}}var qe,Xe;(qe=t.b2TOIOutputState||(t.b2TOIOutputState={}))[qe.e_unknown=0]="e_unknown",qe[qe.e_failed=1]="e_failed",qe[qe.e_overlapped=2]="e_overlapped",qe[qe.e_touching=3]="e_touching",qe[qe.e_separated=4]="e_separated";class Ye{constructor(){this.state=t.b2TOIOutputState.e_unknown,this.t=0}}(Xe=t.b2SeparationFunctionType||(t.b2SeparationFunctionType={}))[Xe.e_unknown=-1]="e_unknown",Xe[Xe.e_points=0]="e_points",Xe[Xe.e_faceA=1]="e_faceA",Xe[Xe.e_faceB=2]="e_faceB";class Ke{constructor(){this.m_sweepA=new Et,this.m_sweepB=new Et,this.m_type=t.b2SeparationFunctionType.e_unknown,this.m_localPoint=new xt,this.m_axis=new xt}Initialize(e,i,n,s,r,o){this.m_proxyA=i,this.m_proxyB=s;const a=e.count;this.m_sweepA.Copy(n),this.m_sweepB.Copy(r);const l=ze,c=Ve;if(this.m_sweepA.GetTransform(l,o),this.m_sweepB.GetTransform(c,o),1===a){this.m_type=t.b2SeparationFunctionType.e_points;const i=this.m_proxyA.GetVertex(e.indexA[0]),n=this.m_proxyB.GetVertex(e.indexB[0]),s=wt.MulXV(l,i,Ue),r=wt.MulXV(c,n,Ge);xt.SubVV(r,s,this.m_axis);const o=this.m_axis.Normalize();return this.m_localPoint.SetZero(),o}if(e.indexA[0]===e.indexA[1]){this.m_type=t.b2SeparationFunctionType.e_faceB;const i=this.m_proxyB.GetVertex(e.indexB[0]),n=this.m_proxyB.GetVertex(e.indexB[1]);xt.CrossVOne(xt.SubVV(n,i,xt.s_t0),this.m_axis).SelfNormalize();const s=Tt.MulRV(c.q,this.m_axis,He);xt.MidVV(i,n,this.m_localPoint);const r=wt.MulXV(c,this.m_localPoint,Ge),o=this.m_proxyA.GetVertex(e.indexA[0]),a=wt.MulXV(l,o,Ue);let h=xt.DotVV(xt.SubVV(a,r,xt.s_t0),s);return h<0&&(this.m_axis.SelfNeg(),h=-h),h}{this.m_type=t.b2SeparationFunctionType.e_faceA;const i=this.m_proxyA.GetVertex(e.indexA[0]),n=this.m_proxyA.GetVertex(e.indexA[1]);xt.CrossVOne(xt.SubVV(n,i,xt.s_t0),this.m_axis).SelfNormalize();const s=Tt.MulRV(l.q,this.m_axis,He);xt.MidVV(i,n,this.m_localPoint);const r=wt.MulXV(l,this.m_localPoint,Ue),o=this.m_proxyB.GetVertex(e.indexB[0]),a=wt.MulXV(c,o,Ge);let h=xt.DotVV(xt.SubVV(a,r,xt.s_t0),s);return h<0&&(this.m_axis.SelfNeg(),h=-h),h}}FindMinSeparation(e,i,n){const s=ze,r=Ve;switch(this.m_sweepA.GetTransform(s,n),this.m_sweepB.GetTransform(r,n),this.m_type){case t.b2SeparationFunctionType.e_points:{const t=Tt.MulTRV(s.q,this.m_axis,ke),n=Tt.MulTRV(r.q,xt.NegV(this.m_axis,xt.s_t0),je);e[0]=this.m_proxyA.GetSupport(t),i[0]=this.m_proxyB.GetSupport(n);const o=this.m_proxyA.GetVertex(e[0]),a=this.m_proxyB.GetVertex(i[0]),l=wt.MulXV(s,o,Ue),c=wt.MulXV(r,a,Ge);return xt.DotVV(xt.SubVV(c,l,xt.s_t0),this.m_axis)}case t.b2SeparationFunctionType.e_faceA:{const t=Tt.MulRV(s.q,this.m_axis,He),n=wt.MulXV(s,this.m_localPoint,Ue),o=Tt.MulTRV(r.q,xt.NegV(t,xt.s_t0),je);e[0]=-1,i[0]=this.m_proxyB.GetSupport(o);const a=this.m_proxyB.GetVertex(i[0]),l=wt.MulXV(r,a,Ge);return xt.DotVV(xt.SubVV(l,n,xt.s_t0),t)}case t.b2SeparationFunctionType.e_faceB:{const t=Tt.MulRV(r.q,this.m_axis,He),n=wt.MulXV(r,this.m_localPoint,Ge),o=Tt.MulTRV(s.q,xt.NegV(t,xt.s_t0),ke);i[0]=-1,e[0]=this.m_proxyA.GetSupport(o);const a=this.m_proxyA.GetVertex(e[0]),l=wt.MulXV(s,a,Ue);return xt.DotVV(xt.SubVV(l,n,xt.s_t0),t)}default:return e[0]=-1,i[0]=-1,0}}Evaluate(e,i,n){const s=ze,r=Ve;switch(this.m_sweepA.GetTransform(s,n),this.m_sweepB.GetTransform(r,n),this.m_type){case t.b2SeparationFunctionType.e_points:{const t=this.m_proxyA.GetVertex(e),n=this.m_proxyB.GetVertex(i),o=wt.MulXV(s,t,Ue),a=wt.MulXV(r,n,Ge);return xt.DotVV(xt.SubVV(a,o,xt.s_t0),this.m_axis)}case t.b2SeparationFunctionType.e_faceA:{const t=Tt.MulRV(s.q,this.m_axis,He),e=wt.MulXV(s,this.m_localPoint,Ue),n=this.m_proxyB.GetVertex(i),o=wt.MulXV(r,n,Ge);return xt.DotVV(xt.SubVV(o,e,xt.s_t0),t)}case t.b2SeparationFunctionType.e_faceB:{const t=Tt.MulRV(r.q,this.m_axis,He),i=wt.MulXV(r,this.m_localPoint,Ge),n=this.m_proxyA.GetVertex(e),o=wt.MulXV(s,n,Ue);return xt.DotVV(xt.SubVV(o,i,xt.s_t0),t)}default:return 0}}}const Je=new Rt,$e=new Ft,Ze=new zt,Qe=new Vt,ti=new Ke,ei=[0],ii=[0],ni=new Et,si=new Et;function ri(e,i){const n=Je.Reset();++t.b2_toiCalls,e.state=t.b2TOIOutputState.e_unknown,e.t=i.tMax;const s=i.proxyA,r=i.proxyB,o=et(l,et(s.m_count,r.m_count)),a=ni.Copy(i.sweepA),c=si.Copy(i.sweepB);a.Normalize(),c.Normalize();const h=i.tMax,u=s.m_radius+r.m_radius,m=et(_,u-3*_),d=.25*_;let p=0;const f=20;let g=0;const y=$e;y.count=0;const v=Ze;for(v.proxyA.Copy(i.proxyA),v.proxyB.Copy(i.proxyB),v.useRadii=!1;;){const i=ze,n=Ve;a.GetTransform(i,p),c.GetTransform(n,p),v.transformA.Copy(i),v.transformB.Copy(n);const l=Qe;if(Qt(l,y,v),l.distance<=0){e.state=t.b2TOIOutputState.e_overlapped,e.t=0;break}if(l.distance<m+d){e.state=t.b2TOIOutputState.e_touching,e.t=p;break}const _=ti;_.Initialize(y,s,a,r,c,p);let u=!1,x=h,S=0;for(;;){const i=ei,n=ii;let s=_.FindMinSeparation(i,n,x);if(s>m+d){e.state=t.b2TOIOutputState.e_separated,e.t=h,u=!0;break}if(s>m-d){p=x;break}let r=_.Evaluate(i[0],n[0],p);if(r<m-d){e.state=t.b2TOIOutputState.e_failed,e.t=p,u=!0;break}if(r<=m+d){e.state=t.b2TOIOutputState.e_touching,e.t=p,u=!0;break}let a=0,l=p,c=x;for(;;){let e=0;e=1&a?l+(m-r)*(c-l)/(s-r):.5*(l+c),++a,++t.b2_toiRootIters;const o=_.Evaluate(i[0],n[0],e);if(Q(o-m)<d){x=e;break}if(o>m?(l=e,r=o):(c=e,s=o),50===a)break}if(t.b2_toiMaxRootIters=et(t.b2_toiMaxRootIters,a),++S,S===o)break}if(++g,++t.b2_toiIters,u)break;if(g===f){e.state=t.b2TOIOutputState.e_failed,e.t=p;break}}t.b2_toiMaxIters=et(t.b2_toiMaxIters,g);const x=n.GetMilliseconds();t.b2_toiMaxTime=et(t.b2_toiMaxTime,x),t.b2_toiTime+=x}const oi=new xt,ai=new xt;function li(e,i,n,s,r){e.pointCount=0;const o=wt.MulXV(n,i.m_p,oi),a=wt.MulXV(r,s.m_p,ai),l=xt.DistanceSquaredVV(o,a),c=i.m_radius+s.m_radius;l>c*c||(e.type=t.b2ManifoldType.e_circles,e.localPoint.Copy(i.m_p),e.localNormal.SetZero(),e.pointCount=1,e.points[0].localPoint.Copy(s.m_p),e.points[0].id.key=0)}const ci=new xt,hi=new xt,_i=new xt;function ui(e,i,r,o,a){e.pointCount=0;const l=wt.MulXV(a,o.m_p,ci),c=wt.MulTXV(r,l,hi);let h=0,_=-n;const u=i.m_radius+o.m_radius,m=i.m_count,d=i.m_vertices,p=i.m_normals;for(let t=0;t<m;++t){const e=xt.DotVV(p[t],xt.SubVV(c,d[t],xt.s_t0));if(e>u)return;e>_&&(_=e,h=t)}const f=h,g=(f+1)%m,y=d[f],v=d[g];if(_<s)return e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(p[h]),xt.MidVV(y,v,e.localPoint),e.points[0].localPoint.Copy(o.m_p),void(e.points[0].id.key=0);const x=xt.DotVV(xt.SubVV(c,y,xt.s_t0),xt.SubVV(v,y,xt.s_t1)),S=xt.DotVV(xt.SubVV(c,v,xt.s_t0),xt.SubVV(y,v,xt.s_t1));if(x<=0){if(xt.DistanceSquaredVV(c,y)>u*u)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,xt.SubVV(c,y,e.localNormal).SelfNormalize(),e.localPoint.Copy(y),e.points[0].localPoint.Copy(o.m_p),e.points[0].id.key=0}else if(S<=0){if(xt.DistanceSquaredVV(c,v)>u*u)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,xt.SubVV(c,v,e.localNormal).SelfNormalize(),e.localPoint.Copy(v),e.points[0].localPoint.Copy(o.m_p),e.points[0].id.key=0}else{const i=xt.MidVV(y,v,_i);if(xt.DotVV(xt.SubVV(c,i,xt.s_t1),p[f])>u)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(p[f]).SelfNormalize(),e.localPoint.Copy(i),e.points[0].localPoint.Copy(o.m_p),e.points[0].id.key=0}}const mi=new xt,di=new xt,pi=new xt,fi=new xt;function gi(t,e,i,s,r){const o=t.m_vertices,a=t.m_normals,l=s.m_count,c=s.m_vertices,h=Tt.MulRV(e.q,a[i],mi),_=Tt.MulTRV(r.q,h,di);let u=0,m=n;for(let t=0;t<l;++t){const e=xt.DotVV(c[t],_);e<m&&(m=e,u=t)}const d=wt.MulXV(e,o[i],pi),p=wt.MulXV(r,c[u],fi);return xt.DotVV(xt.SubVV(p,d,xt.s_t0),h)}const yi=new xt,vi=new xt;function xi(t,e,i,s,r){const o=e.m_count,a=e.m_normals,l=xt.SubVV(wt.MulXV(r,s.m_centroid,xt.s_t0),wt.MulXV(i,e.m_centroid,xt.s_t1),yi),c=Tt.MulTRV(i.q,l,vi);let h=0,_=-n;for(let t=0;t<o;++t){const e=xt.DotVV(a[t],c);e>_&&(_=e,h=t)}let u=gi(e,i,h,s,r);const m=(h+o-1)%o,d=gi(e,i,m,s,r),p=(h+1)%o,f=gi(e,i,p,s,r);let g=0,y=0,v=0;if(d>u&&d>f)v=-1,g=m,y=d;else{if(!(f>u))return t[0]=h,u;v=1,g=p,y=f}for(;h=-1===v?(g+o-1)%o:(g+1)%o,u=gi(e,i,h,s,r),u>y;)g=h,y=u;return t[0]=g,y}const Si=new xt;function Ai(e,i,s,r,o,a){const l=i.m_normals,c=o.m_count,h=o.m_vertices,_=o.m_normals,u=Tt.MulTRV(a.q,Tt.MulRV(s.q,l[r],xt.s_t0),Si);let m=0,d=n;for(let t=0;t<c;++t){const e=xt.DotVV(u,_[t]);e<d&&(d=e,m=t)}const p=m,f=(p+1)%c,g=e[0];wt.MulXV(a,h[p],g.v);const y=g.id.cf;y.indexA=r,y.indexB=p,y.typeA=t.b2ContactFeatureType.e_face,y.typeB=t.b2ContactFeatureType.e_vertex;const v=e[1];wt.MulXV(a,h[f],v.v);const x=v.id.cf;x.indexA=r,x.indexB=f,x.typeA=t.b2ContactFeatureType.e_face,x.typeB=t.b2ContactFeatureType.e_vertex}const Ci=ye.MakeArray(2),bi=ye.MakeArray(2),Ti=ye.MakeArray(2),wi=[0],Ei=[0],Pi=new xt,Ii=new xt,Di=new xt,Ri=new xt,Mi=new xt,Bi=new xt,Oi=new xt,Ni=new xt;function Li(e,i,n,s,r){e.pointCount=0;const o=i.m_radius+s.m_radius,l=wi;l[0]=0;const c=xi(l,i,n,s,r);if(c>o)return;const h=Ei;h[0]=0;const _=xi(h,s,r,i,n);if(_>o)return;let u,m,d,p,f=0,g=0;_>.98*c+.001?(u=s,m=i,d=r,p=n,f=h[0],e.type=t.b2ManifoldType.e_faceB,g=1):(u=i,m=s,d=n,p=r,f=l[0],e.type=t.b2ManifoldType.e_faceA,g=0);const y=Ci;Ai(y,u,d,f,m,p);const v=u.m_count,x=u.m_vertices,S=f,A=(f+1)%v,C=x[S],b=x[A],T=xt.SubVV(b,C,Pi);T.Normalize();const w=xt.CrossVOne(T,Ii),E=xt.MidVV(C,b,Di),P=Tt.MulRV(d.q,T,Mi),I=xt.CrossVOne(P,Ri),D=wt.MulXV(d,C,Oi),R=wt.MulXV(d,b,Ni),M=xt.DotVV(I,D),B=-xt.DotVV(P,D)+o,O=xt.DotVV(P,R)+o,N=bi,L=Ti;let F;if(F=Ce(N,y,xt.NegV(P,Bi),B,S),F<2)return;if(F=Ce(L,N,P,O,A),F<2)return;e.localNormal.Copy(w),e.localPoint.Copy(E);let z=0;for(let t=0;t<a;++t){const i=L[t];if(xt.DotVV(I,i.v)-M<=o){const t=e.points[z];if(wt.MulTXV(p,i.v,t.localPoint),t.id.Copy(i.id),g){const e=t.id.cf;t.id.cf.indexA=e.indexB,t.id.cf.indexB=e.indexA,t.id.cf.typeA=e.typeB,t.id.cf.typeB=e.typeA}++z}}e.pointCount=z}const Fi=new xt,zi=new xt,Vi=new xt,Ui=new xt,Gi=new xt,Hi=new xt,ki=new xt,ji=new me;function Wi(e,i,n,s,r){e.pointCount=0;const o=wt.MulTXV(n,wt.MulXV(r,s.m_p,xt.s_t0),Fi),a=i.m_vertex1,l=i.m_vertex2,c=xt.SubVV(l,a,zi),h=xt.DotVV(c,xt.SubVV(l,o,xt.s_t0)),_=xt.DotVV(c,xt.SubVV(o,a,xt.s_t0)),u=i.m_radius+s.m_radius,m=ji;if(m.cf.indexB=0,m.cf.typeB=t.b2ContactFeatureType.e_vertex,_<=0){const n=a,r=xt.SubVV(o,n,Vi);if(xt.DotVV(r,r)>u*u)return;if(i.m_hasVertex0){const t=i.m_vertex0,e=a,n=xt.SubVV(e,t,Ui);if(xt.DotVV(n,xt.SubVV(e,o,xt.s_t0))>0)return}return m.cf.indexA=0,m.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(n),e.points[0].id.Copy(m),void e.points[0].localPoint.Copy(s.m_p)}if(h<=0){const n=l,r=xt.SubVV(o,n,Vi);if(xt.DotVV(r,r)>u*u)return;if(i.m_hasVertex3){const t=i.m_vertex3,e=l,n=xt.SubVV(t,e,Gi);if(xt.DotVV(n,xt.SubVV(o,e,xt.s_t0))>0)return}return m.cf.indexA=1,m.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(n),e.points[0].id.Copy(m),void e.points[0].localPoint.Copy(s.m_p)}const d=xt.DotVV(c,c),p=Hi;p.x=1/d*(h*a.x+_*l.x),p.y=1/d*(h*a.y+_*l.y);const f=xt.SubVV(o,p,Vi);if(xt.DotVV(f,f)>u*u)return;const g=ki.Set(-c.y,c.x);xt.DotVV(g,xt.SubVV(o,a,xt.s_t0))<0&&g.Set(-g.x,-g.y),g.Normalize(),m.cf.indexA=0,m.cf.typeA=t.b2ContactFeatureType.e_face,e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(g),e.localPoint.Copy(a),e.points[0].id.Copy(m),e.points[0].localPoint.Copy(s.m_p)}var qi,Xi;!function(t){t[t.e_unknown=0]="e_unknown",t[t.e_edgeA=1]="e_edgeA",t[t.e_edgeB=2]="e_edgeB"}(qi||(qi={}));class Yi{constructor(){this.type=qi.e_unknown,this.index=0,this.separation=0}}class Ki{constructor(){this.vertices=[],this.normals=[],this.count=0}}class Ji{constructor(){this.i1=0,this.i2=0,this.v1=new xt,this.v2=new xt,this.normal=new xt,this.sideNormal1=new xt,this.sideOffset1=0,this.sideNormal2=new xt,this.sideOffset2=0}}!function(t){t[t.e_isolated=0]="e_isolated",t[t.e_concave=1]="e_concave",t[t.e_convex=2]="e_convex"}(Xi||(Xi={}));class $i{constructor(){this.m_polygonB=new Ki,this.m_xf=new wt,this.m_centroidB=new xt,this.m_v0=new xt,this.m_v1=new xt,this.m_v2=new xt,this.m_v3=new xt,this.m_normal0=new xt,this.m_normal1=new xt,this.m_normal2=new xt,this.m_normal=new xt,this.m_type1=Xi.e_isolated,this.m_type2=Xi.e_isolated,this.m_lowerLimit=new xt,this.m_upperLimit=new xt,this.m_radius=0,this.m_front=!1}Collide(e,i,n,s,r){wt.MulTXX(n,r,this.m_xf),wt.MulXV(this.m_xf,s.m_centroid,this.m_centroidB),this.m_v0.Copy(i.m_vertex0),this.m_v1.Copy(i.m_vertex1),this.m_v2.Copy(i.m_vertex2),this.m_v3.Copy(i.m_vertex3);const o=i.m_hasVertex0,l=i.m_hasVertex3,c=xt.SubVV(this.m_v2,this.m_v1,$i.s_edge1);c.Normalize(),this.m_normal1.Set(c.y,-c.x);const h=xt.DotVV(this.m_normal1,xt.SubVV(this.m_centroidB,this.m_v1,xt.s_t0));let _=0,u=0,m=!1,d=!1;if(o){const t=xt.SubVV(this.m_v1,this.m_v0,$i.s_edge0);t.Normalize(),this.m_normal0.Set(t.y,-t.x),m=xt.CrossVV(t,c)>=0,_=xt.DotVV(this.m_normal0,xt.SubVV(this.m_centroidB,this.m_v0,xt.s_t0))}if(l){const t=xt.SubVV(this.m_v3,this.m_v2,$i.s_edge2);t.Normalize(),this.m_normal2.Set(t.y,-t.x),d=xt.CrossVV(c,t)>0,u=xt.DotVV(this.m_normal2,xt.SubVV(this.m_centroidB,this.m_v2,xt.s_t0))}o&&l?m&&d?(this.m_front=_>=0||h>=0||u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):m?(this.m_front=_>=0||h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):d?(this.m_front=u>=0||_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=_>=0&&h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):o?m?(this.m_front=_>=0||h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):(this.m_front=_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):l?d?(this.m_front=h>=0||u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=s.m_count;for(let t=0;t<s.m_count;++t)this.m_polygonB.vertices.length<=t&&this.m_polygonB.vertices.push(new xt),this.m_polygonB.normals.length<=t&&this.m_polygonB.normals.push(new xt),wt.MulXV(this.m_xf,s.m_vertices[t],this.m_polygonB.vertices[t]),Tt.MulRV(this.m_xf.q,s.m_normals[t],this.m_polygonB.normals[t]);this.m_radius=s.m_radius+i.m_radius,e.pointCount=0;const p=this.ComputeEdgeSeparation($i.s_edgeAxis);if(p.type===qi.e_unknown)return;if(p.separation>this.m_radius)return;const f=this.ComputePolygonSeparation($i.s_polygonAxis);if(f.type!==qi.e_unknown&&f.separation>this.m_radius)return;const g=.98,y=.001;let v;v=f.type===qi.e_unknown?p:f.separation>g*p.separation+y?f:p;const x=$i.s_ie,S=$i.s_rf;if(v.type===qi.e_edgeA){e.type=t.b2ManifoldType.e_faceA;let i=0,n=xt.DotVV(this.m_normal,this.m_polygonB.normals[0]);for(let t=1;t<this.m_polygonB.count;++t){const e=xt.DotVV(this.m_normal,this.m_polygonB.normals[t]);e<n&&(n=e,i=t)}const s=i,r=(s+1)%this.m_polygonB.count,o=x[0];o.v.Copy(this.m_polygonB.vertices[s]),o.id.cf.indexA=0,o.id.cf.indexB=s,o.id.cf.typeA=t.b2ContactFeatureType.e_face,o.id.cf.typeB=t.b2ContactFeatureType.e_vertex;const a=x[1];a.v.Copy(this.m_polygonB.vertices[r]),a.id.cf.indexA=0,a.id.cf.indexB=r,a.id.cf.typeA=t.b2ContactFeatureType.e_face,a.id.cf.typeB=t.b2ContactFeatureType.e_vertex,this.m_front?(S.i1=0,S.i2=1,S.v1.Copy(this.m_v1),S.v2.Copy(this.m_v2),S.normal.Copy(this.m_normal1)):(S.i1=1,S.i2=0,S.v1.Copy(this.m_v2),S.v2.Copy(this.m_v1),S.normal.Copy(this.m_normal1).SelfNeg())}else{e.type=t.b2ManifoldType.e_faceB;const i=x[0];i.v.Copy(this.m_v1),i.id.cf.indexA=0,i.id.cf.indexB=v.index,i.id.cf.typeA=t.b2ContactFeatureType.e_vertex,i.id.cf.typeB=t.b2ContactFeatureType.e_face;const n=x[1];n.v.Copy(this.m_v2),n.id.cf.indexA=0,n.id.cf.indexB=v.index,n.id.cf.typeA=t.b2ContactFeatureType.e_vertex,n.id.cf.typeB=t.b2ContactFeatureType.e_face,S.i1=v.index,S.i2=(S.i1+1)%this.m_polygonB.count,S.v1.Copy(this.m_polygonB.vertices[S.i1]),S.v2.Copy(this.m_polygonB.vertices[S.i2]),S.normal.Copy(this.m_polygonB.normals[S.i1])}S.sideNormal1.Set(S.normal.y,-S.normal.x),S.sideNormal2.Copy(S.sideNormal1).SelfNeg(),S.sideOffset1=xt.DotVV(S.sideNormal1,S.v1),S.sideOffset2=xt.DotVV(S.sideNormal2,S.v2);const A=$i.s_clipPoints1,C=$i.s_clipPoints2;let b=0;if(b=Ce(A,x,S.sideNormal1,S.sideOffset1,S.i1),b<a)return;if(b=Ce(C,A,S.sideNormal2,S.sideOffset2,S.i2),b<a)return;v.type===qi.e_edgeA?(e.localNormal.Copy(S.normal),e.localPoint.Copy(S.v1)):(e.localNormal.Copy(s.m_normals[S.i1]),e.localPoint.Copy(s.m_vertices[S.i1]));let T=0;for(let t=0;t<a;++t){let i;if(i=xt.DotVV(S.normal,xt.SubVV(C[t].v,S.v1,xt.s_t0)),i<=this.m_radius){const i=e.points[T];v.type===qi.e_edgeA?(wt.MulTXV(this.m_xf,C[t].v,i.localPoint),i.id.Copy(C[t].id)):(i.localPoint.Copy(C[t].v),i.id.cf.typeA=C[t].id.cf.typeB,i.id.cf.typeB=C[t].id.cf.typeA,i.id.cf.indexA=C[t].id.cf.indexB,i.id.cf.indexB=C[t].id.cf.indexA),++T}}e.pointCount=T}ComputeEdgeSeparation(t){const e=t;e.type=qi.e_edgeA,e.index=this.m_front?0:1,e.separation=n;for(let t=0;t<this.m_polygonB.count;++t){const i=xt.DotVV(this.m_normal,xt.SubVV(this.m_polygonB.vertices[t],this.m_v1,xt.s_t0));i<e.separation&&(e.separation=i)}return e}ComputePolygonSeparation(t){const e=t;e.type=qi.e_unknown,e.index=-1,e.separation=-n;const i=$i.s_perp.Set(-this.m_normal.y,this.m_normal.x);for(let t=0;t<this.m_polygonB.count;++t){const n=xt.NegV(this.m_polygonB.normals[t],$i.s_n),s=tt(xt.DotVV(n,xt.SubVV(this.m_polygonB.vertices[t],this.m_v1,xt.s_t0)),xt.DotVV(n,xt.SubVV(this.m_polygonB.vertices[t],this.m_v2,xt.s_t0)));if(s>this.m_radius)return e.type=qi.e_edgeB,e.index=t,e.separation=s,e;if(xt.DotVV(n,i)>=0){if(xt.DotVV(xt.SubVV(n,this.m_upperLimit,xt.s_t0),this.m_normal)<-u)continue}else if(xt.DotVV(xt.SubVV(n,this.m_lowerLimit,xt.s_t0),this.m_normal)<-u)continue;s>e.separation&&(e.type=qi.e_edgeB,e.index=t,e.separation=s)}return e}}$i.s_edge1=new xt,$i.s_edge0=new xt,$i.s_edge2=new xt,$i.s_ie=ye.MakeArray(2),$i.s_rf=new Ji,$i.s_clipPoints1=ye.MakeArray(2),$i.s_clipPoints2=ye.MakeArray(2),$i.s_edgeAxis=new Yi,$i.s_polygonAxis=new Yi,$i.s_n=new xt,$i.s_perp=new xt;const Zi=new $i;function Qi(t,e,i,n,s){Zi.Collide(t,e,i,n,s)}class tn{constructor(){this.mass=0,this.center=new xt(0,0),this.I=0}}var en,nn,sn,rn;(en=t.b2ShapeType||(t.b2ShapeType={}))[en.e_unknown=-1]="e_unknown",en[en.e_circleShape=0]="e_circleShape",en[en.e_edgeShape=1]="e_edgeShape",en[en.e_polygonShape=2]="e_polygonShape",en[en.e_chainShape=3]="e_chainShape",en[en.e_shapeTypeCount=4]="e_shapeTypeCount";class on{constructor(e,i){this.m_type=t.b2ShapeType.e_unknown,this.m_radius=0,this.m_type=e,this.m_radius=i}Copy(t){return this.m_radius=t.m_radius,this}GetType(){return this.m_type}}class an extends on{constructor(e=0){super(t.b2ShapeType.e_circleShape,e),this.m_p=new xt}Set(t,e=this.m_radius){return this.m_p.Copy(t),this.m_radius=e,this}Clone(){return(new an).Copy(this)}Copy(t){return super.Copy(t),this.m_p.Copy(t.m_p),this}GetChildCount(){return 1}TestPoint(t,e){const i=wt.MulXV(t,this.m_p,an.TestPoint_s_center),n=xt.SubVV(e,i,an.TestPoint_s_d);return xt.DotVV(n,n)<=rt(this.m_radius)}ComputeDistance(t,e,i,n){const s=wt.MulXV(t,this.m_p,an.ComputeDistance_s_center);return xt.SubVV(e,s,i),i.Normalize()-this.m_radius}RayCast(t,e,i,n){const r=wt.MulXV(i,this.m_p,an.RayCast_s_position),o=xt.SubVV(e.p1,r,an.RayCast_s_s),a=xt.DotVV(o,o)-rt(this.m_radius),l=xt.SubVV(e.p2,e.p1,an.RayCast_s_r),c=xt.DotVV(o,l),h=xt.DotVV(l,l),_=c*c-h*a;if(_<0||h<s)return!1;let u=-(c+at(_));return 0<=u&&u<=e.maxFraction*h&&(u/=h,t.fraction=u,xt.AddVMulSV(o,u,l,t.normal).SelfNormalize(),!0)}ComputeAABB(t,e,i){const n=wt.MulXV(e,this.m_p,an.ComputeAABB_s_p);t.lowerBound.Set(n.x-this.m_radius,n.y-this.m_radius),t.upperBound.Set(n.x+this.m_radius,n.y+this.m_radius)}ComputeMass(t,e){const i=rt(this.m_radius);t.mass=e*o*i,t.center.Copy(this.m_p),t.I=t.mass*(.5*i+xt.DotVV(this.m_p,this.m_p))}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){const r=wt.MulXV(i,this.m_p,new xt),a=-(xt.DotVV(t,r)-e);if(a<-this.m_radius+s)return 0;if(a>this.m_radius)return n.Copy(r),o*this.m_radius*this.m_radius;const l=this.m_radius*this.m_radius,c=a*a,h=l*(dt(a/this.m_radius)+o/2)+a*at(l-c),_=-2/3*lt(l-c,1.5)/h;return n.x=r.x+t.x*_,n.y=r.y+t.y*_,h}Dump(t){t("    const shape: b2CircleShape = new b2CircleShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_p.Set(%.15f, %.15f);\n",this.m_p.x,this.m_p.y)}}an.TestPoint_s_center=new xt,an.TestPoint_s_d=new xt,an.ComputeDistance_s_center=new xt,an.RayCast_s_position=new xt,an.RayCast_s_s=new xt,an.RayCast_s_r=new xt,an.ComputeAABB_s_p=new xt;class ln extends on{constructor(){super(t.b2ShapeType.e_polygonShape,m),this.m_centroid=new xt(0,0),this.m_vertices=[],this.m_normals=[],this.m_count=0}Clone(){return(new ln).Copy(this)}Copy(t){super.Copy(t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count,this.m_vertices=xt.MakeArray(this.m_count),this.m_normals=xt.MakeArray(this.m_count);for(let e=0;e<this.m_count;++e)this.m_vertices[e].Copy(t.m_vertices[e]),this.m_normals[e].Copy(t.m_normals[e]);return this}GetChildCount(){return 1}Set(...t){if("number"==typeof t[0][0]){const e=t[0];if(e.length%2!=0)throw new Error;return this._Set((t=>({x:e[2*t],y:e[2*t+1]})),e.length/2)}{const e=t[0],i=t[1]||e.length;return this._Set((t=>e[t]),i)}}_Set(t,e){if(e<3)return this.SetAsBox(1,1);let i=e;const n=[];for(let e=0;e<i;++e){const i=t(e);let s=!0;for(let t=0;t<n.length;++t)if(xt.DistanceSquaredVV(i,n[t])<.25*_*_){s=!1;break}s&&n.push(i)}if(i=n.length,i<3)return this.SetAsBox(1,1);let s=0,r=n[0].x;for(let t=1;t<i;++t){const e=n[t].x;(e>r||e===r&&n[t].y<n[s].y)&&(s=t,r=e)}const o=[];let a=0,l=s;for(;;){o[a]=l;let t=0;for(let e=1;e<i;++e){if(t===l){t=e;continue}const i=xt.SubVV(n[t],n[o[a]],ln.Set_s_r),s=xt.SubVV(n[e],n[o[a]],ln.Set_s_v),r=xt.CrossVV(i,s);r<0&&(t=e),0===r&&s.LengthSquared()>i.LengthSquared()&&(t=e)}if(++a,l=t,t===s)break}this.m_count=a,this.m_vertices=xt.MakeArray(this.m_count),this.m_normals=xt.MakeArray(this.m_count);for(let t=0;t<a;++t)this.m_vertices[t].Copy(n[o[t]]);for(let t=0;t<a;++t){const e=this.m_vertices[t],i=this.m_vertices[(t+1)%a],n=xt.SubVV(i,e,xt.s_t0);xt.CrossVOne(n,this.m_normals[t]).SelfNormalize()}return ln.ComputeCentroid(this.m_vertices,a,this.m_centroid),this}SetAsBox(t,e,i,n=0){if(this.m_count=4,this.m_vertices=xt.MakeArray(this.m_count),this.m_normals=xt.MakeArray(this.m_count),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),i){this.m_centroid.Copy(i);const t=new wt;t.SetPosition(i),t.SetRotationAngle(n);for(let e=0;e<this.m_count;++e)wt.MulXV(t,this.m_vertices[e],this.m_vertices[e]),Tt.MulRV(t.q,this.m_normals[e],this.m_normals[e])}return this}TestPoint(t,e){const i=wt.MulTXV(t,e,ln.TestPoint_s_pLocal);for(let t=0;t<this.m_count;++t)if(xt.DotVV(this.m_normals[t],xt.SubVV(i,this.m_vertices[t],xt.s_t0))>0)return!1;return!0}ComputeDistance(t,e,i,s){const r=wt.MulTXV(t,e,ln.ComputeDistance_s_pLocal);let o=-n;const a=ln.ComputeDistance_s_normalForMaxDistance.Copy(r);for(let t=0;t<this.m_count;++t){const e=xt.DotVV(this.m_normals[t],xt.SubVV(r,this.m_vertices[t],xt.s_t0));e>o&&(o=e,a.Copy(this.m_normals[t]))}if(o>0){const e=ln.ComputeDistance_s_minDistance.Copy(a);let n=o*o;for(let t=0;t<this.m_count;++t){const i=xt.SubVV(r,this.m_vertices[t],ln.ComputeDistance_s_distance),s=i.LengthSquared();n>s&&(e.Copy(i),n=s)}return Tt.MulRV(t.q,e,i),i.Normalize(),Math.sqrt(n)}return Tt.MulRV(t.q,a,i),o}RayCast(t,e,i,n){const s=wt.MulTXV(i,e.p1,ln.RayCast_s_p1),r=wt.MulTXV(i,e.p2,ln.RayCast_s_p2),o=xt.SubVV(r,s,ln.RayCast_s_d);let a=0,l=e.maxFraction,c=-1;for(let t=0;t<this.m_count;++t){const e=xt.DotVV(this.m_normals[t],xt.SubVV(this.m_vertices[t],s,xt.s_t0)),i=xt.DotVV(this.m_normals[t],o);if(0===i){if(e<0)return!1}else i<0&&e<a*i?(a=e/i,c=t):i>0&&e<l*i&&(l=e/i);if(l<a)return!1}return c>=0&&(t.fraction=a,Tt.MulRV(i.q,this.m_normals[c],t.normal),!0)}ComputeAABB(t,e,i){const n=wt.MulXV(e,this.m_vertices[0],t.lowerBound),s=t.upperBound.Copy(n);for(let t=0;t<this.m_count;++t){const i=wt.MulXV(e,this.m_vertices[t],ln.ComputeAABB_s_v);xt.MinV(i,n,n),xt.MaxV(i,s,s)}const r=this.m_radius;n.SelfSubXY(r,r),s.SelfAddXY(r,r)}ComputeMass(t,e){const i=ln.ComputeMass_s_center.SetZero();let n=0,s=0;const r=ln.ComputeMass_s_s.SetZero();for(let t=0;t<this.m_count;++t)r.SelfAdd(this.m_vertices[t]);r.SelfMul(1/this.m_count);const o=1/3;for(let t=0;t<this.m_count;++t){const e=xt.SubVV(this.m_vertices[t],r,ln.ComputeMass_s_e1),a=xt.SubVV(this.m_vertices[(t+1)%this.m_count],r,ln.ComputeMass_s_e2),l=xt.CrossVV(e,a),c=.5*l;n+=c,i.SelfAdd(xt.MulSV(c*o,xt.AddVV(e,a,xt.s_t0),xt.s_t1));const h=e.x,_=e.y,u=a.x,m=a.y;s+=.25*o*l*(h*h+u*h+u*u+_*_+m*_+m*m)}t.mass=e*n,i.SelfMul(1/n),xt.AddVV(i,r,t.center),t.I=e*s,t.I+=t.mass*(xt.DotVV(t.center,t.center)-xt.DotVV(i,i))}Validate(){for(let t=0;t<this.m_count;++t){const e=t,i=(t+1)%this.m_count,n=this.m_vertices[e],s=xt.SubVV(this.m_vertices[i],n,ln.Validate_s_e);for(let t=0;t<this.m_count;++t){if(t===e||t===i)continue;const r=xt.SubVV(this.m_vertices[t],n,ln.Validate_s_v);if(xt.CrossVV(s,r)<0)return!1}}return!0}SetupDistanceProxy(t,e){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){const r=Tt.MulTRV(i.q,t,ln.ComputeSubmergedArea_s_normalL),o=e-xt.DotVV(t,i.p),a=[];let l=0,c=-1,h=-1,_=!1;for(let t=0;t<this.m_count;++t){a[t]=xt.DotVV(r,this.m_vertices[t])-o;const e=a[t]<-s;t>0&&(e?_||(c=t-1,l++):_&&(h=t-1,l++)),_=e}switch(l){case 0:if(_){const t=ln.ComputeSubmergedArea_s_md;return this.ComputeMass(t,1),wt.MulXV(i,t.center,n),t.mass}return 0;case 1:-1===c?c=this.m_count-1:h=this.m_count-1}const u=(c+1)%this.m_count,m=(h+1)%this.m_count,d=(0-a[c])/(a[u]-a[c]),p=(0-a[h])/(a[m]-a[h]),f=ln.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[c].x*(1-d)+this.m_vertices[u].x*d,this.m_vertices[c].y*(1-d)+this.m_vertices[u].y*d),g=ln.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[h].x*(1-p)+this.m_vertices[m].x*p,this.m_vertices[h].y*(1-p)+this.m_vertices[m].y*p);let y=0;const v=ln.ComputeSubmergedArea_s_center.SetZero();let x,S=this.m_vertices[u],A=u;for(;A!==m;){A=(A+1)%this.m_count,x=A===m?g:this.m_vertices[A];const t=.5*((S.x-f.x)*(x.y-f.y)-(S.y-f.y)*(x.x-f.x));y+=t,v.x+=t*(f.x+S.x+x.x)/3,v.y+=t*(f.y+S.y+x.y)/3,S=x}return v.SelfMul(1/y),wt.MulXV(i,v,n),y}Dump(t){t("    const shape: b2PolygonShape = new b2PolygonShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(let e=0;e<this.m_count;++e)t("    vs[%d] = new b2Vec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.Set(vs, %d);\n",this.m_count)}static ComputeCentroid(t,e,i){const n=i;n.SetZero();let s=0;const r=ln.ComputeCentroid_s_pRef.SetZero(),o=1/3;for(let i=0;i<e;++i){const a=r,l=t[i],c=t[(i+1)%e],h=xt.SubVV(l,a,ln.ComputeCentroid_s_e1),_=xt.SubVV(c,a,ln.ComputeCentroid_s_e2),u=.5*xt.CrossVV(h,_);s+=u,n.x+=u*o*(a.x+l.x+c.x),n.y+=u*o*(a.y+l.y+c.y)}return n.SelfMul(1/s),n}}ln.Set_s_r=new xt,ln.Set_s_v=new xt,ln.TestPoint_s_pLocal=new xt,ln.ComputeDistance_s_pLocal=new xt,ln.ComputeDistance_s_normalForMaxDistance=new xt,ln.ComputeDistance_s_minDistance=new xt,ln.ComputeDistance_s_distance=new xt,ln.RayCast_s_p1=new xt,ln.RayCast_s_p2=new xt,ln.RayCast_s_d=new xt,ln.ComputeAABB_s_v=new xt,ln.ComputeMass_s_center=new xt,ln.ComputeMass_s_s=new xt,ln.ComputeMass_s_e1=new xt,ln.ComputeMass_s_e2=new xt,ln.Validate_s_e=new xt,ln.Validate_s_v=new xt,ln.ComputeSubmergedArea_s_normalL=new xt,ln.ComputeSubmergedArea_s_md=new tn,ln.ComputeSubmergedArea_s_intoVec=new xt,ln.ComputeSubmergedArea_s_outoVec=new xt,ln.ComputeSubmergedArea_s_center=new xt,ln.ComputeCentroid_s_pRef=new xt,ln.ComputeCentroid_s_e1=new xt,ln.ComputeCentroid_s_e2=new xt;class cn extends on{constructor(){super(t.b2ShapeType.e_edgeShape,m),this.m_vertex1=new xt,this.m_vertex2=new xt,this.m_vertex0=new xt,this.m_vertex3=new xt,this.m_hasVertex0=!1,this.m_hasVertex3=!1}Set(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this}Clone(){return(new cn).Copy(this)}Copy(t){return super.Copy(t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_hasVertex0=t.m_hasVertex0,this.m_hasVertex3=t.m_hasVertex3,this}GetChildCount(){return 1}TestPoint(t,e){return!1}ComputeDistance(t,e,i,n){const s=wt.MulXV(t,this.m_vertex1,cn.ComputeDistance_s_v1),r=wt.MulXV(t,this.m_vertex2,cn.ComputeDistance_s_v2),o=xt.SubVV(e,s,cn.ComputeDistance_s_d),a=xt.SubVV(r,s,cn.ComputeDistance_s_s),l=xt.DotVV(o,a);if(l>0){const t=xt.DotVV(a,a);l>t?xt.SubVV(e,r,o):o.SelfMulSub(l/t,a)}return i.Copy(o),i.Normalize()}RayCast(t,e,i,n){const s=wt.MulTXV(i,e.p1,cn.RayCast_s_p1),r=wt.MulTXV(i,e.p2,cn.RayCast_s_p2),o=xt.SubVV(r,s,cn.RayCast_s_d),a=this.m_vertex1,l=this.m_vertex2,c=xt.SubVV(l,a,cn.RayCast_s_e),h=t.normal.Set(c.y,-c.x).SelfNormalize(),_=xt.DotVV(h,xt.SubVV(a,s,xt.s_t0)),u=xt.DotVV(h,o);if(0===u)return!1;const m=_/u;if(m<0||e.maxFraction<m)return!1;const d=xt.AddVMulSV(s,m,o,cn.RayCast_s_q),p=xt.SubVV(l,a,cn.RayCast_s_r),f=xt.DotVV(p,p);if(0===f)return!1;const g=xt.DotVV(xt.SubVV(d,a,xt.s_t0),p)/f;return!(g<0||1<g||(t.fraction=m,Tt.MulRV(i.q,t.normal,t.normal),_>0&&t.normal.SelfNeg(),0))}ComputeAABB(t,e,i){const n=wt.MulXV(e,this.m_vertex1,cn.ComputeAABB_s_v1),s=wt.MulXV(e,this.m_vertex2,cn.ComputeAABB_s_v2);xt.MinV(n,s,t.lowerBound),xt.MaxV(n,s,t.upperBound);const r=this.m_radius;t.lowerBound.SelfSubXY(r,r),t.upperBound.SelfAddXY(r,r)}ComputeMass(t,e){t.mass=0,xt.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){return n.SetZero(),0}Dump(t){t("    const shape: b2EdgeShape = new b2EdgeShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),t("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),t("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),t("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),t("    shape.m_hasVertex0 = %s;\n",this.m_hasVertex0),t("    shape.m_hasVertex3 = %s;\n",this.m_hasVertex3)}}cn.ComputeDistance_s_v1=new xt,cn.ComputeDistance_s_v2=new xt,cn.ComputeDistance_s_d=new xt,cn.ComputeDistance_s_s=new xt,cn.RayCast_s_p1=new xt,cn.RayCast_s_p2=new xt,cn.RayCast_s_d=new xt,cn.RayCast_s_e=new xt,cn.RayCast_s_q=new xt,cn.RayCast_s_r=new xt,cn.ComputeAABB_s_v1=new xt,cn.ComputeAABB_s_v2=new xt;class hn extends on{constructor(){super(t.b2ShapeType.e_chainShape,m),this.m_vertices=[],this.m_count=0,this.m_prevVertex=new xt,this.m_nextVertex=new xt,this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1}CreateLoop(...t){if("number"==typeof t[0][0]){const e=t[0];if(e.length%2!=0)throw new Error;return this._CreateLoop((t=>({x:e[2*t],y:e[2*t+1]})),e.length/2)}{const e=t[0],i=t[1]||e.length;return this._CreateLoop((t=>e[t]),i)}}_CreateLoop(t,e){if(e<3)return this;this.m_count=e+1,this.m_vertices=xt.MakeArray(this.m_count);for(let i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_vertices[e].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this}CreateChain(...t){if("number"==typeof t[0][0]){const e=t[0];if(e.length%2!=0)throw new Error;return this._CreateChain((t=>({x:e[2*t],y:e[2*t+1]})),e.length/2)}{const e=t[0],i=t[1]||e.length;return this._CreateChain((t=>e[t]),i)}}_CreateChain(t,e){this.m_count=e,this.m_vertices=xt.MakeArray(e);for(let i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this}SetPrevVertex(t){return this.m_prevVertex.Copy(t),this.m_hasPrevVertex=!0,this}SetNextVertex(t){return this.m_nextVertex.Copy(t),this.m_hasNextVertex=!0,this}Clone(){return(new hn).Copy(this)}Copy(t){return super.Copy(t),this._CreateChain((e=>t.m_vertices[e]),t.m_count),this.m_prevVertex.Copy(t.m_prevVertex),this.m_nextVertex.Copy(t.m_nextVertex),this.m_hasPrevVertex=t.m_hasPrevVertex,this.m_hasNextVertex=t.m_hasNextVertex,this}GetChildCount(){return this.m_count-1}GetChildEdge(t,e){t.m_radius=this.m_radius,t.m_vertex1.Copy(this.m_vertices[e]),t.m_vertex2.Copy(this.m_vertices[e+1]),e>0?(t.m_vertex0.Copy(this.m_vertices[e-1]),t.m_hasVertex0=!0):(t.m_vertex0.Copy(this.m_prevVertex),t.m_hasVertex0=this.m_hasPrevVertex),e<this.m_count-2?(t.m_vertex3.Copy(this.m_vertices[e+2]),t.m_hasVertex3=!0):(t.m_vertex3.Copy(this.m_nextVertex),t.m_hasVertex3=this.m_hasNextVertex)}TestPoint(t,e){return!1}ComputeDistance(t,e,i,n){const s=hn.ComputeDistance_s_edgeShape;return this.GetChildEdge(s,n),s.ComputeDistance(t,e,i,0)}RayCast(t,e,i,n){const s=hn.RayCast_s_edgeShape;return s.m_vertex1.Copy(this.m_vertices[n]),s.m_vertex2.Copy(this.m_vertices[(n+1)%this.m_count]),s.RayCast(t,e,i,0)}ComputeAABB(t,e,i){const n=this.m_vertices[i],s=this.m_vertices[(i+1)%this.m_count],r=wt.MulXV(e,n,hn.ComputeAABB_s_v1),o=wt.MulXV(e,s,hn.ComputeAABB_s_v2);xt.MinV(r,o,t.lowerBound),xt.MaxV(r,o,t.upperBound)}ComputeMass(t,e){t.mass=0,t.center.SetZero(),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_count?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){return n.SetZero(),0}Dump(t){t("    const shape: b2ChainShape = new b2ChainShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(let e=0;e<this.m_count;++e)t("    vs[%d] = new bVec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.CreateChain(vs, %d);\n",this.m_count),t("    shape.m_prevVertex.Set(%.15f, %.15f);\n",this.m_prevVertex.x,this.m_prevVertex.y),t("    shape.m_nextVertex.Set(%.15f, %.15f);\n",this.m_nextVertex.x,this.m_nextVertex.y),t("    shape.m_hasPrevVertex = %s;\n",this.m_hasPrevVertex?"true":"false"),t("    shape.m_hasNextVertex = %s;\n",this.m_hasNextVertex?"true":"false")}}hn.ComputeDistance_s_edgeShape=new cn,hn.RayCast_s_edgeShape=new cn,hn.ComputeAABB_s_v1=new xt,hn.ComputeAABB_s_v2=new xt;class _n{constructor(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}Clone(){return(new _n).Copy(this)}Copy(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this}}_n.DEFAULT=new _n;class un{constructor(){this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new _n}}class mn{constructor(t,e){this.aabb=new Se,this.childIndex=0,this.fixture=t,this.childIndex=e,this.fixture.m_shape.ComputeAABB(this.aabb,this.fixture.m_body.GetTransform(),e),this.treeNode=this.fixture.m_body.m_world.m_contactManager.m_broadPhase.CreateProxy(this.aabb,this)}Reset(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.DestroyProxy(this.treeNode)}Touch(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.TouchProxy(this.treeNode)}Synchronize(t,e,i){if(t===e)this.fixture.m_shape.ComputeAABB(this.aabb,t,this.childIndex),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i);else{const n=mn.Synchronize_s_aabb1,s=mn.Synchronize_s_aabb2;this.fixture.m_shape.ComputeAABB(n,t,this.childIndex),this.fixture.m_shape.ComputeAABB(s,e,this.childIndex),this.aabb.Combine2(n,s),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i)}}}mn.Synchronize_s_aabb1=new Se,mn.Synchronize_s_aabb2=new Se;class dn{constructor(t,e){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=[],this.m_filter=new _n,this.m_isSensor=!1,this.m_userData=null,this.m_body=t,this.m_shape=e.shape.Clone(),this.m_userData=i(e.userData,null),this.m_friction=i(e.friction,.2),this.m_restitution=i(e.restitution,0),this.m_filter.Copy(i(e.filter,_n.DEFAULT)),this.m_isSensor=i(e.isSensor,!1),this.m_density=i(e.density,0)}get m_proxyCount(){return this.m_proxies.length}Reset(){}GetType(){return this.m_shape.GetType()}GetShape(){return this.m_shape}SetSensor(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)}IsSensor(){return this.m_isSensor}SetFilterData(t){this.m_filter.Copy(t),this.Refilter()}GetFilterData(){return this.m_filter}Refilter(){let t=this.m_body.GetContactList();for(;t;){const e=t.contact,i=e.GetFixtureA(),n=e.GetFixtureB();i!==this&&n!==this||e.FlagForFiltering(),t=t.next}this.TouchProxies()}GetBody(){return this.m_body}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}TestPoint(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)}ComputeDistance(t,e,i){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),t,e,i)}RayCast(t,e,i){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),i)}GetMassData(t=new tn){return this.m_shape.ComputeMass(t,this.m_density),t}SetDensity(t){this.m_density=t}GetDensity(){return this.m_density}GetFriction(){return this.m_friction}SetFriction(t){this.m_friction=t}GetRestitution(){return this.m_restitution}SetRestitution(t){this.m_restitution=t}GetAABB(t){return this.m_proxies[t].aabb}Dump(t,e){t("    const fd: b2FixtureDef = new b2FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.m_friction),t("    fd.restitution = %.15f;\n",this.m_restitution),t("    fd.density = %.15f;\n",this.m_density),t("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)}CreateProxies(){if(0!==this.m_proxies.length)throw new Error;for(let t=0;t<this.m_shape.GetChildCount();++t)this.m_proxies[t]=new mn(this,t)}DestroyProxies(){for(const t of this.m_proxies)t.Reset();this.m_proxies.length=0}TouchProxies(){for(const t of this.m_proxies)t.Touch()}SynchronizeProxies(t,e,i){for(const n of this.m_proxies)n.Synchronize(t,e,i)}}(nn=t.b2BodyType||(t.b2BodyType={}))[nn.b2_unknown=-1]="b2_unknown",nn[nn.b2_staticBody=0]="b2_staticBody",nn[nn.b2_kinematicBody=1]="b2_kinematicBody",nn[nn.b2_dynamicBody=2]="b2_dynamicBody";class pn{constructor(){this.type=t.b2BodyType.b2_staticBody,this.position=new xt(0,0),this.angle=0,this.linearVelocity=new xt(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1}}class fn{constructor(e,n){this.m_type=t.b2BodyType.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new wt,this.m_xf0=new wt,this.m_sweep=new Et,this.m_linearVelocity=new xt,this.m_angularVelocity=0,this.m_force=new xt,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,this.m_bulletFlag=i(e.bullet,!1),this.m_fixedRotationFlag=i(e.fixedRotation,!1),this.m_autoSleepFlag=i(e.allowSleep,!0),this.m_awakeFlag=i(e.awake,!0),this.m_activeFlag=i(e.active,!0),this.m_world=n,this.m_xf.p.Copy(i(e.position,xt.ZERO)),this.m_xf.q.SetAngle(i(e.angle,0)),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(i(e.linearVelocity,xt.ZERO)),this.m_angularVelocity=i(e.angularVelocity,0),this.m_linearDamping=i(e.linearDamping,0),this.m_angularDamping=i(e.angularDamping,0),this.m_gravityScale=i(e.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=i(e.type,t.b2BodyType.b2_staticBody),e.type===t.b2BodyType.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=e.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}CreateFixture(t,e=0){return t instanceof on?this.CreateFixtureShapeDensity(t,e):this.CreateFixtureDef(t)}CreateFixtureDef(t){if(this.m_world.IsLocked())throw new Error;const e=new dn(this,t);return this.m_activeFlag&&e.CreateProxies(),e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newFixture=!0,e}CreateFixtureShapeDensity(t,e=0){const i=fn.CreateFixtureShapeDensity_s_def;return i.shape=t,i.density=e,this.CreateFixtureDef(i)}DestroyFixture(t){if(this.m_world.IsLocked())throw new Error;let e=this.m_fixtureList,i=null;for(;null!==e;){if(e===t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}let n=this.m_contactList;for(;n;){const e=n.contact;n=n.next;const i=e.GetFixtureA(),s=e.GetFixtureB();t!==i&&t!==s||this.m_world.m_contactManager.Destroy(e)}this.m_activeFlag&&t.DestroyProxies(),t.m_next=null,t.Reset(),--this.m_fixtureCount,this.ResetMassData()}SetTransformVec(t,e){this.SetTransformXY(t.x,t.y,e)}SetTransformXY(t,e,i){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(i),this.m_xf.p.Set(t,e),this.m_xf0.Copy(this.m_xf),wt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=i,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=i;for(let t=this.m_fixtureList;t;t=t.m_next)t.SynchronizeProxies(this.m_xf,this.m_xf,xt.ZERO);this.m_world.m_contactManager.FindNewContacts()}SetTransform(t){this.SetTransformVec(t.p,t.GetAngle())}GetTransform(){return this.m_xf}GetPosition(){return this.m_xf.p}SetPosition(t){this.SetTransformVec(t,this.GetAngle())}SetPositionXY(t,e){this.SetTransformXY(t,e,this.GetAngle())}GetAngle(){return this.m_sweep.a}SetAngle(t){this.SetTransformVec(this.GetPosition(),t)}GetWorldCenter(){return this.m_sweep.c}GetLocalCenter(){return this.m_sweep.localCenter}SetLinearVelocity(e){this.m_type!==t.b2BodyType.b2_staticBody&&(xt.DotVV(e,e)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(e))}GetLinearVelocity(){return this.m_linearVelocity}SetAngularVelocity(e){this.m_type!==t.b2BodyType.b2_staticBody&&(e*e>0&&this.SetAwake(!0),this.m_angularVelocity=e)}GetAngularVelocity(){return this.m_angularVelocity}GetDefinition(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t}ApplyForce(e,i,n=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y,this.m_torque+=(i.x-this.m_sweep.c.x)*e.y-(i.y-this.m_sweep.c.y)*e.x))}ApplyForceToCenter(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y))}ApplyTorque(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=e))}ApplyLinearImpulse(e,i,n=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y,this.m_angularVelocity+=this.m_invI*((i.x-this.m_sweep.c.x)*e.y-(i.y-this.m_sweep.c.y)*e.x)))}ApplyLinearImpulseToCenter(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y))}ApplyAngularImpulse(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*e))}GetMass(){return this.m_mass}GetInertia(){return this.m_I+this.m_mass*xt.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)}GetMassData(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*xt.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t}SetMassData(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==t.b2BodyType.b2_dynamicBody)return;this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=e.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,e.I>0&&!this.m_fixedRotationFlag&&(this.m_I=e.I-this.m_mass*xt.DotVV(e.center,e.center),this.m_invI=1/this.m_I);const i=fn.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(e.center),wt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),xt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,xt.SubVV(this.m_sweep.c,i,xt.s_t0),this.m_linearVelocity)}ResetMassData(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===t.b2BodyType.b2_staticBody||this.m_type===t.b2BodyType.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);const e=fn.ResetMassData_s_localCenter.SetZero();for(let t=this.m_fixtureList;t;t=t.m_next){if(0===t.m_density)continue;const i=t.GetMassData(fn.ResetMassData_s_massData);this.m_mass+=i.mass,e.x+=i.center.x*i.mass,e.y+=i.center.y*i.mass,this.m_I+=i.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,e.x*=this.m_invMass,e.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*xt.DotVV(e,e),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);const i=fn.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(e),wt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),xt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,xt.SubVV(this.m_sweep.c,i,xt.s_t0),this.m_linearVelocity)}GetWorldPoint(t,e){return wt.MulXV(this.m_xf,t,e)}GetWorldVector(t,e){return Tt.MulRV(this.m_xf.q,t,e)}GetLocalPoint(t,e){return wt.MulTXV(this.m_xf,t,e)}GetLocalVector(t,e){return Tt.MulTRV(this.m_xf.q,t,e)}GetLinearVelocityFromWorldPoint(t,e){return xt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,xt.SubVV(t,this.m_sweep.c,xt.s_t0),e)}GetLinearVelocityFromLocalPoint(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)}GetLinearDamping(){return this.m_linearDamping}SetLinearDamping(t){this.m_linearDamping=t}GetAngularDamping(){return this.m_angularDamping}SetAngularDamping(t){this.m_angularDamping=t}GetGravityScale(){return this.m_gravityScale}SetGravityScale(t){this.m_gravityScale=t}SetType(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type===e)return;this.m_type=e,this.ResetMassData(),this.m_type===t.b2BodyType.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;let i=this.m_contactList;for(;i;){const t=i;i=i.next,this.m_world.m_contactManager.Destroy(t.contact)}this.m_contactList=null;for(let t=this.m_fixtureList;t;t=t.m_next)t.TouchProxies()}GetType(){return this.m_type}SetBullet(t){this.m_bulletFlag=t}IsBullet(){return this.m_bulletFlag}SetSleepingAllowed(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)}IsSleepingAllowed(){return this.m_autoSleepFlag}SetAwake(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)}IsAwake(){return this.m_awakeFlag}SetActive(t){if(this.m_world.IsLocked())throw new Error;if(t!==this.IsActive())if(this.m_activeFlag=t,t)for(let t=this.m_fixtureList;t;t=t.m_next)t.CreateProxies();else{for(let t=this.m_fixtureList;t;t=t.m_next)t.DestroyProxies();let t=this.m_contactList;for(;t;){const e=t;t=t.next,this.m_world.m_contactManager.Destroy(e.contact)}this.m_contactList=null}}IsActive(){return this.m_activeFlag}SetFixedRotation(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())}IsFixedRotation(){return this.m_fixedRotationFlag}GetFixtureList(){return this.m_fixtureList}GetJointList(){return this.m_jointList}GetContactList(){return this.m_contactList}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}GetWorld(){return this.m_world}Dump(e){const i=this.m_islandIndex;e("{\n"),e("  const bd: b2BodyDef = new b2BodyDef();\n");let n="";switch(this.m_type){case t.b2BodyType.b2_staticBody:n="b2BodyType.b2_staticBody";break;case t.b2BodyType.b2_kinematicBody:n="b2BodyType.b2_kinematicBody";break;case t.b2BodyType.b2_dynamicBody:n="b2BodyType.b2_dynamicBody"}e("  bd.type = %s;\n",n),e("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),e("  bd.angle = %.15f;\n",this.m_sweep.a),e("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),e("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),e("  bd.linearDamping = %.15f;\n",this.m_linearDamping),e("  bd.angularDamping = %.15f;\n",this.m_angularDamping),e("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),e("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),e("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),e("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),e("  bd.active = %s;\n",this.m_activeFlag?"true":"false"),e("  bd.gravityScale = %.15f;\n",this.m_gravityScale),e("\n"),e("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),e("\n");for(let t=this.m_fixtureList;t;t=t.m_next)e("  {\n"),t.Dump(e,i),e("  }\n");e("}\n")}SynchronizeFixtures(){const t=fn.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),Tt.MulRV(t.q,this.m_sweep.localCenter,t.p),xt.SubVV(this.m_sweep.c0,t.p,t.p);const e=xt.SubVV(this.m_sweep.c,this.m_sweep.c0,fn.SynchronizeFixtures_s_displacement);for(let i=this.m_fixtureList;i;i=i.m_next)i.SynchronizeProxies(t,this.m_xf,e)}SynchronizeTransform(){this.m_xf.q.SetAngle(this.m_sweep.a),Tt.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),xt.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}ShouldCollide(e){return(this.m_type!==t.b2BodyType.b2_staticBody||e.m_type!==t.b2BodyType.b2_staticBody)&&this.ShouldCollideConnected(e)}ShouldCollideConnected(t){for(let e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0}Advance(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),Tt.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),xt.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}GetControllerList(){return this.m_controllerList}GetControllerCount(){return this.m_controllerCount}}fn.CreateFixtureShapeDensity_s_def=new un,fn.SetMassData_s_oldCenter=new xt,fn.ResetMassData_s_localCenter=new xt,fn.ResetMassData_s_oldCenter=new xt,fn.ResetMassData_s_massData=new tn,fn.SynchronizeFixtures_s_xf1=new wt,fn.SynchronizeFixtures_s_displacement=new xt,(rn=t.b2JointType||(t.b2JointType={}))[rn.e_unknownJoint=0]="e_unknownJoint",rn[rn.e_revoluteJoint=1]="e_revoluteJoint",rn[rn.e_prismaticJoint=2]="e_prismaticJoint",rn[rn.e_distanceJoint=3]="e_distanceJoint",rn[rn.e_pulleyJoint=4]="e_pulleyJoint",rn[rn.e_mouseJoint=5]="e_mouseJoint",rn[rn.e_gearJoint=6]="e_gearJoint",rn[rn.e_wheelJoint=7]="e_wheelJoint",rn[rn.e_weldJoint=8]="e_weldJoint",rn[rn.e_frictionJoint=9]="e_frictionJoint",rn[rn.e_ropeJoint=10]="e_ropeJoint",rn[rn.e_motorJoint=11]="e_motorJoint",rn[rn.e_areaJoint=12]="e_areaJoint",(sn=t.b2LimitState||(t.b2LimitState={}))[sn.e_inactiveLimit=0]="e_inactiveLimit",sn[sn.e_atLowerLimit=1]="e_atLowerLimit",sn[sn.e_atUpperLimit=2]="e_atUpperLimit",sn[sn.e_equalLimits=3]="e_equalLimits";class gn{constructor(){this.linear=new xt,this.angularA=0,this.angularB=0}SetZero(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this}Set(t,e,i){return this.linear.Copy(t),this.angularA=e,this.angularB=i,this}}class yn{constructor(t){this._other=null,this.prev=null,this.next=null,this.joint=t}get other(){if(null===this._other)throw new Error;return this._other}set other(t){if(null!==this._other)throw new Error;this._other=t}Reset(){this._other=null,this.prev=null,this.next=null}}class vn{constructor(e){this.type=t.b2JointType.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=e}}class xn{constructor(e){this.m_type=t.b2JointType.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_edgeA=new yn(this),this.m_edgeB=new yn(this),this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=e.type,this.m_edgeA.other=e.bodyB,this.m_edgeB.other=e.bodyA,this.m_bodyA=e.bodyA,this.m_bodyB=e.bodyB,this.m_collideConnected=i(e.collideConnected,!1),this.m_userData=i(e.userData,null)}GetType(){return this.m_type}GetBodyA(){return this.m_bodyA}GetBodyB(){return this.m_bodyB}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}IsActive(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()}GetCollideConnected(){return this.m_collideConnected}Dump(t){t("// Dump is not supported for this joint type.\n")}ShiftOrigin(t){}}class Sn extends vn{constructor(){super(t.b2JointType.e_distanceJoint),this.localAnchorA=new xt,this.localAnchorB=new xt,this.length=1,this.frequencyHz=0,this.dampingRatio=0}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.length=xt.DistanceVV(i,n),this.frequencyHz=0,this.dampingRatio=0}}class An extends xn{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_bias=0,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_gamma=0,this.m_impulse=0,this.m_length=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_frequencyHz=i(t.frequencyHz,0),this.m_dampingRatio=i(t.dampingRatio,0),this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_length=t.length}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse*this.m_u.x,e.y=t*this.m_impulse*this.m_u.y,e}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetLength(t){this.m_length=t}Length(){return this.m_length}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.length = %.15f;\n",this.m_length),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v;let c=t.velocities[this.m_indexB].w;const h=this.m_qA.SetAngle(i),u=this.m_qB.SetAngle(a);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(h,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(u,this.m_lalcB,this.m_rB),this.m_u.x=r.x+this.m_rB.x-e.x-this.m_rA.x,this.m_u.y=r.y+this.m_rB.y-e.y-this.m_rA.y;const m=this.m_u.Length();m>_?this.m_u.SelfMul(1/m):this.m_u.SetZero();const d=xt.CrossVV(this.m_rA,this.m_u),p=xt.CrossVV(this.m_rB,this.m_u);let f=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=0!==f?1/f:0,this.m_frequencyHz>0){const e=m-this.m_length,i=2*o*this.m_frequencyHz,n=2*this.m_mass*this.m_dampingRatio*i,s=this.m_mass*i*i,r=t.step.dt;this.m_gamma=r*(n+r*s),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=e*r*s*this.m_gamma,f+=this.m_gamma,this.m_mass=0!==f?1/f:0}else this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const e=xt.MulSV(this.m_impulse,this.m_u,An.InitVelocityConstraints_s_P);n.SelfMulSub(this.m_invMassA,e),s-=this.m_invIA*xt.CrossVV(this.m_rA,e),l.SelfMulAdd(this.m_invMassB,e),c+=this.m_invIB*xt.CrossVV(this.m_rB,e)}else this.m_impulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=c}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=xt.AddVCrossSV(e,i,this.m_rA,An.SolveVelocityConstraints_s_vpA),o=xt.AddVCrossSV(n,s,this.m_rB,An.SolveVelocityConstraints_s_vpB),a=xt.DotVV(this.m_u,xt.SubVV(o,r,xt.s_t0)),l=-this.m_mass*(a+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=l;const c=xt.MulSV(l,this.m_u,An.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,c),i-=this.m_invIA*xt.CrossVV(this.m_rA,c),n.SelfMulAdd(this.m_invMassB,c),s+=this.m_invIB*xt.CrossVV(this.m_rB,c),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){if(this.m_frequencyHz>0)return!0;const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s),a=Tt.MulRV(r,this.m_lalcA,this.m_rA),l=Tt.MulRV(o,this.m_lalcB,this.m_rB),c=this.m_u;c.x=n.x+l.x-e.x-a.x,c.y=n.y+l.y-e.y-a.y;let h=this.m_u.Normalize()-this.m_length;h=it(h,-g,g);const u=-this.m_mass*h,m=xt.MulSV(u,c,An.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,m),i-=this.m_invIA*xt.CrossVV(a,m),n.SelfMulAdd(this.m_invMassB,m),s+=this.m_invIB*xt.CrossVV(l,m),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,Q(h)<_}}An.InitVelocityConstraints_s_P=new xt,An.SolveVelocityConstraints_s_vpA=new xt,An.SolveVelocityConstraints_s_vpB=new xt,An.SolveVelocityConstraints_s_P=new xt,An.SolvePositionConstraints_s_P=new xt;class Cn extends vn{constructor(){super(t.b2JointType.e_areaJoint),this.bodies=[],this.frequencyHz=0,this.dampingRatio=0}AddBody(t){this.bodies.push(t),1===this.bodies.length?this.bodyA=t:2===this.bodies.length&&(this.bodyB=t)}}class bn extends xn{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_impulse=0,this.m_targetArea=0,this.m_delta=new xt,this.m_bodies=t.bodies,this.m_frequencyHz=i(t.frequencyHz,0),this.m_dampingRatio=i(t.dampingRatio,0),this.m_targetLengths=K(t.bodies.length),this.m_normals=xt.MakeArray(t.bodies.length),this.m_joints=[],this.m_deltas=xt.MakeArray(t.bodies.length);const e=new Sn;e.frequencyHz=this.m_frequencyHz,e.dampingRatio=this.m_dampingRatio,this.m_targetArea=0;for(let t=0;t<this.m_bodies.length;++t){const i=this.m_bodies[t],n=this.m_bodies[(t+1)%this.m_bodies.length],s=i.GetWorldCenter(),r=n.GetWorldCenter();this.m_targetLengths[t]=xt.DistanceVV(s,r),this.m_targetArea+=xt.CrossVV(s,r),e.Initialize(i,n,s,r),this.m_joints[t]=i.GetWorld().CreateJoint(e)}this.m_targetArea*=.5}GetAnchorA(t){return t}GetAnchorB(t){return t}GetReactionForce(t,e){return e}GetReactionTorque(t){return 0}SetFrequency(t){this.m_frequencyHz=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetFrequency(t)}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDampingRatio(t)}GetDampingRatio(){return this.m_dampingRatio}Dump(t){t("Area joint dumping is not supported.\n")}InitVelocityConstraints(t){for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],n=this.m_bodies[(e+1)%this.m_bodies.length],s=t.positions[i.m_islandIndex].c,r=t.positions[n.m_islandIndex].c,o=this.m_deltas[e];xt.SubVV(r,s,o)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],n=t.velocities[i.m_islandIndex].v,s=this.m_deltas[e];n.x+=i.m_invMass*s.y*.5*this.m_impulse,n.y+=i.m_invMass*-s.x*.5*this.m_impulse}}else this.m_impulse=0}SolveVelocityConstraints(t){let e=0,i=0;for(let n=0;n<this.m_bodies.length;++n){const s=this.m_bodies[n],r=t.velocities[s.m_islandIndex].v,o=this.m_deltas[n];e+=o.LengthSquared()/s.GetMass(),i+=xt.CrossVV(r,o)}const n=-2*i/e;this.m_impulse+=n;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],s=t.velocities[i.m_islandIndex].v,r=this.m_deltas[e];s.x+=i.m_invMass*r.y*.5*n,s.y+=i.m_invMass*-r.x*.5*n}}SolvePositionConstraints(t){let e=0,i=0;for(let n=0;n<this.m_bodies.length;++n){const r=this.m_bodies[n],o=this.m_bodies[(n+1)%this.m_bodies.length],a=t.positions[r.m_islandIndex].c,l=t.positions[o.m_islandIndex].c,c=xt.SubVV(l,a,this.m_delta);let h=c.Length();h<s&&(h=1),this.m_normals[n].x=c.y/h,this.m_normals[n].y=-c.x/h,e+=h,i+=xt.CrossVV(a,l)}i*=.5;const n=.5*(this.m_targetArea-i)/e;let r=!0;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],s=t.positions[i.m_islandIndex].c,o=(e+1)%this.m_bodies.length,a=xt.AddVV(this.m_normals[e],this.m_normals[o],this.m_delta);a.SelfMul(n);const l=a.LengthSquared();l>rt(g)&&a.SelfMul(g/at(l)),l>rt(_)&&(r=!1),s.x+=a.x,s.y+=a.y}return r}}class Tn extends vn{constructor(){super(t.b2JointType.e_frictionJoint),this.localAnchorA=new xt,this.localAnchorB=new xt,this.maxForce=0,this.maxTorque=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB)}}class wn extends xn{constructor(t){super(t),this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_linearImpulse=new xt,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new Ct,this.m_angularMass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_K=new Ct,this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_linearImpulse.SetZero(),this.m_maxForce=i(t.maxForce,0),this.m_maxTorque=i(t.maxTorque,0),this.m_linearMass.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const s=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const a=this.m_qA.SetAngle(e),l=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const c=Tt.MulRV(a,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const h=Tt.MulRV(l,this.m_lalcB,this.m_rB),_=this.m_invMassA,u=this.m_invMassB,m=this.m_invIA,d=this.m_invIB,p=this.m_K;if(p.ex.x=_+u+m*c.y*c.y+d*h.y*h.y,p.ex.y=-m*c.x*c.y-d*h.x*h.y,p.ey.x=p.ex.y,p.ey.y=_+u+m*c.x*c.x+d*h.x*h.x,p.GetInverse(this.m_linearMass),this.m_angularMass=m+d,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const e=this.m_linearImpulse;i.SelfMulSub(_,e),n-=m*(xt.CrossVV(this.m_rA,e)+this.m_angularImpulse),r.SelfMulAdd(u,e),o+=d*(xt.CrossVV(this.m_rB,e)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=this.m_invMassA,o=this.m_invMassB,a=this.m_invIA,l=this.m_invIB,c=t.step.dt;{const t=s-i;let e=-this.m_angularMass*t;const n=this.m_angularImpulse,r=c*this.m_maxTorque;this.m_angularImpulse=it(this.m_angularImpulse+e,-r,r),e=this.m_angularImpulse-n,i-=a*e,s+=l*e}{const t=xt.SubVV(xt.AddVCrossSV(n,s,this.m_rB,xt.s_t0),xt.AddVCrossSV(e,i,this.m_rA,xt.s_t1),wn.SolveVelocityConstraints_s_Cdot_v2),h=Ct.MulMV(this.m_linearMass,t,wn.SolveVelocityConstraints_s_impulseV).SelfNeg(),_=wn.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(h);const u=c*this.m_maxForce;this.m_linearImpulse.LengthSquared()>u*u&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(u)),xt.SubVV(this.m_linearImpulse,_,h),e.SelfMulSub(r,h),i-=a*xt.CrossVV(this.m_rA,h),n.SelfMulAdd(o,h),s+=l*xt.CrossVV(this.m_rB,h)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){return!0}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_linearImpulse.x,e.y=t*this.m_linearImpulse.y,e}GetReactionTorque(t){return t*this.m_angularImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}wn.SolveVelocityConstraints_s_Cdot_v2=new xt,wn.SolveVelocityConstraints_s_impulseV=new xt,wn.SolveVelocityConstraints_s_oldImpulseV=new xt;class En extends vn{constructor(){super(t.b2JointType.e_gearJoint),this.ratio=1}}class Pn extends xn{constructor(e){let n,s;super(e),this.m_typeA=t.b2JointType.e_unknownJoint,this.m_typeB=t.b2JointType.e_unknownJoint,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_localAnchorC=new xt,this.m_localAnchorD=new xt,this.m_localAxisC=new xt,this.m_localAxisD=new xt,this.m_referenceAngleA=0,this.m_referenceAngleB=0,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_indexC=0,this.m_indexD=0,this.m_lcA=new xt,this.m_lcB=new xt,this.m_lcC=new xt,this.m_lcD=new xt,this.m_mA=0,this.m_mB=0,this.m_mC=0,this.m_mD=0,this.m_iA=0,this.m_iB=0,this.m_iC=0,this.m_iD=0,this.m_JvAC=new xt,this.m_JvBD=new xt,this.m_JwA=0,this.m_JwB=0,this.m_JwC=0,this.m_JwD=0,this.m_mass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_qC=new Tt,this.m_qD=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_lalcC=new xt,this.m_lalcD=new xt,this.m_joint1=e.joint1,this.m_joint2=e.joint2,this.m_typeA=this.m_joint1.GetType(),this.m_typeB=this.m_joint2.GetType(),this.m_bodyC=this.m_joint1.GetBodyA(),this.m_bodyA=this.m_joint1.GetBodyB();const r=this.m_bodyA.m_xf,o=this.m_bodyA.m_sweep.a,a=this.m_bodyC.m_xf,l=this.m_bodyC.m_sweep.a;if(this.m_typeA===t.b2JointType.e_revoluteJoint){const t=e.joint1;this.m_localAnchorC.Copy(t.m_localAnchorA),this.m_localAnchorA.Copy(t.m_localAnchorB),this.m_referenceAngleA=t.m_referenceAngle,this.m_localAxisC.SetZero(),n=o-l-this.m_referenceAngleA}else{const t=e.joint1;this.m_localAnchorC.Copy(t.m_localAnchorA),this.m_localAnchorA.Copy(t.m_localAnchorB),this.m_referenceAngleA=t.m_referenceAngle,this.m_localAxisC.Copy(t.m_localXAxisA);const i=this.m_localAnchorC,s=Tt.MulTRV(a.q,xt.AddVV(Tt.MulRV(r.q,this.m_localAnchorA,xt.s_t0),xt.SubVV(r.p,a.p,xt.s_t1),xt.s_t0),xt.s_t0);n=xt.DotVV(xt.SubVV(s,i,xt.s_t0),this.m_localAxisC)}this.m_bodyD=this.m_joint2.GetBodyA(),this.m_bodyB=this.m_joint2.GetBodyB();const c=this.m_bodyB.m_xf,h=this.m_bodyB.m_sweep.a,_=this.m_bodyD.m_xf,u=this.m_bodyD.m_sweep.a;if(this.m_typeB===t.b2JointType.e_revoluteJoint){const t=e.joint2;this.m_localAnchorD.Copy(t.m_localAnchorA),this.m_localAnchorB.Copy(t.m_localAnchorB),this.m_referenceAngleB=t.m_referenceAngle,this.m_localAxisD.SetZero(),s=h-u-this.m_referenceAngleB}else{const t=e.joint2;this.m_localAnchorD.Copy(t.m_localAnchorA),this.m_localAnchorB.Copy(t.m_localAnchorB),this.m_referenceAngleB=t.m_referenceAngle,this.m_localAxisD.Copy(t.m_localXAxisA);const i=this.m_localAnchorD,n=Tt.MulTRV(_.q,xt.AddVV(Tt.MulRV(c.q,this.m_localAnchorB,xt.s_t0),xt.SubVV(c.p,_.p,xt.s_t1),xt.s_t0),xt.s_t0);s=xt.DotVV(xt.SubVV(n,i,xt.s_t0),this.m_localAxisD)}this.m_ratio=i(e.ratio,1),this.m_constant=n+this.m_ratio*s,this.m_impulse=0}InitVelocityConstraints(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;const i=e.positions[this.m_indexA].a,n=e.velocities[this.m_indexA].v;let s=e.velocities[this.m_indexA].w;const r=e.positions[this.m_indexB].a,o=e.velocities[this.m_indexB].v;let a=e.velocities[this.m_indexB].w;const l=e.positions[this.m_indexC].a,c=e.velocities[this.m_indexC].v;let h=e.velocities[this.m_indexC].w;const _=e.positions[this.m_indexD].a,u=e.velocities[this.m_indexD].v;let m=e.velocities[this.m_indexD].w;const d=this.m_qA.SetAngle(i),p=this.m_qB.SetAngle(r),f=this.m_qC.SetAngle(l),g=this.m_qD.SetAngle(_);if(this.m_mass=0,this.m_typeA===t.b2JointType.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{const t=Tt.MulRV(f,this.m_localAxisC,Pn.InitVelocityConstraints_s_u);xt.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);const e=Tt.MulRV(f,this.m_lalcC,Pn.InitVelocityConstraints_s_rC);xt.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);const i=Tt.MulRV(d,this.m_lalcA,Pn.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(t),this.m_JwC=xt.CrossVV(e,t),this.m_JwA=xt.CrossVV(i,t),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===t.b2JointType.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{const t=Tt.MulRV(g,this.m_localAxisD,Pn.InitVelocityConstraints_s_u);xt.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);const e=Tt.MulRV(g,this.m_lalcD,Pn.InitVelocityConstraints_s_rD);xt.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);const i=Tt.MulRV(p,this.m_lalcB,Pn.InitVelocityConstraints_s_rB);xt.MulSV(this.m_ratio,t,this.m_JvBD),this.m_JwD=this.m_ratio*xt.CrossVV(e,t),this.m_JwB=this.m_ratio*xt.CrossVV(i,t),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,e.step.warmStarting?(n.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),s+=this.m_iA*this.m_impulse*this.m_JwA,o.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),a+=this.m_iB*this.m_impulse*this.m_JwB,c.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),h-=this.m_iC*this.m_impulse*this.m_JwC,u.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),m-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,e.velocities[this.m_indexA].w=s,e.velocities[this.m_indexB].w=a,e.velocities[this.m_indexC].w=h,e.velocities[this.m_indexD].w=m}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=t.velocities[this.m_indexC].v;let o=t.velocities[this.m_indexC].w;const a=t.velocities[this.m_indexD].v;let l=t.velocities[this.m_indexD].w,c=xt.DotVV(this.m_JvAC,xt.SubVV(e,r,xt.s_t0))+xt.DotVV(this.m_JvBD,xt.SubVV(n,a,xt.s_t0));c+=this.m_JwA*i-this.m_JwC*o+(this.m_JwB*s-this.m_JwD*l);const h=-this.m_mass*c;this.m_impulse+=h,e.SelfMulAdd(this.m_mA*h,this.m_JvAC),i+=this.m_iA*h*this.m_JwA,n.SelfMulAdd(this.m_mB*h,this.m_JvBD),s+=this.m_iB*h*this.m_JwB,r.SelfMulSub(this.m_mC*h,this.m_JvAC),o-=this.m_iC*h*this.m_JwC,a.SelfMulSub(this.m_mD*h,this.m_JvBD),l-=this.m_iD*h*this.m_JwD,t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s,t.velocities[this.m_indexC].w=o,t.velocities[this.m_indexD].w=l}SolvePositionConstraints(e){const i=e.positions[this.m_indexA].c;let n=e.positions[this.m_indexA].a;const s=e.positions[this.m_indexB].c;let r=e.positions[this.m_indexB].a;const o=e.positions[this.m_indexC].c;let a=e.positions[this.m_indexC].a;const l=e.positions[this.m_indexD].c;let c=e.positions[this.m_indexD].a;const h=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(r),m=this.m_qC.SetAngle(a),d=this.m_qD.SetAngle(c),p=0;let f,g;const y=this.m_JvAC,v=this.m_JvBD;let x,S,A,C,b=0;if(this.m_typeA===t.b2JointType.e_revoluteJoint)y.SetZero(),x=1,A=1,b+=this.m_iA+this.m_iC,f=n-a-this.m_referenceAngleA;else{const t=Tt.MulRV(m,this.m_localAxisC,Pn.SolvePositionConstraints_s_u),e=Tt.MulRV(m,this.m_lalcC,Pn.SolvePositionConstraints_s_rC),n=Tt.MulRV(h,this.m_lalcA,Pn.SolvePositionConstraints_s_rA);y.Copy(t),A=xt.CrossVV(e,t),x=xt.CrossVV(n,t),b+=this.m_mC+this.m_mA+this.m_iC*A*A+this.m_iA*x*x;const s=this.m_lalcC,r=Tt.MulTRV(m,xt.AddVV(n,xt.SubVV(i,o,xt.s_t0),xt.s_t0),xt.s_t0);f=xt.DotVV(xt.SubVV(r,s,xt.s_t0),this.m_localAxisC)}if(this.m_typeB===t.b2JointType.e_revoluteJoint)v.SetZero(),S=this.m_ratio,C=this.m_ratio,b+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),g=r-c-this.m_referenceAngleB;else{const t=Tt.MulRV(d,this.m_localAxisD,Pn.SolvePositionConstraints_s_u),e=Tt.MulRV(d,this.m_lalcD,Pn.SolvePositionConstraints_s_rD),i=Tt.MulRV(u,this.m_lalcB,Pn.SolvePositionConstraints_s_rB);xt.MulSV(this.m_ratio,t,v),C=this.m_ratio*xt.CrossVV(e,t),S=this.m_ratio*xt.CrossVV(i,t),b+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*C*C+this.m_iB*S*S;const n=this.m_lalcD,r=Tt.MulTRV(d,xt.AddVV(i,xt.SubVV(s,l,xt.s_t0),xt.s_t0),xt.s_t0);g=xt.DotVV(xt.SubVV(r,n,xt.s_t0),this.m_localAxisD)}const T=f+this.m_ratio*g-this.m_constant;let w=0;return b>0&&(w=-T/b),i.SelfMulAdd(this.m_mA*w,y),n+=this.m_iA*w*x,s.SelfMulAdd(this.m_mB*w,v),r+=this.m_iB*w*S,o.SelfMulSub(this.m_mC*w,y),a-=this.m_iC*w*A,l.SelfMulSub(this.m_mD*w,v),c-=this.m_iD*w*C,e.positions[this.m_indexA].a=n,e.positions[this.m_indexB].a=r,e.positions[this.m_indexC].a=a,e.positions[this.m_indexD].a=c,p<_}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return xt.MulSV(t*this.m_impulse,this.m_JvAC,e)}GetReactionTorque(t){return t*this.m_impulse*this.m_JwA}GetJoint1(){return this.m_joint1}GetJoint2(){return this.m_joint2}GetRatio(){return this.m_ratio}SetRatio(t){this.m_ratio=t}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex,n=this.m_joint1.m_index,s=this.m_joint2.m_index;t("  const jd: b2GearJointDef = new b2GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",n),t("  jd.joint2 = joints[%d];\n",s),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Pn.InitVelocityConstraints_s_u=new xt,Pn.InitVelocityConstraints_s_rA=new xt,Pn.InitVelocityConstraints_s_rB=new xt,Pn.InitVelocityConstraints_s_rC=new xt,Pn.InitVelocityConstraints_s_rD=new xt,Pn.SolvePositionConstraints_s_u=new xt,Pn.SolvePositionConstraints_s_rA=new xt,Pn.SolvePositionConstraints_s_rB=new xt,Pn.SolvePositionConstraints_s_rC=new xt,Pn.SolvePositionConstraints_s_rD=new xt;class In extends vn{constructor(){super(t.b2JointType.e_motorJoint),this.linearOffset=new xt(0,0),this.angularOffset=0,this.maxForce=1,this.maxTorque=1,this.correctionFactor=.3}Initialize(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);const i=this.bodyA.GetAngle(),n=this.bodyB.GetAngle();this.angularOffset=n-i}}class Dn extends xn{constructor(t){super(t),this.m_linearOffset=new xt,this.m_angularOffset=0,this.m_linearImpulse=new xt,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_correctionFactor=.3,this.m_indexA=0,this.m_indexB=0,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_linearError=new xt,this.m_angularError=0,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new Ct,this.m_angularMass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_K=new Ct,this.m_linearOffset.Copy(i(t.linearOffset,xt.ZERO)),this.m_linearImpulse.SetZero(),this.m_maxForce=i(t.maxForce,0),this.m_maxTorque=i(t.maxTorque,0),this.m_correctionFactor=i(t.correctionFactor,.3)}GetAnchorA(t){const e=this.m_bodyA.GetPosition();return t.x=e.x,t.y=e.y,t}GetAnchorB(t){const e=this.m_bodyB.GetPosition();return t.x=e.x,t.y=e.y,t}GetReactionForce(t,e){return xt.MulSV(t,this.m_linearImpulse,e)}GetReactionTorque(t){return t*this.m_angularImpulse}SetLinearOffset(t){xt.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))}GetLinearOffset(){return this.m_linearOffset}SetAngularOffset(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)}GetAngularOffset(){return this.m_angularOffset}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v;let l=t.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(i),h=this.m_qB.SetAngle(o),_=Tt.MulRV(c,xt.SubVV(this.m_linearOffset,this.m_localCenterA,xt.s_t0),this.m_rA),u=Tt.MulRV(h,xt.NegV(this.m_localCenterB,xt.s_t0),this.m_rB),m=this.m_invMassA,d=this.m_invMassB,p=this.m_invIA,f=this.m_invIB,g=this.m_K;if(g.ex.x=m+d+p*_.y*_.y+f*u.y*u.y,g.ex.y=-p*_.x*_.y-f*u.x*u.y,g.ey.x=g.ex.y,g.ey.y=m+d+p*_.x*_.x+f*u.x*u.x,g.GetInverse(this.m_linearMass),this.m_angularMass=p+f,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),xt.SubVV(xt.AddVV(r,u,xt.s_t0),xt.AddVV(e,_,xt.s_t1),this.m_linearError),this.m_angularError=o-i-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const e=this.m_linearImpulse;n.SelfMulSub(m,e),s-=p*(xt.CrossVV(_,e)+this.m_angularImpulse),a.SelfMulAdd(d,e),l+=f*(xt.CrossVV(u,e)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=l}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=this.m_invMassA,o=this.m_invMassB,a=this.m_invIA,l=this.m_invIB,c=t.step.dt,h=t.step.inv_dt;{const t=s-i+h*this.m_correctionFactor*this.m_angularError;let e=-this.m_angularMass*t;const n=this.m_angularImpulse,r=c*this.m_maxTorque;this.m_angularImpulse=it(this.m_angularImpulse+e,-r,r),e=this.m_angularImpulse-n,i-=a*e,s+=l*e}{const t=this.m_rA,_=this.m_rB,u=xt.AddVV(xt.SubVV(xt.AddVV(n,xt.CrossSV(s,_,xt.s_t0),xt.s_t0),xt.AddVV(e,xt.CrossSV(i,t,xt.s_t1),xt.s_t1),xt.s_t2),xt.MulSV(h*this.m_correctionFactor,this.m_linearError,xt.s_t3),Dn.SolveVelocityConstraints_s_Cdot_v2),m=Ct.MulMV(this.m_linearMass,u,Dn.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),d=Dn.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(m);const p=c*this.m_maxForce;this.m_linearImpulse.LengthSquared()>p*p&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(p)),xt.SubVV(this.m_linearImpulse,d,m),e.SelfMulSub(r,m),i-=a*xt.CrossVV(t,m),n.SelfMulAdd(o,m),s+=l*xt.CrossVV(_,m)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){return!0}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.m_angularOffset),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Dn.SolveVelocityConstraints_s_Cdot_v2=new xt,Dn.SolveVelocityConstraints_s_impulse_v2=new xt,Dn.SolveVelocityConstraints_s_oldImpulse_v2=new xt;class Rn extends vn{constructor(){super(t.b2JointType.e_mouseJoint),this.target=new xt,this.maxForce=0,this.frequencyHz=5,this.dampingRatio=.7}}class Mn extends xn{constructor(t){super(t),this.m_localAnchorB=new xt,this.m_targetA=new xt,this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_beta=0,this.m_impulse=new xt,this.m_maxForce=0,this.m_gamma=0,this.m_indexA=0,this.m_indexB=0,this.m_rB=new xt,this.m_localCenterB=new xt,this.m_invMassB=0,this.m_invIB=0,this.m_mass=new Ct,this.m_C=new xt,this.m_qB=new Tt,this.m_lalcB=new xt,this.m_K=new Ct,this.m_targetA.Copy(i(t.target,xt.ZERO)),wt.MulTXV(this.m_bodyB.GetTransform(),this.m_targetA,this.m_localAnchorB),this.m_maxForce=i(t.maxForce,0),this.m_impulse.SetZero(),this.m_frequencyHz=i(t.frequencyHz,0),this.m_dampingRatio=i(t.dampingRatio,0),this.m_beta=0,this.m_gamma=0}SetTarget(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)}GetTarget(){return this.m_targetA}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}InitVelocityConstraints(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexB].c,i=t.positions[this.m_indexB].a,n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=this.m_qB.SetAngle(i),a=this.m_bodyB.GetMass(),l=2*o*this.m_frequencyHz,c=2*a*this.m_dampingRatio*l,h=a*l*l,_=t.step.dt;this.m_gamma=_*(c+_*h),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=_*h*this.m_gamma,xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(r,this.m_lalcB,this.m_rB);const u=this.m_K;u.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,u.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,u.ey.x=u.ex.y,u.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,u.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),s*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),n.x+=this.m_invMassB*this.m_impulse.x,n.y+=this.m_invMassB*this.m_impulse.y,s+=this.m_invIB*xt.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=s}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexB].v;let i=t.velocities[this.m_indexB].w;const n=xt.AddVCrossSV(e,i,this.m_rB,Mn.SolveVelocityConstraints_s_Cdot),s=Ct.MulMV(this.m_mass,xt.AddVV(n,xt.AddVV(this.m_C,xt.MulSV(this.m_gamma,this.m_impulse,xt.s_t0),xt.s_t0),xt.s_t0).SelfNeg(),Mn.SolveVelocityConstraints_s_impulse),r=Mn.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(s);const o=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>o*o&&this.m_impulse.SelfMul(o/this.m_impulse.Length()),xt.SubVV(this.m_impulse,r,s),e.SelfMulAdd(this.m_invMassB,s),i+=this.m_invIB*xt.CrossVV(this.m_rB,s),t.velocities[this.m_indexB].w=i}SolvePositionConstraints(t){return!0}GetAnchorA(t){return t.x=this.m_targetA.x,t.y=this.m_targetA.y,t}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return xt.MulSV(t,this.m_impulse,e)}GetReactionTorque(t){return 0}Dump(t){t("Mouse joint dumping is not supported.\n")}ShiftOrigin(t){this.m_targetA.SelfSub(t)}}Mn.SolveVelocityConstraints_s_Cdot=new xt,Mn.SolveVelocityConstraints_s_impulse=new xt,Mn.SolveVelocityConstraints_s_oldImpulse=new xt;class Bn extends vn{constructor(){super(t.b2JointType.e_prismaticJoint),this.localAnchorA=new xt,this.localAnchorB=new xt,this.localAxisA=new xt(1,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class On extends xn{constructor(e){super(e),this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_localXAxisA=new xt,this.m_localYAxisA=new xt,this.m_referenceAngle=0,this.m_impulse=new At(0,0,0),this.m_motorImpulse=0,this.m_lowerTranslation=0,this.m_upperTranslation=0,this.m_maxMotorForce=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_enableMotor=!1,this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_axis=new xt(0,0),this.m_perp=new xt(0,0),this.m_s1=0,this.m_s2=0,this.m_a1=0,this.m_a2=0,this.m_K=new bt,this.m_K3=new bt,this.m_K2=new Ct,this.m_motorMass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_localAnchorA.Copy(i(e.localAnchorA,xt.ZERO)),this.m_localAnchorB.Copy(i(e.localAnchorB,xt.ZERO)),this.m_localXAxisA.Copy(i(e.localAxisA,new xt(1,0))).SelfNormalize(),xt.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_referenceAngle=i(e.referenceAngle,0),this.m_lowerTranslation=i(e.lowerTranslation,0),this.m_upperTranslation=i(e.upperTranslation,0),this.m_maxMotorForce=i(e.maxMotorForce,0),this.m_motorSpeed=i(e.motorSpeed,0),this.m_enableLimit=i(e.enableLimit,!1),this.m_enableMotor=i(e.enableMotor,!1)}InitVelocityConstraints(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const i=e.positions[this.m_indexA].c,n=e.positions[this.m_indexA].a,s=e.velocities[this.m_indexA].v;let r=e.velocities[this.m_indexA].w;const o=e.positions[this.m_indexB].c,a=e.positions[this.m_indexB].a,l=e.velocities[this.m_indexB].v;let c=e.velocities[this.m_indexB].w;const h=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(a);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const m=Tt.MulRV(h,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const d=Tt.MulRV(u,this.m_lalcB,this.m_rB),p=xt.AddVV(xt.SubVV(o,i,xt.s_t0),xt.SubVV(d,m,xt.s_t1),On.InitVelocityConstraints_s_d),f=this.m_invMassA,g=this.m_invMassB,y=this.m_invIA,v=this.m_invIB;if(Tt.MulRV(h,this.m_localXAxisA,this.m_axis),this.m_a1=xt.CrossVV(xt.AddVV(p,m,xt.s_t0),this.m_axis),this.m_a2=xt.CrossVV(d,this.m_axis),this.m_motorMass=f+g+y*this.m_a1*this.m_a1+v*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),Tt.MulRV(h,this.m_localYAxisA,this.m_perp),this.m_s1=xt.CrossVV(xt.AddVV(p,m,xt.s_t0),this.m_perp),this.m_s2=xt.CrossVV(d,this.m_perp),this.m_K.ex.x=f+g+y*this.m_s1*this.m_s1+v*this.m_s2*this.m_s2,this.m_K.ex.y=y*this.m_s1+v*this.m_s2,this.m_K.ex.z=y*this.m_s1*this.m_a1+v*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=y+v,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_K.ey.z=y*this.m_a1+v*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=f+g+y*this.m_a1*this.m_a1+v*this.m_a2*this.m_a2,this.m_enableLimit){const e=xt.DotVV(this.m_axis,p);Q(this.m_upperTranslation-this.m_lowerTranslation)<2*_?this.m_limitState=t.b2LimitState.e_equalLimits:e<=this.m_lowerTranslation?this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_limitState=t.b2LimitState.e_atLowerLimit,this.m_impulse.z=0):e>=this.m_upperTranslation?this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_limitState=t.b2LimitState.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;const t=xt.AddVV(xt.MulSV(this.m_impulse.x,this.m_perp,xt.s_t0),xt.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,xt.s_t1),On.InitVelocityConstraints_s_P),i=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,n=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;s.SelfMulSub(f,t),r-=y*i,l.SelfMulAdd(g,t),c+=v*n}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=c}SolveVelocityConstraints(e){const i=e.velocities[this.m_indexA].v;let n=e.velocities[this.m_indexA].w;const s=e.velocities[this.m_indexB].v;let r=e.velocities[this.m_indexB].w;const o=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,c=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits){const t=xt.DotVV(this.m_axis,xt.SubVV(s,i,xt.s_t0))+this.m_a2*r-this.m_a1*n;let h=this.m_motorMass*(this.m_motorSpeed-t);const _=this.m_motorImpulse,u=e.step.dt*this.m_maxMotorForce;this.m_motorImpulse=it(this.m_motorImpulse+h,-u,u),h=this.m_motorImpulse-_;const m=xt.MulSV(h,this.m_axis,On.SolveVelocityConstraints_s_P),d=h*this.m_a1,p=h*this.m_a2;i.SelfMulSub(o,m),n-=l*d,s.SelfMulAdd(a,m),r+=c*p}const h=xt.DotVV(this.m_perp,xt.SubVV(s,i,xt.s_t0))+this.m_s2*r-this.m_s1*n,_=r-n;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit){const e=xt.DotVV(this.m_axis,xt.SubVV(s,i,xt.s_t0))+this.m_a2*r-this.m_a1*n,u=On.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),m=this.m_K.Solve33(-h,-_,-e,On.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(m),this.m_limitState===t.b2LimitState.e_atLowerLimit?this.m_impulse.z=et(this.m_impulse.z,0):this.m_limitState===t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=tt(this.m_impulse.z,0));const d=-h-(this.m_impulse.z-u.z)*this.m_K.ez.x,p=-_-(this.m_impulse.z-u.z)*this.m_K.ez.y,f=this.m_K.Solve22(d,p,On.SolveVelocityConstraints_s_f2r);f.x+=u.x,f.y+=u.y,this.m_impulse.x=f.x,this.m_impulse.y=f.y,m.x=this.m_impulse.x-u.x,m.y=this.m_impulse.y-u.y,m.z=this.m_impulse.z-u.z;const g=xt.AddVV(xt.MulSV(m.x,this.m_perp,xt.s_t0),xt.MulSV(m.z,this.m_axis,xt.s_t1),On.SolveVelocityConstraints_s_P),y=m.x*this.m_s1+m.y+m.z*this.m_a1,v=m.x*this.m_s2+m.y+m.z*this.m_a2;i.SelfMulSub(o,g),n-=l*y,s.SelfMulAdd(a,g),r+=c*v}else{const t=this.m_K.Solve22(-h,-_,On.SolveVelocityConstraints_s_df2);this.m_impulse.x+=t.x,this.m_impulse.y+=t.y;const e=xt.MulSV(t.x,this.m_perp,On.SolveVelocityConstraints_s_P),u=t.x*this.m_s1+t.y,m=t.x*this.m_s2+t.y;i.SelfMulSub(o,e),n-=l*u,s.SelfMulAdd(a,e),r+=c*m}e.velocities[this.m_indexA].w=n,e.velocities[this.m_indexB].w=r}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s),a=this.m_invMassA,l=this.m_invMassB,c=this.m_invIA,h=this.m_invIB,m=Tt.MulRV(r,this.m_lalcA,this.m_rA),d=Tt.MulRV(o,this.m_lalcB,this.m_rB),p=xt.SubVV(xt.AddVV(n,d,xt.s_t0),xt.AddVV(e,m,xt.s_t1),On.SolvePositionConstraints_s_d),f=Tt.MulRV(r,this.m_localXAxisA,this.m_axis),y=xt.CrossVV(xt.AddVV(p,m,xt.s_t0),f),v=xt.CrossVV(d,f),x=Tt.MulRV(r,this.m_localYAxisA,this.m_perp),S=xt.CrossVV(xt.AddVV(p,m,xt.s_t0),x),A=xt.CrossVV(d,x);let C=On.SolvePositionConstraints_s_impulse;const b=xt.DotVV(x,p),T=s-i-this.m_referenceAngle;let w=Q(b);const E=Q(T);let P=!1,I=0;if(this.m_enableLimit){const t=xt.DotVV(f,p);Q(this.m_upperTranslation-this.m_lowerTranslation)<2*_?(I=it(t,-g,g),w=et(w,Q(t)),P=!0):t<=this.m_lowerTranslation?(I=it(t-this.m_lowerTranslation+_,-g,0),w=et(w,this.m_lowerTranslation-t),P=!0):t>=this.m_upperTranslation&&(I=it(t-this.m_upperTranslation-_,0,g),w=et(w,t-this.m_upperTranslation),P=!0)}if(P){const t=a+l+c*S*S+h*A*A,e=c*S+h*A,i=c*S*y+h*A*v;let n=c+h;0===n&&(n=1);const s=c*y+h*v,r=a+l+c*y*y+h*v*v,o=this.m_K3;o.ex.SetXYZ(t,e,i),o.ey.SetXYZ(e,n,s),o.ez.SetXYZ(i,s,r),C=o.Solve33(-b,-T,-I,C)}else{const t=a+l+c*S*S+h*A*A,e=c*S+h*A;let i=c+h;0===i&&(i=1);const n=this.m_K2;n.ex.Set(t,e),n.ey.Set(e,i);const s=n.Solve(-b,-T,On.SolvePositionConstraints_s_impulse1);C.x=s.x,C.y=s.y,C.z=0}const D=xt.AddVV(xt.MulSV(C.x,x,xt.s_t0),xt.MulSV(C.z,f,xt.s_t1),On.SolvePositionConstraints_s_P),R=C.x*S+C.y+C.z*y,M=C.x*A+C.y+C.z*v;return e.SelfMulSub(a,D),i-=c*R,n.SelfMulAdd(l,D),s+=h*M,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,w<=_&&E<=u}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),e.y=t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y),e}GetReactionTorque(t){return t*this.m_impulse.y}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetReferenceAngle(){return this.m_referenceAngle}GetJointTranslation(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,On.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,On.GetJointTranslation_s_pB),i=xt.SubVV(e,t,On.GetJointTranslation_s_d),n=this.m_bodyA.GetWorldVector(this.m_localXAxisA,On.GetJointTranslation_s_axis);return xt.DotVV(i,n)}GetJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;xt.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=Tt.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const n=Tt.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),s=xt.AddVV(t.m_sweep.c,i,xt.s_t0),r=xt.AddVV(e.m_sweep.c,n,xt.s_t1),o=xt.SubVV(r,s,xt.s_t2),a=t.GetWorldVector(this.m_localXAxisA,this.m_axis),l=t.m_linearVelocity,c=e.m_linearVelocity,h=t.m_angularVelocity,_=e.m_angularVelocity;return xt.DotVV(o,xt.CrossSV(h,a,xt.s_t0))+xt.DotVV(a,xt.SubVV(xt.AddVCrossSV(c,_,n,xt.s_t0),xt.AddVCrossSV(l,h,i,xt.s_t1),xt.s_t0))}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)}GetLowerLimit(){return this.m_lowerTranslation}GetUpperLimit(){return this.m_upperTranslation}SetLimits(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_impulse.z=0)}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorForce(t){t!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t)}GetMaxMotorForce(){return this.m_maxMotorForce}GetMotorForce(t){return t*this.m_motorImpulse}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}On.InitVelocityConstraints_s_d=new xt,On.InitVelocityConstraints_s_P=new xt,On.SolveVelocityConstraints_s_P=new xt,On.SolveVelocityConstraints_s_f2r=new xt,On.SolveVelocityConstraints_s_f1=new At,On.SolveVelocityConstraints_s_df3=new At,On.SolveVelocityConstraints_s_df2=new xt,On.SolvePositionConstraints_s_d=new xt,On.SolvePositionConstraints_s_impulse=new At,On.SolvePositionConstraints_s_impulse1=new xt,On.SolvePositionConstraints_s_P=new xt,On.GetJointTranslation_s_pA=new xt,On.GetJointTranslation_s_pB=new xt,On.GetJointTranslation_s_d=new xt,On.GetJointTranslation_s_axis=new xt;const Nn=2;class Ln extends vn{constructor(){super(t.b2JointType.e_pulleyJoint),this.groundAnchorA=new xt(-1,1),this.groundAnchorB=new xt(1,1),this.localAnchorA=new xt(-1,0),this.localAnchorB=new xt(1,0),this.lengthA=0,this.lengthB=0,this.ratio=1,this.collideConnected=!0}Initialize(t,e,i,n,s,r,o){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(i),this.groundAnchorB.Copy(n),this.bodyA.GetLocalPoint(s,this.localAnchorA),this.bodyB.GetLocalPoint(r,this.localAnchorB),this.lengthA=xt.DistanceVV(s,i),this.lengthB=xt.DistanceVV(r,n),this.ratio=o}}class Fn extends xn{constructor(t){super(t),this.m_groundAnchorA=new xt,this.m_groundAnchorB=new xt,this.m_lengthA=0,this.m_lengthB=0,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_uA=new xt,this.m_uB=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_groundAnchorA.Copy(i(t.groundAnchorA,new xt(-1,1))),this.m_groundAnchorB.Copy(i(t.groundAnchorB,new xt(1,0))),this.m_localAnchorA.Copy(i(t.localAnchorA,new xt(-1,0))),this.m_localAnchorB.Copy(i(t.localAnchorB,new xt(1,0))),this.m_lengthA=i(t.lengthA,0),this.m_lengthB=i(t.lengthB,0),this.m_ratio=i(t.ratio,1),this.m_constant=i(t.lengthA,0)+this.m_ratio*i(t.lengthB,0),this.m_impulse=0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v;let l=t.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(i),h=this.m_qB.SetAngle(o);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(c,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(h,this.m_lalcB,this.m_rB),this.m_uA.Copy(e).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(r).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);const u=this.m_uA.Length(),m=this.m_uB.Length();u>10*_?this.m_uA.SelfMul(1/u):this.m_uA.SetZero(),m>10*_?this.m_uB.SelfMul(1/m):this.m_uB.SetZero();const d=xt.CrossVV(this.m_rA,this.m_uA),p=xt.CrossVV(this.m_rB,this.m_uB),f=this.m_invMassA+this.m_invIA*d*d,g=this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=f+this.m_ratio*this.m_ratio*g,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const e=xt.MulSV(-this.m_impulse,this.m_uA,Fn.InitVelocityConstraints_s_PA),i=xt.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,Fn.InitVelocityConstraints_s_PB);n.SelfMulAdd(this.m_invMassA,e),s+=this.m_invIA*xt.CrossVV(this.m_rA,e),a.SelfMulAdd(this.m_invMassB,i),l+=this.m_invIB*xt.CrossVV(this.m_rB,i)}else this.m_impulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=l}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=xt.AddVCrossSV(e,i,this.m_rA,Fn.SolveVelocityConstraints_s_vpA),o=xt.AddVCrossSV(n,s,this.m_rB,Fn.SolveVelocityConstraints_s_vpB),a=-xt.DotVV(this.m_uA,r)-this.m_ratio*xt.DotVV(this.m_uB,o),l=-this.m_mass*a;this.m_impulse+=l;const c=xt.MulSV(-l,this.m_uA,Fn.SolveVelocityConstraints_s_PA),h=xt.MulSV(-this.m_ratio*l,this.m_uB,Fn.SolveVelocityConstraints_s_PB);e.SelfMulAdd(this.m_invMassA,c),i+=this.m_invIA*xt.CrossVV(this.m_rA,c),n.SelfMulAdd(this.m_invMassB,h),s+=this.m_invIB*xt.CrossVV(this.m_rB,h),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const a=Tt.MulRV(r,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const l=Tt.MulRV(o,this.m_lalcB,this.m_rB),c=this.m_uA.Copy(e).SelfAdd(a).SelfSub(this.m_groundAnchorA),h=this.m_uB.Copy(n).SelfAdd(l).SelfSub(this.m_groundAnchorB),u=c.Length(),m=h.Length();u>10*_?c.SelfMul(1/u):c.SetZero(),m>10*_?h.SelfMul(1/m):h.SetZero();const d=xt.CrossVV(a,c),p=xt.CrossVV(l,h),f=this.m_invMassA+this.m_invIA*d*d,g=this.m_invMassB+this.m_invIB*p*p;let y=f+this.m_ratio*this.m_ratio*g;y>0&&(y=1/y);const v=this.m_constant-u-this.m_ratio*m,x=Q(v),S=-y*v,A=xt.MulSV(-S,c,Fn.SolvePositionConstraints_s_PA),C=xt.MulSV(-this.m_ratio*S,h,Fn.SolvePositionConstraints_s_PB);return e.SelfMulAdd(this.m_invMassA,A),i+=this.m_invIA*xt.CrossVV(a,A),n.SelfMulAdd(this.m_invMassB,C),s+=this.m_invIB*xt.CrossVV(l,C),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,x<_}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse*this.m_uB.x,e.y=t*this.m_impulse*this.m_uB.y,e}GetReactionTorque(t){return 0}GetGroundAnchorA(){return this.m_groundAnchorA}GetGroundAnchorB(){return this.m_groundAnchorB}GetLengthA(){return this.m_lengthA}GetLengthB(){return this.m_lengthB}GetRatio(){return this.m_ratio}GetCurrentLengthA(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,Fn.GetCurrentLengthA_s_p),e=this.m_groundAnchorA;return xt.DistanceVV(t,e)}GetCurrentLengthB(){const t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,Fn.GetCurrentLengthB_s_p),e=this.m_groundAnchorB;return xt.DistanceVV(t,e)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.m_lengthA),t("  jd.lengthB = %.15f;\n",this.m_lengthB),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}ShiftOrigin(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)}}Fn.InitVelocityConstraints_s_PA=new xt,Fn.InitVelocityConstraints_s_PB=new xt,Fn.SolveVelocityConstraints_s_vpA=new xt,Fn.SolveVelocityConstraints_s_vpB=new xt,Fn.SolveVelocityConstraints_s_PA=new xt,Fn.SolveVelocityConstraints_s_PB=new xt,Fn.SolvePositionConstraints_s_PA=new xt,Fn.SolvePositionConstraints_s_PB=new xt,Fn.GetCurrentLengthA_s_p=new xt,Fn.GetCurrentLengthB_s_p=new xt;class zn extends vn{constructor(){super(t.b2JointType.e_revoluteJoint),this.localAnchorA=new xt(0,0),this.localAnchorB=new xt(0,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerAngle=0,this.upperAngle=0,this.enableMotor=!1,this.motorSpeed=0,this.maxMotorTorque=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class Vn extends xn{constructor(e){super(e),this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_impulse=new At,this.m_motorImpulse=0,this.m_enableMotor=!1,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_referenceAngle=0,this.m_lowerAngle=0,this.m_upperAngle=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new bt,this.m_motorMass=0,this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_K=new Ct,this.m_localAnchorA.Copy(i(e.localAnchorA,xt.ZERO)),this.m_localAnchorB.Copy(i(e.localAnchorB,xt.ZERO)),this.m_referenceAngle=i(e.referenceAngle,0),this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerAngle=i(e.lowerAngle,0),this.m_upperAngle=i(e.upperAngle,0),this.m_maxMotorTorque=i(e.maxMotorTorque,0),this.m_motorSpeed=i(e.motorSpeed,0),this.m_enableLimit=i(e.enableLimit,!1),this.m_enableMotor=i(e.enableMotor,!1),this.m_limitState=t.b2LimitState.e_inactiveLimit}InitVelocityConstraints(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const i=e.positions[this.m_indexA].a,n=e.velocities[this.m_indexA].v;let s=e.velocities[this.m_indexA].w;const r=e.positions[this.m_indexB].a,o=e.velocities[this.m_indexB].v;let a=e.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(i),c=this.m_qB.SetAngle(r);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(l,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(c,this.m_lalcB,this.m_rB);const h=this.m_invMassA,_=this.m_invMassB,m=this.m_invIA,d=this.m_invIB,p=m+d===0;if(this.m_mass.ex.x=h+_+this.m_rA.y*this.m_rA.y*m+this.m_rB.y*this.m_rB.y*d,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*m-this.m_rB.y*this.m_rB.x*d,this.m_mass.ez.x=-this.m_rA.y*m-this.m_rB.y*d,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=h+_+this.m_rA.x*this.m_rA.x*m+this.m_rB.x*this.m_rB.x*d,this.m_mass.ez.y=this.m_rA.x*m+this.m_rB.x*d,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=m+d,this.m_motorMass=m+d,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),this.m_enableMotor&&!p||(this.m_motorImpulse=0),this.m_enableLimit&&!p){const e=r-i-this.m_referenceAngle;Q(this.m_upperAngle-this.m_lowerAngle)<2*u?this.m_limitState=t.b2LimitState.e_equalLimits:e<=this.m_lowerAngle?(this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atLowerLimit):e>=this.m_upperAngle?(this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atUpperLimit):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit;if(e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;const t=Vn.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);n.SelfMulSub(h,t),s-=m*(xt.CrossVV(this.m_rA,t)+this.m_motorImpulse+this.m_impulse.z),o.SelfMulAdd(_,t),a+=d*(xt.CrossVV(this.m_rB,t)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=s,e.velocities[this.m_indexB].w=a}SolveVelocityConstraints(e){const i=e.velocities[this.m_indexA].v;let n=e.velocities[this.m_indexA].w;const s=e.velocities[this.m_indexB].v;let r=e.velocities[this.m_indexB].w;const o=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,c=this.m_invIB,h=l+c===0;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits&&!h){const t=r-n-this.m_motorSpeed;let i=-this.m_motorMass*t;const s=this.m_motorImpulse,o=e.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=it(this.m_motorImpulse+i,-o,o),i=this.m_motorImpulse-s,n-=l*i,r+=c*i}if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!h){const e=xt.SubVV(xt.AddVCrossSV(s,r,this.m_rB,xt.s_t0),xt.AddVCrossSV(i,n,this.m_rA,xt.s_t1),Vn.SolveVelocityConstraints_s_Cdot1),h=r-n,_=this.m_mass.Solve33(e.x,e.y,h,Vn.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(this.m_limitState===t.b2LimitState.e_equalLimits)this.m_impulse.SelfAdd(_);else if(this.m_limitState===t.b2LimitState.e_atLowerLimit)if(this.m_impulse.z+_.z<0){const t=-e.x+this.m_impulse.z*this.m_mass.ez.x,i=-e.y+this.m_impulse.z*this.m_mass.ez.y,n=this.m_mass.Solve22(t,i,Vn.SolveVelocityConstraints_s_reduced_v2);_.x=n.x,_.y=n.y,_.z=-this.m_impulse.z,this.m_impulse.x+=n.x,this.m_impulse.y+=n.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(_);else if(this.m_limitState===t.b2LimitState.e_atUpperLimit)if(this.m_impulse.z+_.z>0){const t=-e.x+this.m_impulse.z*this.m_mass.ez.x,i=-e.y+this.m_impulse.z*this.m_mass.ez.y,n=this.m_mass.Solve22(t,i,Vn.SolveVelocityConstraints_s_reduced_v2);_.x=n.x,_.y=n.y,_.z=-this.m_impulse.z,this.m_impulse.x+=n.x,this.m_impulse.y+=n.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(_);const u=Vn.SolveVelocityConstraints_s_P.Set(_.x,_.y);i.SelfMulSub(o,u),n-=l*(xt.CrossVV(this.m_rA,u)+_.z),s.SelfMulAdd(a,u),r+=c*(xt.CrossVV(this.m_rB,u)+_.z)}else{const t=xt.SubVV(xt.AddVCrossSV(s,r,this.m_rB,xt.s_t0),xt.AddVCrossSV(i,n,this.m_rA,xt.s_t1),Vn.SolveVelocityConstraints_s_Cdot_v2),e=this.m_mass.Solve22(-t.x,-t.y,Vn.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=e.x,this.m_impulse.y+=e.y,i.SelfMulSub(o,e),n-=l*xt.CrossVV(this.m_rA,e),s.SelfMulAdd(a,e),r+=c*xt.CrossVV(this.m_rB,e)}e.velocities[this.m_indexA].w=n,e.velocities[this.m_indexB].w=r}SolvePositionConstraints(e){const i=e.positions[this.m_indexA].c;let n=e.positions[this.m_indexA].a;const s=e.positions[this.m_indexB].c;let r=e.positions[this.m_indexB].a;const o=this.m_qA.SetAngle(n),a=this.m_qB.SetAngle(r);let l=0,c=0;const h=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!h){const e=r-n-this.m_referenceAngle;let i=0;if(this.m_limitState===t.b2LimitState.e_equalLimits){const t=it(e-this.m_lowerAngle,-y,y);i=-this.m_motorMass*t,l=Q(t)}else if(this.m_limitState===t.b2LimitState.e_atLowerLimit){let t=e-this.m_lowerAngle;l=-t,t=it(t+u,-y,0),i=-this.m_motorMass*t}else if(this.m_limitState===t.b2LimitState.e_atUpperLimit){let t=e-this.m_upperAngle;l=t,t=it(t-u,0,y),i=-this.m_motorMass*t}n-=this.m_invIA*i,r+=this.m_invIB*i}{o.SetAngle(n),a.SetAngle(r),xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const t=Tt.MulRV(o,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const e=Tt.MulRV(a,this.m_lalcB,this.m_rB),l=xt.SubVV(xt.AddVV(s,e,xt.s_t0),xt.AddVV(i,t,xt.s_t1),Vn.SolvePositionConstraints_s_C_v2);c=l.Length();const h=this.m_invMassA,_=this.m_invMassB,u=this.m_invIA,m=this.m_invIB,d=this.m_K;d.ex.x=h+_+u*t.y*t.y+m*e.y*e.y,d.ex.y=-u*t.x*t.y-m*e.x*e.y,d.ey.x=d.ex.y,d.ey.y=h+_+u*t.x*t.x+m*e.x*e.x;const p=d.Solve(l.x,l.y,Vn.SolvePositionConstraints_s_impulse).SelfNeg();i.SelfMulSub(h,p),n-=u*xt.CrossVV(t,p),s.SelfMulAdd(_,p),r+=m*xt.CrossVV(e,p)}return e.positions[this.m_indexA].a=n,e.positions[this.m_indexB].a=r,c<=_&&l<=u}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}GetJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle}GetJointSpeed(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}GetMotorTorque(t){return t*this.m_motorImpulse}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMaxMotorTorque(){return this.m_maxMotorTorque}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)}GetLowerLimit(){return this.m_lowerAngle}GetUpperLimit(){return this.m_upperAngle}SetLimits(t,e){t===this.m_lowerAngle&&e===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=t,this.m_upperAngle=e)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),t("  jd.upperAngle = %.15f;\n",this.m_upperAngle),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Vn.InitVelocityConstraints_s_P=new xt,Vn.SolveVelocityConstraints_s_P=new xt,Vn.SolveVelocityConstraints_s_Cdot_v2=new xt,Vn.SolveVelocityConstraints_s_Cdot1=new xt,Vn.SolveVelocityConstraints_s_impulse_v3=new At,Vn.SolveVelocityConstraints_s_reduced_v2=new xt,Vn.SolveVelocityConstraints_s_impulse_v2=new xt,Vn.SolvePositionConstraints_s_C_v2=new xt,Vn.SolvePositionConstraints_s_impulse=new xt;class Un extends vn{constructor(){super(t.b2JointType.e_ropeJoint),this.localAnchorA=new xt(-1,0),this.localAnchorB=new xt(1,0),this.maxLength=0}}class Gn extends xn{constructor(e){super(e),this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_maxLength=0,this.m_length=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_state=t.b2LimitState.e_inactiveLimit,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_localAnchorA.Copy(i(e.localAnchorA,new xt(-1,0))),this.m_localAnchorB.Copy(i(e.localAnchorB,new xt(1,0))),this.m_maxLength=i(e.maxLength,0)}InitVelocityConstraints(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const i=e.positions[this.m_indexA].c,n=e.positions[this.m_indexA].a,s=e.velocities[this.m_indexA].v;let r=e.velocities[this.m_indexA].w;const o=e.positions[this.m_indexB].c,a=e.positions[this.m_indexB].a,l=e.velocities[this.m_indexB].v;let c=e.velocities[this.m_indexB].w;const h=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(a);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(h,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(u,this.m_lalcB,this.m_rB),this.m_u.Copy(o).SelfAdd(this.m_rB).SelfSub(i).SelfSub(this.m_rA),this.m_length=this.m_u.Length();const m=this.m_length-this.m_maxLength;if(this.m_state=m>0?t.b2LimitState.e_atUpperLimit:t.b2LimitState.e_inactiveLimit,!(this.m_length>_))return this.m_u.SetZero(),this.m_mass=0,void(this.m_impulse=0);this.m_u.SelfMul(1/this.m_length);const d=xt.CrossVV(this.m_rA,this.m_u),p=xt.CrossVV(this.m_rB,this.m_u),f=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=0!==f?1/f:0,e.step.warmStarting){this.m_impulse*=e.step.dtRatio;const t=xt.MulSV(this.m_impulse,this.m_u,Gn.InitVelocityConstraints_s_P);s.SelfMulSub(this.m_invMassA,t),r-=this.m_invIA*xt.CrossVV(this.m_rA,t),l.SelfMulAdd(this.m_invMassB,t),c+=this.m_invIB*xt.CrossVV(this.m_rB,t)}else this.m_impulse=0;e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=c}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=xt.AddVCrossSV(e,i,this.m_rA,Gn.SolveVelocityConstraints_s_vpA),o=xt.AddVCrossSV(n,s,this.m_rB,Gn.SolveVelocityConstraints_s_vpB),a=this.m_length-this.m_maxLength;let l=xt.DotVV(this.m_u,xt.SubVV(o,r,xt.s_t0));a<0&&(l+=t.step.inv_dt*a);let c=-this.m_mass*l;const h=this.m_impulse;this.m_impulse=tt(0,this.m_impulse+c),c=this.m_impulse-h;const _=xt.MulSV(c,this.m_u,Gn.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,_),i-=this.m_invIA*xt.CrossVV(this.m_rA,_),n.SelfMulAdd(this.m_invMassB,_),s+=this.m_invIB*xt.CrossVV(this.m_rB,_),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const a=Tt.MulRV(r,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const l=Tt.MulRV(o,this.m_lalcB,this.m_rB),c=this.m_u.Copy(n).SelfAdd(l).SelfSub(e).SelfSub(a),h=c.Normalize();let u=h-this.m_maxLength;u=it(u,0,g);const m=-this.m_mass*u,d=xt.MulSV(m,c,Gn.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,d),i-=this.m_invIA*xt.CrossVV(a,d),n.SelfMulAdd(this.m_invMassB,d),s+=this.m_invIB*xt.CrossVV(l,d),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,h-this.m_maxLength<_}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return xt.MulSV(t*this.m_impulse,this.m_u,e)}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxLength(t){this.m_maxLength=t}GetMaxLength(){return this.m_maxLength}GetLimitState(){return this.m_state}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RopeJointDef = new b2RopeJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxLength = %.15f;\n",this.m_maxLength),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Gn.InitVelocityConstraints_s_P=new xt,Gn.SolveVelocityConstraints_s_vpA=new xt,Gn.SolveVelocityConstraints_s_vpB=new xt,Gn.SolveVelocityConstraints_s_P=new xt,Gn.SolvePositionConstraints_s_P=new xt;class Hn extends vn{constructor(){super(t.b2JointType.e_weldJoint),this.localAnchorA=new xt,this.localAnchorB=new xt,this.referenceAngle=0,this.frequencyHz=0,this.dampingRatio=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class kn extends xn{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_bias=0,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_referenceAngle=0,this.m_gamma=0,this.m_impulse=new At(0,0,0),this.m_indexA=0,this.m_indexB=0,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new bt,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_K=new bt,this.m_frequencyHz=i(t.frequencyHz,0),this.m_dampingRatio=i(t.dampingRatio,0),this.m_localAnchorA.Copy(i(t.localAnchorA,xt.ZERO)),this.m_localAnchorB.Copy(i(t.localAnchorB,xt.ZERO)),this.m_referenceAngle=i(t.referenceAngle,0),this.m_impulse.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const s=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(e),c=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(l,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(c,this.m_lalcB,this.m_rB);const h=this.m_invMassA,_=this.m_invMassB,u=this.m_invIA,m=this.m_invIB,d=this.m_K;if(d.ex.x=h+_+this.m_rA.y*this.m_rA.y*u+this.m_rB.y*this.m_rB.y*m,d.ey.x=-this.m_rA.y*this.m_rA.x*u-this.m_rB.y*this.m_rB.x*m,d.ez.x=-this.m_rA.y*u-this.m_rB.y*m,d.ex.y=d.ey.x,d.ey.y=h+_+this.m_rA.x*this.m_rA.x*u+this.m_rB.x*this.m_rB.x*m,d.ez.y=this.m_rA.x*u+this.m_rB.x*m,d.ex.z=d.ez.x,d.ey.z=d.ez.y,d.ez.z=u+m,this.m_frequencyHz>0){d.GetInverse22(this.m_mass);let i=u+m;const n=i>0?1/i:0,r=s-e-this.m_referenceAngle,a=2*o*this.m_frequencyHz,l=2*n*this.m_dampingRatio*a,c=n*a*a,h=t.step.dt;this.m_gamma=h*(l+h*c),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=r*h*c*this.m_gamma,i+=this.m_gamma,this.m_mass.ez.z=0!==i?1/i:0}else d.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);const e=kn.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(h,e),n-=u*(xt.CrossVV(this.m_rA,e)+this.m_impulse.z),r.SelfMulAdd(_,e),a+=m*(xt.CrossVV(this.m_rB,e)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=this.m_invMassA,o=this.m_invMassB,a=this.m_invIA,l=this.m_invIB;if(this.m_frequencyHz>0){const t=s-i,c=-this.m_mass.ez.z*(t+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=c,i-=a*c,s+=l*c;const h=xt.SubVV(xt.AddVCrossSV(n,s,this.m_rB,xt.s_t0),xt.AddVCrossSV(e,i,this.m_rA,xt.s_t1),kn.SolveVelocityConstraints_s_Cdot1),_=bt.MulM33XY(this.m_mass,h.x,h.y,kn.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=_.x,this.m_impulse.y+=_.y;const u=_;e.SelfMulSub(r,u),i-=a*xt.CrossVV(this.m_rA,u),n.SelfMulAdd(o,u),s+=l*xt.CrossVV(this.m_rB,u)}else{const t=xt.SubVV(xt.AddVCrossSV(n,s,this.m_rB,xt.s_t0),xt.AddVCrossSV(e,i,this.m_rA,xt.s_t1),kn.SolveVelocityConstraints_s_Cdot1),c=s-i,h=bt.MulM33XYZ(this.m_mass,t.x,t.y,c,kn.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(h);const _=kn.SolveVelocityConstraints_s_P.Set(h.x,h.y);e.SelfMulSub(r,_),i-=a*(xt.CrossVV(this.m_rA,_)+h.z),n.SelfMulAdd(o,_),s+=l*(xt.CrossVV(this.m_rB,_)+h.z)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s),a=this.m_invMassA,l=this.m_invMassB,c=this.m_invIA,h=this.m_invIB;xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const m=Tt.MulRV(r,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const d=Tt.MulRV(o,this.m_lalcB,this.m_rB);let p,f;const g=this.m_K;if(g.ex.x=a+l+m.y*m.y*c+d.y*d.y*h,g.ey.x=-m.y*m.x*c-d.y*d.x*h,g.ez.x=-m.y*c-d.y*h,g.ex.y=g.ey.x,g.ey.y=a+l+m.x*m.x*c+d.x*d.x*h,g.ez.y=m.x*c+d.x*h,g.ex.z=g.ez.x,g.ey.z=g.ez.y,g.ez.z=c+h,this.m_frequencyHz>0){const t=xt.SubVV(xt.AddVV(n,d,xt.s_t0),xt.AddVV(e,m,xt.s_t1),kn.SolvePositionConstraints_s_C1);p=t.Length(),f=0;const r=g.Solve22(t.x,t.y,kn.SolvePositionConstraints_s_P).SelfNeg();e.SelfMulSub(a,r),i-=c*xt.CrossVV(m,r),n.SelfMulAdd(l,r),s+=h*xt.CrossVV(d,r)}else{const t=xt.SubVV(xt.AddVV(n,d,xt.s_t0),xt.AddVV(e,m,xt.s_t1),kn.SolvePositionConstraints_s_C1),r=s-i-this.m_referenceAngle;p=t.Length(),f=Q(r);const o=g.Solve33(t.x,t.y,r,kn.SolvePositionConstraints_s_impulse).SelfNeg(),_=kn.SolvePositionConstraints_s_P.Set(o.x,o.y);e.SelfMulSub(a,_),i-=c*(xt.CrossVV(this.m_rA,_)+o.z),n.SelfMulAdd(l,_),s+=h*(xt.CrossVV(this.m_rB,_)+o.z)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,p<=_&&f<=u}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}kn.InitVelocityConstraints_s_P=new xt,kn.SolveVelocityConstraints_s_Cdot1=new xt,kn.SolveVelocityConstraints_s_impulse1=new xt,kn.SolveVelocityConstraints_s_impulse=new At,kn.SolveVelocityConstraints_s_P=new xt,kn.SolvePositionConstraints_s_C1=new xt,kn.SolvePositionConstraints_s_P=new xt,kn.SolvePositionConstraints_s_impulse=new At;class jn extends vn{constructor(){super(t.b2JointType.e_wheelJoint),this.localAnchorA=new xt(0,0),this.localAnchorB=new xt(0,0),this.localAxisA=new xt(1,0),this.enableMotor=!1,this.maxMotorTorque=0,this.motorSpeed=0,this.frequencyHz=2,this.dampingRatio=.7}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA)}}class Wn extends xn{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_localXAxisA=new xt,this.m_localYAxisA=new xt,this.m_impulse=0,this.m_motorImpulse=0,this.m_springImpulse=0,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableMotor=!1,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_ax=new xt,this.m_ay=new xt,this.m_sAx=0,this.m_sBx=0,this.m_sAy=0,this.m_sBy=0,this.m_mass=0,this.m_motorMass=0,this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_frequencyHz=i(t.frequencyHz,2),this.m_dampingRatio=i(t.dampingRatio,.7),this.m_localAnchorA.Copy(i(t.localAnchorA,xt.ZERO)),this.m_localAnchorB.Copy(i(t.localAnchorB,xt.ZERO)),this.m_localXAxisA.Copy(i(t.localAxisA,xt.UNITX)),xt.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_maxMotorTorque=i(t.maxMotorTorque,0),this.m_motorSpeed=i(t.motorSpeed,0),this.m_enableMotor=i(t.enableMotor,!1),this.m_ax.SetZero(),this.m_ay.SetZero()}GetMotorSpeed(){return this.m_motorSpeed}GetMaxMotorTorque(){return this.m_maxMotorTorque}SetSpringFrequencyHz(t){this.m_frequencyHz=t}GetSpringFrequencyHz(){return this.m_frequencyHz}SetSpringDampingRatio(t){this.m_dampingRatio=t}GetSpringDampingRatio(){return this.m_dampingRatio}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=this.m_invMassA,i=this.m_invMassB,n=this.m_invIA,s=this.m_invIB,r=t.positions[this.m_indexA].c,a=t.positions[this.m_indexA].a,l=t.velocities[this.m_indexA].v;let c=t.velocities[this.m_indexA].w;const h=t.positions[this.m_indexB].c,_=t.positions[this.m_indexB].a,u=t.velocities[this.m_indexB].v;let m=t.velocities[this.m_indexB].w;const d=this.m_qA.SetAngle(a),p=this.m_qB.SetAngle(_);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const f=Tt.MulRV(d,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const g=Tt.MulRV(p,this.m_lalcB,this.m_rB),y=xt.SubVV(xt.AddVV(h,g,xt.s_t0),xt.AddVV(r,f,xt.s_t1),Wn.InitVelocityConstraints_s_d);if(Tt.MulRV(d,this.m_localYAxisA,this.m_ay),this.m_sAy=xt.CrossVV(xt.AddVV(y,f,xt.s_t0),this.m_ay),this.m_sBy=xt.CrossVV(g,this.m_ay),this.m_mass=e+i+n*this.m_sAy*this.m_sAy+s*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){Tt.MulRV(d,this.m_localXAxisA,this.m_ax),this.m_sAx=xt.CrossVV(xt.AddVV(y,f,xt.s_t0),this.m_ax),this.m_sBx=xt.CrossVV(g,this.m_ax);const r=e+i+n*this.m_sAx*this.m_sAx+s*this.m_sBx*this.m_sBx;if(r>0){this.m_springMass=1/r;const e=xt.DotVV(y,this.m_ax),i=2*o*this.m_frequencyHz,n=2*this.m_springMass*this.m_dampingRatio*i,s=this.m_springMass*i*i,a=t.step.dt;this.m_gamma=a*(n+a*s),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=e*a*s*this.m_gamma,this.m_springMass=r+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=n+s,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;const e=xt.AddVV(xt.MulSV(this.m_impulse,this.m_ay,xt.s_t0),xt.MulSV(this.m_springImpulse,this.m_ax,xt.s_t1),Wn.InitVelocityConstraints_s_P),i=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,n=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;l.SelfMulSub(this.m_invMassA,e),c-=this.m_invIA*i,u.SelfMulAdd(this.m_invMassB,e),m+=this.m_invIB*n}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;t.velocities[this.m_indexA].w=c,t.velocities[this.m_indexB].w=m}SolveVelocityConstraints(t){const e=this.m_invMassA,i=this.m_invMassB,n=this.m_invIA,s=this.m_invIB,r=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const a=t.velocities[this.m_indexB].v;let l=t.velocities[this.m_indexB].w;{const t=xt.DotVV(this.m_ax,xt.SubVV(a,r,xt.s_t0))+this.m_sBx*l-this.m_sAx*o,c=-this.m_springMass*(t+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=c;const h=xt.MulSV(c,this.m_ax,Wn.SolveVelocityConstraints_s_P),_=c*this.m_sAx,u=c*this.m_sBx;r.SelfMulSub(e,h),o-=n*_,a.SelfMulAdd(i,h),l+=s*u}{const e=l-o-this.m_motorSpeed;let i=-this.m_motorMass*e;const r=this.m_motorImpulse,a=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=it(this.m_motorImpulse+i,-a,a),i=this.m_motorImpulse-r,o-=n*i,l+=s*i}{const t=xt.DotVV(this.m_ay,xt.SubVV(a,r,xt.s_t0))+this.m_sBy*l-this.m_sAy*o,c=-this.m_mass*t;this.m_impulse+=c;const h=xt.MulSV(c,this.m_ay,Wn.SolveVelocityConstraints_s_P),_=c*this.m_sAy,u=c*this.m_sBy;r.SelfMulSub(e,h),o-=n*_,a.SelfMulAdd(i,h),l+=s*u}t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=l}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const a=Tt.MulRV(r,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const l=Tt.MulRV(o,this.m_lalcB,this.m_rB),c=xt.AddVV(xt.SubVV(n,e,xt.s_t0),xt.SubVV(l,a,xt.s_t1),Wn.SolvePositionConstraints_s_d),h=Tt.MulRV(r,this.m_localYAxisA,this.m_ay),u=xt.CrossVV(xt.AddVV(c,a,xt.s_t0),h),m=xt.CrossVV(l,h),d=xt.DotVV(c,this.m_ay),p=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;let f;f=0!==p?-d/p:0;const g=xt.MulSV(f,h,Wn.SolvePositionConstraints_s_P),y=f*u,v=f*m;return e.SelfMulSub(this.m_invMassA,g),i-=this.m_invIA*y,n.SelfMulAdd(this.m_invMassB,g),s+=this.m_invIB*v,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,Q(d)<=_}GetDefinition(t){return t}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),e}GetReactionTorque(t){return t*this.m_motorImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetJointTranslation(){return this.GetPrismaticJointTranslation()}GetJointLinearSpeed(){return this.GetPrismaticJointSpeed()}GetJointAngle(){return this.GetRevoluteJointAngle()}GetJointAngularSpeed(){return this.GetRevoluteJointSpeed()}GetPrismaticJointTranslation(){const t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchorA,new xt),n=e.GetWorldPoint(this.m_localAnchorB,new xt),s=xt.SubVV(n,i,new xt),r=t.GetWorldVector(this.m_localXAxisA,new xt);return xt.DotVV(s,r)}GetPrismaticJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;xt.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=Tt.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const n=Tt.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),s=xt.AddVV(t.m_sweep.c,i,xt.s_t0),r=xt.AddVV(e.m_sweep.c,n,xt.s_t1),o=xt.SubVV(r,s,xt.s_t2),a=t.GetWorldVector(this.m_localXAxisA,new xt),l=t.m_linearVelocity,c=e.m_linearVelocity,h=t.m_angularVelocity,_=e.m_angularVelocity;return xt.DotVV(o,xt.CrossSV(h,a,xt.s_t0))+xt.DotVV(a,xt.SubVV(xt.AddVCrossSV(c,_,n,xt.s_t0),xt.AddVCrossSV(l,h,i,xt.s_t1),xt.s_t0))}GetRevoluteJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a}GetRevoluteJointSpeed(){const t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMotorTorque(t){return t*this.m_motorImpulse}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}function qn(t,e){return at(t*e)}function Xn(t,e){return t>e?t:e}Wn.InitVelocityConstraints_s_d=new xt,Wn.InitVelocityConstraints_s_P=new xt,Wn.SolveVelocityConstraints_s_P=new xt,Wn.SolvePositionConstraints_s_d=new xt,Wn.SolvePositionConstraints_s_P=new xt;class Yn{constructor(t){this._other=null,this.prev=null,this.next=null,this.contact=t}get other(){if(null===this._other)throw new Error;return this._other}set other(t){if(null!==this._other)throw new Error;this._other=t}Reset(){this._other=null,this.prev=null,this.next=null}}class Kn{constructor(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new Yn(this),this.m_nodeB=new Yn(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new pe,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new pe}GetManifold(){return this.m_manifold}GetWorldManifold(t){const e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),n=this.GetShapeA(),s=this.GetShapeB();t.Initialize(this.m_manifold,e.GetTransform(),n.m_radius,i.GetTransform(),s.m_radius)}IsTouching(){return this.m_touchingFlag}SetEnabled(t){this.m_enabledFlag=t}IsEnabled(){return this.m_enabledFlag}GetNext(){return this.m_next}GetFixtureA(){return this.m_fixtureA}GetChildIndexA(){return this.m_indexA}GetShapeA(){return this.m_fixtureA.GetShape()}GetFixtureB(){return this.m_fixtureB}GetChildIndexB(){return this.m_indexB}GetShapeB(){return this.m_fixtureB.GetShape()}FlagForFiltering(){this.m_filterFlag=!0}SetFriction(t){this.m_friction=t}GetFriction(){return this.m_friction}ResetFriction(){this.m_friction=qn(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)}SetRestitution(t){this.m_restitution=t}GetRestitution(){return this.m_restitution}ResetRestitution(){this.m_restitution=Xn(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}SetTangentSpeed(t){this.m_tangentSpeed=t}GetTangentSpeed(){return this.m_tangentSpeed}Reset(t,e,i,n){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=n,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=qn(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=Xn(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}Update(t){const e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;let i=!1;const n=this.m_touchingFlag,s=this.m_fixtureA.IsSensor(),r=this.m_fixtureB.IsSensor(),o=s||r,a=this.m_fixtureA.GetBody(),l=this.m_fixtureB.GetBody(),c=a.GetTransform(),h=l.GetTransform();if(o){const t=this.GetShapeA(),e=this.GetShapeB();i=Ee(t,this.m_indexA,e,this.m_indexB,c,h),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,c,h),i=this.m_manifold.pointCount>0;for(let t=0;t<this.m_manifold.pointCount;++t){const e=this.m_manifold.points[t];e.normalImpulse=0,e.tangentImpulse=0;const i=e.id;for(let t=0;t<this.m_oldManifold.pointCount;++t){const n=this.m_oldManifold.points[t];if(n.id.key===i.key){e.normalImpulse=n.normalImpulse,e.tangentImpulse=n.tangentImpulse;break}}}i!==n&&(a.SetAwake(!0),l.SetAwake(!0))}this.m_touchingFlag=i,!n&&i&&t&&t.BeginContact(this),n&&!i&&t&&t.EndContact(this),!o&&i&&t&&t.PreSolve(this,this.m_oldManifold)}ComputeTOI(t,e){const i=Kn.ComputeTOI_s_input;i.proxyA.SetShape(this.GetShapeA(),this.m_indexA),i.proxyB.SetShape(this.GetShapeB(),this.m_indexB),i.sweepA.Copy(t),i.sweepB.Copy(e),i.tMax=_;const n=Kn.ComputeTOI_s_output;return ri(n,i),n.t}}Kn.ComputeTOI_s_input=new We,Kn.ComputeTOI_s_output=new Ye;class Jn extends Kn{static Create(){return new Jn}static Destroy(t){}Evaluate(t,e,i){li(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class $n extends Kn{static Create(){return new $n}static Destroy(t){}Evaluate(t,e,i){Li(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class Zn extends Kn{static Create(){return new Zn}static Destroy(t){}Evaluate(t,e,i){ui(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class Qn extends Kn{static Create(){return new Qn}static Destroy(t){}Evaluate(t,e,i){Wi(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class ts extends Kn{static Create(){return new ts}static Destroy(t){}Evaluate(t,e,i){Qi(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class es extends Kn{static Create(){return new es}static Destroy(t){}Evaluate(t,e,i){const n=es.Evaluate_s_edge;this.GetShapeA().GetChildEdge(n,this.m_indexA),Wi(t,n,e,this.GetShapeB(),i)}}es.Evaluate_s_edge=new cn;class is extends Kn{static Create(){return new is}static Destroy(t){}Evaluate(t,e,i){const n=is.Evaluate_s_edge;this.GetShapeA().GetChildEdge(n,this.m_indexA),Qi(t,n,e,this.GetShapeB(),i)}}is.Evaluate_s_edge=new cn;class ns{constructor(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1}}class ss{constructor(){this.m_registers=[],this.InitializeRegisters()}AddType(t,e,i,n){const s=[];function r(){return s.pop()||t()}function o(t){s.push(t)}this.m_registers[i][n].pool=s,this.m_registers[i][n].createFcn=r,this.m_registers[i][n].destroyFcn=o,this.m_registers[i][n].primary=!0,i!==n&&(this.m_registers[n][i].pool=s,this.m_registers[n][i].createFcn=r,this.m_registers[n][i].destroyFcn=o,this.m_registers[n][i].primary=!1)}InitializeRegisters(){for(let e=0;e<t.b2ShapeType.e_shapeTypeCount;e++){this.m_registers[e]=[];for(let i=0;i<t.b2ShapeType.e_shapeTypeCount;i++)this.m_registers[e][i]=new ns}this.AddType(Jn.Create,Jn.Destroy,t.b2ShapeType.e_circleShape,t.b2ShapeType.e_circleShape),this.AddType(Zn.Create,Zn.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_circleShape),this.AddType($n.Create,$n.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_polygonShape),this.AddType(Qn.Create,Qn.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_circleShape),this.AddType(ts.Create,ts.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_polygonShape),this.AddType(es.Create,es.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_circleShape),this.AddType(is.Create,is.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_polygonShape)}Create(t,e,i,n){const s=t.GetType(),r=i.GetType(),o=this.m_registers[s][r];if(o.createFcn){const s=o.createFcn();return o.primary?s.Reset(t,e,i,n):s.Reset(i,n,t,e),s}return null}Destroy(t){const e=t.m_fixtureA.GetType(),i=t.m_fixtureB.GetType(),n=this.m_registers[e][i];n.destroyFcn&&n.destroyFcn(t)}}class rs{SayGoodbyeJoint(t){}SayGoodbyeFixture(t){}SayGoodbyeParticleGroup(t){}SayGoodbyeParticle(t,e){}}class os{ShouldCollide(e,i){const n=e.GetBody(),s=i.GetBody();if(s.GetType()===t.b2BodyType.b2_staticBody&&n.GetType()===t.b2BodyType.b2_staticBody)return!1;if(!s.ShouldCollideConnected(n))return!1;const r=e.GetFilterData(),o=i.GetFilterData();return r.groupIndex===o.groupIndex&&0!==r.groupIndex?r.groupIndex>0:0!=(r.maskBits&o.categoryBits)&&0!=(r.categoryBits&o.maskBits)}ShouldCollideFixtureParticle(t,e,i){return!0}ShouldCollideParticleParticle(t,e,i){return!0}}os.b2_defaultFilter=new os;class as{constructor(){this.normalImpulses=K(a),this.tangentImpulses=K(a),this.count=0}}class ls{BeginContact(t){}EndContact(t){}BeginContactFixtureParticle(t,e){}EndContactFixtureParticle(t,e){}BeginContactParticleParticle(t,e){}EndContactParticleParticle(t,e){}PreSolve(t,e){}PostSolve(t,e){}}ls.b2_defaultListener=new ls;class cs{ReportFixture(t){return!0}ReportParticle(t,e){return!1}ShouldQueryParticleSystem(t){return!0}}class hs{ReportFixture(t,e,i,n){return n}ReportParticle(t,e,i,n,s){return 0}ShouldQueryParticleSystem(t){return!0}}class _s{constructor(){this.m_broadPhase=new Ne,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=os.b2_defaultFilter,this.m_contactListener=ls.b2_defaultListener,this.m_contactFactory=new ss}AddPair(t,e){let i=t.fixture,n=e.fixture,s=t.childIndex,r=e.childIndex,o=i.GetBody(),a=n.GetBody();if(o===a)return;let l=a.GetContactList();for(;l;){if(l.other===o){const t=l.contact.GetFixtureA(),e=l.contact.GetFixtureB(),o=l.contact.GetChildIndexA(),a=l.contact.GetChildIndexB();if(t===i&&e===n&&o===s&&a===r)return;if(t===n&&e===i&&o===r&&a===s)return}l=l.next}if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,n))return;const c=this.m_contactFactory.Create(i,s,n,r);null!==c&&(i=c.GetFixtureA(),n=c.GetFixtureB(),s=c.GetChildIndexA(),r=c.GetChildIndexB(),o=i.m_body,a=n.m_body,c.m_prev=null,c.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=c),this.m_contactList=c,c.m_nodeA.other=a,c.m_nodeA.prev=null,c.m_nodeA.next=o.m_contactList,null!==o.m_contactList&&(o.m_contactList.prev=c.m_nodeA),o.m_contactList=c.m_nodeA,c.m_nodeB.other=o,c.m_nodeB.prev=null,c.m_nodeB.next=a.m_contactList,null!==a.m_contactList&&(a.m_contactList.prev=c.m_nodeB),a.m_contactList=c.m_nodeB,i.IsSensor()||n.IsSensor()||(o.SetAwake(!0),a.SetAwake(!0)),++this.m_contactCount)}FindNewContacts(){this.m_broadPhase.UpdatePairs(((t,e)=>{this.AddPair(t,e)}))}Destroy(t){const e=t.GetFixtureA(),i=t.GetFixtureB(),n=e.GetBody(),s=i.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===n.m_contactList&&(n.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===s.m_contactList&&(s.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!e.IsSensor()&&!i.IsSensor()&&(e.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(t),--this.m_contactCount}Collide(){let e=this.m_contactList;for(;e;){const i=e.GetFixtureA(),n=e.GetFixtureB(),s=e.GetChildIndexA(),r=e.GetChildIndexB(),o=i.GetBody(),a=n.GetBody();if(e.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,n)){const t=e;e=t.m_next,this.Destroy(t);continue}e.m_filterFlag=!1}const l=o.IsAwake()&&o.m_type!==t.b2BodyType.b2_staticBody,c=a.IsAwake()&&a.m_type!==t.b2BodyType.b2_staticBody;if(!l&&!c){e=e.m_next;continue}const h=i.m_proxies[s].treeNode,_=n.m_proxies[r].treeNode;if(Ae(h.aabb,_.aabb))e.Update(this.m_contactListener),e=e.m_next;else{const t=e;e=t.m_next,this.Destroy(t)}}}}class us{constructor(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}Reset(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this}}class ms{constructor(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}Copy(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this}}class ds{constructor(){this.c=new xt,this.a=0}static MakeArray(t){return X(t,(()=>new ds))}}class ps{constructor(){this.v=new xt,this.w=0}static MakeArray(t){return X(t,(()=>new ps))}}class fs{constructor(){this.step=new ms}}let gs=!1;class ys{constructor(){this.rA=new xt,this.rB=new xt,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}static MakeArray(t){return X(t,(()=>new ys))}}class vs{constructor(){this.points=ys.MakeArray(a),this.normal=new xt,this.tangent=new xt,this.normalMass=new Ct,this.K=new Ct,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}static MakeArray(t){return X(t,(()=>new vs))}}class xs{constructor(){this.localPoints=xt.MakeArray(a),this.localNormal=new xt,this.localPoint=new xt,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new xt,this.localCenterB=new xt,this.invIA=0,this.invIB=0,this.type=t.b2ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}static MakeArray(t){return X(t,(()=>new xs))}}class Ss{constructor(){this.step=new ms,this.count=0}}class As{constructor(){this.normal=new xt,this.point=new xt,this.separation=0}Initialize(e,i,n,s){const r=As.Initialize_s_pointA,o=As.Initialize_s_pointB,a=As.Initialize_s_planePoint,l=As.Initialize_s_clipPoint;switch(e.type){case t.b2ManifoldType.e_circles:wt.MulXV(i,e.localPoint,r),wt.MulXV(n,e.localPoints[0],o),xt.SubVV(o,r,this.normal).SelfNormalize(),xt.MidVV(r,o,this.point),this.separation=xt.DotVV(xt.SubVV(o,r,xt.s_t0),this.normal)-e.radiusA-e.radiusB;break;case t.b2ManifoldType.e_faceA:Tt.MulRV(i.q,e.localNormal,this.normal),wt.MulXV(i,e.localPoint,a),wt.MulXV(n,e.localPoints[s],l),this.separation=xt.DotVV(xt.SubVV(l,a,xt.s_t0),this.normal)-e.radiusA-e.radiusB,this.point.Copy(l);break;case t.b2ManifoldType.e_faceB:Tt.MulRV(n.q,e.localNormal,this.normal),wt.MulXV(n,e.localPoint,a),wt.MulXV(i,e.localPoints[s],l),this.separation=xt.DotVV(xt.SubVV(l,a,xt.s_t0),this.normal)-e.radiusA-e.radiusB,this.point.Copy(l),this.normal.SelfNeg()}}}As.Initialize_s_pointA=new xt,As.Initialize_s_pointB=new xt,As.Initialize_s_planePoint=new xt,As.Initialize_s_clipPoint=new xt;class Cs{constructor(){this.m_step=new ms,this.m_positionConstraints=xs.MakeArray(1024),this.m_velocityConstraints=vs.MakeArray(1024),this.m_count=0}Initialize(t){if(this.m_step.Copy(t.step),this.m_count=t.count,this.m_positionConstraints.length<this.m_count){const t=et(2*this.m_positionConstraints.length,this.m_count);for(;this.m_positionConstraints.length<t;)this.m_positionConstraints[this.m_positionConstraints.length]=new xs}if(this.m_velocityConstraints.length<this.m_count){const t=et(2*this.m_velocityConstraints.length,this.m_count);for(;this.m_velocityConstraints.length<t;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new vs}this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(let t=0;t<this.m_count;++t){const e=this.m_contacts[t],i=e.m_fixtureA,n=e.m_fixtureB,s=i.GetShape(),r=n.GetShape(),o=s.m_radius,a=r.m_radius,l=i.GetBody(),c=n.GetBody(),h=e.GetManifold(),_=h.pointCount,u=this.m_velocityConstraints[t];u.friction=e.m_friction,u.restitution=e.m_restitution,u.tangentSpeed=e.m_tangentSpeed,u.indexA=l.m_islandIndex,u.indexB=c.m_islandIndex,u.invMassA=l.m_invMass,u.invMassB=c.m_invMass,u.invIA=l.m_invI,u.invIB=c.m_invI,u.contactIndex=t,u.pointCount=_,u.K.SetZero(),u.normalMass.SetZero();const m=this.m_positionConstraints[t];m.indexA=l.m_islandIndex,m.indexB=c.m_islandIndex,m.invMassA=l.m_invMass,m.invMassB=c.m_invMass,m.localCenterA.Copy(l.m_sweep.localCenter),m.localCenterB.Copy(c.m_sweep.localCenter),m.invIA=l.m_invI,m.invIB=c.m_invI,m.localNormal.Copy(h.localNormal),m.localPoint.Copy(h.localPoint),m.pointCount=_,m.radiusA=o,m.radiusB=a,m.type=h.type;for(let t=0;t<_;++t){const e=h.points[t],i=u.points[t];this.m_step.warmStarting?(i.normalImpulse=this.m_step.dtRatio*e.normalImpulse,i.tangentImpulse=this.m_step.dtRatio*e.tangentImpulse):(i.normalImpulse=0,i.tangentImpulse=0),i.rA.SetZero(),i.rB.SetZero(),i.normalMass=0,i.tangentMass=0,i.velocityBias=0,m.localPoints[t].Copy(e.localPoint)}}return this}InitializeVelocityConstraints(){const t=Cs.InitializeVelocityConstraints_s_xfA,e=Cs.InitializeVelocityConstraints_s_xfB,i=Cs.InitializeVelocityConstraints_s_worldManifold,n=1e3;for(let s=0;s<this.m_count;++s){const r=this.m_velocityConstraints[s],o=this.m_positionConstraints[s],a=o.radiusA,l=o.radiusB,c=this.m_contacts[r.contactIndex].GetManifold(),h=r.indexA,_=r.indexB,u=r.invMassA,m=r.invMassB,d=r.invIA,p=r.invIB,g=o.localCenterA,y=o.localCenterB,v=this.m_positions[h].c,x=this.m_positions[h].a,S=this.m_velocities[h].v,A=this.m_velocities[h].w,C=this.m_positions[_].c,b=this.m_positions[_].a,T=this.m_velocities[_].v,w=this.m_velocities[_].w;t.q.SetAngle(x),e.q.SetAngle(b),xt.SubVV(v,Tt.MulRV(t.q,g,xt.s_t0),t.p),xt.SubVV(C,Tt.MulRV(e.q,y,xt.s_t0),e.p),i.Initialize(c,t,a,e,l),r.normal.Copy(i.normal),xt.CrossVOne(r.normal,r.tangent);const E=r.pointCount;for(let t=0;t<E;++t){const e=r.points[t];xt.SubVV(i.points[t],v,e.rA),xt.SubVV(i.points[t],C,e.rB);const n=xt.CrossVV(e.rA,r.normal),s=xt.CrossVV(e.rB,r.normal),o=u+m+d*n*n+p*s*s;e.normalMass=o>0?1/o:0;const a=r.tangent,l=xt.CrossVV(e.rA,a),c=xt.CrossVV(e.rB,a),h=u+m+d*l*l+p*c*c;e.tangentMass=h>0?1/h:0,e.velocityBias=0;const _=xt.DotVV(r.normal,xt.SubVV(xt.AddVCrossSV(T,w,e.rB,xt.s_t0),xt.AddVCrossSV(S,A,e.rA,xt.s_t1),xt.s_t0));_<-f&&(e.velocityBias+=-r.restitution*_)}if(2===r.pointCount&&gs){const t=r.points[0],e=r.points[1],i=xt.CrossVV(t.rA,r.normal),s=xt.CrossVV(t.rB,r.normal),o=xt.CrossVV(e.rA,r.normal),a=xt.CrossVV(e.rB,r.normal),l=u+m+d*i*i+p*s*s,c=u+m+d*o*o+p*a*a,h=u+m+d*i*o+p*s*a;l*l<n*(l*c-h*h)?(r.K.ex.Set(l,h),r.K.ey.Set(h,c),r.K.GetInverse(r.normalMass)):r.pointCount=1}}}WarmStart(){const t=Cs.WarmStart_s_P;for(let e=0;e<this.m_count;++e){const i=this.m_velocityConstraints[e],n=i.indexA,s=i.indexB,r=i.invMassA,o=i.invIA,a=i.invMassB,l=i.invIB,c=i.pointCount,h=this.m_velocities[n].v;let _=this.m_velocities[n].w;const u=this.m_velocities[s].v;let m=this.m_velocities[s].w;const d=i.normal,p=i.tangent;for(let e=0;e<c;++e){const n=i.points[e];xt.AddVV(xt.MulSV(n.normalImpulse,d,xt.s_t0),xt.MulSV(n.tangentImpulse,p,xt.s_t1),t),_-=o*xt.CrossVV(n.rA,t),h.SelfMulSub(r,t),m+=l*xt.CrossVV(n.rB,t),u.SelfMulAdd(a,t)}this.m_velocities[n].w=_,this.m_velocities[s].w=m}}SolveVelocityConstraints(){const t=Cs.SolveVelocityConstraints_s_dv,e=Cs.SolveVelocityConstraints_s_dv1,i=Cs.SolveVelocityConstraints_s_dv2,n=Cs.SolveVelocityConstraints_s_P,s=Cs.SolveVelocityConstraints_s_a,r=Cs.SolveVelocityConstraints_s_b,o=Cs.SolveVelocityConstraints_s_x,a=Cs.SolveVelocityConstraints_s_d,l=Cs.SolveVelocityConstraints_s_P1,c=Cs.SolveVelocityConstraints_s_P2,h=Cs.SolveVelocityConstraints_s_P1P2;for(let _=0;_<this.m_count;++_){const u=this.m_velocityConstraints[_],m=u.indexA,d=u.indexB,p=u.invMassA,f=u.invIA,g=u.invMassB,y=u.invIB,v=u.pointCount,x=this.m_velocities[m].v;let S=this.m_velocities[m].w;const A=this.m_velocities[d].v;let C=this.m_velocities[d].w;const b=u.normal,T=u.tangent,w=u.friction;for(let e=0;e<v;++e){const i=u.points[e];xt.SubVV(xt.AddVCrossSV(A,C,i.rB,xt.s_t0),xt.AddVCrossSV(x,S,i.rA,xt.s_t1),t);const s=xt.DotVV(t,T)-u.tangentSpeed;let r=i.tangentMass*-s;const o=w*i.normalImpulse,a=it(i.tangentImpulse+r,-o,o);r=a-i.tangentImpulse,i.tangentImpulse=a,xt.MulSV(r,T,n),x.SelfMulSub(p,n),S-=f*xt.CrossVV(i.rA,n),A.SelfMulAdd(g,n),C+=y*xt.CrossVV(i.rB,n)}if(1===u.pointCount||!1===gs)for(let e=0;e<v;++e){const i=u.points[e];xt.SubVV(xt.AddVCrossSV(A,C,i.rB,xt.s_t0),xt.AddVCrossSV(x,S,i.rA,xt.s_t1),t);const s=xt.DotVV(t,b);let r=-i.normalMass*(s-i.velocityBias);const o=et(i.normalImpulse+r,0);r=o-i.normalImpulse,i.normalImpulse=o,xt.MulSV(r,b,n),x.SelfMulSub(p,n),S-=f*xt.CrossVV(i.rA,n),A.SelfMulAdd(g,n),C+=y*xt.CrossVV(i.rB,n)}else{const t=u.points[0],n=u.points[1];s.Set(t.normalImpulse,n.normalImpulse),xt.SubVV(xt.AddVCrossSV(A,C,t.rB,xt.s_t0),xt.AddVCrossSV(x,S,t.rA,xt.s_t1),e),xt.SubVV(xt.AddVCrossSV(A,C,n.rB,xt.s_t0),xt.AddVCrossSV(x,S,n.rA,xt.s_t1),i);let _=xt.DotVV(e,b),m=xt.DotVV(i,b);for(r.x=_-t.velocityBias,r.y=m-n.velocityBias,r.SelfSub(Ct.MulMV(u.K,s,xt.s_t0));;){if(Ct.MulMV(u.normalMass,r,o).SelfNeg(),o.x>=0&&o.y>=0){xt.SubVV(o,s,a),xt.MulSV(a.x,b,l),xt.MulSV(a.y,b,c),xt.AddVV(l,c,h),x.SelfMulSub(p,h),S-=f*(xt.CrossVV(t.rA,l)+xt.CrossVV(n.rA,c)),A.SelfMulAdd(g,h),C+=y*(xt.CrossVV(t.rB,l)+xt.CrossVV(n.rB,c)),t.normalImpulse=o.x,n.normalImpulse=o.y;break}if(o.x=-t.normalMass*r.x,o.y=0,_=0,m=u.K.ex.y*o.x+r.y,o.x>=0&&m>=0){xt.SubVV(o,s,a),xt.MulSV(a.x,b,l),xt.MulSV(a.y,b,c),xt.AddVV(l,c,h),x.SelfMulSub(p,h),S-=f*(xt.CrossVV(t.rA,l)+xt.CrossVV(n.rA,c)),A.SelfMulAdd(g,h),C+=y*(xt.CrossVV(t.rB,l)+xt.CrossVV(n.rB,c)),t.normalImpulse=o.x,n.normalImpulse=o.y;break}if(o.x=0,o.y=-n.normalMass*r.y,_=u.K.ey.x*o.y+r.x,m=0,o.y>=0&&_>=0){xt.SubVV(o,s,a),xt.MulSV(a.x,b,l),xt.MulSV(a.y,b,c),xt.AddVV(l,c,h),x.SelfMulSub(p,h),S-=f*(xt.CrossVV(t.rA,l)+xt.CrossVV(n.rA,c)),A.SelfMulAdd(g,h),C+=y*(xt.CrossVV(t.rB,l)+xt.CrossVV(n.rB,c)),t.normalImpulse=o.x,n.normalImpulse=o.y;break}if(o.x=0,o.y=0,_=r.x,m=r.y,_>=0&&m>=0){xt.SubVV(o,s,a),xt.MulSV(a.x,b,l),xt.MulSV(a.y,b,c),xt.AddVV(l,c,h),x.SelfMulSub(p,h),S-=f*(xt.CrossVV(t.rA,l)+xt.CrossVV(n.rA,c)),A.SelfMulAdd(g,h),C+=y*(xt.CrossVV(t.rB,l)+xt.CrossVV(n.rB,c)),t.normalImpulse=o.x,n.normalImpulse=o.y;break}break}}this.m_velocities[m].w=S,this.m_velocities[d].w=C}}StoreImpulses(){for(let t=0;t<this.m_count;++t){const e=this.m_velocityConstraints[t],i=this.m_contacts[e.contactIndex].GetManifold();for(let t=0;t<e.pointCount;++t)i.points[t].normalImpulse=e.points[t].normalImpulse,i.points[t].tangentImpulse=e.points[t].tangentImpulse}}SolvePositionConstraints(){const t=Cs.SolvePositionConstraints_s_xfA,e=Cs.SolvePositionConstraints_s_xfB,i=Cs.SolvePositionConstraints_s_psm,n=Cs.SolvePositionConstraints_s_rA,s=Cs.SolvePositionConstraints_s_rB,r=Cs.SolvePositionConstraints_s_P;let o=0;for(let a=0;a<this.m_count;++a){const l=this.m_positionConstraints[a],c=l.indexA,h=l.indexB,u=l.localCenterA,m=l.invMassA,d=l.invIA,p=l.localCenterB,f=l.invMassB,y=l.invIB,v=l.pointCount,x=this.m_positions[c].c;let S=this.m_positions[c].a;const A=this.m_positions[h].c;let b=this.m_positions[h].a;for(let a=0;a<v;++a){t.q.SetAngle(S),e.q.SetAngle(b),xt.SubVV(x,Tt.MulRV(t.q,u,xt.s_t0),t.p),xt.SubVV(A,Tt.MulRV(e.q,p,xt.s_t0),e.p),i.Initialize(l,t,e,a);const c=i.normal,h=i.point,v=i.separation;xt.SubVV(h,x,n),xt.SubVV(h,A,s),o=tt(o,v);const T=it(C*(v+_),-g,0),w=xt.CrossVV(n,c),E=xt.CrossVV(s,c),P=m+f+d*w*w+y*E*E,I=P>0?-T/P:0;xt.MulSV(I,c,r),x.SelfMulSub(m,r),S-=d*xt.CrossVV(n,r),A.SelfMulAdd(f,r),b+=y*xt.CrossVV(s,r)}this.m_positions[c].a=S,this.m_positions[h].a=b}return o>-3*_}SolveTOIPositionConstraints(t,e){const i=Cs.SolveTOIPositionConstraints_s_xfA,n=Cs.SolveTOIPositionConstraints_s_xfB,s=Cs.SolveTOIPositionConstraints_s_psm,r=Cs.SolveTOIPositionConstraints_s_rA,o=Cs.SolveTOIPositionConstraints_s_rB,a=Cs.SolveTOIPositionConstraints_s_P;let l=0;for(let c=0;c<this.m_count;++c){const h=this.m_positionConstraints[c],u=h.indexA,m=h.indexB,d=h.localCenterA,p=h.localCenterB,f=h.pointCount;let y=0,v=0;u!==t&&u!==e||(y=h.invMassA,v=h.invIA);let x=0,S=0;m!==t&&m!==e||(x=h.invMassB,S=h.invIB);const A=this.m_positions[u].c;let C=this.m_positions[u].a;const T=this.m_positions[m].c;let w=this.m_positions[m].a;for(let t=0;t<f;++t){i.q.SetAngle(C),n.q.SetAngle(w),xt.SubVV(A,Tt.MulRV(i.q,d,xt.s_t0),i.p),xt.SubVV(T,Tt.MulRV(n.q,p,xt.s_t0),n.p),s.Initialize(h,i,n,t);const e=s.normal,c=s.point,u=s.separation;xt.SubVV(c,A,r),xt.SubVV(c,T,o),l=tt(l,u);const m=it(b*(u+_),-g,0),f=xt.CrossVV(r,e),E=xt.CrossVV(o,e),P=y+x+v*f*f+S*E*E,I=P>0?-m/P:0;xt.MulSV(I,e,a),A.SelfMulSub(y,a),C-=v*xt.CrossVV(r,a),T.SelfMulAdd(x,a),w+=S*xt.CrossVV(o,a)}this.m_positions[u].a=C,this.m_positions[m].a=w}return l>=-1.5*_}}Cs.InitializeVelocityConstraints_s_xfA=new wt,Cs.InitializeVelocityConstraints_s_xfB=new wt,Cs.InitializeVelocityConstraints_s_worldManifold=new fe,Cs.WarmStart_s_P=new xt,Cs.SolveVelocityConstraints_s_dv=new xt,Cs.SolveVelocityConstraints_s_dv1=new xt,Cs.SolveVelocityConstraints_s_dv2=new xt,Cs.SolveVelocityConstraints_s_P=new xt,Cs.SolveVelocityConstraints_s_a=new xt,Cs.SolveVelocityConstraints_s_b=new xt,Cs.SolveVelocityConstraints_s_x=new xt,Cs.SolveVelocityConstraints_s_d=new xt,Cs.SolveVelocityConstraints_s_P1=new xt,Cs.SolveVelocityConstraints_s_P2=new xt,Cs.SolveVelocityConstraints_s_P1P2=new xt,Cs.SolvePositionConstraints_s_xfA=new wt,Cs.SolvePositionConstraints_s_xfB=new wt,Cs.SolvePositionConstraints_s_psm=new As,Cs.SolvePositionConstraints_s_rA=new xt,Cs.SolvePositionConstraints_s_rB=new xt,Cs.SolvePositionConstraints_s_P=new xt,Cs.SolveTOIPositionConstraints_s_xfA=new wt,Cs.SolveTOIPositionConstraints_s_xfB=new wt,Cs.SolveTOIPositionConstraints_s_psm=new As,Cs.SolveTOIPositionConstraints_s_rA=new xt,Cs.SolveTOIPositionConstraints_s_rB=new xt,Cs.SolveTOIPositionConstraints_s_P=new xt;class bs{constructor(){this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=ds.MakeArray(1024),this.m_velocities=ps.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}Initialize(t,e,i,n){if(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_listener=n,this.m_positions.length<t){const e=et(2*this.m_positions.length,t);for(;this.m_positions.length<e;)this.m_positions[this.m_positions.length]=new ds}if(this.m_velocities.length<t){const e=et(2*this.m_velocities.length,t);for(;this.m_velocities.length<e;)this.m_velocities[this.m_velocities.length]=new ps}}Clear(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0}AddBody(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t}AddContact(t){this.m_contacts[this.m_contactCount++]=t}AddJoint(t){this.m_joints[this.m_jointCount++]=t}Solve(e,i,s,r){const o=bs.s_timer.Reset(),a=i.dt;for(let e=0;e<this.m_bodyCount;++e){const i=this.m_bodies[e];this.m_positions[e].c.Copy(i.m_sweep.c);const n=i.m_sweep.a,r=this.m_velocities[e].v.Copy(i.m_linearVelocity);let o=i.m_angularVelocity;i.m_sweep.c0.Copy(i.m_sweep.c),i.m_sweep.a0=i.m_sweep.a,i.m_type===t.b2BodyType.b2_dynamicBody&&(r.x+=a*(i.m_gravityScale*s.x+i.m_invMass*i.m_force.x),r.y+=a*(i.m_gravityScale*s.y+i.m_invMass*i.m_force.y),o+=a*i.m_invI*i.m_torque,r.SelfMul(1/(1+a*i.m_linearDamping)),o*=1/(1+a*i.m_angularDamping)),this.m_positions[e].a=n,this.m_velocities[e].w=o}o.Reset();const l=bs.s_solverData;l.step.Copy(i),l.positions=this.m_positions,l.velocities=this.m_velocities;const c=bs.s_contactSolverDef;c.step.Copy(i),c.contacts=this.m_contacts,c.count=this.m_contactCount,c.positions=this.m_positions,c.velocities=this.m_velocities;const h=bs.s_contactSolver.Initialize(c);h.InitializeVelocityConstraints(),i.warmStarting&&h.WarmStart();for(let t=0;t<this.m_jointCount;++t)this.m_joints[t].InitVelocityConstraints(l);e.solveInit=o.GetMilliseconds(),o.Reset();for(let t=0;t<i.velocityIterations;++t){for(let t=0;t<this.m_jointCount;++t)this.m_joints[t].SolveVelocityConstraints(l);h.SolveVelocityConstraints()}h.StoreImpulses(),e.solveVelocity=o.GetMilliseconds();for(let t=0;t<this.m_bodyCount;++t){const e=this.m_positions[t].c;let i=this.m_positions[t].a;const n=this.m_velocities[t].v;let s=this.m_velocities[t].w;const r=xt.MulSV(a,n,bs.s_translation);if(xt.DotVV(r,r)>x){const t=v/r.Length();n.SelfMul(t)}const o=a*s;o*o>A&&(s*=S/Q(o)),e.x+=a*n.x,e.y+=a*n.y,i+=a*s,this.m_positions[t].a=i,this.m_velocities[t].w=s}o.Reset();let _=!1;for(let t=0;t<i.positionIterations;++t){const t=h.SolvePositionConstraints();let e=!0;for(let t=0;t<this.m_jointCount;++t){const i=this.m_joints[t].SolvePositionConstraints(l);e=e&&i}if(t&&e){_=!0;break}}for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];e.m_sweep.c.Copy(this.m_positions[t].c),e.m_sweep.a=this.m_positions[t].a,e.m_linearVelocity.Copy(this.m_velocities[t].v),e.m_angularVelocity=this.m_velocities[t].w,e.SynchronizeTransform()}if(e.solvePosition=o.GetMilliseconds(),this.Report(h.m_velocityConstraints),r){let e=n;const i=L*L,s=F*F;for(let n=0;n<this.m_bodyCount;++n){const r=this.m_bodies[n];r.GetType()!==t.b2BodyType.b2_staticBody&&(!r.m_autoSleepFlag||r.m_angularVelocity*r.m_angularVelocity>s||xt.DotVV(r.m_linearVelocity,r.m_linearVelocity)>i?(r.m_sleepTime=0,e=0):(r.m_sleepTime+=a,e=tt(e,r.m_sleepTime)))}if(e>=N&&_)for(let t=0;t<this.m_bodyCount;++t)this.m_bodies[t].SetAwake(!1)}}SolveTOI(t,e,i){for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];this.m_positions[t].c.Copy(e.m_sweep.c),this.m_positions[t].a=e.m_sweep.a,this.m_velocities[t].v.Copy(e.m_linearVelocity),this.m_velocities[t].w=e.m_angularVelocity}const n=bs.s_contactSolverDef;n.contacts=this.m_contacts,n.count=this.m_contactCount,n.step.Copy(t),n.positions=this.m_positions,n.velocities=this.m_velocities;const s=bs.s_contactSolver.Initialize(n);for(let n=0;n<t.positionIterations&&!s.SolveTOIPositionConstraints(e,i);++n);this.m_bodies[e].m_sweep.c0.Copy(this.m_positions[e].c),this.m_bodies[e].m_sweep.a0=this.m_positions[e].a,this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,s.InitializeVelocityConstraints();for(let e=0;e<t.velocityIterations;++e)s.SolveVelocityConstraints();const r=t.dt;for(let t=0;t<this.m_bodyCount;++t){const e=this.m_positions[t].c;let i=this.m_positions[t].a;const n=this.m_velocities[t].v;let s=this.m_velocities[t].w;const o=xt.MulSV(r,n,bs.s_translation);if(xt.DotVV(o,o)>x){const t=v/o.Length();n.SelfMul(t)}const a=r*s;a*a>A&&(s*=S/Q(a)),e.SelfMulAdd(r,n),i+=r*s,this.m_positions[t].a=i,this.m_velocities[t].w=s;const l=this.m_bodies[t];l.m_sweep.c.Copy(e),l.m_sweep.a=i,l.m_linearVelocity.Copy(n),l.m_angularVelocity=s,l.SynchronizeTransform()}this.Report(s.m_velocityConstraints)}Report(t){if(null!==this.m_listener)for(let e=0;e<this.m_contactCount;++e){const i=this.m_contacts[e];if(!i)continue;const n=t[e],s=bs.s_impulse;s.count=n.pointCount;for(let t=0;t<n.pointCount;++t)s.normalImpulses[t]=n.points[t].normalImpulse,s.tangentImpulses[t]=n.points[t].tangentImpulse;this.m_listener.PostSolve(i,s)}}}var Ts,ws;bs.s_timer=new Rt,bs.s_solverData=new fs,bs.s_contactSolverDef=new Ss,bs.s_contactSolver=new Cs,bs.s_translation=new xt,bs.s_impulse=new as,(Ts=t.b2ParticleFlag||(t.b2ParticleFlag={}))[Ts.b2_waterParticle=0]="b2_waterParticle",Ts[Ts.b2_zombieParticle=2]="b2_zombieParticle",Ts[Ts.b2_wallParticle=4]="b2_wallParticle",Ts[Ts.b2_springParticle=8]="b2_springParticle",Ts[Ts.b2_elasticParticle=16]="b2_elasticParticle",Ts[Ts.b2_viscousParticle=32]="b2_viscousParticle",Ts[Ts.b2_powderParticle=64]="b2_powderParticle",Ts[Ts.b2_tensileParticle=128]="b2_tensileParticle",Ts[Ts.b2_colorMixingParticle=256]="b2_colorMixingParticle",Ts[Ts.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",Ts[Ts.b2_barrierParticle=1024]="b2_barrierParticle",Ts[Ts.b2_staticPressureParticle=2048]="b2_staticPressureParticle",Ts[Ts.b2_reactiveParticle=4096]="b2_reactiveParticle",Ts[Ts.b2_repulsiveParticle=8192]="b2_repulsiveParticle",Ts[Ts.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",Ts[Ts.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",Ts[Ts.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",Ts[Ts.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle";class Es{constructor(){this.flags=0,this.position=new xt,this.velocity=new xt,this.color=new Pt(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null}}function Ps(t,e,i){const n=8,s=.01;return it(Math.ceil(Math.sqrt(t/(s*e))*i),1,n)}class Is{constructor(){this.m_index=T}GetIndex(){return this.m_index}SetIndex(t){this.m_index=t}}(ws=t.b2ParticleGroupFlag||(t.b2ParticleGroupFlag={}))[ws.b2_solidParticleGroup=1]="b2_solidParticleGroup",ws[ws.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",ws[ws.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",ws[ws.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",ws[ws.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",ws[ws.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask";class Ds{constructor(){this.flags=0,this.groupFlags=0,this.position=new xt,this.angle=0,this.linearVelocity=new xt,this.angularVelocity=0,this.color=new Pt,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null}}class Rs{constructor(t){this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new xt,this.m_linearVelocity=new xt,this.m_angularVelocity=0,this.m_transform=new wt,this.m_userData=null,this.m_system=t}GetNext(){return this.m_next}GetParticleSystem(){return this.m_system}GetParticleCount(){return this.m_lastIndex-this.m_firstIndex}GetBufferIndex(){return this.m_firstIndex}ContainsParticle(t){return this.m_firstIndex<=t&&t<this.m_lastIndex}GetAllParticleFlags(){if(!this.m_system.m_flagsBuffer.data)throw new Error;let t=0;for(let e=this.m_firstIndex;e<this.m_lastIndex;e++)t|=this.m_system.m_flagsBuffer.data[e];return t}GetGroupFlags(){return this.m_groupFlags}SetGroupFlags(e){e|=this.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,e)}GetMass(){return this.UpdateStatistics(),this.m_mass}GetInertia(){return this.UpdateStatistics(),this.m_inertia}GetCenter(){return this.UpdateStatistics(),this.m_center}GetLinearVelocity(){return this.UpdateStatistics(),this.m_linearVelocity}GetAngularVelocity(){return this.UpdateStatistics(),this.m_angularVelocity}GetTransform(){return this.m_transform}GetPosition(){return this.m_transform.p}GetAngle(){return this.m_transform.q.GetAngle()}GetLinearVelocityFromWorldPoint(t,e){const i=Rs.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),xt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,xt.SubVV(t,this.m_center,i),e)}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}ApplyForce(t){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,t)}ApplyLinearImpulse(t){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,t)}DestroyParticles(t){if(this.m_system.m_world.IsLocked())throw new Error;for(let e=this.m_firstIndex;e<this.m_lastIndex;e++)this.m_system.DestroyParticle(e,t)}UpdateStatistics(){if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;const t=new xt,e=new xt;if(this.m_timestamp!==this.m_system.m_timestamp){const i=this.m_system.GetParticleMass();this.m_mass=i*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(let t=this.m_firstIndex;t<this.m_lastIndex;t++)this.m_center.SelfMulAdd(i,this.m_system.m_positionBuffer.data[t]),this.m_linearVelocity.SelfMulAdd(i,this.m_system.m_velocityBuffer.data[t]);if(this.m_mass>0){const t=1/this.m_mass;this.m_center.SelfMul(t),this.m_linearVelocity.SelfMul(t)}this.m_inertia=0,this.m_angularVelocity=0;for(let n=this.m_firstIndex;n<this.m_lastIndex;n++)xt.SubVV(this.m_system.m_positionBuffer.data[n],this.m_center,t),xt.SubVV(this.m_system.m_velocityBuffer.data[n],this.m_linearVelocity,e),this.m_inertia+=i*xt.DotVV(t,t),this.m_angularVelocity+=i*xt.CrossVV(t,e);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}}}Rs.GetLinearVelocityFromWorldPoint_s_t0=new xt;class Ms{constructor(t){this.m_buffer=[],this.m_front=0,this.m_back=0,this.m_buffer.fill(null,0,t)}get m_capacity(){return this.m_buffer.length}Push(t){if(this.m_back>=this.m_capacity){for(let t=this.m_front;t<this.m_back;t++)this.m_buffer[t-this.m_front]=this.m_buffer[t];this.m_back-=this.m_front,this.m_front=0}this.m_buffer[this.m_back]=t,this.m_back++}Pop(){this.m_buffer[this.m_front]=null,this.m_front++}Empty(){return this.m_front===this.m_back}Front(){const t=this.m_buffer[this.m_front];if(!t)throw new Error;return t}}class Bs{constructor(t){this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=[],this.m_generatorBuffer=X(t,(()=>new Os)),this.m_generatorCapacity=t}AddGenerator(t,e,i){const n=this.m_generatorBuffer[this.m_generatorCount++];n.center.Copy(t),n.tag=e,n.necessary=i}Generate(t,e){const i=1/t,s=new xt(+n,+n),r=new xt(-n,-n);let o=0;for(let t=0;t<this.m_generatorCount;t++){const e=this.m_generatorBuffer[t];e.necessary&&(xt.MinV(s,e.center,s),xt.MaxV(r,e.center,r),++o)}if(0===o)return this.m_countX=0,void(this.m_countY=0);s.x-=e,s.y-=e,r.x+=e,r.y+=e,this.m_countX=1+Math.floor(i*(r.x-s.x)),this.m_countY=1+Math.floor(i*(r.y-s.y)),this.m_diagram=[];const a=new Ms(4*this.m_countX*this.m_countY);for(let t=0;t<this.m_generatorCount;t++){const e=this.m_generatorBuffer[t];e.center.SelfSub(s).SelfMul(i);const n=Math.floor(e.center.x),r=Math.floor(e.center.y);n>=0&&r>=0&&n<this.m_countX&&r<this.m_countY&&a.Push(new Ns(n,r,n+r*this.m_countX,e))}for(;!a.Empty();){const t=a.Front(),e=t.m_x,i=t.m_y,n=t.m_i,s=t.m_generator;a.Pop(),this.m_diagram[n]||(this.m_diagram[n]=s,e>0&&a.Push(new Ns(e-1,i,n-1,s)),i>0&&a.Push(new Ns(e,i-1,n-this.m_countX,s)),e<this.m_countX-1&&a.Push(new Ns(e+1,i,n+1,s)),i<this.m_countY-1&&a.Push(new Ns(e,i+1,n+this.m_countX,s)))}for(let t=0;t<this.m_countY;t++)for(let e=0;e<this.m_countX-1;e++){const i=e+t*this.m_countX,n=this.m_diagram[i],s=this.m_diagram[i+1];n!==s&&(a.Push(new Ns(e,t,i,s)),a.Push(new Ns(e+1,t,i+1,n)))}for(let t=0;t<this.m_countY-1;t++)for(let e=0;e<this.m_countX;e++){const i=e+t*this.m_countX,n=this.m_diagram[i],s=this.m_diagram[i+this.m_countX];n!==s&&(a.Push(new Ns(e,t,i,s)),a.Push(new Ns(e,t+1,i+this.m_countX,n)))}for(;!a.Empty();){const t=a.Front(),e=t.m_x,i=t.m_y,n=t.m_i,s=t.m_generator;a.Pop();const r=this.m_diagram[n],o=s;if(r!==o){const t=r.center.x-e,s=r.center.y-i,l=o.center.x-e,c=o.center.y-i;t*t+s*s>l*l+c*c&&(this.m_diagram[n]=o,e>0&&a.Push(new Ns(e-1,i,n-1,o)),i>0&&a.Push(new Ns(e,i-1,n-this.m_countX,o)),e<this.m_countX-1&&a.Push(new Ns(e+1,i,n+1,o)),i<this.m_countY-1&&a.Push(new Ns(e,i+1,n+this.m_countX,o)))}}}GetNodes(t){for(let e=0;e<this.m_countY-1;e++)for(let i=0;i<this.m_countX-1;i++){const n=i+e*this.m_countX,s=this.m_diagram[n],r=this.m_diagram[n+1],o=this.m_diagram[n+this.m_countX],a=this.m_diagram[n+1+this.m_countX];r!==o&&(s!==r&&s!==o&&(s.necessary||r.necessary||o.necessary)&&t(s.tag,r.tag,o.tag),a!==r&&a!==o&&(s.necessary||r.necessary||o.necessary)&&t(r.tag,a.tag,o.tag))}}}class Os{constructor(){this.center=new xt,this.tag=0,this.necessary=!1}}class Ns{constructor(t,e,i,n){this.m_x=t,this.m_y=e,this.m_i=i,this.m_generator=n}}function Ls(t,e,i){const n=t[e];t[e]=t[i],t[i]=n}function Fs(t,e){return t<e}function zs(t,e=0,i=t.length-e,n=Fs){let s=e;const r=[];let o=0;for(;;){for(;s+1<i;i++){const e=t[s+Math.floor(Math.random()*(i-s))];r[o++]=i;for(let r=s-1;;){for(;n(t[++r],e););for(;n(e,t[--i]););if(r>=i)break;Ls(t,r,i)}}if(0===o)break;s=i,i=r[--o]}return t}function Vs(t,e=0,i=t.length-e,n=Fs){return zs(t,e,i,n)}function Us(t,e,i=t.length){let n=0;for(let s=0;s<i;++s)e(t[s])||(s!==n?Ls(t,n++,s):++n);return n}function Gs(t,e,i,n,s){let r=i-e;for(;r>0;){const i=Math.floor(r/2);let o=e+i;s(t[o],n)?(e=++o,r-=i+1):r=i}return e}function Hs(t,e,i,n,s){let r=i-e;for(;r>0;){const i=Math.floor(r/2);let o=e+i;s(n,t[o])?r=i:(e=++o,r-=i+1)}return e}function ks(t,e,i,n){let s=i;for(;e!==s;)Ls(t,e++,s++),s===n?s=i:e===i&&(i=s)}function js(t,e,i,n){if(e===i)return i;let s=e;for(;++e!==i;)n(t[s],t[e])||Ls(t,++s,e);return++s}class Ws{constructor(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}Append(){return this.count>=this.capacity&&this.Grow(),this.count++}Reserve(t){if(!(this.capacity>=t)){for(let e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}}Grow(){const t=this.capacity?2*this.capacity:B;this.Reserve(t)}Free(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)}Shorten(t){}Data(){return this.data}GetCount(){return this.count}SetCount(t){this.count=t}GetCapacity(){return this.capacity}RemoveIf(t){this.count=Us(this.data,t,this.count)}Unique(t){this.count=js(this.data,0,this.count,t)}}class qs extends cs{constructor(t){super(),this.m_system=t}ShouldQueryParticleSystem(t){return!1}ReportFixture(t){if(t.IsSensor())return!0;const e=t.GetShape().GetChildCount();for(let i=0;i<e;i++){const e=t.GetAABB(i),n=this.m_system.GetInsideBoundsEnumerator(e);let s;for(;(s=n.GetNext())>=0;)this.ReportFixtureAndParticle(t,i,s)}return!0}ReportParticle(t,e){return!1}ReportFixtureAndParticle(t,e,i){}}class Xs{constructor(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new xt,this.flags=0}SetIndices(t,e){this.indexA=t,this.indexB=e}SetWeight(t){this.weight=t}SetNormal(t){this.normal.Copy(t)}SetFlags(t){this.flags=t}GetIndexA(){return this.indexA}GetIndexB(){return this.indexB}GetWeight(){return this.weight}GetNormal(){return this.normal}GetFlags(){return this.flags}IsEqual(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y}IsNotEqual(t){return!this.IsEqual(t)}ApproximatelyEqual(t){const e=.01,i=1e-4;return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&Q(this.weight-t.weight)<e&&xt.DistanceSquaredVV(this.normal,t.normal)<i}}class Ys{constructor(){this.index=0,this.weight=0,this.normal=new xt,this.mass=0}}class Ks{constructor(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0}}class Js{constructor(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new xt(0,0),this.pb=new xt(0,0),this.pc=new xt(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0}}class $s{constructor(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}Copy(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this}Clone(){return(new $s).Copy(this)}}class Zs{constructor(t,e){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new Qs,this.m_flagsBuffer=new Qs,this.m_positionBuffer=new Qs,this.m_velocityBuffer=new Qs,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new Qs,this.m_groupBuffer=[],this.m_userDataBuffer=new Qs,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new Qs,this.m_bodyContactCountBuffer=new Qs,this.m_consecutiveContactStepsBuffer=new Qs,this.m_stuckParticleBuffer=new Ws((()=>0)),this.m_proxyBuffer=new Ws((()=>new tr)),this.m_contactBuffer=new Ws((()=>new Xs)),this.m_bodyContactBuffer=new Ws((()=>new Ys)),this.m_pairBuffer=new Ws((()=>new Ks)),this.m_triadBuffer=new Ws((()=>new Js)),this.m_expirationTimeBuffer=new Qs,this.m_indexByExpirationTimeBuffer=new Qs,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new $s,this.m_prev=null,this.m_next=null,this.UpdateBodyContacts_callback=null,this.SolveCollision_callback=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),this.m_def=t.Clone(),this.m_world=e,this.SetDestructionByAge(this.m_def.destroyByAge)}static computeTag(t,e){return(e+Zs.yOffset>>>0<<Zs.yShift)+(Zs.xScale*t+Zs.xOffset>>>0)>>>0}static computeRelativeTag(t,e,i){return t+(i<<Zs.yShift)+(e<<Zs.xShift)>>>0}Drop(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)}CreateParticle(t){if(this.m_world.IsLocked())throw new Error;if(this.m_count>=this.m_internalAllocatedCapacity){const t=this.m_count?2*this.m_count:B;this.ReallocateInternalAllocatedBuffers(t)}if(this.m_count>=this.m_internalAllocatedCapacity){if(!this.m_def.destroyByAge)return T;this.DestroyOldestParticle(0,!1),this.SolveZombie()}const e=this.m_count++;this.m_flagsBuffer.data[e]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=0),this.m_positionBuffer.data[e]=(this.m_positionBuffer.data[e]||new xt).Copy(i(t.position,xt.ZERO)),this.m_velocityBuffer.data[e]=(this.m_velocityBuffer.data[e]||new xt).Copy(i(t.velocity,xt.ZERO)),this.m_weightBuffer[e]=0,this.m_forceBuffer[e]=(this.m_forceBuffer[e]||new xt).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=0),this.m_depthBuffer&&(this.m_depthBuffer[e]=0);const n=(new Pt).Copy(i(t.color,Pt.ZERO));!this.m_colorBuffer.data&&n.IsZero()||(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[e]=(this.m_colorBuffer.data[e]||new Pt).Copy(n)),(this.m_userDataBuffer.data||t.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[e]=t.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[e]=null);const s=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],r=i(t.lifetime,0),o=r>0;(this.m_expirationTimeBuffer.data||o)&&(this.SetParticleLifetime(e,o?r:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[e]=e),s.index=e;const a=i(t.group,null);return this.m_groupBuffer[e]=a,a&&(a.m_firstIndex<a.m_lastIndex?(this.RotateBuffer(a.m_firstIndex,a.m_lastIndex,e),a.m_lastIndex=e+1):(a.m_firstIndex=e,a.m_lastIndex=e+1)),this.SetParticleFlags(e,i(t.flags,0)),e}GetParticleHandleFromIndex(t){this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);let e=this.m_handleIndexBuffer.data[t];return e||(e=new Is,e.SetIndex(t),this.m_handleIndexBuffer.data[t]=e,e)}DestroyParticle(e,i=!1){let n=t.b2ParticleFlag.b2_zombieParticle;i&&(n|=t.b2ParticleFlag.b2_destructionListenerParticle),this.SetParticleFlags(e,this.m_flagsBuffer.data[e]|n)}DestroyOldestParticle(t,e=!1){const i=this.GetParticleCount(),n=this.m_indexByExpirationTimeBuffer.data[i-(t+1)],s=this.m_indexByExpirationTimeBuffer.data[t];this.DestroyParticle(this.m_expirationTimeBuffer.data[n]>0?n:s,e)}DestroyParticlesInShape(t,e,i=!1){const n=Zs.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked())throw new Error;const s=new cr(this,t,e,i),r=n;return t.ComputeAABB(r,e,0),this.m_world.QueryAABB(s,r),s.Destroyed()}CreateParticleGroup(t){const e=Zs.CreateParticleGroup_s_transform;if(this.m_world.IsLocked())throw new Error;const n=e;n.SetPositionAngle(i(t.position,xt.ZERO),i(t.angle,0));const s=this.m_count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,n),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,i(t.shapeCount,t.shapes.length),t,n),t.positionData){const e=i(t.particleCount,t.positionData.length);for(let i=0;i<e;i++){const e=t.positionData[i];this.CreateParticleForGroup(t,n,e)}}const r=this.m_count;let o=new Rs(this);o.m_firstIndex=s,o.m_lastIndex=r,o.m_strength=i(t.strength,1),o.m_userData=t.userData,o.m_transform.Copy(n),o.m_prev=null,o.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=o),this.m_groupList=o,++this.m_groupCount;for(let t=s;t<r;t++)this.m_groupBuffer[t]=o;this.SetGroupFlags(o,i(t.groupFlags,0));const a=new lr;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(s,r,a),t.group&&(this.JoinParticleGroups(t.group,o),o=t.group),o}JoinParticleGroups(t,e){if(this.m_world.IsLocked())throw new Error;this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,this.m_count),this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,e.m_firstIndex);const i=new hr(e.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.m_firstIndex,e.m_lastIndex,i);for(let i=e.m_firstIndex;i<e.m_lastIndex;i++)this.m_groupBuffer[i]=t;const n=t.m_groupFlags|e.m_groupFlags;this.SetGroupFlags(t,n),t.m_lastIndex=e.m_lastIndex,e.m_firstIndex=e.m_lastIndex,this.DestroyParticleGroup(e)}SplitParticleGroup(t){this.UpdateContacts(!0);const e=X(t.GetParticleCount(),(()=>new ir));Zs.InitializeParticleLists(t,e),this.MergeParticleListsInContact(t,e);const i=Zs.FindLongestParticleList(t,e);this.MergeZombieParticleListNodes(t,e,i),this.CreateParticleGroupsFromParticleList(t,e,i),this.UpdatePairsAndTriadsWithParticleList(t,e)}GetParticleGroupList(){return this.m_groupList}GetParticleGroupCount(){return this.m_groupCount}GetParticleCount(){return this.m_count}GetMaxParticleCount(){return this.m_def.maxCount}SetMaxParticleCount(t){this.m_def.maxCount=t}GetAllParticleFlags(){return this.m_allParticleFlags}GetAllGroupFlags(){return this.m_allGroupFlags}SetPaused(t){this.m_paused=t}GetPaused(){return this.m_paused}SetDensity(t){this.m_def.density=t,this.m_inverseDensity=1/this.m_def.density}GetDensity(){return this.m_def.density}SetGravityScale(t){this.m_def.gravityScale=t}GetGravityScale(){return this.m_def.gravityScale}SetDamping(t){this.m_def.dampingStrength=t}GetDamping(){return this.m_def.dampingStrength}SetStaticPressureIterations(t){this.m_def.staticPressureIterations=t}GetStaticPressureIterations(){return this.m_def.staticPressureIterations}SetRadius(t){this.m_particleDiameter=2*t,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter}GetRadius(){return this.m_particleDiameter/2}GetPositionBuffer(){return this.m_positionBuffer.data}GetVelocityBuffer(){return this.m_velocityBuffer.data}GetColorBuffer(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data}GetGroupBuffer(){return this.m_groupBuffer}GetWeightBuffer(){return this.m_weightBuffer}GetUserDataBuffer(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data}GetFlagsBuffer(){return this.m_flagsBuffer.data}SetParticleFlags(e,i){this.m_flagsBuffer.data[e]&~i&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&i&&(i&t.b2ParticleFlag.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),i&t.b2ParticleFlag.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=i),this.m_flagsBuffer.data[e]=i}GetParticleFlags(t){return this.m_flagsBuffer.data[t]}SetFlagsBuffer(t){this.SetUserOverridableBuffer(this.m_flagsBuffer,t)}SetPositionBuffer(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;const e=t.length/2,i=new Array(e);for(let n=0;n<e;++n)i[n]=new xt(t.subarray(2*n,2*n+2));t=i}this.SetUserOverridableBuffer(this.m_positionBuffer,t)}SetVelocityBuffer(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;const e=t.length/2,i=new Array(e);for(let n=0;n<e;++n)i[n]=new xt(t.subarray(2*n,2*n+2));t=i}this.SetUserOverridableBuffer(this.m_velocityBuffer,t)}SetColorBuffer(t){if(t instanceof Float32Array){if(t.length%4!=0)throw new Error;const e=t.length/4,i=new Array(e);for(let n=0;n<e;++n)i[n]=new Pt(t.subarray(4*n,4*n+4));t=i}this.SetUserOverridableBuffer(this.m_colorBuffer,t)}SetUserDataBuffer(t){this.SetUserOverridableBuffer(this.m_userDataBuffer,t)}GetContacts(){return this.m_contactBuffer.data}GetContactCount(){return this.m_contactBuffer.count}GetBodyContacts(){return this.m_bodyContactBuffer.data}GetBodyContactCount(){return this.m_bodyContactBuffer.count}GetPairs(){return this.m_pairBuffer.data}GetPairCount(){return this.m_pairBuffer.count}GetTriads(){return this.m_triadBuffer.data}GetTriadCount(){return this.m_triadBuffer.count}SetStuckThreshold(t){this.m_stuckThreshold=t,t>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))}GetStuckCandidates(){return this.m_stuckParticleBuffer.Data()}GetStuckCandidateCount(){return this.m_stuckParticleBuffer.GetCount()}ComputeCollisionEnergy(){const t=Zs.ComputeCollisionEnergy_s_v,e=this.m_velocityBuffer.data;let i=0;for(let n=0;n<this.m_contactBuffer.count;n++){const s=this.m_contactBuffer.data[n],r=s.indexA,o=s.indexB,a=s.normal,l=xt.SubVV(e[o],e[r],t),c=xt.DotVV(l,a);c<0&&(i+=c*c)}return.5*this.GetParticleMass()*i}SetStrictContactCheck(t){this.m_def.strictContactCheck=t}GetStrictContactCheck(){return this.m_def.strictContactCheck}SetParticleLifetime(t,e){const i=null===this.m_indexByExpirationTimeBuffer.data;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),i){const t=this.GetParticleCount();for(let e=0;e<t;++e)this.m_indexByExpirationTimeBuffer.data[e]=e}const n=e/this.m_def.lifetimeGranularity,s=n>0?this.GetQuantizedTimeElapsed()+n:n;s!==this.m_expirationTimeBuffer.data[t]&&(this.m_expirationTimeBuffer.data[t]=s,this.m_expirationTimeBufferRequiresSorting=!0)}GetParticleLifetime(t){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])}SetDestructionByAge(t){t&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=t}GetDestructionByAge(){return this.m_def.destroyByAge}GetExpirationTimeBuffer(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data}ExpirationTimeToLifetime(t){return(t>0?t-this.GetQuantizedTimeElapsed():t)*this.m_def.lifetimeGranularity}GetIndexByExpirationTimeBuffer(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data}ParticleApplyLinearImpulse(t,e){this.ApplyLinearImpulse(t,t+1,e)}ApplyLinearImpulse(t,e,i){const n=this.m_velocityBuffer.data,s=(e-t)*this.GetParticleMass(),r=(new xt).Copy(i).SelfMul(1/s);for(let i=t;i<e;i++)n[i].SelfAdd(r)}static IsSignificantForce(t){return 0!==t.x||0!==t.y}ParticleApplyForce(t,e){Zs.IsSignificantForce(e)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.m_forceBuffer[t].SelfAdd(e))}ApplyForce(t,e,i){const n=(new xt).Copy(i).SelfMul(1/(e-t));if(Zs.IsSignificantForce(n)){this.PrepareForceBuffer();for(let i=t;i<e;i++)this.m_forceBuffer[i].SelfAdd(n)}}GetNext(){return this.m_next}QueryAABB(t,e){if(0===this.m_proxyBuffer.count)return;const i=0,n=this.m_proxyBuffer.count,s=Gs(this.m_proxyBuffer.data,i,n,Zs.computeTag(this.m_inverseDiameter*e.lowerBound.x,this.m_inverseDiameter*e.lowerBound.y),tr.CompareProxyTag),r=Hs(this.m_proxyBuffer.data,s,n,Zs.computeTag(this.m_inverseDiameter*e.upperBound.x,this.m_inverseDiameter*e.upperBound.y),tr.CompareTagProxy),o=this.m_positionBuffer.data;for(let i=s;i<r;++i){const n=this.m_proxyBuffer.data[i].index,s=o[n];if(e.lowerBound.x<s.x&&s.x<e.upperBound.x&&e.lowerBound.y<s.y&&s.y<e.upperBound.y&&!t.ReportParticle(this,n))break}}QueryShapeAABB(t,e,i,n=0){const s=Zs.QueryShapeAABB_s_aabb;e.ComputeAABB(s,i,n),this.QueryAABB(t,s)}QueryPointAABB(t,e,i=_){const n=Zs.QueryPointAABB_s_aabb;n.lowerBound.Set(e.x-i,e.y-i),n.upperBound.Set(e.x+i,e.y+i),this.QueryAABB(t,n)}RayCast(t,e,i){const n=Zs.RayCast_s_aabb,s=Zs.RayCast_s_p,r=Zs.RayCast_s_v,o=Zs.RayCast_s_n,a=Zs.RayCast_s_point;if(0===this.m_proxyBuffer.count)return;const l=this.m_positionBuffer.data,c=n;xt.MinV(e,i,c.lowerBound),xt.MaxV(e,i,c.upperBound);let h=1;const _=xt.SubVV(i,e,r),u=xt.DotVV(_,_),m=this.GetInsideBoundsEnumerator(c);let d;for(;(d=m.GetNext())>=0;){const i=xt.SubVV(e,l[d],s),n=xt.DotVV(i,_),r=n*n-u*(xt.DotVV(i,i)-this.m_squaredDiameter);if(r>=0){const s=at(r);let l=(-n-s)/u;if(l>h)continue;if(l<0&&(l=(-n+s)/u,l<0||l>h))continue;const c=xt.AddVMulSV(i,l,_,o);if(c.Normalize(),h=tt(h,t.ReportParticle(this,d,xt.AddVMulSV(e,l,_,a),c,l)),h<=0)break}}}ComputeAABB(t){const e=this.GetParticleCount();t.lowerBound.x=+n,t.lowerBound.y=+n,t.upperBound.x=-n,t.upperBound.y=-n;const i=this.m_positionBuffer.data;for(let n=0;n<e;n++){const e=i[n];xt.MinV(t.lowerBound,e,t.lowerBound),xt.MaxV(t.upperBound,e,t.upperBound)}t.lowerBound.x-=this.m_particleDiameter,t.lowerBound.y-=this.m_particleDiameter,t.upperBound.x+=this.m_particleDiameter,t.upperBound.y+=this.m_particleDiameter}FreeBuffer(t,e){null!==t&&(t.length=0)}FreeUserOverridableBuffer(t){0===t.userSuppliedCapacity&&this.FreeBuffer(t.data,this.m_internalAllocatedCapacity)}ReallocateBuffer3(t,e,i){if(i<=e)throw new Error;const n=t?t.slice():[];return n.length=i,n}ReallocateBuffer5(t,e,i,n,s){if(n<=i)throw new Error;if(e&&!(n<=e))throw new Error;return s&&!t||e||(t=this.ReallocateBuffer3(t,i,n)),t}ReallocateBuffer4(t,e,i,n){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,i,n)}RequestBuffer(t){return t||(0===this.m_internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(B),(t=[]).length=this.m_internalAllocatedCapacity),t}ReallocateHandleBuffers(t){this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,t,!0)}ReallocateInternalAllocatedBuffers(t){function e(t,e){return e&&t>e?e:t}if(t=e(t,this.m_def.maxCount),t=e(t,this.m_flagsBuffer.userSuppliedCapacity),t=e(t,this.m_positionBuffer.userSuppliedCapacity),t=e(t,this.m_velocityBuffer.userSuppliedCapacity),t=e(t,this.m_colorBuffer.userSuppliedCapacity),t=e(t,this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<t){this.ReallocateHandleBuffers(t),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,t,!1);const e=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,t,e),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,t,e),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,t,e),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_internalAllocatedCapacity=t}}CreateParticleForGroup(t,e,n){const s=new Es;s.flags=i(t.flags,0),wt.MulXV(e,n,s.position),xt.AddVV(i(t.linearVelocity,xt.ZERO),xt.CrossSV(i(t.angularVelocity,0),xt.SubVV(s.position,i(t.position,xt.ZERO),xt.s_t0),xt.s_t0),s.velocity),s.color.Copy(i(t.color,Pt.ZERO)),s.lifetime=i(t.lifetime,0),s.userData=t.userData,this.CreateParticle(s)}CreateParticlesStrokeShapeForGroup(e,n,s){const r=Zs.CreateParticlesStrokeShapeForGroup_s_edge,o=Zs.CreateParticlesStrokeShapeForGroup_s_d,a=Zs.CreateParticlesStrokeShapeForGroup_s_p;let l=i(n.stride,0);0===l&&(l=this.GetParticleStride());let c=0;const h=e.GetChildCount();for(let i=0;i<h;i++){let h=null;e.GetType()===t.b2ShapeType.e_edgeShape?h=e:(h=r,e.GetChildEdge(h,i));const _=xt.SubVV(h.m_vertex2,h.m_vertex1,o),u=_.Length();for(;c<u;){const t=xt.AddVMulSV(h.m_vertex1,c/u,_,a);this.CreateParticleForGroup(n,s,t),c+=l}c-=u}}CreateParticlesFillShapeForGroup(t,e,n){const s=Zs.CreateParticlesFillShapeForGroup_s_aabb,r=Zs.CreateParticlesFillShapeForGroup_s_p;let o=i(e.stride,0);0===o&&(o=this.GetParticleStride());const a=wt.IDENTITY,l=s;t.ComputeAABB(l,a,0);for(let i=Math.floor(l.lowerBound.y/o)*o;i<l.upperBound.y;i+=o)for(let s=Math.floor(l.lowerBound.x/o)*o;s<l.upperBound.x;s+=o){const o=r.Set(s,i);t.TestPoint(a,o)&&this.CreateParticleForGroup(e,n,o)}}CreateParticlesWithShapeForGroup(e,i,n){switch(e.GetType()){case t.b2ShapeType.e_edgeShape:case t.b2ShapeType.e_chainShape:this.CreateParticlesStrokeShapeForGroup(e,i,n);break;case t.b2ShapeType.e_polygonShape:case t.b2ShapeType.e_circleShape:this.CreateParticlesFillShapeForGroup(e,i,n)}}CreateParticlesWithShapesForGroup(t,e,i,n){const s=new _r(t,e);this.CreateParticlesFillShapeForGroup(s,i,n)}CloneParticle(t,e){const i=new Es;i.flags=this.m_flagsBuffer.data[t],i.position.Copy(this.m_positionBuffer.data[t]),i.velocity.Copy(this.m_velocityBuffer.data[t]),this.m_colorBuffer.data&&i.color.Copy(this.m_colorBuffer.data[t]),this.m_userDataBuffer.data&&(i.userData=this.m_userDataBuffer.data[t]),i.group=e;const n=this.CreateParticle(i);if(this.m_handleIndexBuffer.data){const e=this.m_handleIndexBuffer.data[t];e&&e.SetIndex(n),this.m_handleIndexBuffer.data[n]=e,this.m_handleIndexBuffer.data[t]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[n]=this.m_lastBodyContactStepBuffer.data[t]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[n]=this.m_bodyContactCountBuffer.data[t]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[n]=this.m_consecutiveContactStepsBuffer.data[t]),this.m_hasForce&&this.m_forceBuffer[n].Copy(this.m_forceBuffer[t]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[n]=this.m_staticPressureBuffer[t]),this.m_depthBuffer&&(this.m_depthBuffer[n]=this.m_depthBuffer[t]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[n]=this.m_expirationTimeBuffer.data[t]),n}DestroyParticlesInGroup(t,e=!1){for(let i=t.m_firstIndex;i<t.m_lastIndex;i++)this.DestroyParticle(i,e)}DestroyParticleGroup(t){this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(let e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_groupBuffer[e]=null;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_groupList&&(this.m_groupList=t.m_next),--this.m_groupCount}static ParticleCanBeConnected(e,i){return 0!=(e&(t.b2ParticleFlag.b2_wallParticle|t.b2ParticleFlag.b2_springParticle|t.b2ParticleFlag.b2_elasticParticle))||null!==i&&0!=(i.GetGroupFlags()&t.b2ParticleGroupFlag.b2_rigidParticleGroup)}UpdatePairsAndTriads(e,i,n){const s=Zs.UpdatePairsAndTriads_s_dab,r=Zs.UpdatePairsAndTriads_s_dbc,o=Zs.UpdatePairsAndTriads_s_dca,a=this.m_positionBuffer.data;let l=0;for(let t=e;t<i;t++)l|=this.m_flagsBuffer.data[t];if(l&Zs.k_pairFlags)for(let s=0;s<this.m_contactBuffer.count;s++){const r=this.m_contactBuffer.data[s],o=r.indexA,l=r.indexB,c=this.m_flagsBuffer.data[o],h=this.m_flagsBuffer.data[l],_=this.m_groupBuffer[o],u=this.m_groupBuffer[l];if(o>=e&&o<i&&l>=e&&l<i&&!((c|h)&t.b2ParticleFlag.b2_zombieParticle)&&(c|h)&Zs.k_pairFlags&&(n.IsNecessary(o)||n.IsNecessary(l))&&Zs.ParticleCanBeConnected(c,_)&&Zs.ParticleCanBeConnected(h,u)&&n.ShouldCreatePair(o,l)){const t=this.m_pairBuffer.data[this.m_pairBuffer.Append()];t.indexA=o,t.indexB=l,t.flags=r.flags,t.strength=tt(_?_.m_strength:1,u?u.m_strength:1),t.distance=xt.DistanceVV(a[o],a[l])}Vs(this.m_pairBuffer.data,0,this.m_pairBuffer.count,Zs.ComparePairIndices),this.m_pairBuffer.Unique(Zs.MatchPairIndices)}if(l&Zs.k_triadFlags){const l=new Bs(i-e);for(let s=e;s<i;s++){const e=this.m_flagsBuffer.data[s],i=this.m_groupBuffer[s];e&t.b2ParticleFlag.b2_zombieParticle||!Zs.ParticleCanBeConnected(e,i)||l.AddGenerator(a[s],s,n.IsNecessary(s))}const c=this.GetParticleStride();l.Generate(c/2,2*c);const h=this,_=(t,e,i)=>{const l=h.m_flagsBuffer.data[t],c=h.m_flagsBuffer.data[e],_=h.m_flagsBuffer.data[i];if((l|c|_)&Zs.k_triadFlags&&n.ShouldCreateTriad(t,e,i)){const n=a[t],u=a[e],m=a[i],d=xt.SubVV(n,u,s),p=xt.SubVV(u,m,r),f=xt.SubVV(m,n,o),g=M*h.m_squaredDiameter;if(xt.DotVV(d,d)>g||xt.DotVV(p,p)>g||xt.DotVV(f,f)>g)return;const y=h.m_groupBuffer[t],v=h.m_groupBuffer[e],x=h.m_groupBuffer[i],S=h.m_triadBuffer.data[h.m_triadBuffer.Append()];S.indexA=t,S.indexB=e,S.indexC=i,S.flags=l|c|_,S.strength=tt(tt(y?y.m_strength:1,v?v.m_strength:1),x?x.m_strength:1);const A=(n.x+u.x+m.x)/3,C=(n.y+u.y+m.y)/3;S.pa.x=n.x-A,S.pa.y=n.y-C,S.pb.x=u.x-A,S.pb.y=u.y-C,S.pc.x=m.x-A,S.pc.y=m.y-C,S.ka=-xt.DotVV(f,d),S.kb=-xt.DotVV(d,p),S.kc=-xt.DotVV(p,f),S.s=xt.CrossVV(n,u)+xt.CrossVV(u,m)+xt.CrossVV(m,n)}};l.GetNodes(_),Vs(this.m_triadBuffer.data,0,this.m_triadBuffer.count,Zs.CompareTriadIndices),this.m_triadBuffer.Unique(Zs.MatchTriadIndices)}}UpdatePairsAndTriadsWithReactiveParticles(){const e=new ur(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,e);for(let e=0;e<this.m_count;e++)this.m_flagsBuffer.data[e]&=~t.b2ParticleFlag.b2_reactiveParticle;this.m_allParticleFlags&=~t.b2ParticleFlag.b2_reactiveParticle}static ComparePairIndices(t,e){const i=t.indexA-e.indexA;return 0!==i?i<0:t.indexB<e.indexB}static MatchPairIndices(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB}static CompareTriadIndices(t,e){const i=t.indexA-e.indexA;if(0!==i)return i<0;const n=t.indexB-e.indexB;return 0!==n?n<0:t.indexC<e.indexC}static MatchTriadIndices(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC}static InitializeParticleLists(t,e){const i=t.GetBufferIndex(),n=t.GetParticleCount();for(let t=0;t<n;t++){const n=e[t];n.list=n,n.next=null,n.count=1,n.index=t+i}}MergeParticleListsInContact(t,e){const i=t.GetBufferIndex();for(let n=0;n<this.m_contactBuffer.count;n++){const s=this.m_contactBuffer.data[n],r=s.indexA,o=s.indexB;if(!t.ContainsParticle(r)||!t.ContainsParticle(o))continue;let a=e[r-i].list,l=e[o-i].list;if(a!==l){if(a.count<l.count){const t=a;a=l,l=t}Zs.MergeParticleLists(a,l)}}}static MergeParticleLists(t,e){for(let i=e;;){i.list=t;const e=i.next;if(!e){i.next=t.next;break}i=e}t.next=e,t.count+=e.count,e.count=0}static FindLongestParticleList(t,e){const i=t.GetParticleCount();let n=e[0];for(let t=0;t<i;t++){const i=e[t];n.count<i.count&&(n=i)}return n}MergeZombieParticleListNodes(e,i,n){const s=e.GetParticleCount();for(let e=0;e<s;e++){const s=i[e];s!==n&&this.m_flagsBuffer.data[s.index]&t.b2ParticleFlag.b2_zombieParticle&&Zs.MergeParticleListAndNode(n,s)}}static MergeParticleListAndNode(t,e){e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0}CreateParticleGroupsFromParticleList(e,i,n){const s=e.GetParticleCount(),r=new Ds;r.groupFlags=e.GetGroupFlags(),r.userData=e.GetUserData();for(let e=0;e<s;e++){const s=i[e];if(!s.count||s===n)continue;const o=this.CreateParticleGroup(r);for(let e=s;e;e=e.next){const i=e.index,n=this.CloneParticle(i,o);this.m_flagsBuffer.data[i]|=t.b2ParticleFlag.b2_zombieParticle,e.index=n}}}UpdatePairsAndTriadsWithParticleList(t,e){const i=t.GetBufferIndex();for(let n=0;n<this.m_pairBuffer.count;n++){const s=this.m_pairBuffer.data[n],r=s.indexA,o=s.indexB;t.ContainsParticle(r)&&(s.indexA=e[r-i].index),t.ContainsParticle(o)&&(s.indexB=e[o-i].index)}for(let n=0;n<this.m_triadBuffer.count;n++){const s=this.m_triadBuffer.data[n],r=s.indexA,o=s.indexB,a=s.indexC;t.ContainsParticle(r)&&(s.indexA=e[r-i].index),t.ContainsParticle(o)&&(s.indexB=e[o-i].index),t.ContainsParticle(a)&&(s.indexC=e[a-i].index)}}ComputeDepth(){const e=[];let i=0;for(let n=0;n<this.m_contactBuffer.count;n++){const s=this.m_contactBuffer.data[n],r=s.indexA,o=s.indexB,a=this.m_groupBuffer[r],l=this.m_groupBuffer[o];a&&a===l&&a.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&(e[i++]=s)}const s=[];let r=0;for(let e=this.m_groupList;e;e=e.GetNext())if(e.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth){s[r++]=e,this.SetGroupFlags(e,e.m_groupFlags&~t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth);for(let t=e.m_firstIndex;t<e.m_lastIndex;t++)this.m_accumulationBuffer[t]=0}for(let t=0;t<i;t++){const i=e[t],n=i.indexA,s=i.indexB,r=i.weight;this.m_accumulationBuffer[n]+=r,this.m_accumulationBuffer[s]+=r}for(let t=0;t<r;t++){const e=s[t];for(let t=e.m_firstIndex;t<e.m_lastIndex;t++){const e=this.m_accumulationBuffer[t];this.m_depthBuffer[t]=e<.8?0:n}}const o=at(this.m_count)>>0;for(let t=0;t<o;t++){let t=!1;for(let n=0;n<i;n++){const i=e[n],s=i.indexA,r=i.indexB,o=1-i.weight,a=this.m_depthBuffer[s],l=this.m_depthBuffer[r],c=l+o,h=a+o;a>c&&(this.m_depthBuffer[s]=c,t=!0),l>h&&(this.m_depthBuffer[r]=h,t=!0)}if(!t)break}for(let t=0;t<r;t++){const e=s[t];for(let t=e.m_firstIndex;t<e.m_lastIndex;t++)this.m_depthBuffer[t]<n?this.m_depthBuffer[t]*=this.m_particleDiameter:this.m_depthBuffer[t]=0}}GetInsideBoundsEnumerator(t){const e=Zs.computeTag(this.m_inverseDiameter*t.lowerBound.x-1,this.m_inverseDiameter*t.lowerBound.y-1),i=Zs.computeTag(this.m_inverseDiameter*t.upperBound.x+1,this.m_inverseDiameter*t.upperBound.y+1),n=0,s=this.m_proxyBuffer.count,r=Gs(this.m_proxyBuffer.data,n,s,e,tr.CompareProxyTag),o=Hs(this.m_proxyBuffer.data,n,s,i,tr.CompareTagProxy);return new er(this,e,i,r,o)}UpdateAllParticleFlags(){this.m_allParticleFlags=0;for(let t=0;t<this.m_count;t++)this.m_allParticleFlags|=this.m_flagsBuffer.data[t];this.m_needsUpdateAllParticleFlags=!1}UpdateAllGroupFlags(){this.m_allGroupFlags=0;for(let t=this.m_groupList;t;t=t.GetNext())this.m_allGroupFlags|=t.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1}AddContact(t,e,i){const n=this.m_flagsBuffer.data,s=this.m_positionBuffer.data,r=xt.SubVV(s[e],s[t],Zs.AddContact_s_d),o=xt.DotVV(r,r);if(0<o&&o<this.m_squaredDiameter){const i=ot(o),s=this.m_contactBuffer.data[this.m_contactBuffer.Append()];s.indexA=t,s.indexB=e,s.flags=n[t]|n[e],s.weight=1-o*i*this.m_inverseDiameter,s.normal.x=i*r.x,s.normal.y=i*r.y}}FindContacts_Reference(t){const e=0,i=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(let t=e,n=e;t<i;t++){const e=Zs.computeRelativeTag(this.m_proxyBuffer.data[t].tag,1,0);for(let n=t+1;n<i&&!(e<this.m_proxyBuffer.data[n].tag);n++)this.AddContact(this.m_proxyBuffer.data[t].index,this.m_proxyBuffer.data[n].index,this.m_contactBuffer);const s=Zs.computeRelativeTag(this.m_proxyBuffer.data[t].tag,-1,1);for(;n<i&&!(s<=this.m_proxyBuffer.data[n].tag);n++);const r=Zs.computeRelativeTag(this.m_proxyBuffer.data[t].tag,1,1);for(let e=n;e<i&&!(r<this.m_proxyBuffer.data[e].tag);e++)this.AddContact(this.m_proxyBuffer.data[t].index,this.m_proxyBuffer.data[e].index,this.m_contactBuffer)}}FindContacts(t){this.FindContacts_Reference(t)}UpdateProxies_Reference(t){const e=this.m_positionBuffer.data,i=this.m_inverseDiameter;for(let t=0;t<this.m_proxyBuffer.count;++t){const n=this.m_proxyBuffer.data[t],s=e[n.index];n.tag=Zs.computeTag(i*s.x,i*s.y)}}UpdateProxies(t){this.UpdateProxies_Reference(t)}SortProxies(t){zs(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,tr.CompareProxyProxy)}FilterContacts(e){const i=this.GetParticleContactFilter();if(null===i)return;const n=this,s=e=>0!=(e.flags&t.b2ParticleFlag.b2_particleContactFilterParticle)&&!i.ShouldCollideParticleParticle(n,e.indexA,e.indexB);this.m_contactBuffer.RemoveIf(s)}NotifyContactListenerPreContact(t){if(null!==this.GetParticleContactListener())throw t.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error}NotifyContactListenerPostContact(t){const e=this.GetParticleContactListener();if(null!==e){for(let t=0;t<this.m_contactBuffer.count;++t){const i=this.m_contactBuffer.data[t];e.BeginContactParticleParticle(this,i)}throw new Error}}static b2ParticleContactIsZombie(e){return(e.flags&t.b2ParticleFlag.b2_zombieParticle)===t.b2ParticleFlag.b2_zombieParticle}UpdateContacts(t){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);const e=new ar;this.NotifyContactListenerPreContact(e),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(e),t&&this.m_contactBuffer.RemoveIf(Zs.b2ParticleContactIsZombie)}NotifyBodyContactListenerPreContact(t){if(null!==this.GetFixtureContactListener())throw t.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error}NotifyBodyContactListenerPostContact(t){const e=this.GetFixtureContactListener();if(null!==e){for(let t=0;t<this.m_bodyContactBuffer.count;t++){const i=this.m_bodyContactBuffer.data[t];e.BeginContactFixtureParticle(this,i)}throw new Error}}UpdateBodyContacts(){const t=Zs.UpdateBodyContacts_s_aabb,e=new rr;if(this.NotifyBodyContactListenerPreContact(e),this.m_stuckThreshold>0){const t=this.GetParticleCount();for(let e=0;e<t;e++)this.m_bodyContactCountBuffer.data[e]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[e]+1&&(this.m_consecutiveContactStepsBuffer.data[e]=0)}this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);const i=t;this.ComputeAABB(i),null===this.UpdateBodyContacts_callback&&(this.UpdateBodyContacts_callback=new mr(this));const n=this.UpdateBodyContacts_callback;n.m_contactFilter=this.GetFixtureContactFilter(),this.m_world.QueryAABB(n,i),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(e)}Solve(e){const i=Zs.Solve_s_subStep;if(0!==this.m_count&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(e),this.m_allParticleFlags&t.b2ParticleFlag.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<e.particleIterations;this.m_iterationIndex++){++this.m_timestamp;const n=i.Copy(e);n.dt/=e.particleIterations,n.inv_dt*=e.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&t.b2ParticleFlag.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&t.b2ParticleFlag.b2_repulsiveParticle&&this.SolveRepulsive(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_powderParticle&&this.SolvePowder(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_tensileParticle&&this.SolveTensile(n),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SolveSolid(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle&&this.SolveStaticPressure(n),this.SolvePressure(n),this.SolveDamping(n),this.m_allParticleFlags&Zs.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_elasticParticle&&this.SolveElastic(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_springParticle&&this.SolveSpring(n),this.LimitVelocity(n),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_barrierParticle&&this.SolveBarrier(n),this.SolveCollision(n),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigid(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_wallParticle&&this.SolveWall();for(let t=0;t<this.m_count;t++)this.m_positionBuffer.data[t].SelfMulAdd(n.dt,this.m_velocityBuffer.data[t])}}SolveCollision(t){const e=Zs.SolveCollision_s_aabb,i=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=e;r.lowerBound.x=+n,r.lowerBound.y=+n,r.upperBound.x=-n,r.upperBound.y=-n;for(let e=0;e<this.m_count;e++){const n=s[e],o=i[e],a=o.x+t.dt*n.x,l=o.y+t.dt*n.y;r.lowerBound.x=tt(r.lowerBound.x,tt(o.x,a)),r.lowerBound.y=tt(r.lowerBound.y,tt(o.y,l)),r.upperBound.x=et(r.upperBound.x,et(o.x,a)),r.upperBound.y=et(r.upperBound.y,et(o.y,l))}null===this.SolveCollision_callback&&(this.SolveCollision_callback=new dr(this,t));const o=this.SolveCollision_callback;o.m_step=t,this.m_world.QueryAABB(o,r)}LimitVelocity(t){const e=this.m_velocityBuffer.data,i=this.GetCriticalVelocitySquared(t);for(let t=0;t<this.m_count;t++){const n=e[t],s=xt.DotVV(n,n);s>i&&n.SelfMul(at(i/s))}}SolveGravity(t){const e=Zs.SolveGravity_s_gravity,i=this.m_velocityBuffer.data,n=xt.MulSV(t.dt*this.m_def.gravityScale,this.m_world.GetGravity(),e);for(let t=0;t<this.m_count;t++)i[t].SelfAdd(n)}SolveBarrier(e){const i=Zs.SolveBarrier_s_aabb,n=Zs.SolveBarrier_s_va,s=Zs.SolveBarrier_s_vb,r=Zs.SolveBarrier_s_pba,o=Zs.SolveBarrier_s_vba,a=Zs.SolveBarrier_s_vc,l=Zs.SolveBarrier_s_pca,c=Zs.SolveBarrier_s_vca,h=Zs.SolveBarrier_s_qba,_=Zs.SolveBarrier_s_qca,u=Zs.SolveBarrier_s_dv,m=Zs.SolveBarrier_s_f,d=this.m_positionBuffer.data,p=this.m_velocityBuffer.data;for(let t=0;t<this.m_count;t++)0!=(this.m_flagsBuffer.data[t]&Zs.k_barrierWallFlags)&&p[t].SetZero();const f=O*e.dt,g=this.GetParticleMass();for(let y=0;y<this.m_pairBuffer.count;y++){const v=this.m_pairBuffer.data[y];if(v.flags&t.b2ParticleFlag.b2_barrierParticle){const t=v.indexA,y=v.indexB,x=d[t],S=d[y],A=i;xt.MinV(x,S,A.lowerBound),xt.MaxV(x,S,A.upperBound);const C=this.m_groupBuffer[t],b=this.m_groupBuffer[y],T=this.GetLinearVelocity(C,t,x,n),w=this.GetLinearVelocity(b,y,S,s),E=xt.SubVV(S,x,r),P=xt.SubVV(w,T,o),I=this.GetInsideBoundsEnumerator(A);let D;for(;(D=I.GetNext())>=0;){const t=d[D],i=this.m_groupBuffer[D];if(C!==i&&b!==i){const n=this.GetLinearVelocity(i,D,t,a),s=xt.SubVV(t,x,l),r=xt.SubVV(n,T,c),o=xt.CrossVV(P,r),d=xt.CrossVV(E,r)-xt.CrossVV(s,P),y=xt.CrossVV(E,s);let v,S;const A=h,C=_;if(0===o){if(0===d)continue;if(S=-y/d,!(S>=0&&S<f))continue;if(xt.AddVMulSV(E,S,P,A),xt.AddVMulSV(s,S,r,C),v=xt.DotVV(A,C)/xt.DotVV(A,A),!(v>=0&&v<=1))continue}else{const t=d*d-4*y*o;if(t<0)continue;const e=at(t);let i=(-d-e)/(2*o),n=(-d+e)/(2*o);if(i>n){const t=i;i=n,n=t}if(S=i,xt.AddVMulSV(E,S,P,A),xt.AddVMulSV(s,S,r,C),v=xt.DotVV(A,C)/xt.DotVV(A,A),!(S>=0&&S<f&&v>=0&&v<=1)){if(S=n,!(S>=0&&S<f))continue;if(xt.AddVMulSV(E,S,P,A),xt.AddVMulSV(s,S,r,C),v=xt.DotVV(A,C)/xt.DotVV(A,A),!(v>=0&&v<=1))continue}}const b=u;b.x=T.x+v*P.x-n.x,b.y=T.y+v*P.y-n.y;const w=xt.MulSV(g,b,m);if(i&&this.IsRigidGroup(i)){const e=i.GetMass(),n=i.GetInertia();e>0&&i.m_linearVelocity.SelfMulAdd(1/e,w),n>0&&(i.m_angularVelocity+=xt.CrossVV(xt.SubVV(t,i.GetCenter(),xt.s_t0),w)/n)}else p[D].SelfAdd(b);this.ParticleApplyForce(D,w.SelfMul(-e.inv_dt))}}}}}SolveStaticPressure(e){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);const i=this.GetCriticalPressure(e),n=this.m_def.staticPressureStrength*i,s=I*i,r=this.m_def.staticPressureRelaxation;for(let e=0;e<this.m_def.staticPressureIterations;e++){for(let t=0;t<this.m_count;t++)this.m_accumulationBuffer[t]=0;for(let e=0;e<this.m_contactBuffer.count;e++){const i=this.m_contactBuffer.data[e];if(i.flags&t.b2ParticleFlag.b2_staticPressureParticle){const t=i.indexA,e=i.indexB,n=i.weight;this.m_accumulationBuffer[t]+=n*this.m_staticPressureBuffer[e],this.m_accumulationBuffer[e]+=n*this.m_staticPressureBuffer[t]}}for(let e=0;e<this.m_count;e++){const i=this.m_weightBuffer[e];if(this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_staticPressureParticle){const t=(this.m_accumulationBuffer[e]+n*(i-P))/(i+r);this.m_staticPressureBuffer[e]=it(t,0,s)}else this.m_staticPressureBuffer[e]=0}}}ComputeWeight(){for(let t=0;t<this.m_count;t++)this.m_weightBuffer[t]=0;for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t],i=e.index,n=e.weight;this.m_weightBuffer[i]+=n}for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t],i=e.indexA,n=e.indexB,s=e.weight;this.m_weightBuffer[i]+=s,this.m_weightBuffer[n]+=s}}SolvePressure(e){const i=Zs.SolvePressure_s_f,n=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.GetCriticalPressure(e),o=this.m_def.pressureStrength*r,a=I*r;for(let t=0;t<this.m_count;t++){const e=o*et(0,this.m_weightBuffer[t]-P);this.m_accumulationBuffer[t]=tt(e,a)}if(this.m_allParticleFlags&Zs.k_noPressureFlags)for(let t=0;t<this.m_count;t++)this.m_flagsBuffer.data[t]&Zs.k_noPressureFlags&&(this.m_accumulationBuffer[t]=0);if(this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle)for(let e=0;e<this.m_count;e++)this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_staticPressureParticle&&(this.m_accumulationBuffer[e]+=this.m_staticPressureBuffer[e]);const l=e.dt/(this.m_def.density*this.m_particleDiameter),c=this.GetParticleInvMass();for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t],r=e.index,a=e.body,h=e.weight,_=e.mass,u=e.normal,m=n[r],d=this.m_accumulationBuffer[r]+o*h,p=xt.MulSV(l*h*_*d,u,i);s[r].SelfMulSub(c,p),a.ApplyLinearImpulse(p,m,!0)}for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t],n=e.indexA,r=e.indexB,o=e.weight,a=e.normal,c=this.m_accumulationBuffer[n]+this.m_accumulationBuffer[r],h=xt.MulSV(l*o*c,a,i);s[n].SelfSub(h),s[r].SelfAdd(h)}}SolveDamping(t){const e=Zs.SolveDamping_s_v,i=Zs.SolveDamping_s_f,n=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.m_def.dampingStrength,o=1/this.GetCriticalVelocity(t),a=this.GetParticleInvMass();for(let t=0;t<this.m_bodyContactBuffer.count;t++){const l=this.m_bodyContactBuffer.data[t],c=l.index,h=l.body,_=l.weight,u=l.mass,m=l.normal,d=n[c],p=xt.SubVV(h.GetLinearVelocityFromWorldPoint(d,xt.s_t0),s[c],e),f=xt.DotVV(p,m);if(f<0){const t=et(r*_,tt(-o*f,.5)),e=xt.MulSV(t*u*f,m,i);s[c].SelfMulAdd(a,e),h.ApplyLinearImpulse(e.SelfNeg(),d,!0)}}for(let t=0;t<this.m_contactBuffer.count;t++){const n=this.m_contactBuffer.data[t],a=n.indexA,l=n.indexB,c=n.weight,h=n.normal,_=xt.SubVV(s[l],s[a],e),u=xt.DotVV(_,h);if(u<0){const t=et(r*c,tt(-o*u,.5)),e=xt.MulSV(t*u,h,i);s[a].SelfAdd(e),s[l].SelfSub(e)}}}SolveRigidDamping(){const t=Zs.SolveRigidDamping_s_t0,e=Zs.SolveRigidDamping_s_t1,i=Zs.SolveRigidDamping_s_p,n=Zs.SolveRigidDamping_s_v,s=[0],r=[0],o=[0],a=[0],l=[0],c=[0],h=this.m_positionBuffer.data,_=this.m_def.dampingStrength;for(let i=0;i<this.m_bodyContactBuffer.count;i++){const u=this.m_bodyContactBuffer.data[i],m=u.index,d=this.m_groupBuffer[m];if(d&&this.IsRigidGroup(d)){const i=u.body,p=u.normal,f=u.weight,g=h[m],y=xt.SubVV(i.GetLinearVelocityFromWorldPoint(g,t),d.GetLinearVelocityFromWorldPoint(g,e),n),v=xt.DotVV(y,p);if(v<0){this.InitDampingParameterWithRigidGroupOrParticle(s,r,o,!0,d,m,g,p),this.InitDampingParameter(a,l,c,i.GetMass(),i.GetInertia()-i.GetMass()*i.GetLocalCenter().LengthSquared(),i.GetWorldCenter(),g,p);const t=_*tt(f,1)*this.ComputeDampingImpulse(s[0],r[0],o[0],a[0],l[0],c[0],v);this.ApplyDamping(s[0],r[0],o[0],!0,d,m,t,p),i.ApplyLinearImpulse(xt.MulSV(-t,p,xt.s_t0),g,!0)}}}for(let u=0;u<this.m_contactBuffer.count;u++){const m=this.m_contactBuffer.data[u],d=m.indexA,p=m.indexB,f=m.normal,g=m.weight,y=this.m_groupBuffer[d],v=this.m_groupBuffer[p],x=this.IsRigidGroup(y),S=this.IsRigidGroup(v);if(y!==v&&(x||S)){const u=xt.MidVV(h[d],h[p],i),m=xt.SubVV(this.GetLinearVelocity(v,p,u,t),this.GetLinearVelocity(y,d,u,e),n),A=xt.DotVV(m,f);if(A<0){this.InitDampingParameterWithRigidGroupOrParticle(s,r,o,x,y,d,u,f),this.InitDampingParameterWithRigidGroupOrParticle(a,l,c,S,v,p,u,f);const t=_*g*this.ComputeDampingImpulse(s[0],r[0],o[0],a[0],l[0],c[0],A);this.ApplyDamping(s[0],r[0],o[0],x,y,d,t,f),this.ApplyDamping(a[0],l[0],c[0],S,v,p,-t,f)}}}}SolveExtraDamping(){const t=Zs.SolveExtraDamping_s_v,e=Zs.SolveExtraDamping_s_f,i=this.m_velocityBuffer.data,n=this.m_positionBuffer.data,s=this.GetParticleInvMass();for(let r=0;r<this.m_bodyContactBuffer.count;r++){const o=this.m_bodyContactBuffer.data[r],a=o.index;if(this.m_flagsBuffer.data[a]&Zs.k_extraDampingFlags){const r=o.body,l=o.mass,c=o.normal,h=n[a],_=xt.SubVV(r.GetLinearVelocityFromWorldPoint(h,xt.s_t0),i[a],t),u=xt.DotVV(_,c);if(u<0){const t=xt.MulSV(.5*l*u,c,e);i[a].SelfMulAdd(s,t),r.ApplyLinearImpulse(t.SelfNeg(),h,!0)}}}}SolveWall(){const e=this.m_velocityBuffer.data;for(let i=0;i<this.m_count;i++)this.m_flagsBuffer.data[i]&t.b2ParticleFlag.b2_wallParticle&&e[i].SetZero()}SolveRigid(e){const i=Zs.SolveRigid_s_position,n=Zs.SolveRigid_s_rotation,s=Zs.SolveRigid_s_transform,r=Zs.SolveRigid_s_velocityTransform,o=this.m_positionBuffer.data,a=this.m_velocityBuffer.data;for(let l=this.m_groupList;l;l=l.GetNext())if(l.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup){l.UpdateStatistics();const t=n;t.SetAngle(e.dt*l.m_angularVelocity);const c=xt.AddVV(l.m_center,xt.SubVV(xt.MulSV(e.dt,l.m_linearVelocity,xt.s_t0),Tt.MulRV(t,l.m_center,xt.s_t1),xt.s_t0),i),h=s;h.SetPositionRotation(c,t),wt.MulXX(h,l.m_transform,l.m_transform);const _=r;_.p.x=e.inv_dt*h.p.x,_.p.y=e.inv_dt*h.p.y,_.q.s=e.inv_dt*h.q.s,_.q.c=e.inv_dt*(h.q.c-1);for(let t=l.m_firstIndex;t<l.m_lastIndex;t++)wt.MulXV(_,o[t],a[t])}}SolveElastic(e){const i=Zs.SolveElastic_s_pa,n=Zs.SolveElastic_s_pb,s=Zs.SolveElastic_s_pc,r=Zs.SolveElastic_s_r,o=Zs.SolveElastic_s_t0,a=this.m_positionBuffer.data,l=this.m_velocityBuffer.data,c=e.inv_dt*this.m_def.elasticStrength;for(let h=0;h<this.m_triadBuffer.count;h++){const _=this.m_triadBuffer.data[h];if(_.flags&t.b2ParticleFlag.b2_elasticParticle){const t=_.indexA,h=_.indexB,u=_.indexC,m=_.pa,d=_.pb,p=_.pc,f=i.Copy(a[t]),g=n.Copy(a[h]),y=s.Copy(a[u]),v=l[t],x=l[h],S=l[u];f.SelfMulAdd(e.dt,v),g.SelfMulAdd(e.dt,x),y.SelfMulAdd(e.dt,S);const A=(f.x+g.x+y.x)/3,C=(f.y+g.y+y.y)/3;f.x-=A,f.y-=C,g.x-=A,g.y-=C,y.x-=A,y.y-=C;const b=r;b.s=xt.CrossVV(m,f)+xt.CrossVV(d,g)+xt.CrossVV(p,y),b.c=xt.DotVV(m,f)+xt.DotVV(d,g)+xt.DotVV(p,y);let T=ot(b.s*b.s+b.c*b.c);isFinite(T)||(T=198177537e11),b.s*=T,b.c*=T;const w=c*_.strength;Tt.MulRV(b,m,o),xt.SubVV(o,f,o),xt.MulSV(w,o,o),v.SelfAdd(o),Tt.MulRV(b,d,o),xt.SubVV(o,g,o),xt.MulSV(w,o,o),x.SelfAdd(o),Tt.MulRV(b,p,o),xt.SubVV(o,y,o),xt.MulSV(w,o,o),S.SelfAdd(o)}}}SolveSpring(e){const i=Zs.SolveSpring_s_pa,n=Zs.SolveSpring_s_pb,s=Zs.SolveSpring_s_d,r=Zs.SolveSpring_s_f,o=this.m_positionBuffer.data,a=this.m_velocityBuffer.data,l=e.inv_dt*this.m_def.springStrength;for(let c=0;c<this.m_pairBuffer.count;c++){const h=this.m_pairBuffer.data[c];if(h.flags&t.b2ParticleFlag.b2_springParticle){const t=h.indexA,c=h.indexB,_=i.Copy(o[t]),u=n.Copy(o[c]),m=a[t],d=a[c];_.SelfMulAdd(e.dt,m),u.SelfMulAdd(e.dt,d);const p=xt.SubVV(u,_,s),f=h.distance,g=p.Length(),y=l*h.strength,v=xt.MulSV(y*(f-g)/g,p,r);m.SelfSub(v),d.SelfAdd(v)}}}SolveTensile(e){const i=Zs.SolveTensile_s_weightedNormal,n=Zs.SolveTensile_s_s,s=Zs.SolveTensile_s_f,r=this.m_velocityBuffer.data;for(let t=0;t<this.m_count;t++)this.m_accumulation2Buffer[t]=new xt,this.m_accumulation2Buffer[t].SetZero();for(let e=0;e<this.m_contactBuffer.count;e++){const n=this.m_contactBuffer.data[e];if(n.flags&t.b2ParticleFlag.b2_tensileParticle){const t=n.indexA,e=n.indexB,s=n.weight,r=n.normal,o=xt.MulSV((1-s)*s,r,i);this.m_accumulation2Buffer[t].SelfSub(o),this.m_accumulation2Buffer[e].SelfAdd(o)}}const o=this.GetCriticalVelocity(e),a=this.m_def.surfaceTensionPressureStrength*o,l=this.m_def.surfaceTensionNormalStrength*o,c=D*o;for(let e=0;e<this.m_contactBuffer.count;e++){const i=this.m_contactBuffer.data[e];if(i.flags&t.b2ParticleFlag.b2_tensileParticle){const t=i.indexA,e=i.indexB,o=i.weight,h=i.normal,_=this.m_weightBuffer[t]+this.m_weightBuffer[e],u=xt.SubVV(this.m_accumulation2Buffer[e],this.m_accumulation2Buffer[t],n),m=tt(a*(_-2)+l*xt.DotVV(u,h),c)*o,d=xt.MulSV(m,h,s);r[t].SelfSub(d),r[e].SelfAdd(d)}}}SolveViscous(){const e=Zs.SolveViscous_s_v,i=Zs.SolveViscous_s_f,n=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.m_def.viscousStrength,o=this.GetParticleInvMass();for(let a=0;a<this.m_bodyContactBuffer.count;a++){const l=this.m_bodyContactBuffer.data[a],c=l.index;if(this.m_flagsBuffer.data[c]&t.b2ParticleFlag.b2_viscousParticle){const t=l.body,a=l.weight,h=l.mass,_=n[c],u=xt.SubVV(t.GetLinearVelocityFromWorldPoint(_,xt.s_t0),s[c],e),m=xt.MulSV(r*h*a,u,i);s[c].SelfMulAdd(o,m),t.ApplyLinearImpulse(m.SelfNeg(),_,!0)}}for(let n=0;n<this.m_contactBuffer.count;n++){const o=this.m_contactBuffer.data[n];if(o.flags&t.b2ParticleFlag.b2_viscousParticle){const t=o.indexA,n=o.indexB,a=o.weight,l=xt.SubVV(s[n],s[t],e),c=xt.MulSV(r*a,l,i);s[t].SelfAdd(c),s[n].SelfSub(c)}}}SolveRepulsive(e){const i=Zs.SolveRepulsive_s_f,n=this.m_velocityBuffer.data,s=this.m_def.repulsiveStrength*this.GetCriticalVelocity(e);for(let e=0;e<this.m_contactBuffer.count;e++){const r=this.m_contactBuffer.data[e];if(r.flags&t.b2ParticleFlag.b2_repulsiveParticle){const t=r.indexA,e=r.indexB;if(this.m_groupBuffer[t]!==this.m_groupBuffer[e]){const o=r.weight,a=r.normal,l=xt.MulSV(s*o,a,i);n[t].SelfSub(l),n[e].SelfAdd(l)}}}}SolvePowder(e){const i=Zs.SolvePowder_s_f,n=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.m_def.powderStrength*this.GetCriticalVelocity(e),o=1-E,a=this.GetParticleInvMass();for(let e=0;e<this.m_bodyContactBuffer.count;e++){const l=this.m_bodyContactBuffer.data[e],c=l.index;if(this.m_flagsBuffer.data[c]&t.b2ParticleFlag.b2_powderParticle){const t=l.weight;if(t>o){const e=l.body,h=l.mass,_=n[c],u=l.normal,m=xt.MulSV(r*h*(t-o),u,i);s[c].SelfMulSub(a,m),e.ApplyLinearImpulse(m,_,!0)}}}for(let e=0;e<this.m_contactBuffer.count;e++){const n=this.m_contactBuffer.data[e];if(n.flags&t.b2ParticleFlag.b2_powderParticle){const t=n.weight;if(t>o){const e=n.indexA,a=n.indexB,l=n.normal,c=xt.MulSV(r*(t-o),l,i);s[e].SelfSub(c),s[a].SelfAdd(c)}}}}SolveSolid(t){const e=Zs.SolveSolid_s_f,i=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);const n=t.inv_dt*this.m_def.ejectionStrength;for(let t=0;t<this.m_contactBuffer.count;t++){const s=this.m_contactBuffer.data[t],r=s.indexA,o=s.indexB;if(this.m_groupBuffer[r]!==this.m_groupBuffer[o]){const t=s.weight,a=s.normal,l=this.m_depthBuffer[r]+this.m_depthBuffer[o],c=xt.MulSV(n*l*t,a,e);i[r].SelfSub(c),i[o].SelfAdd(c)}}}SolveForce(t){const e=this.m_velocityBuffer.data,i=t.dt*this.GetParticleInvMass();for(let t=0;t<this.m_count;t++)e[t].SelfMulAdd(i,this.m_forceBuffer[t]);this.m_hasForce=!1}SolveColorMixing(){const e=.5*this.m_def.colorMixingStrength;if(e)for(let i=0;i<this.m_contactBuffer.count;i++){const n=this.m_contactBuffer.data[i],s=n.indexA,r=n.indexB;if(this.m_flagsBuffer.data[s]&this.m_flagsBuffer.data[r]&t.b2ParticleFlag.b2_colorMixingParticle){const t=this.m_colorBuffer.data[s],i=this.m_colorBuffer.data[r];Pt.MixColors(t,i,e)}}}SolveZombie(){let e=0;const i=[];for(let t=0;t<this.m_count;t++)i[t]=T;let n=0;for(let s=0;s<this.m_count;s++){const r=this.m_flagsBuffer.data[s];if(r&t.b2ParticleFlag.b2_zombieParticle){const e=this.m_world.m_destructionListener;if(r&t.b2ParticleFlag.b2_destructionListenerParticle&&e&&e.SayGoodbyeParticle(this,s),this.m_handleIndexBuffer.data){const t=this.m_handleIndexBuffer.data[s];t&&(t.SetIndex(T),this.m_handleIndexBuffer.data[s]=null)}i[s]=T}else{if(i[s]=e,s!==e){if(this.m_handleIndexBuffer.data){const t=this.m_handleIndexBuffer.data[s];t&&t.SetIndex(e),this.m_handleIndexBuffer.data[e]=t}this.m_flagsBuffer.data[e]=this.m_flagsBuffer.data[s],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=this.m_lastBodyContactStepBuffer.data[s]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=this.m_bodyContactCountBuffer.data[s]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=this.m_consecutiveContactStepsBuffer.data[s]),this.m_positionBuffer.data[e].Copy(this.m_positionBuffer.data[s]),this.m_velocityBuffer.data[e].Copy(this.m_velocityBuffer.data[s]),this.m_groupBuffer[e]=this.m_groupBuffer[s],this.m_hasForce&&this.m_forceBuffer[e].Copy(this.m_forceBuffer[s]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=this.m_staticPressureBuffer[s]),this.m_depthBuffer&&(this.m_depthBuffer[e]=this.m_depthBuffer[s]),this.m_colorBuffer.data&&this.m_colorBuffer.data[e].Copy(this.m_colorBuffer.data[s]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[e]=this.m_userDataBuffer.data[s]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[e]=this.m_expirationTimeBuffer.data[s])}e++,n|=r}}const s={IsProxyInvalid:t=>t.index<0,IsContactInvalid:t=>t.indexA<0||t.indexB<0,IsBodyContactInvalid:t=>t.index<0,IsPairInvalid:t=>t.indexA<0||t.indexB<0,IsTriadInvalid:t=>t.indexA<0||t.indexB<0||t.indexC<0};for(let t=0;t<this.m_proxyBuffer.count;t++){const e=this.m_proxyBuffer.data[t];e.index=i[e.index]}this.m_proxyBuffer.RemoveIf(s.IsProxyInvalid);for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t];e.indexA=i[e.indexA],e.indexB=i[e.indexB]}this.m_contactBuffer.RemoveIf(s.IsContactInvalid);for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t];e.index=i[e.index]}this.m_bodyContactBuffer.RemoveIf(s.IsBodyContactInvalid);for(let t=0;t<this.m_pairBuffer.count;t++){const e=this.m_pairBuffer.data[t];e.indexA=i[e.indexA],e.indexB=i[e.indexB]}this.m_pairBuffer.RemoveIf(s.IsPairInvalid);for(let t=0;t<this.m_triadBuffer.count;t++){const e=this.m_triadBuffer.data[t];e.indexA=i[e.indexA],e.indexB=i[e.indexB],e.indexC=i[e.indexC]}if(this.m_triadBuffer.RemoveIf(s.IsTriadInvalid),this.m_indexByExpirationTimeBuffer.data){let t=0;for(let e=0;e<this.m_count;e++){const n=i[this.m_indexByExpirationTimeBuffer.data[e]];n!==T&&(this.m_indexByExpirationTimeBuffer.data[t++]=n)}}for(let n=this.m_groupList;n;n=n.GetNext()){let s=e,r=0,o=!1;for(let t=n.m_firstIndex;t<n.m_lastIndex;t++){const e=i[t];e>=0?(s=tt(s,e),r=et(r,e+1)):o=!0}s<r?(n.m_firstIndex=s,n.m_lastIndex=r,o&&n.m_groupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SetGroupFlags(n,n.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth)):(n.m_firstIndex=0,n.m_lastIndex=0,n.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupCanBeEmpty||this.SetGroupFlags(n,n.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed))}this.m_count=e,this.m_allParticleFlags=n,this.m_needsUpdateAllParticleFlags=!1;for(let e=this.m_groupList;e;){const i=e.GetNext();e.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(e),e=i}}SolveLifetimes(t){this.m_timeElapsed=this.LifetimeToExpirationTime(t.dt);const e=this.GetQuantizedTimeElapsed(),i=this.m_expirationTimeBuffer.data,n=this.m_indexByExpirationTimeBuffer.data,s=this.GetParticleCount();this.m_expirationTimeBufferRequiresSorting&&(zs(n,0,s,((t,e)=>{const n=i[t],s=i[e],r=n<=0;return r===s<=0?n>s:r})),this.m_expirationTimeBufferRequiresSorting=!1);for(let t=s-1;t>=0;--t){const s=n[t],r=i[s];if(e<r||r<=0)break;this.DestroyParticle(s)}}RotateBuffer(t,e,i){if(t!==e&&e!==i){if(ks(this.m_flagsBuffer.data,t,e,i),this.m_lastBodyContactStepBuffer.data&&ks(this.m_lastBodyContactStepBuffer.data,t,e,i),this.m_bodyContactCountBuffer.data&&ks(this.m_bodyContactCountBuffer.data,t,e,i),this.m_consecutiveContactStepsBuffer.data&&ks(this.m_consecutiveContactStepsBuffer.data,t,e,i),ks(this.m_positionBuffer.data,t,e,i),ks(this.m_velocityBuffer.data,t,e,i),ks(this.m_groupBuffer,t,e,i),this.m_hasForce&&ks(this.m_forceBuffer,t,e,i),this.m_staticPressureBuffer&&ks(this.m_staticPressureBuffer,t,e,i),this.m_depthBuffer&&ks(this.m_depthBuffer,t,e,i),this.m_colorBuffer.data&&ks(this.m_colorBuffer.data,t,e,i),this.m_userDataBuffer.data&&ks(this.m_userDataBuffer.data,t,e,i),this.m_handleIndexBuffer.data){ks(this.m_handleIndexBuffer.data,t,e,i);for(let e=t;e<i;++e){const t=this.m_handleIndexBuffer.data[e];t&&t.SetIndex(n(t.GetIndex()))}}if(this.m_expirationTimeBuffer.data){ks(this.m_expirationTimeBuffer.data,t,e,i);const s=this.GetParticleCount(),r=this.m_indexByExpirationTimeBuffer.data;for(let t=0;t<s;++t)r[t]=n(r[t])}for(let t=0;t<this.m_proxyBuffer.count;t++){const e=this.m_proxyBuffer.data[t];e.index=n(e.index)}for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t];e.indexA=n(e.indexA),e.indexB=n(e.indexB)}for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t];e.index=n(e.index)}for(let t=0;t<this.m_pairBuffer.count;t++){const e=this.m_pairBuffer.data[t];e.indexA=n(e.indexA),e.indexB=n(e.indexB)}for(let t=0;t<this.m_triadBuffer.count;t++){const e=this.m_triadBuffer.data[t];e.indexA=n(e.indexA),e.indexB=n(e.indexB),e.indexC=n(e.indexC)}for(let t=this.m_groupList;t;t=t.GetNext())t.m_firstIndex=n(t.m_firstIndex),t.m_lastIndex=n(t.m_lastIndex-1)+1}function n(n){return n<t?n:n<e?n+i-e:n<i?n+t-e:n}}GetCriticalVelocity(t){return this.m_particleDiameter*t.inv_dt}GetCriticalVelocitySquared(t){const e=this.GetCriticalVelocity(t);return e*e}GetCriticalPressure(t){return this.m_def.density*this.GetCriticalVelocitySquared(t)}GetParticleStride(){return E*this.m_particleDiameter}GetParticleMass(){const t=this.GetParticleStride();return this.m_def.density*t*t}GetParticleInvMass(){const t=this.m_inverseDiameter*(1/E);return this.m_inverseDensity*t*t}GetFixtureContactFilter(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}GetParticleContactFilter(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}GetFixtureContactListener(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}GetParticleContactListener(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}SetUserOverridableBuffer(t,e){t.data=e,t.userSuppliedCapacity=e.length}SetGroupFlags(e,i){const n=e.m_groupFlags;(n^i)&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(i|=t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth),n&~i&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&i&&(i&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=i),e.m_groupFlags=i}static BodyContactCompare(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index}RemoveSpuriousBodyContacts(){zs(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,Zs.BodyContactCompare);const t=Zs.RemoveSpuriousBodyContacts_s_n,e=Zs.RemoveSpuriousBodyContacts_s_pos,i=Zs.RemoveSpuriousBodyContacts_s_normal,n=3,s=this;let r=-1,o=0;const a=a=>{if(a.index!==r&&(o=0,r=a.index),o++>n)return!0;const l=t.Copy(a.normal);l.SelfMul(s.m_particleDiameter*(1-a.weight));const c=xt.AddVV(s.m_positionBuffer.data[a.index],l,e);if(!a.fixture.TestPoint(c)){const t=a.fixture.GetShape().GetChildCount();for(let e=0;e<t;e++){const t=i;if(a.fixture.ComputeDistance(c,t,e)<_)return!1}return!0}return!1};this.m_bodyContactBuffer.count=Us(this.m_bodyContactBuffer.data,a,this.m_bodyContactBuffer.count)}DetectStuckParticle(t){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[t],2===this.m_bodyContactCountBuffer.data[t]&&(++this.m_consecutiveContactStepsBuffer.data[t],this.m_consecutiveContactStepsBuffer.data[t]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=t)),this.m_lastBodyContactStepBuffer.data[t]=this.m_timestamp)}ValidateParticleIndex(t){return t>=0&&t<this.GetParticleCount()&&t!==T}GetQuantizedTimeElapsed(){return Math.floor(this.m_timeElapsed/4294967296)}LifetimeToExpirationTime(t){return this.m_timeElapsed+Math.floor(t/this.m_def.lifetimeGranularity*4294967296)}ForceCanBeApplied(e){return!(e&t.b2ParticleFlag.b2_wallParticle)}PrepareForceBuffer(){if(!this.m_hasForce){for(let t=0;t<this.m_count;t++)this.m_forceBuffer[t].SetZero();this.m_hasForce=!0}}IsRigidGroup(e){return null!==e&&0!=(e.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup)}GetLinearVelocity(t,e,i,n){return t&&this.IsRigidGroup(t)?t.GetLinearVelocityFromWorldPoint(i,n):n.Copy(this.m_velocityBuffer.data[e])}InitDampingParameter(t,e,i,n,s,r,o,a){t[0]=n>0?1/n:0,e[0]=s>0?1/s:0,i[0]=xt.CrossVV(xt.SubVV(o,r,xt.s_t0),a)}InitDampingParameterWithRigidGroupOrParticle(e,i,n,s,r,o,a,l){if(r&&s)this.InitDampingParameter(e,i,n,r.GetMass(),r.GetInertia(),r.GetCenter(),a,l);else{const s=this.m_flagsBuffer.data[o];this.InitDampingParameter(e,i,n,s&t.b2ParticleFlag.b2_wallParticle?0:this.GetParticleMass(),0,a,a,l)}}ComputeDampingImpulse(t,e,i,n,s,r,o){const a=t+e*i*i+n+s*r*r;return a>0?o/a:0}ApplyDamping(t,e,i,n,s,r,o,a){s&&n?(s.m_linearVelocity.SelfMulAdd(o*t,a),s.m_angularVelocity+=o*i*e):this.m_velocityBuffer.data[r].SelfMulAdd(o*t,a)}}Zs.xTruncBits=12,Zs.yTruncBits=12,Zs.tagBits=32,Zs.yOffset=1<<Zs.yTruncBits-1,Zs.yShift=Zs.tagBits-Zs.yTruncBits,Zs.xShift=Zs.tagBits-Zs.yTruncBits-Zs.xTruncBits,Zs.xScale=1<<Zs.xShift,Zs.xOffset=Zs.xScale*(1<<Zs.xTruncBits-1),Zs.yMask=(1<<Zs.yTruncBits)-1<<Zs.yShift,Zs.xMask=~Zs.yMask,Zs.DestroyParticlesInShape_s_aabb=new Se,Zs.CreateParticleGroup_s_transform=new wt,Zs.ComputeCollisionEnergy_s_v=new xt,Zs.QueryShapeAABB_s_aabb=new Se,Zs.QueryPointAABB_s_aabb=new Se,Zs.RayCast_s_aabb=new Se,Zs.RayCast_s_p=new xt,Zs.RayCast_s_v=new xt,Zs.RayCast_s_n=new xt,Zs.RayCast_s_point=new xt,Zs.k_pairFlags=t.b2ParticleFlag.b2_springParticle,Zs.k_triadFlags=t.b2ParticleFlag.b2_elasticParticle,Zs.k_noPressureFlags=t.b2ParticleFlag.b2_powderParticle|t.b2ParticleFlag.b2_tensileParticle,Zs.k_extraDampingFlags=t.b2ParticleFlag.b2_staticPressureParticle,Zs.k_barrierWallFlags=t.b2ParticleFlag.b2_barrierParticle|t.b2ParticleFlag.b2_wallParticle,Zs.CreateParticlesStrokeShapeForGroup_s_edge=new cn,Zs.CreateParticlesStrokeShapeForGroup_s_d=new xt,Zs.CreateParticlesStrokeShapeForGroup_s_p=new xt,Zs.CreateParticlesFillShapeForGroup_s_aabb=new Se,Zs.CreateParticlesFillShapeForGroup_s_p=new xt,Zs.UpdatePairsAndTriads_s_dab=new xt,Zs.UpdatePairsAndTriads_s_dbc=new xt,Zs.UpdatePairsAndTriads_s_dca=new xt,Zs.AddContact_s_d=new xt,Zs.UpdateBodyContacts_s_aabb=new Se,Zs.Solve_s_subStep=new ms,Zs.SolveCollision_s_aabb=new Se,Zs.SolveGravity_s_gravity=new xt,Zs.SolveBarrier_s_aabb=new Se,Zs.SolveBarrier_s_va=new xt,Zs.SolveBarrier_s_vb=new xt,Zs.SolveBarrier_s_pba=new xt,Zs.SolveBarrier_s_vba=new xt,Zs.SolveBarrier_s_vc=new xt,Zs.SolveBarrier_s_pca=new xt,Zs.SolveBarrier_s_vca=new xt,Zs.SolveBarrier_s_qba=new xt,Zs.SolveBarrier_s_qca=new xt,Zs.SolveBarrier_s_dv=new xt,Zs.SolveBarrier_s_f=new xt,Zs.SolvePressure_s_f=new xt,Zs.SolveDamping_s_v=new xt,Zs.SolveDamping_s_f=new xt,Zs.SolveRigidDamping_s_t0=new xt,Zs.SolveRigidDamping_s_t1=new xt,Zs.SolveRigidDamping_s_p=new xt,Zs.SolveRigidDamping_s_v=new xt,Zs.SolveExtraDamping_s_v=new xt,Zs.SolveExtraDamping_s_f=new xt,Zs.SolveRigid_s_position=new xt,Zs.SolveRigid_s_rotation=new Tt,Zs.SolveRigid_s_transform=new wt,Zs.SolveRigid_s_velocityTransform=new wt,Zs.SolveElastic_s_pa=new xt,Zs.SolveElastic_s_pb=new xt,Zs.SolveElastic_s_pc=new xt,Zs.SolveElastic_s_r=new Tt,Zs.SolveElastic_s_t0=new xt,Zs.SolveSpring_s_pa=new xt,Zs.SolveSpring_s_pb=new xt,Zs.SolveSpring_s_d=new xt,Zs.SolveSpring_s_f=new xt,Zs.SolveTensile_s_weightedNormal=new xt,Zs.SolveTensile_s_s=new xt,Zs.SolveTensile_s_f=new xt,Zs.SolveViscous_s_v=new xt,Zs.SolveViscous_s_f=new xt,Zs.SolveRepulsive_s_f=new xt,Zs.SolvePowder_s_f=new xt,Zs.SolveSolid_s_f=new xt,Zs.RemoveSpuriousBodyContacts_s_n=new xt,Zs.RemoveSpuriousBodyContacts_s_pos=new xt,Zs.RemoveSpuriousBodyContacts_s_normal=new xt;class Qs{constructor(){this._data=null,this.userSuppliedCapacity=0}get data(){return this._data}set data(t){this._data=t}}class tr{constructor(){this.index=T,this.tag=0}static CompareProxyProxy(t,e){return t.tag<e.tag}static CompareTagProxy(t,e){return t<e.tag}static CompareProxyTag(t,e){return t.tag<e}}class er{constructor(t,e,i,n,s){this.m_system=t,this.m_xLower=(e&Zs.xMask)>>>0,this.m_xUpper=(i&Zs.xMask)>>>0,this.m_yLower=(e&Zs.yMask)>>>0,this.m_yUpper=(i&Zs.yMask)>>>0,this.m_first=n,this.m_last=s}GetNext(){for(;this.m_first<this.m_last;){const t=(this.m_system.m_proxyBuffer.data[this.m_first].tag&Zs.xMask)>>>0;if(t>=this.m_xLower&&t<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return T}}class ir{constructor(){this.next=null,this.count=0,this.index=0}}class nr{Allocate(t,e){return e}Clear(){}GetCount(){return 0}Invalidate(t){}GetValidBuffer(){return[]}GetBuffer(){return[]}SetCount(t){}}class sr{constructor(t,e){this.second=T,this.first=t,this.second=e}}class rr extends nr{Initialize(t,e){}Find(t){return T}}class or{constructor(t,e){this.first=T,this.second=T,this.first=t,this.second=e}}class ar extends nr{Initialize(t,e){}Find(t){return T}}class lr{IsNecessary(t){return!0}ShouldCreatePair(t,e){return!0}ShouldCreateTriad(t,e,i){return!0}}class cr extends cs{constructor(t,e,i,n){super(),this.m_callDestructionListener=!1,this.m_destroyed=0,this.m_system=t,this.m_shape=e,this.m_xf=i,this.m_callDestructionListener=n,this.m_destroyed=0}ReportFixture(t){return!1}ReportParticle(t,e){return t===this.m_system&&(this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[e])&&(this.m_system.DestroyParticle(e,this.m_callDestructionListener),this.m_destroyed++),!0)}Destroyed(){return this.m_destroyed}}class hr extends lr{constructor(t){super(),this.m_threshold=0,this.m_threshold=t}ShouldCreatePair(t,e){return t<this.m_threshold&&this.m_threshold<=e||e<this.m_threshold&&this.m_threshold<=t}ShouldCreateTriad(t,e,i){return(t<this.m_threshold||e<this.m_threshold||i<this.m_threshold)&&(this.m_threshold<=t||this.m_threshold<=e||this.m_threshold<=i)}}class _r extends on{constructor(e,i=e.length){super(t.b2ShapeType.e_unknown,0),this.m_shapeCount=0,this.m_shapes=e,this.m_shapeCount=i}Clone(){throw new Error}GetChildCount(){return 1}TestPoint(t,e){for(let i=0;i<this.m_shapeCount;i++)if(this.m_shapes[i].TestPoint(t,e))return!0;return!1}ComputeDistance(t,e,i,n){return 0}RayCast(t,e,i,n){return!1}ComputeAABB(t,e,i){const s=new Se;t.lowerBound.x=+n,t.lowerBound.y=+n,t.upperBound.x=-n,t.upperBound.y=-n;for(let i=0;i<this.m_shapeCount;i++){const n=this.m_shapes[i].GetChildCount();for(let r=0;r<n;r++){const n=s;this.m_shapes[i].ComputeAABB(n,e,r),t.Combine1(n)}}}ComputeMass(t,e){}SetupDistanceProxy(t,e){}ComputeSubmergedArea(t,e,i,n){return 0}Dump(t){}}class ur extends lr{constructor(t){super(),this.m_flagsBuffer=t}IsNecessary(e){return 0!=(this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_reactiveParticle)}}class mr extends qs{constructor(t,e=null){super(t),this.m_contactFilter=null,this.m_contactFilter=e}ShouldCollideFixtureParticle(e,i,n){return!(this.m_contactFilter&&this.m_system.GetFlagsBuffer()[n]&t.b2ParticleFlag.b2_fixtureContactFilterParticle)||this.m_contactFilter.ShouldCollideFixtureParticle(e,this.m_system,n)}ReportFixtureAndParticle(e,i,n){const s=mr.ReportFixtureAndParticle_s_n,r=mr.ReportFixtureAndParticle_s_rp,o=this.m_system.m_positionBuffer.data[n],a=s,l=e.ComputeDistance(o,a,i);if(l<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(e,this.m_system,n)){const i=e.GetBody(),s=i.GetWorldCenter(),c=i.GetMass(),h=i.GetInertia()-c*i.GetLocalCenter().LengthSquared(),_=c>0?1/c:0,u=h>0?1/h:0,m=this.m_system.m_flagsBuffer.data[n]&t.b2ParticleFlag.b2_wallParticle?0:this.m_system.GetParticleInvMass(),d=xt.SubVV(o,s,r),p=xt.CrossVV(d,a),f=m+_+u*p*p,g=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];g.index=n,g.body=i,g.fixture=e,g.weight=1-l*this.m_system.m_inverseDiameter,g.normal.Copy(a.SelfNeg()),g.mass=f>0?1/f:0,this.m_system.DetectStuckParticle(n)}}}mr.ReportFixtureAndParticle_s_n=new xt,mr.ReportFixtureAndParticle_s_rp=new xt;class dr extends qs{constructor(t,e){super(t),this.m_step=e}ReportFixtureAndParticle(e,i,n){const s=dr.ReportFixtureAndParticle_s_p1,r=dr.ReportFixtureAndParticle_s_output,o=dr.ReportFixtureAndParticle_s_input,a=dr.ReportFixtureAndParticle_s_p,l=dr.ReportFixtureAndParticle_s_v,c=dr.ReportFixtureAndParticle_s_f,h=e.GetBody(),u=this.m_system.m_positionBuffer.data[n],m=this.m_system.m_velocityBuffer.data[n],d=r,p=o;if(0===this.m_system.m_iterationIndex){const i=wt.MulTXV(h.m_xf0,u,s);e.GetShape().GetType()===t.b2ShapeType.e_circleShape&&(i.SelfSub(h.GetLocalCenter()),Tt.MulRV(h.m_xf0.q,i,i),Tt.MulTRV(h.m_xf.q,i,i),i.SelfAdd(h.GetLocalCenter())),wt.MulXV(h.m_xf,i,p.p1)}else p.p1.Copy(u);if(xt.AddVMulSV(u,this.m_step.dt,m,p.p2),p.maxFraction=1,e.RayCast(d,p,i)){const t=d.normal,e=a;e.x=(1-d.fraction)*p.p1.x+d.fraction*p.p2.x+_*t.x,e.y=(1-d.fraction)*p.p1.y+d.fraction*p.p2.y+_*t.y;const i=l;i.x=this.m_step.inv_dt*(e.x-u.x),i.y=this.m_step.inv_dt*(e.y-u.y),this.m_system.m_velocityBuffer.data[n].Copy(i);const s=c;s.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(m.x-i.x),s.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(m.y-i.y),this.m_system.ParticleApplyForce(n,s)}}ReportParticle(t,e){return!1}}dr.ReportFixtureAndParticle_s_p1=new xt,dr.ReportFixtureAndParticle_s_output=new xe,dr.ReportFixtureAndParticle_s_input=new ve,dr.ReportFixtureAndParticle_s_p=new xt,dr.ReportFixtureAndParticle_s_v=new xt,dr.ReportFixtureAndParticle_s_f=new xt;class pr{constructor(t){this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new _s,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new xt,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new us,this.m_island=new bs,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(t)}SetDestructionListener(t){this.m_destructionListener=t}SetContactFilter(t){this.m_contactManager.m_contactFilter=t}SetContactListener(t){this.m_contactManager.m_contactListener=t}SetDebugDraw(t){this.m_debugDraw=t}CreateBody(t={}){if(this.IsLocked())throw new Error;const e=new fn(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e}DestroyBody(t){if(this.IsLocked())throw new Error;let e=t.m_jointList;for(;e;){const i=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint),t.m_jointList=e}t.m_jointList=null;let i=t.m_controllerList;for(;i;){const e=i;i=i.nextController,e.controller.RemoveBody(t)}let n=t.m_contactList;for(;n;){const t=n;n=n.next,this.m_contactManager.Destroy(t.contact)}t.m_contactList=null;let s=t.m_fixtureList;for(;s;){const e=s;s=s.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(e),e.DestroyProxies(),e.Reset(),t.m_fixtureList=s,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}static _Joint_Create(e){switch(e.type){case t.b2JointType.e_distanceJoint:return new An(e);case t.b2JointType.e_mouseJoint:return new Mn(e);case t.b2JointType.e_prismaticJoint:return new On(e);case t.b2JointType.e_revoluteJoint:return new Vn(e);case t.b2JointType.e_pulleyJoint:return new Fn(e);case t.b2JointType.e_gearJoint:return new Pn(e);case t.b2JointType.e_wheelJoint:return new Wn(e);case t.b2JointType.e_weldJoint:return new kn(e);case t.b2JointType.e_frictionJoint:return new wn(e);case t.b2JointType.e_ropeJoint:return new Gn(e);case t.b2JointType.e_motorJoint:return new Dn(e);case t.b2JointType.e_areaJoint:return new bn(e)}throw new Error}static _Joint_Destroy(t){}CreateJoint(t){if(this.IsLocked())throw new Error;const e=pr._Joint_Create(t);e.m_prev=null,e.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=e),this.m_jointList=e,++this.m_jointCount,e.m_edgeA.prev=null,e.m_edgeA.next=e.m_bodyA.m_jointList,e.m_bodyA.m_jointList&&(e.m_bodyA.m_jointList.prev=e.m_edgeA),e.m_bodyA.m_jointList=e.m_edgeA,e.m_edgeB.prev=null,e.m_edgeB.next=e.m_bodyB.m_jointList,e.m_bodyB.m_jointList&&(e.m_bodyB.m_jointList.prev=e.m_edgeB),e.m_bodyB.m_jointList=e.m_edgeB;const i=e.m_bodyA,n=e.m_bodyB;if(!e.m_collideConnected){let t=n.GetContactList();for(;t;)t.other===i&&t.contact.FlagForFiltering(),t=t.next}return e}DestroyJoint(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);const e=t.m_bodyA,i=t.m_bodyB,n=t.m_collideConnected;if(e.SetAwake(!0),i.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===e.m_jointList&&(e.m_jointList=t.m_edgeA.next),t.m_edgeA.Reset(),t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===i.m_jointList&&(i.m_jointList=t.m_edgeB.next),t.m_edgeB.Reset(),pr._Joint_Destroy(t),--this.m_jointCount,!n){let t=i.GetContactList();for(;t;)t.other===e&&t.contact.FlagForFiltering(),t=t.next}}CreateParticleSystem(t){if(this.IsLocked())throw new Error;const e=new Zs(t,this);return e.m_prev=null,e.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=e),this.m_particleSystemList=e,e}DestroyParticleSystem(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_particleSystemList&&(this.m_particleSystemList=t.m_next)}CalculateReasonableParticleIterations(t){if(null===this.m_particleSystemList)return 1;function e(t){let e=n;for(let i=t.GetParticleSystemList();null!==i;i=i.m_next)e=tt(e,i.GetRadius());return e}return Ps(this.m_gravity.Length(),e(this),t)}Step(t,e,i,n=this.CalculateReasonableParticleIterations(t)){const s=pr.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;const r=pr.Step_s_step;r.dt=t,r.velocityIterations=e,r.positionIterations=i,r.particleIterations=n,r.inv_dt=t>0?1/t:0,r.dtRatio=this.m_inv_dt0*t,r.warmStarting=this.m_warmStarting;const o=pr.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=o.GetMilliseconds(),this.m_stepComplete&&r.dt>0){const t=pr.Step_s_timer.Reset();for(let t=this.m_particleSystemList;t;t=t.m_next)t.Solve(r);this.Solve(r),this.m_profile.solve=t.GetMilliseconds()}if(this.m_continuousPhysics&&r.dt>0){const t=pr.Step_s_timer.Reset();this.SolveTOI(r),this.m_profile.solveTOI=t.GetMilliseconds()}r.dt>0&&(this.m_inv_dt0=r.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=s.GetMilliseconds()}ClearForces(){for(let t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0}DrawParticleSystem(t){if(null===this.m_debugDraw)return;const e=t.GetParticleCount();if(e){const i=t.GetRadius(),n=t.GetPositionBuffer();if(t.m_colorBuffer.data){const s=t.GetColorBuffer();this.m_debugDraw.DrawParticles(n,i,s,e)}else this.m_debugDraw.DrawParticles(n,i,null,e)}}DrawDebugData(){if(null===this.m_debugDraw)return;const e=this.m_debugDraw.GetFlags(),i=pr.DrawDebugData_s_color.SetRGB(0,0,0);if(e&t.b2DrawFlags.e_shapeBit)for(let e=this.m_bodyList;e;e=e.m_next){const n=e.m_xf;this.m_debugDraw.PushTransform(n);for(let n=e.GetFixtureList();n;n=n.m_next)e.IsActive()?e.GetType()===t.b2BodyType.b2_staticBody?(i.SetRGB(.5,.9,.5),this.DrawShape(n,i)):e.GetType()===t.b2BodyType.b2_kinematicBody?(i.SetRGB(.5,.5,.9),this.DrawShape(n,i)):e.IsAwake()?(i.SetRGB(.9,.7,.7),this.DrawShape(n,i)):(i.SetRGB(.6,.6,.6),this.DrawShape(n,i)):(i.SetRGB(.5,.5,.3),this.DrawShape(n,i));this.m_debugDraw.PopTransform(n)}if(e&t.b2DrawFlags.e_particleBit)for(let t=this.m_particleSystemList;t;t=t.m_next)this.DrawParticleSystem(t);if(e&t.b2DrawFlags.e_jointBit)for(let t=this.m_jointList;t;t=t.m_next)this.DrawJoint(t);if(e&t.b2DrawFlags.e_aabbBit){i.SetRGB(.9,.3,.9);const t=pr.DrawDebugData_s_vs;for(let e=this.m_bodyList;e;e=e.m_next)if(e.IsActive())for(let n=e.GetFixtureList();n;n=n.m_next)for(let e=0;e<n.m_proxyCount;++e){const s=n.m_proxies[e].treeNode.aabb;t[0].Set(s.lowerBound.x,s.lowerBound.y),t[1].Set(s.upperBound.x,s.lowerBound.y),t[2].Set(s.upperBound.x,s.upperBound.y),t[3].Set(s.lowerBound.x,s.upperBound.y),this.m_debugDraw.DrawPolygon(t,4,i)}}if(e&t.b2DrawFlags.e_centerOfMassBit)for(let t=this.m_bodyList;t;t=t.m_next){const e=pr.DrawDebugData_s_xf;e.q.Copy(t.m_xf.q),e.p.Copy(t.GetWorldCenter()),this.m_debugDraw.DrawTransform(e)}if(e&t.b2DrawFlags.e_controllerBit)for(let t=this.m_controllerList;t;t=t.m_next)t.Draw(this.m_debugDraw)}QueryAABB(...t){t[0]instanceof cs?this._QueryAABB(t[0],t[1]):this._QueryAABB(null,t[0],t[1])}_QueryAABB(t,e,i){if(this.m_contactManager.m_broadPhase.Query(e,(e=>{const n=e.userData.fixture;return t?t.ReportFixture(n):!i||i(n)})),t instanceof cs)for(let i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryAABB(t,e)}QueryAllAABB(t,e=[]){return this.QueryAABB(t,(t=>(e.push(t),!0))),e}QueryPointAABB(...t){t[0]instanceof cs?this._QueryPointAABB(t[0],t[1]):this._QueryPointAABB(null,t[0],t[1])}_QueryPointAABB(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(e=>{const n=e.userData.fixture;return t?t.ReportFixture(n):!i||i(n)})),t instanceof cs)for(let i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(t,e)}QueryAllPointAABB(t,e=[]){return this.QueryPointAABB(t,(t=>(e.push(t),!0))),e}QueryFixtureShape(...t){t[0]instanceof cs?this._QueryFixtureShape(t[0],t[1],t[2],t[3]):this._QueryFixtureShape(null,t[0],t[1],t[2],t[3])}_QueryFixtureShape(t,e,i,n,s){const r=pr.QueryFixtureShape_s_aabb;if(e.ComputeAABB(r,n,i),this.m_contactManager.m_broadPhase.Query(r,(r=>{const o=r.userData,a=o.fixture;if(Ee(e,i,a.GetShape(),o.childIndex,n,a.GetBody().GetTransform())){if(t)return t.ReportFixture(a);if(s)return s(a)}return!0})),t instanceof cs)for(let e=this.m_particleSystemList;e;e=e.m_next)t.ShouldQueryParticleSystem(e)&&e.QueryAABB(t,r)}QueryAllFixtureShape(t,e,i,n=[]){return this.QueryFixtureShape(t,e,i,(t=>(n.push(t),!0))),n}QueryFixturePoint(...t){t[0]instanceof cs?this._QueryFixturePoint(t[0],t[1]):this._QueryFixturePoint(null,t[0],t[1])}_QueryFixturePoint(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(n=>{const s=n.userData.fixture;if(s.TestPoint(e)){if(t)return t.ReportFixture(s);if(i)return i(s)}return!0})),t)for(let i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(t,e)}QueryAllFixturePoint(t,e=[]){return this.QueryFixturePoint(t,(t=>(e.push(t),!0))),e}RayCast(...t){t[0]instanceof hs?this._RayCast(t[0],t[1],t[2]):this._RayCast(null,t[0],t[1],t[2])}_RayCast(t,e,i,n){const s=pr.RayCast_s_input;if(s.maxFraction=1,s.p1.Copy(e),s.p2.Copy(i),this.m_contactManager.m_broadPhase.RayCast(s,((s,r)=>{const o=r.userData,a=o.fixture,l=o.childIndex,c=pr.RayCast_s_output;if(a.RayCast(c,s,l)){const s=c.fraction,r=pr.RayCast_s_point;if(r.Set((1-s)*e.x+s*i.x,(1-s)*e.y+s*i.y),t)return t.ReportFixture(a,r,c.normal,s);if(n)return n(a,r,c.normal,s)}return s.maxFraction})),t)for(let n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.RayCast(t,e,i)}RayCastOne(t,e){let i=null,n=1;return this.RayCast(t,e,((t,e,s,r)=>(r<n&&(n=r,i=t),n))),i}RayCastAll(t,e,i=[]){return this.RayCast(t,e,(t=>(i.push(t),1))),i}GetBodyList(){return this.m_bodyList}GetJointList(){return this.m_jointList}GetParticleSystemList(){return this.m_particleSystemList}GetContactList(){return this.m_contactManager.m_contactList}SetAllowSleeping(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(let t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)}GetAllowSleeping(){return this.m_allowSleep}SetWarmStarting(t){this.m_warmStarting=t}GetWarmStarting(){return this.m_warmStarting}SetContinuousPhysics(t){this.m_continuousPhysics=t}GetContinuousPhysics(){return this.m_continuousPhysics}SetSubStepping(t){this.m_subStepping=t}GetSubStepping(){return this.m_subStepping}GetProxyCount(){return this.m_contactManager.m_broadPhase.GetProxyCount()}GetBodyCount(){return this.m_bodyCount}GetJointCount(){return this.m_jointCount}GetContactCount(){return this.m_contactManager.m_contactCount}GetTreeHeight(){return this.m_contactManager.m_broadPhase.GetTreeHeight()}GetTreeBalance(){return this.m_contactManager.m_broadPhase.GetTreeBalance()}GetTreeQuality(){return this.m_contactManager.m_broadPhase.GetTreeQuality()}SetGravity(t,e=!0){if(!xt.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(let t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)}GetGravity(){return this.m_gravity}IsLocked(){return this.m_locked}SetAutoClearForces(t){this.m_clearForces=t}GetAutoClearForces(){return this.m_clearForces}ShiftOrigin(t){if(this.IsLocked())throw new Error;for(let e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(let e=this.m_jointList;e;e=e.m_next)e.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)}GetContactManager(){return this.m_contactManager}GetProfile(){return this.m_profile}Dump(e){if(this.m_locked)return;e("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),e("this.m_world.SetGravity(g);\n"),e("const bodies: b2Body[] = [];\n"),e("const joints: b2Joint[] = [];\n");let i=0;for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandIndex=i,t.Dump(e),++i;i=0;for(let t=this.m_jointList;t;t=t.m_next)t.m_index=i,++i;for(let i=this.m_jointList;i;i=i.m_next)i.m_type!==t.b2JointType.e_gearJoint&&(e("{\n"),i.Dump(e),e("}\n"));for(let i=this.m_jointList;i;i=i.m_next)i.m_type===t.b2JointType.e_gearJoint&&(e("{\n"),i.Dump(e),e("}\n"))}DrawJoint(e){if(null===this.m_debugDraw)return;const i=e.GetBodyA(),n=e.GetBodyB(),s=i.m_xf,r=n.m_xf,o=s.p,a=r.p,l=e.GetAnchorA(pr.DrawJoint_s_p1),c=e.GetAnchorB(pr.DrawJoint_s_p2),h=pr.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(e.m_type){case t.b2JointType.e_distanceJoint:this.m_debugDraw.DrawSegment(l,c,h);break;case t.b2JointType.e_pulleyJoint:{const t=e,i=t.GetGroundAnchorA(),n=t.GetGroundAnchorB();this.m_debugDraw.DrawSegment(i,l,h),this.m_debugDraw.DrawSegment(n,c,h),this.m_debugDraw.DrawSegment(i,n,h);break}case t.b2JointType.e_mouseJoint:{const t=pr.DrawJoint_s_c;t.Set(0,1,0),this.m_debugDraw.DrawPoint(l,4,t),this.m_debugDraw.DrawPoint(c,4,t),t.Set(.8,.8,.8),this.m_debugDraw.DrawSegment(l,c,t);break}default:this.m_debugDraw.DrawSegment(o,l,h),this.m_debugDraw.DrawSegment(l,c,h),this.m_debugDraw.DrawSegment(a,c,h)}}DrawShape(e,i){if(null===this.m_debugDraw)return;const n=e.GetShape();switch(n.m_type){case t.b2ShapeType.e_circleShape:{const t=n,e=t.m_p,s=t.m_radius,r=xt.UNITX;this.m_debugDraw.DrawSolidCircle(e,s,r,i);break}case t.b2ShapeType.e_edgeShape:{const t=n,e=t.m_vertex1,s=t.m_vertex2;this.m_debugDraw.DrawSegment(e,s,i);break}case t.b2ShapeType.e_chainShape:{const t=n,e=t.m_count,s=t.m_vertices,r=pr.DrawShape_s_ghostColor.SetRGBA(.75*i.r,.75*i.g,.75*i.b,i.a);let o=s[0];if(this.m_debugDraw.DrawPoint(o,4,i),t.m_hasPrevVertex){const e=t.m_prevVertex;this.m_debugDraw.DrawSegment(e,o,r),this.m_debugDraw.DrawCircle(e,.1,r)}for(let t=1;t<e;++t){const e=s[t];this.m_debugDraw.DrawSegment(o,e,i),this.m_debugDraw.DrawPoint(e,4,i),o=e}if(t.m_hasNextVertex){const e=t.m_nextVertex;this.m_debugDraw.DrawSegment(e,o,r),this.m_debugDraw.DrawCircle(e,.1,r)}break}case t.b2ShapeType.e_polygonShape:{const t=n,e=t.m_count,s=t.m_vertices;this.m_debugDraw.DrawSolidPolygon(s,e,i);break}}}Solve(e){for(let t=this.m_bodyList;t;t=t.m_next)t.m_xf0.Copy(t.m_xf);for(let t=this.m_controllerList;t;t=t.m_next)t.Step(e);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;const i=this.m_island;i.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,this.m_contactManager.m_contactListener);for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag=!1;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next)t.m_islandFlag=!1;for(let t=this.m_jointList;t;t=t.m_next)t.m_islandFlag=!1;const n=this.s_stack;for(let s=this.m_bodyList;s;s=s.m_next){if(s.m_islandFlag)continue;if(!s.IsAwake()||!s.IsActive())continue;if(s.GetType()===t.b2BodyType.b2_staticBody)continue;i.Clear();let r=0;for(n[r++]=s,s.m_islandFlag=!0;r>0;){const e=n[--r];if(!e)throw new Error;if(i.AddBody(e),e.m_awakeFlag=!0,e.GetType()!==t.b2BodyType.b2_staticBody){for(let t=e.m_contactList;t;t=t.next){const e=t.contact;if(e.m_islandFlag)continue;if(!e.IsEnabled()||!e.IsTouching())continue;const s=e.m_fixtureA.m_isSensor,o=e.m_fixtureB.m_isSensor;if(s||o)continue;i.AddContact(e),e.m_islandFlag=!0;const a=t.other;a.m_islandFlag||(n[r++]=a,a.m_islandFlag=!0)}for(let t=e.m_jointList;t;t=t.next){if(t.joint.m_islandFlag)continue;const e=t.other;e.IsActive()&&(i.AddJoint(t.joint),t.joint.m_islandFlag=!0,e.m_islandFlag||(n[r++]=e,e.m_islandFlag=!0))}}}const o=new us;i.Solve(o,e,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=o.solveInit,this.m_profile.solveVelocity+=o.solveVelocity,this.m_profile.solvePosition+=o.solvePosition;for(let e=0;e<i.m_bodyCount;++e){const n=i.m_bodies[e];n.GetType()===t.b2BodyType.b2_staticBody&&(n.m_islandFlag=!1)}}for(let t=0;t<n.length&&n[t];++t)n[t]=null;const s=new Rt;for(let e=this.m_bodyList;e;e=e.m_next)e.m_islandFlag&&e.GetType()!==t.b2BodyType.b2_staticBody&&e.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=s.GetMilliseconds()}SolveTOI(e){const i=this.m_island;if(i.Initialize(2*p,p,0,this.m_contactManager.m_contactListener),this.m_stepComplete){for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag=!1,t.m_sweep.alpha0=0;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next)t.m_toiFlag=!1,t.m_islandFlag=!1,t.m_toiCount=0,t.m_toi=1}for(;;){let n=null,r=1;for(let e=this.m_contactManager.m_contactList;e;e=e.m_next){if(!e.IsEnabled())continue;if(e.m_toiCount>d)continue;let i=1;if(e.m_toiFlag)i=e.m_toi;else{const n=e.GetFixtureA(),s=e.GetFixtureB();if(n.IsSensor()||s.IsSensor())continue;const r=n.GetBody(),o=s.GetBody(),a=r.m_type,l=o.m_type,c=r.IsAwake()&&a!==t.b2BodyType.b2_staticBody,h=o.IsAwake()&&l!==t.b2BodyType.b2_staticBody;if(!c&&!h)continue;const _=r.IsBullet()||a!==t.b2BodyType.b2_dynamicBody,u=o.IsBullet()||l!==t.b2BodyType.b2_dynamicBody;if(!_&&!u)continue;let m=r.m_sweep.alpha0;r.m_sweep.alpha0<o.m_sweep.alpha0?(m=o.m_sweep.alpha0,r.m_sweep.Advance(m)):o.m_sweep.alpha0<r.m_sweep.alpha0&&(m=r.m_sweep.alpha0,o.m_sweep.Advance(m));const d=e.GetChildIndexA(),p=e.GetChildIndexB(),f=pr.SolveTOI_s_toi_input;f.proxyA.SetShape(n.GetShape(),d),f.proxyB.SetShape(s.GetShape(),p),f.sweepA.Copy(r.m_sweep),f.sweepB.Copy(o.m_sweep),f.tMax=1;const g=pr.SolveTOI_s_toi_output;ri(g,f);const y=g.t;i=g.state===t.b2TOIOutputState.e_touching?tt(m+(1-m)*y,1):1,e.m_toi=i,e.m_toiFlag=!0}i<r&&(n=e,r=i)}if(null===n||1-10*s<r){this.m_stepComplete=!0;break}const o=n.GetFixtureA(),a=n.GetFixtureB(),l=o.GetBody(),c=a.GetBody(),h=pr.SolveTOI_s_backup1.Copy(l.m_sweep),_=pr.SolveTOI_s_backup2.Copy(c.m_sweep);if(l.Advance(r),c.Advance(r),n.Update(this.m_contactManager.m_contactListener),n.m_toiFlag=!1,++n.m_toiCount,!n.IsEnabled()||!n.IsTouching()){n.SetEnabled(!1),l.m_sweep.Copy(h),c.m_sweep.Copy(_),l.SynchronizeTransform(),c.SynchronizeTransform();continue}l.SetAwake(!0),c.SetAwake(!0),i.Clear(),i.AddBody(l),i.AddBody(c),i.AddContact(n),l.m_islandFlag=!0,c.m_islandFlag=!0,n.m_islandFlag=!0;for(let e=0;e<2;++e){const n=0===e?l:c;if(n.m_type===t.b2BodyType.b2_dynamicBody)for(let e=n.m_contactList;e&&i.m_bodyCount!==i.m_bodyCapacity&&i.m_contactCount!==i.m_contactCapacity;e=e.next){const s=e.contact;if(s.m_islandFlag)continue;const o=e.other;if(o.m_type===t.b2BodyType.b2_dynamicBody&&!n.IsBullet()&&!o.IsBullet())continue;const a=s.m_fixtureA.m_isSensor,l=s.m_fixtureB.m_isSensor;if(a||l)continue;const c=pr.SolveTOI_s_backup.Copy(o.m_sweep);o.m_islandFlag||o.Advance(r),s.Update(this.m_contactManager.m_contactListener),s.IsEnabled()&&s.IsTouching()?(s.m_islandFlag=!0,i.AddContact(s),o.m_islandFlag||(o.m_islandFlag=!0,o.m_type!==t.b2BodyType.b2_staticBody&&o.SetAwake(!0),i.AddBody(o))):(o.m_sweep.Copy(c),o.SynchronizeTransform())}}const u=pr.SolveTOI_s_subStep;u.dt=(1-r)*e.dt,u.inv_dt=1/u.dt,u.dtRatio=1,u.positionIterations=20,u.velocityIterations=e.velocityIterations,u.particleIterations=e.particleIterations,u.warmStarting=!1,i.SolveTOI(u,l.m_islandIndex,c.m_islandIndex);for(let e=0;e<i.m_bodyCount;++e){const n=i.m_bodies[e];if(n.m_islandFlag=!1,n.m_type===t.b2BodyType.b2_dynamicBody){n.SynchronizeFixtures();for(let t=n.m_contactList;t;t=t.next)t.contact.m_toiFlag=!1,t.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}}AddController(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t}RemoveController(t){return t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList===t&&(this.m_controllerList=t.m_next),--this.m_controllerCount,t.m_prev=null,t.m_next=null,t}}pr.Step_s_step=new ms,pr.Step_s_stepTimer=new Rt,pr.Step_s_timer=new Rt,pr.DrawDebugData_s_color=new Pt(0,0,0),pr.DrawDebugData_s_vs=xt.MakeArray(4),pr.DrawDebugData_s_xf=new wt,pr.QueryFixtureShape_s_aabb=new Se,pr.RayCast_s_input=new ve,pr.RayCast_s_output=new xe,pr.RayCast_s_point=new xt,pr.DrawJoint_s_p1=new xt,pr.DrawJoint_s_p2=new xt,pr.DrawJoint_s_color=new Pt(.5,.8,.8),pr.DrawJoint_s_c=new Pt,pr.DrawShape_s_ghostColor=new Pt,pr.SolveTOI_s_subStep=new ms,pr.SolveTOI_s_backup=new Et,pr.SolveTOI_s_backup1=new Et,pr.SolveTOI_s_backup2=new Et,pr.SolveTOI_s_toi_input=new We,pr.SolveTOI_s_toi_output=new Ye;class fr{constructor(t,e){this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=t,this.body=e}}class gr{constructor(){this.m_bodyList=null,this.m_bodyCount=0,this.m_prev=null,this.m_next=null}GetNext(){return this.m_next}GetPrev(){return this.m_prev}GetBodyList(){return this.m_bodyList}AddBody(t){const e=new fr(this,t);e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList&&(this.m_bodyList.prevBody=e),this.m_bodyList=e,++this.m_bodyCount,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList&&(t.m_controllerList.prevController=e),t.m_controllerList=e,++t.m_controllerCount}RemoveBody(t){if(this.m_bodyCount<=0)throw new Error;let e=this.m_bodyList;for(;e&&e.body!==t;)e=e.nextBody;if(null===e)throw new Error;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),this.m_bodyList===e&&(this.m_bodyList=e.nextBody),--this.m_bodyCount,e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),t.m_controllerList===e&&(t.m_controllerList=e.nextController),--t.m_controllerCount}Clear(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body);this.m_bodyCount=0}}class yr extends gr{constructor(){super(...arguments),this.normal=new xt(0,1),this.offset=0,this.density=0,this.velocity=new xt(0,0),this.linearDrag=0,this.angularDrag=0,this.useDensity=!1,this.useWorldGravity=!0,this.gravity=new xt(0,0)}Step(t){if(this.m_bodyList){this.useWorldGravity&&this.gravity.Copy(this.m_bodyList.body.GetWorld().GetGravity());for(let t=this.m_bodyList;t;t=t.nextBody){const e=t.body;if(!e.IsAwake())continue;const i=new xt,n=new xt;let r=0,o=0;for(let t=e.GetFixtureList();t;t=t.m_next){const s=new xt,a=t.GetShape().ComputeSubmergedArea(this.normal,this.offset,e.GetTransform(),s);r+=a,i.x+=a*s.x,i.y+=a*s.y;let l=0;l=this.useDensity?t.GetDensity():1,o+=a*l,n.x+=a*s.x*l,n.y+=a*s.y*l}if(i.x/=r,i.y/=r,n.x/=o,n.y/=o,r<s)continue;const a=this.gravity.Clone().SelfNeg();a.SelfMul(this.density*r),e.ApplyForce(a,n);const l=e.GetLinearVelocityFromWorldPoint(i,new xt);l.SelfSub(this.velocity),l.SelfMul(-this.linearDrag*r),e.ApplyForce(l,i),e.ApplyTorque(-e.GetInertia()/e.GetMass()*r*e.GetAngularVelocity()*this.angularDrag)}}}Draw(t){const e=100,i=new xt,n=new xt;i.x=this.normal.x*this.offset+this.normal.y*e,i.y=this.normal.y*this.offset-this.normal.x*e,n.x=this.normal.x*this.offset-this.normal.y*e,n.y=this.normal.y*this.offset+this.normal.x*e;const s=new Pt(0,0,.8);t.DrawSegment(i,n,s)}}class vr extends gr{constructor(){super(...arguments),this.A=new xt(0,0)}Step(t){const e=xt.MulSV(t.dt,this.A,vr.Step_s_dtA);for(let t=this.m_bodyList;t;t=t.nextBody){const i=t.body;i.IsAwake()&&i.SetLinearVelocity(xt.AddVV(i.GetLinearVelocity(),e,xt.s_t0))}}Draw(t){}}vr.Step_s_dtA=new xt;class xr extends gr{constructor(){super(...arguments),this.F=new xt(0,0)}Step(t){for(let t=this.m_bodyList;t;t=t.nextBody){const e=t.body;e.IsAwake()&&e.ApplyForce(this.F,e.GetWorldCenter())}}Draw(t){}}class Sr extends gr{constructor(){super(...arguments),this.G=1,this.invSqr=!0}Step(t){if(this.invSqr)for(let t=this.m_bodyList;t;t=t.nextBody){const e=t.body,i=e.GetWorldCenter(),n=e.GetMass();for(let r=this.m_bodyList;r&&r!==t;r=r.nextBody){const t=r.body,o=t.GetWorldCenter(),a=t.GetMass(),l=o.x-i.x,c=o.y-i.y,h=l*l+c*c;if(h<s)continue;const _=Sr.Step_s_f.Set(l,c);_.SelfMul(this.G/h/at(h)*n*a),e.IsAwake()&&e.ApplyForce(_,i),t.IsAwake()&&t.ApplyForce(_.SelfMul(-1),o)}}else for(let t=this.m_bodyList;t;t=t.nextBody){const e=t.body,i=e.GetWorldCenter(),n=e.GetMass();for(let r=this.m_bodyList;r&&r!==t;r=r.nextBody){const t=r.body,o=t.GetWorldCenter(),a=t.GetMass(),l=o.x-i.x,c=o.y-i.y,h=l*l+c*c;if(h<s)continue;const _=Sr.Step_s_f.Set(l,c);_.SelfMul(this.G/h*n*a),e.IsAwake()&&e.ApplyForce(_,i),t.IsAwake()&&t.ApplyForce(_.SelfMul(-1),o)}}}Draw(t){}}Sr.Step_s_f=new xt;class Ar extends gr{constructor(){super(...arguments),this.T=new Ct,this.maxTimestep=0}Step(t){let e=t.dt;if(!(e<=s)){e>this.maxTimestep&&this.maxTimestep>0&&(e=this.maxTimestep);for(let t=this.m_bodyList;t;t=t.nextBody){const i=t.body;if(!i.IsAwake())continue;const n=i.GetWorldVector(Ct.MulMV(this.T,i.GetLocalVector(i.GetLinearVelocity(),xt.s_t0),xt.s_t1),Ar.Step_s_damping);i.SetLinearVelocity(xt.AddVV(i.GetLinearVelocity(),xt.MulSV(e,n,xt.s_t0),xt.s_t1))}}}Draw(t){}SetAxisAligned(t,e){this.T.ex.x=-t,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-e,this.maxTimestep=t>0||e>0?1/et(t,e):0}}Ar.Step_s_damping=new xt;class Cr{constructor(){this.vertices=[],this.count=0,this.masses=[],this.gravity=new xt(0,0),this.damping=.1,this.k2=.9,this.k3=.1}}class br{constructor(){this.m_count=0,this.m_ps=[],this.m_p0s=[],this.m_vs=[],this.m_ims=[],this.m_Ls=[],this.m_as=[],this.m_gravity=new xt,this.m_damping=0,this.m_k2=1,this.m_k3=.1}GetVertexCount(){return this.m_count}GetVertices(){return this.m_ps}Initialize(t){this.m_count=t.count,this.m_ps=xt.MakeArray(this.m_count),this.m_p0s=xt.MakeArray(this.m_count),this.m_vs=xt.MakeArray(this.m_count),this.m_ims=K(this.m_count);for(let e=0;e<this.m_count;++e){this.m_ps[e].Copy(t.vertices[e]),this.m_p0s[e].Copy(t.vertices[e]),this.m_vs[e].SetZero();const i=t.masses[e];this.m_ims[e]=i>0?1/i:0}const e=this.m_count-1,i=this.m_count-2;this.m_Ls=K(e),this.m_as=K(i);for(let t=0;t<e;++t){const e=this.m_ps[t],i=this.m_ps[t+1];this.m_Ls[t]=xt.DistanceVV(e,i)}for(let t=0;t<i;++t){const e=this.m_ps[t],i=this.m_ps[t+1],n=this.m_ps[t+2],s=xt.SubVV(i,e,xt.s_t0),r=xt.SubVV(n,i,xt.s_t1),o=xt.CrossVV(s,r),a=xt.DotVV(s,r);this.m_as[t]=pt(o,a)}this.m_gravity.Copy(t.gravity),this.m_damping=t.damping,this.m_k2=t.k2,this.m_k3=t.k3}Step(t,e){if(0===t)return;const i=Math.exp(-t*this.m_damping);for(let e=0;e<this.m_count;++e)this.m_p0s[e].Copy(this.m_ps[e]),this.m_ims[e]>0&&this.m_vs[e].SelfMulAdd(t,this.m_gravity),this.m_vs[e].SelfMul(i),this.m_ps[e].SelfMulAdd(t,this.m_vs[e]);for(let t=0;t<e;++t)this.SolveC2(),this.SolveC3(),this.SolveC2();const n=1/t;for(let t=0;t<this.m_count;++t)xt.MulSV(n,xt.SubVV(this.m_ps[t],this.m_p0s[t],xt.s_t0),this.m_vs[t])}SolveC2(){const t=this.m_count-1;for(let e=0;e<t;++e){const t=this.m_ps[e],i=this.m_ps[e+1],n=xt.SubVV(i,t,br.s_d),s=n.Normalize(),r=this.m_ims[e],o=this.m_ims[e+1];if(r+o===0)continue;const a=r/(r+o),l=o/(r+o);t.SelfMulSub(this.m_k2*a*(this.m_Ls[e]-s),n),i.SelfMulAdd(this.m_k2*l*(this.m_Ls[e]-s),n)}}SetAngle(t){const e=this.m_count-2;for(let i=0;i<e;++i)this.m_as[i]=t}SolveC3(){const t=this.m_count-2;for(let e=0;e<t;++e){const t=this.m_ps[e],i=this.m_ps[e+1],n=this.m_ps[e+2],s=this.m_ims[e],r=this.m_ims[e+1],a=this.m_ims[e+2],l=xt.SubVV(i,t,br.s_d1),c=xt.SubVV(n,i,br.s_d2),h=l.LengthSquared(),_=c.LengthSquared();if(h*_==0)continue;const u=xt.CrossVV(l,c),m=xt.DotVV(l,c);let d=pt(u,m);const p=xt.MulSV(-1/h,l.SelfSkew(),br.s_Jd1),f=xt.MulSV(1/_,c.SelfSkew(),br.s_Jd2),g=xt.NegV(p,br.s_J1),y=xt.SubVV(p,f,br.s_J2),v=f;let x=s*xt.DotVV(g,g)+r*xt.DotVV(y,y)+a*xt.DotVV(v,v);if(0===x)continue;x=1/x;let S=d-this.m_as[e];for(;S>o;)d-=2*o,S=d-this.m_as[e];for(;S<-o;)d+=2*o,S=d-this.m_as[e];const A=-this.m_k3*x*S;t.SelfMulAdd(s*A,g),i.SelfMulAdd(r*A,y),n.SelfMulAdd(a*A,v)}}Draw(t){const e=new Pt(.4,.5,.7);for(let i=0;i<this.m_count-1;++i)t.DrawSegment(this.m_ps[i],this.m_ps[i+1],e)}}br.s_d=new xt,br.s_d1=new xt,br.s_d2=new xt,br.s_Jd1=new xt,br.s_Jd2=new xt,br.s_J1=new xt,br.s_J2=new xt,t.b2AABB=Se,t.b2Abs=Q,t.b2Acos=mt,t.b2Alloc=z,t.b2AreaJoint=bn,t.b2AreaJointDef=Cn,t.b2Asin=dt,t.b2Assert=e,t.b2Atan2=pt,t.b2BlockAllocator=Ot,t.b2Body=fn,t.b2BodyDef=pn,t.b2BroadPhase=Ne,t.b2BuoyancyController=yr,t.b2CalculateParticleIterations=Ps,t.b2ChainAndCircleContact=es,t.b2ChainAndPolygonContact=is,t.b2ChainShape=hn,t.b2CircleContact=Jn,t.b2CircleShape=an,t.b2Clamp=it,t.b2ClipSegmentToLine=Ce,t.b2ClipVertex=ye,t.b2CollideCircles=li,t.b2CollideEdgeAndCircle=Wi,t.b2CollideEdgeAndPolygon=Qi,t.b2CollidePolygonAndCircle=ui,t.b2CollidePolygons=Li,t.b2Color=Pt,t.b2ConstantAccelController=vr,t.b2ConstantForceController=xr,t.b2Contact=Kn,t.b2ContactEdge=Yn,t.b2ContactFactory=ss,t.b2ContactFeature=ue,t.b2ContactFilter=os,t.b2ContactID=me,t.b2ContactImpulse=as,t.b2ContactListener=ls,t.b2ContactManager=_s,t.b2ContactPositionConstraint=xs,t.b2ContactRegister=ns,t.b2ContactSolver=Cs,t.b2ContactSolverDef=Ss,t.b2ContactVelocityConstraint=vs,t.b2Controller=gr,t.b2ControllerEdge=fr,t.b2Cos=_t,t.b2Counter=Mt,t.b2DegToRad=ct,t.b2DestructionListener=rs,t.b2Distance=Qt,t.b2DistanceInput=zt,t.b2DistanceJoint=An,t.b2DistanceJointDef=Sn,t.b2DistanceOutput=Vt,t.b2DistanceProxy=Lt,t.b2Draw=Dt,t.b2DynamicTree=De,t.b2EdgeAndCircleContact=Qn,t.b2EdgeAndPolygonContact=ts,t.b2EdgeShape=cn,t.b2Filter=_n,t.b2Fixture=dn,t.b2FixtureDef=un,t.b2FixtureParticleQueryCallback=qs,t.b2FixtureProxy=mn,t.b2Free=V,t.b2FrictionJoint=wn,t.b2FrictionJointDef=Tn,t.b2GearJoint=Pn,t.b2GearJointDef=En,t.b2GetPointStates=ge,t.b2GravityController=Sr,t.b2GrowableBuffer=Ws,t.b2GrowableStack=Bt,t.b2InvSqrt=ot,t.b2IsPowerOfTwo=gt,t.b2IsValid=st,t.b2Island=bs,t.b2Jacobian=gn,t.b2Joint=xn,t.b2JointDef=vn,t.b2JointEdge=yn,t.b2Log=U,t.b2MakeArray=X,t.b2MakeNullArray=Y,t.b2MakeNumberArray=K,t.b2Manifold=pe,t.b2ManifoldPoint=de,t.b2MassData=tn,t.b2Mat22=Ct,t.b2Mat33=bt,t.b2Max=et,t.b2Maybe=i,t.b2Min=tt,t.b2MixFriction=qn,t.b2MixRestitution=Xn,t.b2MotorJoint=Dn,t.b2MotorJointDef=In,t.b2MouseJoint=Mn,t.b2MouseJointDef=Rn,t.b2NextPowerOfTwo=ft,t.b2Pair=Oe,t.b2PairLessThan=Le,t.b2ParseInt=W,t.b2ParseUInt=q,t.b2ParticleBodyContact=Ys,t.b2ParticleContact=Xs,t.b2ParticleDef=Es,t.b2ParticleGroup=Rs,t.b2ParticleGroupDef=Ds,t.b2ParticleHandle=Is,t.b2ParticlePair=Ks,t.b2ParticlePairSet=ar,t.b2ParticleSystem=Zs,t.b2ParticleSystemDef=$s,t.b2ParticleSystem_CompositeShape=_r,t.b2ParticleSystem_ConnectionFilter=lr,t.b2ParticleSystem_DestroyParticlesInShapeCallback=cr,t.b2ParticleSystem_FixedSetAllocator=nr,t.b2ParticleSystem_FixtureParticle=sr,t.b2ParticleSystem_FixtureParticleSet=rr,t.b2ParticleSystem_InsideBoundsEnumerator=er,t.b2ParticleSystem_JoinParticleGroupsFilter=hr,t.b2ParticleSystem_ParticleListNode=ir,t.b2ParticleSystem_ParticlePair=or,t.b2ParticleSystem_Proxy=tr,t.b2ParticleSystem_ReactiveFilter=ur,t.b2ParticleSystem_SolveCollisionCallback=dr,t.b2ParticleSystem_UpdateBodyContactsCallback=mr,t.b2ParticleSystem_UserOverridableBuffer=Qs,t.b2ParticleTriad=Js,t.b2PolygonAndCircleContact=Zn,t.b2PolygonContact=$n,t.b2PolygonShape=ln,t.b2Position=ds,t.b2PositionSolverManifold=As,t.b2Pow=lt,t.b2PrismaticJoint=On,t.b2PrismaticJointDef=Bn,t.b2Profile=us,t.b2PulleyJoint=Fn,t.b2PulleyJointDef=Ln,t.b2QueryCallback=cs,t.b2RadToDeg=ht,t.b2Random=yt,t.b2RandomRange=vt,t.b2RayCastCallback=hs,t.b2RayCastInput=ve,t.b2RayCastOutput=xe,t.b2RevoluteJoint=Vn,t.b2RevoluteJointDef=zn,t.b2Rope=br,t.b2RopeDef=Cr,t.b2RopeJoint=Gn,t.b2RopeJointDef=Un,t.b2Rot=Tt,t.b2SeparationFunction=Ke,t.b2Shape=on,t.b2ShapeCast=le,t.b2ShapeCastInput=Ut,t.b2ShapeCastOutput=Gt,t.b2Simplex=jt,t.b2SimplexCache=Ft,t.b2SimplexVertex=kt,t.b2Sin=ut,t.b2SolverData=fs,t.b2Sq=rt,t.b2Sqrt=at,t.b2StackAllocator=Nt,t.b2Swap=nt,t.b2Sweep=Et,t.b2TOIInput=We,t.b2TOIOutput=Ye,t.b2TensorDampingController=Ar,t.b2TestOverlapAABB=Ae,t.b2TestOverlapShape=Ee,t.b2TimeOfImpact=ri,t.b2TimeStep=ms,t.b2Timer=Rt,t.b2Transform=wt,t.b2TreeNode=Ie,t.b2Vec2=xt,t.b2Vec2_zero=St,t.b2Vec3=At,t.b2Velocity=ps,t.b2VelocityConstraintPoint=ys,t.b2Version=G,t.b2WeldJoint=kn,t.b2WeldJointDef=Hn,t.b2WheelJoint=Wn,t.b2WheelJointDef=jn,t.b2World=pr,t.b2WorldManifold=fe,t.b2_180_over_pi=$,t.b2_aabbExtension=c,t.b2_aabbMultiplier=h,t.b2_angularSleepTolerance=F,t.b2_angularSlop=u,t.b2_barrierCollisionTime=O,t.b2_baumgarte=C,t.b2_branch=k,t.b2_commit=j,t.b2_epsilon=s,t.b2_epsilon_sq=r,t.b2_gjk_reset=Ht,t.b2_invalidParticleIndex=T,t.b2_linearSleepTolerance=L,t.b2_linearSlop=_,t.b2_maxAngularCorrection=y,t.b2_maxFloat=n,t.b2_maxLinearCorrection=g,t.b2_maxManifoldPoints=a,t.b2_maxParticleForce=D,t.b2_maxParticleIndex=w,t.b2_maxParticlePressure=I,t.b2_maxPolygonVertices=l,t.b2_maxRotation=S,t.b2_maxRotationSquared=A,t.b2_maxSubSteps=d,t.b2_maxTOIContacts=p,t.b2_maxTranslation=v,t.b2_maxTranslationSquared=x,t.b2_maxTriadDistance=R,t.b2_maxTriadDistanceSquared=M,t.b2_minParticleSystemBufferCapacity=B,t.b2_minParticleWeight=P,t.b2_minPulleyLength=Nn,t.b2_particleStride=E,t.b2_pi=o,t.b2_pi_over_180=J,t.b2_polygonRadius=m,t.b2_timeToSleep=N,t.b2_toiBaumgarte=b,t.b2_toi_reset=Fe,t.b2_two_pi=Z,t.b2_velocityThreshold=f,t.b2_version=H,t.g_blockSolve=gs,Object.defineProperty(t,"__esModule",{value:!0})}(e)}(e={exports:{}},e.exports),e.exports}();(W$=q$)&&W$.__esModule&&Object.prototype.hasOwnProperty.call(W$,"default")&&W$.default;let X$={};for(var Y$ in q$)-1===Y$.indexOf("b2_")&&(X$[Y$.replace("b2","")]=q$[Y$]);var K$=X$;let J$,$$,Z$,Q$;!function(t){t[t.Static=0]="Static",t[t.Kinematic=1]="Kinematic",t[t.Dynamic=2]="Dynamic",t[t.Animated=3]="Animated"}(J$||(J$=t("ERigidBody2DType",{}))),Gt(J$),function(t){t[t.None=0]="None",t[t.BOX=1]="BOX",t[t.CIRCLE=2]="CIRCLE",t[t.POLYGON=3]="POLYGON"}($$||($$=t("ECollider2DType",{}))),Gt($$),function(t){t[t.None=0]="None",t[t.DISTANCE=1]="DISTANCE",t[t.SPRING=2]="SPRING",t[t.WHEEL=3]="WHEEL",t[t.MOUSE=4]="MOUSE",t[t.FIXED=5]="FIXED",t[t.SLIDER=6]="SLIDER",t[t.RELATIVE=7]="RELATIVE",t[t.HINGE=8]="HINGE"}(Z$||(Z$=t("EJoint2DType",{}))),Gt(Z$),function(t){t[t.Closest=0]="Closest",t[t.Any=1]="Any",t[t.AllClosest=2]="AllClosest",t[t.All=3]="All"}(Q$||(Q$=t("ERaycast2DType",{})));const tZ=t("Contact2DType",{None:"none-contact",BEGIN_CONTACT:"begin-contact",END_CONTACT:"end-contact",PRE_SOLVE:"pre-solve",POST_SOLVE:"post-solve"});let eZ;!function(t){t[t.None=0]="None",t[t.Shape=1]="Shape",t[t.Joint=2]="Joint",t[t.Aabb=4]="Aabb",t[t.Pair=8]="Pair",t[t.CenterOfMass=16]="CenterOfMass",t[t.Particle=32]="Particle",t[t.Controller=64]="Controller",t[t.All=63]="All"}(eZ||(eZ=t("EPhysics2DDrawFlags",{})));const iZ=t("PHYSICS_2D_PTM_RATIO",32);class nZ extends K$.ContactListener{constructor(...t){super(...t),this._contactFixtures=[],this._BeginContact=null,this._EndContact=null,this._PreSolve=null,this._PostSolve=null}setBeginContact(t){this._BeginContact=t}setEndContact(t){this._EndContact=t}setPreSolve(t){this._PreSolve=t}setPostSolve(t){this._PostSolve=t}BeginContact(t){if(!this._BeginContact)return;const e=t.GetFixtureA(),i=t.GetFixtureB(),n=this._contactFixtures;t._shouldReport=!1,-1===n.indexOf(e)&&-1===n.indexOf(i)||(t._shouldReport=!0,this._BeginContact(t))}EndContact(t){this._EndContact&&t._shouldReport&&(t._shouldReport=!1,this._EndContact(t))}PreSolve(t,e){this._PreSolve&&t._shouldReport&&this._PreSolve(t,e)}PostSolve(t,e){this._PostSolve&&t._shouldReport&&this._PostSolve(t,e)}registerContactFixture(t){this._contactFixtures.push(t)}unregisterContactFixture(t){J(this._contactFixtures,t)}}class sZ extends K$.QueryCallback{constructor(...t){super(...t),this._point=new K$.Vec2,this._isPoint=!1,this._fixtures=[]}init(t){t?(this._isPoint=!0,this._point.x=t.x,this._point.y=t.y):this._isPoint=!1,this._fixtures.length=0}ReportFixture(t){return this._isPoint?t.TestPoint(this._point)&&this._fixtures.push(t):this._fixtures.push(t),!0}getFixture(){return this._fixtures[0]}getFixtures(){return this._fixtures}}function rZ(t,e){const i=e.length;return e[t<0?i- -t%i:t%i]}function oZ(t,e,i){const n=[];for(;e<t;)e+=i.length;for(;t<=e;++t)n.push(rZ(t,i));return n}function aZ(t){pZ(t);let e,i,n,s,r,o,a=[],l=new Ti,c=new Ti,h=0,_=0;for(let u=0;u<t.length;++u)if(cZ(u,t)){i=n=1e8;for(let r=0;r<t.length;++r)_Z(rZ(u-1,t),rZ(u,t),rZ(r,t))&&mZ(rZ(u-1,t),rZ(u,t),rZ(r-1,t))&&(s=gZ(rZ(u-1,t),rZ(u,t),rZ(r,t),rZ(r-1,t)),hZ(rZ(u+1,t),rZ(u,t),s)&&(e=dZ(rZ(u,t),s),e<i&&(i=e,l=s,h=r))),_Z(rZ(u+1,t),rZ(u,t),rZ(r+1,t))&&mZ(rZ(u+1,t),rZ(u,t),rZ(r,t))&&(s=gZ(rZ(u+1,t),rZ(u,t),rZ(r,t),rZ(r+1,t)),_Z(rZ(u-1,t),rZ(u,t),s)&&(e=dZ(rZ(u,t),s),e<n&&(n=e,_=r,c=s)));if(h==(_+1)%t.length){const e=l.add(c).multiplyScalar(.5);r=oZ(u,_,t),r.push(e),o=oZ(h,u,t),o.push(e)}else{let e=0,i=h;for(;_<h;)_+=t.length;for(let n=h;n<=_;++n)if(lZ(u,n,t)){let s=1/(dZ(rZ(u,t),rZ(n,t))+1);cZ(n,t)?mZ(rZ(n-1,t),rZ(n,t),rZ(u,t))&&uZ(rZ(n+1,t),rZ(n,t),rZ(u,t))?s+=3:s+=2:s+=1,s>e&&(i=n,e=s)}r=oZ(u,i,t),o=oZ(i,u,t)}return a=a.concat(aZ(r)),a=a.concat(aZ(o)),a}a.push(t);for(let t=a.length-1;t>=0;t--)0==a[t].length&&a.splice(t,0);return a}function lZ(t,e,i){if(cZ(t,i)){if(uZ(rZ(t,i),rZ(t-1,i),rZ(e,i))&&mZ(rZ(t,i),rZ(t+1,i),rZ(e,i)))return!1}else if(mZ(rZ(t,i),rZ(t+1,i),rZ(e,i))||uZ(rZ(t,i),rZ(t-1,i),rZ(e,i)))return!1;if(cZ(e,i)){if(uZ(rZ(e,i),rZ(e-1,i),rZ(t,i))&&mZ(rZ(e,i),rZ(e+1,i),rZ(t,i)))return!1}else if(mZ(rZ(e,i),rZ(e+1,i),rZ(t,i))||uZ(rZ(e,i),rZ(e-1,i),rZ(t,i)))return!1;for(let n=0;n<i.length;++n){if((n+1)%i.length==t||n==t||(n+1)%i.length==e||n==e)continue;const s=new Ti;if(yZ(rZ(t,i),rZ(e,i),rZ(n,i),rZ(n+1,i),s))return!1}return!0}function cZ(t,e){return hZ(t,e)}function hZ(t,e,i){if(void 0===i){const n=t,s=e;t=rZ(n-1,s),e=rZ(n,s),i=rZ(n+1,s)}return vZ(t,e,i)<0}function _Z(t,e,i){return vZ(t,e,i)>0}function uZ(t,e,i){return vZ(t,e,i)>=0}function mZ(t,e,i){return vZ(t,e,i)<=0}function dZ(t,e){const i=e.x-t.x,n=e.y-t.y;return i*i+n*n}function pZ(t){fZ(t)||t.reverse()}function fZ(t){return t.length<3||function(t){let e,i=0;for(e=0;e<t.length;e++){const n=(e+1)%t.length;i+=t[e].x*t[n].y,i-=t[e].y*t[n].x}return i/=2,i}(t)>0}function gZ(t,e,i,n){const s=new Ti,r=e.y-t.y,o=t.x-e.x,a=r*t.x+o*t.y,l=n.y-i.y,c=i.x-n.x,h=l*i.x+c*i.y,_=r*c-l*o;var u;return u=_,0,Math.abs(u-0)<=1e-6||(s.x=(c*a-o*h)/_,s.y=(r*h-l*a)/_),s}function yZ(t,e,i,n,s){if(t==i||t==n||e==i||e==n)return!1;const r=t.x,o=t.y,a=e.x,l=e.y,c=i.x,h=i.y,_=n.x,u=n.y;if(Math.max(r,a)<Math.min(c,_)||Math.max(c,_)<Math.min(r,a))return!1;if(Math.max(o,l)<Math.min(h,u)||Math.max(h,u)<Math.min(o,l))return!1;let m=(_-c)*(o-h)-(u-h)*(r-c),d=(a-r)*(o-h)-(l-o)*(r-c);const p=(u-h)*(a-r)-(_-c)*(l-o);return!(Math.abs(p)<1e-6)&&(m/=p,d/=p,m>0&&m<1&&d>0&&d<1&&(s.x=r+m*(a-r),s.y=o+m*(l-o),!0))}function vZ(t,e,i){return t.x*(e.y-i.y)+e.x*(i.y-t.y)+i.x*(t.y-e.y)}var xZ=Object.freeze({__proto__:null,ConvexPartition:aZ,ForceCounterClockWise:pZ,IsCounterClockWise:fZ});const SZ=()=>0,AZ={impl:null,rigidBody:null,isAwake:!1,isSleeping:!1,initialize:SZ,setType:SZ,setLinearDamping:SZ,setAngularDamping:SZ,setGravityScale:SZ,setFixedRotation:SZ,setAllowSleep:SZ,isActive:SZ,setActive:SZ,wakeUp:SZ,sleep:SZ,getMass:SZ,getInertia:SZ,getLinearVelocity:SZ,setLinearVelocity:SZ,getLinearVelocityFromWorldPoint:SZ,getAngularVelocity:SZ,setAngularVelocity:SZ,getLocalVector:SZ,getWorldVector:SZ,getLocalPoint:SZ,getWorldPoint:SZ,getLocalCenter:SZ,getWorldCenter:SZ,applyForce:SZ,applyForceToCenter:SZ,applyTorque:SZ,applyLinearImpulse:SZ,applyLinearImpulseToCenter:SZ,applyAngularImpulse:SZ,onEnable:SZ,onDisable:SZ,onDestroy:SZ},CZ={INITED:!1};const bZ={INITED:!1},TZ={impl:null,initialize:SZ,setDampingRatio:SZ,setFrequency:SZ,setMaxForce:SZ,setTarget:SZ,setDistance:SZ,setAngularOffset:SZ,setCorrectionFactor:SZ,setLinearOffset:SZ,setMaxLength:SZ,setMaxTorque:SZ,setLowerLimit:SZ,setUpperLimit:SZ,setMaxMotorForce:SZ,setMaxMotorTorque:SZ,setMotorSpeed:SZ,enableLimit:SZ,enableMotor:SZ,setLowerAngle:SZ,setUpperAngle:SZ};let wZ,EZ,PZ,IZ,DZ,RZ;!function(t){t[t.DYNAMIC=1]="DYNAMIC",t[t.STATIC=2]="STATIC",t[t.KINEMATIC=4]="KINEMATIC"}(wZ||(wZ={})),Gt(wZ),function(t){t[t.X_AXIS=0]="X_AXIS",t[t.Y_AXIS=1]="Y_AXIS",t[t.Z_AXIS=2]="Z_AXIS"}(EZ||(EZ={})),Gt(EZ),function(t){t[t.VERTEX=1]="VERTEX",t[t.LINE=2]="LINE",t[t.TRIANGLE=3]="TRIANGLE",t[t.TETRAHEDRON=4]="TETRAHEDRON"}(PZ||(PZ={})),Gt(PZ),function(t){t[t.BOX=0]="BOX",t[t.SPHERE=1]="SPHERE",t[t.CAPSULE=2]="CAPSULE",t[t.CYLINDER=3]="CYLINDER",t[t.CONE=4]="CONE",t[t.MESH=5]="MESH",t[t.PLANE=6]="PLANE",t[t.SIMPLEX=7]="SIMPLEX",t[t.TERRAIN=8]="TERRAIN"}(IZ||(IZ={})),Gt(IZ),function(t){t[t.POINT_TO_POINT=0]="POINT_TO_POINT",t[t.HINGE=1]="HINGE",t[t.CONE_TWIST=2]="CONE_TWIST"}(DZ||(DZ={})),Gt(DZ),function(t){t[t.DEFAULT=1]="DEFAULT"}(RZ||(RZ={})),Gt(RZ);class MZ{constructor(t){if(1===t){const t=this;for(let e=0;e<32;e++){const i="_"+(1<<e);t[i]=0,t.updateArray=[],Object.defineProperty(t,1<<e,{get(){return this[i]},set(t){this[i]!==t&&(this[i]=t,this.updateArray.indexOf(e)<0&&this.updateArray.push(e))}})}this._1=RZ.DEFAULT}else{for(let t=0;t<32;t++)this[""+(1<<t)]=0;this[1]=RZ.DEFAULT}}}let BZ,OZ=null;class NZ extends($i(Kx)){get enable(){return this._enable}set enable(t){this._enable=t}get allowSleep(){return this._allowSleep}set allowSleep(t){this._allowSleep=t,this.physicsWorld.setAllowSleep(t)}get gravity(){return this._gravity}set gravity(t){this._gravity.set(t),this.physicsWorld.setGravity(new Ti(t.x/iZ,t.y/iZ))}get maxSubSteps(){return this._maxSubSteps}set maxSubSteps(t){this._maxSubSteps=t}get fixedTimeStep(){return this._fixedTimeStep}set fixedTimeStep(t){this._fixedTimeStep=t}get autoSimulation(){return this._autoSimulation}set autoSimulation(t){this._autoSimulation=t}get debugDrawFlags(){return this.physicsWorld.debugDrawFlags}set debugDrawFlags(t){this.physicsWorld.debugDrawFlags=t}static get PHYSICS_NONE(){return!k$}static get PHYSICS_BUILTIN(){return"builtin"===k$}static get PHYSICS_BOX2D(){return"box2d"===k$}static get instance(){return OZ||(OZ=new NZ),OZ}get stepping(){return this._steping}constructor(){super(),this.velocityIterations=10,this.positionIterations=10,this.physicsWorld=void 0,this.collisionMatrix=new MZ,this._enable=!0,this._allowSleep=!0,this._maxSubSteps=1,this._fixedTimeStep=1/60,this._autoSimulation=!0,this._accumulator=0,this._steping=!1,this._gravity=new Ti(0,-10*iZ),this._delayEvents=[];const t=Lv.config?Lv.config.physics:null;if(t&&(Ti.copy(this._gravity,t.gravity),this._gravity.multiplyScalar(iZ),this._allowSleep=t.allowSleep,this._fixedTimeStep=t.fixedTimeStep,this._maxSubSteps=t.maxSubSteps,this._autoSimulation=t.autoSimulation,t.collisionMatrix))for(const e in t.collisionMatrix){const i=parseInt(e),n=1<<parseInt(e);this.collisionMatrix[`${n}`]=t.collisionMatrix[i]}this.physicsWorld=new H$.PhysicsWorld,this.gravity=this._gravity,this.allowSleep=this._allowSleep}postUpdate(t){if(!this._enable)return;if(!this._autoSimulation)return;aT.emit(oT.EVENT_BEFORE_PHYSICS),this._steping=!0;const e=this._fixedTimeStep,i=this.velocityIterations,n=this.positionIterations;this._accumulator+=t;let s=0;for(;s++<this._maxSubSteps&&this._accumulator>e;)this.physicsWorld.step(e,i,n),this._accumulator-=e;const r=this._delayEvents;for(let t=0,e=r.length;t<e;t++){const e=r[t];e.func.call(e.target)}r.length=0,this.physicsWorld.syncPhysicsToScene(),this.debugDrawFlags&&this.physicsWorld.drawDebug(),this._steping=!1,aT.emit(oT.EVENT_AFTER_PHYSICS)}_callAfterStep(t,e){this._steping?this._delayEvents.push({target:t,func:e}):e.call(t)}resetAccumulator(t=0){this._accumulator=t}step(t){this.physicsWorld.step(t,this.velocityIterations,this.positionIterations)}raycast(t,e,i=Q$.Closest,n=4294967295){return this.physicsWorld.raycast(t,e,i,n)}testPoint(t){return this.physicsWorld.testPoint(t)}testAABB(t){return this.physicsWorld.testAABB(t)}}var LZ,FZ,zZ,VZ,UZ,GZ,HZ,kZ,jZ,WZ,qZ,XZ,YZ,KZ,JZ,$Z,ZZ,QZ;t("PhysicsSystem2D",NZ),NZ.ID="PHYSICS_2D",aT.once(oT.EVENT_INIT,(()=>{NZ.PHYSICS_NONE||aT.registerSystem(NZ.ID,NZ.instance,0)})),function(t){t[t.Circles=0]="Circles",t[t.FaceA=1]="FaceA",t[t.FaceB=2]="FaceB"}(BZ||(BZ=t("Physics2DManifoldType",{})));const{property:tQ,type:eQ,menu:iQ}=rS;let nQ=t("RigidBody2D",(LZ=u_("cc.RigidBody2D"),FZ=iQ("Physics2D/RigidBody2D"),zZ=eQ(RZ),VZ=eQ(J$),LZ(UZ=FZ((n_((GZ=class extends Nm{constructor(...t){super(...t),i_(this,"enabledContactListener",HZ,this),i_(this,"bullet",kZ,this),i_(this,"awakeOnLoad",jZ,this),this._body=null,i_(this,"_group",WZ,this),i_(this,"_type",qZ,this),i_(this,"_allowSleep",XZ,this),i_(this,"_gravityScale",YZ,this),i_(this,"_linearDamping",KZ,this),i_(this,"_angularDamping",JZ,this),i_(this,"_linearVelocity",$Z,this),i_(this,"_angularVelocity",ZZ,this),i_(this,"_fixedRotation",QZ,this)}get group(){return this._group}set group(t){this._group=t}get type(){return this._type}set type(t){this._type=t,this._body&&(t===J$.Animated?this._body.setType(J$.Kinematic):this._body.setType(t))}get allowSleep(){return this._allowSleep}set allowSleep(t){this._allowSleep=t,this._body&&this._body.setAllowSleep(t)}get gravityScale(){return this._gravityScale}set gravityScale(t){this._gravityScale=t,this._body&&this._body.setGravityScale(t)}get linearDamping(){return this._linearDamping}set linearDamping(t){this._linearDamping=t,this._body&&this._body.setLinearDamping(t)}get angularDamping(){return this._angularDamping}set angularDamping(t){this._angularDamping=t,this._body&&this._body.setAngularDamping(t)}get linearVelocity(){return this._body&&this._body.getLinearVelocity(this._linearVelocity),this._linearVelocity}set linearVelocity(t){this._linearVelocity=t,this._body&&this._body.setLinearVelocity(t)}get angularVelocity(){return this._body&&(this._angularVelocity=this._body.getAngularVelocity()),this._angularVelocity}set angularVelocity(t){this._angularVelocity=t,this._body&&this._body.setAngularVelocity(t)}get fixedRotation(){return this._fixedRotation}set fixedRotation(t){this._fixedRotation=t,this._body&&this._body.setFixedRotation(t)}isAwake(){return!!this._body&&this._body.isAwake}wakeUp(){this._body&&this._body.wakeUp()}sleep(){this._body&&this._body.sleep()}getMass(){return this._body?this._body.getMass():0}applyForce(t,e,i){this._body&&this._body.applyForce(t,e,i)}applyForceToCenter(t,e){this._body&&this._body.applyForceToCenter(t,e)}applyTorque(t,e){this._body&&this._body.applyTorque(t,e)}applyLinearImpulse(t,e,i){this._body&&this._body.applyLinearImpulse(t,e,i)}applyLinearImpulseToCenter(t,e){this._body&&this._body.applyLinearImpulseToCenter(t,e)}applyAngularImpulse(t,e){this._body&&this._body.applyAngularImpulse(t,e)}getLinearVelocityFromWorldPoint(t,e){return this._body?this._body.getLinearVelocityFromWorldPoint(t,e):e}getLocalVector(t,e){return this._body?this._body.getLocalVector(t,e):e}getWorldVector(t,e){return this._body?this._body.getWorldVector(t,e):e}getLocalPoint(t,e){return this._body?this._body.getLocalPoint(t,e):e}getWorldPoint(t,e){return this._body?this._body.getWorldPoint(t,e):e}getLocalCenter(t){return this._body?this._body.getLocalCenter(t):t}getWorldCenter(t){return this._body?this._body.getWorldCenter(t):t}getInertia(){return this._body&&this._body.getInertia(),0}onLoad(){this._body=n._global.CC_PHYSICS_2D_BUILTIN?AZ:new H$.RigidBody,this._body.initialize(this)}onEnable(){this._body&&this._body.onEnable()}onDisable(){this._body&&this._body.onDisable()}onDestroy(){this._body&&this._body.onDestroy()}get impl(){return this._body}}).prototype,"group",[zZ],Object.getOwnPropertyDescriptor(GZ.prototype,"group"),GZ.prototype),HZ=n_(GZ.prototype,"enabledContactListener",[tQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kZ=n_(GZ.prototype,"bullet",[tQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),n_(GZ.prototype,"type",[VZ],Object.getOwnPropertyDescriptor(GZ.prototype,"type"),GZ.prototype),n_(GZ.prototype,"allowSleep",[tQ],Object.getOwnPropertyDescriptor(GZ.prototype,"allowSleep"),GZ.prototype),n_(GZ.prototype,"gravityScale",[tQ],Object.getOwnPropertyDescriptor(GZ.prototype,"gravityScale"),GZ.prototype),n_(GZ.prototype,"linearDamping",[tQ],Object.getOwnPropertyDescriptor(GZ.prototype,"linearDamping"),GZ.prototype),n_(GZ.prototype,"angularDamping",[tQ],Object.getOwnPropertyDescriptor(GZ.prototype,"angularDamping"),GZ.prototype),n_(GZ.prototype,"linearVelocity",[tQ],Object.getOwnPropertyDescriptor(GZ.prototype,"linearVelocity"),GZ.prototype),n_(GZ.prototype,"angularVelocity",[tQ],Object.getOwnPropertyDescriptor(GZ.prototype,"angularVelocity"),GZ.prototype),n_(GZ.prototype,"fixedRotation",[tQ],Object.getOwnPropertyDescriptor(GZ.prototype,"fixedRotation"),GZ.prototype),jZ=n_(GZ.prototype,"awakeOnLoad",[tQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),WZ=n_(GZ.prototype,"_group",[tQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return RZ.DEFAULT}}),qZ=n_(GZ.prototype,"_type",[tQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return J$.Dynamic}}),XZ=n_(GZ.prototype,"_allowSleep",[tQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),YZ=n_(GZ.prototype,"_gravityScale",[tQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),KZ=n_(GZ.prototype,"_linearDamping",[tQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JZ=n_(GZ.prototype,"_angularDamping",[tQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$Z=n_(GZ.prototype,"_linearVelocity",[tQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti}}),ZZ=n_(GZ.prototype,"_angularVelocity",[tQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QZ=n_(GZ.prototype,"_fixedRotation",[tQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UZ=GZ))||UZ)||UZ));var sQ,rQ,oQ,aQ,lQ,cQ,hQ,_Q,uQ,mQ,dQ,pQ,fQ;let gQ=t("Collider2D",(sQ=u_("cc.Collider2D"),rQ=H_(RZ),sQ((fQ=class extends($i(Nm)){constructor(...t){super(...t),i_(this,"editing",lQ,this),i_(this,"tag",cQ,this),this.TYPE=$$.None,this._shape=null,this._body=null,i_(this,"_group",hQ,this),i_(this,"_density",_Q,this),i_(this,"_sensor",uQ,this),i_(this,"_friction",mQ,this),i_(this,"_restitution",dQ,this),i_(this,"_offset",pQ,this)}get group(){return this._group}set group(t){this._group=t,this._shape&&this._shape.onGroupChanged&&this._shape.onGroupChanged()}get density(){return this._density}set density(t){this._density=t}get sensor(){return this._sensor}set sensor(t){this._sensor=t}get friction(){return this._friction}set friction(t){this._friction=t}get restitution(){return this._restitution}set restitution(t){this._restitution=t}get offset(){return this._offset}set offset(t){this._offset=t}get body(){return this._body}get impl(){return this._shape}onLoad(){this._shape=function(t){return CZ.INITED||(CZ.INITED=!0,CZ[$$.BOX]=function(){return new H$.BoxShape},CZ[$$.CIRCLE]=function(){return new H$.CircleShape},CZ[$$.POLYGON]=function(){return new H$.PolygonShape}),CZ[t]()}(this.TYPE),this._shape.initialize(this),this._shape.onLoad&&this._shape.onLoad(),this._body=this.getComponent(nQ)}onEnable(){this._shape&&this._shape.onEnable()}onDisable(){this._shape&&this._shape.onDisable&&this._shape.onDisable()}onDestroy(){this._shape&&this._shape.onDestroy&&this._shape.onDestroy()}apply(){this._shape&&this._shape.apply&&this._shape.apply()}get worldAABB(){return this._shape?this._shape.worldAABB:new Oi}},lQ=n_((aQ=fQ).prototype,"editing",[w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cQ=n_(aQ.prototype,"tag",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n_(aQ.prototype,"group",[rQ],Object.getOwnPropertyDescriptor(aQ.prototype,"group"),aQ.prototype),n_(aQ.prototype,"density",[f_],Object.getOwnPropertyDescriptor(aQ.prototype,"density"),aQ.prototype),n_(aQ.prototype,"sensor",[f_],Object.getOwnPropertyDescriptor(aQ.prototype,"sensor"),aQ.prototype),n_(aQ.prototype,"friction",[f_],Object.getOwnPropertyDescriptor(aQ.prototype,"friction"),aQ.prototype),n_(aQ.prototype,"restitution",[f_],Object.getOwnPropertyDescriptor(aQ.prototype,"restitution"),aQ.prototype),n_(aQ.prototype,"offset",[f_],Object.getOwnPropertyDescriptor(aQ.prototype,"offset"),aQ.prototype),hQ=n_(aQ.prototype,"_group",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return RZ.DEFAULT}}),_Q=n_(aQ.prototype,"_density",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),uQ=n_(aQ.prototype,"_sensor",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mQ=n_(aQ.prototype,"_friction",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.2}}),dQ=n_(aQ.prototype,"_restitution",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pQ=n_(aQ.prototype,"_offset",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti}}),oQ=aQ))||oQ));var yQ,vQ,xQ,SQ,AQ,CQ,bQ,TQ,wQ,EQ,PQ,IQ,DQ,RQ,MQ,BQ,OQ,NQ,LQ,FQ,zQ,VQ;t("BoxCollider2D",u_("cc.BoxCollider2D")(yQ=S_()((xQ=n_((vQ=class extends gQ{constructor(...t){super(...t),i_(this,"_size",xQ,this),this.TYPE=$$.BOX}get size(){return this._size}set size(t){this._size=t}get worldPoints(){return this._shape?this._shape.worldPoints:[]}}).prototype,"_size",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(1,1)}}),n_(vQ.prototype,"size",[f_],Object.getOwnPropertyDescriptor(vQ.prototype,"size"),vQ.prototype),yQ=vQ))||yQ)||yQ),t("CircleCollider2D",u_("cc.CircleCollider2D")(SQ=S_()((CQ=n_((AQ=class extends gQ{constructor(...t){super(...t),i_(this,"_radius",CQ,this),this.TYPE=$$.CIRCLE}get radius(){return this._radius}set radius(t){this._radius=t<0?0:t}get worldPosition(){return this._shape?this._shape.worldPosition:new Ti}get worldRadius(){return this._shape?this._shape.worldRadius:0}}).prototype,"_radius",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),n_(AQ.prototype,"radius",[f_],Object.getOwnPropertyDescriptor(AQ.prototype,"radius"),AQ.prototype),SQ=AQ))||SQ)||SQ),t("PolygonCollider2D",(bQ=u_("cc.PolygonCollider2D"),TQ=S_(),wQ=f_({serializable:!1}),EQ=f_({type:Ti}),bQ(PQ=TQ((DQ=n_((IQ=class extends gQ{constructor(...t){super(...t),i_(this,"threshold",DQ,this),i_(this,"_points",RQ,this),this.TYPE=$$.POLYGON}get points(){return this._points}set points(t){this._points=t}get worldPoints(){return this._shape?this._shape.worldPoints:[]}}).prototype,"threshold",[wQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),RQ=n_(IQ.prototype,"_points",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new Ti(-1,-1),new Ti(1,-1),new Ti(1,1),new Ti(-1,1)]}}),n_(IQ.prototype,"points",[EQ],Object.getOwnPropertyDescriptor(IQ.prototype,"points"),IQ.prototype),PQ=IQ))||PQ)||PQ));let UQ=t("Joint2D",(MQ=u_("cc.Joint2D"),BQ=H_(nQ),MQ((LQ=n_((NQ=class extends Nm{constructor(...t){super(...t),i_(this,"anchor",LQ,this),i_(this,"connectedAnchor",FQ,this),i_(this,"collideConnected",zQ,this),i_(this,"connectedBody",VQ,this),this._body=null,this._joint=null,this.TYPE=Z$.None}get body(){return this._body}get impl(){return this._joint}onLoad(){this._joint=function(t){return function(){if(bZ.INITED)return;bZ.INITED=!0;const t=n._global.CC_PHYSICS_2D_BUILTIN;bZ[Z$.SPRING]=function(){return t?TZ:new H$.SpringJoint},bZ[Z$.DISTANCE]=function(){return t?TZ:new H$.DistanceJoint},bZ[Z$.FIXED]=function(){return t?TZ:new H$.FixedJoint},bZ[Z$.MOUSE]=function(){return t?TZ:new H$.MouseJoint},bZ[Z$.RELATIVE]=function(){return t?TZ:new H$.RelativeJoint},bZ[Z$.SLIDER]=function(){return t?TZ:new H$.SliderJoint},bZ[Z$.WHEEL]=function(){return t?TZ:new H$.WheelJoint},bZ[Z$.HINGE]=function(){return t?TZ:new H$.HingeJoint}}(),bZ[t]()}(this.TYPE),this._joint.initialize(this),this._body=this.getComponent(nQ)}onEnable(){this._joint&&this._joint.onEnable&&this._joint.onEnable()}onDisable(){this._joint&&this._joint.onDisable&&this._joint.onDisable()}start(){this._joint&&this._joint.start&&this._joint.start()}onDestroy(){this._joint&&this._joint.onDestroy&&this._joint.onDestroy()}}).prototype,"anchor",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti}}),FQ=n_(NQ.prototype,"connectedAnchor",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti}}),zQ=n_(NQ.prototype,"collideConnected",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),VQ=n_(NQ.prototype,"connectedBody",[BQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OQ=NQ))||OQ));var GQ,HQ,kQ,jQ,WQ,qQ,XQ,YQ,KQ,JQ,$Q,ZQ,QQ,t0,e0,i0,n0,s0,r0,o0,a0,l0,c0;t("DistanceJoint2D",u_("cc.DistanceJoint2D")(GQ=S_()((n_((HQ=class extends UQ{constructor(...t){super(...t),this.TYPE=Z$.DISTANCE,i_(this,"_maxLength",kQ,this),i_(this,"_autoCalcDistance",jQ,this)}get maxLength(){return this._autoCalcDistance&&this.connectedBody?oi.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._maxLength}set maxLength(t){this._maxLength=t,this._joint&&this._joint.setMaxLength(t)}get autoCalcDistance(){return this._autoCalcDistance}set autoCalcDistance(t){this._autoCalcDistance=t}}).prototype,"maxLength",[f_],Object.getOwnPropertyDescriptor(HQ.prototype,"maxLength"),HQ.prototype),n_(HQ.prototype,"autoCalcDistance",[f_],Object.getOwnPropertyDescriptor(HQ.prototype,"autoCalcDistance"),HQ.prototype),kQ=n_(HQ.prototype,"_maxLength",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),jQ=n_(HQ.prototype,"_autoCalcDistance",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),GQ=HQ))||GQ)||GQ),t("SpringJoint2D",u_("cc.SpringJoint2D")(WQ=S_()((n_((qQ=class extends UQ{constructor(...t){super(...t),this.TYPE=Z$.SPRING,i_(this,"_frequency",XQ,this),i_(this,"_dampingRatio",YQ,this),i_(this,"_distance",KQ,this),i_(this,"_autoCalcDistance",JQ,this)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}get dampingRatio(){return this._dampingRatio}set dampingRatio(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}get distance(){return this._autoCalcDistance&&this.connectedBody?oi.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._distance}set distance(t){this._distance=t,this._joint&&this._joint.setDistance(t)}get autoCalcDistance(){return this._autoCalcDistance}set autoCalcDistance(t){this._autoCalcDistance=t}}).prototype,"frequency",[f_],Object.getOwnPropertyDescriptor(qQ.prototype,"frequency"),qQ.prototype),n_(qQ.prototype,"dampingRatio",[f_],Object.getOwnPropertyDescriptor(qQ.prototype,"dampingRatio"),qQ.prototype),n_(qQ.prototype,"distance",[f_],Object.getOwnPropertyDescriptor(qQ.prototype,"distance"),qQ.prototype),n_(qQ.prototype,"autoCalcDistance",[f_],Object.getOwnPropertyDescriptor(qQ.prototype,"autoCalcDistance"),qQ.prototype),XQ=n_(qQ.prototype,"_frequency",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),YQ=n_(qQ.prototype,"_dampingRatio",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),KQ=n_(qQ.prototype,"_distance",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),JQ=n_(qQ.prototype,"_autoCalcDistance",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),WQ=qQ))||WQ)||WQ),t("MouseJoint2D",u_("cc.MouseJoint2D")($Q=S_()((n_((ZQ=class extends UQ{constructor(...t){super(...t),this.TYPE=Z$.MOUSE,i_(this,"_maxForce",QQ,this),i_(this,"_dampingRatio",t0,this),i_(this,"_frequency",e0,this),this._target=new Ti}get target(){return this._target}set target(t){this._target=t,this._joint&&this._joint.setTarget(t)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}get dampingRatio(){return this._dampingRatio}set dampingRatio(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}get maxForce(){return this._maxForce}set maxForce(t){this._maxForce=t,this._joint&&this._joint.setMaxForce(t)}update(t){this._joint.update(t)}}).prototype,"frequency",[f_],Object.getOwnPropertyDescriptor(ZQ.prototype,"frequency"),ZQ.prototype),n_(ZQ.prototype,"dampingRatio",[f_],Object.getOwnPropertyDescriptor(ZQ.prototype,"dampingRatio"),ZQ.prototype),n_(ZQ.prototype,"maxForce",[f_],Object.getOwnPropertyDescriptor(ZQ.prototype,"maxForce"),ZQ.prototype),QQ=n_(ZQ.prototype,"_maxForce",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),t0=n_(ZQ.prototype,"_dampingRatio",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),e0=n_(ZQ.prototype,"_frequency",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),$Q=ZQ))||$Q)||$Q);const h0=new oi,_0=new oi;var u0,m0,d0,p0,f0,g0,y0,v0,x0,S0;t("RelativeJoint2D",u_("cc.RelativeJoint2D")(i0=S_()((n_((n0=class extends UQ{constructor(...t){super(...t),this.TYPE=Z$.RELATIVE,i_(this,"_maxForce",s0,this),i_(this,"_maxTorque",r0,this),i_(this,"_correctionFactor",o0,this),i_(this,"_angularOffset",a0,this),i_(this,"_linearOffset",l0,this),i_(this,"_autoCalcOffset",c0,this)}get maxForce(){return this._maxForce}set maxForce(t){this._maxForce=t,this._joint&&this._joint.setMaxForce(t)}get maxTorque(){return this._maxTorque}set maxTorque(t){this._maxTorque=t,this._joint&&this._joint.setMaxTorque(t)}get correctionFactor(){return this._correctionFactor}set correctionFactor(t){this._correctionFactor=t,this._joint&&this._joint.setCorrectionFactor(t)}get linearOffset(){return this._autoCalcOffset&&this.connectedBody?Ti.subtract(this._linearOffset,this.connectedBody.node.worldPosition,this.node.worldPosition):this._linearOffset}set linearOffset(t){this._linearOffset.set(t),this._joint&&this._joint.setLinearOffset(t)}get angularOffset(){return this._autoCalcOffset&&this.connectedBody&&(mi.toEuler(h0,this.node.worldRotation),mi.toEuler(_0,this.connectedBody.node.worldRotation),this._angularOffset=_0.z-h0.z),this._angularOffset}set angularOffset(t){this._angularOffset=t,this._joint&&this._joint.setAngularOffset(t)}get autoCalcOffset(){return this._autoCalcOffset}set autoCalcOffset(t){this._autoCalcOffset=t}}).prototype,"maxForce",[f_],Object.getOwnPropertyDescriptor(n0.prototype,"maxForce"),n0.prototype),n_(n0.prototype,"maxTorque",[f_],Object.getOwnPropertyDescriptor(n0.prototype,"maxTorque"),n0.prototype),n_(n0.prototype,"correctionFactor",[f_],Object.getOwnPropertyDescriptor(n0.prototype,"correctionFactor"),n0.prototype),n_(n0.prototype,"linearOffset",[f_],Object.getOwnPropertyDescriptor(n0.prototype,"linearOffset"),n0.prototype),n_(n0.prototype,"angularOffset",[f_],Object.getOwnPropertyDescriptor(n0.prototype,"angularOffset"),n0.prototype),n_(n0.prototype,"autoCalcOffset",[f_],Object.getOwnPropertyDescriptor(n0.prototype,"autoCalcOffset"),n0.prototype),s0=n_(n0.prototype,"_maxForce",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),r0=n_(n0.prototype,"_maxTorque",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),o0=n_(n0.prototype,"_correctionFactor",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),a0=n_(n0.prototype,"_angularOffset",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),l0=n_(n0.prototype,"_linearOffset",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti}}),c0=n_(n0.prototype,"_autoCalcOffset",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),i0=n0))||i0)||i0);const A0=new Ti;var C0,b0,T0,w0,E0,P0,I0,D0,R0,M0,B0,O0,N0,L0,F0,z0,V0,U0,G0,H0;t("SliderJoint2D",u_("cc.SliderJoint2D")(u0=S_()((n_((m0=class extends UQ{constructor(...t){super(...t),this.TYPE=Z$.SLIDER,i_(this,"_angle",d0,this),i_(this,"_autoCalcAngle",p0,this),i_(this,"_enableMotor",f0,this),i_(this,"_maxMotorForce",g0,this),i_(this,"_motorSpeed",y0,this),i_(this,"_enableLimit",v0,this),i_(this,"_lowerLimit",x0,this),i_(this,"_upperLimit",S0,this)}get angle(){return this._autoCalcAngle&&this.connectedBody&&(Ti.subtract(A0,this.connectedBody.node.worldPosition,this.node.worldPosition),this._angle=je(Math.atan2(A0.y,A0.x))),this._angle}set angle(t){this._angle=t}get autoCalcAngle(){return this._autoCalcAngle}set autoCalcAngle(t){this._autoCalcAngle=t}get enableMotor(){return this._enableMotor}set enableMotor(t){this._enableMotor=t}get maxMotorForce(){return this._maxMotorForce}set maxMotorForce(t){this._maxMotorForce=t,this._joint&&this._joint.setMaxMotorForce(t)}get motorSpeed(){return this._motorSpeed}set motorSpeed(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}get enableLimit(){return this._enableLimit}set enableLimit(t){this._enableLimit=t}get lowerLimit(){return this._lowerLimit}set lowerLimit(t){this._lowerLimit=t,this._joint&&this._joint.setLowerLimit(t)}get upperLimit(){return this._upperLimit}set upperLimit(t){this._upperLimit=t,this._joint&&this._joint.setUpperLimit(t)}}).prototype,"angle",[f_],Object.getOwnPropertyDescriptor(m0.prototype,"angle"),m0.prototype),n_(m0.prototype,"autoCalcAngle",[f_],Object.getOwnPropertyDescriptor(m0.prototype,"autoCalcAngle"),m0.prototype),n_(m0.prototype,"enableMotor",[f_],Object.getOwnPropertyDescriptor(m0.prototype,"enableMotor"),m0.prototype),n_(m0.prototype,"maxMotorForce",[f_],Object.getOwnPropertyDescriptor(m0.prototype,"maxMotorForce"),m0.prototype),n_(m0.prototype,"motorSpeed",[f_],Object.getOwnPropertyDescriptor(m0.prototype,"motorSpeed"),m0.prototype),n_(m0.prototype,"enableLimit",[f_],Object.getOwnPropertyDescriptor(m0.prototype,"enableLimit"),m0.prototype),n_(m0.prototype,"lowerLimit",[f_],Object.getOwnPropertyDescriptor(m0.prototype,"lowerLimit"),m0.prototype),n_(m0.prototype,"upperLimit",[f_],Object.getOwnPropertyDescriptor(m0.prototype,"upperLimit"),m0.prototype),d0=n_(m0.prototype,"_angle",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),p0=n_(m0.prototype,"_autoCalcAngle",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),f0=n_(m0.prototype,"_enableMotor",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),g0=n_(m0.prototype,"_maxMotorForce",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),y0=n_(m0.prototype,"_motorSpeed",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),v0=n_(m0.prototype,"_enableLimit",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),x0=n_(m0.prototype,"_lowerLimit",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S0=n_(m0.prototype,"_upperLimit",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),u0=m0))||u0)||u0),t("FixedJoint2D",u_("cc.FixedJoint2D")(C0=S_()((n_((b0=class extends UQ{constructor(...t){super(...t),this.TYPE=Z$.FIXED,i_(this,"_frequency",T0,this),i_(this,"_dampingRatio",w0,this)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}get dampingRatio(){return this._dampingRatio}set dampingRatio(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}}).prototype,"frequency",[f_],Object.getOwnPropertyDescriptor(b0.prototype,"frequency"),b0.prototype),n_(b0.prototype,"dampingRatio",[f_],Object.getOwnPropertyDescriptor(b0.prototype,"dampingRatio"),b0.prototype),T0=n_(b0.prototype,"_frequency",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),w0=n_(b0.prototype,"_dampingRatio",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),C0=b0))||C0)||C0),t("WheelJoint2D",u_("cc.WheelJoint2D")(E0=S_()((n_((P0=class extends UQ{constructor(...t){super(...t),this.TYPE=Z$.WHEEL,i_(this,"_angle",I0,this),i_(this,"_enableMotor",D0,this),i_(this,"_maxMotorTorque",R0,this),i_(this,"_motorSpeed",M0,this),i_(this,"_frequency",B0,this),i_(this,"_dampingRatio",O0,this)}get angle(){return this._angle}set angle(t){this._angle=t}get enableMotor(){return this._enableMotor}set enableMotor(t){this._enableMotor=t,this._joint&&this._joint.enableMotor(t)}get maxMotorTorque(){return this._maxMotorTorque}set maxMotorTorque(t){this._maxMotorTorque=t,this._joint&&this._joint.setMaxMotorTorque(t)}get motorSpeed(){return this._motorSpeed}set motorSpeed(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}get dampingRatio(){return this._dampingRatio}set dampingRatio(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}}).prototype,"angle",[f_],Object.getOwnPropertyDescriptor(P0.prototype,"angle"),P0.prototype),n_(P0.prototype,"enableMotor",[f_],Object.getOwnPropertyDescriptor(P0.prototype,"enableMotor"),P0.prototype),n_(P0.prototype,"maxMotorTorque",[f_],Object.getOwnPropertyDescriptor(P0.prototype,"maxMotorTorque"),P0.prototype),n_(P0.prototype,"motorSpeed",[f_],Object.getOwnPropertyDescriptor(P0.prototype,"motorSpeed"),P0.prototype),n_(P0.prototype,"frequency",[f_],Object.getOwnPropertyDescriptor(P0.prototype,"frequency"),P0.prototype),n_(P0.prototype,"dampingRatio",[f_],Object.getOwnPropertyDescriptor(P0.prototype,"dampingRatio"),P0.prototype),I0=n_(P0.prototype,"_angle",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),D0=n_(P0.prototype,"_enableMotor",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),R0=n_(P0.prototype,"_maxMotorTorque",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),M0=n_(P0.prototype,"_motorSpeed",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),B0=n_(P0.prototype,"_frequency",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),O0=n_(P0.prototype,"_dampingRatio",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),E0=P0))||E0)||E0),t("HingeJoint2D",u_("cc.HingeJoint2D")(N0=S_()((n_((L0=class extends UQ{constructor(...t){super(...t),this.TYPE=Z$.HINGE,i_(this,"_enableLimit",F0,this),i_(this,"_lowerAngle",z0,this),i_(this,"_upperAngle",V0,this),i_(this,"_enableMotor",U0,this),i_(this,"_maxMotorTorque",G0,this),i_(this,"_motorSpeed",H0,this)}get enableLimit(){return this._enableLimit}set enableLimit(t){this._enableLimit=t}get lowerAngle(){return this._lowerAngle}set lowerAngle(t){this._lowerAngle=t,this._joint&&this._joint.setLowerAngle(t)}get upperAngle(){return this._upperAngle}set upperAngle(t){this._upperAngle=t,this._joint&&this._joint.setUpperAngle(t)}get enableMotor(){return this._enableMotor}set enableMotor(t){this._enableMotor=t,this._joint&&this._joint.enableMotor(t)}get maxMotorTorque(){return this._maxMotorTorque}set maxMotorTorque(t){this._maxMotorTorque=t,this._joint&&this._joint.setMaxMotorTorque(t)}get motorSpeed(){return this._motorSpeed}set motorSpeed(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}}).prototype,"enableLimit",[f_],Object.getOwnPropertyDescriptor(L0.prototype,"enableLimit"),L0.prototype),n_(L0.prototype,"lowerAngle",[f_],Object.getOwnPropertyDescriptor(L0.prototype,"lowerAngle"),L0.prototype),n_(L0.prototype,"upperAngle",[f_],Object.getOwnPropertyDescriptor(L0.prototype,"upperAngle"),L0.prototype),n_(L0.prototype,"enableMotor",[f_],Object.getOwnPropertyDescriptor(L0.prototype,"enableMotor"),L0.prototype),n_(L0.prototype,"maxMotorTorque",[f_],Object.getOwnPropertyDescriptor(L0.prototype,"maxMotorTorque"),L0.prototype),n_(L0.prototype,"motorSpeed",[f_],Object.getOwnPropertyDescriptor(L0.prototype,"motorSpeed"),L0.prototype),F0=n_(L0.prototype,"_enableLimit",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),z0=n_(L0.prototype,"_lowerAngle",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),V0=n_(L0.prototype,"_upperAngle",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),U0=n_(L0.prototype,"_enableMotor",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),G0=n_(L0.prototype,"_maxMotorTorque",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),H0=n_(L0.prototype,"_motorSpeed",[f_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),N0=L0))||N0)||N0),t("Physics2DUtils",{PolygonSeparator:xZ});class k0 extends K$.RayCastCallback{constructor(...t){super(...t),this._type=Q$.Closest,this._fixtures=[],this._points=[],this._normals=[],this._fractions=[],this._mask=4294967295}init(t,e){this._type=t,this._mask=e,this._fixtures.length=0,this._points.length=0,this._normals.length=0,this._fractions.length=0}ReportFixture(t,e,i,n){return 0==(t.GetFilterData().categoryBits&this._mask)?0:this._type===Q$.Closest?(this._fixtures[0]=t,this._points[0]=e,this._normals[0]=i,this._fractions[0]=n,n):(this._fixtures.push(t),this._points.push(new Ti(e.x,e.y)),this._normals.push(new Ti(i.x,i.y)),this._fractions.push(n),this._type===Q$.Any?0:this._type>=Q$.All?1:n)}getFixtures(){return this._fixtures}getPoints(){return this._points}getNormals(){return this._normals}getFractions(){return this._fractions}}const j0=[],W0=[new Ti,new Ti],q0=new K$.WorldManifold,X0={points:[],separations:[],normal:new Ti};class Y0{constructor(){this.localPoint=new Ti,this.normalImpulse=0,this.tangentImpulse=0}}const K0=[new Y0,new Y0],J0={type:0,localPoint:new Ti,localNormal:new Ti,points:[]},$0={normalImpulses:[],tangentImpulses:[]};class Z0{constructor(){this.colliderA=null,this.colliderB=null,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=null}static get(t){let e=j0.pop();return e||(e=new Z0),e.init(t),e}static put(t){const e=t.m_userData;e&&(j0.push(e),e.reset())}_setImpulse(t){this._impulse=t}init(t){this.colliderA=t.m_fixtureA.m_userData.collider,this.colliderB=t.m_fixtureB.m_userData.collider,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=t,t.m_userData=this}reset(){this.setTangentSpeed(0),this.resetFriction(),this.resetRestitution(),this.colliderA=null,this.colliderB=null,this.disabled=!1,this._impulse=null,this._b2contact.m_userData=null,this._b2contact=null}getWorldManifold(){const t=X0.points,e=X0.separations,i=X0.normal;this._b2contact.GetWorldManifold(q0);const n=q0.points,s=q0.separations,r=this._b2contact.GetManifold().pointCount;t.length=e.length=r;for(let i=0;i<r;i++){const r=W0[i];r.x=n[i].x*iZ,r.y=n[i].y*iZ,t[i]=r,e[i]=s[i]*iZ}return i.x=q0.normal.x,i.y=q0.normal.y,this._inverted&&(i.x*=-1,i.y*=-1),X0}getManifold(){const t=J0.points,e=J0.localNormal,i=J0.localPoint,n=this._b2contact.GetManifold(),s=n.points,r=t.length=n.pointCount;for(let e=0;e<r;e++){const i=K0[e],n=s[e];i.localPoint.x=n.localPoint.x*iZ,i.localPoint.y=n.localPoint.y*iZ,i.normalImpulse=n.normalImpulse*iZ,i.tangentImpulse=n.tangentImpulse,t[e]=i}return i.x=n.localPoint.x*iZ,i.y=n.localPoint.y*iZ,e.x=n.localNormal.x,e.y=n.localNormal.y,J0.type=n.type,this._inverted&&(e.x*=-1,e.y*=-1),J0}getImpulse(){const t=this._impulse;if(!t)return null;const e=$0.normalImpulses,i=$0.tangentImpulses,n=t.count;for(let s=0;s<n;s++)e[s]=t.normalImpulses[s]*iZ,i[s]=t.tangentImpulses[s];return i.length=e.length=n,$0}emit(t){const e=this.colliderA,i=this.colliderB,n=e.body,s=i.body;n.enabledContactListener&&(null==e||e.emit(t,e,i,this)),s.enabledContactListener&&(null==i||i.emit(t,i,e,this)),(n.enabledContactListener||s.enabledContactListener)&&NZ.instance.emit(t,e,i),(this.disabled||this.disabledOnce)&&(this.setEnabled(!1),this.disabledOnce=!1)}setEnabled(t){this._b2contact.SetEnabled(t)}isTouching(){return this._b2contact.IsTouching()}setTangentSpeed(t){this._b2contact.SetTangentSpeed(t)}getTangentSpeed(){return this._b2contact.GetTangentSpeed()}setFriction(t){this._b2contact.SetFriction(t)}getFriction(){return this._b2contact.GetFriction()}resetFriction(){return this._b2contact.ResetFriction()}setRestitution(t){this._b2contact.SetRestitution(t)}getRestitution(){return this._b2contact.GetRestitution()}resetRestitution(){return this._b2contact.ResetRestitution()}}const Q0=new K$.Vec2,t1=new si,e1=si.GREEN,i1=si.RED;class n1 extends K$.Draw{constructor(t){super(),this._drawer=null,this._xf=new K$.Transform,this._dxf=new K$.Transform,this._drawer=t}_DrawPolygon(t,e){const i=this._drawer;for(let n=0;n<e;n++){K$.Transform.MulXV(this._xf,t[n],Q0);const e=Q0.x*iZ,s=Q0.y*iZ;0===n?i.moveTo(e,s):i.lineTo(e,s)}i.close()}DrawPolygon(t,e,i){this._applyStrokeColor(i),this._DrawPolygon(t,e),this._drawer.stroke()}DrawSolidPolygon(t,e,i){this._applyFillColor(i),this._DrawPolygon(t,e),this._drawer.fill(),this._drawer.stroke()}_DrawCircle(t,e){const i=this._xf.p;this._drawer.circle((t.x+i.x)*iZ,(t.y+i.y)*iZ,e*iZ)}DrawCircle(t,e,i){this._applyStrokeColor(i),this._DrawCircle(t,e),this._drawer.stroke()}DrawSolidCircle(t,e,i,n){this._applyFillColor(n),this._DrawCircle(t,e),this._drawer.fill()}DrawSegment(t,e,i){const n=this._drawer;if(t.x===e.x&&t.y===e.y)return this._applyFillColor(i),this._DrawCircle(t,2/iZ),void n.fill();this._applyStrokeColor(i),K$.Transform.MulXV(this._xf,t,Q0),n.moveTo(Q0.x*iZ,Q0.y*iZ),K$.Transform.MulXV(this._xf,e,Q0),n.lineTo(Q0.x*iZ,Q0.y*iZ),n.stroke()}DrawTransform(t){const e=this._drawer;e.strokeColor=i1,Q0.x=Q0.y=0,K$.Transform.MulXV(t,Q0,Q0),e.moveTo(Q0.x*iZ,Q0.y*iZ),Q0.x=1,Q0.y=0,K$.Transform.MulXV(t,Q0,Q0),e.lineTo(Q0.x*iZ,Q0.y*iZ),e.stroke(),e.strokeColor=e1,Q0.x=Q0.y=0,K$.Transform.MulXV(t,Q0,Q0),e.moveTo(Q0.x*iZ,Q0.y*iZ),Q0.x=0,Q0.y=1,K$.Transform.MulXV(t,Q0,Q0),e.lineTo(Q0.x*iZ,Q0.y*iZ),e.stroke()}DrawPoint(t,e,i){}DrawParticles(){}_applyStrokeColor(t){this._drawer.strokeColor=t1.set(255*t.r,255*t.g,255*t.b,150)}_applyFillColor(t){this._drawer.fillColor=t1.set(255*t.r,255*t.g,255*t.b,150)}PushTransform(t){this._xf=t}PopTransform(){this._xf=this._dxf}}const s1=new oi,r1=new Ti,o1=new Ti,a1=new K$.BodyDef,l1=new K$.AABB,c1=[];new oi;const h1=new K$.Vec2,_1=new K$.Filter;function u1(t){const e=t.collider;return _1.categoryBits=e.group===RZ.DEFAULT?e.body.group:e.group,_1.maskBits=NZ.instance.collisionMatrix[_1.categoryBits],_1}class m1{constructor(){this._shapes=[],this._fixtures=[],this._collider=null,this._body=null,this._inited=!1,this._rect=new Oi}get impl(){return this._shapes}get collider(){return this._collider}initialize(t){this._collider=t}onLoad(){}onEnable(){NZ.instance._callAfterStep(this,this._init)}onDisable(){NZ.instance._callAfterStep(this,this._destroy)}start(){}onGroupChanged(){const t=u1(this);this._fixtures.forEach((e=>{e.SetFilterData(t)}))}apply(){this._destroy(),this._init()}get worldAABB(){const t=1e7;let e=t,i=t,n=-t,s=-t;const r=this._fixtures;for(let t=0;t<r.length;t++){const o=r[t],a=o.GetShape().GetChildCount();for(let t=0;t<a;t++){const r=o.GetAABB(t);r.lowerBound.x<e&&(e=r.lowerBound.x),r.lowerBound.y<i&&(i=r.lowerBound.y),r.upperBound.x>n&&(n=r.upperBound.x),r.upperBound.y>s&&(s=r.upperBound.y)}}e*=iZ,i*=iZ,n*=iZ,s*=iZ;const o=this._rect;return o.x=e,o.y=i,o.width=n-e,o.height=s-i,o}getFixtureIndex(t){return this._fixtures.indexOf(t)}_createShapes(t,e){return[]}_init(){var t;if(this._inited)return;const e=this.collider,i=e.getComponent(nQ);if(!i)return;const n=null===(t=i.impl)||void 0===t?void 0:t.impl;if(!n)return;const s=i.node.worldScale,r=0===s.x&&0===s.y?[]:this._createShapes(s.x,s.y),o=u1(this);for(let t=0;t<r.length;t++){const s=r[t],a={density:e.density,isSensor:e.sensor,friction:e.friction,restitution:e.restitution,shape:s,filter:o},l=n.CreateFixture(a);l.m_userData=this,i.enabledContactListener&&NZ.instance.physicsWorld.registerContactFixture(l),this._shapes.push(s),this._fixtures.push(l)}this._body=n,this._inited=!0}_destroy(){if(!this._inited)return;const t=this._fixtures,e=this._body;for(let i=t.length-1;i>=0;i--){const n=t[i];n.m_userData=null,NZ.instance.physicsWorld.unregisterContactFixture(n),e&&e.DestroyFixture(n)}this._body=null,this._fixtures.length=0,this._shapes.length=0,this._inited=!1}}const d1=new Oi;class p1{constructor(){this._b2joint=null,this._jointComp=null,this._body=null,this._inited=!1}get impl(){return this._b2joint}get comp(){return this._jointComp}get body(){return this._body}initialize(t){this._jointComp=t}onEnable(){NZ.instance._callAfterStep(this,this._init)}onDisable(){NZ.instance._callAfterStep(this,this._destroy)}start(){NZ.instance._callAfterStep(this,this._init)}_init(){if(this._inited)return;const t=this._jointComp;if(!t.isValid)return;this._body=t.getComponent(nQ);const e=this._createJointDef();if(!e)return;const i=t.connectedBody;i&&i.enabledInHierarchy&&(e.bodyA=this._body.impl.impl,e.bodyB=i.impl.impl,e.collideConnected=t.collideConnected,this._b2joint=NZ.instance.physicsWorld.impl.CreateJoint(e),this._inited=!0)}_destroy(){this._inited&&(NZ.instance.physicsWorld.impl.DestroyJoint(this._b2joint),this._b2joint=null,this._inited=!1)}_createJointDef(){return null}isValid(){return this._b2joint&&this._body&&this._body.impl&&this._jointComp&&this._jointComp.connectedBody&&this._jointComp.connectedBody.impl}}const f1=new K$.Vec2;var g1,y1;function v1(t,e,i,n){const s=(n.x-i.x)*(t.y-i.y)-(n.y-i.y)*(t.x-i.x),r=(e.x-t.x)*(t.y-i.y)-(e.y-t.y)*(t.x-i.x),o=(n.y-i.y)*(e.x-t.x)-(n.x-i.x)*(e.y-t.y);if(0!==o){const t=s/o,e=r/o;if(t>=0&&t<=1&&e>=0&&e<=1)return!0}return!1}g1="box2d",y1={PhysicsWorld:class{get impl(){return this._world}constructor(){this._world=void 0,this._bodies=[],this._animatedBodies=[],this._contactListener=void 0,this._aabbQueryCallback=void 0,this._raycastQueryCallback=void 0,this._debugGraphics=null,this._b2DebugDrawer=null,this._debugDrawFlags=0,this._world=new K$.World(new K$.Vec2(0,-10));const t=new nZ;t.setBeginContact(this._onBeginContact),t.setEndContact(this._onEndContact),t.setPreSolve(this._onPreSolve),t.setPostSolve(this._onPostSolve),this._world.SetContactListener(t),this._contactListener=t,this._aabbQueryCallback=new sZ,this._raycastQueryCallback=new k0}get debugDrawFlags(){return this._debugDrawFlags}set debugDrawFlags(t){t||this._debugGraphics&&(this._debugGraphics.node.parent=null),this._debugDrawFlags=t}_checkDebugDrawValid(){if(!this._debugGraphics||!this._debugGraphics.isValid){let t=Ab("Canvas");if(!t){const e=aT.getScene();if(!e)return;t=new uf("Canvas"),t.addComponent(DF),t.parent=e}const e=new uf("PHYSICS_2D_DEBUG_DRAW");e.hideFlags|=Gi.Flags.DontSave,e.parent=t,e.worldPosition=oi.ZERO,this._debugGraphics=e.addComponent(RN),this._debugGraphics.lineWidth=2;const i=new n1(this._debugGraphics);this._b2DebugDrawer=i,this._world.SetDebugDraw(i)}const t=this._debugGraphics.node.parent;this._debugGraphics.node.setSiblingIndex(t.children.length-1),this._b2DebugDrawer&&this._b2DebugDrawer.SetFlags(this.debugDrawFlags)}setGravity(t){this._world.SetGravity(t)}setAllowSleep(t){this._world.SetAllowSleeping(!0)}step(t,e=10,i=10){const n=this._animatedBodies;for(let e=0,i=n.length;e<i;e++)n[e].animate(t);this._world.Step(t,e,i)}raycast(t,e,i,n){if(t.equals(e))return[];i=i||Q$.Closest,r1.x=t.x/iZ,r1.y=t.y/iZ,o1.x=e.x/iZ,o1.y=e.y/iZ;const s=this._raycastQueryCallback;s.init(i,n),this._world.RayCast(s,r1,o1);const r=s.getFixtures();if(r.length>0){const t=s.getPoints(),e=s.getNormals(),n=s.getFractions(),o=[];for(let s=0,a=r.length;s<a;s++){const a=r[s],l=a.m_userData,c=l.collider;if(i===Q$.AllClosest){let i;for(let t=0;t<o.length;t++)o[t].collider===c&&(i=o[t]);if(i){n[s]<i.fraction&&(i.fixtureIndex=l.getFixtureIndex(a),i.point.x=t[s].x*iZ,i.point.y=t[s].y*iZ,i.normal.x=e[s].x,i.normal.y=e[s].y,i.fraction=n[s]);continue}}o.push({collider:c,fixtureIndex:l.getFixtureIndex(a),point:new Ti(t[s].x*iZ,t[s].y*iZ),normal:new Ti(e[s].x,e[s].y),fraction:n[s]})}return o}return[]}syncPhysicsToScene(){const t=this._bodies;for(let e=0,i=t.length;e<i;e++){const i=t[e],n=i.rigidBody;if(n.type===J$.Animated){i.resetVelocity();continue}const s=n.node,r=i.impl,o=r.GetPosition();s1.x=o.x*iZ,s1.y=o.y*iZ,s1.z=0,s.worldPosition=s1;const a=je(r.GetAngle());s.setWorldRotationFromEuler(0,0,a)}}syncSceneToPhysics(){const t=this._bodies;for(let e=0;e<t.length;e++)t[e].syncRotationToPhysics(),t[e].syncPositionToPhysics()}addBody(t){if(this._bodies.includes(t))return;const e=a1,i=t.rigidBody;e.allowSleep=i.allowSleep,e.gravityScale=i.gravityScale,e.linearDamping=i.linearDamping,e.angularDamping=i.angularDamping,e.fixedRotation=i.fixedRotation,e.bullet=i.bullet;const n=i.node,s=n.worldPosition;e.position.Set(s.x/iZ,s.y/iZ),mi.toEuler(s1,n.worldRotation),e.angle=ke(s1.z),e.awake=i.awakeOnLoad,i.type===J$.Animated?(e.type=J$.Kinematic,this._animatedBodies.push(t),t._animatedPos.set(e.position.x,e.position.y),t._animatedAngle=e.angle):e.type=i.type;const r=i,o=r._linearVelocity;e.linearVelocity.Set(o.x,o.y),e.angularVelocity=ke(r._angularVelocity);const a=this._world.CreateBody(e);a.m_userData=t,t._imp=a,this._bodies.push(t)}removeBody(t){this._bodies.includes(t)&&(t.impl&&(t.impl.m_userData=null,this._world.DestroyBody(t.impl),t._imp=null),zt.remove(this._bodies,t),t.rigidBody.type===J$.Animated&&zt.remove(this._animatedBodies,t))}registerContactFixture(t){this._contactListener.registerContactFixture(t)}unregisterContactFixture(t){this._contactListener.unregisterContactFixture(t)}testPoint(t){const e=r1.x=t.x/iZ,i=r1.y=t.y/iZ,n=.2/iZ;l1.lowerBound.x=e-n,l1.lowerBound.y=i-n,l1.upperBound.x=e+n,l1.upperBound.y=i+n;const s=this._aabbQueryCallback;s.init(r1),this._world.QueryAABB(s,l1);const r=s.getFixtures();c1.length=0;for(let t=0;t<r.length;t++){const e=r[t].m_userData.collider;c1.includes(e)||c1.push(e)}return c1}testAABB(t){l1.lowerBound.x=t.xMin/iZ,l1.lowerBound.y=t.yMin/iZ,l1.upperBound.x=t.xMax/iZ,l1.upperBound.y=t.yMax/iZ;const e=this._aabbQueryCallback;e.init(),this._world.QueryAABB(e,l1);const i=e.getFixtures();c1.length=0;for(let t=0;t<i.length;t++){const e=i[t].m_userData.collider;c1.includes(e)||c1.push(e)}return c1}drawDebug(){this._checkDebugDrawValid(),this._debugGraphics&&(this._debugGraphics.clear(),this._world.DrawDebugData())}_onBeginContact(t){Z0.get(t).emit(tZ.BEGIN_CONTACT)}_onEndContact(t){const e=t.m_userData;e&&(e.emit(tZ.END_CONTACT),Z0.put(t))}_onPreSolve(t){const e=t.m_userData;e&&e.emit(tZ.PRE_SOLVE)}_onPostSolve(t,e){const i=t.m_userData;i&&(i._setImpulse(e),i.emit(tZ.POST_SOLVE),i._setImpulse(null))}},RigidBody:class{constructor(){this._animatedPos=new Ti,this._animatedAngle=0,this._body=null,this._inited=!1}get impl(){return this._body}set _imp(t){this._body=t}get rigidBody(){return this._rigidBody}get isAwake(){return this._body.IsAwake()}get isSleeping(){return!this._body.IsAwake()}initialize(t){this._rigidBody=t,NZ.instance._callAfterStep(this,this._init)}onDestroy(){NZ.instance._callAfterStep(this,this._destroy)}onEnable(){this.setActive(!0)}onDisable(){this.setActive(!1)}_registerNodeEvents(){this.rigidBody.node.on(uf.EventType.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)}_unregisterNodeEvents(){this.rigidBody.node.off(uf.EventType.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)}_onNodeTransformChanged(t){if(!NZ.instance.stepping)if(t&uf.TransformBit.SCALE){const t=this.rigidBody.getComponents(gQ);for(let e=0;e<t.length;e++)t[e].apply()}else t&uf.TransformBit.POSITION&&this.syncPositionToPhysics(!0),t&uf.TransformBit.ROTATION&&this.syncRotationToPhysics(!0)}_init(){this._inited||(this._registerNodeEvents(),NZ.instance.physicsWorld.addBody(this),this._inited=!0)}_destroy(){this._inited&&(NZ.instance.physicsWorld.removeBody(this),this._unregisterNodeEvents(),this._inited=!1)}animate(t){const e=this._body;if(!e)return;const i=e.GetPosition();e.SetAwake(!0);const n=1/t;h1.x=(this._animatedPos.x-i.x)*n,h1.y=(this._animatedPos.y-i.y)*n,e.SetLinearVelocity(h1);const s=e.GetAngle();e.SetAngularVelocity((this._animatedAngle-s)*n)}syncPositionToPhysics(t=!1){const e=this._body;if(!e)return;const i=this._rigidBody.node.worldPosition;let n;const s=this._rigidBody.type;n=s===J$.Animated?e.GetLinearVelocity():e.GetPosition(),n.x=i.x/iZ,n.y=i.y/iZ,s===J$.Animated&&t?this._animatedPos.set(n.x,n.y):e.SetTransformVec(n,e.GetAngle())}syncRotationToPhysics(t=!1){const e=this._body;if(!e)return;const i=ke(this._rigidBody.node.eulerAngles.z);this._rigidBody.type===J$.Animated&&t?this._animatedAngle=i:e.SetTransformVec(e.GetPosition(),i)}resetVelocity(){const t=this._body;if(!t)return;const e=t.m_linearVelocity;e.Set(0,0),t.SetLinearVelocity(e),t.SetAngularVelocity(0)}setType(t){this._body.SetType(t)}setLinearDamping(t){this._body.SetLinearDamping(t)}setAngularDamping(t){this._body.SetAngularDamping(t)}setGravityScale(t){this._body.SetGravityScale(t)}setFixedRotation(t){this._body.SetFixedRotation(t)}setAllowSleep(t){this._body.SetSleepingAllowed(t)}isActive(){return this._body.IsActive()}setActive(t){this._body.SetActive(t)}wakeUp(){this._body.SetAwake(!0)}sleep(){this._body.SetAwake(!1)}getMass(){return this._body.GetMass()}setLinearVelocity(t){this._body.SetLinearVelocity(t)}getLinearVelocity(t){const e=this._body.GetLinearVelocity();return t.x=e.x,t.y=e.y,t}getLinearVelocityFromWorldPoint(t,e){return h1.Set(t.x/iZ,t.y/iZ),this._body.GetLinearVelocityFromWorldPoint(h1,e),e.x*=iZ,e.y*=iZ,e}setAngularVelocity(t){this._body.SetAngularVelocity(t)}getAngularVelocity(){return je(this._body.GetAngularVelocity())}getLocalVector(t,e){return e=e||new Ti,h1.Set(t.x/iZ,t.y/iZ),this._body.GetLocalVector(h1,e),e.x*=iZ,e.y*=iZ,e}getWorldVector(t,e){return h1.Set(t.x/iZ,t.y/iZ),this._body.GetWorldVector(h1,e),e.x*=iZ,e.y*=iZ,e}getLocalPoint(t,e){return e=e||new Ti,h1.Set(t.x/iZ,t.y/iZ),this._body.GetLocalPoint(h1,e),e.x*=iZ,e.y*=iZ,e}getWorldPoint(t,e){return e=e||new Ti,h1.Set(t.x/iZ,t.y/iZ),this._body.GetWorldPoint(h1,e),e.x*=iZ,e.y*=iZ,e}getLocalCenter(t){t=t||new Ti;const e=this._body.GetLocalCenter();return t.x=e.x*iZ,t.y=e.y*iZ,t}getWorldCenter(t){t=t||new Ti;const e=this._body.GetWorldCenter();return t.x=e.x*iZ,t.y=e.y*iZ,t}getInertia(){return this._body.GetInertia()}applyForce(t,e,i){this._body&&(h1.Set(e.x/iZ,e.y/iZ),this._body.ApplyForce(t,h1,i))}applyForceToCenter(t,e){this._body&&this._body.ApplyForceToCenter(t,e)}applyTorque(t,e){this._body&&this._body.ApplyTorque(t,e)}applyLinearImpulse(t,e,i){this._body&&(h1.Set(e.x/iZ,e.y/iZ),this._body.ApplyLinearImpulse(t,h1,i))}applyLinearImpulseToCenter(t,e){this._body&&this._body.ApplyLinearImpulse(t,this._body.GetPosition(),e)}applyAngularImpulse(t,e){this._body&&this._body.ApplyAngularImpulse(t,e)}},BoxShape:class extends m1{constructor(...t){super(...t),this._worldPoints=[new Ti,new Ti,new Ti,new Ti]}get worldPoints(){const t=d1,e=this.collider,i=e.size,n=e.offset;t.x=n.x-i.width/2,t.y=n.y-i.height/2,t.width=i.width,t.height=i.height;const s=this._worldPoints,r=s[0],o=s[1],a=s[2],l=s[3];return t.transformMat4ToPoints(e.node.worldMatrix,r,o,a,l),s}_createShapes(t,e){t=Math.abs(t),e=Math.abs(e);const i=this.collider,n=i.size.width/2/iZ*t,s=i.size.height/2/iZ*e,r=i.offset.x/iZ*t,o=i.offset.y/iZ*e,a=new K$.PolygonShape;return a.SetAsBox(n,s,new K$.Vec2(r,o),0),[a]}},CircleShape:class extends m1{constructor(...t){super(...t),this._worldPosition=new Ti}get worldRadius(){return this._shapes[0].m_radius*iZ}get worldPosition(){const t=this._shapes[0].m_p;return this._worldPosition.set(t.x*iZ,t.y*iZ)}_createShapes(t,e){t=Math.abs(t),e=Math.abs(e);const i=this.collider,n=i.offset.x/iZ*t,s=i.offset.y/iZ*e,r=new K$.CircleShape;return r.m_radius=i.radius/iZ*t,r.m_p.Set(n,s),[r]}},PolygonShape:class extends m1{constructor(...t){super(...t),this._worldPoints=[]}get worldPoints(){const t=this.collider,e=t.points,i=this._worldPoints,n=t.node.worldMatrix;for(let t=0;t<e.length;t++)i[t]||(i[t]=new Ti),Ti.transformMat4(i[t],e[t],n);return i.length=e.length,this._worldPoints}_createShapes(t,e){const i=[],n=this.collider,s=n.points;s.length>0&&s[0].equals(s[s.length-1])&&(s.length-=1);const r=aZ(s),o=n.offset;for(let n=0;n<r.length;n++){const s=r[n];let a=null,l=[],c=null;for(let n=0,r=s.length;n<r;n++){a||(a=new K$.PolygonShape);const h=s[n],_=(h.x+o.x)/iZ*t,u=(h.y+o.y)/iZ*e,m=new K$.Vec2(_,u);l.push(m),c||(c=m),l.length===K$.maxPolygonVertices&&(a.Set(l,l.length),i.push(a),a=null,n<r-1&&(l=[c,l[l.length-1]]))}a&&(a.Set(l,l.length),i.push(a))}return i}},MouseJoint:class extends p1{constructor(...t){super(...t),this._touchPoint=new Ti,this._isTouched=!1}setTarget(t){this._b2joint&&(f1.x=t.x/iZ,f1.y=t.y/iZ,this._b2joint.SetTarget(f1))}setDampingRatio(t){this._b2joint&&this._b2joint.SetDampingRatio(t)}setFrequency(t){this._b2joint&&this._b2joint.SetFrequency(t)}setMaxForce(t){this._b2joint&&this._b2joint.SetMaxForce(t)}_createJointDef(){const t=new K$.MouseJointDef,e=this._jointComp;return t.target.Set(this._touchPoint.x/iZ,this._touchPoint.y/iZ),t.maxForce=e.maxForce,t.dampingRatio=e.dampingRatio,t.frequencyHz=e.frequency,t}initialize(t){super.initialize(t);const e=Ab("Canvas");e&&(e.on(_p.TOUCH_START,this.onTouchBegan,this),e.on(_p.TOUCH_MOVE,this.onTouchMove,this),e.on(_p.TOUCH_END,this.onTouchEnd,this),e.on(_p.TOUCH_CANCEL,this.onTouchEnd,this))}onEnable(){}start(){}onTouchBegan(t){this._isTouched=!0;const e=this._touchPoint.set(t.getUILocation()),i=NZ.instance.physicsWorld.testPoint(e);if(i.length<=0)return;const n=i[0].body;n.wakeUp();const s=this._jointComp;s.connectedBody=n,this._init(),this.setMaxForce(s.maxForce*n.getMass()),this.setTarget(e)}onTouchMove(t){this._touchPoint=t.getUILocation()}onTouchEnd(t){this._destroy(),this._isTouched=!1}update(){this._isTouched&&this.isValid()&&this.setTarget(this._touchPoint)}},DistanceJoint:class extends p1{setMaxLength(t){this._b2joint&&this._b2joint.SetMaxLength(t)}_createJointDef(){const t=this._jointComp,e=new K$.RopeJointDef;return e.localAnchorA.Set(t.anchor.x/iZ,t.anchor.y/iZ),e.localAnchorB.Set(t.connectedAnchor.x/iZ,t.connectedAnchor.y/iZ),e.maxLength=t.maxLength/iZ,e}},SpringJoint:class extends p1{setDampingRatio(t){this._b2joint&&this._b2joint.SetDampingRatio(t)}setFrequency(t){this._b2joint&&this._b2joint.SetFrequency(t)}setDistance(t){this._b2joint&&this._b2joint.SetLength(t)}_createJointDef(){const t=this._jointComp,e=new K$.DistanceJointDef;return e.localAnchorA.Set(t.anchor.x/iZ,t.anchor.y/iZ),e.localAnchorB.Set(t.connectedAnchor.x/iZ,t.connectedAnchor.y/iZ),e.length=t.distance/iZ,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e}},RelativeJoint:class extends p1{setMaxForce(t){this._b2joint&&this._b2joint.SetMaxForce(t)}setAngularOffset(t){this._b2joint&&this._b2joint.SetAngularOffset(ke(t))}setLinearOffset(t){this._b2joint&&this._b2joint.SetLinearOffset(new K$.Vec2(t.x/iZ,t.y/iZ))}setCorrectionFactor(t){this._b2joint&&(this._b2joint.m_correctionFactor=t)}setMaxTorque(t){this._b2joint&&this._b2joint.SetMaxTorque(t)}_createJointDef(){const t=this._jointComp,e=new K$.MotorJointDef;return e.linearOffset.Set(t.linearOffset.x/iZ,t.linearOffset.y/iZ),e.angularOffset=ke(t.angularOffset),e.maxForce=t.maxForce,e.maxTorque=t.maxTorque,e.correctionFactor=t.correctionFactor,e}},SliderJoint:class extends p1{enableLimit(t){this._b2joint&&this._b2joint.EnableLimit(t)}setLowerLimit(t){this.updateLimits()}setUpperLimit(t){this.updateLimits()}updateLimits(){if(this._b2joint){const t=this._jointComp;this._b2joint.SetLimits(t.lowerLimit/iZ,t.upperLimit/iZ)}}enableMotor(t){this._b2joint&&this._b2joint.EnableMotor(t)}setMaxMotorForce(t){this._b2joint&&this._b2joint.SetMaxMotorForce(t)}setMotorSpeed(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)}_createJointDef(){const t=this._jointComp,e=new K$.PrismaticJointDef;e.localAnchorA.Set(t.anchor.x/iZ,t.anchor.y/iZ),e.localAnchorB.Set(t.connectedAnchor.x/iZ,t.connectedAnchor.y/iZ);const i=ke(t.angle);return e.localAxisA.Set(Math.cos(i),Math.sin(i)),e.referenceAngle=0,e.enableLimit=t.enableLimit,e.lowerTranslation=t.lowerLimit/iZ,e.upperTranslation=t.upperLimit/iZ,e.enableMotor=t.enableMotor,e.maxMotorForce=t.maxMotorForce,e.motorSpeed=t.motorSpeed,e}},FixedJoint:class extends p1{setFrequency(t){this._b2joint&&this._b2joint.SetFrequency(t)}setDampingRatio(t){this._b2joint&&this._b2joint.SetDampingRatio(t)}_createJointDef(){const t=this._jointComp,e=new K$.WeldJointDef;return e.localAnchorA.Set(t.anchor.x/iZ,t.anchor.y/iZ),e.localAnchorB.Set(t.connectedAnchor.x/iZ,t.connectedAnchor.y/iZ),e.referenceAngle=0,e.frequencyHz=t.frequency,e.dampingRatio=t.dampingRatio,e}},WheelJoint:class extends p1{setDampingRatio(t){this._b2joint&&this._b2joint.SetSpringDampingRatio(t)}setFrequency(t){this._b2joint&&this._b2joint.SetSpringFrequencyHz(t)}enableMotor(t){this._b2joint&&this._b2joint.EnableMotor(t)}setMaxMotorTorque(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)}setMotorSpeed(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)}_createJointDef(){const t=this._jointComp,e=new K$.WheelJointDef;e.localAnchorA.Set(t.anchor.x/iZ,t.anchor.y/iZ),e.localAnchorB.Set(t.connectedAnchor.x/iZ,t.connectedAnchor.y/iZ);const i=ke(t.angle);return e.localAxisA.Set(Math.cos(i),Math.sin(i)),e.maxMotorTorque=t.maxMotorTorque,e.motorSpeed=ke(t.motorSpeed),e.enableMotor=t.enableMotor,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e}},HingeJoint:class extends p1{enableLimit(t){this._b2joint&&this._b2joint.EnableLimit(t)}setLowerAngle(t){this.updateLimits()}setUpperAngle(t){this.updateLimits()}updateLimits(){if(this._b2joint){const t=this._jointComp;this._b2joint.SetLimits(ke(t.lowerAngle),ke(t.upperAngle))}}enableMotor(t){this._b2joint&&this._b2joint.EnableMotor(t)}setMaxMotorTorque(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)}setMotorSpeed(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)}_createJointDef(){const t=this._jointComp,e=new K$.RevoluteJointDef;return e.localAnchorA.Set(t.anchor.x/iZ,t.anchor.y/iZ),e.localAnchorB.Set(t.connectedAnchor.x/iZ,t.connectedAnchor.y/iZ),e.enableMotor=t.enableMotor,e.maxMotorTorque=t.maxMotorTorque,e.motorSpeed=ke(t.motorSpeed),e.enableLimit=t.enableLimit,e.lowerAngle=t.lowerAngle,e.upperAngle=t.upperAngle,e}}},k$=g1,n._global.CC_PHYSICS_2D_BUILTIN=!1,n._global.CC_PHYSICS_2D_BOX2D=!0,H$=y1;const x1=new Ti,S1=new Ti,A1=new Ti,C1=new Ti;function b1(t,e,i){const n=i.length;for(let s=0;s<n;++s)if(v1(t,e,i[s],i[(s+1)%n]))return!0;return!1}function T1(t,e){let i=!1;const n=t.x,s=t.y,r=e.length;for(let t=0,o=r-1;t<r;o=t++){const r=e[t].x,a=e[t].y,l=e[o].x,c=e[o].y;a>s!=c>s&&n<(l-r)*(s-a)/(c-a)+r&&(i=!i)}return i}function w1(t,e,i,n){let s=i.x-e.x,r=i.y-e.y;const o=s*s+r*r,a=((t.x-e.x)*s+(t.y-e.y)*r)/o;let l;return l=n?o?a<0?e:a>1?i:x1.set(e.x+a*s,e.y+a*r):e:x1.set(e.x+a*s,e.y+a*r),s=t.x-l.x,r=t.y-l.y,Math.sqrt(s*s+r*r)}class E1{}t("Intersection2D",E1),E1.lineLine=v1,E1.lineRect=function(t,e,i){const n=x1.set(i.x,i.y),s=S1.set(i.x,i.yMax),r=A1.set(i.xMax,i.yMax),o=C1.set(i.xMax,i.y);return!!(v1(t,e,n,s)||v1(t,e,s,r)||v1(t,e,r,o)||v1(t,e,o,n))},E1.linePolygon=b1,E1.rectRect=function(t,e){const i=t.x,n=t.y,s=t.x+t.width,r=t.y+t.height,o=e.x,a=e.y,l=e.x+e.width,c=e.y+e.height;return i<=l&&s>=o&&n<=c&&r>=a},E1.rectPolygon=function(t,e){const i=x1.set(t.x,t.y),n=S1.set(t.x,t.yMax),s=A1.set(t.xMax,t.yMax),r=C1.set(t.xMax,t.y);if(b1(i,n,e))return!0;if(b1(n,s,e))return!0;if(b1(s,r,e))return!0;if(b1(r,i,e))return!0;for(let i=0,n=e.length;i<n;++i)if(t.contains(e[i]))return!0;return!!(T1(i,e)||T1(n,e)||T1(s,e)||T1(r,e))},E1.rectCircle=function(t,e,i){const n=e.x,s=e.y,r=t.x,o=t.y,a=t.width,l=t.height;let c=n,h=s;n<r?c=r:n>r+a&&(c=r+a),s<o?h=o:s>o+l&&(h=o+l);const _=n-c,u=s-h;return Math.sqrt(_*_+u*u)<=i},E1.polygonPolygon=function(t,e){let i,n;for(i=0,n=t.length;i<n;++i)if(b1(t[i],t[(i+1)%n],e))return!0;for(i=0,n=e.length;i<n;++i)if(T1(e[i],t))return!0;for(i=0,n=t.length;i<n;++i)if(T1(t[i],e))return!0;return!1},E1.circleCircle=function(t,e,i,n){return Ti.distance(t,i)<e+n},E1.polygonCircle=function(t,e,i){const n=e;if(T1(n,t))return!0;for(let e=0,s=t.length;e<s;e++)if(w1(n,0===e?t[t.length-1]:t[e-1],t[e],!0)<i)return!0;return!1},E1.pointInPolygon=T1,E1.pointLineDistance=w1;class P1{constructor(){this._arrayBufferOrPaddings=[],this._length=0}setNextAlignment(t){if(0!==t){const e=this._length%t;if(0!==e){const i=t-e;this._arrayBufferOrPaddings.push(i),this._length+=i}}}addBuffer(t){const e=this._length;return this._arrayBufferOrPaddings.push(t),this._length+=t.byteLength,e}getLength(){return this._length}getCombined(){const t=new Uint8Array(this._length);let e=0;return this._arrayBufferOrPaddings.forEach((i=>{"number"==typeof i?e+=i:(t.set(new Uint8Array(i),e),e+=i.byteLength)})),t.buffer}}class I1{constructor(t,e){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,!this._mesh.struct.morph)return;const i=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(i).fill(null);for(let t=0;t<i;++t){const i=this._mesh.struct.morph.subMeshMorphs[t];i&&(i.targets.length>vh.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[t]=new R1(this._mesh,t,this._mesh.struct.morph,e):this._subMeshRenderings[t]=new D1(this._mesh,t,this._mesh.struct.morph,e))}}createInstance(){const t=this._mesh.struct.primitives.length,e=new Array(t);for(let s=0;s<t;++s){var i,n;e[s]=null!==(i=null===(n=this._subMeshRenderings[s])||void 0===n?void 0:n.createInstance())&&void 0!==i?i:null}return{setWeights(t,i){var n;null===(n=e[t])||void 0===n||n.setWeights(i)},requiredPatches:t=>{this._mesh.struct.morph;const i=this._mesh.struct.morph.subMeshMorphs[t],n=e[t];if(null===n)return null;const s=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(bo.ATTR_POSITION)&&s.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(bo.ATTR_NORMAL)&&s.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(bo.ATTR_TANGENT)&&s.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),s.push(...n.requiredPatches()),s},adaptPipelineState:(t,i)=>{var n;null===(n=e[t])||void 0===n||n.adaptPipelineState(i)},destroy:()=>{for(const t of e)null==t||t.destroy()}}}}class D1{constructor(t,e,i,n){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=n;const s=i.subMeshMorphs[e];this._subMeshMorph=s,N1(t,e,n);const r=t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count;this._verticesCount=r;const o=s.targets.length,a=O1(n,r*o);this._textureInfo={width:a.width,height:a.height},this._attributes=s.attributes.map(((e,i)=>{const n=a.create(),o=n.valueView;return s.targets.forEach(((e,n)=>{const s=e.displacements[i],a=new Float32Array(t.data.buffer,t.data.byteOffset+s.offset,s.count),l=r*n*4;for(let t=0;t<r;++t)o[l+4*t+0]=a[3*t+0],o[l+4*t+1]=a[3*t+1],o[l+4*t+2]=a[3*t+2]})),n.updatePixels(),{name:e,morphTexture:n}}))}destroy(){for(const t of this._attributes)t.morphTexture.destroy()}createInstance(){const t=new B1(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:e=>{t.setWeights(e),t.commit()},requiredPatches:()=>[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}],adaptPipelineState:e=>{for(const t of this._attributes){let i;switch(t.name){case bo.ATTR_POSITION:i=Ch;break;case bo.ATTR_NORMAL:i=wh;break;case bo.ATTR_TANGENT:i=Ih;break;default:m("Unexpected attribute!")}void 0!==i&&(e.bindSampler(i,t.morphTexture.sampler),e.bindTexture(i,t.morphTexture.texture))}e.bindBuffer(vh.BINDING,t.buffer),e.update()},destroy:()=>{}}}}class R1{constructor(t,e,i,n){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=n;const s=i.subMeshMorphs[e];N1(t,e,n),this._attributes=s.attributes.map(((e,i)=>({name:e,targets:s.targets.map((e=>({displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[i].offset,e.displacements[i].count)})))})))}get data(){return this._attributes}createInstance(){return new M1(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)}}class M1{constructor(t,e,i){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=t,this._morphUniforms=new B1(i,0);const n=O1(i,e);this._morphUniforms.setMorphTextureInfo(n.width,n.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((t=>{const e=n.create();return{attributeName:t.name,morphTexture:e}}))}setWeights(t){for(let e=0;e<this._attributes.length;++e){const i=this._attributes[e],n=i.morphTexture.valueView,s=this._owner.data[e];t.length,s.targets.length;for(let e=0;e<s.targets.length;++e){const i=s.targets[e].displacements,r=t[e],o=i.length/3;if(0===e)for(let t=0;t<o;++t)n[4*t+0]=i[3*t+0]*r,n[4*t+1]=i[3*t+1]*r,n[4*t+2]=i[3*t+2]*r;else if(0!==r)for(let t=0;t<o;++t)n[4*t+0]+=i[3*t+0]*r,n[4*t+1]+=i[3*t+1]*r,n[4*t+2]+=i[3*t+2]*r}i.morphTexture.updatePixels()}}requiredPatches(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]}adaptPipelineState(t){for(const e of this._attributes){let i;switch(e.attributeName){case bo.ATTR_POSITION:i=Ch;break;case bo.ATTR_NORMAL:i=wh;break;case bo.ATTR_TANGENT:i=Ih;break;default:m("Unexpected attribute!")}void 0!==i&&(t.bindSampler(i,e.morphTexture.sampler),t.bindTexture(i,e.morphTexture.texture))}t.bindBuffer(vh.BINDING,this._morphUniforms.buffer),t.update()}destroy(){this._morphUniforms.destroy();for(let t=0;t<this._attributes.length;++t)this._attributes[t].morphTexture.destroy()}}class B1{constructor(t,e){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=e,this._localBuffer=new DataView(new ArrayBuffer(vh.SIZE)),this._remoteBuffer=t.createBuffer(new zo(Xr.UNIFORM|Xr.TRANSFER_DST,Jr.HOST|Jr.DEVICE,vh.SIZE,vh.SIZE))}destroy(){this._remoteBuffer.destroy()}get buffer(){return this._remoteBuffer}setWeights(t){t.length,this._targetCount;for(let e=0;e<t.length;++e)this._localBuffer.setFloat32(vh.OFFSET_OF_WEIGHTS+4*e,t[e],n.sys.isLittleEndian)}setMorphTextureInfo(t,e){this._localBuffer.setFloat32(vh.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,t,n.sys.isLittleEndian),this._localBuffer.setFloat32(vh.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,e,n.sys.isLittleEndian)}setVerticesCount(t){this._localBuffer.setFloat32(vh.OFFSET_OF_VERTICES_COUNT,t,n.sys.isLittleEndian)}commit(){this._remoteBuffer.update(this._localBuffer.buffer)}}function O1(t,e){let i,n,s,r;t.hasFeature(kr.TEXTURE_FLOAT)?(i=e,s=16,n=Zm.PixelFormat.RGBA32F,r=Float32Array):(i=4*e,s=4,n=Zm.PixelFormat.RGBA8888,r=Uint8Array);const{width:o,height:a}=function(t){t<5&&(t=5);const e=B(N(t)),i=e>>1;return{width:1<<(1&e?i+1:i),height:1<<i}}(i);return{width:o,height:a,create:()=>{const e=new ArrayBuffer(o*a*s),i=new Float32Array(e),l=r===Float32Array?i:new r(e),c=new Ru({width:o,height:a,_data:l,_compressed:!1,format:n}),h=new Zm;h.setFilters(Zm.Filter.NEAREST,Zm.Filter.NEAREST),h.setMipFilter(Zm.Filter.NONE),h.setWrapMode(Zm.WrapMode.CLAMP_TO_EDGE,Zm.WrapMode.CLAMP_TO_EDGE,Zm.WrapMode.CLAMP_TO_EDGE),h.image=c,h.getGFXTexture()||m("Unexpected: failed to create morph texture?");const _=Fu.getSampler(t,h.getSamplerHash());return{get texture(){return h.getGFXTexture()},get sampler(){return _},get valueView(){return i},destroy(){h.destroy()},updatePixels(){h.uploadData(l)}}}}}function N1(t,e,i){t.renderingSubMeshes[e].enableVertexIdChannel(i)}var L1,F1,z1,V1,U1;function G1(t){switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}const H1=new oi,k1=new oi,j1=new Uint8Array;let W1=u_("cc.Mesh")((z1=n_((F1=class extends xu{get _nativeAsset(){return this._data.buffer}set _nativeAsset(t){this._data.byteLength===t.byteLength?this._data.set(new Uint8Array(t)):this._data=new Uint8Array(t),this.loaded=!0,this.emit("load")}get subMeshCount(){const t=this.renderingSubMeshes;return t?t.length:0}get minPosition(){return this.struct.minPosition}get maxPosition(){return this.struct.maxPosition}get struct(){return this._struct}get data(){return this._data}get hash(){return this._hash||(this._hash=qa(this._data,666)),this._hash}get jointBufferIndices(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((t=>t.jointMapIndex||0))}get renderingSubMeshes(){return this.initialize(),this._renderingSubMeshes}constructor(){super(),this.morphRendering=null,i_(this,"_struct",z1,this),i_(this,"_dataLength",V1,this),i_(this,"_hash",U1,this),this._data=j1,this._initialized=!1,this._renderingSubMeshes=null,this._boneSpaceBounds=new Map,this._jointBufferIndices=null,this.loaded=!1}initialize(){if(this._initialized)return;this._initialized=!0,this._data.byteLength!==this._dataLength&&(this._data=new Uint8Array(this._dataLength),n.assetManager.postLoadNative(this));const{buffer:t}=this._data,e=n.director.root.device,i=this._createVertexBuffers(e,t),s=[];for(let n=0;n<this._struct.primitives.length;n++){const r=this._struct.primitives[n];if(0===r.vertexBundelIndices.length)continue;let o=null,a=null;if(r.indexView){const i=r.indexView;let n=i.stride,s=i.length;if(4===n&&!e.hasFeature(kr.ELEMENT_INDEX_UINT)){const t=this._struct.vertexBundles[r.vertexBundelIndices[0]].view.count;if(t>=65536){C(10001,t,65536);continue}n>>=1,s>>=1}o=e.createBuffer(new zo(Xr.INDEX,Jr.DEVICE,s,n)),a=new(G1(i.stride))(t,i.offset,i.count),i.stride!==n&&(a=G1(n).from(a)),this.loaded?o.update(a):this.once("load",(()=>{o.update(a)}))}const l=r.vertexBundelIndices.map((t=>i[t])),c=[];if(r.vertexBundelIndices.length>0){const t=r.vertexBundelIndices[0],e=this._struct.vertexBundles[t].attributes;for(let t=0;t<e.length;++t){const i=e[t];c[t]=new rl(i.name,i.format,i.isInstanced,i.stream,i.isInstanced,i.location)}}const h=new NS(l,c,r.primitiveMode,o);h.mesh=this,h.subMeshIdx=n,s.push(h)}this._renderingSubMeshes=s,this._struct.morph&&(this.morphRendering=function(t,e){return new I1(t,e)}(this,e))}destroy(){return this.destroyRenderingMesh(),super.destroy()}destroyRenderingMesh(){if(this._renderingSubMeshes){for(let t=0;t<this._renderingSubMeshes.length;t++)this._renderingSubMeshes[t].destroy();this._renderingSubMeshes=null,this._initialized=!1}}assign(t,e){this.reset({struct:t,data:e})}reset(t){this.destroyRenderingMesh(),this._struct=t.struct,this._data=t.data,this._dataLength=this.data.byteLength,this._hash=0,this.loaded=!0,this.emit("load")}getBoneSpaceBounds(t){if(this._boneSpaceBounds.has(t.hash))return this._boneSpaceBounds.get(t.hash);const e=[];this._boneSpaceBounds.set(t.hash,e);const i=[],{bindposes:n}=t;for(let t=0;t<n.length;t++)e.push(new lc(1/0,1/0,1/0,-1/0,-1/0,-1/0)),i.push(!1);const{primitives:s}=this._struct;for(let t=0;t<s.length;t++){const s=this.readAttribute(t,bo.ATTR_JOINTS),r=this.readAttribute(t,bo.ATTR_WEIGHTS),o=this.readAttribute(t,bo.ATTR_POSITION);if(!s||!r||!o)continue;const a=Math.min(s.length/4,r.length/4,o.length/3);for(let t=0;t<a;t++){oi.set(H1,o[3*t+0],o[3*t+1],o[3*t+2]);for(let o=0;o<4;++o){const a=4*t+o,l=s[a];if(0===r[a]||l>=n.length)continue;oi.transformMat4(k1,H1,n[l]),i[l]=!0;const c=e[l];oi.min(c.center,c.center,k1),oi.max(c.halfExtents,c.halfExtents,k1)}}}for(let t=0;t<n.length;t++){const n=e[t];i[t]?lc.fromPoints(n,n.center,n.halfExtents):e[t]=null}return e}merge(t,e,i){if(i&&(!this.loaded||!t.loaded||!this.validateMergingMesh(t)))return!1;const n=new oi,s=e&&new mi,r=e&&new lc;if(s&&e.getRotation(s),!this._initialized){const i=JSON.parse(JSON.stringify(t._struct)),o=t._data.slice();if(e){i.maxPosition&&i.minPosition&&(oi.add(r.center,i.maxPosition,i.minPosition),oi.multiplyScalar(r.center,r.center,.5),oi.subtract(r.halfExtents,i.maxPosition,i.minPosition),oi.multiplyScalar(r.halfExtents,r.halfExtents,.5),lc.transform(r,r,e),oi.add(i.maxPosition,r.center,r.halfExtents),oi.subtract(i.minPosition,r.center,r.halfExtents));for(let t=0;t<i.vertexBundles.length;t++){const r=i.vertexBundles[t];for(let t=0;t<r.attributes.length;t++)if(r.attributes[t].name===bo.ATTR_POSITION||r.attributes[t].name===bo.ATTR_NORMAL){const{format:i}=r.attributes[t],a=new DataView(o.buffer,r.view.offset+q1(r.attributes,t)),l=K1(a,i),c=J1(a,i);if(!l||!c)continue;const h=r.view.count,_=r.view.stride,u=Y1(i);for(let i=0;i<h;i++){const o=i*_,a=o+u,h=a+u;switch(n.set(l(o),l(a),l(h)),r.attributes[t].name){case bo.ATTR_POSITION:n.transformMat4(e);break;case bo.ATTR_NORMAL:oi.transformQuat(n,n,s)}c(o,n.x),c(a,n.y),c(h,n.z)}}}}return this.reset({struct:i,data:o}),this.initialize(),!0}const o=new P1;let a,l,c,h,_,u=0,m=0,d=0,p=0,f=0,g=0,y=0,v=0,x=!1;const S=new Array(this._struct.vertexBundles.length);for(let i=0;i<this._struct.vertexBundles.length;++i){const r=this._struct.vertexBundles[i],A=t._struct.vertexBundles[i];d=r.view.offset,p=A.view.offset,m=r.view.stride,u=r.view.count+A.view.count,a=new ArrayBuffer(u*m),l=new Uint8Array(a),c=this._data.subarray(d,d+r.view.length),d+=c.length,h=t._data.subarray(p,p+A.view.length),p+=h.length,l.set(c),f=0;for(const t of r.attributes){y=0,x=!1;for(const e of A.attributes){if(t.name===e.name&&t.format===e.format){x=!0;break}y+=Aa[e.format].size}if(x){v=Aa[t.format].size,g=r.view.length+f;for(let i=0;i<A.view.count;++i){if(_=h.subarray(y,y+v),l.set(_,g),(t.name===bo.ATTR_POSITION||t.name===bo.ATTR_NORMAL)&&e){const i=new Float32Array(l.buffer,g,3);switch(n.set(i[0],i[1],i[2]),t.name){case bo.ATTR_POSITION:n.transformMat4(e);break;case bo.ATTR_NORMAL:oi.transformQuat(n,n,s)}i[0]=n.x,i[1]=n.y,i[2]=n.z}g+=r.view.stride,y+=A.view.stride}}f+=Aa[t.format].size}S[i]={attributes:r.attributes,view:{offset:o.getLength(),length:a.byteLength,count:u,stride:m}},o.addBuffer(a)}let A,C,b,T=0,w=2,E=0;const P=new Array(this._struct.primitives.length);for(let e=0;e<this._struct.primitives.length;++e){const i=this._struct.primitives[e],n=t._struct.primitives[e];P[e]={primitiveMode:i.primitiveMode,vertexBundelIndices:i.vertexBundelIndices};for(const t of i.vertexBundelIndices)E=Math.max(E,this._struct.vertexBundles[t].view.count);if(i.indexView&&n.indexView){T=i.indexView.count,T+=n.indexView.count,d=i.indexView.offset,p=n.indexView.offset,w=T<256?1:T<65536?2:4;const s=new ArrayBuffer(T*w);if(A=2===w?new Uint16Array(s):1===w?new Uint8Array(s):new Uint32Array(s),C=2===i.indexView.stride?new Uint16Array(this._data.buffer,d,i.indexView.count):1===i.indexView.stride?new Uint8Array(this._data.buffer,d,i.indexView.count):new Uint32Array(this._data.buffer,d,i.indexView.count),w===i.indexView.stride)A.set(C);else for(let t=0;t<i.indexView.count;++t)A[t]=C[t];d+=i.indexView.length,b=2===n.indexView.stride?new Uint16Array(t._data.buffer,p,n.indexView.count):1===n.indexView.stride?new Uint8Array(t._data.buffer,p,n.indexView.count):new Uint32Array(t._data.buffer,p,n.indexView.count);for(let t=0;t<n.indexView.count;++t)A[i.indexView.count+t]=E+b[t];p+=n.indexView.length,P[e].indexView={offset:o.getLength(),length:s.byteLength,count:T,stride:w},o.setNextAlignment(w),o.addBuffer(s)}}const I={vertexBundles:S,primitives:P,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return I.minPosition&&t._struct.minPosition&&I.maxPosition&&t._struct.maxPosition&&(e?(oi.add(r.center,t._struct.maxPosition,t._struct.minPosition),oi.multiplyScalar(r.center,r.center,.5),oi.subtract(r.halfExtents,t._struct.maxPosition,t._struct.minPosition),oi.multiplyScalar(r.halfExtents,r.halfExtents,.5),lc.transform(r,r,e),oi.add(n,r.center,r.halfExtents),oi.max(I.maxPosition,I.maxPosition,n),oi.subtract(n,r.center,r.halfExtents),oi.min(I.minPosition,I.minPosition,n)):(oi.min(I.minPosition,I.minPosition,t._struct.minPosition),oi.max(I.maxPosition,I.maxPosition,t._struct.maxPosition))),this.reset({struct:I,data:new Uint8Array(o.getCombined())}),this.initialize(),!0}validateMergingMesh(t){if(this._struct.vertexBundles.length!==t._struct.vertexBundles.length)return!1;for(let e=0;e<this._struct.vertexBundles.length;++e){const i=this._struct.vertexBundles[e],n=t._struct.vertexBundles[e];if(i.attributes.length!==n.attributes.length)return!1;for(let t=0;t<i.attributes.length;++t)if(i.attributes[t].format!==n.attributes[t].format)return!1}if(this._struct.primitives.length!==t._struct.primitives.length)return!1;for(let e=0;e<this._struct.primitives.length;++e){const i=this._struct.primitives[e],n=t._struct.primitives[e];if(i.vertexBundelIndices.length!==n.vertexBundelIndices.length)return!1;for(let t=0;t<i.vertexBundelIndices.length;++t)if(i.vertexBundelIndices[t]!==n.vertexBundelIndices[t])return!1;if(i.primitiveMode!==n.primitiveMode)return!1;if(i.indexView){if(void 0===n.indexView)return!1}else if(n.indexView)return!1}return!0}readAttribute(t,e){let i=null;return this._accessAttribute(t,e,((t,e)=>{const n=t.view.count,{format:s}=t.attributes[e],r=Ra(Aa[s]);if(0===n)return;const o=new DataView(this._data.buffer,t.view.offset+q1(t.attributes,e)),a=Aa[s],l=K1(o,s);if(!r||!l)return;const c=a.count,h=new r(n*c),_=t.view.stride;for(let t=0;t<n;++t)for(let e=0;e<c;++e)h[c*t+e]=l(_*t+h.BYTES_PER_ELEMENT*e);i=h})),i}copyAttribute(t,e,i,n,s){let r=!1;return this._accessAttribute(t,e,((t,e)=>{const o=t.view.count;if(0===o)return void(r=!0);const{format:a}=t.attributes[e],l=new DataView(this._data.buffer,t.view.offset+q1(t.attributes,e)),c=new DataView(i,s),h=Aa[a],_=K1(l,a),u=J1(c,a);if(!_||!u)return;const m=h.count,d=t.view.stride,p=Y1(a),f=n,g=p;for(let t=0;t<o;++t)for(let e=0;e<m;++e)u(f*t+g*e,_(d*t+p*e));r=!0})),r}readIndices(t){if(t>=this._struct.primitives.length)return null;const e=this._struct.primitives[t];if(!e.indexView)return null;const{stride:i}=e.indexView;return new(1===i?Uint8Array:2===i?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)}copyIndices(t,e){if(t>=this._struct.primitives.length)return!1;const i=this._struct.primitives[t];if(!i.indexView)return!1;const n=i.indexView.count,s=1===i.indexView.stride?jr.R8UI:2===i.indexView.stride?jr.R16UI:jr.R32UI,r=K1(new DataView(this._data.buffer),s);for(let t=0;t<n;++t)e[t]=r(i.indexView.offset+Aa[s].size*t);return!0}_accessAttribute(t,e,i){if(t>=this._struct.primitives.length)return;const n=this._struct.primitives[t];for(const t of n.vertexBundelIndices){const n=this._struct.vertexBundles[t],s=n.attributes.findIndex((t=>t.name===e));if(!(s<0)){i(n,s);break}}}_createVertexBuffers(t,e){return this._struct.vertexBundles.map((i=>{const n=t.createBuffer(new zo(Xr.VERTEX,Jr.DEVICE,i.view.length,i.view.stride)),s=new Uint8Array(e,i.view.offset,i.view.length);return this.loaded?n.update(s):this.once("load",(()=>{n.update(s)})),n}))}initDefault(t){super.initDefault(t),this.reset({struct:{vertexBundles:[],primitives:[]},data:j1})}validate(){return this.renderingSubMeshes.length>0&&this.data.byteLength>0}}).prototype,"_struct",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),V1=n_(F1.prototype,"_dataLength",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),U1=n_(F1.prototype,"_hash",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),L1=F1))||L1;function q1(t,e){let i=0;for(let n=0;n<e;++n){const e=t[n];i+=Aa[e.format].size}return i}n.Mesh=W1;const{isLittleEndian:X1}=Cy;function Y1(t){const e=Aa[t];return e.size/e.count}function K1(t,e){const i=Aa[e],n=i.size/i.count;switch(i.type){case Wr.UNORM:switch(n){case 1:return e=>t.getUint8(e);case 2:return e=>t.getUint16(e,X1);case 4:return e=>t.getUint32(e,X1)}break;case Wr.SNORM:case Wr.INT:switch(n){case 1:return e=>t.getInt8(e);case 2:return e=>t.getInt16(e,X1);case 4:return e=>t.getInt32(e,X1)}break;case Wr.UINT:switch(n){case 1:return e=>t.getUint8(e);case 2:return e=>t.getUint16(e,X1);case 4:return e=>t.getUint32(e,X1)}break;case Wr.FLOAT:return e=>t.getFloat32(e,X1)}return null}function J1(t,e){const i=Aa[e],n=i.size/i.count;switch(i.type){case Wr.UNORM:switch(n){case 1:return(e,i)=>t.setUint8(e,i);case 2:return(e,i)=>t.setUint16(e,i,X1);case 4:return(e,i)=>t.setUint32(e,i,X1)}break;case Wr.SNORM:case Wr.INT:switch(n){case 1:return(e,i)=>t.setInt8(e,i);case 2:return(e,i)=>t.setInt16(e,i,X1);case 4:return(e,i)=>t.setInt32(e,i,X1)}break;case Wr.UINT:switch(n){case 1:return(e,i)=>t.setUint8(e,i);case 2:return(e,i)=>t.setUint16(e,i,X1);case 4:return(e,i)=>t.setUint32(e,i,X1)}break;case Wr.FLOAT:return(e,i)=>t.setFloat32(e,i,X1)}return null}class $1 extends ex{constructor(...t){super(...t),this._morphRenderingInstance=null,this._usedMaterials=new Set}getMacroPatches(t){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(t):null}initSubModel(t,e,i){return super.initSubModel(t,e,this._launderMaterial(i))}setSubModelMaterial(t,e){return super.setSubModelMaterial(t,this._launderMaterial(e))}_updateLocalDescriptors(t,e){super._updateLocalDescriptors(t,e),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,e)}_launderMaterial(t){return t}setMorphRendering(t){this._morphRenderingInstance=t}}var Z1,Q1,t2,e2,i2,n2,s2,r2,o2,a2,l2,c2,h2,_2,u2,m2,d2,p2,f2,g2,y2,v2,x2,S2,A2,C2,b2,T2,w2,E2;const P2=Gt({OFF:0,ON:1}),I2=Gt({OFF:0,ON:1});let D2=(Z1=u_("cc.ModelLightmapSettings"),Q1=f_(v_({formerlySerializedAs:"_recieveShadow"})),Z1((i2=n_((e2=class{constructor(){i_(this,"texture",i2,this),i_(this,"uvParam",n2,this),i_(this,"_bakeable",s2,this),i_(this,"_castShadow",r2,this),i_(this,"_receiveShadow",o2,this),i_(this,"_lightmapSize",a2,this)}get bakeable(){return this._bakeable}set bakeable(t){this._bakeable=t}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t}get receiveShadow(){return this._receiveShadow}set receiveShadow(t){this._receiveShadow=t}get lightmapSize(){return this._lightmapSize}set lightmapSize(t){this._lightmapSize=t}}).prototype,"texture",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),n2=n_(e2.prototype,"uvParam",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii}}),s2=n_(e2.prototype,"_bakeable",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),r2=n_(e2.prototype,"_castShadow",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),o2=n_(e2.prototype,"_receiveShadow",[Q1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a2=n_(e2.prototype,"_lightmapSize",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),n_(e2.prototype,"bakeable",[w_],Object.getOwnPropertyDescriptor(e2.prototype,"bakeable"),e2.prototype),n_(e2.prototype,"castShadow",[w_],Object.getOwnPropertyDescriptor(e2.prototype,"castShadow"),e2.prototype),n_(e2.prototype,"receiveShadow",[w_],Object.getOwnPropertyDescriptor(e2.prototype,"receiveShadow"),e2.prototype),n_(e2.prototype,"lightmapSize",[w_],Object.getOwnPropertyDescriptor(e2.prototype,"lightmapSize"),e2.prototype),t2=e2))||t2),R2=(l2=u_("cc.MeshRenderer"),c2=T_(),h2=d_(100),_2=S_(),u2=H_(P2),m2=I_(),d2=H_(I2),p2=I_(),f2=H_(W1),g2=I_(),y2=E_(),l2(v2=c2(v2=h2(v2=_2(v2=x_((E2=w2=class extends hP{get shadowCastingMode(){return this._shadowCastingMode}set shadowCastingMode(t){this._shadowCastingMode=t,this._updateCastShadow()}get receiveShadow(){return this._shadowReceivingMode}set receiveShadow(t){this._shadowReceivingMode=t,this._updateReceiveShadow()}get mesh(){return this._mesh}set mesh(t){const e=this._mesh;this._mesh=t,this._mesh&&this._mesh.initialize(),this._watchMorphInMesh(),this._onMeshChanged(e),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}get model(){return this._model}get enableMorph(){return this._enableMorph}set enableMorph(t){this._enableMorph=t}constructor(){super(),i_(this,"lightmapSettings",S2,this),i_(this,"_mesh",A2,this),i_(this,"_shadowCastingMode",C2,this),i_(this,"_shadowReceivingMode",b2,this),this._modelType=void 0,this._model=null,this._morphInstance=null,i_(this,"_enableMorph",T2,this),this._modelType=ex}onLoad(){this._mesh&&this._mesh.initialize(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}onRestore(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}onEnable(){this._model||this._updateModels(),this._attachToScene()}onDisable(){this._model&&this._detachFromScene()}onDestroy(){this._model&&(n.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()}setWeights(t,e){this._morphInstance&&this._morphInstance.setWeights(e,t)}setInstancedAttribute(t,e){if(!this.model)return;const{attributes:i,views:n}=this.model.instancedAttributes;for(let s=0;s<i.length;s++)if(i[s].name===t){n[s].set(e);break}}_updateLightmap(t,e,i,n,s){this.lightmapSettings.texture=t,this.lightmapSettings.uvParam.x=e,this.lightmapSettings.uvParam.y=i,this.lightmapSettings.uvParam.z=n,this.lightmapSettings.uvParam.w=s,this._onUpdateLightingmap()}_updateModels(){if(!this.enabledInHierarchy||!this._mesh)return;const t=this._model;t?(t.destroy(),t.initialize(),t.node=t.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}_createModel(){const t=this._morphInstance&&this._modelType===ex?$1:this._modelType,e=this._model=n.director.root.createModel(t);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&e instanceof $1&&e.setMorphRendering(this._morphInstance)}_attachToScene(){if(!this.node.scene||!this._model)return;const t=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),t.addModel(this._model)}_detachFromScene(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}_updateModelParams(){if(!this._mesh||!this._model)return;this.node.hasChangedFlags|=t_.POSITION,this._model.transform.hasChangedFlags|=t_.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();const t=this._mesh?this._mesh.renderingSubMeshes.length:0,e=this._mesh.renderingSubMeshes;if(e)for(let i=0;i<t;++i){let t=this.getRenderMaterial(i);t&&!t.isValid&&(t=null);const n=e[i];n&&this._model.initSubModel(i,n,t||this._getBuiltinMaterial())}this._model.enabled=!0}_onUpdateLightingmap(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])}_onMaterialModified(t,e){this._model&&this._model.inited&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())}_onRebuildPSO(t,e){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(t,e),this._onUpdateLightingmap())}_onMeshChanged(t){}_clearMaterials(){if(!this._model)return;const t=this._model.subModels;for(let e=0;e<t.length;++e)this._onMaterialModified(e,null)}_getBuiltinMaterial(){return Bd.get("missing-material")}_onVisibilityChange(t){this._model&&(this._model.visFlags=t)}_updateCastShadow(){this._model&&(this._shadowCastingMode===P2.OFF?this._model.castShadow=!1:(this._shadowCastingMode,P2.ON,this._shadowCastingMode,this._model.castShadow=!0))}_updateReceiveShadow(){this._model&&(this._shadowReceivingMode===I2.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)}_isBatchingEnabled(){for(let t=0;t<this._materials.length;++t){const e=this._materials[t];if(e)for(let t=0;t<e.passes.length;++t)if(e.passes[t].batchingScheme)return!0}return!1}_watchMorphInMesh(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),!this._enableMorph)return;if(!this._mesh||!this._mesh.struct.morph||!this._mesh.morphRendering)return;const{morph:t}=this._mesh.struct;this._morphInstance=this._mesh.morphRendering.createInstance();const e=this._mesh.struct.primitives.length;for(let i=0;i<e;++i){const e=t.subMeshMorphs[i];if(!e)continue;const n=e.weights||t.weights,s=n?n.slice():new Array(e.targets.length).fill(0);this._morphInstance.setWeights(i,s)}this._model&&this._model instanceof $1&&this._model.setMorphRendering(this._morphInstance)}_syncMorphWeights(t){if(!this._morphInstance)return;const e=this._morphInstance[t];e&&e.renderResources&&e.renderResources.setWeights(e.weights)}},w2.ShadowCastingMode=P2,w2.ShadowReceivingMode=I2,S2=n_((x2=E2).prototype,"lightmapSettings",[g_,w_,F_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new D2}}),A2=n_(x2.prototype,"_mesh",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),C2=n_(x2.prototype,"_shadowCastingMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return P2.OFF}}),b2=n_(x2.prototype,"_shadowReceivingMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return I2.ON}}),n_(x2.prototype,"shadowCastingMode",[u2,m2,F_],Object.getOwnPropertyDescriptor(x2.prototype,"shadowCastingMode"),x2.prototype),n_(x2.prototype,"receiveShadow",[d2,p2,F_],Object.getOwnPropertyDescriptor(x2.prototype,"receiveShadow"),x2.prototype),n_(x2.prototype,"mesh",[f2,g2],Object.getOwnPropertyDescriptor(x2.prototype,"mesh"),x2.prototype),n_(x2.prototype,"enableMorph",[y2,F_],Object.getOwnPropertyDescriptor(x2.prototype,"enableMorph"),x2.prototype),T2=n_(x2.prototype,"_enableMorph",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),v2=x2))||v2)||v2)||v2)||v2)||v2);var M2;!function(t){t[t.positions=bo.ATTR_POSITION]="positions",t[t.normals=bo.ATTR_NORMAL]="normals",t[t.uvs=bo.ATTR_TEX_COORD]="uvs",t[t.colors=bo.ATTR_COLOR]="colors"}(M2||(M2={}));const B2=[new rl(bo.ATTR_POSITION,jr.RGB32F),new rl(bo.ATTR_NORMAL,jr.RGB32F),new rl(bo.ATTR_TEX_COORD,jr.RG32F),new rl(bo.ATTR_TANGENT,jr.RGBA32F),new rl(bo.ATTR_COLOR,jr.RGBA32F)],O2=new oi;var N2;let L2=u_("cc.PerfCounter")(N2=class extends class{get value(){return this._value}set value(t){this._value=t}constructor(t,e,i){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=e,this._accumStart=i}sample(t){this._average(this._value,t)}human(){const{average:t,isInteger:e}=this._opts,i=t?this._averageValue:this._value;return e?Math.round(i):Math.round(100*i)/100}alarm(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}_average(t,e=0){if(this._opts.average){this._accumValue+=t,++this._accumSamples;const i=e;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}}}{constructor(t,e,i){super(t,e,i),this._time=void 0,this._time=i}start(t=0){this._time=t}end(t=0){this._value=t-this._time,this._average(this._value)}tick(){this.end(),this.start()}frame(t){const e=t,i=e-this._time;this._total++,i>(this._opts.average||1e3)&&(this._value=1e3*this._total/i,this._total=0,this._time=e,this._average(this._value))}})||N2;const F2="0123456789. ",z2={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},V2={fps:{desc:"Framerate (FPS)",below:30,average:500,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:500},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:500,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:500},render:{desc:"Renderer (ms)",min:0,max:50,average:500,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},U2={fontSize:23,quadHeight:.4,segmentsPerLine:8,textureWidth:256,textureHeight:256};class G2{constructor(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new Oo,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=U2.textureHeight/(Object.keys(V2).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}isShowingStats(){return this._showFPS}hideStats(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),n.game.off(n.Game.EVENT_RESTART,this.generateNode,this),n.director.off(n.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),n.director.off(n.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),n.director.off(n.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),n.director.off(n.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),n.director.off(n.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),n.director.off(n.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1)}showStats(){this._showFPS||(this._device||(this._device=n.director.root.device),this.generateCanvas(),this.generateStats(),n.game.once(n.Game.EVENT_ENGINE_INITED,this.generateNode,this),n.game.on(n.Game.EVENT_RESTART,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),n.director.on(n.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),n.director.on(n.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),n.director.on(n.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),n.director.on(n.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),n.director.on(n.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),n.director.on(n.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0)}generateCanvas(){if(this._canvasDone)return;const{textureWidth:t,textureHeight:e}=U2;this._ctx&&this._canvas&&(this._canvas.width=t,this._canvas.height=e,this._canvas.style.width=`${this._canvas.width}`,this._canvas.style.height=`${this._canvas.height}`,this._ctx.font=`${U2.fontSize}px Arial`,this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new ko($r.TEX2D,Zr.SAMPLED|Zr.TRANSFER_DST,jr.RGBA8,t,e)),this._region.texExtent.width=t,this._region.texExtent.height=e)}generateStats(){if(this._statsDone||!this._ctx||!this._canvas)return;this._stats=null;const t=performance.now();this._ctx.textAlign="left";let e=0;for(const i in V2){const n=V2[i];this._ctx.fillText(n.desc,0,e*this._lineHeight),n.counter=new L2(i,n,t),e++}this._totalLines=e,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(let t=0;t<F2.length;++t){const e=this._ctx.measureText(F2[t]).width;this._eachNumWidth=Math.max(this._eachNumWidth,e)}for(let t=0;t<F2.length;++t)this._ctx.fillText(F2[t],t*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=V2,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}generateNode(){if(this._rootNode&&this._rootNode.isValid)return;this._rootNode=new uf("PROFILER_NODE"),n.game.addPersistRootNode(this._rootNode);const t=new uf("Profiler_Camera");t.setPosition(0,0,1.5),t.parent=this._rootNode;const e=t.addComponent("cc.Camera");e.projection=ZE.ProjectionType.ORTHO,e.orthoHeight=1,e.near=1,e.far=2,e.visibility=Ec.BitMask.PROFILER,e.clearFlags=Co.NONE,e.priority=4294967295;const i=new uf("Profiler_Root");i.parent=this._rootNode;const s=U2.quadHeight,r=s/this._totalLines,o=s/this._wordHeight,a=r/U2.fontSize,l=this._eachNumWidth*this._canvas.width*a,c=[0,s,0,o,s,0,o,0,0,0,0,0],h=[0,2,1,0,3,2],_=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0];let u=0;for(let t=0;t<this._totalLines;t++)for(let e=0;e<U2.segmentsPerLine;e++){c.push(o+e*l,s-t*r,0),c.push(o+(e+1)*l,s-t*r,0),c.push(o+(e+1)*l,s-(t+1)*r,0),c.push(o+e*l,s-(t+1)*r,0),u=4*(t*U2.segmentsPerLine+e+1),h.push(0+u,2+u,1+u,0+u,3+u,2+u);const i=t*U2.segmentsPerLine+e,n=Math.floor(i/4),a=i-4*n;_.push(0,this._wordHeight,n,a),_.push(this._eachNumWidth,this._wordHeight,n,a),_.push(this._eachNumWidth,1,n,a),_.push(0,1,n,a)}const m=i.addComponent(R2);m.mesh=function(t,e,i){i=i||{};const n=[];let s=0;const r=[];let o,a=0;const l=t.positions.slice();if(l.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===bo.ATTR_POSITION){o=e;break}o||(o=B2[0]),n.push(o);const e=Aa[o.format];a=Math.max(a,Math.floor(l.length/e.count)),r.push({offset:s,data:l,attribute:o}),s+=e.size}if(t.normals&&t.normals.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===bo.ATTR_NORMAL){o=e;break}o||(o=B2[1]);const e=Aa[o.format];n.push(o),a=Math.max(a,Math.floor(t.normals.length/e.count)),r.push({offset:s,data:t.normals,attribute:o}),s+=e.size}if(t.uvs&&t.uvs.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===bo.ATTR_TEX_COORD){o=e;break}o||(o=B2[2]);const e=Aa[o.format];n.push(o),a=Math.max(a,Math.floor(t.uvs.length/e.count)),r.push({offset:s,data:t.uvs,attribute:o}),s+=e.size}if(t.tangents&&t.tangents.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===bo.ATTR_TANGENT){o=e;break}o||(o=B2[3]);const e=Aa[o.format];n.push(o),a=Math.max(a,Math.floor(t.tangents.length/e.count)),r.push({offset:s,data:t.tangents,attribute:o}),s+=e.size}if(t.colors&&t.colors.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===bo.ATTR_COLOR){o=e;break}o||(o=B2[4]);const e=Aa[o.format];n.push(o),a=Math.max(a,Math.floor(t.colors.length/e.count)),r.push({offset:s,data:t.colors,attribute:o}),s+=e.size}if(t.customAttributes)for(const e of t.customAttributes){const t=Aa[e.attr.format];n.push(e.attr),a=Math.max(a,Math.floor(e.values.length/t.count)),r.push({offset:s,data:e.values,attribute:e.attr}),s+=t.size}const c=new P1,h=new ArrayBuffer(a*s),_=new DataView(h);for(const t of r)BS(_,t.data,t.attribute.format,t.offset,s);c.setNextAlignment(0);const u={attributes:n,view:{offset:c.getLength(),length:h.byteLength,count:a,stride:s}};c.addBuffer(h);let m=null,d=0;if(t.indices){const{indices:e}=t;d=e.length,m=new ArrayBuffer(2*d),BS(new DataView(m),e,jr.R16UI)}const p={primitiveMode:t.primitiveMode||mo.TRIANGLE_LIST,vertexBundelIndices:[0]};m&&(c.setNextAlignment(2),p.indexView={offset:c.getLength(),length:m.byteLength,count:d,stride:2},c.addBuffer(m));let f=t.minPos;if(!f&&i.calculateBounds){f=oi.set(new oi,1/0,1/0,1/0);for(let t=0;t<a;++t)oi.set(O2,l[3*t+0],l[3*t+1],l[3*t+2]),oi.min(f,f,O2)}let g=t.maxPos;if(!g&&i.calculateBounds){g=oi.set(new oi,-1/0,-1/0,-1/0);for(let t=0;t<a;++t)oi.set(O2,l[3*t+0],l[3*t+1],l[3*t+2]),oi.max(g,g,O2)}const y={vertexBundles:[u],primitives:[p]};return f&&(y.minPosition=new oi(f.x,f.y,f.z)),g&&(y.maxPosition=new oi(g.x,g.y,g.z)),e||(e=new W1),e.reset({struct:y,data:new Uint8Array(c.getCombined())}),e}({positions:c,indices:h,colors:_});const d=new ov;d.initialize({effectName:"profiler"});const p=this.pass=d.passes[0],f=p.getBinding("mainTexture"),g=p.getBinding("digits"),y=p.getBinding("offset");p.bindTexture(f,this._texture),this.digitsData=p.blocks[g],this.offsetData=p.blocks[y],this.offsetData[3]=-1,m.material=d,m.node.layer=Ec.Enum.PROFILER,this._inited=!0}beforeUpdate(){if(!this._stats)return;const t=performance.now();this._stats.frame.counter.end(t),this._stats.frame.counter.start(t),this._stats.logic.counter.start(t)}afterUpdate(){if(!this._stats)return;const t=performance.now();n.director.isPaused()?this._stats.frame.counter.start(t):this._stats.logic.counter.end(t)}beforePhysics(){if(!this._stats)return;const t=performance.now();this._stats.physics.counter.start(t)}afterPhysics(){if(!this._stats)return;const t=performance.now();this._stats.physics.counter.end(t)}beforeDraw(){if(!this._stats)return;{const t=this._device.surfaceTransform,e=this._device.capabilities.clipSpaceSignY;if(t!==this.offsetData[3]){const i=xi[t],n=-.9,s=-.9*e;this.offsetData[0]=n*i[0]+s*i[2],this.offsetData[1]=n*i[1]+s*i[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=t}this.pass._rootBufferDirty=!0}const t=performance.now();this._stats.render.counter.start(t)}afterDraw(){if(!this._stats||!this._inited)return;const t=performance.now();if(this._stats.fps.counter.frame(t),this._stats.render.counter.end(t),t-this.lastTime<500)return;this.lastTime=t;const e=this._device;this._stats.draws.counter.value=e.numDrawCalls,this._stats.instances.counter.value=e.numInstances,this._stats.bufferMemory.counter.value=e.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=e.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=e.numTris;let i=0;{const e=this.digitsData;for(const n in this._stats){const s=this._stats[n];s.counter.sample(t);const r=s.counter.human().toString();for(let t=U2.segmentsPerLine-1;t>=0;t--){const n=i*U2.segmentsPerLine+t,s=r[r.length-(U2.segmentsPerLine-t)];let o=z2[s];void 0===o&&(o=11),e[n]=o}i++}}}}t("Profiler",G2);const H2=t("profiler",new G2);n.profiler=H2;const k2=Gt({GRAVITY:0,RADIUS:1}),j2=Gt({FREE:0,RELATIVE:1,GROUPED:2}),W2=new Ti(0,0),q2=new Ti,X2=new Ti,Y2=new Ti,K2=new Ti,J2=sN(iN);class $2{constructor(){this.pos=new Ti(0,0),this.startPos=new Ti(0,0),this.color=new si(0,0,0,255),this.deltaColor={r:0,g:0,b:0,a:255},this.size=0,this.deltaSize=0,this.rotation=0,this.deltaRotation=0,this.timeToLive=0,this.drawPos=new Ti(0,0),this.aspectRatio=1,this.dir=new Ti(0,0),this.radialAccel=0,this.tangentialAccel=0,this.angle=0,this.degreesPerSecond=0,this.radius=0,this.deltaRadius=0}}const Z2=new class extends Ft{get(){return this._get()||new $2}}((t=>{t.pos.set(W2),t.startPos.set(W2),t.color._val=4278190080,t.deltaColor.r=t.deltaColor.g=t.deltaColor.b=0,t.deltaColor.a=255,t.size=0,t.deltaSize=0,t.rotation=0,t.deltaRotation=0,t.timeToLive=0,t.drawPos.set(W2),t.aspectRatio=1,t.dir.set(W2),t.radialAccel=0,t.tangentialAccel=0,t.angle=0,t.degreesPerSecond=0,t.radius=0,t.deltaRadius=0}),1024);class Q2{constructor(t){this.particles=[],this.active=!1,this.uvFilled=0,this.finished=!1,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this._worldRotation=0,this.sys=t,this.particles=[],this.active=!1,this.readyToPlay=!0,this.finished=!1,this.elapsed=0,this.emitCounter=0,this.uvFilled=0,this._worldRotation=0}stop(){this.active=!1,this.readyToPlay=!1,this.elapsed=this.sys.duration,this.emitCounter=0}reset(){this.active=!0,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this.finished=!1;const t=this.particles;for(let e=0;e<t.length;++e)Z2.put(t[e]);t.length=0}emitParticle(t){const e=this.sys,i=Z2.get();this.particles.push(i),i.timeToLive=e.life+e.lifeVar*(Math.random()-.5)*2;const n=i.timeToLive=Math.max(0,i.timeToLive);i.pos.x=e.sourcePos.x+e.posVar.x*(Math.random()-.5)*2,i.pos.y=e.sourcePos.y+e.posVar.y*(Math.random()-.5)*2;let s=0,r=0,o=0,a=0;const l=e.startColor,c=e.startColorVar,h=e.endColor,_=e.endColorVar;i.color.r=s=ie(l.r+c.r*(Math.random()-.5)*2,0,255),i.color.g=r=ie(l.g+c.g*(Math.random()-.5)*2,0,255),i.color.b=o=ie(l.b+c.b*(Math.random()-.5)*2,0,255),i.color.a=a=ie(l.a+c.a*(Math.random()-.5)*2,0,255),i.deltaColor.r=(ie(h.r+_.r*(Math.random()-.5)*2,0,255)-s)/n,i.deltaColor.g=(ie(h.g+_.g*(Math.random()-.5)*2,0,255)-r)/n,i.deltaColor.b=(ie(h.b+_.b*(Math.random()-.5)*2,0,255)-o)/n,i.deltaColor.a=(ie(h.a+_.a*(Math.random()-.5)*2,0,255)-a)/n;let u=e.startSize+e.startSizeVar*(Math.random()-.5)*2;if(u=Math.max(0,u),i.size=u,-1===e.endSize)i.deltaSize=0;else{let t=e.endSize+e.endSizeVar*(Math.random()-.5)*2;t=Math.max(0,t),i.deltaSize=(t-u)/n}const m=e.startSpin+e.startSpinVar*(Math.random()-.5)*2,d=e.endSpin+e.endSpinVar*(Math.random()-.5)*2;i.rotation=m,i.deltaRotation=(d-m)/n,i.startPos.x=t.x,i.startPos.y=t.y,i.aspectRatio=e.aspectRatio||1;const p=ne(e.angle+this._worldRotation+e.angleVar*(Math.random()-.5)*2);if(e.emitterMode===k2.GRAVITY){const t=e.speed+e.speedVar*(Math.random()-.5)*2;i.dir.x=Math.cos(p),i.dir.y=Math.sin(p),i.dir.multiplyScalar(t),i.radialAccel=e.radialAccel+e.radialAccelVar*(Math.random()-.5)*2,i.tangentialAccel=e.tangentialAccel+e.tangentialAccelVar*(Math.random()-.5)*2,e.rotationIsDir&&(i.rotation=-se(Math.atan2(i.dir.y,i.dir.x)))}else{const t=e.startRadius+e.startRadiusVar*(Math.random()-.5)*2,s=e.endRadius+e.endRadiusVar*(Math.random()-.5)*2;i.radius=t,i.deltaRadius=-1===e.endRadius?0:(s-t)/n,i.angle=p,i.degreesPerSecond=ne(e.rotatePerS+e.rotatePerSVar*(Math.random()-.5)*2)}}updateUVs(t){const e=this.renderData;if(e&&this.sys._renderSpriteFrame){const i=e.vData,n=this.sys._renderSpriteFrame.uv,s=t?0:this.uvFilled,r=this.particles.length;for(let t=s;t<r;t++){const e=t*J2*4;i[e+3]=n[0],i[e+4]=n[1],i[e+12]=n[2],i[e+13]=n[3],i[e+21]=n[4],i[e+22]=n[5],i[e+30]=n[6],i[e+31]=n[7]}this.uvFilled=r}}updateParticleBuffer(t,e,i,n){const s=i.vData,r=e.x,o=e.y;let a=t.size,l=a;const c=t.aspectRatio;c>1?l=a/c:a=l*c;const h=a/2,_=l/2;if(t.rotation){const e=-h,i=-_,a=h,l=_,c=-ne(t.rotation),u=Math.cos(c),m=Math.sin(c);s[n]=e*u-i*m+r,s[n+1]=e*m+i*u+o,s[n+2]=0,s[n+9]=a*u-i*m+r,s[n+10]=a*m+i*u+o,s[n+11]=0,s[n+18]=e*u-l*m+r,s[n+19]=e*m+l*u+o,s[n+20]=0,s[n+27]=a*u-l*m+r,s[n+28]=a*m+l*u+o,s[n+29]=0}else s[n]=r-h,s[n+1]=o-_,s[n+2]=0,s[n+9]=r+h,s[n+10]=o-_,s[n+11]=0,s[n+18]=r-h,s[n+19]=o+_,s[n+20]=0,s[n+27]=r+h,s[n+28]=o+_,s[n+29]=0;si.toArray(s,t.color,n+5),si.toArray(s,t.color,n+14),si.toArray(s,t.color,n+23),si.toArray(s,t.color,n+32)}step(t){const e=this.sys.assembler,i=this.sys,n=i.node,s=this.particles;if(t=t>e.maxParticleDeltaTime?e.maxParticleDeltaTime:t,n.updateWorldTransform(),i.positionType===j2.FREE){this._worldRotation=function(t){let e=0,i=t;for(;i;)e+=i.eulerAngles.z,i=i.parent;return e}(n);const t=n.worldMatrix;q2.x=t.m12,q2.y=t.m13}else i.positionType===j2.RELATIVE?(this._worldRotation=n.eulerAngles.z,q2.x=n.position.x,q2.y=n.position.y):this._worldRotation=0;if(this.active&&i.emissionRate){const e=1/i.emissionRate;for(s.length<i.totalParticles&&(this.emitCounter+=t);s.length<i.totalParticles&&this.emitCounter>e;)this.emitParticle(q2),this.emitCounter-=e;this.elapsed+=t,-1!==i.duration&&i.duration<this.elapsed&&i.stopSystem()}const r=this.renderData,o=s.length;r.reset(),this.requestData(4*o,6*o),o>this.uvFilled&&this.updateUVs();let a=0;for(;a<s.length;){X2.x=X2.y=Y2.x=Y2.y=K2.x=K2.y=0;const e=s[a];if(e.timeToLive-=t,e.timeToLive>0){if(i.emitterMode===k2.GRAVITY){const n=K2,s=X2,r=Y2;(e.pos.x||e.pos.y)&&(s.set(e.pos),s.normalize()),r.set(s),s.multiplyScalar(e.radialAccel);const o=r.x;r.x=-r.y,r.y=o,r.multiplyScalar(e.tangentialAccel),n.set(s),n.add(r),n.add(i.gravity),n.multiplyScalar(t),e.dir.add(n),n.set(e.dir),n.multiplyScalar(t),e.pos.add(n)}else e.angle+=e.degreesPerSecond*t,e.radius+=e.deltaRadius*t,e.pos.x=-Math.cos(e.angle)*e.radius,e.pos.y=-Math.sin(e.angle)*e.radius;e.color.r+=e.deltaColor.r*t,e.color.g+=e.deltaColor.g*t,e.color.b+=e.deltaColor.b*t,e.color.a+=e.deltaColor.a*t,e.size+=e.deltaSize*t,e.size<0&&(e.size=0),e.rotation+=e.deltaRotation*t;const n=X2;n.set(e.pos),i.positionType!==j2.GROUPED&&n.add(e.startPos);const s=J2*a*4;this.updateParticleBuffer(e,n,r,s),++a}else{const t=s[a];a!==s.length-1&&(s[a]=s[s.length-1]),Z2.put(t),s.length--,r.indicesCount-=6,r.vertexCount-=4}}0!==s.length||this.active||this.readyToPlay||(this.finished=!0,i._finishedSimulation())}requestData(t,e){let i=this.renderData.indicesCount;this.renderData.request(t,e);const n=this.renderData.indicesCount/6,s=this.renderData.iData;for(let t=i;t<n;t++){const e=4*t;s[i++]=e,s[i++]=e+1,s[i++]=e+2,s[i++]=e+1,s[i++]=e+3,s[i++]=e+2}}}var t4,e4,i4;let n4=t("ParticleAsset",u_("cc.ParticleAsset")((i4=n_((e4=class extends xu{constructor(...t){super(...t),i_(this,"spriteFrame",i4,this)}}).prototype,"spriteFrame",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),t4=e4))||t4);n.ParticleAsset=n4;
/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
var s4={};(function(){function t(t){throw t}var e=void 0,i=!0,n=this;function s(t,i){var s,r=t.split("."),o=n;!(r[0]in o)&&o.execScript&&o.execScript("var "+r[0]);for(;r.length&&(s=r.shift());)r.length||i===e?o=o[s]?o[s]:o[s]={}:o[s]=i}var r="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array;function o(t){if("string"==typeof t){var e,i,n=t.split("");for(e=0,i=n.length;e<i;e++)n[e]=(255&n[e].charCodeAt(0))>>>0;t=n}for(var s,r=1,o=0,a=t.length,l=0;0<a;){a-=s=1024<a?1024:a;do{o+=r+=t[l++]}while(--s);r%=65521,o%=65521}return(o<<16|r)>>>0}function a(e,i){this.index="number"==typeof i?i:0,this.i=0,this.buffer=e instanceof(r?Uint8Array:Array)?e:new(r?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&t(Error("invalid index")),this.buffer.length<=this.index&&this.f()}a.prototype.f=function(){var t,e=this.buffer,i=e.length,n=new(r?Uint8Array:Array)(i<<1);if(r)n.set(e);else for(t=0;t<i;++t)n[t]=e[t];return this.buffer=n},a.prototype.d=function(t,e,i){var n,s=this.buffer,r=this.index,o=this.i,a=s[r];if(i&&1<e&&(t=8<e?(m[255&t]<<24|m[t>>>8&255]<<16|m[t>>>16&255]<<8|m[t>>>24&255])>>32-e:m[t]>>8-e),8>e+o)a=a<<e|t,o+=e;else for(n=0;n<e;++n)a=a<<1|t>>e-n-1&1,8==++o&&(o=0,s[r++]=m[a],a=0,r===s.length&&(s=this.f()));s[r]=a,this.buffer=s,this.i=o,this.index=r},a.prototype.finish=function(){var t,e=this.buffer,i=this.index;return 0<this.i&&(e[i]<<=8-this.i,e[i]=m[e[i]],i++),r?t=e.subarray(0,i):(e.length=i,t=e),t};var l,c=new(r?Uint8Array:Array)(256);for(l=0;256>l;++l){for(var h=u=l,_=7,u=u>>>1;u;u>>>=1)h<<=1,h|=1&u,--_;c[l]=(h<<_&255)>>>0}var m=c;function d(t){this.buffer=new(r?Uint16Array:Array)(2*t),this.length=0}function p(t){var e,i,n,s,o,a,l,c,h,_=t.length,u=0,m=Number.POSITIVE_INFINITY;for(c=0;c<_;++c)t[c]>u&&(u=t[c]),t[c]<m&&(m=t[c]);for(e=1<<u,i=new(r?Uint32Array:Array)(e),n=1,s=0,o=2;n<=u;){for(c=0;c<_;++c)if(t[c]===n){for(a=0,l=s,h=0;h<n;++h)a=a<<1|1&l,l>>=1;for(h=a;h<e;h+=o)i[h]=n<<16|c;++s}++n,s<<=1,o<<=1}return[i,u,m]}function f(t,e){this.h=y,this.w=0,this.input=t,this.b=0,e&&(e.lazy&&(this.w=e.lazy),"number"==typeof e.compressionType&&(this.h=e.compressionType),e.outputBuffer&&(this.a=r&&e.outputBuffer instanceof Array?new Uint8Array(e.outputBuffer):e.outputBuffer),"number"==typeof e.outputIndex&&(this.b=e.outputIndex)),this.a||(this.a=new(r?Uint8Array:Array)(32768))}d.prototype.getParent=function(t){return 2*((t-2)/4|0)},d.prototype.push=function(t,e){var i,n,s,r=this.buffer;for(i=this.length,r[this.length++]=e,r[this.length++]=t;0<i&&(n=this.getParent(i),r[i]>r[n]);)s=r[i],r[i]=r[n],r[n]=s,s=r[i+1],r[i+1]=r[n+1],r[n+1]=s,i=n;return this.length},d.prototype.pop=function(){var t,e,i,n,s,r=this.buffer;for(e=r[0],t=r[1],this.length-=2,r[0]=r[this.length],r[1]=r[this.length+1],s=0;!((n=2*s+2)>=this.length)&&(n+2<this.length&&r[n+2]>r[n]&&(n+=2),r[n]>r[s]);)i=r[s],r[s]=r[n],r[n]=i,i=r[s+1],r[s+1]=r[n+1],r[n+1]=i,s=n;return{index:t,value:e,length:this.length}};var g,y=2,v={NONE:0,r:1,j:y,N:3},x=[];for(g=0;288>g;g++)switch(i){case 143>=g:x.push([g+48,8]);break;case 255>=g:x.push([g-144+400,9]);break;case 279>=g:x.push([g-256+0,7]);break;case 287>=g:x.push([g-280+192,8]);break;default:t("invalid literal: "+g)}function S(t,e){this.length=t,this.G=e}function A(){var e=C;switch(i){case 3===e:return[257,e-3,0];case 4===e:return[258,e-4,0];case 5===e:return[259,e-5,0];case 6===e:return[260,e-6,0];case 7===e:return[261,e-7,0];case 8===e:return[262,e-8,0];case 9===e:return[263,e-9,0];case 10===e:return[264,e-10,0];case 12>=e:return[265,e-11,1];case 14>=e:return[266,e-13,1];case 16>=e:return[267,e-15,1];case 18>=e:return[268,e-17,1];case 22>=e:return[269,e-19,2];case 26>=e:return[270,e-23,2];case 30>=e:return[271,e-27,2];case 34>=e:return[272,e-31,2];case 42>=e:return[273,e-35,3];case 50>=e:return[274,e-43,3];case 58>=e:return[275,e-51,3];case 66>=e:return[276,e-59,3];case 82>=e:return[277,e-67,4];case 98>=e:return[278,e-83,4];case 114>=e:return[279,e-99,4];case 130>=e:return[280,e-115,4];case 162>=e:return[281,e-131,5];case 194>=e:return[282,e-163,5];case 226>=e:return[283,e-195,5];case 257>=e:return[284,e-227,5];case 258===e:return[285,e-258,0];default:t("invalid length: "+e)}}f.prototype.n=function(){var n,s,o,l,c=this.input;switch(this.h){case 0:for(o=0,l=c.length;o<l;){var h,_,u,m=s=r?c.subarray(o,o+65535):c.slice(o,o+65535),d=(o+=s.length)===l,p=e,f=e,g=this.a,v=this.b;if(r){for(g=new Uint8Array(this.a.buffer);g.length<=v+m.length+5;)g=new Uint8Array(g.length<<1);g.set(this.a)}if(h=d?1:0,g[v++]=0|h,u=65536+~(_=m.length)&65535,g[v++]=255&_,g[v++]=_>>>8&255,g[v++]=255&u,g[v++]=u>>>8&255,r)g.set(m,v),v+=m.length,g=g.subarray(0,v);else{for(p=0,f=m.length;p<f;++p)g[v++]=m[p];g.length=v}this.b=v,this.a=g}break;case 1:var S=new a(new Uint8Array(this.a.buffer),this.b);S.d(1,1,i),S.d(1,2,i);var A,C,b,T=E(this,c);for(A=0,C=T.length;A<C;A++)if(b=T[A],a.prototype.d.apply(S,x[b]),256<b)S.d(T[++A],T[++A],i),S.d(T[++A],5),S.d(T[++A],T[++A],i);else if(256===b)break;this.a=S.finish(),this.b=this.a.length;break;case y:var w,D,R,M,B,O,N,L,F,z,V,U,G,H,k,j=new a(new Uint8Array(this.a),this.b),W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],q=Array(19);for(w=y,j.d(1,1,i),j.d(w,2,i),D=E(this,c),N=I(O=P(this.L,15)),F=I(L=P(this.K,7)),R=286;257<R&&0===O[R-1];R--);for(M=30;1<M&&0===L[M-1];M--);var X,Y,K,J,$,Z,Q=R,tt=M,et=new(r?Uint32Array:Array)(Q+tt),it=new(r?Uint32Array:Array)(316),nt=new(r?Uint8Array:Array)(19);for(X=Y=0;X<Q;X++)et[Y++]=O[X];for(X=0;X<tt;X++)et[Y++]=L[X];if(!r)for(X=0,J=nt.length;X<J;++X)nt[X]=0;for(X=$=0,J=et.length;X<J;X+=Y){for(Y=1;X+Y<J&&et[X+Y]===et[X];++Y);if(K=Y,0===et[X])if(3>K)for(;0<K--;)it[$++]=0,nt[0]++;else for(;0<K;)(Z=138>K?K:138)>K-3&&Z<K&&(Z=K-3),10>=Z?(it[$++]=17,it[$++]=Z-3,nt[17]++):(it[$++]=18,it[$++]=Z-11,nt[18]++),K-=Z;else if(it[$++]=et[X],nt[et[X]]++,3>--K)for(;0<K--;)it[$++]=et[X],nt[et[X]]++;else for(;0<K;)(Z=6>K?K:6)>K-3&&Z<K&&(Z=K-3),it[$++]=16,it[$++]=Z-3,nt[16]++,K-=Z}for(n=r?it.subarray(0,$):it.slice(0,$),z=P(nt,7),H=0;19>H;H++)q[H]=z[W[H]];for(B=19;4<B&&0===q[B-1];B--);for(V=I(z),j.d(R-257,5,i),j.d(M-1,5,i),j.d(B-4,4,i),H=0;H<B;H++)j.d(q[H],3,i);for(H=0,k=n.length;H<k;H++)if(U=n[H],j.d(V[U],z[U],i),16<=U){switch(H++,U){case 16:G=2;break;case 17:G=3;break;case 18:G=7;break;default:t("invalid code: "+U)}j.d(n[H],G,i)}var st,rt,ot,at,lt,ct,ht,_t,ut=[N,O],mt=[F,L];for(lt=ut[0],ct=ut[1],ht=mt[0],_t=mt[1],st=0,rt=D.length;st<rt;++st)if(ot=D[st],j.d(lt[ot],ct[ot],i),256<ot)j.d(D[++st],D[++st],i),at=D[++st],j.d(ht[at],_t[at],i),j.d(D[++st],D[++st],i);else if(256===ot)break;this.a=j.finish(),this.b=this.a.length;break;default:t("invalid compression type")}return this.a};var C,b,T=[];for(C=3;258>=C;C++)b=A(),T[C]=b[2]<<24|b[1]<<16|b[0];var w=r?new Uint32Array(T):T;function E(n,s){function o(e,n){var s,r,o,a,l=e.G,c=[],h=0;switch(s=w[e.length],c[h++]=65535&s,c[h++]=s>>16&255,c[h++]=s>>24,i){case 1===l:r=[0,l-1,0];break;case 2===l:r=[1,l-2,0];break;case 3===l:r=[2,l-3,0];break;case 4===l:r=[3,l-4,0];break;case 6>=l:r=[4,l-5,1];break;case 8>=l:r=[5,l-7,1];break;case 12>=l:r=[6,l-9,2];break;case 16>=l:r=[7,l-13,2];break;case 24>=l:r=[8,l-17,3];break;case 32>=l:r=[9,l-25,3];break;case 48>=l:r=[10,l-33,4];break;case 64>=l:r=[11,l-49,4];break;case 96>=l:r=[12,l-65,5];break;case 128>=l:r=[13,l-97,5];break;case 192>=l:r=[14,l-129,6];break;case 256>=l:r=[15,l-193,6];break;case 384>=l:r=[16,l-257,7];break;case 512>=l:r=[17,l-385,7];break;case 768>=l:r=[18,l-513,8];break;case 1024>=l:r=[19,l-769,8];break;case 1536>=l:r=[20,l-1025,9];break;case 2048>=l:r=[21,l-1537,9];break;case 3072>=l:r=[22,l-2049,10];break;case 4096>=l:r=[23,l-3073,10];break;case 6144>=l:r=[24,l-4097,11];break;case 8192>=l:r=[25,l-6145,11];break;case 12288>=l:r=[26,l-8193,12];break;case 16384>=l:r=[27,l-12289,12];break;case 24576>=l:r=[28,l-16385,13];break;case 32768>=l:r=[29,l-24577,13];break;default:t("invalid distance")}for(s=r,c[h++]=s[0],c[h++]=s[1],c[h++]=s[2],o=0,a=c.length;o<a;++o)g[y++]=c[o];x[c[0]]++,A[c[3]]++,v=e.length+n-1,d=null}var a,l,c,h,_,u,m,d,p,f={},g=r?new Uint16Array(2*s.length):[],y=0,v=0,x=new(r?Uint32Array:Array)(286),A=new(r?Uint32Array:Array)(30),C=n.w;if(!r){for(c=0;285>=c;)x[c++]=0;for(c=0;29>=c;)A[c++]=0}for(x[256]=1,a=0,l=s.length;a<l;++a){for(c=_=0,h=3;c<h&&a+c!==l;++c)_=_<<8|s[a+c];if(f[_]===e&&(f[_]=[]),u=f[_],!(0<v--)){for(;0<u.length&&32768<a-u[0];)u.shift();if(a+3>=l){for(d&&o(d,-1),c=0,h=l-a;c<h;++c)p=s[a+c],g[y++]=p,++x[p];break}if(0<u.length){var b=e,T=e,E=0,P=e,I=e,D=e,R=s.length,M=(I=0,u.length);t:for(;I<M;I++){if(b=u[M-I-1],P=3,3<E){for(D=E;3<D;D--)if(s[b+D-1]!==s[a+D-1])continue t;P=E}for(;258>P&&a+P<R&&s[b+P]===s[a+P];)++P;if(P>E&&(T=b,E=P),258===P)break}m=new S(E,a-T),d?d.length<m.length?(p=s[a-1],g[y++]=p,++x[p],o(m,0)):o(d,-1):m.length<C?d=m:o(m,0)}else d?o(d,-1):(p=s[a],g[y++]=p,++x[p])}u.push(a)}return g[y++]=256,x[256]++,n.L=x,n.K=A,r?g.subarray(0,y):g}function P(t,e){function i(t){var e=C[t][b[t]];e===y?(i(t+1),i(t+1)):--S[e],++b[t]}var n,s,o,a,l,c=t.length,h=new d(572),_=new(r?Uint8Array:Array)(c);if(!r)for(a=0;a<c;a++)_[a]=0;for(a=0;a<c;++a)0<t[a]&&h.push(a,t[a]);if(n=Array(h.length/2),s=new(r?Uint32Array:Array)(h.length/2),1===n.length)return _[h.pop().index]=1,_;for(a=0,l=h.length/2;a<l;++a)n[a]=h.pop(),s[a]=n[a].value;var u,m,p,f,g,y=s.length,v=new(r?Uint16Array:Array)(e),x=new(r?Uint8Array:Array)(e),S=new(r?Uint8Array:Array)(y),A=Array(e),C=Array(e),b=Array(e),T=(1<<e)-y,w=1<<e-1;for(v[e-1]=y,m=0;m<e;++m)T<w?x[m]=0:(x[m]=1,T-=w),T<<=1,v[e-2-m]=(v[e-1-m]/2|0)+y;for(v[0]=x[0],A[0]=Array(v[0]),C[0]=Array(v[0]),m=1;m<e;++m)v[m]>2*v[m-1]+x[m]&&(v[m]=2*v[m-1]+x[m]),A[m]=Array(v[m]),C[m]=Array(v[m]);for(u=0;u<y;++u)S[u]=e;for(p=0;p<v[e-1];++p)A[e-1][p]=s[p],C[e-1][p]=p;for(u=0;u<e;++u)b[u]=0;for(1===x[e-1]&&(--S[0],++b[e-1]),m=e-2;0<=m;--m){for(f=u=0,g=b[m+1],p=0;p<v[m];p++)(f=A[m+1][g]+A[m+1][g+1])>s[u]?(A[m][p]=f,C[m][p]=y,g+=2):(A[m][p]=s[u],C[m][p]=u,++u);b[m]=0,1===x[m]&&i(m)}for(o=S,a=0,l=n.length;a<l;++a)_[n[a].index]=o[a];return _}function I(e){var i,n,s,o,a=new(r?Uint16Array:Array)(e.length),l=[],c=[],h=0;for(i=0,n=e.length;i<n;i++)l[e[i]]=1+(0|l[e[i]]);for(i=1,n=16;i<=n;i++)c[i]=h,(h+=0|l[i])>1<<i&&t("overcommitted"),h<<=1;for(65536>h&&t("undercommitted"),i=0,n=e.length;i<n;i++)for(h=c[e[i]],c[e[i]]+=1,s=a[i]=0,o=e[i];s<o;s++)a[i]=a[i]<<1|1&h,h>>>=1;return a}function D(t,e){this.input=t,this.a=new(r?Uint8Array:Array)(32768),this.h=R.j;var i,n={};for(i in!e&&(e={})||"number"!=typeof e.compressionType||(this.h=e.compressionType),e)n[i]=e[i];n.outputBuffer=this.a,this.z=new f(this.input,n)}var R=v;function M(e,i){switch(this.k=[],this.l=32768,this.e=this.g=this.c=this.q=0,this.input=r?new Uint8Array(e):e,this.s=!1,this.m=O,this.B=!1,!i&&(i={})||(i.index&&(this.c=i.index),i.bufferSize&&(this.l=i.bufferSize),i.bufferType&&(this.m=i.bufferType),i.resize&&(this.B=i.resize)),this.m){case B:this.b=32768,this.a=new(r?Uint8Array:Array)(32768+this.l+258);break;case O:this.b=0,this.a=new(r?Uint8Array:Array)(this.l),this.f=this.J,this.t=this.H,this.o=this.I;break;default:t(Error("invalid inflate mode"))}}D.prototype.n=function(){var e,i,n,s,a,l,c,h=0;switch(c=this.a,e=ht){case ht:i=Math.LOG2E*Math.log(32768)-8;break;default:t(Error("invalid compression method"))}switch(n=i<<4|e,c[h++]=n,e){case ht:switch(this.h){case R.NONE:a=0;break;case R.r:a=1;break;case R.j:a=2;break;default:t(Error("unsupported compression type"))}break;default:t(Error("invalid compression method"))}return s=a<<6|0,c[h++]=s|31-(256*n+s)%31,l=o(this.input),this.z.b=h,h=(c=this.z.n()).length,r&&((c=new Uint8Array(c.buffer)).length<=h+4&&(this.a=new Uint8Array(c.length+4),this.a.set(c),c=this.a),c=c.subarray(0,h+4)),c[h++]=l>>24&255,c[h++]=l>>16&255,c[h++]=l>>8&255,c[h++]=255&l,c},s("Zlib.Deflate",D),s("Zlib.Deflate.compress",(function(t,e){return new D(t,e).n()})),s("Zlib.Deflate.CompressionType",R),s("Zlib.Deflate.CompressionType.NONE",R.NONE),s("Zlib.Deflate.CompressionType.FIXED",R.r),s("Zlib.Deflate.CompressionType.DYNAMIC",R.j);var B=0,O=1,N={D:B,C:O};M.prototype.p=function(){for(;!this.s;){var n=tt(this,3);switch(1&n&&(this.s=i),n>>>=1){case 0:var s=this.input,o=this.c,a=this.a,l=this.b,c=e,h=e,_=e,u=a.length,m=e;switch(this.e=this.g=0,(c=s[o++])===e&&t(Error("invalid uncompressed block header: LEN (first byte)")),h=c,(c=s[o++])===e&&t(Error("invalid uncompressed block header: LEN (second byte)")),h|=c<<8,(c=s[o++])===e&&t(Error("invalid uncompressed block header: NLEN (first byte)")),_=c,(c=s[o++])===e&&t(Error("invalid uncompressed block header: NLEN (second byte)")),h===~(_|=c<<8)&&t(Error("invalid uncompressed block header: length verify")),o+h>s.length&&t(Error("input buffer is broken")),this.m){case B:for(;l+h>a.length;){if(h-=m=u-l,r)a.set(s.subarray(o,o+m),l),l+=m,o+=m;else for(;m--;)a[l++]=s[o++];this.b=l,a=this.f(),l=this.b}break;case O:for(;l+h>a.length;)a=this.f({v:2});break;default:t(Error("invalid inflate mode"))}if(r)a.set(s.subarray(o,o+h),l),l+=h,o+=h;else for(;h--;)a[l++]=s[o++];this.c=o,this.b=l,this.a=a;break;case 1:this.o($,Q);break;case 2:it(this);break;default:t(Error("unknown BTYPE: "+n))}}return this.t()};var L,F,z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],V=r?new Uint16Array(z):z,U=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],G=r?new Uint16Array(U):U,H=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],k=r?new Uint8Array(H):H,j=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],W=r?new Uint16Array(j):j,q=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],X=r?new Uint8Array(q):q,Y=new(r?Uint8Array:Array)(288);for(L=0,F=Y.length;L<F;++L)Y[L]=143>=L?8:255>=L?9:279>=L?7:8;var K,J,$=p(Y),Z=new(r?Uint8Array:Array)(30);for(K=0,J=Z.length;K<J;++K)Z[K]=5;var Q=p(Z);function tt(i,n){for(var s,r=i.g,o=i.e,a=i.input,l=i.c;o<n;)(s=a[l++])===e&&t(Error("input buffer is broken")),r|=s<<o,o+=8;return s=r&(1<<n)-1,i.g=r>>>n,i.e=o-n,i.c=l,s}function et(i,n){for(var s,r,o,a=i.g,l=i.e,c=i.input,h=i.c,_=n[0],u=n[1];l<u;)(s=c[h++])===e&&t(Error("input buffer is broken")),a|=s<<l,l+=8;return o=(r=_[a&(1<<u)-1])>>>16,i.g=a>>o,i.e=l-o,i.c=h,65535&r}function it(t){function e(t,e,i){var n,s,r,o;for(o=0;o<t;)switch(n=et(this,e),n){case 16:for(r=3+tt(this,2);r--;)i[o++]=s;break;case 17:for(r=3+tt(this,3);r--;)i[o++]=0;s=0;break;case 18:for(r=11+tt(this,7);r--;)i[o++]=0;s=0;break;default:s=i[o++]=n}return i}var i,n,s,o,a=tt(t,5)+257,l=tt(t,5)+1,c=tt(t,4)+4,h=new(r?Uint8Array:Array)(V.length);for(o=0;o<c;++o)h[V[o]]=tt(t,3);i=p(h),n=new(r?Uint8Array:Array)(a),s=new(r?Uint8Array:Array)(l),t.o(p(e.call(t,a,i,n)),p(e.call(t,l,i,s)))}function nt(e,i){var n,s;switch(this.input=e,this.c=0,!i&&(i={})||(i.index&&(this.c=i.index),i.verify&&(this.M=i.verify)),n=e[this.c++],s=e[this.c++],15&n){case ht:this.method=ht;break;default:t(Error("unsupported compression method"))}0!=((n<<8)+s)%31&&t(Error("invalid fcheck flag:"+((n<<8)+s)%31)),32&s&&t(Error("fdict flag is not supported")),this.A=new M(e,{index:this.c,bufferSize:i.bufferSize,bufferType:i.bufferType,resize:i.resize})}M.prototype.o=function(t,e){var i=this.a,n=this.b;this.u=t;for(var s,r,o,a,l=i.length-258;256!==(s=et(this,t));)if(256>s)n>=l&&(this.b=n,i=this.f(),n=this.b),i[n++]=s;else for(a=G[r=s-257],0<k[r]&&(a+=tt(this,k[r])),s=et(this,e),o=W[s],0<X[s]&&(o+=tt(this,X[s])),n>=l&&(this.b=n,i=this.f(),n=this.b);a--;)i[n]=i[n++-o];for(;8<=this.e;)this.e-=8,this.c--;this.b=n},M.prototype.I=function(t,e){var i=this.a,n=this.b;this.u=t;for(var s,r,o,a,l=i.length;256!==(s=et(this,t));)if(256>s)n>=l&&(l=(i=this.f()).length),i[n++]=s;else for(a=G[r=s-257],0<k[r]&&(a+=tt(this,k[r])),s=et(this,e),o=W[s],0<X[s]&&(o+=tt(this,X[s])),n+a>l&&(l=(i=this.f()).length);a--;)i[n]=i[n++-o];for(;8<=this.e;)this.e-=8,this.c--;this.b=n},M.prototype.f=function(){var t,e,i=new(r?Uint8Array:Array)(this.b-32768),n=this.b-32768,s=this.a;if(r)i.set(s.subarray(32768,i.length));else for(t=0,e=i.length;t<e;++t)i[t]=s[t+32768];if(this.k.push(i),this.q+=i.length,r)s.set(s.subarray(n,n+32768));else for(t=0;32768>t;++t)s[t]=s[n+t];return this.b=32768,s},M.prototype.J=function(t){var e,i,n,s=this.input.length/this.c+1|0,o=this.input,a=this.a;return t&&("number"==typeof t.v&&(s=t.v),"number"==typeof t.F&&(s+=t.F)),i=2>s?(n=(o.length-this.c)/this.u[2]/2*258|0)<a.length?a.length+n:a.length<<1:a.length*s,r?(e=new Uint8Array(i)).set(a):e=a,this.a=e},M.prototype.t=function(){var t,e,i,n,s,o=0,a=this.a,l=this.k,c=new(r?Uint8Array:Array)(this.q+(this.b-32768));if(0===l.length)return r?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(e=0,i=l.length;e<i;++e)for(n=0,s=(t=l[e]).length;n<s;++n)c[o++]=t[n];for(e=32768,i=this.b;e<i;++e)c[o++]=a[e];return this.k=[],this.buffer=c},M.prototype.H=function(){var t,e=this.b;return r?this.B?(t=new Uint8Array(e)).set(this.a.subarray(0,e)):t=this.a.subarray(0,e):(this.a.length>e&&(this.a.length=e),t=this.a),this.buffer=t},nt.prototype.p=function(){var e,i=this.input;return e=this.A.p(),this.c=this.A.c,this.M&&(i[this.c++]<<24|i[this.c++]<<16|i[this.c++]<<8|i[this.c++])>>>0!==o(e)&&t(Error("invalid adler-32 checksum")),e},s("Zlib.Inflate",nt),s("Zlib.Inflate.BufferType",N),N.ADAPTIVE=N.C,N.BLOCK=N.D,s("Zlib.Inflate.prototype.decompress",nt.prototype.p);var st,rt,ot=new(r?Uint8Array:Array)(288);for(st=0,rt=ot.length;st<rt;++st)ot[st]=143>=st?8:255>=st?9:279>=st?7:8;p(ot);var at,lt,ct=new(r?Uint8Array:Array)(30);for(at=0,lt=ct.length;at<lt;++at)ct[at]=5;p(ct);var ht=8}).call(s4);var r4=s4.Zlib;r4.Deflate=r4.Deflate,r4.Deflate.compress=r4.Deflate.compress,r4.Inflate=r4.Inflate,r4.Inflate.BufferType=r4.Inflate.BufferType,r4.Inflate.prototype.decompress=r4.Inflate.prototype.decompress;class o4{constructor(t){let e;this.pos=8,this.palette=[],this.imgData=[],this.text={},this.width=0,this.height=0,this.bits=0,this.colorType=0,this.compressionMethod=0,this.filterMethod=0,this.interlaceMethod=0,this.colors=0,this.hasAlphaChannel=!1,this.pixelBitlength=0,this.data=t,this.transparency={indexed:[],rgb:0,grayscale:0};let i=0,n=0,s=0,r=0;for(;;){r=this.readUInt32();const o=(()=>{const t=[];for(i=n=0;n<4;i=++n)t.push(String.fromCharCode(this.data[this.pos++]));return t}).call(this).join("");switch(o){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(r);break;case"fcTL":e&&this.animation.frames.push(e),this.pos+=4,e={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()};const a=this.readUInt16(),l=this.readUInt16()||100;e.delay=1e3*a/l,e.disposeOp=this.data[this.pos++],e.blendOp=this.data[this.pos++],e.data=[];break;case"IDAT":case"fdAT":for("fdAT"===o&&(this.pos+=4,r-=4),t=(null!=e?e.data:void 0)||this.imgData,i=n=0;r>=0?n<r:n>r;i=r>=0?++n:--n)t.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:this.transparency.indexed=this.read(r);const t=255-this.transparency.indexed.length;if(t>0)for(i=s=0;t>=0?s<t:s>t;i=t>=0?++s:--s)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(r)[0];break;case 2:this.transparency.rgb=this.read(r)}break;case"tEXt":const c=this.read(r),h=c.indexOf(0),_=String.fromCharCode.apply(String,c.slice(0,h));this.text[_]=String.fromCharCode.apply(String,c.slice(h+1));break;case"IEND":e&&this.animation.frames.push(e),this.colors=(()=>{switch(this.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}).call(this);const u=this.colorType;this.hasAlphaChannel=4===u||6===u;const m=this.colors+(this.hasAlphaChannel?1:0);return this.pixelBitlength=this.bits*m,this.colorSpace=(()=>{switch(this.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}).call(this),void(this.imgData instanceof Uint8Array||(this.imgData=new Uint8Array(this.imgData)));default:this.pos+=r}if(this.pos+=4,this.pos>this.data.length)throw new Error(I(6017))}}read(t){let e=0,i=0;const n=[];for(e=i=0;t>=0?i<t:i>t;e=t>=0?++i:--i)n.push(this.data[this.pos++]);return n}readUInt32(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]}readUInt16(){return this.data[this.pos++]<<8|this.data[this.pos++]}decodePixels(t){if(null==t&&(t=this.imgData),0===t.length)return new Uint8Array(0);t=new r4.Inflate(t,{index:0,verify:!1}).decompress();const e=this.pixelBitlength/8,i=e*this.width,n=new Uint8Array(i*this.height),s=t.length;let r=0,o=0,a=0,l=0,c=0,h=0,_=0,u=0,m=0,d=0,p=0,f=0,g=0,y=0,v=0,x=0,S=0,A=0,C=0;for(;o<s;){switch(t[o++]){case 0:for(h=_=0;_<i;h=_+=1)n[a++]=t[o++];break;case 1:for(h=u=0;u<i;h=u+=1)l=t[o++],f=h<e?0:n[a-e],n[a++]=(l+f)%256;break;case 2:for(h=m=0;m<i;h=m+=1)l=t[o++],c=(h-h%e)/e,A=r&&n[(r-1)*i+c*e+h%e],n[a++]=(A+l)%256;break;case 3:for(h=d=0;d<i;h=d+=1)l=t[o++],c=(h-h%e)/e,f=h<e?0:n[a-e],A=r&&n[(r-1)*i+c*e+h%e],n[a++]=(l+Math.floor((f+A)/2))%256;break;case 4:for(h=p=0;p<i;h=p+=1)l=t[o++],c=(h-h%e)/e,f=h<e?0:n[a-e],0===r?A=C=0:(A=n[(r-1)*i+c*e+h%e],C=c&&n[(r-1)*i+(c-1)*e+h%e]),g=f+A-C,y=Math.abs(g-f),x=Math.abs(g-A),S=Math.abs(g-C),v=y<=x&&y<=S?f:x<=S?A:C,n[a++]=(l+v)%256;break;default:throw new Error(I(6018,t[o-1]))}r++}return n}copyToImageData(t,e){let i,n=this.hasAlphaChannel,s=this.colors;this.palette.length&&(i=null!=this._decodedPalette?this._decodedPalette:this._decodedPalette=this.decodePalette(),s=4,n=!0);const r=t.data||t,o=r.length,a=i||e;let l=0,c=0,h=0,_=0;if(1===s)for(;l<o;)h=i?4*e[l/4]:c,_=a[h++],r[l++]=_,r[l++]=_,r[l++]=_,r[l++]=n?a[h++]:255,c=h;else for(;l<o;)h=i?4*e[l/4]:c,r[l++]=a[h++],r[l++]=a[h++],r[l++]=a[h++],r[l++]=n?a[h++]:255,c=h}decodePalette(){const t=this.palette,e=this.transparency.indexed||[],i=new Uint8Array((e.length||0)+t.length);let n=0,s=0,r=0;for(let o=0,a=0,l=t.length;a<l;o=a+=3)i[n++]=t[o],i[n++]=t[o+1],i[n++]=t[o+2],r=e[s++],i[n++]=null!=r?r:255;return i}render(t){t.width=this.width,t.height=this.height;const e=t.getContext("2d"),i=e.createImageData(this.width,this.height);return this.copyToImageData(i,this.decodePixels(null)),e.putImageData(i,0,0)}}class a4{constructor(){this._littleEndian=!1,this._tiffData=[],this._fileDirectories=[]}getUint8(t){return this._tiffData[t]}getUint16(t){return this._littleEndian?this._tiffData[t+1]<<8|this._tiffData[t]:this._tiffData[t]<<8|this._tiffData[t+1]}getUint32(t){const e=this._tiffData;return this._littleEndian?e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]:e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}checkLittleEndian(){const t=this.getUint16(0);if(18761===t)this._littleEndian=!0;else{if(19789!==t)throw console.log(t),TypeError(I(6019));this._littleEndian=!1}return this._littleEndian}hasTowel(){if(42!==this.getUint16(2))throw RangeError(I(6020));return!0}getFieldTypeName(t){return t in c4?c4[t]:null}getFieldTagName(t){return t in l4?l4[t]:(S(6021,t),`Tag${t}`)}getFieldTypeLength(t){return-1!==["BYTE","ASCII","SBYTE","UNDEFINED"].indexOf(t)?1:-1!==["SHORT","SSHORT"].indexOf(t)?2:-1!==["LONG","SLONG","FLOAT"].indexOf(t)?4:-1!==["RATIONAL","SRATIONAL","DOUBLE"].indexOf(t)?8:0}getFieldValues(t,e,i,n){const s=[],r=this.getFieldTypeLength(e);if(r*i<=4)!1===this._littleEndian?s.push(n>>>8*(4-r)):s.push(n);else for(let t=0;t<i;t++){const i=r*t;r>=8?-1!==["RATIONAL","SRATIONAL"].indexOf(e)?(s.push(this.getUint32(n+i)),s.push(this.getUint32(n+i+4))):S(8e3):s.push(this.getBytes(r,n+i))}return"ASCII"===e&&s.forEach(((t,e,i)=>{i[e]=String.fromCharCode(t)})),s}getBytes(t,e){if(t<=0)S(8001);else{if(t<=1)return this.getUint8(e);if(t<=2)return this.getUint16(e);if(t<=3)return this.getUint32(e)>>>8;if(t<=4)return this.getUint32(e);S(8002)}return 0}getBits(t,e,i){i=i||0;const n=e+Math.floor(i/8),s=i+t,r=32-t;let o=0,a=0;return s<=0?S(6023):s<=8?(o=24+i,a=this.getUint8(n)):s<=16?(o=16+i,a=this.getUint16(n)):s<=32?(o=i,a=this.getUint32(n)):S(6022),{bits:a<<o>>>r,byteOffset:n+Math.floor(s/8),bitOffset:s%8}}parseFileDirectory(t){const e=this.getUint16(t),i=[];let n=0,s=0;for(n=t+2,s=0;s<e;n+=12,s++){const t=this.getUint16(n),e=this.getUint16(n+2),s=this.getUint32(n+4),r=this.getUint32(n+8),o=this.getFieldTagName(t),a=this.getFieldTypeName(e),l=this.getFieldValues(o,a,s,r);i[o]={type:a,values:l}}this._fileDirectories.push(i);const r=this.getUint32(n);0!==r&&this.parseFileDirectory(r)}clampColorSample(t,e){const i=Math.pow(2,8-e);return Math.floor(t*i+(i-1))}parseTIFF(t,e){if(e=e||document.createElement("canvas"),this._tiffData=t,this._canvas=e,this.checkLittleEndian(),!this.hasTowel())return;const i=this.getUint32(4);this._fileDirectories.length=0,this.parseFileDirectory(i);const n=this._fileDirectories[0],s=n.ImageWidth.values[0],r=n.ImageLength.values[0];this._canvas.width=s,this._canvas.height=r;const o=[],a=n.Compression?n.Compression.values[0]:1,l=n.SamplesPerPixel.values[0],c=[];let h=0,_=!1;n.BitsPerSample.values.forEach(((t,e)=>{c[e]={bitsPerSample:t,hasBytesPerSample:!1,bytesPerSample:void 0},t%8==0&&(c[e].hasBytesPerSample=!0,c[e].bytesPerSample=t/8),h+=t}),this);let u=0;h%8==0&&(_=!0,u=h/8);const m=n.StripOffsets.values,d=m.length;let p;if(n.StripByteCounts)p=n.StripByteCounts.values;else{if(S(8003),1!==d)throw Error(I(6024));p=[Math.ceil(s*r*h/8)]}let f=1,g=1;for(let t=0;t<d;t++){const e=m[t];o[t]=[];const i=p[t];for(let n=0,s=0,r=1,h=!0,m=[],d=0,p=0,y=0;n<i;n+=r)switch(a){case 1:m=[];for(let t=0;t<l;t++){const i=c[t];if(!i.hasBytesPerSample){const t=this.getBits(i.bitsPerSample,e+n,s);throw m.push(t.bits),n=t.byteOffset-e,s=t.bitOffset,RangeError(I(6025))}{const s=i.bytesPerSample*t;m.push(this.getBytes(i.bytesPerSample,e+n+s))}}if(o[t].push(m),!_)throw r=0,RangeError(I(6026));r=u;break;case 2:case 3:case 4:case 5:case 6:case 7:break;case 32773:if(h){h=!1;const t=this.getUint8(e+n);t>=0&&t<=127?f=t+1:t>=-127&&t<=-1?g=1-t:h=!0}else{const i=this.getUint8(e+n);for(let e=0;e<g;e++){const e=c[p];if(!e.hasBytesPerSample)throw RangeError(I(6025));y=y<<8*d|i,d++,d===e.bytesPerSample&&(m.push(y),y=d=0,p++),p===l&&(o[t].push(m),m=[],p=0)}f--,0===f&&(h=!0)}r=1}}if(e.getContext){const t=this._canvas.getContext("2d");t.fillStyle="rgba(255, 255, 255, 0)";const e=n.RowsPerStrip?n.RowsPerStrip.values[0]:r,i=o.length,a=r%e,l=0===a?e:a;let h=e,_=0;const u=n.PhotometricInterpretation.values[0];let m=[],d=0;n.ExtraSamples&&(m=n.ExtraSamples.values,d=m.length);let p=[],f=0;n.ColorMap&&(p=n.ColorMap.values,f=Math.pow(2,c[0].bitsPerSample));for(let e=0;e<i;e++){e+1===i&&(h=l);const n=o[e].length,r=_*e;for(let i=0,a=0;i<h&&a<n;i++)for(let n=0;n<s;n++,a++){const s=o[e][a];let l=0,h=0,_=0,g=1;if(d>0)for(let t=0;t<d;t++)if(1===m[t]||2===m[t]){g=s[3+t]/256;break}switch(u){case 0:let t=0;c[0].hasBytesPerSample&&(t=Math.pow(16,2*c[0].bytesPerSample)),s.forEach(((e,i,n)=>{n[i]=t-e}));case 1:l=h=_=this.clampColorSample(s[0],c[0].bitsPerSample);break;case 2:l=this.clampColorSample(s[0],c[0].bitsPerSample),h=this.clampColorSample(s[1],c[1].bitsPerSample),_=this.clampColorSample(s[2],c[2].bitsPerSample);break;case 3:if(void 0===p)throw Error(I(6027));const e=s[0];l=this.clampColorSample(p[e],16),h=this.clampColorSample(p[f+e],16),_=this.clampColorSample(p[2*f+e],16);break;default:throw RangeError(I(6028,u))}t.fillStyle=`rgba(${l}, ${h}, ${_}, ${g})`,t.fillRect(n,r+i,1,1)}_=h}}return this._canvas}}const l4={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop"},c4={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE"},h4=new Array(123);for(let t=0;t<123;++t)h4[t]=64;for(let t=0;t<64;++t)h4["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(t)]=t;var _4={name:"Jacob__Codec__Base64",decode:function(t){var e,i,n,s,r,o,a=[],l=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");l<t.length;)e=h4[t.charCodeAt(l++)]<<2|(s=h4[t.charCodeAt(l++)])>>4,i=(15&s)<<4|(r=h4[t.charCodeAt(l++)])>>2,n=(3&r)<<6|(o=h4[t.charCodeAt(l++)]),a.push(String.fromCharCode(e)),64!==r&&a.push(String.fromCharCode(i)),64!==o&&a.push(String.fromCharCode(n));return a.join("")},decodeAsArray:function(t,e){var i,n,s,r=this.decode(t),o=[];for(i=0,s=r.length/e;i<s;i++)for(o[i]=0,n=e-1;n>=0;--n)o[i]+=r.charCodeAt(i*e+n)<<8*n;return o}},u4=function(t){this.data=t,this.debug=!1,this.gpflags=void 0,this.files=0,this.unzipped=[],this.buf32k=new Array(32768),this.bIdx=0,this.modeZIP=!1,this.bytepos=0,this.bb=1,this.bits=0,this.nameBuf=[],this.fileout=void 0,this.literalTree=new Array(u4.LITERALS),this.distanceTree=new Array(32),this.treepos=0,this.Places=null,this.len=0,this.fpos=new Array(17),this.fpos[0]=0,this.flens=void 0,this.fmax=void 0};u4.gunzip=function(t){return t.constructor===Array||t.constructor,new u4(t).gunzip()[0][0]},u4.HufNode=function(){this.b0=0,this.b1=0,this.jump=null,this.jumppos=-1},u4.LITERALS=288,u4.NAMEMAX=256,u4.bitReverse=[0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,3,131,67,195,35,163,99,227,19,147,83,211,51,179,115,243,11,139,75,203,43,171,107,235,27,155,91,219,59,187,123,251,7,135,71,199,39,167,103,231,23,151,87,215,55,183,119,247,15,143,79,207,47,175,111,239,31,159,95,223,63,191,127,255],u4.cplens=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],u4.cplext=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],u4.cpdist=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],u4.cpdext=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],u4.border=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],u4.prototype.gunzip=function(){return this.outputArr=[],this.nextFile(),this.unzipped},u4.prototype.readByte=function(){return this.bits+=8,this.bytepos<this.data.length?this.data.charCodeAt(this.bytepos++):-1},u4.prototype.byteAlign=function(){this.bb=1},u4.prototype.readBit=function(){var t;return this.bits++,t=1&this.bb,this.bb>>=1,0===this.bb&&(this.bb=this.readByte(),t=1&this.bb,this.bb=this.bb>>1|128),t},u4.prototype.readBits=function(t){for(var e=0,i=t;i--;)e=e<<1|this.readBit();return t&&(e=u4.bitReverse[e]>>8-t),e},u4.prototype.flushBuffer=function(){this.bIdx=0},u4.prototype.addBuffer=function(t){this.buf32k[this.bIdx++]=t,this.outputArr.push(String.fromCharCode(t)),32768===this.bIdx&&(this.bIdx=0)},u4.prototype.IsPat=function(){for(;;){if(this.fpos[this.len]>=this.fmax)return-1;if(this.flens[this.fpos[this.len]]===this.len)return this.fpos[this.len]++;this.fpos[this.len]++}},u4.prototype.Rec=function(){var t,e=this.Places[this.treepos];if(17===this.len)return-1;if(this.treepos++,this.len++,(t=this.IsPat())>=0)e.b0=t;else if(e.b0=32768,this.Rec())return-1;if((t=this.IsPat())>=0)e.b1=t,e.jump=null;else if(e.b1=32768,e.jump=this.Places[this.treepos],e.jumppos=this.treepos,this.Rec())return-1;return this.len--,0},u4.prototype.CreateTree=function(t,e,i){var n;for(this.Places=t,this.treepos=0,this.flens=i,this.fmax=e,n=0;n<17;n++)this.fpos[n]=0;return this.len=0,this.Rec()?-1:0},u4.prototype.DecodeValue=function(t){for(var e,i,n=0,s=t[n];;)if(this.readBit()){if(!(32768&s.b1))return s.b1;for(s=s.jump,e=t.length,i=0;i<e;i++)if(t[i]===s){n=i;break}}else{if(!(32768&s.b0))return s.b0;s=t[++n]}return-1},u4.prototype.DeflateLoop=function(){var t,e,i;do{var n,s;if(t=this.readBit(),0===(e=this.readBits(2)))for(this.byteAlign(),n=this.readByte(),n|=this.readByte()<<8,s=this.readByte(),65535&(n^~(s|=this.readByte()<<8))&&document.write("BlockLen checksum mismatch\n");n--;)r=this.readByte(),this.addBuffer(r);else if(1===e)for(;;)if((o=u4.bitReverse[this.readBits(7)]>>1)>23?(o=o<<1|this.readBit())>199?o=(o-=128)<<1|this.readBit():(o-=48)>143&&(o+=136):o+=256,o<256)this.addBuffer(o);else{if(256===o)break;for(o-=257,d=this.readBits(u4.cplext[o])+u4.cplens[o],o=u4.bitReverse[this.readBits(5)]>>3,u4.cpdext[o]>8?(p=this.readBits(8),p|=this.readBits(u4.cpdext[o]-8)<<8):p=this.readBits(u4.cpdext[o]),p+=u4.cpdist[o],o=0;o<d;o++){var r=this.buf32k[this.bIdx-p&32767];this.addBuffer(r)}}else if(2===e){var o,a,l,c,h,_=new Array(320);for(l=257+this.readBits(5),c=1+this.readBits(5),h=4+this.readBits(4),o=0;o<19;o++)_[o]=0;for(o=0;o<h;o++)_[u4.border[o]]=this.readBits(3);for(d=this.distanceTree.length,i=0;i<d;i++)this.distanceTree[i]=new u4.HufNode;if(this.CreateTree(this.distanceTree,19,_,0))return this.flushBuffer(),1;for(a=l+c,i=0;i<a;)if((o=this.DecodeValue(this.distanceTree))<16)_[i++]=o;else if(16===o){var u;if(i+(o=3+this.readBits(2))>a)return this.flushBuffer(),1;for(u=i?_[i-1]:0;o--;)_[i++]=u}else{if(i+(o=17===o?3+this.readBits(3):11+this.readBits(7))>a)return this.flushBuffer(),1;for(;o--;)_[i++]=0}for(d=this.literalTree.length,i=0;i<d;i++)this.literalTree[i]=new u4.HufNode;if(this.CreateTree(this.literalTree,l,_,0))return this.flushBuffer(),1;for(d=this.literalTree.length,i=0;i<d;i++)this.distanceTree[i]=new u4.HufNode;var m=new Array;for(i=l;i<_.length;i++)m[i-l]=_[i];if(this.CreateTree(this.distanceTree,c,m,0))return this.flushBuffer(),1;for(;;)if((o=this.DecodeValue(this.literalTree))>=256){var d,p;if(0==(o-=256))break;for(o--,d=this.readBits(u4.cplext[o])+u4.cplens[o],o=this.DecodeValue(this.distanceTree),u4.cpdext[o]>8?(p=this.readBits(8),p|=this.readBits(u4.cpdext[o]-8)<<8):p=this.readBits(u4.cpdext[o]),p+=u4.cpdist[o];d--;)r=this.buf32k[this.bIdx-p&32767],this.addBuffer(r)}else this.addBuffer(o)}}while(!t);return this.flushBuffer(),this.byteAlign(),0},u4.prototype.unzipFile=function(t){var e;for(this.gunzip(),e=0;e<this.unzipped.length;e++)if(this.unzipped[e][1]===t)return this.unzipped[e][0]},u4.prototype.nextFile=function(){this.outputArr=[],this.modeZIP=!1;var t=[];if(t[0]=this.readByte(),t[1]=this.readByte(),120===t[0]&&218===t[1]&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),"geonext.gxt"],this.files++),31===t[0]&&139===t[1]&&(this.skipdir(),this.unzipped[this.files]=[this.outputArr.join(""),"file"],this.files++),80===t[0]&&75===t[1]&&(this.modeZIP=!0,t[2]=this.readByte(),t[3]=this.readByte(),3===t[2]&&4===t[3])){t[0]=this.readByte(),t[1]=this.readByte(),this.gpflags=this.readByte(),this.gpflags|=this.readByte()<<8;var e=this.readByte();e|=this.readByte()<<8,this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte();var i=this.readByte();i|=this.readByte()<<8;var n=this.readByte();for(n|=this.readByte()<<8,r=0,this.nameBuf=[];i--;){var s=this.readByte();"/"===s|":"===s?r=0:r<u4.NAMEMAX-1&&(this.nameBuf[r++]=String.fromCharCode(s))}this.fileout||(this.fileout=this.nameBuf);for(var r=0;r<n;)s=this.readByte(),r++;8===e&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),this.nameBuf.join("")],this.files++),this.skipdir()}},u4.prototype.skipdir=function(){var t,e,i=[];if(8&this.gpflags&&(i[0]=this.readByte(),i[1]=this.readByte(),i[2]=this.readByte(),i[3]=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte()),this.modeZIP&&this.nextFile(),i[0]=this.readByte(),8!==i[0])return 0;if(this.gpflags=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),4&this.gpflags)for(i[0]=this.readByte(),i[2]=this.readByte(),this.len=i[0]+256*i[1],t=0;t<this.len;t++)this.readByte();if(8&this.gpflags)for(t=0,this.nameBuf=[];e=this.readByte();)"7"!==e&&":"!==e||(t=0),t<u4.NAMEMAX-1&&(this.nameBuf[t++]=e);if(16&this.gpflags)for(;e=this.readByte(););2&this.gpflags&&(this.readByte(),this.readByte()),this.DeflateLoop(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.modeZIP&&this.nextFile()};var m4,d4,p4,f4,g4,y4,v4,x4,S4,A4,C4,b4,T4,w4,E4,P4,I4,D4,R4,M4,B4,O4,N4,L4,F4,z4,V4,U4,G4,H4,k4,j4,W4,q4,X4,Y4,K4,J4,$4,Z4,Q4,t3,e3,i3,n3,s3,r3,o3,a3,l3,c3,h3,_3,u3,m3,d3,p3,f3,g3,y3,v3,x3,S3,A3,C3,b3,T3,w3,E3,P3,I3,D3,R3,M3,B3,O3,N3,L3,F3,z3,V3,U3,G3,H3,k3,j3,W3,q3,X3,Y3,K3,J3,$3,Z3,Q3,t5={name:"Jacob__Codec"};let e5;function i5(t){const e=t.parent,i=t.getComponent(n5);return e&&i?i5(e):t.getComponentsInChildren(n5)}t5.Base64=_4,t5.GZip=u4,t5.unzip=function(){return t5.GZip.gunzip.apply(t5.GZip,arguments)},t5.unzipBase64=function(){var t=t5.Base64.decode.apply(t5.Base64,arguments);try{return t5.GZip.gunzip.call(t5.GZip,t)}catch(e){return t.slice(7)}},t5.unzipBase64AsArray=function(t,e){e=e||1;var i,n,s,r=this.unzipBase64(t),o=[];for(i=0,s=r.length/e;i<s;i++)for(o[i]=0,n=e-1;n>=0;--n)o[i]+=r.charCodeAt(i*e+n)<<8*n;return o},t5.unzipAsArray=function(t,e){e=e||1;var i,n,s,r=this.unzip(t),o=[];for(i=0,s=r.length/e;i<s;i++)for(o[i]=0,n=e-1;n>=0;--n)o[i]+=r.charCodeAt(i*e+n)<<8*n;return o},function(t){t[t.JPG=0]="JPG",t[t.PNG=1]="PNG",t[t.TIFF=2]="TIFF",t[t.WEBP=3]="WEBP",t[t.PVR=4]="PVR",t[t.ETC=5]="ETC",t[t.S3TC=6]="S3TC",t[t.ATITC=7]="ATITC",t[t.TGA=8]="TGA",t[t.RAWDATA=9]="RAWDATA",t[t.UNKNOWN=10]="UNKNOWN"}(e5||(e5={}));let n5=t("ParticleSystem2D",(m4=u_("cc.ParticleSystem2D"),d4=S_(),p4=I_(),f4=H_(n4),g4=I_(),y4=H_(zR),v4=I_(),x4=I_(),S4=I_(),A4=I_(),C4=I_(),b4=I_(),T4=I_(),w4=I_(),E4=I_(),P4=I_(),I4=I_(),D4=I_(),R4=I_(),M4=I_(),B4=I_(),O4=I_(),N4=I_(),L4=I_(),F4=I_(),z4=I_(),V4=I_(),U4=H_(j2),G4=I_(),H4=H_(k2),k4=I_(),j4=I_(),W4=I_(),q4=I_(),X4=I_(),Y4=I_(),K4=I_(),J4=I_(),$4=I_(),Z4=I_(),Q4=I_(),t3=I_(),e3=I_(),i3=I_(),n3=I_(),s3=I_(),r3=I_(),o3=I_(),m4(a3=d4(a3=A_(a3=x_((Q3=Z3=class t extends wB{get custom(){return this._custom}set custom(t){this._custom!==t&&(this._custom=t,this._applyFile())}get file(){return this._file}set file(t){this._file!==t&&(this._file=t,t?this._applyFile():this.custom=!0)}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){this._renderSpriteFrame!==t&&(this._renderSpriteFrame=t,t&&!t._uuid||(this._spriteFrame=t),this._applySpriteFrame())}get particleCount(){return this._simulator.particles.length}get totalParticles(){return this._totalParticles}set totalParticles(t){this._totalParticles!==t&&(this._totalParticles=t)}get startColor(){return this._startColor}set startColor(t){this._startColor.r=t.r,this._startColor.g=t.g,this._startColor.b=t.b,this._startColor.a=t.a}get startColorVar(){return this._startColorVar}set startColorVar(t){this._startColorVar.r=t.r,this._startColorVar.g=t.g,this._startColorVar.b=t.b,this._startColorVar.a=t.a}get endColor(){return this._endColor}set endColor(t){this._endColor.r=t.r,this._endColor.g=t.g,this._endColor.b=t.b,this._endColor.a=t.a}get endColorVar(){return this._endColorVar}set endColorVar(t){this._endColorVar.r=t.r,this._endColorVar.g=t.g,this._endColorVar.b=t.b,this._endColorVar.a=t.a}get positionType(){return this._positionType}set positionType(t){this._positionType=t,this._updateMaterial()}get stopped(){return this._stopped}get active(){return this._simulator.active}get assembler(){return this._assembler}constructor(){super(),i_(this,"duration",c3,this),i_(this,"emissionRate",h3,this),i_(this,"life",_3,this),i_(this,"lifeVar",u3,this),i_(this,"angle",m3,this),i_(this,"angleVar",d3,this),i_(this,"startSize",p3,this),i_(this,"startSizeVar",f3,this),i_(this,"endSize",g3,this),i_(this,"endSizeVar",y3,this),i_(this,"startSpin",v3,this),i_(this,"startSpinVar",x3,this),i_(this,"endSpin",S3,this),i_(this,"endSpinVar",A3,this),i_(this,"sourcePos",C3,this),i_(this,"posVar",b3,this),i_(this,"emitterMode",T3,this),i_(this,"gravity",w3,this),i_(this,"speed",E3,this),i_(this,"speedVar",P3,this),i_(this,"tangentialAccel",I3,this),i_(this,"tangentialAccelVar",D3,this),i_(this,"radialAccel",R3,this),i_(this,"radialAccelVar",M3,this),i_(this,"rotationIsDir",B3,this),i_(this,"startRadius",O3,this),i_(this,"startRadiusVar",N3,this),i_(this,"endRadius",L3,this),i_(this,"endRadiusVar",F3,this),i_(this,"rotatePerS",z3,this),i_(this,"rotatePerSVar",V3,this),this.aspectRatio=1,i_(this,"playOnLoad",U3,this),i_(this,"autoRemoveOnFinish",G3,this),i_(this,"preview",H3,this),i_(this,"_custom",k3,this),i_(this,"_file",j3,this),i_(this,"_spriteFrame",W3,this),i_(this,"_totalParticles",q3,this),i_(this,"_startColor",X3,this),i_(this,"_startColorVar",Y3,this),i_(this,"_endColor",K3,this),i_(this,"_endColorVar",J3,this),i_(this,"_positionType",$3,this),this._stopped=!0,this._deferredloaded=!1,this.initProperties()}onEnable(){super.onEnable(),this._updateMaterial()}onDestroy(){super.onDestroy(),this.autoRemoveOnFinish&&(this.autoRemoveOnFinish=!1),this._simulator.uvFilled=0}initProperties(){this._previewTimer=null,this._focused=!1,this.aspectRatio=1,this._simulator=new Q2(this)}onFocusInEditor(){this._focused=!0;const t=i5(this.node);for(let e=0;e<t.length;++e)t[e]._startPreview()}onLostFocusInEditor(){this._focused=!1;const t=i5(this.node);for(let e=0;e<t.length;++e)t[e]._stopPreview()}_startPreview(){this.preview&&this.resetSystem()}_stopPreview(){this.preview&&(this.resetSystem(),this.stopSystem()),this._previewTimer&&clearInterval(this._previewTimer)}__preload(){super.__preload(),this._custom&&this.spriteFrame&&!this._renderSpriteFrame?this._applySpriteFrame():this._file&&(this._custom?!this._getTexture()&&this._applyFile():this._applyFile()),this.playOnLoad&&this.resetSystem()}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._assembler&&this._assembler.createData&&(this._simulator.renderData=this._assembler.createData(this))}lateUpdate(t){this._simulator.finished||this._simulator.step(t)}addParticle(){}stopSystem(){this._stopped=!0,this._simulator.stop()}resetSystem(){this._stopped=!1,this._simulator.reset(),this._renderFlag=this._canRender()}isFull(){return this.particleCount>=this.totalParticles}_applyFile(){const t=this._file;if(t){const e=e=>{!e&&t?this.isValid&&(this._plistFile=t.nativeUrl,this._custom||(this._spriteFrame!==t.spriteFrame&&(this.spriteFrame=t.spriteFrame),this._initWithDictionary(t._nativeAsset)),this._spriteFrame?!this._renderSpriteFrame&&this._spriteFrame&&this._applySpriteFrame():t.spriteFrame?this.spriteFrame=t.spriteFrame:this._custom&&this._initTextureWithDictionary(t._nativeAsset),this._deferredloaded=!1):T(6029)};t._nativeAsset?e(null):(this._deferredloaded=!0,lw.postLoadNative(t,e))}}_initTextureWithDictionary(t){if(t.spriteFrameUuid){const e=t.spriteFrameUuid;lw.loadAny(e,((e,i)=>{e?(t.spriteFrameUuid=void 0,this._initTextureWithDictionary(t),d(e)):this.spriteFrame=i}))}else{const i=xn(this._plistFile,t.textureFileName||"");if(t.textureFileName)lw.loadRemote(i,((e,i)=>{e?(t.textureFileName=void 0,this._initTextureWithDictionary(t),d(e)):this.spriteFrame=zR.createWithImage(i)}));else if(t.textureImageData){const n=t.textureImageData;if(!(n&&n.length>0))return!1;{let t=lw.assets.get(i);if(!t){const s=t5.unzipBase64AsArray(n,1);if(!s)return C(6030,this._file.name),!1;const r=(e=s).length>8&&137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]&&13===e[4]&&10===e[5]&&26===e[6]&&10===e[7]?e5.PNG:e.length>2&&(73===e[0]&&73===e[1]||77===e[0]&&77===e[1]||255===e[0]&&216===e[1])?e5.TIFF:e5.UNKNOWN;if(r!==e5.TIFF&&r!==e5.PNG)return C(6031,this._file.name),!1;const o=document.createElement("canvas");r===e5.PNG?new o4(s).render(o):(this._tiffReader||(this._tiffReader=new a4),this._tiffReader.parseTIFF(s,o)),t=new Ru(o),lw.assets.add(i,t)}t||C(6032,this._file.name),this.spriteFrame=zR.createWithImage(t)}}}var e;return!0}_initWithDictionary(t){this.totalParticles=parseInt(t.maxParticles||0),this.life=parseFloat(t.particleLifespan||0),this.lifeVar=parseFloat(t.particleLifespanVariance||0);const e=t.emissionRate;this.emissionRate=e||Math.min(this.totalParticles/this.life,Number.MAX_VALUE),this.duration=parseFloat(t.duration||0),this._srcBlendFactor=parseInt(t.blendFuncSource||ro.SRC_ALPHA),this._dstBlendFactor=parseInt(t.blendFuncDestination||ro.ONE_MINUS_SRC_ALPHA);const i=this._startColor;i.r=255*parseFloat(t.startColorRed||0),i.g=255*parseFloat(t.startColorGreen||0),i.b=255*parseFloat(t.startColorBlue||0),i.a=255*parseFloat(t.startColorAlpha||0);const n=this._startColorVar;n.r=255*parseFloat(t.startColorVarianceRed||0),n.g=255*parseFloat(t.startColorVarianceGreen||0),n.b=255*parseFloat(t.startColorVarianceBlue||0),n.a=255*parseFloat(t.startColorVarianceAlpha||0);const s=this._endColor;s.r=255*parseFloat(t.finishColorRed||0),s.g=255*parseFloat(t.finishColorGreen||0),s.b=255*parseFloat(t.finishColorBlue||0),s.a=255*parseFloat(t.finishColorAlpha||0);const r=this._endColorVar;if(r.r=255*parseFloat(t.finishColorVarianceRed||0),r.g=255*parseFloat(t.finishColorVarianceGreen||0),r.b=255*parseFloat(t.finishColorVarianceBlue||0),r.a=255*parseFloat(t.finishColorVarianceAlpha||0),this.startSize=parseFloat(t.startParticleSize||0),this.startSizeVar=parseFloat(t.startParticleSizeVariance||0),this.endSize=parseFloat(t.finishParticleSize||0),this.endSizeVar=parseFloat(t.finishParticleSizeVariance||0),this.positionType=parseFloat(void 0!==t.positionType?t.positionType:j2.FREE),this.sourcePos.set(0,0),this.posVar.set(parseFloat(t.sourcePositionVariancex||0),parseFloat(t.sourcePositionVariancey||0)),this.angle=parseFloat(t.angle||0),this.angleVar=parseFloat(t.angleVariance||0),this.startSpin=parseFloat(t.rotationStart||0),this.startSpinVar=parseFloat(t.rotationStartVariance||0),this.endSpin=parseFloat(t.rotationEnd||0),this.endSpinVar=parseFloat(t.rotationEndVariance||0),this.emitterMode=parseInt(t.emitterType||k2.GRAVITY),this.emitterMode===k2.GRAVITY){this.gravity.set(parseFloat(t.gravityx||0),parseFloat(t.gravityy||0)),this.speed=parseFloat(t.speed||0),this.speedVar=parseFloat(t.speedVariance||0),this.radialAccel=parseFloat(t.radialAcceleration||0),this.radialAccelVar=parseFloat(t.radialAccelVariance||0),this.tangentialAccel=parseFloat(t.tangentialAcceleration||0),this.tangentialAccelVar=parseFloat(t.tangentialAccelVariance||0);let e=t.rotationIsDir||"";null!==e?(e=e.toString().toLowerCase(),this.rotationIsDir="true"===e||"1"===e):this.rotationIsDir=!1}else{if(this.emitterMode!==k2.RADIUS)return C(6009),!1;this.startRadius=parseFloat(t.maxRadius||0),this.startRadiusVar=parseFloat(t.maxRadiusVariance||0),this.endRadius=parseFloat(t.minRadius||0),this.endRadiusVar=parseFloat(t.minRadiusVariance||0),this.rotatePerS=parseFloat(t.rotatePerSecond||0),this.rotatePerSVar=parseFloat(t.rotatePerSecondVariance||0)}return this._initTextureWithDictionary(t),!0}_onTextureLoaded(){this._simulator.updateUVs(!0),this._syncAspect(),this._updateMaterial(),this._stopped=!1,this._renderFlag=this._canRender()}_syncAspect(){if(this._renderSpriteFrame){const t=this._renderSpriteFrame.rect;this.aspectRatio=t.width/t.height}}_applySpriteFrame(){this._renderSpriteFrame=this._renderSpriteFrame||this._spriteFrame,this._renderSpriteFrame?this._renderSpriteFrame.textureLoaded()?this._onTextureLoaded():this._renderSpriteFrame.once("load",this._onTextureLoaded,this):this.resetSystem()}_getTexture(){return this._renderSpriteFrame&&this._renderSpriteFrame.texture}_updateMaterial(){const t=this.getMaterialInstance(0);t&&t.recompileShaders({USE_LOCAL:this._positionType!==j2.FREE})}_finishedSimulation(){this.resetSystem(),this.stopSystem(),this._renderFlag=this._canRender(),this.autoRemoveOnFinish&&this._stopped&&this.node.destroy()}_canRender(){return super._canRender()&&!this._stopped&&!this._deferredloaded&&null!==this._renderSpriteFrame}_render(t){t.commitComp(this,this._renderSpriteFrame,this._assembler,this._positionType===j2.RELATIVE?this.node.parent:null)}},Z3.EmitterMode=k2,Z3.PositionType=j2,Z3.DURATION_INFINITY=-1,Z3.START_SIZE_EQUAL_TO_END_SIZE=-1,Z3.START_RADIUS_EQUAL_TO_END_RADIUS=-1,n_((l3=Q3).prototype,"custom",[w_,p4],Object.getOwnPropertyDescriptor(l3.prototype,"custom"),l3.prototype),n_(l3.prototype,"file",[f4,g4],Object.getOwnPropertyDescriptor(l3.prototype,"file"),l3.prototype),n_(l3.prototype,"spriteFrame",[y4,v4],Object.getOwnPropertyDescriptor(l3.prototype,"spriteFrame"),l3.prototype),n_(l3.prototype,"totalParticles",[w_,x4],Object.getOwnPropertyDescriptor(l3.prototype,"totalParticles"),l3.prototype),c3=n_(l3.prototype,"duration",[g_,w_,S4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),h3=n_(l3.prototype,"emissionRate",[g_,w_,A4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),_3=n_(l3.prototype,"life",[g_,w_,C4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),u3=n_(l3.prototype,"lifeVar",[g_,w_,b4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n_(l3.prototype,"startColor",[w_,T4],Object.getOwnPropertyDescriptor(l3.prototype,"startColor"),l3.prototype),n_(l3.prototype,"startColorVar",[w_,w4],Object.getOwnPropertyDescriptor(l3.prototype,"startColorVar"),l3.prototype),n_(l3.prototype,"endColor",[w_,E4],Object.getOwnPropertyDescriptor(l3.prototype,"endColor"),l3.prototype),n_(l3.prototype,"endColorVar",[w_,P4],Object.getOwnPropertyDescriptor(l3.prototype,"endColorVar"),l3.prototype),m3=n_(l3.prototype,"angle",[g_,w_,I4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),d3=n_(l3.prototype,"angleVar",[g_,w_,D4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),p3=n_(l3.prototype,"startSize",[g_,w_,R4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),f3=n_(l3.prototype,"startSizeVar",[g_,w_,M4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),g3=n_(l3.prototype,"endSize",[g_,w_,B4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),y3=n_(l3.prototype,"endSizeVar",[g_,w_,O4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v3=n_(l3.prototype,"startSpin",[g_,w_,N4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),x3=n_(l3.prototype,"startSpinVar",[g_,w_,L4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S3=n_(l3.prototype,"endSpin",[g_,w_,F4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),A3=n_(l3.prototype,"endSpinVar",[g_,w_,z4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),C3=n_(l3.prototype,"sourcePos",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.ZERO.clone()}}),b3=n_(l3.prototype,"posVar",[g_,w_,V4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.ZERO.clone()}}),n_(l3.prototype,"positionType",[U4,G4],Object.getOwnPropertyDescriptor(l3.prototype,"positionType"),l3.prototype),T3=n_(l3.prototype,"emitterMode",[g_,w_,H4,k4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k2.GRAVITY}}),w3=n_(l3.prototype,"gravity",[g_,w_,j4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.ZERO.clone()}}),E3=n_(l3.prototype,"speed",[g_,w_,W4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 180}}),P3=n_(l3.prototype,"speedVar",[g_,w_,q4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),I3=n_(l3.prototype,"tangentialAccel",[g_,w_,X4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 80}}),D3=n_(l3.prototype,"tangentialAccelVar",[g_,w_,Y4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),R3=n_(l3.prototype,"radialAccel",[g_,w_,K4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),M3=n_(l3.prototype,"radialAccelVar",[g_,w_,J4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),B3=n_(l3.prototype,"rotationIsDir",[g_,w_,$4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),O3=n_(l3.prototype,"startRadius",[g_,w_,Z4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),N3=n_(l3.prototype,"startRadiusVar",[g_,w_,Q4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),L3=n_(l3.prototype,"endRadius",[g_,w_,t3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),F3=n_(l3.prototype,"endRadiusVar",[g_,w_,e3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),z3=n_(l3.prototype,"rotatePerS",[g_,w_,i3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),V3=n_(l3.prototype,"rotatePerSVar",[g_,w_,n3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),U3=n_(l3.prototype,"playOnLoad",[g_,w_,s3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),G3=n_(l3.prototype,"autoRemoveOnFinish",[g_,w_,r3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),H3=n_(l3.prototype,"preview",[g_,w_,o3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),k3=n_(l3.prototype,"_custom",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),j3=n_(l3.prototype,"_file",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),W3=n_(l3.prototype,"_spriteFrame",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),q3=n_(l3.prototype,"_totalParticles",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 150}}),X3=n_(l3.prototype,"_startColor",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new si(255,255,255,255)}}),Y3=n_(l3.prototype,"_startColorVar",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new si(0,0,0,0)}}),K3=n_(l3.prototype,"_endColor",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new si(255,255,255,0)}}),J3=n_(l3.prototype,"_endColorVar",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new si(0,0,0,0)}}),$3=n_(l3.prototype,"_positionType",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return j2.FREE}}),a3=l3))||a3)||a3)||a3)||a3));var s5,r5,o5,a5,l5,c5,h5,_5,u5,m5,d5,p5,f5,g5;let y5=t("MotionStreak",(s5=u_("cc.MotionStreak"),r5=S_(),o5=T_(),a5=H_(Zm),s5(l5=x_(l5=A_(l5=r5(l5=o5((g5=f5=class t extends wB{constructor(...t){super(...t),i_(this,"_preview",h5,this),i_(this,"_fadeTime",_5,this),i_(this,"_minSeg",u5,this),i_(this,"_stroke",m5,this),i_(this,"_texture",d5,this),i_(this,"_fastMode",p5,this),this._points=[]}get preview(){return this._preview}set preview(t){this._preview=t,this.reset()}get fadeTime(){return this._fadeTime}set fadeTime(t){this._fadeTime=t,this.reset()}get minSeg(){return this._minSeg}set minSeg(t){this._minSeg=t}get stroke(){return this._stroke}set stroke(t){this._stroke=t}get texture(){return this._texture}set texture(t){this._texture!==t&&(this._texture=t)}get fastMode(){return this._fastMode}set fastMode(t){this._fastMode=t}get points(){return this._points}onEnable(){super.onEnable(),this.reset()}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)}onFocusInEditor(){this._preview&&this.reset()}onLostFocusInEditor(){this._preview&&this.reset()}reset(){this._points.length=0,this._renderData&&this._renderData.clear()}lateUpdate(t){this._assembler&&this._assembler.update(this,t)}_render(t){t.commitComp(this,this._texture,this._assembler,null)}},f5.Point=class{constructor(t,e){this.point=new Ti,this.dir=new Ti,this.distance=0,this.time=0,t&&this.point.set(t),e&&this.dir.set(e)}setPoint(t,e){this.point.x=t,this.point.y=e}setDir(t,e){this.dir.x=t,this.dir.y=e}},n_((c5=g5).prototype,"preview",[w_],Object.getOwnPropertyDescriptor(c5.prototype,"preview"),c5.prototype),n_(c5.prototype,"fadeTime",[w_],Object.getOwnPropertyDescriptor(c5.prototype,"fadeTime"),c5.prototype),n_(c5.prototype,"minSeg",[w_],Object.getOwnPropertyDescriptor(c5.prototype,"minSeg"),c5.prototype),n_(c5.prototype,"stroke",[w_],Object.getOwnPropertyDescriptor(c5.prototype,"stroke"),c5.prototype),n_(c5.prototype,"texture",[a5],Object.getOwnPropertyDescriptor(c5.prototype,"texture"),c5.prototype),n_(c5.prototype,"fastMode",[w_],Object.getOwnPropertyDescriptor(c5.prototype,"fastMode"),c5.prototype),h5=n_(c5.prototype,"_preview",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_5=n_(c5.prototype,"_fadeTime",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),u5=n_(c5.prototype,"_minSeg",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),m5=n_(c5.prototype,"_stroke",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),d5=n_(c5.prototype,"_texture",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),p5=n_(c5.prototype,"_fastMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),l5=c5))||l5)||l5)||l5)||l5)||l5));new Ti;const v5=new Ti,x5=new Ti;function S5(t,e){return t.x=-e.y,t.y=e.x,t}const A5={createData(t){const e=t.requestRenderData();return e.dataLength=4,e.vertexCount=16,e.indicesCount=42,e},update(t,e){const i=t.stroke/2,n=t.node.worldMatrix,s=n.m12,r=n.m13,o=t.points;let a;if(o.length>1){const e=o[0],i=e.point.x-s,n=e.point.y-r;i*i+n*n<t.minSeg&&(a=e)}a||(a=new y5.Point,o.splice(0,0,a)),a.setPoint(s,r),a.time=t.fadeTime+e;let l=0,c=0;if(o.length<2)return;const h=t.renderData,_=t.color,u=_.r,m=_.g,d=_.b,p=_.a,f=o[1];f.distance=Ti.subtract(x5,a.point,f.point).length(),x5.normalize(),f.setDir(x5.x,x5.y),a.setDir(x5.x,x5.y),h.dataLength=2*o.length;const g=h.data,y=t.fadeTime;let v=!1;for(let t=o.length-1;t>=0;t--){const n=o[t],s=n.point,r=n.dir;if(n.time-=e,n.time<0){o.splice(t,1);continue}const a=n.time/y,c=o[t-1];if(!v){if(!c){o.splice(t,1);continue}s.x=c.point.x-r.x*a,s.y=c.point.y-r.y*a}v=!0,S5(v5,r);const h=(a*p<<24>>>0)+(d<<16)+(m<<8)+u;let _=l;g[_].x=s.x+v5.x*i,g[_].y=s.y+v5.y*i,g[_].u=1,g[_].v=a,g[_].color._val=h,_+=1,g[_].x=s.x-v5.x*i,g[_].y=s.y-v5.y*i,g[_].u=0,g[_].v=a,g[_].color._val=h,l+=2}c=l<=2?0:3*(l-2),h.vertexCount=l,h.indicesCount=c},updateRenderData(t){},fillBuffers(t,e){const i=t.renderData,n=i.data;t.node;let s=e.acquireBufferBatch(),r=s.byteOffset>>2,o=s.indicesOffset,a=s.vertexOffset;s.request(i.vertexCount,i.indicesCount)||(s=e.currBufferBatch,o=0,a=0);const l=s.vData,c=s.iData,h=i.vertexCount,_=i.indicesCount;for(let t=0;t<h;t++){const e=n[t];l[r++]=e.x,l[r++]=e.y,l[r++]=e.z,l[r++]=e.u,l[r++]=e.v,si.toArray(l,e.color,r),r+=4}for(let t=0,e=_;t<e;t+=2){const e=a+t;c[o++]=e,c[o++]=e+2,c[o++]=e+1,c[o++]=e+1,c[o++]=e+2,c[o++]=e+3}}},C5=t("MotionStreakAssemblerManager",{getAssembler:()=>A5});y5.Assembler=C5;const b5={maxParticleDeltaTime:0,createData:()=>BM.add(),updateRenderData(){},fillBuffers(t,e){if(null===t)return;const i=t._simulator.renderData;if(0===i.vertexCount||0===i.indicesCount)return;let n=e.acquireBufferBatch(),s=n.byteOffset>>2,r=n.indicesOffset,o=n.vertexOffset;n.request(i.vertexCount,i.indicesCount)||(n=e.currBufferBatch,r=0,o=0);const a=n.vData,l=n.iData,c=i.vData,h=i.iData,_=9*i.vertexCount;for(let t=0;t<_;t++)a[s++]=c[t];const u=i.indicesCount;for(let t=0;t<u;t++)l[r++]=h[t]+o}},T5=t("ParticleSystem2DAssembler",{getAssembler:()=>(b5.maxParticleDeltaTime||(b5.maxParticleDeltaTime=n.game.frameTime/1e3*2),b5)});let w5,E5,P5;n5.Assembler=T5,function(t){t.PLAYED="play",t.PAUSED="pause",t.STOPPED="stop",t.SEEKED="seeked",t.ENDED="ended",t.INTERRUPTION_BEGIN="interruptionBegin",t.INTERRUPTION_END="interruptionEnd",t.USER_GESTURE="on_gesture"}(w5||(w5={})),function(t){t[t.DOM_AUDIO=0]="DOM_AUDIO",t[t.WEB_AUDIO=1]="WEB_AUDIO",t[t.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",t[t.NATIVE_AUDIO=3]="NATIVE_AUDIO",t[t.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(E5||(E5={})),function(t){t[t.INIT=0]="INIT",t[t.PLAYING=1]="PLAYING",t[t.PAUSED=2]="PAUSED",t[t.STOPPED=3]="STOPPED",t[t.INTERRUPTED=4]="INTERRUPTED"}(P5||(P5={}));let I5=0;function D5(t,e){e.invoking||(e.invoking=!0,e.func.call(t,...e.args).then((()=>{e.invoking=!1,t._operationQueue.shift(),t._eventTarget.emit(e.id.toString());const i=t._operationQueue[0];i&&D5(t,i)})).catch((()=>{})))}function R5(t,e,i){const n=i.value;i.value=function(...t){return new Promise((e=>{const i=I5++,s=this;s._operationQueue.push({id:i,func:n,args:t,invoking:!1}),s._eventTarget.once(i.toString(),e),D5(s,s._operationQueue[0])}))}}var M5,B5,O5;const N5={},L5=jsb.AudioEngine,F5=-1;class z5{get onPlay(){return this._onPlayCb}set onPlay(t){this._onPlayCb=t}get onEnd(){return this._onEndCb}set onEnd(t){this._onEndCb=t}constructor(t,e){this._id=F5,this._url=void 0,this._volume=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._url=t,this._volume=e}play(){var t;this._id=jsb.AudioEngine.play2d(this._url,!1,this._volume),jsb.AudioEngine.setFinishCallback(this._id,(()=>{var t;null===(t=this.onEnd)||void 0===t||t.call(this)})),null===(t=this.onPlay)||void 0===t||t.call(this)}stop(){this._id!==F5&&jsb.AudioEngine.stop(this._id)}}let V5=(O5=B5=class t{constructor(t){this._url=void 0,this._id=F5,this._state=P5.INIT,this._onHide=void 0,this._onShow=void 0,this._eventTarget=new Zi,this._operationQueue=[],this._beforePlaying={duration:0,loop:!1,currentTime:0,volume:1},this._url=t,this._onHide=()=>{this._state===P5.PLAYING&&this.pause().then((()=>{this._state=P5.INTERRUPTED,this._eventTarget.emit(w5.INTERRUPTION_BEGIN)})).catch((()=>{}))},n.game.on(n.Game.EVENT_HIDE,this._onHide),this._onShow=()=>{this._state===P5.INTERRUPTED&&this.play().then((()=>{this._eventTarget.emit(w5.INTERRUPTION_END)})).catch((()=>{}))},n.game.on(n.Game.EVENT_SHOW,this._onShow)}destroy(){this._onShow&&(n.game.off(n.Game.EVENT_SHOW,this._onShow),this._onShow=void 0),this._onHide&&(n.game.off(n.Game.EVENT_HIDE,this._onHide),this._onHide=void 0),--N5[this._url]<=0&&L5.uncache(this._url)}static load(e){return new Promise(((i,n)=>{t.loadNative(e).then((e=>{i(new t(e))})).catch((t=>n(t)))}))}static loadNative(t){return new Promise(((e,i)=>{hn.platform===on.WIN32?e(t):L5.preload(t,(n=>{n?e(t):i(new Error("load audio failed"))}))}))}static loadOneShotAudio(e,i){return new Promise(((n,s)=>{t.loadNative(e).then((t=>{n(new z5(t,i))})).catch(s)}))}get _isValid(){return this._id!==F5}get src(){return this._url}get type(){return E5.NATIVE_AUDIO}get state(){return this._state}get loop(){return this._isValid?L5.isLoop(this._id):this._beforePlaying.loop}set loop(t){this._isValid?L5.setLoop(this._id,t):this._beforePlaying.loop=t}get volume(){return this._isValid?L5.getVolume(this._id):this._beforePlaying.volume}set volume(t){t=Ge(t),this._isValid?L5.setVolume(this._id,t):this._beforePlaying.volume=t}get duration(){return this._isValid?L5.getDuration(this._id):this._beforePlaying.duration}get currentTime(){return this._isValid?L5.getCurrentTime(this._id):this._beforePlaying.currentTime}seek(t){return new Promise((e=>(t=Ue(t,0,this.duration),this._isValid?(L5.setCurrentTime(this._id,t),e()):(this._beforePlaying.currentTime=t,e()))))}play(){return new Promise((t=>{this._isValid?this._state===P5.PAUSED?L5.resume(this._id):this._state===P5.PLAYING&&(L5.pause(this._id),L5.setCurrentTime(this._id,0),L5.resume(this._id)):(this._id=L5.play2d(this._url,this._beforePlaying.loop,this._beforePlaying.volume),this._isValid&&(0!==this._beforePlaying.currentTime&&L5.setCurrentTime(this._id,this._beforePlaying.currentTime),L5.setFinishCallback(this._id,(()=>{this._id=F5,this._state=P5.INIT,this._eventTarget.emit(w5.ENDED)})))),this._state=P5.PLAYING,t()}))}pause(){return new Promise((t=>{this._isValid&&L5.pause(this._id),this._state=P5.PAUSED,t()}))}stop(){return new Promise((t=>{this._isValid&&L5.stop(this._id),this._state=P5.STOPPED,this._id=F5,t()}))}onInterruptionBegin(t){this._eventTarget.on(w5.INTERRUPTION_BEGIN,t)}offInterruptionBegin(t){this._eventTarget.off(w5.INTERRUPTION_BEGIN,t)}onInterruptionEnd(t){this._eventTarget.on(w5.INTERRUPTION_END,t)}offInterruptionEnd(t){this._eventTarget.off(w5.INTERRUPTION_END,t)}onEnded(t){this._eventTarget.on(w5.ENDED,t)}offEnded(t){this._eventTarget.off(w5.ENDED,t)}},B5.maxAudioChannel=L5.getMaxAudioInstance(),n_((M5=O5).prototype,"seek",[R5],Object.getOwnPropertyDescriptor(M5.prototype,"seek"),M5.prototype),n_(M5.prototype,"play",[R5],Object.getOwnPropertyDescriptor(M5.prototype,"play"),M5.prototype),n_(M5.prototype,"pause",[R5],Object.getOwnPropertyDescriptor(M5.prototype,"pause"),M5.prototype),n_(M5.prototype,"stop",[R5],Object.getOwnPropertyDescriptor(M5.prototype,"stop"),M5.prototype),M5);var U5,G5,H5,k5,j5;n.AudioPlayer=V5;let W5=t("AudioClip",u_("cc.AudioClip")((j5=k5=class extends xu{constructor(){super(),i_(this,"_duration",H5,this),this._loadMode=E5.UNKNOWN_AUDIO,this._meta=null,this.loaded=!1}set _nativeAsset(t){this._meta=t,t?(this.loaded=!0,this._loadMode=t.type,this.emit("load")):(this._meta=null,this._loadMode=E5.UNKNOWN_AUDIO,this._duration=0,this.loaded=!1)}get _nativeAsset(){return this._meta}get _nativeDep(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}get loadMode(){return this._loadMode}validate(){return!!this._meta}getDuration(){return this._duration?this._duration:this._meta?this._meta.duration:0}},k5.AudioType=E5,H5=n_((G5=j5).prototype,"_duration",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n_(G5.prototype,"_nativeDep",[k_],Object.getOwnPropertyDescriptor(G5.prototype,"_nativeDep"),G5.prototype),U5=G5))||U5);function q5(t,e,i){V5.load(t,{audioLoadMode:e.audioLoadMode}).then((e=>{const n={url:t,duration:e.duration,type:e.type};e.destroy(),i(null,n)})).catch((t=>{i(t)}))}function X5(t,e,i,n){const s=new W5;s._nativeUrl=t,s._nativeAsset=e,s._duration=e.duration,n(null,s)}n.AudioClip=W5,VT.register({".mp3":q5,".ogg":q5,".wav":q5,".m4a":q5}),qT.register({".mp3":X5,".ogg":X5,".wav":X5,".m4a":X5});const Y5=new class{constructor(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}_findIndex(t,e){return t.findIndex((t=>t.audio===e))}_tryAddPlaying(t,e){const i=this._findIndex(t,e);return i>-1?(t[i].playTime=performance.now(),!1):(t.push({audio:e,playTime:performance.now()}),!0)}addPlaying(t){if(t instanceof V5){if(this._tryAddPlaying(this._audioPlayerInfoList,t))return}else this._tryAddPlaying(this._oneShotAudioInfoList,t)}_tryRemovePlaying(t,e){const i=this._findIndex(t,e);return-1!==i&&(K(t,i),!0)}removePlaying(t){if(t instanceof V5){if(this._tryRemovePlaying(this._audioPlayerInfoList,t))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,t)}discardOnePlayingIfNeeded(){if(this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<V5.maxAudioChannel)return;let t;this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((e=>{(!t||e.playTime<t.playTime)&&(t=e)})):this._audioPlayerInfoList.forEach((e=>{(!t||e.playTime<t.playTime)&&(t=e)})),t&&(t.audio.stop(),this.removePlaying(t.audio))}};var K5,J5,$5,Z5,Q5,t6,e6,i6,n6,s6,r6,o6,a6,l6,c6,h6,_6,u6;let m6=function(e){return t({AudioSource:e,AudioSourceComponent:e}),e}((K5=u_("cc.AudioSource"),J5=T_(),$5=S_(),Z5=H_(W5),Q5=H_(W5),t6=I_(),e6=I_(),i6=I_(),n6=D_(),s6=I_(),K5(r6=J5(r6=$5((u6=_6=class t extends Nm{constructor(...t){super(...t),i_(this,"_clip",a6,this),this._player=null,i_(this,"_loop",l6,this),i_(this,"_playOnAwake",c6,this),i_(this,"_volume",h6,this),this._cachedCurrentTime=0,this._operationsBeforeLoading=[],this._isLoaded=!1,this._lastSetClip=void 0}static get maxAudioChannel(){return V5.maxAudioChannel}set clip(t){t!==this._clip&&(this._clip=t,this._syncPlayer())}get clip(){return this._clip}_syncPlayer(){const t=this._clip;this._isLoaded=!1,t&&this._lastSetClip!==t&&(t._nativeAsset?(this._lastSetClip=t,V5.load(t._nativeAsset.url,{audioLoadMode:t.loadMode}).then((e=>{this._lastSetClip===t&&(this._isLoaded=!0,this._player&&(this._player.offEnded(),this._player.offInterruptionBegin(),this._player.offInterruptionEnd(),this._player.destroy()),this._player=e,e.onEnded((()=>{Y5.removePlaying(e)})),e.onInterruptionBegin((()=>{Y5.removePlaying(e)})),e.onInterruptionEnd((()=>{Y5.addPlaying(e)})),this._syncStates())})).catch((()=>{}))):console.error("Invalid audio clip"))}set loop(t){this._loop=t,this._player&&(this._player.loop=t)}get loop(){return this._loop}set playOnAwake(t){this._playOnAwake=t}get playOnAwake(){return this._playOnAwake}set volume(t){Number.isNaN(t)?console.warn("illegal audio volume!"):(t=Ue(t,0,1),this._player?(this._player.volume=t,this._volume=this._player.volume):this._volume=t)}get volume(){return this._volume}onLoad(){this._syncPlayer()}onEnable(){this._playOnAwake&&!this.playing&&this.play()}onDisable(){this.pause()}onDestroy(){this.stop()}play(){var t,e;this._isLoaded?(Y5.discardOnePlayingIfNeeded(),this.state===P5.PLAYING&&(null===(e=this._player)||void 0===e||e.stop().catch((()=>{}))),null===(t=this._player)||void 0===t||t.play().then((()=>{Y5.addPlaying(this._player)})).catch((()=>{}))):this._operationsBeforeLoading.push("play")}pause(){var t;this._isLoaded?null===(t=this._player)||void 0===t||t.pause().then((()=>{Y5.removePlaying(this._player)})).catch((()=>{})):this._operationsBeforeLoading.push("pause")}stop(){var t;this._isLoaded?null===(t=this._player)||void 0===t||t.stop().then((()=>{Y5.removePlaying(this._player)})).catch((()=>{})):this._operationsBeforeLoading.push("stop")}playOneShot(t,e=1){t._nativeAsset?V5.loadOneShotAudio(t._nativeAsset.url,this._volume*e,{audioLoadMode:t.loadMode}).then((t=>{Y5.discardOnePlayingIfNeeded(),t.onPlay=()=>{Y5.addPlaying(t)},t.onEnd=()=>{Y5.removePlaying(t)},t.play()})).catch((()=>{})):console.error("Invalid audio clip")}_syncStates(){this._player&&this._player.seek(this._cachedCurrentTime).then((()=>{this._player&&(this._player.loop=this._loop,this._player.volume=this._volume,this._operationsBeforeLoading.forEach((t=>{var e;null===(e=this[t])||void 0===e||e.call(this)})),this._operationsBeforeLoading.length=0)})).catch((()=>{}))}set currentTime(t){var e;Number.isNaN(t)?console.warn("illegal audio time!"):(t=Ue(t,0,this.duration),this._cachedCurrentTime=t,null===(e=this._player)||void 0===e||e.seek(this._cachedCurrentTime).catch((()=>{})))}get currentTime(){return this._player?this._player.currentTime:this._cachedCurrentTime}get duration(){var t,e;return null!==(t=null===(e=this._clip)||void 0===e?void 0:e.getDuration())&&void 0!==t?t:this._player?this._player.currentTime:0}get state(){return this._player?this._player.state:P5.INIT}get playing(){return this.state===t.AudioState.PLAYING}},_6.AudioState=P5,a6=n_((o6=u6).prototype,"_clip",[Z5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),l6=n_(o6.prototype,"_loop",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),c6=n_(o6.prototype,"_playOnAwake",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),h6=n_(o6.prototype,"_volume",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),n_(o6.prototype,"clip",[Q5,t6],Object.getOwnPropertyDescriptor(o6.prototype,"clip"),o6.prototype),n_(o6.prototype,"loop",[e6],Object.getOwnPropertyDescriptor(o6.prototype,"loop"),o6.prototype),n_(o6.prototype,"playOnAwake",[i6],Object.getOwnPropertyDescriptor(o6.prototype,"playOnAwake"),o6.prototype),n_(o6.prototype,"volume",[n6,s6],Object.getOwnPropertyDescriptor(o6.prototype,"volume"),o6.prototype),r6=o6))||r6)||r6)||r6));var d6,p6,f6;z(W5,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:m6,targetName:"AudioSource"}]),z(W5.prototype,"AudioClip.prototype",[{name:"state",targetName:"AudioSource.prototype",customGetter:()=>P5.INIT}]),z(W5.prototype,"AudioClip.prototype",[{name:"getCurrentTime",targetName:"AudioSource.prototype",customFunction:()=>0},{name:"getVolume",targetName:"AudioSource.prototype",customFunction:()=>0},{name:"getLoop",targetName:"AudioSource.prototype",customFunction:()=>!1}]),z(W5.prototype,"AudioClip.prototype",["play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop"].map((t=>({name:t,targetName:"AudioSource.prototype",customFunction(){}})))),n.AudioSourceComponent=m6,Vt.setClassAlias(m6,"cc.AudioSourceComponent");let g6=t("VideoClip",u_("cc.VideoClip")((f6=n_((p6=class extends xu{constructor(){super(),i_(this,"_duration",f6,this),this._video=null,this.loaded=!1}set _nativeAsset(t){this._video=t,t?(this._duration=t.duration,this.loaded=!0):(this._duration=0,this.loaded=!1)}get _nativeAsset(){return this._video}}).prototype,"_duration",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),d6=p6))||d6);function y6(t,e,i){const n=document.createElement("video"),s=document.createElement("source");n.appendChild(s);const r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="blob",r.onload=function(){200===this.status||0===this.status?(s.src=URL.createObjectURL(this.response),i(null,n)):i(new Error(`${r.status}(no response)`))},r.onerror=function(){const e=`load video failure - ${t}`;u(e),i(new Error(e))},r.send()}function v6(t,e,i,n){const s=new g6;s._nativeUrl=t,s._nativeAsset=e,n(null,s)}VT.register({".mp4":y6,".avi":y6,".mov":y6,".mpg":y6,".mpeg":y6,".rm":y6,".rmvb":y6}),qT.register({".mp4":v6,".avi":v6,".mov":v6,".mpg":v6,".mpeg":v6,".rm":v6,".rmvb":v6});const x6=Gt({REMOTE:0,LOCAL:1});let S6,A6;!function(t){t.NONE="none",t.PLAYING="playing",t.PAUSED="paused",t.STOPPED="stopped",t.COMPLETED="completed",t.META_LOADED="meta-loaded",t.READY_TO_PLAY="ready-to-play",t.ERROR="error",t.CLICKED="clicked"}(S6||(S6={})),function(t){t[t.HAVE_NOTHING=0]="HAVE_NOTHING",t[t.HAVE_METADATA=1]="HAVE_METADATA",t[t.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",t[t.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",t[t.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(A6||(A6={}));class C6{constructor(t){this._componentEventList=new Map,this._state=S6.NONE,this._video=null,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._loaded=!1,this._loadedMeta=!1,this._ignorePause=!1,this._fullScreenOnAwake=!1,this._visible=!0,this._playing=!1,this._cachedCurrentTime=-1,this._waitingFullscreen=!1,this._waitingPlay=!1,this._keepAspectRatio=!1,this._component=null,this._uiTrans=null,this._node=null,this._stayOnBottom=!1,this._dirty=!1,this._forceUpdate=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=t,this._node=t.node,this._uiTrans=t.node.getComponent(rB),this._onHide=()=>{this.video&&this._state===S6.PLAYING&&(this.video.pause(),this._interrupted=!0)},this._onShow=()=>{this._interrupted&&this.video&&(this.video.play(),this._interrupted=!1)},n.game.on(n.Game.EVENT_HIDE,this._onHide),n.game.on(n.Game.EVENT_SHOW,this._onShow)}get fullScreenOnAwake(){return this._fullScreenOnAwake}get loaded(){return this._loaded}get componentEventList(){return this._componentEventList}get video(){return this._video}get state(){return this._state}get isPlaying(){return this._playing}get UICamera(){return aT.root.batcher2D.getFirstRenderCamera(this._node)}onLoadedMetadata(t){this._loadedMeta=!0,this._forceUpdate=!0,this._visible?this.enable():this.disable(),this.dispatchEvent(S6.META_LOADED);const e=t.target;this._keepAspectRatio&&e&&this.syncUITransform(e.videoWidth,e.videoHeight),this.delayedFullScreen(),this.delayedPlay()}onCanPlay(t){this._loaded=!0,this.dispatchEvent(S6.READY_TO_PLAY)}onPlay(t){this._playing=!0,this.dispatchEvent(S6.PLAYING)}onPlaying(t){this.dispatchEvent(S6.PLAYING)}onPause(t){this._ignorePause?this._ignorePause=!1:(this._playing=!1,this.dispatchEvent(S6.PAUSED))}onStoped(t){this._playing=!1,this._ignorePause=!1,this.dispatchEvent(S6.STOPPED)}onEnded(t){this.dispatchEvent(S6.COMPLETED)}onClick(t){this.dispatchEvent(S6.CLICKED)}onError(t){this.dispatchEvent(S6.ERROR);const e=t.target;e&&e.error&&d(`Error ${e.error.code}; details: ${e.error.message}`)}play(){this._loadedMeta||this._loaded?this.canPlay():this._waitingPlay=!0}delayedPlay(){this._waitingPlay&&(this.canPlay(),this._waitingPlay=!1)}syncFullScreenOnAwake(t){this._fullScreenOnAwake=t,this._loadedMeta||this._loaded?this.canFullScreen(t):this._waitingFullscreen=!0}delayedFullScreen(){this._waitingFullscreen&&(this.canFullScreen(this._fullScreenOnAwake),this._waitingFullscreen=!1)}dispatchEvent(t){const e=this._componentEventList.get(t);e&&(this._state=t,e.call(this))}syncUITransform(t,e){this._uiTrans&&(this._uiTrans.width=t,this._uiTrans.height=e)}syncCurrentTime(){this.video&&-1!==this._cachedCurrentTime&&this.video.currentTime!==this._cachedCurrentTime&&(this.seekTo(this._cachedCurrentTime),this._cachedCurrentTime=-1)}destroy(){this.removeVideoPlayer(),this._componentEventList.clear(),n.game.off(n.Game.EVENT_HIDE,this._onHide),n.game.off(n.Game.EVENT_SHOW,this._onShow)}}n.internal.VideoPlayerImpl=C6;const b6=bi();class T6 extends C6{constructor(t){super(t),this._eventList=new Map,this._clearColorA=-1,this._clearFlag=void 0}addListener(t,e){this._video&&(this._eventList.set(t,e),this._video.addEventListener(t,e))}removeAllListeners(){this._eventList.forEach(((t,e)=>{this._video&&this._video.removeEventListener(e,t)})),this._eventList.clear()}canPlay(){if(this.video){const t=this.video.play();window.Promise&&t instanceof Promise&&t.catch((()=>{})).then((()=>{this.syncCurrentTime()}))}}pause(){this.video&&(this.video.pause(),this._cachedCurrentTime=this.video.currentTime)}resume(){this.play()}stop(){this.video&&(this._ignorePause=!0,this.video.currentTime=0,this.video.pause(),this._cachedCurrentTime=0,setTimeout((()=>{this._ignorePause=!1,this.dispatchEvent(S6.STOPPED)}),0))}syncClip(t){this.removeVideoPlayer(),t&&this.createVideoPlayer(t.nativeUrl)}syncURL(t){this.removeVideoPlayer(),t&&this.createVideoPlayer(t)}syncPlaybackRate(t){hn.browserType!==Qi.UC?this.video&&(this.video.playbackRate=t):m("playbackRate is not supported by the uc mobile browser.")}syncVolume(t){this.video&&(this.video.volume=t)}syncMute(t){this.video&&(this.video.muted=t)}syncLoop(t){this.video&&(this.video.loop=t)}getDuration(){return this.video?this.video.duration:0}getCurrentTime(){return this.video?this.video.currentTime:-1}seekTo(t){this.video&&(this.video.currentTime=t)}canFullScreen(t){const e=this._video;if(e&&e.readyState===A6.HAVE_ENOUGH_DATA)return hn.os===sn.IOS&&Cy.isBrowser?(t?e.webkitEnterFullscreen&&e.webkitEnterFullscreen():e.webkitExitFullscreen&&e.webkitExitFullscreen(),void(this._fullScreenOnAwake=e.webkitDisplayingFullscreen)):jv.supportsFullScreen?void(t?(hn.browserType===Qi.IE&&(e.style.transform=""),e.setAttribute("x5-video-player-fullscreen","true"),jv.requestFullScreen(e,(t=>{const i=hn.browserType===Qi.IE?t.msFullscreenElement:t.fullscreenElement;this._fullScreenOnAwake=i===e}),(()=>{this._fullScreenOnAwake=!1}))):(e.removeAttribute("x5-video-player-fullscreen"),jv.exitFullScreen())):(this._fullScreenOnAwake=t,this._forceUpdate=!0,void this.syncMatrix())}syncStayOnBottom(t){this._video&&(this._video.style["z-index"]=t?-32768:0,this._stayOnBottom=t),this._dirty=!0}syncKeepAspectRatio(t){this._keepAspectRatio=t,t&&this._loadedMeta&&this._video&&this.syncUITransform(this._video.videoWidth,this._video.videoHeight)}removeVideoPlayer(){const t=this._video;t&&Zt(Lv.container,t)&&(Lv.container.removeChild(t),this.removeAllListeners()),this._cachedCurrentTime=0,this._playing=!1,this._loaded=!1,this._loadedMeta=!1,this._video=null}createVideoPlayer(t){const e=this._video=document.createElement("video");e.className="cocosVideo",e.style.visibility="hidden",e.style.position="absolute",e.style.bottom="0px",e.style.left="0px",e.style["transform-origin"]="0px 100% 0px",e.style["-webkit-transform-origin"]="0px 100% 0px",e.setAttribute("preload","auto"),e.setAttribute("webkit-playsinline",""),e.setAttribute("x5-playsinline",""),e.setAttribute("playsinline",""),this._bindDomEvent(),Lv.container.appendChild(e);const i=document.createElement("source");e.appendChild(i),i.src=t}_bindDomEvent(){this._video,this.addListener("loadedmetadata",this.onLoadedMetadata.bind(this)),this.addListener("canplay",this.onCanPlay.bind(this)),this.addListener("canplaythrough",this.onCanPlay.bind(this)),this.addListener("play",this.onPlay.bind(this)),this.addListener("playing",this.onPlaying.bind(this)),this.addListener("pause",this.onPause.bind(this)),this.addListener("click",this.onClick.bind(this)),this.addListener("ended",this.onEnded.bind(this)),this.addListener("error",this.onError.bind(this))}onCanPlay(t){const e=t.target;if(!this._loaded||!e)switch(e.readyState){case A6.HAVE_METADATA:case A6.HAVE_ENOUGH_DATA:super.onCanPlay(t)}}enable(){if(this._video){if(this._visible=!0,"visible"===this._video.style.visibility)return;this._video.style.visibility="visible"}}disable(t){if(this._video){if(!t&&this._playing&&this._video.pause(),this._visible=!1,"hidden"===this._video.style.visibility)return;this._video.style.visibility="hidden"}}syncMatrix(){if(!this._video||!this._visible||!this._component)return;const t=this.UICamera;if(!t)return;if(jv.fullScreen())return;this._dirty&&(this._dirty=!1,this._stayOnBottom?(this._clearColorA=t.clearColor.w,this._clearFlag=t.clearFlag,t.clearColor.w=0,t.clearFlag=Co.ALL):this._clearFlag&&(t.clearColor.w=this._clearColorA,t.clearFlag=this._clearFlag,this._clearColorA=-1,this._clearFlag=null)),this._component.node.getWorldMatrix(b6),t.update(!0),t.worldMatrixToScreen(b6,b6,Lv.canvas.width,Lv.canvas.height);let e=0,i=0;if(this._fullScreenOnAwake?(e=Fv.width,i=Fv.height):(e=this._uiTrans.contentSize.width,i=this._uiTrans.contentSize.height),!this._forceUpdate&&this._m00===b6.m00&&this._m01===b6.m01&&this._m04===b6.m04&&this._m05===b6.m05&&this._m12===b6.m12&&this._m13===b6.m13&&this._w===e&&this._h===i)return;this._m00=b6.m00,this._m01=b6.m01,this._m04=b6.m04,this._m05=b6.m05,this._m12=b6.m12,this._m13=b6.m13,this._w=e,this._h=i;const n=kv.getDevicePixelRatio(),s=1/n,r=1/n,o=Lv.container,a=b6.m00*s,l=b6.m01,c=b6.m04,h=b6.m05*r;this._video.style.width=`${this._w}px`,this._video.style.height=`${this._h}px`,hn.browserType!==Qi.MOBILE_QQ?this._video.style.objectFit=this._keepAspectRatio?"none":"fill":m("keepAspectRatio is not supported by the qq mobile browser.");const _=this._w*s,u=this._h*r,{x:d,y:p}=this._uiTrans.anchorPoint,f=_*b6.m00*d,g=u*b6.m05*p,y=o&&o.style.paddingLeft?parseInt(o.style.paddingLeft):0,v=o&&o.style.paddingBottom?parseInt(o.style.paddingBottom):0,x=`matrix(${a},${-l},${-c},${h},${b6.m12*s-f+y},${-(b6.m13*r-g+v)})`;this._video.style.transform=x,this._video.style["-webkit-transform"]=x,hn.browserType!==Qi.IE&&(this._forceUpdate=!1)}}class w6{static getImpl(t){return new T6(t)}}var E6,P6,I6,D6,R6,M6,B6,O6,N6,L6,F6,z6,V6,U6,G6,H6,k6,j6,W6,q6,X6,Y6,K6,J6,$6,Z6,Q6,t8,e8,i8,n8,s8,r8,o8,a8,l8,c8,h8,_8;n.internal.VideoPlayerImplManager=w6;let u8,m8=t("VideoPlayer",(E6=u_("cc.VideoPlayer"),P6=T_(),I6=S_(),D6=m_(rB),R6=H_(g6),M6=H_(x6),B6=I_(),O6=I_(),N6=H_(g6),L6=I_(),F6=I_(),z6=D_(),V6=I_(),U6=D_(),G6=I_(),H6=I_(),k6=I_(),j6=I_(),W6=I_(),q6=I_(),X6=H_([Rw]),Y6=N_(),K6=I_(),E6(J6=P6(J6=I6(J6=D6(J6=x_((_8=h8=class extends Nm{constructor(...t){super(...t),i_(this,"_resourceType",Z6,this),i_(this,"_remoteURL",Q6,this),i_(this,"_clip",t8,this),i_(this,"_playOnAwake",e8,this),i_(this,"_volume",i8,this),i_(this,"_mute",n8,this),i_(this,"_playbackRate",s8,this),i_(this,"_loop",r8,this),i_(this,"_fullScreenOnAwake",o8,this),i_(this,"_stayOnBottom",a8,this),i_(this,"_keepAspectRatio",l8,this),this._impl=null,this._cachedCurrentTime=0,i_(this,"videoPlayerEvent",c8,this)}get resourceType(){return this._resourceType}set resourceType(t){this._resourceType!==t&&(this._resourceType=t,this.syncSource())}get remoteURL(){return this._remoteURL}set remoteURL(t){this._remoteURL!==t&&(this._remoteURL=t,this.syncSource())}get clip(){return this._clip}set clip(t){this._clip!==t&&(this._clip=t,this.syncSource())}get playOnAwake(){return this._playOnAwake}set playOnAwake(t){this._playOnAwake=t}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._impl&&this._impl.syncPlaybackRate(t)}get volume(){return this._volume}set volume(t){this._volume=t,this._impl&&this._impl.syncVolume(t)}get mute(){return this._mute}set mute(t){this._mute=t,this._impl&&this._impl.syncMute(t)}get loop(){return this._loop}set loop(t){this._loop=t,this._impl&&this._impl.syncLoop(t)}get keepAspectRatio(){return this._keepAspectRatio}set keepAspectRatio(t){this._keepAspectRatio!==t&&(this._keepAspectRatio=t,this._impl&&this._impl.syncKeepAspectRatio(t))}get fullScreenOnAwake(){return this._impl?(this._fullScreenOnAwake=this._impl.fullScreenOnAwake,this._fullScreenOnAwake):this._fullScreenOnAwake}set fullScreenOnAwake(t){this._fullScreenOnAwake!==t&&(this._fullScreenOnAwake=t,this._impl&&this._impl.syncFullScreenOnAwake(t))}get stayOnBottom(){return this._stayOnBottom}set stayOnBottom(t){this._stayOnBottom!==t&&(this._stayOnBottom=t,this._impl&&this._impl.syncStayOnBottom(t))}get nativeVideo(){return this._impl&&this._impl.video||null}get currentTime(){return this._impl?this._impl.getCurrentTime():this._cachedCurrentTime}set currentTime(t){Number.isNaN(t)?m(`illegal video time! value:${t}`):(t=Ue(t,0,this.duration),this._cachedCurrentTime=t,this._impl&&this._impl.seekTo(t))}get duration(){return this._impl?this._impl.getDuration():0}get state(){return this._impl?this._impl.state:S6.NONE}get isPlaying(){return!!this._impl&&this._impl.isPlaying}syncSource(){this._impl&&(this._resourceType===x6.REMOTE?this._impl.syncURL(this._remoteURL):this._impl.syncClip(this._clip))}__preload(){this._impl=w6.getImpl(this),this.syncSource(),this._impl.syncLoop(this._loop),this._impl.syncVolume(this._volume),this._impl.syncMute(this._mute),this._impl.seekTo(this._cachedCurrentTime),this._impl.syncPlaybackRate(this._playbackRate),this._impl.syncStayOnBottom(this._stayOnBottom),this._impl.syncKeepAspectRatio(this._keepAspectRatio),this._impl.syncFullScreenOnAwake(this._fullScreenOnAwake),this._impl.componentEventList.set(S6.META_LOADED,this.onMetaLoaded.bind(this)),this._impl.componentEventList.set(S6.READY_TO_PLAY,this.onReadyToPlay.bind(this)),this._impl.componentEventList.set(S6.PLAYING,this.onPlaying.bind(this)),this._impl.componentEventList.set(S6.PAUSED,this.onPasued.bind(this)),this._impl.componentEventList.set(S6.STOPPED,this.onStopped.bind(this)),this._impl.componentEventList.set(S6.COMPLETED,this.onCompleted.bind(this)),this._impl.componentEventList.set(S6.ERROR,this.onError.bind(this)),this._playOnAwake&&this._impl.loaded&&this.play()}onEnable(){this._impl&&this._impl.enable()}onDisable(){this._impl&&this._impl.disable()}onDestroy(){this._impl&&(this._impl.destroy(),this._impl=null)}update(t){this._impl&&this._impl.syncMatrix()}onMetaLoaded(){Rw.emitEvents(this.videoPlayerEvent,this,S6.META_LOADED),this.node.emit("meta-loaded",this)}onReadyToPlay(){this._playOnAwake&&!this.isPlaying&&this.play(),Rw.emitEvents(this.videoPlayerEvent,this,S6.READY_TO_PLAY),this.node.emit(S6.READY_TO_PLAY,this)}onPlaying(){Rw.emitEvents(this.videoPlayerEvent,this,S6.PLAYING),this.node.emit(S6.PLAYING,this)}onPasued(){Rw.emitEvents(this.videoPlayerEvent,this,S6.PAUSED),this.node.emit(S6.PAUSED,this)}onStopped(){Rw.emitEvents(this.videoPlayerEvent,this,S6.STOPPED),this.node.emit(S6.STOPPED,this)}onCompleted(){Rw.emitEvents(this.videoPlayerEvent,this,S6.COMPLETED),this.node.emit(S6.COMPLETED,this)}onError(){Rw.emitEvents(this.videoPlayerEvent,this,S6.ERROR),this.node.emit(S6.ERROR,this)}play(){this._impl&&this._impl.play()}resume(){this._impl&&this._impl.resume()}pause(){this._impl&&this._impl.pause()}stop(){this._impl&&this._impl.stop()}},h8.EventType=S6,h8.ResourceType=x6,Z6=n_(($6=_8).prototype,"_resourceType",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return x6.LOCAL}}),Q6=n_($6.prototype,"_remoteURL",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),t8=n_($6.prototype,"_clip",[R6,g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),e8=n_($6.prototype,"_playOnAwake",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),i8=n_($6.prototype,"_volume",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),n8=n_($6.prototype,"_mute",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),s8=n_($6.prototype,"_playbackRate",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),r8=n_($6.prototype,"_loop",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),o8=n_($6.prototype,"_fullScreenOnAwake",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a8=n_($6.prototype,"_stayOnBottom",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),l8=n_($6.prototype,"_keepAspectRatio",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),n_($6.prototype,"resourceType",[M6,B6],Object.getOwnPropertyDescriptor($6.prototype,"resourceType"),$6.prototype),n_($6.prototype,"remoteURL",[O6],Object.getOwnPropertyDescriptor($6.prototype,"remoteURL"),$6.prototype),n_($6.prototype,"clip",[N6,L6],Object.getOwnPropertyDescriptor($6.prototype,"clip"),$6.prototype),n_($6.prototype,"playOnAwake",[F6],Object.getOwnPropertyDescriptor($6.prototype,"playOnAwake"),$6.prototype),n_($6.prototype,"playbackRate",[O_,z6,V6],Object.getOwnPropertyDescriptor($6.prototype,"playbackRate"),$6.prototype),n_($6.prototype,"volume",[O_,U6,G6],Object.getOwnPropertyDescriptor($6.prototype,"volume"),$6.prototype),n_($6.prototype,"mute",[H6],Object.getOwnPropertyDescriptor($6.prototype,"mute"),$6.prototype),n_($6.prototype,"loop",[k6],Object.getOwnPropertyDescriptor($6.prototype,"loop"),$6.prototype),n_($6.prototype,"keepAspectRatio",[j6],Object.getOwnPropertyDescriptor($6.prototype,"keepAspectRatio"),$6.prototype),n_($6.prototype,"fullScreenOnAwake",[W6],Object.getOwnPropertyDescriptor($6.prototype,"fullScreenOnAwake"),$6.prototype),n_($6.prototype,"stayOnBottom",[q6],Object.getOwnPropertyDescriptor($6.prototype,"stayOnBottom"),$6.prototype),c8=n_($6.prototype,"videoPlayerEvent",[g_,X6,Y6,K6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),J6=$6))||J6)||J6)||J6)||J6)||J6));n.internal.VideoPlayer=m8,function(t){t.NONE="none",t.LOADING="loading",t.LOADED="loaded",t.ERROR="error"}(u8||(u8={}));class d8{constructor(t){this._componentEventList=new Map,this._state=u8.NONE,this._warpper=void 0,this._webview=null,this._loaded=!1,this._forceUpdate=!1,this._component=null,this._uiTrans=null,this._node=null,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=t,this._node=t.node,this._uiTrans=t.node.getComponent(rB),this.reset(),this.createWebView()}reset(){this._warpper=null,this._webview=null,this._loaded=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._state=u8.NONE,this._forceUpdate=!1}get loaded(){return this._loaded}get componentEventList(){return this._componentEventList}get webview(){return this._webview}get state(){return this._state}get UICamera(){return aT.root.batcher2D.getFirstRenderCamera(this._node)}dispatchEvent(t,...e){const i=this._componentEventList.get(t);i&&(this._state=t,i.call(this,e))}destroy(){this.removeWebView(),this._warpper=null,this._webview=null,this._loaded=!1,this._component=null,this._uiTrans=null,this._forceUpdate=!1,this._componentEventList.clear()}}n.internal.WebViewImpl=d8;const p8=bi();class f8 extends d8{constructor(t){super(t)}_bindDomEvent(){this.webview&&this.webview.addEventListener("load",(t=>{this._forceUpdate=!0,this.dispatchEvent(u8.LOADED);const e=t.target,i=e.contentDocument&&e.contentDocument.body;i&&i.innerHTML.includes("404")&&this.dispatchEvent(u8.ERROR,i.innerHTML)}))}loadURL(t){this.webview&&(this.webview.src=t,this.dispatchEvent(u8.LOADING))}createWebView(){const t=document.createElement("div");this._warpper=t,t.id="webview-wrapper",t.style["-webkit-overflow"]="auto",t.style["-webkit-overflow-scrolling"]="touch",t.style.position="absolute",t.style.bottom="0px",t.style.left="0px",t.style.transformOrigin="0px 100% 0px",t.style["-webkit-transform-origin"]="0px 100% 0px",Lv.container.appendChild(t);const e=document.createElement("iframe");this._webview=e,e.id="webview",e.style.border="none",e.style.width="100%",e.style.height="100%",t.appendChild(e),this._bindDomEvent()}removeWebView(){const t=this._warpper;Zt(Lv.container,t)&&Lv.container.removeChild(t),this.reset()}enable(){this._warpper&&(this._warpper.style.visibility="visible")}disable(){this._warpper&&(this._warpper.style.visibility="hidden")}evaluateJS(t){if(this.webview){const e=this.webview.contentWindow;if(e)try{e.eval(t)}catch(t){this.dispatchEvent(u8.ERROR,t),d(t)}}}setOnJSCallback(t){m("The platform does not support")}setJavascriptInterfaceScheme(t){m("The platform does not support")}syncMatrix(){if(!this._warpper||!this._uiTrans||!this._component||"hidden"===this._warpper.style.visibility)return;const t=this.UICamera;if(!t)return;this._component.node.getWorldMatrix(p8),t.update(!0),t.worldMatrixToScreen(p8,p8,Lv.canvas.width,Lv.canvas.height);const{width:e,height:i}=this._uiTrans.contentSize;if(!this._forceUpdate&&this._m00===p8.m00&&this._m01===p8.m01&&this._m04===p8.m04&&this._m05===p8.m05&&this._m12===p8.m12&&this._m13===p8.m13&&this._w===e&&this._h===i)return;this._m00=p8.m00,this._m01=p8.m01,this._m04=p8.m04,this._m05=p8.m05,this._m12=p8.m12,this._m13=p8.m13,this._w=e,this._h=i;const n=kv.getDevicePixelRatio(),s=1/n,r=1/n,o=Lv.container,a=p8.m00*s,l=p8.m01,c=p8.m04,h=p8.m05*r;this._warpper.style.width=`${e}px`,this._warpper.style.height=`${i}px`;const _=this._w*s,u=this._h*r,m=_*p8.m00*this._uiTrans.anchorX,d=u*p8.m05*this._uiTrans.anchorY,p=o&&o.style.paddingLeft?parseInt(o.style.paddingLeft):0,f=o&&o.style.paddingBottom?parseInt(o.style.paddingBottom):0,g=`matrix(${a},${-l},${-c},${h},${p8.m12*s-m+p},${-(p8.m13*r-d+f)})`;this._warpper.style.transform=g,this._warpper.style["-webkit-transform"]=g,this._forceUpdate=!1}}class g8{static getImpl(t){return new f8(t)}}var y8,v8,x8,S8,A8,C8,b8,T8,w8,E8,P8,I8,D8,R8;n.internal.WebViewImplManager=g8;let M8=t("WebView",(y8=u_("cc.WebView"),v8=T_(),x8=S_(),S8=m_(rB),A8=I_(),C8=H_([Rw]),b8=N_(),T8=I_(),y8(w8=v8(w8=x8(w8=S8(w8=x_((R8=D8=class extends Nm{constructor(...t){super(...t),i_(this,"_url",P8,this),this._impl=null,i_(this,"webviewEvents",I8,this)}get url(){return this._url}set url(t){this._url=t,this._impl&&this._impl.loadURL(t)}get nativeWebView(){return this._impl&&this._impl.webview||null}get state(){return this._impl?this._impl.state:u8.NONE}setJavascriptInterfaceScheme(t){this._impl&&this._impl.setJavascriptInterfaceScheme(t)}setOnJSCallback(t){this._impl&&this._impl.setOnJSCallback(t)}evaluateJS(t){this._impl&&this._impl.evaluateJS(t)}__preload(){this._impl=g8.getImpl(this),this._impl.componentEventList.set(u8.LOADING,this.onLoading.bind(this)),this._impl.componentEventList.set(u8.LOADED,this.onLoaded.bind(this)),this._impl.componentEventList.set(u8.ERROR,this.onError.bind(this)),this._impl.loadURL(this._url)}onLoading(){Rw.emitEvents(this.webviewEvents,this,u8.LOADING),this.node.emit(u8.LOADING,this)}onLoaded(){Rw.emitEvents(this.webviewEvents,this,u8.LOADED),this.node.emit(u8.LOADED,this)}onError(...t){Rw.emitEvents(this.webviewEvents,this,u8.ERROR,t),this.node.emit(u8.ERROR,this,t)}onEnable(){this._impl&&this._impl.enable()}onDisable(){this._impl&&this._impl.disable()}onDestroy(){this._impl&&(this._impl.destroy(),this._impl=null)}update(t){this._impl&&this._impl.syncMatrix()}},D8.EventType=u8,P8=n_((E8=R8).prototype,"_url",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"https://cocos.com"}}),n_(E8.prototype,"url",[A8],Object.getOwnPropertyDescriptor(E8.prototype,"url"),E8.prototype),I8=n_(E8.prototype,"webviewEvents",[g_,C8,b8,T8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),w8=E8))||w8)||w8)||w8)||w8)||w8));n.internal.WebView=M8;class B8{constructor(){this.originalTarget=null,this.target=null,this.tag=B8.TAG_INVALID}clone(){const t=new B8;return t.originalTarget=null,t.target=null,t.tag=this.tag,t}isDone(){return!0}startWithTarget(t){this.originalTarget=t,this.target=t}stop(){this.target=null}step(t){S(1006)}update(t){S(1007)}getTarget(){return this.target}setTarget(t){this.target=t}getOriginalTarget(){return this.originalTarget}setOriginalTarget(t){this.originalTarget=t}getTag(){return this.tag}setTag(t){this.tag=t}reverse(){return S(1008),null}retain(){}release(){}}B8.TAG_INVALID=-1;class O8 extends B8{constructor(...t){super(...t),this._duration=0,this._timesForRepeat=1}getDuration(){return this._duration*(this._timesForRepeat||1)}setDuration(t){this._duration=t}clone(){return new O8}}let N8,L8,F8,z8,V8,U8,G8,H8=0;class k8{constructor(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1}}class j8{constructor(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}_searchElementByTarget(t,e){for(let i=0;i<t.length;i++)if(e===t[i].target)return t[i];return null}_getElement(t,e){let i=this._elementPool.pop();return i||(i=new k8),i.target=t,i.paused=!!e,i}_putElement(t){t.actions.length=0,t.actionIndex=0,t.currentAction=null,t.paused=!1,t.target=null,t.lock=!1,this._elementPool.push(t)}addAction(t,e,i){if(!t||!e)return void T(1e3);null==e.uuid&&(e.uuid="_TWEEN_UUID_"+H8++);let n=this._hashTargets.get(e);n?n.actions||(n.actions=[]):(n=this._getElement(e,i),this._hashTargets.set(e,n),this._arrayTargets.push(n)),n.target=e,n.actions.push(t),t.startWithTarget(e)}removeAllActions(){const t=this._arrayTargets;for(let e=0;e<t.length;e++){const i=t[e];i&&this._putElement(i)}this._arrayTargets.length=0,this._hashTargets=new Map}removeAllActionsFromTarget(t){if(null==t)return;const e=this._hashTargets.get(t);e&&(e.actions.length=0,this._deleteHashElement(e))}removeAction(t){if(null==t)return;const e=t.getOriginalTarget(),i=this._hashTargets.get(e);if(i)for(let e=0;e<i.actions.length;e++)if(i.actions[e]===t){i.actions.splice(e,1),i.actionIndex>=e&&i.actionIndex--;break}}_removeActionByTag(t,e,i){for(let n=0,s=e.actions.length;n<s;++n){const s=e.actions[n];if(s&&s.getTag()===t){if(i&&s.getOriginalTarget()!==i)continue;this._removeActionAtIndex(n,e);break}}}removeActionByTag(t,e){t===B8.TAG_INVALID&&S(1002);const i=this._hashTargets;if(e){const n=i.get(e);n&&this._removeActionByTag(t,n,e)}else i.forEach((e=>{this._removeActionByTag(t,e)}))}getActionByTag(t,e){t===B8.TAG_INVALID&&S(1004);const i=this._hashTargets.get(e);if(i){if(null!=i.actions)for(let e=0;e<i.actions.length;++e){const n=i.actions[e];if(n&&n.getTag()===t)return n}S(1005,t)}return null}getNumberOfRunningActionsInTarget(t){const e=this._hashTargets.get(t);return e&&e.actions?e.actions.length:0}pauseTarget(t){const e=this._hashTargets.get(t);e&&(e.paused=!0)}resumeTarget(t){const e=this._hashTargets.get(t);e&&(e.paused=!1)}pauseAllRunningActions(){const t=[],e=this._arrayTargets;for(let i=0;i<e.length;i++){const n=e[i];n&&!n.paused&&(n.paused=!0,t.push(n.target))}return t}resumeTargets(t){if(t)for(let e=0;e<t.length;e++)t[e]&&this.resumeTarget(t[e])}pauseTargets(t){if(t)for(let e=0;e<t.length;e++)t[e]&&this.pauseTarget(t[e])}purgeSharedManager(){n.director.getScheduler().unscheduleUpdate(this)}_removeActionAtIndex(t,e){e.actions[t],e.actions.splice(t,1),e.actionIndex>=t&&e.actionIndex--,0===e.actions.length&&this._deleteHashElement(e)}_deleteHashElement(t){let e=!1;if(t&&!t.lock&&this._hashTargets.get(t.target)){this._hashTargets.delete(t.target);const i=this._arrayTargets;for(let e=0,n=i.length;e<n;e++)if(i[e]===t){i.splice(e,1);break}this._putElement(t),e=!0}return e}update(t){const e=this._arrayTargets;let i;for(let n=0;n<e.length;n++){this._currentTarget=e[n],i=this._currentTarget;const s=i.target;if(s instanceof Gi&&!s.isValid)this.removeAllActionsFromTarget(s),n--;else{if(!i.paused&&i.actions){for(i.lock=!0,i.actionIndex=0;i.actionIndex<i.actions.length;i.actionIndex++)if(i.currentAction=i.actions[i.actionIndex],i.currentAction){if(i.currentAction.step(t*(i.currentAction._speedMethod?i.currentAction._speed:1)),i.currentAction&&i.currentAction.isDone()){i.currentAction.stop();const t=i.currentAction;i.currentAction=null,this.removeAction(t)}i.currentAction=null}i.lock=!1}0===i.actions.length&&this._deleteHashElement(i)&&n--}}}}class W8 extends Kx{constructor(...t){super(...t),this.actionMgr=new j8}get ActionManager(){return this.actionMgr}update(t){this.actionMgr.update(t)}}t("TweenSystem",W8),W8.ID="TWEEN",W8.instance=void 0,aT.on(oT.EVENT_INIT,(()=>{const t=new W8;W8.instance=t,aT.registerSystem(W8.ID,t,100)}));class q8 extends O8{isDone(){return!0}step(t){this.update(1)}update(t){}reverse(){return this.clone()}clone(){return new q8}}class X8 extends q8{update(t){const e=this.target.getComponentsInChildren(hP);for(let t=0;t<e.length;++t)e[t].enabled=!0}reverse(){return new Y8}clone(){return new X8}}class Y8 extends q8{update(t){const e=this.target.getComponentsInChildren(hP);for(let t=0;t<e.length;++t)e[t].enabled=!1}reverse(){return new X8}clone(){return new Y8}}class K8 extends q8{constructor(t){super(),this._isNeedCleanUp=!0,void 0!==t&&this.init(t)}update(t){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()}init(t){return this._isNeedCleanUp=t,!0}reverse(){return new K8(this._isNeedCleanUp)}clone(){return new K8(this._isNeedCleanUp)}}class J8 extends q8{constructor(t,e,i){super(),this._selectorTarget=null,this._function=null,this._data=null,this.initWithFunction(t,e,i)}initWithFunction(t,e,i){return t&&(this._function=t),e&&(this._selectorTarget=e),void 0!==i&&(this._data=i),!0}execute(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)}update(t){this.execute()}getTargetCallback(){return this._selectorTarget}setTargetCallback(t){t!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=t)}clone(){const t=new J8;return t.initWithFunction(this._function,this._selectorTarget,this._data),t}}class $8 extends O8{constructor(t){super(),this.MAX_VALUE=2,this._elapsed=0,this._firstTick=!1,this._easeList=[],this._speed=1,this._repeatForever=!1,this._repeatMethod=!1,this._speedMethod=!1,void 0===t||isNaN(t)||this.initWithDuration(t)}getElapsed(){return this._elapsed}initWithDuration(t){return this._duration=0===t?qt.FLT_EPSILON:t,this._elapsed=0,this._firstTick=!0,!0}isDone(){return this._elapsed>=this._duration}_cloneDecoration(t){t._repeatForever=this._repeatForever,t._speed=this._speed,t._timesForRepeat=this._timesForRepeat,t._easeList=this._easeList,t._speedMethod=this._speedMethod,t._repeatMethod=this._repeatMethod}_reverseEaseList(t){if(this._easeList){t._easeList=[];for(let e=0;e<this._easeList.length;e++)t._easeList.push(this._easeList[e])}}clone(){const t=new $8(this._duration);return this._cloneDecoration(t),t}easing(t){this._easeList?this._easeList.length=0:this._easeList=[];for(let t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this}_computeEaseTime(t){return t}step(t){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=t;let e=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);e=e<1?e:1,this.update(e>0?e:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))}startWithTarget(t){B8.prototype.startWithTarget.call(this,t),this._elapsed=0,this._firstTick=!0}reverse(){return S(1010),this}setAmplitudeRate(t){S(1011)}getAmplitudeRate(){return S(1012),0}speed(t){return t<=0?(S(1013),this):(this._speedMethod=!0,this._speed*=t,this)}getSpeed(){return this._speed}setSpeed(t){return this._speed=t,this}repeat(t){return t=Math.round(t),isNaN(t)||t<1?(S(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=t,this)}repeatForever(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this}}class Z8 extends $8{constructor(t){super(),this._actions=[],this._split=0,this._last=0,this._reversed=!1;const e=t instanceof Array?t:arguments;if(1===e.length)return void T(1019);const i=e.length-1;if(i>=0&&null==e[i]&&S(1015),i>=0){let t,n=e[0];for(let s=1;s<i;s++)e[s]&&(t=n,n=Z8._actionOneTwo(t,e[s]));this.initWithTwoActions(n,e[i])}}initWithTwoActions(t,e){if(!t||!e)return T(1025),!1;let i=t._duration,n=e._duration;i*=t._repeatMethod?t._timesForRepeat:1,n*=e._repeatMethod?e._timesForRepeat:1;const s=i+n;return this.initWithDuration(s),this._actions[0]=t,this._actions[1]=e,!0}clone(){const t=new Z8;return this._cloneDecoration(t),t.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),t}startWithTarget(t){$8.prototype.startWithTarget.call(this,t),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1}stop(){-1!==this._last&&this._actions[this._last].stop(),B8.prototype.stop.call(this)}update(t){let e,i=0;const n=this._split,s=this._actions,r=this._last;let o;(t=this._computeEaseTime(t))<n?(e=0!==n?t/n:1,0===i&&1===r&&this._reversed&&(s[1].update(0),s[1].stop())):(i=1,e=1===n?1:(t-n)/(1-n),-1===r&&(s[0].startWithTarget(this.target),s[0].update(1),s[0].stop()),0===r&&(s[0].update(1),s[0].stop())),o=s[i],r===i&&o.isDone()||(r!==i&&o.startWithTarget(this.target),e*=o._timesForRepeat,o.update(e>1?e%1:e),this._last=i)}reverse(){const t=Z8._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t._reversed=!0,t}}function Q8(t){const e=t instanceof Array?t:arguments;if(1===e.length)return T(1019),null;const i=e.length-1;i>=0&&null==e[i]&&S(1015);let n=null;if(i>=0){n=e[0];for(let t=1;t<=i;t++)e[t]&&(n=Z8._actionOneTwo(n,e[t]))}return n}Z8._actionOneTwo=function(t,e){const i=new Z8;return i.initWithTwoActions(t,e),i};class t7 extends $8{constructor(t,e){super(),this._times=0,this._total=0,this._nextDt=0,this._actionInstant=!1,this._innerAction=null,void 0!==e&&this.initWithAction(t,e)}initWithAction(t,e){const i=t._duration*e;return!!this.initWithDuration(i)&&(this._times=e,this._innerAction=t,t instanceof q8&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)}clone(){const t=new t7;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone(),this._times),t}startWithTarget(t){this._total=0,this._nextDt=this._innerAction._duration/this._duration,$8.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)}stop(){this._innerAction.stop(),B8.prototype.stop.call(this)}update(t){t=this._computeEaseTime(t);const e=this._innerAction,i=this._duration,n=this._times;let s=this._nextDt;if(t>=s){for(;t>s&&this._total<n;)e.update(1),this._total++,e.stop(),e.startWithTarget(this.target),s+=e._duration/i,this._nextDt=s>1?1:s;t>=1&&this._total<n&&(e.update(1),this._total++),this._actionInstant||(this._total===n?e.stop():e.update(t-(s-e._duration/i)))}else e.update(t*n%1)}isDone(){return this._total===this._times}reverse(){const t=new t7(this._innerAction.reverse(),this._times);return this._cloneDecoration(t),this._reverseEaseList(t),t}setInnerAction(t){this._innerAction!==t&&(this._innerAction=t)}getInnerAction(){return this._innerAction}}class e7 extends $8{constructor(t){super(),this._innerAction=null,t&&this.initWithAction(t)}initWithAction(t){return t?(this._innerAction=t,!0):(T(1026),!1)}clone(){const t=new e7;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone()),t}startWithTarget(t){$8.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)}step(t){const e=this._innerAction;e.step(t),e.isDone()&&(e.startWithTarget(this.target),e.step(e.getElapsed()-e._duration))}isDone(){return!1}reverse(){const t=new e7(this._innerAction.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t}setInnerAction(t){this._innerAction!==t&&(this._innerAction=t)}getInnerAction(){return this._innerAction}}class i7 extends $8{constructor(t){super(),this._one=null,this._two=null;const e=t instanceof Array?t:arguments;if(1===e.length)return void T(1020);const i=e.length-1;if(i>=0&&null==e[i]&&S(1015),i>=0){let t,n=e[0];for(let s=1;s<i;s++)e[s]&&(t=n,n=i7._actionOneTwo(t,e[s]));this.initWithTwoActions(n,e[i])}}initWithTwoActions(t,e){if(!t||!e)return T(1027),!1;let i=!1;const n=t._duration,s=e._duration;return this.initWithDuration(Math.max(n,s))&&(this._one=t,this._two=e,n>s?this._two=Z8._actionOneTwo(e,r7(n-s)):n<s&&(this._one=Z8._actionOneTwo(t,r7(s-n))),i=!0),i}clone(){const t=new i7;return this._cloneDecoration(t),t.initWithTwoActions(this._one.clone(),this._two.clone()),t}startWithTarget(t){$8.prototype.startWithTarget.call(this,t),this._one.startWithTarget(t),this._two.startWithTarget(t)}stop(){this._one.stop(),this._two.stop(),B8.prototype.stop.call(this)}update(t){t=this._computeEaseTime(t),this._one&&this._one.update(t),this._two&&this._two.update(t)}reverse(){const t=i7._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t}}function n7(t){const e=t instanceof Array?t:arguments;if(1===e.length)return T(1020),null;e.length>0&&null==e[e.length-1]&&S(1015);let i=e[0];for(let t=1;t<e.length;t++)null!=e[t]&&(i=i7._actionOneTwo(i,e[t]));return i}i7._actionOneTwo=function(t,e){const i=new i7;return i.initWithTwoActions(t,e),i};class s7 extends $8{update(t){}reverse(){const t=new s7(this._duration);return this._cloneDecoration(t),this._reverseEaseList(t),t}clone(){const t=new s7;return this._cloneDecoration(t),t.initWithDuration(this._duration),t}}function r7(t){return new s7(t)}class o7 extends $8{constructor(t){super(),this._other=null,t&&this.initWithAction(t)}initWithAction(t){return t?t===this._other?(T(1029),!1):!!$8.prototype.initWithDuration.call(this,t._duration)&&(this._other=t,!0):(T(1028),!1)}clone(){const t=new o7;return this._cloneDecoration(t),t.initWithAction(this._other.clone()),t}startWithTarget(t){$8.prototype.startWithTarget.call(this,t),this._other.startWithTarget(t)}update(t){t=this._computeEaseTime(t),this._other&&this._other.update(1-t)}reverse(){return this._other.clone()}stop(){this._other.stop(),B8.prototype.stop.call(this)}}class a7 extends $8{constructor(t,e,i){if(super(),this._opts=void 0,this._props=void 0,this._originProps=void 0,null==i)i=Object.create(null);else if(function(t){const e=" [Tween:] ",i=` option is not support in v + ${s}`,n=t;n.delay&&m(`${e}delay${i}`),n.repeat&&m(`${e}repeat${i}`),n.repeatDelay&&m(`${e}repeatDelay${i}`),n.interpolation&&m(`${e}interpolation${i}`),n.onStop&&m(`${e}onStop${i}`)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(t){const e=t.charAt(0);if(/[A-Z]/.test(e)){const i=(t=t.replace(e,e.toLowerCase())).split("-");if(2===i.length){const e=i[0];if("linear"===e)t="linear";else{const n=i[1];switch(e){case"quadratic":t=`quad${n}`;break;case"quartic":t=`quart${n}`;break;case"quintic":t=`quint${n}`;break;case"sinusoidal":t=`sine${n}`;break;case"exponential":t=`expo${n}`;break;case"circular":t=`circ${n}`;break;default:t=e+n}}}}return t}(i.easing)),i.progress||(i.progress=this.progress),i.easing&&"string"==typeof i.easing){const t=i.easing;i.easing=qx[t],i.easing||C(1031,t)}this._opts=i,this._props=Object.create(null);for(const t in e){if(!e.hasOwnProperty(t))continue;let i,n,s=e[t];if(null==s||"string"==typeof s||"function"==typeof s)continue;void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?(i=qx[s.easing],i||C(1031,s.easing)):i=s.easing,n=s.progress,s=s.value);const r=Object.create(null);r.value=s,r.easing=i,r.progress=n,this._props[t]=r}this._originProps=e,this.initWithDuration(t)}clone(){const t=new a7(this._duration,this._originProps,this._opts);return this._cloneDecoration(t),t}startWithTarget(t){$8.prototype.startWithTarget.call(this,t);const e=!!this._opts.relative,i=this._props;for(const n in i){const s=t[n];if(void 0===s)continue;const r=i[n],o=r.value;if("number"==typeof s)r.start=s,r.current=s,r.end=e?s+o:o;else if("object"==typeof s){null==r.start&&(r.start={},r.current={},r.end={});for(const t in o)isNaN(s[t])||(r.start[t]=s[t],r.current[t]=s[t],r.end[t]=e?s[t]+o[t]:o[t])}}this._opts.onStart&&this._opts.onStart(this.target)}update(t){const e=this.target;if(!e)return;const i=this._props,n=this._opts;let s=t;n.easing&&(s=n.easing(t));const r=n.progress;for(const n in i){const o=i[n],a=o.easing?o.easing(t):s,l=o.progress?o.progress:r,c=o.start,h=o.end;if("number"==typeof c)o.current=l(c,h,o.current,a);else if("object"==typeof c)for(const t in c)o.current[t]=l(c[t],h[t],o.current[t],a);e[n]=o.current}n.onUpdate&&n.onUpdate(this.target,t),1===t&&n.onComplete&&n.onComplete(this.target)}progress(t,e,i,n){return t+(e-t)*n}}class l7 extends q8{constructor(t){super(),this._props=void 0,this._props={},void 0!==t&&this.init(t)}init(t){for(const e in t)this._props[e]=t[e];return!0}update(){const t=this._props,e=this.target;for(const i in t)e[i]=t[i]}clone(){const t=new l7;return t.init(this._props),t}}class c7{constructor(t){this._actions=[],this._finalAction=null,this._target=null,this._tag=B8.TAG_INVALID,this._target=void 0===t?null:t}tag(t){return this._tag=t,this}then(t){return t instanceof B8?this._actions.push(t.clone()):this._actions.push(t._union()),this}target(t){return this._target=t,this}start(){return this._target?(this._finalAction&&W8.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),W8.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(m("Please set target to tween first"),this)}stop(){return this._finalAction&&W8.instance.ActionManager.removeAction(this._finalAction),this}clone(t){const e=this._union();return h7(t).then(e.clone())}union(){const t=this._union();return this._actions.length=0,this._actions.push(t),this}to(t,e,i){(i=i||Object.create(null)).relative=!1;const n=new a7(t,e,i);return this._actions.push(n),this}by(t,e,i){(i=i||Object.create(null)).relative=!0;const n=new a7(t,e,i);return this._actions.push(n),this}set(t){const e=new l7(t);return this._actions.push(e),this}delay(t){const e=r7(t);return this._actions.push(e),this}call(t){const e=new J8(t,undefined,undefined);return this._actions.push(e),this}sequence(...t){const e=c7._wrappedSequence(...t);return this._actions.push(e),this}parallel(...t){const e=c7._wrappedParallel(...t);return this._actions.push(e),this}repeat(t,e){if(t==1/0)return this.repeatForever(e);const i=this._actions;let n;return n=e instanceof c7?e._union():i.pop(),i.push(function(t,e){return new t7(t,e)}(n,t)),this}repeatForever(t){const e=this._actions;let i;return i=t instanceof c7?t._union():e.pop(),e.push(function(t){return new e7(t)}(i)),this}reverseTime(t){const e=this._actions;let i;return i=t instanceof c7?t._union():e.pop(),e.push(function(t){return new o7(t)}(i)),this}hide(){const t=new Y8;return this._actions.push(t),this}show(){const t=new X8;return this._actions.push(t),this}removeSelf(){const t=new K8(!1);return this._actions.push(t),this}static stopAll(){W8.instance.ActionManager.removeAllActions()}static stopAllByTag(t,e){W8.instance.ActionManager.removeActionByTag(t,e)}static stopAllByTarget(t){W8.instance.ActionManager.removeAllActionsFromTarget(t)}_union(){const t=this._actions;let e;return e=1===t.length?t[0]:Q8(t),e}_destroy(){this.stop()}static _wrappedSequence(...t){const e=c7._tmp_args;e.length=0;for(let i=t.length,n=0;n<i;n++){const i=e[n]=t[n];i instanceof c7&&(e[n]=i._union())}return Q8.apply(Q8,e)}static _wrappedParallel(...t){const e=c7._tmp_args;e.length=0;for(let i=t.length,n=0;n<i;n++){const i=e[n]=t[n];i instanceof c7&&(e[n]=i._union())}return n7.apply(n7,e)}}function h7(t){return new c7(t)}function _7(t){return m("tweenUtil' is deprecated, please use 'tween' instead "),new c7(t)}t("Tween",c7),c7._tmp_args=[],n.Tween=c7,n.tween=h7,n.tweenUtil=_7,function(t){t[t.ORTHO=0]="ORTHO",t[t.HEX=1]="HEX",t[t.ISO=2]="ISO"}(N8||(N8={})),jt(N8),function(t){t[t.NONE=0]="NONE",t[t.MAP=1]="MAP",t[t.LAYER=2]="LAYER",t[t.OBJECTGROUP=3]="OBJECTGROUP",t[t.OBJECT=4]="OBJECT",t[t.TILE=5]="TILE"}(L8||(L8={})),jt(L8),function(t){t[t.HORIZONTAL=2147483648]="HORIZONTAL",t[t.VERTICAL=1073741824]="VERTICAL",t[t.DIAGONAL=536870912]="DIAGONAL",t[t.FLIPPED_ALL=4026531840]="FLIPPED_ALL",t[t.FLIPPED_MASK=268435455]="FLIPPED_MASK"}(F8||(F8={})),jt(F8),function(t){t[t.STAGGERAXIS_X=0]="STAGGERAXIS_X",t[t.STAGGERAXIS_Y=1]="STAGGERAXIS_Y"}(z8||(z8={})),jt(z8),function(t){t[t.STAGGERINDEX_ODD=0]="STAGGERINDEX_ODD",t[t.STAGGERINDEX_EVEN=1]="STAGGERINDEX_EVEN"}(V8||(V8={})),jt(V8),function(t){t[t.RightDown=0]="RightDown",t[t.RightUp=1]="RightUp",t[t.LeftDown=2]="LeftDown",t[t.LeftUp=3]="LeftUp"}(U8||(U8={})),jt(U8),function(t){t[t.RECT=0]="RECT",t[t.ELLIPSE=1]="ELLIPSE",t[t.POLYGON=2]="POLYGON",t[t.POLYLINE=3]="POLYLINE",t[t.IMAGE=4]="IMAGE",t[t.TEXT=5]="TEXT"}(G8||(G8={})),jt(G8);class u7{constructor(){this.name="",this.firstGid=0,this.spacing=0,this.margin=0,this.sourceImage=void 0,this.imageName=null,this.imageSize=new Mi(0,0),this.tileOffset=new Ti(0,0),this._tileSize=new Mi(0,0),this.collection=!1}rectForGID(t,e){const i=e||new Oi(0,0,0,0);i.width=this._tileSize.width,i.height=this._tileSize.height;let n=t;n&=F8.FLIPPED_MASK,n-=this.firstGid;const s=Math.floor((this.imageSize.width-2*this.margin+this.spacing)/(this._tileSize.width+this.spacing));return i.x=Math.round(n%s*(this._tileSize.width+this.spacing)+this.margin),i.y=Math.round(Math.floor(n/s)*(this._tileSize.height+this.spacing)+this.margin),i}}class m7{constructor(){this.properties={},this.name="",this.objects=[],this.visible=!0,this.opacity=0,this.color=new si(255,255,255,255),this.offset=new Ti(0,0),this.draworder="topdown",this.tintColor=null}getProperties(){return this.properties}setProperties(t){this.properties=t}}class d7{constructor(){this.properties={},this.name="",this.layerSize=null,this.tiles=[],this.visible=!0,this.opacity=0,this.ownTiles=!0,this.minGID=1e5,this.maxGID=0,this.offset=new Ti(0,0),this.tintColor=null}getProperties(){return this.properties}setProperties(t){this.properties=t}}d7.ATTRIB_NONE=1,d7.ATTRIB_BASE64=2,d7.ATTRIB_GZIP=4,d7.ATTRIB_ZLIB=8;class p7{constructor(){this.name="",this.visible=!0,this.width=0,this.height=0,this.offset=new Ti(0,0),this.opacity=0,this.trans=new si(255,255,255,255),this.sourceImage=void 0,this.tintColor=null}}function f7(t){const e=UO.HorizontalAlign;switch(t){case"center":return e.CENTER;case"right":return e.RIGHT;default:return e.LEFT}}function g7(t){const e=UO.VerticalAlign;switch(t){case"center":return e.CENTER;case"bottom":return e.BOTTOM;default:return e.TOP}}function y7(t){if(!t)return new si(0,0,0,255);if(8===(t=-1!==t.indexOf("#")?t.substring(1):t).length){const e=parseInt(t.substr(0,2),16)||255,i=parseInt(t.substr(2,2),16)||0,n=parseInt(t.substr(4,2),16)||0,s=parseInt(t.substr(6,2),16)||0;return new si(i,n,s,e)}{const e=parseInt(t.substr(0,2),16)||0,i=parseInt(t.substr(2,2),16)||0,n=parseInt(t.substr(4,2),16)||0;return new si(e,i,n,255)}}function v7(t,e){const i=[],n=t.getElementsByTagName("properties");for(let t=0;t<n.length;++t){const e=n[t].getElementsByTagName("property");for(let t=0;t<e.length;++t)i.push(e[t])}e=e||{};for(let t=0;t<i.length;t++){const n=i[t],s=n.getAttribute("name"),r=n.getAttribute("type")||"string";let o=n.getAttribute("value");"int"===r?o=parseInt(o):"float"===r?o=parseFloat(o):"bool"===r?o="true"===o:"color"===r&&(o=y7(o)),e[s]=o}return e}class x7{get mapSize(){return this._mapSize}get tileSize(){return this._tileSize}constructor(t,e,i,n,s){this.properties={},this.orientation=null,this.parentElement=null,this.parentGID=0,this.layerAttrs=0,this.storingCharacters=!1,this.currentString=null,this.renderOrder=U8.RightDown,this._supportVersion=[1,4,0],this._objectGroups=[],this._allChildren=[],this._mapSize=new Mi(0,0),this._tileSize=new Mi(0,0),this._layers=[],this._tilesets=[],this._imageLayers=[],this._tileProperties=new Map,this._tileAnimations={},this._tsxContentMap=null,this._spriteFrameMap=null,this._spfSizeMap={},this._staggerAxis=null,this._staggerIndex=null,this._hexSideLength=0,this._imageLayerSPF=null,this.initWithXML(t,e,i,n,s)}getOrientation(){return this.orientation}setOrientation(t){this.orientation=t}getStaggerAxis(){return this._staggerAxis}setStaggerAxis(t){this._staggerAxis=t}getStaggerIndex(){return this._staggerIndex}setStaggerIndex(t){this._staggerIndex=t}getHexSideLength(){return this._hexSideLength}setHexSideLength(t){this._hexSideLength=t}getMapSize(){return new Mi(this._mapSize.width,this._mapSize.height)}setMapSize(t){this._mapSize.width=t.width,this._mapSize.height=t.height}get mapWidth(){return this._mapSize.width}set mapWidth(t){this._mapSize.width=t}get mapHeight(){return this._mapSize.height}set mapHeight(t){this._mapSize.height=t}getTileSize(){return new Mi(this._tileSize.width,this._tileSize.height)}setTileSize(t){this._tileSize.width=t.width,this._tileSize.height=t.height}get tileWidth(){return this._tileSize.width}set tileWidth(t){this._tileSize.width=t}get tileHeight(){return this._tileSize.height}set tileHeight(t){this._tileSize.height=t}getLayers(){return this._layers}setLayers(t){this._allChildren.push(t),this._layers.push(t)}getImageLayers(){return this._imageLayers}setImageLayers(t){this._allChildren.push(t),this._imageLayers.push(t)}getTilesets(){return this._tilesets}setTilesets(t){this._tilesets.push(t)}getObjectGroups(){return this._objectGroups}setObjectGroups(t){this._allChildren.push(t),this._objectGroups.push(t)}getAllChildren(){return this._allChildren}getParentElement(){return this.parentElement}setParentElement(t){this.parentElement=t}getParentGID(){return this.parentGID}setParentGID(t){this.parentGID=t}getLayerAttribs(){return this.layerAttrs}setLayerAttribs(t){this.layerAttrs=t}getStoringCharacters(){return this.storingCharacters}setStoringCharacters(t){this.storingCharacters=t}getProperties(){return this.properties}setProperties(t){this.properties=t}initWithXML(t,e,i,n,s){return this._tilesets.length=0,this._layers.length=0,this._imageLayers.length=0,this._tsxContentMap=e,this._spriteFrameMap=i,this._imageLayerSPF=s,this._spfSizeMap=n,this._objectGroups.length=0,this._allChildren.length=0,this.properties={},this._tileProperties=new Map,this._tileAnimations=new Map,this.currentString="",this.storingCharacters=!1,this.layerAttrs=d7.ATTRIB_NONE,this.parentElement=null,this.parseXMLString(t)}parseXMLString(t,e){let i;const n=(new JT).parse(t).documentElement,s=n.getAttribute("orientation"),r=n.getAttribute("staggeraxis"),o=n.getAttribute("staggerindex"),a=n.getAttribute("hexsidelength"),l=n.getAttribute("renderorder"),c=n.getAttribute("version")||"1.0.0";if("map"===n.nodeName){const t=c.split("."),e=this._supportVersion;for(i=0;i<e.length;i++){const n=parseInt(t[i])||0;if(e[i]<n){S(7216,c);break}}"orthogonal"===s?this.orientation=N8.ORTHO:"isometric"===s?this.orientation=N8.ISO:"hexagonal"===s?this.orientation=N8.HEX:null!==s&&S(7217,s),this.renderOrder="right-up"===l?U8.RightUp:"left-up"===l?U8.LeftUp:"left-down"===l?U8.LeftDown:U8.RightDown,"x"===r?this.setStaggerAxis(z8.STAGGERAXIS_X):"y"===r&&this.setStaggerAxis(z8.STAGGERAXIS_Y),"odd"===o?this.setStaggerIndex(V8.STAGGERINDEX_ODD):"even"===o&&this.setStaggerIndex(V8.STAGGERINDEX_EVEN),a&&this.setHexSideLength(parseFloat(a));let h=new Mi(0,0);h.width=parseFloat(n.getAttribute("width")),h.height=parseFloat(n.getAttribute("height")),this.setMapSize(h),h=new Mi(0,0),h.width=parseFloat(n.getAttribute("tilewidth")),h.height=parseFloat(n.getAttribute("tileheight")),this.setTileSize(h),this.properties=v7(n)}let h=n.getElementsByTagName("tileset");for("map"!==n.nodeName&&(h=[],h.push(n)),i=0;i<h.length;i++){const t=h[i],n=t.getAttribute("source");if(n){const e=parseInt(t.getAttribute("firstgid")),i=this._tsxContentMap[n];i&&this.parseXMLString(i,e)}else{const i=t.getElementsByTagName("image"),n=i.length>1,s=i[0];let r=s.getAttribute("source");r=r.replace(/\\/g,"/");const o=t.getElementsByTagName("tile"),a=o&&o.length||1;let l=null;const c=t.getAttribute("name")||"",h=parseInt(t.getAttribute("spacing"))||0,_=parseInt(t.getAttribute("margin"))||0,u=e||parseInt(t.getAttribute("firstgid"))||0,m=new Mi(0,0);m.width=parseFloat(t.getAttribute("tilewidth")),m.height=parseFloat(t.getAttribute("tileheight"));const d=t.getElementsByTagName("tileoffset")[0];let p=0,f=0;d&&(p=parseFloat(d.getAttribute("x"))||0,f=parseFloat(d.getAttribute("y"))||0);let g=null;for(let t=0;t<a;t++){if(!g||n){if(g=new u7,g.name=c,g.firstGid=u&F8.FLIPPED_MASK,g.tileOffset.x=p,g.tileOffset.y=f,g.collection=n,!n&&(g.imageName=r,g.imageSize.width=parseFloat(s.getAttribute("width"))||0,g.imageSize.height=parseFloat(s.getAttribute("height"))||0,g.sourceImage=this._spriteFrameMap[r],!g.sourceImage)){const t=x7.getNameWithPostfix(r);if(g.imageName=t,g.sourceImage=this._spriteFrameMap[t],!g.sourceImage){const t=x7.getShortName(r);g.imageName=t,g.sourceImage=this._spriteFrameMap[t],g.sourceImage||(console.error(`[error]: ${t} not find in [${Object.keys(this._spriteFrameMap).join(", ")}]`),T(7221,r),console.warn(`Please try asset type of ${r} to 'sprite-frame'`))}}g.spacing=h,g.margin=_,g._tileSize.width=m.width,g._tileSize.height=m.height,this.setTilesets(g)}if(l=o&&o[t],!l)continue;this.parentGID=u+(parseInt(l.getAttribute("id"))||0);const e=l.getElementsByTagName("image");if(e&&e.length>0){const t=e[0];let i=t.getAttribute("source");if(i=i.replace(/\\/g,"/"),g.imageName=i,g.imageSize.width=parseFloat(t.getAttribute("width"))||0,g.imageSize.height=parseFloat(t.getAttribute("height"))||0,g._tileSize.width=g.imageSize.width,g._tileSize.height=g.imageSize.height,g.sourceImage=this._spriteFrameMap[i],!g.sourceImage){const t=x7.getNameWithPostfix(r);if(g.imageName=t,g.sourceImage=this._spriteFrameMap[t],!g.sourceImage){const t=x7.getShortName(i);g.imageName=t,g.sourceImage=this._spriteFrameMap[t],g.sourceImage||(T(7221,i),console.warn(`Please try asset type of ${i} to 'sprite-frame'`))}}g.firstGid=this.parentGID&F8.FLIPPED_MASK}const i=(F8.FLIPPED_MASK&this.parentGID)>>>0;this._tileProperties.set(i,v7(l));const a=l.getElementsByTagName("animation");if(a&&a.length>0){const t=a[0].getElementsByTagName("frame"),e={frames:[],dt:0,frameIdx:0};this._tileAnimations.set(i,e);const n=e.frames;for(let e=0;e<t.length;e++){const i=t[e],s=u+(parseInt(i.getAttribute("tileid"))||0),r=parseFloat(i.getAttribute("duration"))||0;n.push({tileid:s,duration:r/1e3,grid:null})}}}}}const _=n.childNodes;for(i=0;i<_.length;i++){const t=_[i];if(!this._shouldIgnoreNode(t)){if("imagelayer"===t.nodeName){const e=this._parseImageLayer(t);e&&this.setImageLayers(e)}if("layer"===t.nodeName){const e=this._parseLayer(t);this.setLayers(e)}if("objectgroup"===t.nodeName){const e=this._parseObjectGroup(t);this.setObjectGroups(e)}}}return n}_shouldIgnoreNode(t){return 3===t.nodeType||8===t.nodeType||4===t.nodeType}_parseImageLayer(t){const e=t.getElementsByTagName("image");if(!e||0===e.length)return null;const i=new p7;i.name=t.getAttribute("name"),i.offset.x=parseFloat(t.getAttribute("offsetx"))||0,i.offset.y=parseFloat(t.getAttribute("offsety"))||0;const n=t.getAttribute("visible");i.visible=!("0"===n);const s=t.getAttribute("opacity");i.opacity=s?Math.round(255*parseFloat(s)):255;const r=t.getAttribute("tintcolor");i.tintColor=r?y7(r):null;const o=e[0],a=o.getAttribute("source");return i.sourceImage=this._imageLayerSPF[a],i.width=parseInt(o.getAttribute("width"))||0,i.height=parseInt(o.getAttribute("height"))||0,i.trans=y7(o.getAttribute("trans")),i.sourceImage?i:(T(7221,a),console.warn(`Please try asset type of ${a} to 'sprite-frame'`),null)}_parseLayer(t){const e=t.getElementsByTagName("data")[0],i=new d7;i.name=t.getAttribute("name");const n=new Mi(0,0);n.width=parseFloat(t.getAttribute("width")),n.height=parseFloat(t.getAttribute("height")),i.layerSize=n;const s=t.getAttribute("visible");i.visible=!("0"===s);const r=t.getAttribute("opacity");i.opacity=r?Math.round(255*parseFloat(r)):255,i.offset=new Ti(parseFloat(t.getAttribute("offsetx"))||0,parseFloat(t.getAttribute("offsety"))||0);const o=t.getAttribute("tintcolor");i.tintColor=o?y7(o):null;let a="";for(let t=0;t<e.childNodes.length;t++)a+=e.childNodes[t].nodeValue;a=a.trim();const l=e.getAttribute("compression"),c=e.getAttribute("encoding");if(l&&"gzip"!==l&&"zlib"!==l)return S(7218),null;let h;switch(l){case"gzip":h=t5.unzipBase64AsArray(a,4);break;case"zlib":h=function(t){if(t.length%4!=0)return null;const e=t.length/4,i=window.Uint32Array?new Uint32Array(e):[];for(let n=0;n<e;n++){const e=4*n;i[n]=t[e]+256*t[e+1]+65536*t[e+2]+t[e+3]*(1<<24)}return i}(new r4.Inflate(t5.Base64.decodeAsArray(a,1)).decompress());break;case null:case"":if("base64"===c)h=t5.Base64.decodeAsArray(a,4);else if("csv"===c){h=[];const t=a.split(",");for(let e=0;e<t.length;e++)h.push(parseInt(t[e]))}else{const t=e.getElementsByTagName("tile");h=[];for(let e=0;e<t.length;e++)h.push(parseInt(t[e].getAttribute("gid")))}break;default:this.layerAttrs===d7.ATTRIB_NONE&&S(7219)}return h&&(i.tiles=new Uint32Array(h)),i.properties=v7(t),i}_parseObjectGroup(t){const e=new m7;e.name=t.getAttribute("name")||"",e.offset=new Ti(parseFloat(t.getAttribute("offsetx")),parseFloat(t.getAttribute("offsety")));const i=t.getAttribute("opacity");e.opacity=i?Math.round(255*parseFloat(i)):255;const n=t.getAttribute("tintcolor");e.tintColor=n?y7(n):null;const s=t.getAttribute("visible");s&&0===parseInt(s)&&(e.visible=!1);const r=t.getAttribute("color");r&&e.color.fromHEX(r);const o=t.getAttribute("draworder");o&&(e.draworder=o),e.setProperties(v7(t));const a=t.getElementsByTagName("object");if(a){for(let t=0;t<a.length;t++){const i=a[t],n={};n.id=i.getAttribute("id")||t,n.name=i.getAttribute("name")||"",n.width=parseFloat(i.getAttribute("width"))||0,n.height=parseFloat(i.getAttribute("height"))||0,n.x=parseFloat(i.getAttribute("x"))||0,n.y=parseFloat(i.getAttribute("y"))||0,n.rotation=parseFloat(i.getAttribute("rotation"))||0,v7(i,n);const s=i.getAttribute("visible");n.visible=!(s&&0===parseInt(s));const r=i.getElementsByTagName("text");if(r&&r.length>0){const t=r[0];n.type=G8.TEXT,n.wrap="1"===t.getAttribute("wrap"),n.color=y7(t.getAttribute("color")),n.halign=f7(t.getAttribute("halign")),n.valign=g7(t.getAttribute("valign")),n.pixelsize=parseInt(t.getAttribute("pixelsize"))||16,n.text=t.childNodes[0].nodeValue}const o=i.getAttribute("gid");o&&(n.gid=parseInt(o),n.type=G8.IMAGE);const l=i.getElementsByTagName("ellipse");l&&l.length>0&&(n.type=G8.ELLIPSE);const c=i.getElementsByTagName("polygon");if(c&&c.length>0){n.type=G8.POLYGON;const t=c[0].getAttribute("points");t&&(n.points=this._parsePointsString(t))}const h=i.getElementsByTagName("polyline");if(h&&h.length>0){n.type=G8.POLYLINE;const t=h[0].getAttribute("points");t&&(n.polylinePoints=this._parsePointsString(t))}n.type||(n.type=G8.RECT),e.objects.push(n)}"index"!==o&&e.objects.sort(((t,e)=>t.y-e.y))}return e}_parsePointsString(t){if(!t)return null;const e=[],i=t.split(" ");for(let t=0;t<i.length;t++){const n=i[t].split(",");e.push({x:parseFloat(n[0]),y:parseFloat(n[1])})}return e}setTileAnimations(t){this._tileAnimations=t}getTileAnimations(){return this._tileAnimations}getTileProperties(){return this._tileProperties}setTileProperties(t){this._tileProperties=t}getCurrentString(){return this.currentString}setCurrentString(t){this.currentString=t}static getNameWithPostfix(t){const e=(t=t.replace(/\\/g,"/")).lastIndexOf("/")+1,i=t.length;return t.substring(e,i)}static getShortName(t){const e=(t=t.replace(/\\/g,"/")).lastIndexOf("/")+1;let i=t.lastIndexOf(".");return i=i<0?t.length:i,t.substring(e,i)}}var S7,A7,C7,b7,T7,w7,E7,P7,I7,D7,R7,M7;let B7=t("TiledTile",(S7=u_("cc.TiledTile"),A7=T_(),C7=S_(),b7=H_(ue),T7=H_(ue),w7=H_(ue),E7=H_(ue),P7=H_(ue),S7(I7=A7(I7=C7((R7=n_((D7=class extends Nm{constructor(){super(),this._layer=null,i_(this,"_x",R7,this),i_(this,"_y",M7,this)}get x(){return this._x}set x(t){t!==this._x&&(this._layer&&this._layer.isInvalidPosition(t,this._y)?m("Invalid x, the valid value is between [%s] ~ [%s]",0,this._layer.layerSize.width):(this._resetTile(),this._x=t,this.updateInfo()))}get y(){return this._y}set y(t){t!==this._y&&(this._layer&&this._layer.isInvalidPosition(this._x,t)?m("Invalid y, the valid value is between [%s] ~ [%s]",0,this._layer.layerSize.height):(this._resetTile(),this._y=t,this.updateInfo()))}get grid(){return this._layer?this._layer.getTileGIDAt(this._x,this._y):0}set grid(t){this._layer&&this._layer.setTileGIDAt(t,this._x,this._y)}onEnable(){const t=this.node.parent;this._layer=t.getComponent("cc.TiledLayer"),this._resetTile(),this.updateInfo()}onDisable(){this._resetTile()}_resetTile(){this._layer&&this._layer.getTiledTileAt(this._x,this._y)===this&&this._layer.setTiledTileAt(this._x,this._y,null)}updateInfo(){if(!this._layer)return;const t=this._x,e=this._y;if(this._layer.getTiledTileAt(t,e))return void m("There is already a TiledTile at [%s, %s]",t,e);const i=this._layer.getPositionAt(t,e);this.node.setPosition(i.x,i.y),this._layer.setTiledTileAt(t,e,this)}}).prototype,"_x",[b7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),M7=n_(D7.prototype,"_y",[T7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n_(D7.prototype,"x",[w7],Object.getOwnPropertyDescriptor(D7.prototype,"x"),D7.prototype),n_(D7.prototype,"y",[E7],Object.getOwnPropertyDescriptor(D7.prototype,"y"),D7.prototype),n_(D7.prototype,"grid",[P7],Object.getOwnPropertyDescriptor(D7.prototype,"grid"),D7.prototype),I7=D7))||I7)||I7)||I7));function O7(t,e,i){const n=i||t.sourceImage,s=n.texture,r=t.collection;if(!t.imageSize.width||!t.imageSize.height){const e=t.sourceImage;t.imageSize.width=e.width,t.imageSize.height=e.height}const o=t.imageSize.width,a=t.imageSize.height,l=t._tileSize.width,c=t._tileSize.height,h=n.width,_=n.height,u=t.spacing,m=t.margin;let d=1;if(!r){const t=Math.floor((o-2*m+u)/(l+u)),e=Math.floor((a-2*m+u)/(c+u));d=Math.max(1,e*t)}const p=t.firstGid;let f=null,g=!!e.get(p);const y=t.firstGid+d;let v=p;for(;v<y&&(g&&!e.get(v)&&(g=!1),g||!e.get(v));++v){if(f={tileset:t,x:0,y:0,width:l,height:c,t:0,l:0,r:0,b:0,cx:0,cy:0,offsetX:0,offsetY:0,rotated:!1,gid:v,spriteFrame:n,texture:s},t.rectForGID(v,f),!i||d>1)if(i){f._name=i.name;const t=i.unbiasUV[0],e=i.rotated?i.unbiasUV[1]:i.unbiasUV[5];f.l=t+(f.x+.5)/h,f.t=e+(f.y+.5)/_,f.r=t+(f.x+f.width-.5)/h,f.b=e+(f.y+f.height-.5)/_,f._rect=new Oi(f.x,f.y,f.width,f.height)}else f.l=f.x/h,f.t=f.y/_,f.r=(f.x+f.width)/h,f.b=(f.y+f.height)/_,f._rect=new Oi(f.x,f.y,f.width,f.height);else i.rotated?(f._rotated=!0,f._name=i.name,f._rect=i.getRect(),f.l=i.unbiasUV[0],f.t=i.unbiasUV[1],f.r=i.unbiasUV[4],f.b=i.unbiasUV[3]):(f._name=i.name,f._rect=i.getRect(),f.l=i.unbiasUV[0],f.t=i.unbiasUV[5],f.r=i.unbiasUV[2],f.b=i.unbiasUV[1]);f.cx=(f.l+f.r)/2,f.cy=(f.t+f.b)/2,e.set(v,f)}}function N7(t,e){const i=t.length;if(0===i)return void e();let n=0;const s=()=>{n++,n>=i&&e()};for(let e=0;e<i;e++){const i=t[e];i.loaded?s():i.once("load",(()=>{s()}))}}var L7,F7;const z7=new Si,V7=new Ti,U7=new oi,G7=new oi,H7={row:0,col:0};let k7=t("TiledUserNodeData",u_("cc.TiledUserNodeData")(L7=class extends Nm{constructor(){super(),this._index=-1,this._row=-1,this._col=-1,this._tiledLayer=null}})||L7),j7=t("TiledLayer",u_("cc.TiledLayer")(F7=class t extends wB{get cullingRect(){return this._cullingRect}get rightTop(){return this._rightTop}get layerSize(){return this._layerSize}get meshRenderDataArray(){return this._meshRenderDataArray}get leftDownToCenterX(){return this._leftDownToCenterX}get leftDownToCenterY(){return this._leftDownToCenterY}constructor(){super(),this._userNodeGrid={},this._userNodeMap={},this._userNodeDirty=!1,this.tiledTiles=[],this._viewPort={x:-1,y:-1,width:-1,height:-1},this._cullingRect={leftDown:{row:-1,col:-1},rightTop:{row:-1,col:-1}},this._cullingDirty=!0,this._rightTop={row:-1,col:-1},this._layerInfo=null,this._mapInfo=null,this._topOffset=0,this._downOffset=0,this._leftOffset=0,this._rightOffset=0,this.tiles=[],this.vertices=[],this._verticesDirty=!0,this._layerName="",this._layerSize=void 0,this._minGID=void 0,this._maxGID=void 0,this._layerOrientation=null,this._opacity=void 0,this._tintColor=void 0,this.texGrids=null,this._textures=[],this._tilesets=[],this._leftDownToCenterX=0,this._leftDownToCenterY=0,this._hasTiledNodeGrid=!1,this._hasAniGrid=!1,this._animations=null,this._enableCulling=void 0,this.colorChanged=!1,this._properties=void 0,this.renderOrder=void 0,this._staggerAxis=void 0,this._staggerIndex=void 0,this._hexSideLength=void 0,this._mapTileSize=void 0,this._odd_even=void 0,this._diffX1=void 0,this._diffY1=void 0,this._useAutomaticVertexZ=void 0,this._vertexZvalue=void 0,this._offset=void 0,this._meshRenderDataArray=null,this._meshRenderDataArrayIdx=0}hasTiledNode(){return this._hasTiledNodeGrid}hasAnimation(){return this._hasAniGrid}set enableCulling(t){this._enableCulling!==t&&(this._enableCulling=t,this._cullingDirty=!0,this.markForUpdateRenderData())}get enableCulling(){return this._enableCulling}addUserNode(t){let e=t.getComponent(k7);return e?(m("CCTiledLayer:addUserNode node has been added"),!1):(e=t.addComponent(k7),t.parent=this.node,this._userNodeMap[t.uuid]=e,e._row=-1,e._col=-1,e._tiledLayer=this,this._nodeLocalPosToLayerPos(t.getPosition(),V7),this._positionToRowCol(V7.x,V7.y,H7),this._addUserNodeToGrid(e,H7),this._updateCullingOffsetByUserNode(t),t.on(_p.TRANSFORM_CHANGED,this._userNodePosChange,e),t.on(_p.SIZE_CHANGED,this._userNodeSizeChange,e),!0)}removeUserNode(t){const e=t.getComponent(k7);return e?(t.off(_p.TRANSFORM_CHANGED,this._userNodePosChange,e),t.off(_p.SIZE_CHANGED,this._userNodeSizeChange,e),this._removeUserNodeFromGrid(e),delete this._userNodeMap[t.uuid],t._removeComponent(e),e.destroy(),t.removeFromParent(),!0):(m("CCTiledLayer:removeUserNode node is not exist"),!1)}destroyUserNode(t){this.removeUserNode(t),t.destroy()}_nodeLocalPosToLayerPos(t,e){e.x=t.x+this._leftDownToCenterX,e.y=t.y+this._leftDownToCenterY}getNodesByRowCol(t,e){const i=this._userNodeGrid[t];return i?i[e]:null}getNodesCountByRow(t){const e=this._userNodeGrid[t];return e?e.count:0}_updateAllUserNode(){this._userNodeGrid={};for(const t in this._userNodeMap){const e=this._userNodeMap[t];this._nodeLocalPosToLayerPos(e.node.getPosition(),V7),this._positionToRowCol(V7.x,V7.y,H7),this._addUserNodeToGrid(e,H7),this._updateCullingOffsetByUserNode(e.node)}}_updateCullingOffsetByUserNode(t){const e=t._uiProps.uiTransformComp.contentSize;this._topOffset<e.height&&(this._topOffset=e.height),this._downOffset<e.height&&(this._downOffset=e.height),this._leftOffset<e.width&&(this._leftOffset=e.width),this._rightOffset<e.width&&(this._rightOffset=e.width)}_userNodeSizeChange(){const t=this.node,e=this._tiledLayer;e._updateCullingOffsetByUserNode(t),e._userNodeDirty=!0,e.markForUpdateRenderData()}_userNodePosChange(){const t=this,e=t.node,i=t._tiledLayer;i._nodeLocalPosToLayerPos(e.getPosition(),V7),i._positionToRowCol(V7.x,V7.y,H7),i._limitInLayer(H7),H7.row===t._row&&H7.col===t._col||(i._removeUserNodeFromGrid(t),i._addUserNodeToGrid(t,H7))}_removeUserNodeFromGrid(t){const e=t._row,i=t._col,n=t._index,s=this._userNodeGrid[e],r=s&&s[i];r&&(s.count--,r.count--,r.list[n]=null,r.count<=0&&(r.list.length=0,r.count=0)),t._row=-1,t._col=-1,t._index=-1,this._userNodeDirty=!0,this.markForUpdateRenderData()}_limitInLayer(t){const e=t.row,i=t.col;e<0&&(t.row=0),e>this._rightTop.row&&(t.row=this._rightTop.row),i<0&&(t.col=0),i>this._rightTop.col&&(t.col=this._rightTop.col)}_addUserNodeToGrid(t,e){const i=e.row,n=e.col,s=this._userNodeGrid[i]=this._userNodeGrid[i]||{count:0},r=s[n]=s[n]||{count:0,list:[]};t._row=i,t._col=n,t._index=r.list.length,s.count++,r.count++,r.list.push(t),this._userNodeDirty=!0}isUserNodeDirty(){return this._userNodeDirty}setUserNodeDirty(t){this._userNodeDirty=t}onEnable(){super.onEnable(),this.node.on(_p.ANCHOR_CHANGED,this._syncAnchorPoint,this),this.node.on(_p.TRANSFORM_CHANGED,this.updateCulling,this),this.node.on(_p.SIZE_CHANGED,this.updateCulling,this),this.node.parent.on(_p.TRANSFORM_CHANGED,this.updateCulling,this),this.node.parent.on(_p.SIZE_CHANGED,this.updateCulling,this),this.markForUpdateRenderData(),this.scheduleOnce(this.updateCulling.bind(this))}onDisable(){super.onDisable(),this.node.parent.off(_p.SIZE_CHANGED,this.updateCulling,this),this.node.parent.off(_p.TRANSFORM_CHANGED,this.updateCulling,this),this.node.off(_p.SIZE_CHANGED,this.updateCulling,this),this.node.off(_p.TRANSFORM_CHANGED,this.updateCulling,this),this.node.off(_p.ANCHOR_CHANGED,this._syncAnchorPoint,this)}_syncAnchorPoint(){const t=this.node,e=t._uiProps.uiTransformComp,i=t.getScale();this._leftDownToCenterX=e.width*e.anchorX*i.x,this._leftDownToCenterY=e.height*e.anchorY*i.y,this._cullingDirty=!0,this.markForUpdateRenderData()}onDestroy(){super.onDestroy()}getLayerName(){return this._layerName}setLayerName(t){this._layerName=t}getProperty(t){return this._properties[t]}getPositionAt(t,e){let i;switch(void 0!==e?(i=Math.floor(t),e=Math.floor(e)):(i=Math.floor(t.x),e=Math.floor(t.y)),this._layerOrientation){case N8.ORTHO:return this._positionForOrthoAt(i,e);case N8.ISO:return this._positionForIsoAt(i,e);case N8.HEX:return this._positionForHexAt(i,e)}return null}isInvalidPosition(t,e){return t>=this._layerSize.width||e>=this._layerSize.height||t<0||e<0}_positionForIsoAt(t,e){let i=0,n=0;const s=Math.floor(t)+Math.floor(e)*this._layerSize.width,r=this.tiles[s];if(r){const t=(r&F8.FLIPPED_MASK)>>>0,e=this.texGrids.get(t).tileset.tileOffset;i=e.x,n=e.y}return new Ti(.5*this._mapTileSize.width*(this._layerSize.height+t-e-1)+i,.5*this._mapTileSize.height*(this._layerSize.width-t+this._layerSize.height-e-2)-n)}_positionForOrthoAt(t,e){let i=0,n=0;const s=Math.floor(t)+Math.floor(e)*this._layerSize.width,r=this.tiles[s];if(r){const t=(r&F8.FLIPPED_MASK)>>>0,e=this.texGrids.get(t).tileset.tileOffset;i=e.x,n=e.y}return new Ti(t*this._mapTileSize.width+i,(this._layerSize.height-e-1)*this._mapTileSize.height-n)}_positionForHexAt(t,e){const i=this._mapTileSize.width,n=this._mapTileSize.height,s=this._layerSize.height,r=Math.floor(t)+Math.floor(e)*this._layerSize.width,o=(this.tiles[r]&F8.FLIPPED_MASK)>>>0;let a;a=this.texGrids.get(o)?this.texGrids.get(o).tileset.tileOffset:{x:0,y:0};const l=this._staggerIndex===V8.STAGGERINDEX_ODD?1:-1;let c=0,h=0,_=0,u=0;switch(this._staggerAxis){case z8.STAGGERAXIS_Y:_=0,e%2==1&&(_=i/2*l),c=t*i+_+a.x,h=(s-e-1)*(n-(n-this._hexSideLength)/2)-a.y;break;case z8.STAGGERAXIS_X:u=0,t%2==1&&(u=n/2*-l),c=t*(i-(i-this._hexSideLength)/2)+a.x,h=(s-e-1)*n+u-a.y}return new Ti(c,h)}setTilesGIDAt(t,e,i,n){if(!t||0===t.length||n<=0)return;i<0&&(i=0),e<0&&(e=0);let s=0;const r=e+n;for(let n=i;;n++)for(let i=e;i<r;i++){if(s>=t.length)return;this._updateTileForGID(t[s],i,n),s++}}setTileGIDAt(t,e,i,n){const s=(t&F8.FLIPPED_MASK)>>>0;if(e=Math.floor(e),i=Math.floor(i),this.isInvalidPosition(e,i))throw new Error("cc.TiledLayer.setTileGIDAt(): invalid position");this.tiles&&this._tilesets&&0!==this._tilesets.length?0!==s&&s<this._tilesets[0].firstGid?S(7239,t):(n=n||0,this._updateTileForGID((s|n)>>>0,e,i)):S(7238)}_updateTileForGID(t,e,i){const n=0|e+i*this._layerSize.width;if(n>=this.tiles.length)return;if(t===this.tiles[n])return;const s=(t&F8.FLIPPED_MASK)>>>0;this.texGrids.get(s)?(this.tiles[n]=t,this._updateVertex(e,i)):this.tiles[n]=0,this._cullingDirty=!0}getTileGIDAt(t,e){if(this.isInvalidPosition(t,e))throw new Error("cc.TiledLayer.getTileGIDAt(): invalid position");if(!this.tiles)return S(7237),null;const i=Math.floor(t)+Math.floor(e)*this._layerSize.width;return(this.tiles[i]&F8.FLIPPED_MASK)>>>0}getTileFlagsAt(t,e){if(this.isInvalidPosition(t,e))throw new Error("TiledLayer.getTileFlagsAt: invalid position");if(!this.tiles)return S(7240),null;const i=Math.floor(t)+Math.floor(e)*this._layerSize.width;return(this.tiles[i]&F8.FLIPPED_ALL)>>>0}setCullingDirty(t){this._cullingDirty=t}isCullingDirty(){return this._cullingDirty}updateViewPort(t,e,i,n){if(this._viewPort.width===i&&this._viewPort.height===n&&this._viewPort.x===t&&this._viewPort.y===e)return;this._viewPort.x=t,this._viewPort.y=e,this._viewPort.width=i,this._viewPort.height=n;let s=1;this._layerOrientation===N8.ISO&&(s=2);const r=this._viewPort.x-this._offset.x+this._leftDownToCenterX,o=this._viewPort.y-this._offset.y+this._leftDownToCenterY;let a=r-this._leftOffset,l=o-this._downOffset;const c=r+i+this._rightOffset,h=o+n+this._topOffset,_=this._cullingRect.leftDown,u=this._cullingRect.rightTop;a<0&&(a=0),l<0&&(l=0),this._positionToRowCol(a,l,H7),H7.row-=s,H7.col-=s,H7.row=H7.row>0?H7.row:0,H7.col=H7.col>0?H7.col:0,H7.row===_.row&&H7.col===_.col||(_.row=H7.row,_.col=H7.col,this._cullingDirty=!0),c<0||h<0?(H7.row=-1,H7.col=-1):(this._positionToRowCol(c,h,H7),H7.row++,H7.col++),H7.row>this._rightTop.row&&(H7.row=this._rightTop.row),H7.col>this._rightTop.col&&(H7.col=this._rightTop.col),H7.row===u.row&&H7.col===u.col||(u.row=H7.row,u.col=H7.col,this._cullingDirty=!0,this.markForUpdateRenderData())}_positionToRowCol(t,e,i){const n=this._mapTileSize.width,s=this._mapTileSize.height,r=.5*n,o=.5*s;let a=0,l=0,c=0,h=0;const _=this._staggerAxis;switch(this._layerOrientation){case N8.ORTHO:l=Math.floor(t/n),a=Math.floor(e/s);break;case N8.ISO:l=Math.floor(t/r),a=Math.floor(e/o);break;case N8.HEX:_===z8.STAGGERAXIS_Y?(a=Math.floor(e/(s-this._diffY1)),c=a%2==1?r*this._odd_even:0,l=Math.floor((t-c)/n)):(l=Math.floor(t/(n-this._diffX1)),h=l%2==1?o*-this._odd_even:0,a=Math.floor((e-h)/s))}return i.row=a,i.col=l,i}updateCulling(){if(this._enableCulling){this.node.updateWorldTransform(),Si.invert(z7,this.node.getWorldMatrix());const t=aT.root.batcher2D.getFirstRenderCamera(this.node);t&&(U7.x=0,U7.y=0,U7.z=0,G7.x=t.width,G7.y=t.height,G7.z=0,t.screenToWorld(U7,U7),t.screenToWorld(G7,G7),oi.transformMat4(U7,U7,z7),oi.transformMat4(G7,G7,z7),this.updateViewPort(U7.x,U7.y,G7.x-U7.x,G7.y-U7.y))}}getLayerOrientation(){return this._layerOrientation}getProperties(){return this._properties}_updateVertex(t,e){const i=F8.FLIPPED_MASK,n=this.vertices,s=this._layerOrientation,r=this.tiles;if(!r)return;const o=this._rightTop,a=this._mapTileSize.width,l=this._mapTileSize.height,c=.5*a,h=.5*l,_=this._layerSize.height,u=this._layerSize.width,m=this.texGrids;let d,p,f,g,y,v,x=0,S=0;s===N8.HEX&&(d=this._staggerAxis,p=this._diffX1,f=this._diffY1,g=this._odd_even);let A=0,C=0,b=0,T=0,w=0,E=0,P=0;const I=e*u+t;b=(r[I]&i)>>>0;const D=m.get(b);if(!D)return;switch(this._animations.get(b)&&(this._hasAniGrid=this._hasAniGrid||!0),s){case N8.ORTHO:A=t,C=_-e-1,x=A*a,S=C*l;break;case N8.ISO:A=_+t-e-1,C=_+u-t-e-2,x=c*A,S=h*C;break;case N8.HEX:y=d===z8.STAGGERAXIS_Y&&e%2==1?c*g:0,v=d===z8.STAGGERAXIS_X&&t%2==1?h*-g:0,x=t*(a-p)+y,S=(_-e-1)*(l-f)+v,A=t,C=_-e-1}const R=n[C]=n[C]||{minCol:0,maxCol:0},M=R[A]=R[A]||{};R.minCol>A&&(R.minCol=A),R.maxCol<A&&(R.maxCol=A),o.row<C&&(o.row=C),o.col<A&&(o.col=A);const B=D.tileset.tileOffset;x+=this._offset.x+B.x+D.offsetX,S+=this._offset.y-B.y-D.offsetY,T=-B.y+D.tileset._tileSize.height-l,T=T<0?0:T,w=B.y<0?0:B.y,E=-B.x<0?0:-B.x,P=B.x+D.tileset._tileSize.width-a,P=P<0?0:P,this._rightOffset<E&&(this._rightOffset=E),this._leftOffset<P&&(this._leftOffset=P),this._topOffset<w&&(this._topOffset=w),this._downOffset<T&&(this._downOffset=T),M.left=x,M.bottom=S,M.index=I,this._cullingDirty=!0}_updateVertices(){if(this.vertices.length=0,!this.tiles)return;const t=this._rightTop;t.row=-1,t.col=-1;const e=this._layerSize.height,i=this._layerSize.width;this._topOffset=0,this._downOffset=0,this._leftOffset=0,this._rightOffset=0,this._hasAniGrid=!1;for(let t=0;t<e;++t)for(let e=0;e<i;++e)this._updateVertex(e,t);this._verticesDirty=!1}getTiledTileAt(t,e,i){if(this.isInvalidPosition(t,e))throw new Error("TiledLayer.getTiledTileAt: invalid position");if(!this.tiles)return S(7236),null;const n=Math.floor(t)+Math.floor(e)*this._layerSize.width;let s=this.tiledTiles[n];if(!s&&i){const i=new uf;return s=i.addComponent(B7),s._x=t,s._y=e,s._layer=this,s.updateInfo(),i.parent=this.node,s}return s}setTiledTileAt(t,e,i){if(this.isInvalidPosition(t,e))throw new Error("TiledLayer.setTiledTileAt: invalid position");if(!this.tiles)return S(7236),null;const n=Math.floor(t)+Math.floor(e)*this._layerSize.width;return this.tiledTiles[n]=i,this._cullingDirty=!0,this._hasTiledNodeGrid=!!i||this.tiledTiles.some((t=>!!t)),i}getTexture(t){return t=t||0,this._textures&&t>=0&&this._textures.length>t?this._textures[t]:null}getTextures(){return this._textures}setTexture(t){this.setTextures([t])}setTextures(t){this._textures=t,this.markForUpdateRenderData()}getLayerSize(){return this._layerSize}getMapTileSize(){return this._mapTileSize}getTileSet(t){return t=t||0,this._tilesets&&t>=0&&this._tilesets.length>t?this._tilesets[t]:null}getTileSets(){return this._tilesets}setTileSet(t){this.setTileSets([t])}setTileSets(t){this._tilesets=t;const e=this._textures=[],i=this.texGrids;i.clear();for(let i=0;i<t.length;i++){const n=t[i];n&&(e[i]=n.sourceImage)}N7(e,(()=>{for(let e=0,n=t.length;e<n;++e){const n=t[e];n&&O7(n,i,n.sourceImage)}this._prepareToRender()}))}init(t,e,i,n,s){this._cullingDirty=!0,this._layerInfo=t,this._mapInfo=e;const r=t.layerSize;this._layerName=t.name,this.tiles=t.tiles,this._properties=t.properties,this._layerSize=r,this._minGID=t.minGID,this._maxGID=t.maxGID,this._opacity=t.opacity,t.tintColor&&(this._tintColor=t.tintColor),this.renderOrder=e.renderOrder,this._staggerAxis=e.getStaggerAxis(),this._staggerIndex=e.getStaggerIndex(),this._hexSideLength=e.getHexSideLength(),this._animations=e.getTileAnimations(),this._tilesets=i,this._textures=n,this.texGrids=s,this._layerOrientation=e.orientation,this._mapTileSize=e.getTileSize();const o=this._mapTileSize.width,a=this._mapTileSize.height,l=this._layerSize.width,c=this._layerSize.height;if(this._layerOrientation===N8.HEX){let t=0,e=0;this._odd_even=this._staggerIndex===V8.STAGGERINDEX_ODD?1:-1,this._staggerAxis===z8.STAGGERAXIS_X?(this._diffX1=(o-this._hexSideLength)/2,this._diffY1=0,e=a*(c+.5),t=(o+this._hexSideLength)*Math.floor(l/2)+o*(l%2)):(this._diffX1=0,this._diffY1=(a-this._hexSideLength)/2,t=o*(l+.5),e=(a+this._hexSideLength)*Math.floor(c/2)+a*(c%2)),this.node._uiProps.uiTransformComp.setContentSize(t,e)}else if(this._layerOrientation===N8.ISO){const t=l+c;this.node._uiProps.uiTransformComp.setContentSize(.5*o*t,.5*a*t)}else this.node._uiProps.uiTransformComp.setContentSize(l*o,c*a);this._offset=new Ti(t.offset.x,-t.offset.y),this._useAutomaticVertexZ=!1,this._vertexZvalue=0,this._syncAnchorPoint(),this._prepareToRender()}_prepareToRender(){this._updateVertices(),this._updateAllUserNode()}requestMeshRenderData(){this._meshRenderDataArray||(this._meshRenderDataArray=[]);const t=this._meshRenderDataArray;for(;t.length>0&&t[t.length-1].subNodes&&0===t[t.length-1].subNodes.length;)t.pop();if(t.length>0){const e=t[t.length-1];if(e.renderData&&0===e.renderData.byteCount)return e}const e=new BM,i={renderData:e,texture:null};return Object.defineProperty(e,"material",{get:()=>this.getRenderMaterial(0)}),this._meshRenderDataArray.push(i),i}requestSubNodesData(){this._meshRenderDataArray||(this._meshRenderDataArray=[]);const t=this._meshRenderDataArray;for(;t.length>0&&t[t.length-1].renderData&&0===t[t.length-1].renderData.byteCount;)t.pop();if(t.length>0&&t[t.length-1].subNodes&&0===t[t.length-1].subNodes.length)return t[t.length-1];const e={subNodes:[]};return this._meshRenderDataArray.push(e),e}destroyRenderData(){this._meshRenderDataArray&&(this._meshRenderDataArray.forEach((t=>{t.renderData&&t.renderData.reset()})),this._meshRenderDataArray.length=0)}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._meshRenderDataArray||this._assembler&&this._assembler.createData&&(this._assembler.createData(this),this.markForUpdateRenderData(),this._updateColor())}_render(t){if(this._meshRenderDataArray){for(let e=0;e<this._meshRenderDataArray.length;e++){this._meshRenderDataArrayIdx=e;const i=this._meshRenderDataArray[e];i.subNodes?i.subNodes.forEach((e=>{e&&t.walk(e.node)})):i.texture&&t.commitComp(this,i.texture,this._assembler,null)}this.node._static=!0}}})||F7);var W7,q7,X7,Y7,K7,J7;let $7=t("TiledObjectGroup",(W7=u_("cc.TiledObjectGroup"),q7=T_(),X7=m_(rB),Y7=H_(de),W7(K7=q7(K7=X7((n_((J7=class extends Nm{constructor(...t){super(...t),this._premultiplyAlpha=!1,this._groupName=void 0,this._positionOffset=void 0,this._mapInfo=void 0,this._properties=void 0,this._offset=void 0,this._opacity=void 0,this._tintColor=null,this._animations=void 0,this._hasAniObj=void 0,this._texGrids=void 0,this.aniObjects=void 0,this._objects=[]}get premultiplyAlpha(){return this._premultiplyAlpha}set premultiplyAlpha(t){this._premultiplyAlpha=t}getPositionOffset(){return this._positionOffset}getProperties(){return this._properties}getGroupName(){return this._groupName}getProperty(t){return this._properties[t.toString()]}getObject(t){for(let e=0,i=this._objects.length;e<i;e++){const i=this._objects[e];if(i&&i.name===t)return i}return null}getObjects(){return this._objects}get offset(){return this._offset}_init(t,e,i){const n=F8.FLIPPED_MASK,s=F8.HORIZONTAL,r=F8.VERTICAL;this._groupName=t.name,this._positionOffset=t.offset,this._mapInfo=e,this._properties=t.getProperties(),this._offset=new Ti(t.offset.x,-t.offset.y),this._opacity=t.opacity,t.tintColor&&(this._tintColor=t.tintColor),this._texGrids=i,this._animations=e.getTileAnimations(),this.aniObjects=[],this._hasAniObj=!1;const o=e.mapSize,a=e.tileSize;let l=0,c=0;const h=new si,_=N8.ISO===e.orientation;if(e.orientation===N8.HEX)e.getStaggerAxis()===z8.STAGGERAXIS_X?(c=a.height*(o.height+.5),l=(a.width+e.getHexSideLength())*Math.floor(o.width/2)+a.width*(o.width%2)):(l=a.width*(o.width+.5),c=(a.height+e.getHexSideLength())*Math.floor(o.height/2)+a.height*(o.height%2));else if(_){const t=o.width+o.height;l=.5*a.width*t,c=.5*a.height*t}else l=o.width*a.width,c=o.height*a.height;const u=this.node._uiProps.uiTransformComp;u.setContentSize(l,c);const m=l*u.anchorX,d=c*(1-u.anchorY),p=t.objects,f={};for(let t=0,e=p.length;t<e;t++){const e=p[t],l=e.type;e.offset=new Ti(e.x,e.y);const u=e.points||e.polylinePoints;if(u)for(let t=0;t<u.length;t++)u[t].y*=-1;if(_){const t=e.x/a.height,i=e.y/a.height;e.x=.5*a.width*(o.height+t-i),e.y=.5*a.height*(o.width+o.height-t-i)}else e.y=c-e.y;if(l===G8.TEXT){const i=`text${e.id}`;f[i]=!0;let n=this.node.getChildByName(i);n||(n=new uf),n.setRotationFromEuler(0,0,-e.rotation),n.setPosition(e.x-m,e.y-d),n.name=i,n.parent=this.node,n.setSiblingIndex(t);let s=n.getComponent(UO);s||(s=n.addComponent(UO));const r=n._uiProps.uiTransformComp;n.active=e.visible,r.anchorX=0,r.anchorY=1,this._tintColor?(h.set(this._tintColor),h.a*=this._opacity/255,s.color.set(h)):s.color.a*=this._opacity/255,s.overflow=UO.Overflow.SHRINK,s.lineHeight=e.height,s.string=e.text,s.horizontalAlign=e.halign,s.verticalAlign=e.valign,s.fontSize=e.pixelsize,r.setContentSize(e.width,e.height)}else if(l===G8.IMAGE){const o=e.gid,a=(o&n)>>>0,l=i.get(a);if(!l)continue;const c=l.tileset,u=`img${e.id}`;f[u]=!0;let p=this.node.getChildByName(u);e.width=e.width||l.width,e.height=e.height||l.height,p&&p._objFlags&Gi.Flags.HideInHierarchy&&(p.removeFromParent(),p.hideFlags|=Gi.Flags.DontSave,p.destroy(),p=null),p||(p=new uf),this._animations.get(a)&&(this.aniObjects.push({object:e,imgNode:p,gridGID:a}),this._hasAniObj=!0);const g=c.tileOffset.x,y=c.tileOffset.y;p.active=e.visible,p.setRotationFromEuler(0,0,-e.rotation),p.setPosition(e.x-m,e.y-d),p.name=u,p.parent=this.node,p.setSiblingIndex(t);let v=p.getComponent(mF);v||(v=p.addComponent(mF));const x=p._uiProps.uiTransformComp;_?(x.anchorX=.5+g/e.width,x.anchorY=y/e.height):(x.anchorX=g/e.width,x.anchorY=y/e.height),this._tintColor?(h.set(this._tintColor),h.a*=this._opacity/255,v.color.set(h)):v.color.a*=this._opacity/255,v.sizeMode=mF.SizeMode.CUSTOM,v._srcBlendFactor=this._premultiplyAlpha?ro.ONE:ro.SRC_ALPHA,v._dstBlendFactor=ro.ONE_MINUS_SRC_ALPHA,v._updateBlendFunc();let S=l.spriteFrame;S=S?S.clone():new zR,(o&s)>>>0&&(S.flipUVX=!S.flipUVX),(o&r)>>>0&&(S.flipUVY=!S.flipUVY),S.rotated=l._rotated,S.rect=l._rect,v.spriteFrame=S,x.setContentSize(e.width,e.height),v.markForUpdateRenderData()}}this._objects=p;const g=this.node.children,y=/^(?:img|text)\d+$/;for(let t=0,e=g.length;t<e;t++){const e=g[t],i=e.name;y.test(i)&&!f[i]&&e.destroy()}}update(t){if(!this._hasAniObj)return;const e=this.aniObjects,i=this._texGrids,n=N8.ISO===this._mapInfo.orientation;for(let t=0,s=e.length;t<s;t++){const s=e[t],r=s.gridGID,o=i.get(r);if(!o)continue;const a=o.tileset,l=s.object,c=s.imgNode,h=a.tileOffset.x,_=a.tileOffset.y,u=c._uiProps.uiTransformComp;n?(u.anchorX=.5+h/l.width,u.anchorY=_/l.height):(u.anchorX=h/l.width,u.anchorY=_/l.height);const m=c.getComponent(mF),d=m.spriteFrame;d.rotated=o._rotated,d.rect=o._rect,m.spriteFrame=d,m.markForUpdateRenderData()}}}).prototype,"premultiplyAlpha",[Y7],Object.getOwnPropertyDescriptor(J7.prototype,"premultiplyAlpha"),J7.prototype),K7=J7))||K7)||K7)||K7));var Z7,Q7,t9,e9,i9,n9,s9,r9,o9,a9,l9,c9,h9,_9,u9,m9,d9,p9;let f9=t("TiledMapAsset",(Z7=u_("cc.TiledMapAsset"),Q7=H_([eT]),t9=H_([pe]),e9=H_([zR]),i9=H_([zR]),n9=H_([pe]),s9=H_([pe]),r9=H_([Mi]),Z7((l9=n_((a9=class extends xu{constructor(...t){super(...t),i_(this,"tmxXmlStr",l9,this),i_(this,"tsxFiles",c9,this),i_(this,"tsxFileNames",h9,this),i_(this,"spriteFrames",_9,this),i_(this,"imageLayerSpriteFrame",u9,this),i_(this,"imageLayerSpriteFrameNames",m9,this),i_(this,"spriteFrameNames",d9,this),i_(this,"spriteFrameSizes",p9,this)}}).prototype,"tmxXmlStr",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),c9=n_(a9.prototype,"tsxFiles",[g_,Q7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),h9=n_(a9.prototype,"tsxFileNames",[g_,t9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_9=n_(a9.prototype,"spriteFrames",[g_,e9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),u9=n_(a9.prototype,"imageLayerSpriteFrame",[g_,i9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),m9=n_(a9.prototype,"imageLayerSpriteFrameNames",[g_,n9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),d9=n_(a9.prototype,"spriteFrameNames",[g_,s9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),p9=n_(a9.prototype,"spriteFrameSizes",[g_,r9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),o9=a9))||o9));var g9,y9,v9,x9,S9,A9,C9,b9,T9,w9,E9,P9,I9;t("TiledMap",(g9=u_("cc.TiledMap"),y9=T_(),v9=S_(),x9=m_(rB),S9=H_(f9),A9=N_(),g9(C9=y9(C9=v9(C9=x9(C9=x_((I9=P9=class extends Nm{constructor(...t){super(...t),this._texGrids=new Map,this._textures=[],this._tilesets=[],this._animations=new Map,this._imageLayers=[],this._layers=[],this._groups=[],this._images=[],this._properties={},this._tileProperties=new Map,this._mapInfo=null,this._mapSize=new Mi(0,0),this._tileSize=new Mi(0,0),this._preloaded=!1,this._mapOrientation=N8.ORTHO,i_(this,"_tmxFile",T9,this),i_(this,"_enableCulling",w9,this),i_(this,"cleanupImageCache",E9,this)}get tmxAsset(){return this._tmxFile}set tmxAsset(t){this._tmxFile!==t&&(this._tmxFile=t,this._preloaded&&this._applyFile())}get enableCulling(){return this._enableCulling}set enableCulling(t){this._enableCulling=t;const e=this._layers;for(let i=0;i<e.length;++i)e[i].enableCulling=t}getMapSize(){return this._mapSize}getTileSize(){return this._tileSize}getMapOrientation(){return this._mapOrientation}getObjectGroups(){return this._groups}getObjectGroup(t){const e=this._groups;for(let i=0,n=e.length;i<n;i++){const n=e[i];if(n&&n.getGroupName()===t)return n}return null}getProperties(){return this._properties}getLayers(){return this._layers}getLayer(t){const e=this._layers;for(let i=0,n=e.length;i<n;i++){const n=e[i];if(n&&n.getLayerName()===t)return n}return null}_changeLayer(t,e){const i=this._layers;for(let n=0,s=i.length;n<s;n++){const s=i[n];if(s&&s.getLayerName()===t)return void(i[n]=e)}}getProperty(t){return this._properties[t.toString()]}getPropertiesForGID(t){return this._tileProperties.get(t)}__preload(){this._preloaded=!0,this._tmxFile&&this._applyFile()}onEnable(){this.node.on(_p.ANCHOR_CHANGED,this._syncAnchorPoint,this)}onDisable(){this.node.off(_p.ANCHOR_CHANGED,this._syncAnchorPoint,this)}_applyFile(){const t=[],e={},i=this._tmxFile;if(i){let n=i.spriteFrameNames;const s=i.spriteFrameSizes,r=i.spriteFrames,o={},a={};for(let i=0;i<n.length;++i){const l=n[i];a[l]=s[i],t[i]=r[i];const c=t[i];c&&(e[c.name]=c,o[l]=c)}const l={},c=i.imageLayerSpriteFrame;n=i.imageLayerSpriteFrameNames;for(let t=0;t<c.length;++t)l[n[t]]=c[t];const h=i.tsxFileNames,_=i.tsxFiles,u={};for(let t=0;t<h.length;++t)h[t].length>0&&(u[h[t]]=_[t].text);const m=new x7(i.tmxXmlStr,u,o,a,l),d=m.getTilesets();d&&0!==d.length||S(7241),this._buildWithMapInfo(m)}else this._releaseMapInfo()}_releaseMapInfo(){const t=this._layers;for(let e=0,i=t.length;e<i;e++)t[e].node.removeFromParent(),t[e].node.destroy();t.length=0;const e=this._groups;for(let t=0,i=e.length;t<i;t++)e[t].node.removeFromParent(),e[t].node.destroy();e.length=0;const i=this._images;for(let t=0,e=i.length;t<e;t++)i[t].removeFromParent(),i[t].destroy();i.length=0}_syncAnchorPoint(){const t=this.node._uiProps.uiTransformComp.anchorPoint,e=this.node._uiProps.uiTransformComp.width*t.x,i=this.node._uiProps.uiTransformComp.height*(1-t.y);let n,s;for(n=0,s=this._layers.length;n<s;n++)this._layers[n].node._uiProps.uiTransformComp.setAnchorPoint(t);for(n=0,s=this._groups.length;n<s;n++){const t=this._groups[n],s=t.node._uiProps.uiTransformComp;s.anchorX=.5,s.anchorY=.5;const r=t.offset.x-e+s.width*s.anchorX,o=t.offset.y+i-s.height*s.anchorY;t.node.setPosition(r,o)}for(n=0,s=this._images.length;n<s;n++){const t=this._images[n]._uiProps.uiTransformComp;t.anchorX=.5,t.anchorY=.5;const s=this._images[n]._offset.x-e+t.width*t.anchorX,r=this._images[n]._offset.y+i-t.height*t.anchorY;this._images[n].setPosition(s,r)}}_fillAniGrids(t,e){for(const i of e.keys()){const n=e.get(i);if(!n)continue;const s=n.frames;for(let e=0;e<s.length;e++){const i=s[e];i.grid=t.get(i.tileid)}}}_buildLayerAndGroup(){const t=this._tilesets,e=this._texGrids,i=this._animations;e.clear();for(let i=0,n=t.length;i<n;++i){const n=t[i];n&&(n.sourceImage?O7(n,e,n.sourceImage):console.warn(`Can't find the spriteFrame of tilesets ${i}`))}this._fillAniGrids(e,i);let n=this._layers,s=this._groups,r=this._images;const o={};for(let t=0,e=n.length;t<e;t++)o[n[t].node.name]=!0;for(let t=0,e=s.length;t<e;t++)o[s[t].node.name]=!0;for(let t=0,e=r.length;t<e;t++)o[r[t].name]=!0;n=this._layers=[],s=this._groups=[],r=this._images=[];const a=this._mapInfo,l=this.node,c=a.getAllChildren(),h=this._textures;let _=0,u=0;if(c&&c.length>0)for(let i=0,m=c.length;i<m;i++){const m=c[i],d=m.name;let p=this.node.getChildByName(d);if(o[d]=!1,p||(p=new uf,p.name=d,p.layer=l.layer,l.addChild(p)),p.setSiblingIndex(i),p.active=m.visible,m instanceof d7){let i=p.getComponent(j7);i||(i=p.addComponent(j7)),i.init(m,a,t,h,e),i.enableCulling=this._enableCulling,m.ownTiles=!1,n.push(i)}else if(m instanceof m7){let t=p.getComponent($7);t||(t=p.addComponent($7)),t._init(m,a,e),s.push(t)}else if(m instanceof p7){const t=m.sourceImage;p.layerInfo=m,p._offset=new Ti(m.offset.x,-m.offset.y);let e=p.getComponent(mF);e||(e=p.addComponent(mF)),e.color.a*=m.opacity,e.spriteFrame=t,p._uiProps.uiTransformComp.setContentSize(t.width,t.height),r.push(p)}_=Math.max(_,p._uiProps.uiTransformComp.width),u=Math.max(u,p._uiProps.uiTransformComp.height)}const m=l.children;for(let t=0,e=m.length;t<e;t++){const e=m[t];o[e.name]&&e.destroy()}this.node._uiProps.uiTransformComp.setContentSize(_,u),this._syncAnchorPoint()}_buildWithMapInfo(t){this._mapInfo=t,this._mapSize=t.getMapSize(),this._tileSize=t.getTileSize(),this._mapOrientation=t.orientation,this._properties=t.properties,this._tileProperties=t.getTileProperties(),this._imageLayers=t.getImageLayers(),this._animations=t.getTileAnimations(),this._tilesets=t.getTilesets();const e=this._tilesets;this._textures.length=0;const i=[];for(let t=0,n=e.length;t<n;++t){const n=e[t];n&&n.sourceImage&&(this._textures[t]=n.sourceImage,i.push(n.sourceImage))}for(let t=0;t<this._imageLayers.length;t++){const e=this._imageLayers[t];e&&e.sourceImage&&i.push(e.sourceImage)}N7(i,(()=>{this._buildLayerAndGroup(),this.cleanupImageCache&&this._textures.forEach((t=>{this.doCleanupImageCache(t)}))}))}doCleanupImageCache(t){t._image instanceof HTMLImageElement?(t._image.src="",t._image.destroy()):Cy.capabilities.imageBitmap&&t._image instanceof ImageBitmap&&t._image.close&&t._image.close(),t._image=null}update(t){const e=this._animations,i=this._texGrids;for(const n of e.keys()){const s=e.get(n),r=s.frames;let o=r[s.frameIdx];s.dt+=t,o.duration<s.dt&&(s.dt=0,s.frameIdx++,s.frameIdx>=r.length&&(s.frameIdx=0),o=r[s.frameIdx]),i.set(n,o.grid)}for(const t of this.getLayers())t.hasAnimation()&&t.markForUpdateRenderData()}},P9.Orientation=N8,P9.Property=L8,P9.TileFlag=F8,P9.StaggerAxis=z8,P9.StaggerIndex=V8,P9.TMXObjectType=G8,P9.RenderOrder=U8,T9=n_((b9=I9).prototype,"_tmxFile",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),n_(b9.prototype,"tmxAsset",[S9,A9],Object.getOwnPropertyDescriptor(b9.prototype,"tmxAsset"),b9.prototype),w9=n_(b9.prototype,"_enableCulling",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),n_(b9.prototype,"enableCulling",[w_],Object.getOwnPropertyDescriptor(b9.prototype,"enableCulling"),b9.prototype),E9=n_(b9.prototype,"cleanupImageCache",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),C9=b9))||C9)||C9)||C9)||C9)||C9));const D9=Math.ceil(10922.5),R9=[];for(let t=0;t<4;t++)R9.push(new oi);const M9=new Si,B9=new oi,O9={row:0,col:0};let N9,L9,F9={x:0,y:0},z9={x:0,y:0},V9={x:0,y:0},U9={x:0,y:0},G9=0,H9=0,k9=0,j9=0;const W9={createData(t){const e=t.requestMeshRenderData();return t.rightTop.col*t.rightTop.row*4>65535&&console.error("Vertex count exceeds 65535"),e},updateRenderData(t,e){t.updateCulling();const i=t.requestMeshRenderData();if(k9=t.leftDownToCenterX,j9=t.leftDownToCenterY,N9=i,t.colorChanged||t.isCullingDirty()||t.isUserNodeDirty()||t.hasAnimation()||t.hasTiledNode()){let e,i;if(t.colorChanged=!1,t.destroyRenderData(),t.enableCulling){const n=t.cullingRect;e=n.leftDown,i=n.rightTop}else e=O9,i=t.rightTop;switch(t.renderOrder){case U8.RightDown:Y9(e,i,-1,1,t);break;case U8.LeftDown:Y9(e,i,-1,-1,t);break;case U8.RightUp:Y9(e,i,1,1,t);break;case U8.LeftUp:default:Y9(e,i,1,-1,t)}t.setCullingDirty(!1),t.setUserNodeDirty(!1)}N9=null},updateColor(t){const e=t.color,i=new Float32Array(4);i[0]=e.r/255,i[1]=e.g/255,i[2]=e.b/255,i[0]=e.a/255;const n=t.meshRenderDataArray;if(n)for(const t of n){if(!t.renderData)continue;const e=t.renderData,n=e.vData;for(let t=e.vertexStart,s=e.vertexCount;t<s;t++)n.set(i,9*t+5)}},fillBuffers(t,e){if(!t||!t.meshRenderDataArray)return;const i=t.meshRenderDataArray,n=t.node;let s=e.acquireBufferBatch(),r=s.byteOffset>>2,o=s.indicesOffset,a=s.vertexOffset;const l=i[t._meshRenderDataArrayIdx].renderData;s.request(l.vertexCount,l.indicesCount)||(s=e.currBufferBatch,r=0,o=0,a=0);const c=s.vData,h=s.iData,_=n.worldMatrix,u=l.vData,m=l.vertexStart;c.set(u.slice(m,m+9*l.vertexCount),r);for(let t=0;t<l.vertexCount;t++){const e=r+9*t;B9.set(c[e],c[e+1],c[e+2]),B9.transformMat4(_),c[e]=B9.x,c[e+1]=B9.y,c[e+2]=B9.z}const d=l.vertexCount/4;for(let t=0;t<d;t+=1)h[o]=a,h[o+1]=a+1,h[o+2]=a+2,h[o+3]=a+2,h[o+4]=a+1,h[o+5]=a+3,o+=6,a+=4}};function q9(t,e){let i;t._rotated?(F9.x=t.r,F9.y=t.t,z9.x=t.l,z9.y=t.t,V9.x=t.r,V9.y=t.b,U9.x=t.l,U9.y=t.b):(F9.x=t.l,F9.y=t.t,z9.x=t.l,z9.y=t.b,V9.x=t.r,V9.y=t.t,U9.x=t.r,U9.y=t.b),(e&F8.DIAGONAL)>>>0&&(i=z9,z9=V9,V9=i),(e&F8.HORIZONTAL)>>>0&&(i=F9,F9=V9,V9=i,i=z9,z9=U9,U9=i),(e&F8.VERTICAL)>>>0&&(i=F9,F9=z9,z9=i,i=V9,V9=U9,U9=i)}function X9(t,e,i){t||(t=e.texture),N9.texture||(N9.texture=t),N9=i.requestMeshRenderData(),N9.texture=e.texture}function Y9(t,e,i,n,s){if(!N9||e.row<0||e.col<0)return;N9.renderData||(N9=s.requestMeshRenderData());let r=N9.renderData.vData;G9=0,H9=0;const o=s.tiledTiles,a=s.texGrids,l=s.tiles,c=s.vertices;let h,_,u,m,d,p,f,g,y,v=0,x=0,S=0,A=0,C=0,b=null,T=0,w=!0;L9=q9;const E=new Float32Array(4);for(E[0]=s.color.r/255,E[1]=s.color.g/255,E[2]=s.color.b/255,E[3]=s.color.a/255,-1===i?(m=e.row,d=t.row):(m=t.row,d=e.row);(d-m)*i>=0;m+=i)for(h=c[m],T=s.getNodesCountByRow(m),w=h&&0===T,1===n?(_=w&&t.col<h.minCol?h.minCol:t.col,u=w&&e.col>h.maxCol?h.maxCol:e.col):(_=w&&e.col>h.maxCol?h.maxCol:e.col,u=w&&t.col<h.minCol?h.minCol:t.col);(u-_)*n>=0;_+=n){if(p=h&&h[_],T>0){const t=s.requestSubNodesData(),e=s.getNodesByRowCol(m,_);e&&e.count>0&&(t.subNodes=s.getNodesByRowCol(m,_).list,b=null,N9=s.requestMeshRenderData())}p&&(v=l[p.index],g=a.get((v&F8.FLIPPED_MASK)>>>0),g&&(b!==g.texture&&(X9(b,g,s),b=g.texture),f=g.tileset._tileSize,x=p.left-k9,S=p.bottom-j9,A=x+f.width,C=S+f.height,y=o[p.index],N9.renderData.reserve(4,0),H9=9*N9.renderData.vertexCount,r=N9.renderData.vData,y?y.node.active&&K9(y.node,E,r,x,A,C,S,!1):(r[H9]=x,r[H9+1]=C,r[H9+9]=x,r[H9+9+1]=S,r[H9+18]=A,r[H9+18+1]=C,r[H9+27]=A,r[H9+27+1]=S,r.set(E,H9+5),r.set(E,H9+9+5),r.set(E,H9+18+5),r.set(E,H9+27+5)),L9(g,v),r[H9+3]=F9.x,r[H9+4]=F9.y,r[H9+9+3]=z9.x,r[H9+9+4]=z9.y,r[H9+18+3]=V9.x,r[H9+18+4]=V9.y,r[H9+27+3]=U9.x,r[H9+27+4]=U9.y,G9++,N9.renderData.advance(4,6),G9>=D9&&(X9(b,g,s),b=g.texture)))}}function K9(t,e,i,n,s,r,o,a){const l=18,c=27;t.updateWorldTransform(),Si.copy(M9,t.matrix),oi.set(B9,-(n+k9),-(o+j9),0),Si.transform(M9,M9,B9);const h=M9,_=h.m12,u=h.m13,m=h.m00,d=h.m01,p=h.m04,f=h.m05,g=1===m&&0===d&&0===p&&1===f;if(a){const t=(n+s)/2,e=(r+o)/2;g?(i[H9]=t+_,i[H9+1]=r+u,i[H9+9]=n+_,i[H9+9+1]=e+u,i[H9+l]=s+_,i[H9+l+1]=e+u,i[H9+c]=t+_,i[H9+c+1]=o+u):(i[H9]=t*m+r*p+_,i[H9+1]=t*d+r*f+u,i[H9+9]=n*m+e*p+_,i[H9+9+1]=n*d+e*f+u,i[H9+l]=s*m+e*p+_,i[H9+l+1]=s*d+e*f+u,i[H9+c]=t*m+o*p+_,i[H9+c+1]=t*d+o*f+u)}else g?(i[H9]=n+_,i[H9+1]=r+u,i[H9+9]=n+_,i[H9+9+1]=o+u,i[H9+l]=s+_,i[H9+l+1]=r+u,i[H9+c]=s+_,i[H9+c+1]=o+u):(i[H9]=n*m+r*p+_,i[H9+1]=n*d+r*f+u,i[H9+9]=n*m+o*p+_,i[H9+9+1]=n*d+o*f+u,i[H9+l]=s*m+r*p+_,i[H9+l+1]=s*d+r*f+u,i[H9+c]=s*m+o*p+_,i[H9+c+1]=s*d+o*f+u);i.set(e,H9+5),i.set(e,H9+9+5),i.set(e,H9+l+5),i.set(e,H9+c+5)}const J9=t("tiledLayerAssembler",{getAssembler:()=>W9});j7.Assembler=J9;class $9{constructor(){this.start=void 0,this.interrupt=void 0,this.end=void 0,this.dispose=void 0,this.complete=void 0,this.event=void 0}static getListeners(t){return t.listener||(t.listener=new $9),t.listener}}var Z9,Q9,ttt=(Z9=function(t,e){return(Z9=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}Z9(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});!function(t){var e,i,n,s=function(){function t(t,e,i){if(null==t)throw new Error("name cannot be null.");if(null==e)throw new Error("timelines cannot be null.");this.name=t,this.timelines=e,this.timelineIds=[];for(var n=0;n<e.length;n++)this.timelineIds[e[n].getPropertyId()]=!0;this.duration=i}return t.prototype.hasTimeline=function(t){return 1==this.timelineIds[t]},t.prototype.apply=function(t,e,i,n,s,r,o,a){if(null==t)throw new Error("skeleton cannot be null.");n&&0!=this.duration&&(i%=this.duration,e>0&&(e%=this.duration));for(var l=this.timelines,c=0,h=l.length;c<h;c++)l[c].apply(t,e,i,s,r,o,a)},t.binarySearch=function(t,e,i){void 0===i&&(i=1);var n=0,s=t.length/i-2;if(0==s)return i;for(var r=s>>>1;;){if(t[(r+1)*i]<=e?n=r+1:s=r,n==s)return(n+1)*i;r=n+s>>>1}},t.linearSearch=function(t,e,i){for(var n=0,s=t.length-i;n<=s;n+=i)if(t[n]>e)return n;return-1},t}();t.Animation=s,function(t){t[t.setup=0]="setup",t[t.first=1]="first",t[t.replace=2]="replace",t[t.add=3]="add"}(e=t.MixBlend||(t.MixBlend={})),function(t){t[t.mixIn=0]="mixIn",t[t.mixOut=1]="mixOut"}(i=t.MixDirection||(t.MixDirection={})),function(t){t[t.rotate=0]="rotate",t[t.translate=1]="translate",t[t.scale=2]="scale",t[t.shear=3]="shear",t[t.attachment=4]="attachment",t[t.color=5]="color",t[t.deform=6]="deform",t[t.event=7]="event",t[t.drawOrder=8]="drawOrder",t[t.ikConstraint=9]="ikConstraint",t[t.transformConstraint=10]="transformConstraint",t[t.pathConstraintPosition=11]="pathConstraintPosition",t[t.pathConstraintSpacing=12]="pathConstraintSpacing",t[t.pathConstraintMix=13]="pathConstraintMix",t[t.twoColor=14]="twoColor"}(n=t.TimelineType||(t.TimelineType={}));var r=function(){function e(i){if(i<=0)throw new Error("frameCount must be > 0: "+i);this.curves=t.Utils.newFloatArray((i-1)*e.BEZIER_SIZE)}return e.prototype.getFrameCount=function(){return this.curves.length/e.BEZIER_SIZE+1},e.prototype.setLinear=function(t){this.curves[t*e.BEZIER_SIZE]=e.LINEAR},e.prototype.setStepped=function(t){this.curves[t*e.BEZIER_SIZE]=e.STEPPED},e.prototype.getCurveType=function(t){var i=t*e.BEZIER_SIZE;if(i==this.curves.length)return e.LINEAR;var n=this.curves[i];return n==e.LINEAR?e.LINEAR:n==e.STEPPED?e.STEPPED:e.BEZIER},e.prototype.setCurve=function(t,i,n,s,r){var o=.03*(2*-i+s),a=.03*(2*-n+r),l=.006*(3*(i-s)+1),c=.006*(3*(n-r)+1),h=2*o+l,_=2*a+c,u=.3*i+o+.16666667*l,m=.3*n+a+.16666667*c,d=t*e.BEZIER_SIZE,p=this.curves;p[d++]=e.BEZIER;for(var f=u,g=m,y=d+e.BEZIER_SIZE-1;d<y;d+=2)p[d]=f,p[d+1]=g,u+=h,m+=_,h+=l,_+=c,f+=u,g+=m},e.prototype.getCurvePercent=function(i,n){n=t.MathUtils.clamp(n,0,1);var s=this.curves,r=i*e.BEZIER_SIZE,o=s[r];if(o==e.LINEAR)return n;if(o==e.STEPPED)return 0;for(var a=0,l=++r,c=r+e.BEZIER_SIZE-1;r<c;r+=2)if((a=s[r])>=n){var h=void 0,_=void 0;return r==l?(h=0,_=0):(h=s[r-2],_=s[r-1]),_+(s[r+1]-_)*(n-h)/(a-h)}var u=s[r-1];return u+(1-u)*(n-a)/(1-a)},e.LINEAR=0,e.STEPPED=1,e.BEZIER=2,e.BEZIER_SIZE=19,e}();t.CurveTimeline=r;var o=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e<<1),n}return ttt(r,i),r.prototype.getPropertyId=function(){return(n.rotate<<24)+this.boneIndex},r.prototype.setFrame=function(t,e,i){t<<=1,this.frames[t]=e,this.frames[t+r.ROTATION]=i},r.prototype.apply=function(t,i,n,o,a,l){var c=this.frames,h=t.bones[this.boneIndex];if(h.active)if(n<c[0])switch(l){case e.setup:return void(h.rotation=h.data.rotation);case e.first:var _=h.data.rotation-h.rotation;h.rotation+=(_-360*(16384-(16384.499999999996-_/360|0)))*a}else if(n>=c[c.length-r.ENTRIES]){var u=c[c.length+r.PREV_ROTATION];switch(l){case e.setup:h.rotation=h.data.rotation+u*a;break;case e.first:case e.replace:u+=h.data.rotation-h.rotation,u-=360*(16384-(16384.499999999996-u/360|0));case e.add:h.rotation+=u*a}}else{var m=s.binarySearch(c,n,r.ENTRIES),d=c[m+r.PREV_ROTATION],p=c[m],f=this.getCurvePercent((m>>1)-1,1-(n-p)/(c[m+r.PREV_TIME]-p)),g=c[m+r.ROTATION]-d;switch(g=d+(g-360*(16384-(16384.499999999996-g/360|0)))*f,l){case e.setup:h.rotation=h.data.rotation+(g-360*(16384-(16384.499999999996-g/360|0)))*a;break;case e.first:case e.replace:g+=h.data.rotation-h.rotation;case e.add:h.rotation+=(g-360*(16384-(16384.499999999996-g/360|0)))*a}}},r.ENTRIES=2,r.PREV_TIME=-2,r.PREV_ROTATION=-1,r.ROTATION=1,r}(r);t.RotateTimeline=o;var a=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return ttt(r,i),r.prototype.getPropertyId=function(){return(n.translate<<24)+this.boneIndex},r.prototype.setFrame=function(t,e,i,n){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.X]=i,this.frames[t+r.Y]=n},r.prototype.apply=function(t,i,n,o,a,l){var c=this.frames,h=t.bones[this.boneIndex];if(h.active)if(n<c[0])switch(l){case e.setup:return h.x=h.data.x,void(h.y=h.data.y);case e.first:h.x+=(h.data.x-h.x)*a,h.y+=(h.data.y-h.y)*a}else{var _=0,u=0;if(n>=c[c.length-r.ENTRIES])_=c[c.length+r.PREV_X],u=c[c.length+r.PREV_Y];else{var m=s.binarySearch(c,n,r.ENTRIES);_=c[m+r.PREV_X],u=c[m+r.PREV_Y];var d=c[m],p=this.getCurvePercent(m/r.ENTRIES-1,1-(n-d)/(c[m+r.PREV_TIME]-d));_+=(c[m+r.X]-_)*p,u+=(c[m+r.Y]-u)*p}switch(l){case e.setup:h.x=h.data.x+_*a,h.y=h.data.y+u*a;break;case e.first:case e.replace:h.x+=(h.data.x+_-h.x)*a,h.y+=(h.data.y+u-h.y)*a;break;case e.add:h.x+=_*a,h.y+=u*a}}},r.ENTRIES=3,r.PREV_TIME=-3,r.PREV_X=-2,r.PREV_Y=-1,r.X=1,r.Y=2,r}(r);t.TranslateTimeline=a;var l=function(r){function o(t){return r.call(this,t)||this}return ttt(o,r),o.prototype.getPropertyId=function(){return(n.scale<<24)+this.boneIndex},o.prototype.apply=function(n,r,a,l,c,h,_){var u=this.frames,m=n.bones[this.boneIndex];if(m.active)if(a<u[0])switch(h){case e.setup:return m.scaleX=m.data.scaleX,void(m.scaleY=m.data.scaleY);case e.first:m.scaleX+=(m.data.scaleX-m.scaleX)*c,m.scaleY+=(m.data.scaleY-m.scaleY)*c}else{var d=0,p=0;if(a>=u[u.length-o.ENTRIES])d=u[u.length+o.PREV_X]*m.data.scaleX,p=u[u.length+o.PREV_Y]*m.data.scaleY;else{var f=s.binarySearch(u,a,o.ENTRIES);d=u[f+o.PREV_X],p=u[f+o.PREV_Y];var g=u[f],y=this.getCurvePercent(f/o.ENTRIES-1,1-(a-g)/(u[f+o.PREV_TIME]-g));d=(d+(u[f+o.X]-d)*y)*m.data.scaleX,p=(p+(u[f+o.Y]-p)*y)*m.data.scaleY}if(1==c)h==e.add?(m.scaleX+=d-m.data.scaleX,m.scaleY+=p-m.data.scaleY):(m.scaleX=d,m.scaleY=p);else{var v=0,x=0;if(_==i.mixOut)switch(h){case e.setup:v=m.data.scaleX,x=m.data.scaleY,m.scaleX=v+(Math.abs(d)*t.MathUtils.signum(v)-v)*c,m.scaleY=x+(Math.abs(p)*t.MathUtils.signum(x)-x)*c;break;case e.first:case e.replace:v=m.scaleX,x=m.scaleY,m.scaleX=v+(Math.abs(d)*t.MathUtils.signum(v)-v)*c,m.scaleY=x+(Math.abs(p)*t.MathUtils.signum(x)-x)*c;break;case e.add:v=m.scaleX,x=m.scaleY,m.scaleX=v+(Math.abs(d)*t.MathUtils.signum(v)-m.data.scaleX)*c,m.scaleY=x+(Math.abs(p)*t.MathUtils.signum(x)-m.data.scaleY)*c}else switch(h){case e.setup:v=Math.abs(m.data.scaleX)*t.MathUtils.signum(d),x=Math.abs(m.data.scaleY)*t.MathUtils.signum(p),m.scaleX=v+(d-v)*c,m.scaleY=x+(p-x)*c;break;case e.first:case e.replace:v=Math.abs(m.scaleX)*t.MathUtils.signum(d),x=Math.abs(m.scaleY)*t.MathUtils.signum(p),m.scaleX=v+(d-v)*c,m.scaleY=x+(p-x)*c;break;case e.add:v=t.MathUtils.signum(d),x=t.MathUtils.signum(p),m.scaleX=Math.abs(m.scaleX)*v+(d-Math.abs(m.data.scaleX)*v)*c,m.scaleY=Math.abs(m.scaleY)*x+(p-Math.abs(m.data.scaleY)*x)*c}}}},o}(a);t.ScaleTimeline=l;var c=function(t){function i(e){return t.call(this,e)||this}return ttt(i,t),i.prototype.getPropertyId=function(){return(n.shear<<24)+this.boneIndex},i.prototype.apply=function(t,n,r,o,a,l){var c=this.frames,h=t.bones[this.boneIndex];if(h.active)if(r<c[0])switch(l){case e.setup:return h.shearX=h.data.shearX,void(h.shearY=h.data.shearY);case e.first:h.shearX+=(h.data.shearX-h.shearX)*a,h.shearY+=(h.data.shearY-h.shearY)*a}else{var _=0,u=0;if(r>=c[c.length-i.ENTRIES])_=c[c.length+i.PREV_X],u=c[c.length+i.PREV_Y];else{var m=s.binarySearch(c,r,i.ENTRIES);_=c[m+i.PREV_X],u=c[m+i.PREV_Y];var d=c[m],p=this.getCurvePercent(m/i.ENTRIES-1,1-(r-d)/(c[m+i.PREV_TIME]-d));_+=(c[m+i.X]-_)*p,u+=(c[m+i.Y]-u)*p}switch(l){case e.setup:h.shearX=h.data.shearX+_*a,h.shearY=h.data.shearY+u*a;break;case e.first:case e.replace:h.shearX+=(h.data.shearX+_-h.shearX)*a,h.shearY+=(h.data.shearY+u-h.shearY)*a;break;case e.add:h.shearX+=_*a,h.shearY+=u*a}}},i}(a);t.ShearTimeline=c;var h=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return ttt(r,i),r.prototype.getPropertyId=function(){return(n.color<<24)+this.slotIndex},r.prototype.setFrame=function(t,e,i,n,s,o){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.R]=i,this.frames[t+r.G]=n,this.frames[t+r.B]=s,this.frames[t+r.A]=o},r.prototype.apply=function(t,i,n,o,a,l){var c=t.slots[this.slotIndex];if(c.bone.active){var h=this.frames;if(n<h[0])switch(l){case e.setup:return void c.color.setFromColor(c.data.color);case e.first:var _=c.color,u=c.data.color;_.add((u.r-_.r)*a,(u.g-_.g)*a,(u.b-_.b)*a,(u.a-_.a)*a)}else{var m=0,d=0,p=0,f=0;if(n>=h[h.length-r.ENTRIES]){var g=h.length;m=h[g+r.PREV_R],d=h[g+r.PREV_G],p=h[g+r.PREV_B],f=h[g+r.PREV_A]}else{var y=s.binarySearch(h,n,r.ENTRIES);m=h[y+r.PREV_R],d=h[y+r.PREV_G],p=h[y+r.PREV_B],f=h[y+r.PREV_A];var v=h[y],x=this.getCurvePercent(y/r.ENTRIES-1,1-(n-v)/(h[y+r.PREV_TIME]-v));m+=(h[y+r.R]-m)*x,d+=(h[y+r.G]-d)*x,p+=(h[y+r.B]-p)*x,f+=(h[y+r.A]-f)*x}1==a?c.color.set(m,d,p,f):(_=c.color,l==e.setup&&_.setFromColor(c.data.color),_.add((m-_.r)*a,(d-_.g)*a,(p-_.b)*a,(f-_.a)*a))}}},r.ENTRIES=5,r.PREV_TIME=-5,r.PREV_R=-4,r.PREV_G=-3,r.PREV_B=-2,r.PREV_A=-1,r.R=1,r.G=2,r.B=3,r.A=4,r}(r);t.ColorTimeline=h;var _=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return ttt(r,i),r.prototype.getPropertyId=function(){return(n.twoColor<<24)+this.slotIndex},r.prototype.setFrame=function(t,e,i,n,s,o,a,l,c){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.R]=i,this.frames[t+r.G]=n,this.frames[t+r.B]=s,this.frames[t+r.A]=o,this.frames[t+r.R2]=a,this.frames[t+r.G2]=l,this.frames[t+r.B2]=c},r.prototype.apply=function(t,i,n,o,a,l){var c=t.slots[this.slotIndex];if(c.bone.active){var h=this.frames;if(n<h[0])switch(l){case e.setup:return c.color.setFromColor(c.data.color),void c.darkColor.setFromColor(c.data.darkColor);case e.first:var _=c.color,u=c.darkColor,m=c.data.color,d=c.data.darkColor;_.add((m.r-_.r)*a,(m.g-_.g)*a,(m.b-_.b)*a,(m.a-_.a)*a),u.add((d.r-u.r)*a,(d.g-u.g)*a,(d.b-u.b)*a,0)}else{var p=0,f=0,g=0,y=0,v=0,x=0,S=0;if(n>=h[h.length-r.ENTRIES]){var A=h.length;p=h[A+r.PREV_R],f=h[A+r.PREV_G],g=h[A+r.PREV_B],y=h[A+r.PREV_A],v=h[A+r.PREV_R2],x=h[A+r.PREV_G2],S=h[A+r.PREV_B2]}else{var C=s.binarySearch(h,n,r.ENTRIES);p=h[C+r.PREV_R],f=h[C+r.PREV_G],g=h[C+r.PREV_B],y=h[C+r.PREV_A],v=h[C+r.PREV_R2],x=h[C+r.PREV_G2],S=h[C+r.PREV_B2];var b=h[C],T=this.getCurvePercent(C/r.ENTRIES-1,1-(n-b)/(h[C+r.PREV_TIME]-b));p+=(h[C+r.R]-p)*T,f+=(h[C+r.G]-f)*T,g+=(h[C+r.B]-g)*T,y+=(h[C+r.A]-y)*T,v+=(h[C+r.R2]-v)*T,x+=(h[C+r.G2]-x)*T,S+=(h[C+r.B2]-S)*T}1==a?(c.color.set(p,f,g,y),c.darkColor.set(v,x,S,1)):(_=c.color,u=c.darkColor,l==e.setup&&(_.setFromColor(c.data.color),u.setFromColor(c.data.darkColor)),_.add((p-_.r)*a,(f-_.g)*a,(g-_.b)*a,(y-_.a)*a),u.add((v-u.r)*a,(x-u.g)*a,(S-u.b)*a,0))}}},r.ENTRIES=8,r.PREV_TIME=-8,r.PREV_R=-7,r.PREV_G=-6,r.PREV_B=-5,r.PREV_A=-4,r.PREV_R2=-3,r.PREV_G2=-2,r.PREV_B2=-1,r.R=1,r.G=2,r.B=3,r.A=4,r.R2=5,r.G2=6,r.B2=7,r}(r);t.TwoColorTimeline=_;var u=function(){function r(e){this.frames=t.Utils.newFloatArray(e),this.attachmentNames=new Array(e)}return r.prototype.getPropertyId=function(){return(n.attachment<<24)+this.slotIndex},r.prototype.getFrameCount=function(){return this.frames.length},r.prototype.setFrame=function(t,e,i){this.frames[t]=e,this.attachmentNames[t]=i},r.prototype.apply=function(t,n,r,o,a,l,c){var h=t.slots[this.slotIndex];if(h.bone.active)if(c!=i.mixOut||l!=e.setup){var _=this.frames;if(r<_[0]){if(l==e.setup||l==e.first){var u=h.data.attachmentName;h.setAttachment(null==u?null:t.getAttachment(this.slotIndex,u))}}else{var m;m=r>=_[_.length-1]?_.length-1:s.binarySearch(_,r,1)-1;var d=this.attachmentNames[m];t.slots[this.slotIndex].setAttachment(null==d?null:t.getAttachment(this.slotIndex,d))}}else{var p=h.data.attachmentName;h.setAttachment(null==p?null:t.getAttachment(this.slotIndex,p))}},r}();t.AttachmentTimeline=u;var m=null,d=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e),n.frameVertices=new Array(e),null==m&&(m=t.Utils.newFloatArray(64)),n}return ttt(r,i),r.prototype.getPropertyId=function(){return(n.deform<<27)+ +this.attachment.id+this.slotIndex},r.prototype.setFrame=function(t,e,i){this.frames[t]=e,this.frameVertices[t]=i},r.prototype.apply=function(i,n,r,o,a,l){var c=i.slots[this.slotIndex];if(c.bone.active){var h=c.getAttachment();if(h instanceof t.VertexAttachment&&h.deformAttachment==this.attachment){var _=c.deform;0==_.length&&(l=e.setup);var u=this.frameVertices,m=u[0].length,d=this.frames;if(r<d[0]){var p=h;switch(l){case e.setup:return void(_.length=0);case e.first:if(1==a){_.length=0;break}var f=t.Utils.setArraySize(_,m);if(null==p.bones)for(var g=p.vertices,y=0;y<m;y++)f[y]+=(g[y]-f[y])*a;else for(a=1-a,y=0;y<m;y++)f[y]*=a}}else{var v=t.Utils.setArraySize(_,m);if(r>=d[d.length-1]){var x=u[d.length-1];if(1==a)if(l==e.add)if(null==(p=h).bones){g=p.vertices;for(var S=0;S<m;S++)v[S]+=x[S]-g[S]}else for(var A=0;A<m;A++)v[A]+=x[A];else t.Utils.arrayCopy(x,0,v,0,m);else switch(l){case e.setup:var C=h;if(null==C.bones){g=C.vertices;for(var b=0;b<m;b++){var T=g[b];v[b]=T+(x[b]-T)*a}}else for(var w=0;w<m;w++)v[w]=x[w]*a;break;case e.first:case e.replace:for(var E=0;E<m;E++)v[E]+=(x[E]-v[E])*a;case e.add:if(null==(p=h).bones){g=p.vertices;for(var P=0;P<m;P++)v[P]+=(x[P]-g[P])*a}else for(var I=0;I<m;I++)v[I]+=x[I]*a}}else{var D=s.binarySearch(d,r),R=u[D-1],M=u[D],B=d[D],O=this.getCurvePercent(D-1,1-(r-B)/(d[D-1]-B));if(1==a)if(l==e.add)if(null==(p=h).bones){g=p.vertices;for(var N=0;N<m;N++){var L=R[N];v[N]+=L+(M[N]-L)*O-g[N]}}else for(var F=0;F<m;F++)L=R[F],v[F]+=L+(M[F]-L)*O;else for(var z=0;z<m;z++)L=R[z],v[z]=L+(M[z]-L)*O;else switch(l){case e.setup:var V=h;if(null==V.bones){g=V.vertices;for(var U=0;U<m;U++)L=R[U],T=g[U],v[U]=T+(L+(M[U]-L)*O-T)*a}else for(var G=0;G<m;G++)L=R[G],v[G]=(L+(M[G]-L)*O)*a;break;case e.first:case e.replace:for(var H=0;H<m;H++)L=R[H],v[H]+=(L+(M[H]-L)*O-v[H])*a;break;case e.add:if(null==(p=h).bones){g=p.vertices;for(var k=0;k<m;k++)L=R[k],v[k]+=(L+(M[k]-L)*O-g[k])*a}else for(var j=0;j<m;j++)L=R[j],v[j]+=(L+(M[j]-L)*O)*a}}}}}},r}(r);t.DeformTimeline=d;var p=function(){function e(e){this.frames=t.Utils.newFloatArray(e),this.events=new Array(e)}return e.prototype.getPropertyId=function(){return n.event<<24},e.prototype.getFrameCount=function(){return this.frames.length},e.prototype.setFrame=function(t,e){this.frames[t]=e.time,this.events[t]=e},e.prototype.apply=function(t,e,i,n,r,o,a){if(null!=n){var l=this.frames,c=this.frames.length;if(e>i)this.apply(t,e,Number.MAX_VALUE,n,r,o,a),e=-1;else if(e>=l[c-1])return;if(!(i<l[0])){var h=0;if(e<l[0])h=0;else for(var _=l[h=s.binarySearch(l,e)];h>0&&l[h-1]==_;)h--;for(;h<c&&i>=l[h];h++)n.push(this.events[h])}}},e}();t.EventTimeline=p;var f=function(){function r(e){this.frames=t.Utils.newFloatArray(e),this.drawOrders=new Array(e)}return r.prototype.getPropertyId=function(){return n.drawOrder<<24},r.prototype.getFrameCount=function(){return this.frames.length},r.prototype.setFrame=function(t,e,i){this.frames[t]=e,this.drawOrders[t]=i},r.prototype.apply=function(n,r,o,a,l,c,h){var _=n.drawOrder,u=n.slots;if(h!=i.mixOut||c!=e.setup){var m=this.frames;if(o<m[0])c!=e.setup&&c!=e.first||t.Utils.arrayCopy(n.slots,0,n.drawOrder,0,n.slots.length);else{var d;d=o>=m[m.length-1]?m.length-1:s.binarySearch(m,o)-1;var p=this.drawOrders[d];if(null==p)t.Utils.arrayCopy(u,0,_,0,u.length);else for(var f=0,g=p.length;f<g;f++)_[f]=u[p[f]]}}else t.Utils.arrayCopy(n.slots,0,n.drawOrder,0,n.slots.length)},r}();t.DrawOrderTimeline=f;var g=function(r){function o(e){var i=r.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return ttt(o,r),o.prototype.getPropertyId=function(){return(n.ikConstraint<<24)+this.ikConstraintIndex},o.prototype.setFrame=function(t,e,i,n,s,r,a){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.MIX]=i,this.frames[t+o.SOFTNESS]=n,this.frames[t+o.BEND_DIRECTION]=s,this.frames[t+o.COMPRESS]=r?1:0,this.frames[t+o.STRETCH]=a?1:0},o.prototype.apply=function(t,n,r,a,l,c,h){var _=this.frames,u=t.ikConstraints[this.ikConstraintIndex];if(u.active)if(r<_[0])switch(c){case e.setup:return u.mix=u.data.mix,u.softness=u.data.softness,u.bendDirection=u.data.bendDirection,u.compress=u.data.compress,void(u.stretch=u.data.stretch);case e.first:u.mix+=(u.data.mix-u.mix)*l,u.softness+=(u.data.softness-u.softness)*l,u.bendDirection=u.data.bendDirection,u.compress=u.data.compress,u.stretch=u.data.stretch}else if(r>=_[_.length-o.ENTRIES])c==e.setup?(u.mix=u.data.mix+(_[_.length+o.PREV_MIX]-u.data.mix)*l,u.softness=u.data.softness+(_[_.length+o.PREV_SOFTNESS]-u.data.softness)*l,h==i.mixOut?(u.bendDirection=u.data.bendDirection,u.compress=u.data.compress,u.stretch=u.data.stretch):(u.bendDirection=_[_.length+o.PREV_BEND_DIRECTION],u.compress=0!=_[_.length+o.PREV_COMPRESS],u.stretch=0!=_[_.length+o.PREV_STRETCH])):(u.mix+=(_[_.length+o.PREV_MIX]-u.mix)*l,u.softness+=(_[_.length+o.PREV_SOFTNESS]-u.softness)*l,h==i.mixIn&&(u.bendDirection=_[_.length+o.PREV_BEND_DIRECTION],u.compress=0!=_[_.length+o.PREV_COMPRESS],u.stretch=0!=_[_.length+o.PREV_STRETCH]));else{var m=s.binarySearch(_,r,o.ENTRIES),d=_[m+o.PREV_MIX],p=_[m+o.PREV_SOFTNESS],f=_[m],g=this.getCurvePercent(m/o.ENTRIES-1,1-(r-f)/(_[m+o.PREV_TIME]-f));c==e.setup?(u.mix=u.data.mix+(d+(_[m+o.MIX]-d)*g-u.data.mix)*l,u.softness=u.data.softness+(p+(_[m+o.SOFTNESS]-p)*g-u.data.softness)*l,h==i.mixOut?(u.bendDirection=u.data.bendDirection,u.compress=u.data.compress,u.stretch=u.data.stretch):(u.bendDirection=_[m+o.PREV_BEND_DIRECTION],u.compress=0!=_[m+o.PREV_COMPRESS],u.stretch=0!=_[m+o.PREV_STRETCH])):(u.mix+=(d+(_[m+o.MIX]-d)*g-u.mix)*l,u.softness+=(p+(_[m+o.SOFTNESS]-p)*g-u.softness)*l,h==i.mixIn&&(u.bendDirection=_[m+o.PREV_BEND_DIRECTION],u.compress=0!=_[m+o.PREV_COMPRESS],u.stretch=0!=_[m+o.PREV_STRETCH]))}},o.ENTRIES=6,o.PREV_TIME=-6,o.PREV_MIX=-5,o.PREV_SOFTNESS=-4,o.PREV_BEND_DIRECTION=-3,o.PREV_COMPRESS=-2,o.PREV_STRETCH=-1,o.MIX=1,o.SOFTNESS=2,o.BEND_DIRECTION=3,o.COMPRESS=4,o.STRETCH=5,o}(r);t.IkConstraintTimeline=g;var y=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return ttt(r,i),r.prototype.getPropertyId=function(){return(n.transformConstraint<<24)+this.transformConstraintIndex},r.prototype.setFrame=function(t,e,i,n,s,o){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.ROTATE]=i,this.frames[t+r.TRANSLATE]=n,this.frames[t+r.SCALE]=s,this.frames[t+r.SHEAR]=o},r.prototype.apply=function(t,i,n,o,a,l){var c=this.frames,h=t.transformConstraints[this.transformConstraintIndex];if(h.active)if(n<c[0]){var _=h.data;switch(l){case e.setup:return h.rotateMix=_.rotateMix,h.translateMix=_.translateMix,h.scaleMix=_.scaleMix,void(h.shearMix=_.shearMix);case e.first:h.rotateMix+=(_.rotateMix-h.rotateMix)*a,h.translateMix+=(_.translateMix-h.translateMix)*a,h.scaleMix+=(_.scaleMix-h.scaleMix)*a,h.shearMix+=(_.shearMix-h.shearMix)*a}}else{var u=0,m=0,d=0,p=0;if(n>=c[c.length-r.ENTRIES]){var f=c.length;u=c[f+r.PREV_ROTATE],m=c[f+r.PREV_TRANSLATE],d=c[f+r.PREV_SCALE],p=c[f+r.PREV_SHEAR]}else{var g=s.binarySearch(c,n,r.ENTRIES);u=c[g+r.PREV_ROTATE],m=c[g+r.PREV_TRANSLATE],d=c[g+r.PREV_SCALE],p=c[g+r.PREV_SHEAR];var y=c[g],v=this.getCurvePercent(g/r.ENTRIES-1,1-(n-y)/(c[g+r.PREV_TIME]-y));u+=(c[g+r.ROTATE]-u)*v,m+=(c[g+r.TRANSLATE]-m)*v,d+=(c[g+r.SCALE]-d)*v,p+=(c[g+r.SHEAR]-p)*v}l==e.setup?(_=h.data,h.rotateMix=_.rotateMix+(u-_.rotateMix)*a,h.translateMix=_.translateMix+(m-_.translateMix)*a,h.scaleMix=_.scaleMix+(d-_.scaleMix)*a,h.shearMix=_.shearMix+(p-_.shearMix)*a):(h.rotateMix+=(u-h.rotateMix)*a,h.translateMix+=(m-h.translateMix)*a,h.scaleMix+=(d-h.scaleMix)*a,h.shearMix+=(p-h.shearMix)*a)}},r.ENTRIES=5,r.PREV_TIME=-5,r.PREV_ROTATE=-4,r.PREV_TRANSLATE=-3,r.PREV_SCALE=-2,r.PREV_SHEAR=-1,r.ROTATE=1,r.TRANSLATE=2,r.SCALE=3,r.SHEAR=4,r}(r);t.TransformConstraintTimeline=y;var v=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return ttt(r,i),r.prototype.getPropertyId=function(){return(n.pathConstraintPosition<<24)+this.pathConstraintIndex},r.prototype.setFrame=function(t,e,i){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.VALUE]=i},r.prototype.apply=function(t,i,n,o,a,l){var c=this.frames,h=t.pathConstraints[this.pathConstraintIndex];if(h.active)if(n<c[0])switch(l){case e.setup:return void(h.position=h.data.position);case e.first:h.position+=(h.data.position-h.position)*a}else{var _=0;if(n>=c[c.length-r.ENTRIES])_=c[c.length+r.PREV_VALUE];else{var u=s.binarySearch(c,n,r.ENTRIES);_=c[u+r.PREV_VALUE];var m=c[u],d=this.getCurvePercent(u/r.ENTRIES-1,1-(n-m)/(c[u+r.PREV_TIME]-m));_+=(c[u+r.VALUE]-_)*d}l==e.setup?h.position=h.data.position+(_-h.data.position)*a:h.position+=(_-h.position)*a}},r.ENTRIES=2,r.PREV_TIME=-2,r.PREV_VALUE=-1,r.VALUE=1,r}(r);t.PathConstraintPositionTimeline=v;var x=function(t){function i(e){return t.call(this,e)||this}return ttt(i,t),i.prototype.getPropertyId=function(){return(n.pathConstraintSpacing<<24)+this.pathConstraintIndex},i.prototype.apply=function(t,n,r,o,a,l){var c=this.frames,h=t.pathConstraints[this.pathConstraintIndex];if(h.active)if(r<c[0])switch(l){case e.setup:return void(h.spacing=h.data.spacing);case e.first:h.spacing+=(h.data.spacing-h.spacing)*a}else{var _=0;if(r>=c[c.length-i.ENTRIES])_=c[c.length+i.PREV_VALUE];else{var u=s.binarySearch(c,r,i.ENTRIES);_=c[u+i.PREV_VALUE];var m=c[u],d=this.getCurvePercent(u/i.ENTRIES-1,1-(r-m)/(c[u+i.PREV_TIME]-m));_+=(c[u+i.VALUE]-_)*d}l==e.setup?h.spacing=h.data.spacing+(_-h.data.spacing)*a:h.spacing+=(_-h.spacing)*a}},i}(v);t.PathConstraintSpacingTimeline=x;var S=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return ttt(r,i),r.prototype.getPropertyId=function(){return(n.pathConstraintMix<<24)+this.pathConstraintIndex},r.prototype.setFrame=function(t,e,i,n){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.ROTATE]=i,this.frames[t+r.TRANSLATE]=n},r.prototype.apply=function(t,i,n,o,a,l){var c=this.frames,h=t.pathConstraints[this.pathConstraintIndex];if(h.active)if(n<c[0])switch(l){case e.setup:return h.rotateMix=h.data.rotateMix,void(h.translateMix=h.data.translateMix);case e.first:h.rotateMix+=(h.data.rotateMix-h.rotateMix)*a,h.translateMix+=(h.data.translateMix-h.translateMix)*a}else{var _=0,u=0;if(n>=c[c.length-r.ENTRIES])_=c[c.length+r.PREV_ROTATE],u=c[c.length+r.PREV_TRANSLATE];else{var m=s.binarySearch(c,n,r.ENTRIES);_=c[m+r.PREV_ROTATE],u=c[m+r.PREV_TRANSLATE];var d=c[m],p=this.getCurvePercent(m/r.ENTRIES-1,1-(n-d)/(c[m+r.PREV_TIME]-d));_+=(c[m+r.ROTATE]-_)*p,u+=(c[m+r.TRANSLATE]-u)*p}l==e.setup?(h.rotateMix=h.data.rotateMix+(_-h.data.rotateMix)*a,h.translateMix=h.data.translateMix+(u-h.data.translateMix)*a):(h.rotateMix+=(_-h.rotateMix)*a,h.translateMix+=(u-h.translateMix)*a)}},r.ENTRIES=3,r.PREV_TIME=-3,r.PREV_ROTATE=-2,r.PREV_TRANSLATE=-1,r.ROTATE=1,r.TRANSLATE=2,r}(r);t.PathConstraintMixTimeline=S}(Q9||(Q9={})),function(t){var e=function(){function e(e){this.tracks=new Array,this.timeScale=1,this.events=new Array,this.listeners=new Array,this.queue=new s(this),this.propertyIDs=new t.IntSet,this.animationsChanged=!1,this.trackEntryPool=new t.Pool((function(){return new i})),this.data=e}return e.prototype.update=function(t){t*=this.timeScale;for(var e=this.tracks,i=0,n=e.length;i<n;i++){var s=e[i];if(null!=s){s.animationLast=s.nextAnimationLast,s.trackLast=s.nextTrackLast;var r=t*s.timeScale;if(s.delay>0){if(s.delay-=r,s.delay>0)continue;r=-s.delay,s.delay=0}var o=s.next;if(null!=o){var a=s.trackLast-o.delay;if(a>=0){for(o.delay=0,o.trackTime+=0==s.timeScale?0:(a/s.timeScale+t)*o.timeScale,s.trackTime+=r,this.setCurrent(i,o,!0);null!=o.mixingFrom;)o.mixTime+=t,o=o.mixingFrom;continue}}else if(s.trackLast>=s.trackEnd&&null==s.mixingFrom){e[i]=null,this.queue.end(s),this.disposeNext(s);continue}if(null!=s.mixingFrom&&this.updateMixingFrom(s,t)){var l=s.mixingFrom;for(s.mixingFrom=null,null!=l&&(l.mixingTo=null);null!=l;)this.queue.end(l),l=l.mixingFrom}s.trackTime+=r}}this.queue.drain()},e.prototype.updateMixingFrom=function(t,e){var i=t.mixingFrom;if(null==i)return!0;var n=this.updateMixingFrom(i,e);return i.animationLast=i.nextAnimationLast,i.trackLast=i.nextTrackLast,t.mixTime>0&&t.mixTime>=t.mixDuration?(0!=i.totalAlpha&&0!=t.mixDuration||(t.mixingFrom=i.mixingFrom,null!=i.mixingFrom&&(i.mixingFrom.mixingTo=t),t.interruptAlpha=i.interruptAlpha,this.queue.end(i)),n):(i.trackTime+=e*i.timeScale,t.mixTime+=e,!1)},e.prototype.apply=function(i){if(null==i)throw new Error("skeleton cannot be null.");this.animationsChanged&&this._animationsChanged();for(var n=this.events,s=this.tracks,r=!1,o=0,a=s.length;o<a;o++){var l=s[o];if(!(null==l||l.delay>0)){r=!0;var c=0==o?t.MixBlend.first:l.mixBlend,h=l.alpha;null!=l.mixingFrom?h*=this.applyMixingFrom(l,i,c):l.trackTime>=l.trackEnd&&null==l.next&&(h=0);var _=l.animationLast,u=l.getAnimationTime(),m=l.animation.timelines.length,d=l.animation.timelines;if(0==o&&1==h||c==t.MixBlend.add)for(var p=0;p<m;p++)t.Utils.webkit602BugfixHelper(h,c),d[p].apply(i,_,u,n,h,c,t.MixDirection.mixIn);else{var f=l.timelineMode,g=0==l.timelinesRotation.length;g&&t.Utils.setArraySize(l.timelinesRotation,m<<1,null);var y=l.timelinesRotation;for(p=0;p<m;p++){var v=d[p],x=(f[p]&e.NOT_LAST-1)==e.SUBSEQUENT?c:t.MixBlend.setup;v instanceof t.RotateTimeline?this.applyRotateTimeline(v,i,u,h,x,y,p<<1,g):(t.Utils.webkit602BugfixHelper(h,c),v.apply(i,_,u,n,h,x,t.MixDirection.mixIn))}}this.queueEvents(l,u),n.length=0,l.nextAnimationLast=u,l.nextTrackLast=l.trackTime}}return this.queue.drain(),r},e.prototype.applyMixingFrom=function(i,n,s){var r=i.mixingFrom;null!=r.mixingFrom&&this.applyMixingFrom(r,n,s);var o=0;0==i.mixDuration?(o=1,s==t.MixBlend.first&&(s=t.MixBlend.setup)):((o=i.mixTime/i.mixDuration)>1&&(o=1),s!=t.MixBlend.first&&(s=r.mixBlend));var a=o<r.eventThreshold?this.events:null,l=o<r.attachmentThreshold,c=o<r.drawOrderThreshold,h=r.animationLast,_=r.getAnimationTime(),u=r.animation.timelines.length,m=r.animation.timelines,d=r.alpha*i.interruptAlpha,p=d*(1-o);if(s==t.MixBlend.add)for(var f=0;f<u;f++)m[f].apply(n,h,_,a,p,s,t.MixDirection.mixOut);else{var g=r.timelineMode,y=r.timelineHoldMix,v=0==r.timelinesRotation.length;v&&t.Utils.setArraySize(r.timelinesRotation,u<<1,null);var x=r.timelinesRotation;for(r.totalAlpha=0,f=0;f<u;f++){var S=m[f],A=t.MixDirection.mixOut,C=void 0,b=0;switch(g[f]&e.NOT_LAST-1){case e.SUBSEQUENT:if(C=s,!l&&S instanceof t.AttachmentTimeline){if((g[f]&e.NOT_LAST)==e.NOT_LAST)continue;C=t.MixBlend.setup}if(!c&&S instanceof t.DrawOrderTimeline)continue;b=p;break;case e.FIRST:C=t.MixBlend.setup,b=p;break;case e.HOLD:C=t.MixBlend.setup,b=d;break;default:C=t.MixBlend.setup;var T=y[f];b=d*Math.max(0,1-T.mixTime/T.mixDuration)}r.totalAlpha+=b,S instanceof t.RotateTimeline?this.applyRotateTimeline(S,n,_,b,C,x,f<<1,v):(t.Utils.webkit602BugfixHelper(b,s),C==t.MixBlend.setup&&(S instanceof t.AttachmentTimeline?(l||(g[f]&e.NOT_LAST)==e.NOT_LAST)&&(A=t.MixDirection.mixIn):S instanceof t.DrawOrderTimeline&&c&&(A=t.MixDirection.mixIn)),S.apply(n,h,_,a,b,C,A))}}return i.mixDuration>0&&this.queueEvents(r,_),this.events.length=0,r.nextAnimationLast=_,r.nextTrackLast=r.trackTime,o},e.prototype.applyRotateTimeline=function(e,i,n,s,r,o,a,l){if(l&&(o[a]=0),1!=s){var c=e,h=c.frames,_=i.bones[c.boneIndex];if(_.active){var u=0,m=0;if(n<h[0])switch(r){case t.MixBlend.setup:_.rotation=_.data.rotation;default:return;case t.MixBlend.first:u=_.rotation,m=_.data.rotation}else if(u=r==t.MixBlend.setup?_.data.rotation:_.rotation,n>=h[h.length-t.RotateTimeline.ENTRIES])m=_.data.rotation+h[h.length+t.RotateTimeline.PREV_ROTATION];else{var d=t.Animation.binarySearch(h,n,t.RotateTimeline.ENTRIES),p=h[d+t.RotateTimeline.PREV_ROTATION],f=h[d],g=c.getCurvePercent((d>>1)-1,1-(n-f)/(h[d+t.RotateTimeline.PREV_TIME]-f));m=h[d+t.RotateTimeline.ROTATION]-p,m=p+(m-=360*(16384-(16384.499999999996-m/360|0)))*g+_.data.rotation,m-=360*(16384-(16384.499999999996-m/360|0))}var y=0,v=m-u;if(0==(v-=360*(16384-(16384.499999999996-v/360|0))))y=o[a];else{var x=0,S=0;l?(x=0,S=v):(x=o[a],S=o[a+1]);var A=v>0,C=x>=0;t.MathUtils.signum(S)!=t.MathUtils.signum(v)&&Math.abs(S)<=90&&(Math.abs(x)>180&&(x+=360*t.MathUtils.signum(x)),C=A),y=v+x-x%360,C!=A&&(y+=360*t.MathUtils.signum(x)),o[a]=y}o[a+1]=v,u+=y*s,_.rotation=u-360*(16384-(16384.499999999996-u/360|0))}}else e.apply(i,0,n,null,1,r,t.MixDirection.mixIn)},e.prototype.queueEvents=function(t,e){for(var i=t.animationStart,n=t.animationEnd,s=n-i,r=t.trackLast%s,o=this.events,a=0,l=o.length;a<l;a++){var c=o[a];if(c.time<r)break;c.time>n||this.queue.event(t,c)}for((t.loop?0==s||r>t.trackTime%s:e>=n&&t.animationLast<n)&&this.queue.complete(t);a<l;a++)o[a].time<i||this.queue.event(t,o[a])},e.prototype.clearTracks=function(){var t=this.queue.drainDisabled;this.queue.drainDisabled=!0;for(var e=0,i=this.tracks.length;e<i;e++)this.clearTrack(e);this.tracks.length=0,this.queue.drainDisabled=t,this.queue.drain()},e.prototype.clearTrack=function(t){if(!(t>=this.tracks.length)){var e=this.tracks[t];if(null!=e){this.queue.end(e),this.disposeNext(e);for(var i=e;;){var n=i.mixingFrom;if(null==n)break;this.queue.end(n),i.mixingFrom=null,i.mixingTo=null,i=n}this.tracks[e.trackIndex]=null,this.queue.drain()}}},e.prototype.setCurrent=function(t,e,i){var n=this.expandToIndex(t);this.tracks[t]=e,null!=n&&(i&&this.queue.interrupt(n),e.mixingFrom=n,n.mixingTo=e,e.mixTime=0,null!=n.mixingFrom&&n.mixDuration>0&&(e.interruptAlpha*=Math.min(1,n.mixTime/n.mixDuration)),n.timelinesRotation.length=0),this.queue.start(e)},e.prototype.setAnimation=function(t,e,i){var n=this.data.skeletonData.findAnimation(e);if(null==n)throw new Error("Animation not found: "+e);return this.setAnimationWith(t,n,i)},e.prototype.setAnimationWith=function(t,e,i){if(null==e)throw new Error("animation cannot be null.");var n=!0,s=this.expandToIndex(t);null!=s&&(-1==s.nextTrackLast?(this.tracks[t]=s.mixingFrom,this.queue.interrupt(s),this.queue.end(s),this.disposeNext(s),s=s.mixingFrom,n=!1):this.disposeNext(s));var r=this.trackEntry(t,e,i,s);return this.setCurrent(t,r,n),this.queue.drain(),r},e.prototype.addAnimation=function(t,e,i,n){var s=this.data.skeletonData.findAnimation(e);if(null==s)throw new Error("Animation not found: "+e);return this.addAnimationWith(t,s,i,n)},e.prototype.addAnimationWith=function(t,e,i,n){if(null==e)throw new Error("animation cannot be null.");var s=this.expandToIndex(t);if(null!=s)for(;null!=s.next;)s=s.next;var r=this.trackEntry(t,e,i,s);if(null==s)this.setCurrent(t,r,!0),this.queue.drain();else if(s.next=r,n<=0){var o=s.animationEnd-s.animationStart;0!=o?(s.loop?n+=o*(1+(s.trackTime/o|0)):n+=Math.max(o,s.trackTime),n-=this.data.getMix(s.animation,e)):n=s.trackTime}return r.delay=n,r},e.prototype.setEmptyAnimation=function(t,i){var n=this.setAnimationWith(t,e.emptyAnimation,!1);return n.mixDuration=i,n.trackEnd=i,n},e.prototype.addEmptyAnimation=function(t,i,n){n<=0&&(n-=i);var s=this.addAnimationWith(t,e.emptyAnimation,!1,n);return s.mixDuration=i,s.trackEnd=i,s},e.prototype.setEmptyAnimations=function(t){var e=this.queue.drainDisabled;this.queue.drainDisabled=!0;for(var i=0,n=this.tracks.length;i<n;i++){var s=this.tracks[i];null!=s&&this.setEmptyAnimation(s.trackIndex,t)}this.queue.drainDisabled=e,this.queue.drain()},e.prototype.expandToIndex=function(e){return e<this.tracks.length?this.tracks[e]:(t.Utils.ensureArrayCapacity(this.tracks,e+1,null),this.tracks.length=e+1,null)},e.prototype.trackEntry=function(t,e,i,n){var s=this.trackEntryPool.obtain();return s.trackIndex=t,s.animation=e,s.loop=i,s.holdPrevious=!1,s.eventThreshold=0,s.attachmentThreshold=0,s.drawOrderThreshold=0,s.animationStart=0,s.animationEnd=e.duration,s.animationLast=-1,s.nextAnimationLast=-1,s.delay=0,s.trackTime=0,s.trackLast=-1,s.nextTrackLast=-1,s.trackEnd=Number.MAX_VALUE,s.timeScale=1,s.alpha=1,s.interruptAlpha=1,s.mixTime=0,s.mixDuration=null==n?0:this.data.getMix(n.animation,e),s},e.prototype.disposeNext=function(t){for(var e=t.next;null!=e;)this.queue.dispose(e),e=e.next;t.next=null},e.prototype._animationsChanged=function(){this.animationsChanged=!1,this.propertyIDs.clear();for(var e=0,i=this.tracks.length;e<i;e++)if(null!=(n=this.tracks[e])){for(;null!=n.mixingFrom;)n=n.mixingFrom;do{null!=n.mixingFrom&&n.mixBlend==t.MixBlend.add||this.computeHold(n),n=n.mixingTo}while(null!=n)}for(this.propertyIDs.clear(),e=this.tracks.length-1;e>=0;e--)for(var n=this.tracks[e];null!=n;)this.computeNotLast(n),n=n.mixingFrom},e.prototype.computeHold=function(i){var n=i.mixingTo,s=i.animation.timelines,r=i.animation.timelines.length,o=t.Utils.setArraySize(i.timelineMode,r);i.timelineHoldMix.length=0;var a=t.Utils.setArraySize(i.timelineHoldMix,r),l=this.propertyIDs;if(null!=n&&n.holdPrevious)for(var c=0;c<r;c++)l.add(s[c].getPropertyId()),o[c]=e.HOLD;else t:for(c=0;c<r;c++){var h=s[c],_=h.getPropertyId();if(l.add(_))if(null==n||h instanceof t.AttachmentTimeline||h instanceof t.DrawOrderTimeline||h instanceof t.EventTimeline||!n.animation.hasTimeline(_))o[c]=e.FIRST;else{for(var u=n.mixingTo;null!=u;u=u.mixingTo)if(!u.animation.hasTimeline(_)){if(i.mixDuration>0){o[c]=e.HOLD_MIX,a[c]=u;continue t}break}o[c]=e.HOLD}else o[c]=e.SUBSEQUENT}},e.prototype.computeNotLast=function(i){for(var n=i.animation.timelines,s=i.animation.timelines.length,r=i.timelineMode,o=this.propertyIDs,a=0;a<s;a++)if(n[a]instanceof t.AttachmentTimeline){var l=n[a];o.add(l.slotIndex)||(r[a]|=e.NOT_LAST)}},e.prototype.getCurrent=function(t){return t>=this.tracks.length?null:this.tracks[t]},e.prototype.addListener=function(t){if(null==t)throw new Error("listener cannot be null.");this.listeners.push(t)},e.prototype.removeListener=function(t){var e=this.listeners.indexOf(t);e>=0&&this.listeners.splice(e,1)},e.prototype.clearListeners=function(){this.listeners.length=0},e.prototype.clearListenerNotifications=function(){this.queue.clear()},e.emptyAnimation=new t.Animation("<empty>",[],0),e.SUBSEQUENT=0,e.FIRST=1,e.HOLD=2,e.HOLD_MIX=3,e.NOT_LAST=4,e}();t.AnimationState=e;var i=function(){function e(){this.mixBlend=t.MixBlend.replace,this.timelineMode=new Array,this.timelineHoldMix=new Array,this.timelinesRotation=new Array}return e.prototype.reset=function(){this.next=null,this.mixingFrom=null,this.mixingTo=null,this.animation=null,this.listener=null,this.timelineMode.length=0,this.timelineHoldMix.length=0,this.timelinesRotation.length=0},e.prototype.getAnimationTime=function(){if(this.loop){var t=this.animationEnd-this.animationStart;return 0==t?this.animationStart:this.trackTime%t+this.animationStart}return Math.min(this.trackTime+this.animationStart,this.animationEnd)},e.prototype.setAnimationLast=function(t){this.animationLast=t,this.nextAnimationLast=t},e.prototype.isComplete=function(){return this.trackTime>=this.animationEnd-this.animationStart},e.prototype.resetRotationDirections=function(){this.timelinesRotation.length=0},e}();t.TrackEntry=i;var n,s=function(){function t(t){this.objects=[],this.drainDisabled=!1,this.animState=t}return t.prototype.start=function(t){this.objects.push(n.start),this.objects.push(t),this.animState.animationsChanged=!0},t.prototype.interrupt=function(t){this.objects.push(n.interrupt),this.objects.push(t)},t.prototype.end=function(t){this.objects.push(n.end),this.objects.push(t),this.animState.animationsChanged=!0},t.prototype.dispose=function(t){this.objects.push(n.dispose),this.objects.push(t)},t.prototype.complete=function(t){this.objects.push(n.complete),this.objects.push(t)},t.prototype.event=function(t,e){this.objects.push(n.event),this.objects.push(t),this.objects.push(e)},t.prototype.drain=function(){if(!this.drainDisabled){this.drainDisabled=!0;for(var t=this.objects,e=this.animState.listeners,i=0;i<t.length;i+=2){var s=t[i],r=t[i+1];switch(s){case n.start:null!=r.listener&&r.listener.start&&r.listener.start(r);for(var o=0;o<e.length;o++)e[o].start&&e[o].start(r);break;case n.interrupt:for(null!=r.listener&&r.listener.interrupt&&r.listener.interrupt(r),o=0;o<e.length;o++)e[o].interrupt&&e[o].interrupt(r);break;case n.end:for(null!=r.listener&&r.listener.end&&r.listener.end(r),o=0;o<e.length;o++)e[o].end&&e[o].end(r);case n.dispose:for(null!=r.listener&&r.listener.dispose&&r.listener.dispose(r),o=0;o<e.length;o++)e[o].dispose&&e[o].dispose(r);this.animState.trackEntryPool.free(r);break;case n.complete:for(null!=r.listener&&r.listener.complete&&r.listener.complete(r),o=0;o<e.length;o++)e[o].complete&&e[o].complete(r);break;case n.event:var a=t[2+i++];for(null!=r.listener&&r.listener.event&&r.listener.event(r,a),o=0;o<e.length;o++)e[o].event&&e[o].event(r,a)}}this.clear(),this.drainDisabled=!1}},t.prototype.clear=function(){this.objects.length=0},t}();t.EventQueue=s,function(t){t[t.start=0]="start",t[t.interrupt=1]="interrupt",t[t.end=2]="end",t[t.dispose=3]="dispose",t[t.complete=4]="complete",t[t.event=5]="event"}(n=t.EventType||(t.EventType={}));var r=function(){function t(){}return t.prototype.start=function(){},t.prototype.interrupt=function(){},t.prototype.end=function(){},t.prototype.dispose=function(){},t.prototype.complete=function(){},t.prototype.event=function(){},t}();t.AnimationStateAdapter=r}(Q9||(Q9={})),function(t){var e=function(){function t(t){if(this.animationToMixTime={},this.defaultMix=0,null==t)throw new Error("skeletonData cannot be null.");this.skeletonData=t}return t.prototype.setMix=function(t,e,i){var n=this.skeletonData.findAnimation(t);if(null==n)throw new Error("Animation not found: "+t);var s=this.skeletonData.findAnimation(e);if(null==s)throw new Error("Animation not found: "+e);this.setMixWith(n,s,i)},t.prototype.setMixWith=function(t,e,i){if(null==t)throw new Error("from cannot be null.");if(null==e)throw new Error("to cannot be null.");var n=t.name+"."+e.name;this.animationToMixTime[n]=i},t.prototype.getMix=function(t,e){var i=t.name+"."+e.name,n=this.animationToMixTime[i];return void 0===n?this.defaultMix:n},t}();t.AnimationStateData=e}(Q9||(Q9={})),function(t){var e=function(){function e(t,e){void 0===e&&(e=""),this.assets={},this.errors={},this.toLoad=0,this.loaded=0,this.textureLoader=t,this.pathPrefix=e}return e.downloadText=function(t,e,i){var n=new XMLHttpRequest;n.open("GET",t,!0),n.onload=function(){200==n.status?e(n.responseText):i(n.status,n.responseText)},n.onerror=function(){i(n.status,n.responseText)},n.send()},e.downloadBinary=function(t,e,i){var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){200==n.status?e(new Uint8Array(n.response)):i(n.status,n.responseText)},n.onerror=function(){i(n.status,n.responseText)},n.send()},e.prototype.loadBinary=function(t,i,n){var s=this;void 0===i&&(i=null),void 0===n&&(n=null),t=this.pathPrefix+t,this.toLoad++,e.downloadBinary(t,(function(e){s.assets[t]=e,i&&i(t,e),s.toLoad--,s.loaded++}),(function(e,i){s.errors[t]="Couldn't load binary "+t+": status "+status+", "+i,n&&n(t,"Couldn't load binary "+t+": status "+status+", "+i),s.toLoad--,s.loaded++}))},e.prototype.loadText=function(t,i,n){var s=this;void 0===i&&(i=null),void 0===n&&(n=null),t=this.pathPrefix+t,this.toLoad++,e.downloadText(t,(function(e){s.assets[t]=e,i&&i(t,e),s.toLoad--,s.loaded++}),(function(e,i){s.errors[t]="Couldn't load text "+t+": status "+status+", "+i,n&&n(t,"Couldn't load text "+t+": status "+status+", "+i),s.toLoad--,s.loaded++}))},e.prototype.loadTexture=function(t,e,i){var n=this;void 0===e&&(e=null),void 0===i&&(i=null),t=this.pathPrefix+t,this.toLoad++;var s=new Image;s.crossOrigin="anonymous",s.onload=function(){var i=n.textureLoader(s);n.assets[t]=i,n.toLoad--,n.loaded++,e&&e(t,s)},s.onerror=function(){n.errors[t]="Couldn't load image "+t,n.toLoad--,n.loaded++,i&&i(t,"Couldn't load image "+t)},s.src=t},e.prototype.loadTextureData=function(t,e,i,n){var s=this;void 0===i&&(i=null),void 0===n&&(n=null),t=this.pathPrefix+t,this.toLoad++;var r=new Image;r.onload=function(){var e=s.textureLoader(r);s.assets[t]=e,s.toLoad--,s.loaded++,i&&i(t,r)},r.onerror=function(){s.errors[t]="Couldn't load image "+t,s.toLoad--,s.loaded++,n&&n(t,"Couldn't load image "+t)},r.src=e},e.prototype.loadTextureAtlas=function(i,n,s){var r=this;void 0===n&&(n=null),void 0===s&&(s=null);var o=i.lastIndexOf("/")>=0?i.substring(0,i.lastIndexOf("/")):"";i=this.pathPrefix+i,this.toLoad++,e.downloadText(i,(function(e){var a={count:0},l=new Array;try{new t.TextureAtlas(e,(function(e){l.push(o+"/"+e);var i=document.createElement("img");return i.width=16,i.height=16,new t.FakeTexture(i)}))}catch(t){var c=t;return r.errors[i]="Couldn't load texture atlas "+i+": "+c.message,s&&s(i,"Couldn't load texture atlas "+i+": "+c.message),r.toLoad--,void r.loaded++}for(var h=function(c){var h=!1;r.loadTexture(c,(function(c){if(a.count++,a.count==l.length)if(h)r.errors[i]="Couldn't load texture atlas page "+c+"} of atlas "+i,s&&s(i,"Couldn't load texture atlas page "+c+" of atlas "+i),r.toLoad--,r.loaded++;else try{var _=new t.TextureAtlas(e,(function(t){return r.get(o+"/"+t)}));r.assets[i]=_,n&&n(i,_),r.toLoad--,r.loaded++}catch(t){var u=t;r.errors[i]="Couldn't load texture atlas "+i+": "+u.message,s&&s(i,"Couldn't load texture atlas "+i+": "+u.message),r.toLoad--,r.loaded++}}),(function(t){h=!0,a.count++,a.count==l.length&&(r.errors[i]="Couldn't load texture atlas page "+t+"} of atlas "+i,s&&s(i,"Couldn't load texture atlas page "+t+" of atlas "+i),r.toLoad--,r.loaded++)}))},_=0,u=l;_<u.length;_++)h(u[_])}),(function(t,e){r.errors[i]="Couldn't load texture atlas "+i+": status "+status+", "+e,s&&s(i,"Couldn't load texture atlas "+i+": status "+status+", "+e),r.toLoad--,r.loaded++}))},e.prototype.get=function(t){return t=this.pathPrefix+t,this.assets[t]},e.prototype.remove=function(t){t=this.pathPrefix+t;var e=this.assets[t];e.dispose&&e.dispose(),this.assets[t]=null},e.prototype.removeAll=function(){for(var t in this.assets){var e=this.assets[t];e.dispose&&e.dispose()}this.assets={}},e.prototype.isLoadingComplete=function(){return 0==this.toLoad},e.prototype.getToLoad=function(){return this.toLoad},e.prototype.getLoaded=function(){return this.loaded},e.prototype.dispose=function(){this.removeAll()},e.prototype.hasErrors=function(){return Object.keys(this.errors).length>0},e.prototype.getErrors=function(){return this.errors},e}();t.AssetManager=e}(Q9||(Q9={})),function(t){var e=function(){function e(t){this.atlas=t}return e.prototype.newRegionAttachment=function(e,i,n){var s=this.atlas.findRegion(n);if(null==s)return null;s.renderObject=s;var r=new t.RegionAttachment(i);return r.setRegion(s),r},e.prototype.newMeshAttachment=function(e,i,n){var s=this.atlas.findRegion(n);if(null==s)return null;s.renderObject=s;var r=new t.MeshAttachment(i);return r.region=s,r},e.prototype.newBoundingBoxAttachment=function(e,i){return new t.BoundingBoxAttachment(i)},e.prototype.newPathAttachment=function(e,i){return new t.PathAttachment(i)},e.prototype.newPointAttachment=function(e,i){return new t.PointAttachment(i)},e.prototype.newClippingAttachment=function(e,i){return new t.ClippingAttachment(i)},e}();t.AtlasAttachmentLoader=e}(Q9||(Q9={})),function(t){var e;(e=t.BlendMode||(t.BlendMode={}))[e.Normal=0]="Normal",e[e.Additive=1]="Additive",e[e.Multiply=2]="Multiply",e[e.Screen=3]="Screen"}(Q9||(Q9={})),function(t){var e=function(){function e(t,e,i){if(this.children=new Array,this.x=0,this.y=0,this.rotation=0,this.scaleX=0,this.scaleY=0,this.shearX=0,this.shearY=0,this.ax=0,this.ay=0,this.arotation=0,this.ascaleX=0,this.ascaleY=0,this.ashearX=0,this.ashearY=0,this.appliedValid=!1,this.a=0,this.b=0,this.c=0,this.d=0,this.worldY=0,this.worldX=0,this.sorted=!1,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.skeleton=e,this.parent=i,this.setToSetupPose()}return e.prototype.isActive=function(){return this.active},e.prototype.update=function(){this.updateWorldTransformWith(this.x,this.y,this.rotation,this.scaleX,this.scaleY,this.shearX,this.shearY)},e.prototype.updateWorldTransform=function(){this.updateWorldTransformWith(this.x,this.y,this.rotation,this.scaleX,this.scaleY,this.shearX,this.shearY)},e.prototype.updateWorldTransformWith=function(e,i,n,s,r,o,a){this.ax=e,this.ay=i,this.arotation=n,this.ascaleX=s,this.ascaleY=r,this.ashearX=o,this.ashearY=a,this.appliedValid=!0;var l=this.parent;if(null==l){var c=this.skeleton,h=n+90+a,_=c.scaleX,u=c.scaleY;return this.a=t.MathUtils.cosDeg(n+o)*s*_,this.b=t.MathUtils.cosDeg(h)*r*_,this.c=t.MathUtils.sinDeg(n+o)*s*u,this.d=t.MathUtils.sinDeg(h)*r*u,this.worldX=e*_+c.x,void(this.worldY=i*u+c.y)}var m=l.a,d=l.b,p=l.c,f=l.d;switch(this.worldX=m*e+d*i+l.worldX,this.worldY=p*e+f*i+l.worldY,this.data.transformMode){case t.TransformMode.Normal:h=n+90+a;var g=t.MathUtils.cosDeg(n+o)*s,y=t.MathUtils.cosDeg(h)*r,v=t.MathUtils.sinDeg(n+o)*s,x=t.MathUtils.sinDeg(h)*r;return this.a=m*g+d*v,this.b=m*y+d*x,this.c=p*g+f*v,void(this.d=p*y+f*x);case t.TransformMode.OnlyTranslation:h=n+90+a,this.a=t.MathUtils.cosDeg(n+o)*s,this.b=t.MathUtils.cosDeg(h)*r,this.c=t.MathUtils.sinDeg(n+o)*s,this.d=t.MathUtils.sinDeg(h)*r;break;case t.TransformMode.NoRotationOrReflection:var S=0;(b=m*m+p*p)>1e-4?(d=p*(b=Math.abs(m*f-d*p)/b),f=m*b,S=Math.atan2(p,m)*t.MathUtils.radDeg):(m=0,p=0,S=90-Math.atan2(f,d)*t.MathUtils.radDeg);var A=n+o-S,C=n+a-S+90;g=t.MathUtils.cosDeg(A)*s,y=t.MathUtils.cosDeg(C)*r,v=t.MathUtils.sinDeg(A)*s,x=t.MathUtils.sinDeg(C)*r,this.a=m*g-d*v,this.b=m*y-d*x,this.c=p*g+f*v,this.d=p*y+f*x;break;case t.TransformMode.NoScale:case t.TransformMode.NoScaleOrReflection:var b,T=t.MathUtils.cosDeg(n),w=t.MathUtils.sinDeg(n),E=(m*T+d*w)/this.skeleton.scaleX,P=(p*T+f*w)/this.skeleton.scaleY;(b=Math.sqrt(E*E+P*P))>1e-5&&(b=1/b),E*=b,P*=b,b=Math.sqrt(E*E+P*P),this.data.transformMode==t.TransformMode.NoScale&&m*f-d*p<0!=(this.skeleton.scaleX<0!=this.skeleton.scaleY<0)&&(b=-b);var I=Math.PI/2+Math.atan2(P,E),D=Math.cos(I)*b,R=Math.sin(I)*b;g=t.MathUtils.cosDeg(o)*s,y=t.MathUtils.cosDeg(90+a)*r,v=t.MathUtils.sinDeg(o)*s,x=t.MathUtils.sinDeg(90+a)*r,this.a=E*g+D*v,this.b=E*y+D*x,this.c=P*g+R*v,this.d=P*y+R*x}this.a*=this.skeleton.scaleX,this.b*=this.skeleton.scaleX,this.c*=this.skeleton.scaleY,this.d*=this.skeleton.scaleY},e.prototype.setToSetupPose=function(){var t=this.data;this.x=t.x,this.y=t.y,this.rotation=t.rotation,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.shearX=t.shearX,this.shearY=t.shearY},e.prototype.getWorldRotationX=function(){return Math.atan2(this.c,this.a)*t.MathUtils.radDeg},e.prototype.getWorldRotationY=function(){return Math.atan2(this.d,this.b)*t.MathUtils.radDeg},e.prototype.getWorldScaleX=function(){return Math.sqrt(this.a*this.a+this.c*this.c)},e.prototype.getWorldScaleY=function(){return Math.sqrt(this.b*this.b+this.d*this.d)},e.prototype.updateAppliedTransform=function(){this.appliedValid=!0;var e=this.parent;if(null==e)return this.ax=this.worldX,this.ay=this.worldY,this.arotation=Math.atan2(this.c,this.a)*t.MathUtils.radDeg,this.ascaleX=Math.sqrt(this.a*this.a+this.c*this.c),this.ascaleY=Math.sqrt(this.b*this.b+this.d*this.d),this.ashearX=0,void(this.ashearY=Math.atan2(this.a*this.b+this.c*this.d,this.a*this.d-this.b*this.c)*t.MathUtils.radDeg);var i=e.a,n=e.b,s=e.c,r=e.d,o=1/(i*r-n*s),a=this.worldX-e.worldX,l=this.worldY-e.worldY;this.ax=a*r*o-l*n*o,this.ay=l*i*o-a*s*o;var c=o*r,h=o*i,_=o*n,u=o*s,m=c*this.a-_*this.c,d=c*this.b-_*this.d,p=h*this.c-u*this.a,f=h*this.d-u*this.b;if(this.ashearX=0,this.ascaleX=Math.sqrt(m*m+p*p),this.ascaleX>1e-4){var g=m*f-d*p;this.ascaleY=g/this.ascaleX,this.ashearY=Math.atan2(m*d+p*f,g)*t.MathUtils.radDeg,this.arotation=Math.atan2(p,m)*t.MathUtils.radDeg}else this.ascaleX=0,this.ascaleY=Math.sqrt(d*d+f*f),this.ashearY=0,this.arotation=90-Math.atan2(f,d)*t.MathUtils.radDeg},e.prototype.worldToLocal=function(t){var e=this.a,i=this.b,n=this.c,s=this.d,r=1/(e*s-i*n),o=t.x-this.worldX,a=t.y-this.worldY;return t.x=o*s*r-a*i*r,t.y=a*e*r-o*n*r,t},e.prototype.localToWorld=function(t){var e=t.x,i=t.y;return t.x=e*this.a+i*this.b+this.worldX,t.y=e*this.c+i*this.d+this.worldY,t},e.prototype.worldToLocalRotation=function(e){var i=t.MathUtils.sinDeg(e),n=t.MathUtils.cosDeg(e);return Math.atan2(this.a*i-this.c*n,this.d*n-this.b*i)*t.MathUtils.radDeg+this.rotation-this.shearX},e.prototype.localToWorldRotation=function(e){e-=this.rotation-this.shearX;var i=t.MathUtils.sinDeg(e),n=t.MathUtils.cosDeg(e);return Math.atan2(n*this.c+i*this.d,n*this.a+i*this.b)*t.MathUtils.radDeg},e.prototype.rotateWorld=function(e){var i=this.a,n=this.b,s=this.c,r=this.d,o=t.MathUtils.cosDeg(e),a=t.MathUtils.sinDeg(e);this.a=o*i-a*s,this.b=o*n-a*r,this.c=a*i+o*s,this.d=a*n+o*r,this.appliedValid=!1},e}();t.Bone=e}(Q9||(Q9={})),function(t){var e;t.BoneData=function(i,n,s){if(this.x=0,this.y=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.shearX=0,this.shearY=0,this.transformMode=e.Normal,this.skinRequired=!1,this.color=new t.Color,i<0)throw new Error("index must be >= 0.");if(null==n)throw new Error("name cannot be null.");this.index=i,this.name=n,this.parent=s},function(t){t[t.Normal=0]="Normal",t[t.OnlyTranslation=1]="OnlyTranslation",t[t.NoRotationOrReflection=2]="NoRotationOrReflection",t[t.NoScale=3]="NoScale",t[t.NoScaleOrReflection=4]="NoScaleOrReflection"}(e=t.TransformMode||(t.TransformMode={}))}(Q9||(Q9={})),function(t){t.ConstraintData=function(t,e,i){this.name=t,this.order=e,this.skinRequired=i}}(Q9||(Q9={})),function(t){t.Event=function(t,e){if(null==e)throw new Error("data cannot be null.");this.time=t,this.data=e}}(Q9||(Q9={})),function(t){t.EventData=function(t){this.name=t}}(Q9||(Q9={})),function(t){var e=function(){function e(t,e){if(this.bendDirection=0,this.compress=!1,this.stretch=!1,this.mix=1,this.softness=0,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.mix=t.mix,this.softness=t.softness,this.bendDirection=t.bendDirection,this.compress=t.compress,this.stretch=t.stretch,this.bones=new Array;for(var i=0;i<t.bones.length;i++)this.bones.push(e.findBone(t.bones[i].name));this.target=e.findBone(t.target.name)}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){var t=this.target,e=this.bones;switch(e.length){case 1:this.apply1(e[0],t.worldX,t.worldY,this.compress,this.stretch,this.data.uniform,this.mix);break;case 2:this.apply2(e[0],e[1],t.worldX,t.worldY,this.bendDirection,this.stretch,this.softness,this.mix)}},e.prototype.apply1=function(e,i,n,s,r,o,a){e.appliedValid||e.updateAppliedTransform();var l=e.parent,c=1/(l.a*l.d-l.b*l.c),h=i-l.worldX,_=n-l.worldY,u=(h*l.d-_*l.b)*c-e.ax,m=(_*l.a-h*l.c)*c-e.ay,d=Math.atan2(m,u)*t.MathUtils.radDeg-e.ashearX-e.arotation;e.ascaleX<0&&(d+=180),d>180?d-=360:d<-180&&(d+=360);var p=e.ascaleX,f=e.ascaleY;if(s||r){var g=e.data.length*p,y=Math.sqrt(u*u+m*m);if(s&&y<g||r&&y>g&&g>1e-4){var v=(y/g-1)*a+1;p*=v,o&&(f*=v)}}e.updateWorldTransformWith(e.ax,e.ay,e.arotation+d*a,p,f,e.ashearX,e.ashearY)},e.prototype.apply2=function(e,i,n,s,r,o,a,l){if(0!=l){e.appliedValid||e.updateAppliedTransform(),i.appliedValid||i.updateAppliedTransform();var c=e.ax,h=e.ay,_=e.ascaleX,u=_,m=e.ascaleY,d=i.ascaleX,p=0,f=0,g=0;_<0?(_=-_,p=180,g=-1):(p=0,g=1),m<0&&(m=-m,g=-g),d<0?(d=-d,f=180):f=0;var y=i.ax,v=0,x=0,S=0,A=e.a,C=e.b,b=e.c,T=e.d,w=Math.abs(_-m)<=1e-4;w?(x=A*y+C*(v=i.ay)+e.worldX,S=b*y+T*v+e.worldY):(v=0,x=A*y+e.worldX,S=b*y+e.worldY);var E=e.parent;A=E.a,C=E.b,b=E.c;var P,I,D=1/(A*(T=E.d)-C*b),R=x-E.worldX,M=S-E.worldY,B=(R*T-M*C)*D-c,O=(M*A-R*b)*D-h,N=Math.sqrt(B*B+O*O),L=i.data.length*d;if(N<1e-4)return this.apply1(e,n,s,!1,o,!1,l),void i.updateWorldTransformWith(y,v,0,i.ascaleX,i.ascaleY,i.ashearX,i.ashearY);var F=((R=n-E.worldX)*T-(M=s-E.worldY)*C)*D-c,z=(M*A-R*b)*D-h,V=F*F+z*z;if(0!=a){a*=_*(d+1)/2;var U=Math.sqrt(V),G=U-N-L*_+a;if(G>0){var H=Math.min(1,G/(2*a))-1;V=(F-=(H=(G-a*(1-H*H))/U)*F)*F+(z-=H*z)*z}}t:if(w){var k=(V-N*N-(L*=_)*L)/(2*N*L);k<-1?k=-1:k>1&&(k=1,o&&(u*=(Math.sqrt(V)/(N+L)-1)*l+1)),I=Math.acos(k)*r,A=N+L*k,C=L*Math.sin(I),P=Math.atan2(z*A-F*C,F*A+z*C)}else{var j=(A=_*L)*A,W=(C=m*L)*C,q=Math.atan2(z,F),X=-2*W*N,Y=W-j;if((T=X*X-4*Y*(b=W*N*N+j*V-j*W))>=0){var K=Math.sqrt(T);X<0&&(K=-K);var J=(K=-(X+K)/2)/Y,$=b/K,Z=Math.abs(J)<Math.abs($)?J:$;if(Z*Z<=V){M=Math.sqrt(V-Z*Z)*r,P=q-Math.atan2(M,Z),I=Math.atan2(M/m,(Z-N)/_);break t}}var Q=t.MathUtils.PI,tt=N-A,et=tt*tt,it=0,nt=0,st=N+A,rt=st*st,ot=0;(b=-A*N/(j-W))>=-1&&b<=1&&(b=Math.acos(b),(T=(R=A*Math.cos(b)+N)*R+(M=C*Math.sin(b))*M)<et&&(Q=b,et=T,tt=R,it=M),T>rt&&(nt=b,rt=T,st=R,ot=M)),V<=(et+rt)/2?(P=q-Math.atan2(it*r,tt),I=Q*r):(P=q-Math.atan2(ot*r,st),I=nt*r)}var at=Math.atan2(v,y)*g,lt=e.arotation;(P=(P-at)*t.MathUtils.radDeg+p-lt)>180?P-=360:P<-180&&(P+=360),e.updateWorldTransformWith(c,h,lt+P*l,u,e.ascaleY,0,0),lt=i.arotation,(I=((I+at)*t.MathUtils.radDeg-i.ashearX)*g+f-lt)>180?I-=360:I<-180&&(I+=360),i.updateWorldTransformWith(y,v,lt+I*l,i.ascaleX,i.ascaleY,i.ashearX,i.ashearY)}else i.updateWorldTransform()},e}();t.IkConstraint=e}(Q9||(Q9={})),function(t){var e=function(t){function e(e){var i=t.call(this,e,0,!1)||this;return i.bones=new Array,i.bendDirection=1,i.compress=!1,i.stretch=!1,i.uniform=!1,i.mix=1,i.softness=0,i}return ttt(e,t),e}(t.ConstraintData);t.IkConstraintData=e}(Q9||(Q9={})),function(t){var e=function(){function e(t,e){if(this.position=0,this.spacing=0,this.rotateMix=0,this.translateMix=0,this.spaces=new Array,this.positions=new Array,this.world=new Array,this.curves=new Array,this.lengths=new Array,this.segments=new Array,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.bones=new Array;for(var i=0,n=t.bones.length;i<n;i++)this.bones.push(e.findBone(t.bones[i].name));this.target=e.findSlot(t.target.name),this.position=t.position,this.spacing=t.spacing,this.rotateMix=t.rotateMix,this.translateMix=t.translateMix}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){var i=this.target.getAttachment();if(i instanceof t.PathAttachment){var n=this.rotateMix,s=this.translateMix,r=n>0;if(s>0||r){var o=this.data,a=o.spacingMode==t.SpacingMode.Percent,l=o.rotateMode,c=l==t.RotateMode.Tangent,h=l==t.RotateMode.ChainScale,_=this.bones.length,u=c?_:_+1,m=this.bones,d=t.Utils.setArraySize(this.spaces,u),p=null,f=this.spacing;if(h||!a){h&&(p=t.Utils.setArraySize(this.lengths,_));for(var g=o.spacingMode==t.SpacingMode.Length,y=0,v=u-1;y<v;){var x=(R=m[y]).data.length;if(x<e.epsilon)h&&(p[y]=0),d[++y]=0;else if(a){if(h){var S=x*R.a,A=x*R.c,C=Math.sqrt(S*S+A*A);p[y]=C}d[++y]=f}else{S=x*R.a,A=x*R.c;var b=Math.sqrt(S*S+A*A);h&&(p[y]=b),d[++y]=(g?x+f:f)*b/x}}}else for(y=1;y<u;y++)d[y]=f;var T=this.computeWorldPositions(i,u,c,o.positionMode==t.PositionMode.Percent,a),w=T[0],E=T[1],P=o.offsetRotation,I=!1;0==P?I=l==t.RotateMode.Chain:(I=!1,P*=(D=this.target.bone).a*D.d-D.b*D.c>0?t.MathUtils.degRad:-t.MathUtils.degRad),y=0;for(var D=3;y<_;y++,D+=3){var R;(R=m[y]).worldX+=(w-R.worldX)*s,R.worldY+=(E-R.worldY)*s;var M=(S=T[D])-w,B=(A=T[D+1])-E;if(h){var O=p[y];if(0!=O){var N=(Math.sqrt(M*M+B*B)/O-1)*n+1;R.a*=N,R.c*=N}}if(w=S,E=A,r){var L=R.a,F=R.b,z=R.c,V=R.d,U=0,G=0,H=0;if(U=c?T[D-1]:0==d[y+1]?T[D+2]:Math.atan2(B,M),U-=Math.atan2(z,L),I){G=Math.cos(U),H=Math.sin(U);var k=R.data.length;w+=(k*(G*L-H*z)-M)*n,E+=(k*(H*L+G*z)-B)*n}else U+=P;U>t.MathUtils.PI?U-=t.MathUtils.PI2:U<-t.MathUtils.PI&&(U+=t.MathUtils.PI2),U*=n,G=Math.cos(U),H=Math.sin(U),R.a=G*L-H*z,R.b=G*F-H*V,R.c=H*L+G*z,R.d=H*F+G*V}R.appliedValid=!1}}}},e.prototype.computeWorldPositions=function(i,n,s,r,o){var a=this.target,l=this.position,c=this.spaces,h=t.Utils.setArraySize(this.positions,3*n+2),_=null,u=i.closed,m=i.worldVerticesLength,d=m/6,p=e.NONE;if(!i.constantSpeed){var f=i.lengths,g=f[d-=u?1:2];if(r&&(l*=g),o)for(var y=1;y<n;y++)c[y]*=g;_=t.Utils.setArraySize(this.world,8),y=0;for(var v=0,x=0;y<n;y++,v+=3){var S=l+=W=c[y];if(u)(S%=g)<0&&(S+=g),x=0;else{if(S<0){p!=e.BEFORE&&(p=e.BEFORE,i.computeWorldVertices(a,2,4,_,0,2)),this.addBeforePosition(S,_,0,h,v);continue}if(S>g){p!=e.AFTER&&(p=e.AFTER,i.computeWorldVertices(a,m-6,4,_,0,2)),this.addAfterPosition(S-g,_,0,h,v);continue}}for(;;x++){var A=f[x];if(!(S>A)){0==x?S/=A:S=(S-(K=f[x-1]))/(A-K);break}}x!=p&&(p=x,u&&x==d?(i.computeWorldVertices(a,m-4,4,_,0,2),i.computeWorldVertices(a,0,4,_,4,2)):i.computeWorldVertices(a,6*x+2,8,_,0,2)),this.addCurvePosition(S,_[0],_[1],_[2],_[3],_[4],_[5],_[6],_[7],h,v,s||y>0&&0==W)}return h}u?(m+=2,_=t.Utils.setArraySize(this.world,m),i.computeWorldVertices(a,2,m-4,_,0,2),i.computeWorldVertices(a,0,2,_,m-4,2),_[m-2]=_[0],_[m-1]=_[1]):(d--,m-=4,_=t.Utils.setArraySize(this.world,m),i.computeWorldVertices(a,2,m,_,0,2));for(var C=t.Utils.setArraySize(this.curves,d),b=0,T=_[0],w=_[1],E=0,P=0,I=0,D=0,R=0,M=0,B=0,O=0,N=0,L=0,F=0,z=0,V=0,U=0,G=(y=0,2);y<d;y++,G+=6)E=_[G],P=_[G+1],I=_[G+2],D=_[G+3],F=2*(B=.1875*(T-2*E+I))+(N=.09375*(3*(E-I)-T+(R=_[G+4]))),z=2*(O=.1875*(w-2*P+D))+(L=.09375*(3*(P-D)-w+(M=_[G+5]))),V=.75*(E-T)+B+.16666667*N,U=.75*(P-w)+O+.16666667*L,b+=Math.sqrt(V*V+U*U),V+=F,U+=z,F+=N,z+=L,b+=Math.sqrt(V*V+U*U),V+=F,U+=z,b+=Math.sqrt(V*V+U*U),V+=F+N,U+=z+L,b+=Math.sqrt(V*V+U*U),C[y]=b,T=R,w=M;if(l*=r?b:b/i.lengths[d-1],o)for(y=1;y<n;y++)c[y]*=b;for(var H=this.segments,k=0,j=(y=0,v=0,x=0,0);y<n;y++,v+=3){var W;if(S=l+=W=c[y],u)(S%=b)<0&&(S+=b),x=0;else{if(S<0){this.addBeforePosition(S,_,0,h,v);continue}if(S>b){this.addAfterPosition(S-b,_,m-4,h,v);continue}}for(;;x++){var q=C[x];if(!(S>q)){0==x?S/=q:S=(S-(K=C[x-1]))/(q-K);break}}if(x!=p){p=x;var X=6*x;for(T=_[X],w=_[X+1],E=_[X+2],P=_[X+3],I=_[X+4],D=_[X+5],F=2*(B=.03*(T-2*E+I))+(N=.006*(3*(E-I)-T+(R=_[X+6]))),z=2*(O=.03*(w-2*P+D))+(L=.006*(3*(P-D)-w+(M=_[X+7]))),V=.3*(E-T)+B+.16666667*N,U=.3*(P-w)+O+.16666667*L,k=Math.sqrt(V*V+U*U),H[0]=k,X=1;X<8;X++)V+=F,U+=z,F+=N,z+=L,k+=Math.sqrt(V*V+U*U),H[X]=k;V+=F,U+=z,k+=Math.sqrt(V*V+U*U),H[8]=k,V+=F+N,U+=z+L,k+=Math.sqrt(V*V+U*U),H[9]=k,j=0}for(S*=k;;j++){var Y=H[j];if(!(S>Y)){var K;0==j?S/=Y:S=j+(S-(K=H[j-1]))/(Y-K);break}}this.addCurvePosition(.1*S,T,w,E,P,I,D,R,M,h,v,s||y>0&&0==W)}return h},e.prototype.addBeforePosition=function(t,e,i,n,s){var r=e[i],o=e[i+1],a=e[i+2]-r,l=e[i+3]-o,c=Math.atan2(l,a);n[s]=r+t*Math.cos(c),n[s+1]=o+t*Math.sin(c),n[s+2]=c},e.prototype.addAfterPosition=function(t,e,i,n,s){var r=e[i+2],o=e[i+3],a=r-e[i],l=o-e[i+1],c=Math.atan2(l,a);n[s]=r+t*Math.cos(c),n[s+1]=o+t*Math.sin(c),n[s+2]=c},e.prototype.addCurvePosition=function(t,e,i,n,s,r,o,a,l,c,h,_){if(0==t||isNaN(t))return c[h]=e,c[h+1]=i,void(c[h+2]=Math.atan2(s-i,n-e));var u=t*t,m=u*t,d=1-t,p=d*d,f=p*d,g=d*t,y=3*g,v=d*y,x=y*t,S=e*f+n*v+r*x+a*m,A=i*f+s*v+o*x+l*m;c[h]=S,c[h+1]=A,_&&(c[h+2]=t<.001?Math.atan2(s-i,n-e):Math.atan2(A-(i*p+s*g*2+o*u),S-(e*p+n*g*2+r*u)))},e.NONE=-1,e.BEFORE=-2,e.AFTER=-3,e.epsilon=1e-5,e}();t.PathConstraint=e}(Q9||(Q9={})),function(t){var e,i,n,s=function(t){function e(e){var i=t.call(this,e,0,!1)||this;return i.bones=new Array,i}return ttt(e,t),e}(t.ConstraintData);t.PathConstraintData=s,(n=t.PositionMode||(t.PositionMode={}))[n.Fixed=0]="Fixed",n[n.Percent=1]="Percent",(i=t.SpacingMode||(t.SpacingMode={}))[i.Length=0]="Length",i[i.Fixed=1]="Fixed",i[i.Percent=2]="Percent",(e=t.RotateMode||(t.RotateMode={}))[e.Tangent=0]="Tangent",e[e.Chain=1]="Chain",e[e.ChainScale=2]="ChainScale"}(Q9||(Q9={})),function(t){var e=function(){function t(t){this.toLoad=new Array,this.assets={},this.clientId=t}return t.prototype.loaded=function(){var t=0;for(var e in this.assets)t++;return t},t}(),i=function(){function t(t){void 0===t&&(t=""),this.clientAssets={},this.queuedAssets={},this.rawAssets={},this.errors={},this.pathPrefix=t}return t.prototype.queueAsset=function(t,i,n){var s=this.clientAssets[t];return null==s&&(s=new e(t),this.clientAssets[t]=s),null!==i&&(s.textureLoader=i),s.toLoad.push(n),this.queuedAssets[n]!==n&&(this.queuedAssets[n]=n,!0)},t.prototype.loadText=function(t,e){var i=this;if(e=this.pathPrefix+e,this.queueAsset(t,null,e)){var n=new XMLHttpRequest;n.onreadystatechange=function(){n.readyState==XMLHttpRequest.DONE&&(n.status>=200&&n.status<300?i.rawAssets[e]=n.responseText:i.errors[e]="Couldn't load text "+e+": status "+n.status+", "+n.responseText)},n.open("GET",e,!0),n.send()}},t.prototype.loadJson=function(t,e){var i=this;if(e=this.pathPrefix+e,this.queueAsset(t,null,e)){var n=new XMLHttpRequest;n.onreadystatechange=function(){n.readyState==XMLHttpRequest.DONE&&(n.status>=200&&n.status<300?i.rawAssets[e]=JSON.parse(n.responseText):i.errors[e]="Couldn't load text "+e+": status "+n.status+", "+n.responseText)},n.open("GET",e,!0),n.send()}},t.prototype.loadTexture=function(t,e,i){var n=this;if(i=this.pathPrefix+i,this.queueAsset(t,e,i)){var s=new Image;s.src=i,s.crossOrigin="anonymous",s.onload=function(){n.rawAssets[i]=s},s.onerror=function(){n.errors[i]="Couldn't load image "+i}}},t.prototype.get=function(t,e){e=this.pathPrefix+e;var i=this.clientAssets[t];return null==i||i.assets[e]},t.prototype.updateClientAssets=function(t){for(var e=0;e<t.toLoad.length;e++){var i=t.toLoad[e];if(null==t.assets[i]){var n=this.rawAssets[i];if(null==n)continue;n instanceof HTMLImageElement?t.assets[i]=t.textureLoader(n):t.assets[i]=n}}},t.prototype.isLoadingComplete=function(t){var e=this.clientAssets[t];return null==e||(this.updateClientAssets(e),e.toLoad.length==e.loaded())},t.prototype.dispose=function(){},t.prototype.hasErrors=function(){return Object.keys(this.errors).length>0},t.prototype.getErrors=function(){return this.errors},t}();t.SharedAssetManager=i}(Q9||(Q9={})),function(t){var e=function(){function e(e){if(this._updateCache=new Array,this.updateCacheReset=new Array,this.time=0,this.scaleX=1,this.scaleY=1,this.x=0,this.y=0,null==e)throw new Error("data cannot be null.");this.data=e,this.bones=new Array;for(var i=0;i<e.bones.length;i++){var n=e.bones[i],s=void 0;if(null==n.parent)s=new t.Bone(n,this,null);else{var r=this.bones[n.parent.index];s=new t.Bone(n,this,r),r.children.push(s)}this.bones.push(s)}for(this.slots=new Array,this.drawOrder=new Array,i=0;i<e.slots.length;i++){var o=e.slots[i],a=(s=this.bones[o.boneData.index],new t.Slot(o,s));this.slots.push(a),this.drawOrder.push(a)}for(this.ikConstraints=new Array,i=0;i<e.ikConstraints.length;i++){var l=e.ikConstraints[i];this.ikConstraints.push(new t.IkConstraint(l,this))}for(this.transformConstraints=new Array,i=0;i<e.transformConstraints.length;i++){var c=e.transformConstraints[i];this.transformConstraints.push(new t.TransformConstraint(c,this))}for(this.pathConstraints=new Array,i=0;i<e.pathConstraints.length;i++){var h=e.pathConstraints[i];this.pathConstraints.push(new t.PathConstraint(h,this))}this.color=new t.Color(1,1,1,1),this.updateCache()}return e.prototype.updateCache=function(){this._updateCache.length=0,this.updateCacheReset.length=0;for(var t=this.bones,e=0,i=t.length;e<i;e++)(s=t[e]).sorted=s.data.skinRequired,s.active=!s.sorted;if(null!=this.skin){var n=this.skin.bones;for(e=0,i=this.skin.bones.length;e<i;e++){var s=this.bones[n[e].index];do{s.sorted=!1,s.active=!0,s=s.parent}while(null!=s)}}var r=this.ikConstraints,o=this.transformConstraints,a=this.pathConstraints,l=r.length,c=o.length,h=a.length,_=l+c+h;t:for(e=0;e<_;e++){for(var u=0;u<l;u++)if((m=r[u]).data.order==e){this.sortIkConstraint(m);continue t}for(u=0;u<c;u++)if((m=o[u]).data.order==e){this.sortTransformConstraint(m);continue t}for(u=0;u<h;u++){var m;if((m=a[u]).data.order==e){this.sortPathConstraint(m);continue t}}}for(e=0,i=t.length;e<i;e++)this.sortBone(t[e])},e.prototype.sortIkConstraint=function(e){if(e.active=e.target.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){var i=e.target;this.sortBone(i);var n=e.bones,s=n[0];if(this.sortBone(s),n.length>1){var r=n[n.length-1];this._updateCache.indexOf(r)>-1||this.updateCacheReset.push(r)}this._updateCache.push(e),this.sortReset(s.children),n[n.length-1].sorted=!0}},e.prototype.sortPathConstraint=function(e){if(e.active=e.target.bone.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){var i=e.target,n=i.data.index,s=i.bone;null!=this.skin&&this.sortPathConstraintAttachment(this.skin,n,s),null!=this.data.defaultSkin&&this.data.defaultSkin!=this.skin&&this.sortPathConstraintAttachment(this.data.defaultSkin,n,s);for(var r=0,o=this.data.skins.length;r<o;r++)this.sortPathConstraintAttachment(this.data.skins[r],n,s);var a=i.getAttachment();a instanceof t.PathAttachment&&this.sortPathConstraintAttachmentWith(a,s);var l=e.bones,c=l.length;for(r=0;r<c;r++)this.sortBone(l[r]);for(this._updateCache.push(e),r=0;r<c;r++)this.sortReset(l[r].children);for(r=0;r<c;r++)l[r].sorted=!0}},e.prototype.sortTransformConstraint=function(e){if(e.active=e.target.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){this.sortBone(e.target);var i=e.bones,n=i.length;if(e.data.local)for(var s=0;s<n;s++){var r=i[s];this.sortBone(r.parent),this._updateCache.indexOf(r)>-1||this.updateCacheReset.push(r)}else for(s=0;s<n;s++)this.sortBone(i[s]);this._updateCache.push(e);for(var o=0;o<n;o++)this.sortReset(i[o].children);for(o=0;o<n;o++)i[o].sorted=!0}},e.prototype.sortPathConstraintAttachment=function(t,e,i){var n=t.attachments[e];if(n)for(var s in n)this.sortPathConstraintAttachmentWith(n[s],i)},e.prototype.sortPathConstraintAttachmentWith=function(e,i){if(e instanceof t.PathAttachment){var n=e.bones;if(null==n)this.sortBone(i);else for(var s=this.bones,r=0;r<n.length;)for(var o=n[r++],a=r+o;r<a;r++){var l=n[r];this.sortBone(s[l])}}},e.prototype.sortBone=function(t){if(!t.sorted){var e=t.parent;null!=e&&this.sortBone(e),t.sorted=!0,this._updateCache.push(t)}},e.prototype.sortReset=function(t){for(var e=0,i=t.length;e<i;e++){var n=t[e];n.active&&(n.sorted&&this.sortReset(n.children),n.sorted=!1)}},e.prototype.updateWorldTransform=function(){for(var t=this.updateCacheReset,e=0,i=t.length;e<i;e++){var n=t[e];n.ax=n.x,n.ay=n.y,n.arotation=n.rotation,n.ascaleX=n.scaleX,n.ascaleY=n.scaleY,n.ashearX=n.shearX,n.ashearY=n.shearY,n.appliedValid=!0}var s=this._updateCache;for(e=0,i=s.length;e<i;e++)s[e].update()},e.prototype.setToSetupPose=function(){this.setBonesToSetupPose(),this.setSlotsToSetupPose()},e.prototype.setBonesToSetupPose=function(){for(var t=this.bones,e=0,i=t.length;e<i;e++)t[e].setToSetupPose();var n=this.ikConstraints;for(e=0,i=n.length;e<i;e++)(a=n[e]).mix=a.data.mix,a.softness=a.data.softness,a.bendDirection=a.data.bendDirection,a.compress=a.data.compress,a.stretch=a.data.stretch;var s=this.transformConstraints;for(e=0,i=s.length;e<i;e++){var r=(a=s[e]).data;a.rotateMix=r.rotateMix,a.translateMix=r.translateMix,a.scaleMix=r.scaleMix,a.shearMix=r.shearMix}var o=this.pathConstraints;for(e=0,i=o.length;e<i;e++){var a;r=(a=o[e]).data,a.position=r.position,a.spacing=r.spacing,a.rotateMix=r.rotateMix,a.translateMix=r.translateMix}},e.prototype.setSlotsToSetupPose=function(){var e=this.slots;t.Utils.arrayCopy(e,0,this.drawOrder,0,e.length);for(var i=0,n=e.length;i<n;i++)e[i].setToSetupPose()},e.prototype.getRootBone=function(){return 0==this.bones.length?null:this.bones[0]},e.prototype.findBone=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.findBoneIndex=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,i=0,n=e.length;i<n;i++)if(e[i].data.name==t)return i;return-1},e.prototype.findSlot=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.findSlotIndex=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,i=0,n=e.length;i<n;i++)if(e[i].data.name==t)return i;return-1},e.prototype.setSkinByName=function(t){var e=this.data.findSkin(t);if(null==e)throw new Error("Skin not found: "+t);this.setSkin(e)},e.prototype.setSkin=function(t){if(t!=this.skin){if(null!=t)if(null!=this.skin)t.attachAll(this,this.skin);else for(var e=this.slots,i=0,n=e.length;i<n;i++){var s=e[i],r=s.data.attachmentName;if(null!=r){var o=t.getAttachment(i,r);null!=o&&s.setAttachment(o)}}this.skin=t,this.updateCache()}},e.prototype.getAttachmentByName=function(t,e){return this.getAttachment(this.data.findSlotIndex(t),e)},e.prototype.getAttachment=function(t,e){if(null==e)throw new Error("attachmentName cannot be null.");if(null!=this.skin){var i=this.skin.getAttachment(t,e);if(null!=i)return i}return null!=this.data.defaultSkin?this.data.defaultSkin.getAttachment(t,e):null},e.prototype.setAttachment=function(t,e){if(null==t)throw new Error("slotName cannot be null.");for(var i=this.slots,n=0,s=i.length;n<s;n++){var r=i[n];if(r.data.name==t){var o=null;if(null!=e&&null==(o=this.getAttachment(n,e)))throw new Error("Attachment not found: "+e+", for slot: "+t);return void r.setAttachment(o)}}throw new Error("Slot not found: "+t)},e.prototype.findIkConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.ikConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.findTransformConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.transformConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.findPathConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.pathConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.getBounds=function(e,i,n){if(void 0===n&&(n=new Array(2)),null==e)throw new Error("offset cannot be null.");if(null==i)throw new Error("size cannot be null.");for(var s=this.drawOrder,r=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY,c=0,h=s.length;c<h;c++){var _=s[c];if(_.bone.active){var u=0,m=null,d=_.getAttachment();if(d instanceof t.RegionAttachment)u=8,m=t.Utils.setArraySize(n,u,0),d.computeWorldVertices(_.bone,m,0,2);else if(d instanceof t.MeshAttachment){var p=d;u=p.worldVerticesLength,m=t.Utils.setArraySize(n,u,0),p.computeWorldVertices(_,0,u,m,0,2)}if(null!=m)for(var f=0,g=m.length;f<g;f+=2){var y=m[f],v=m[f+1];r=Math.min(r,y),o=Math.min(o,v),a=Math.max(a,y),l=Math.max(l,v)}}}e.set(r,o),i.set(a-r,l-o)},e.prototype.update=function(t){this.time+=t},e}();t.Skeleton=e}(Q9||(Q9={})),function(t){var e=function(){function e(t){this.scale=1,this.linkedMeshes=new Array,this.attachmentLoader=t}return e.prototype.readSkeletonData=function(n){var s=this.scale,r=new t.SkeletonData;r.name="";var o=new i(n);r.hash=o.readString(),r.version=o.readString(),r.x=o.readFloat(),r.y=o.readFloat(),r.width=o.readFloat(),r.height=o.readFloat();var a=o.readBoolean();a&&(r.fps=o.readFloat(),r.imagesPath=o.readString(),r.audioPath=o.readString());var l=0;l=o.readInt(!0);for(var c=0;c<l;c++)o.strings.push(o.readString());for(l=o.readInt(!0),c=0;c<l;c++){var h=o.readString(),_=0==c?null:r.bones[o.readInt(!0)];(d=new t.BoneData(c,h,_)).rotation=o.readFloat(),d.x=o.readFloat()*s,d.y=o.readFloat()*s,d.scaleX=o.readFloat(),d.scaleY=o.readFloat(),d.shearX=o.readFloat(),d.shearY=o.readFloat(),d.length=o.readFloat()*s,d.transformMode=e.TransformModeValues[o.readInt(!0)],d.skinRequired=o.readBoolean(),a&&t.Color.rgba8888ToColor(d.color,o.readInt32()),r.bones.push(d)}for(l=o.readInt(!0),c=0;c<l;c++){var u=o.readString(),m=r.bones[o.readInt(!0)],d=new t.SlotData(c,u,m);t.Color.rgba8888ToColor(d.color,o.readInt32());var p=o.readInt32();-1!=p&&t.Color.rgb888ToColor(d.darkColor=new t.Color,p),d.attachmentName=o.readStringRef(),d.blendMode=e.BlendModeValues[o.readInt(!0)],r.slots.push(d)}l=o.readInt(!0),c=0;for(var f=void 0;c<l;c++){(d=new t.IkConstraintData(o.readString())).order=o.readInt(!0),d.skinRequired=o.readBoolean(),f=o.readInt(!0);for(var g=0;g<f;g++)d.bones.push(r.bones[o.readInt(!0)]);d.target=r.bones[o.readInt(!0)],d.mix=o.readFloat(),d.softness=o.readFloat()*s,d.bendDirection=o.readByte(),d.compress=o.readBoolean(),d.stretch=o.readBoolean(),d.uniform=o.readBoolean(),r.ikConstraints.push(d)}for(l=o.readInt(!0),c=0,f=void 0;c<l;c++){for((d=new t.TransformConstraintData(o.readString())).order=o.readInt(!0),d.skinRequired=o.readBoolean(),f=o.readInt(!0),g=0;g<f;g++)d.bones.push(r.bones[o.readInt(!0)]);d.target=r.bones[o.readInt(!0)],d.local=o.readBoolean(),d.relative=o.readBoolean(),d.offsetRotation=o.readFloat(),d.offsetX=o.readFloat()*s,d.offsetY=o.readFloat()*s,d.offsetScaleX=o.readFloat(),d.offsetScaleY=o.readFloat(),d.offsetShearY=o.readFloat(),d.rotateMix=o.readFloat(),d.translateMix=o.readFloat(),d.scaleMix=o.readFloat(),d.shearMix=o.readFloat(),r.transformConstraints.push(d)}for(l=o.readInt(!0),c=0,f=void 0;c<l;c++){for((d=new t.PathConstraintData(o.readString())).order=o.readInt(!0),d.skinRequired=o.readBoolean(),f=o.readInt(!0),g=0;g<f;g++)d.bones.push(r.bones[o.readInt(!0)]);d.target=r.slots[o.readInt(!0)],d.positionMode=e.PositionModeValues[o.readInt(!0)],d.spacingMode=e.SpacingModeValues[o.readInt(!0)],d.rotateMode=e.RotateModeValues[o.readInt(!0)],d.offsetRotation=o.readFloat(),d.position=o.readFloat(),d.positionMode==t.PositionMode.Fixed&&(d.position*=s),d.spacing=o.readFloat(),d.spacingMode!=t.SpacingMode.Length&&d.spacingMode!=t.SpacingMode.Fixed||(d.spacing*=s),d.rotateMix=o.readFloat(),d.translateMix=o.readFloat(),r.pathConstraints.push(d)}var y=this.readSkin(o,r,!0,a);for(null!=y&&(r.defaultSkin=y,r.skins.push(y)),c=r.skins.length,t.Utils.setArraySize(r.skins,l=c+o.readInt(!0));c<l;c++)r.skins[c]=this.readSkin(o,r,!1,a);for(l=this.linkedMeshes.length,c=0;c<l;c++){var v=this.linkedMeshes[c],x=null==v.skin?r.defaultSkin:r.findSkin(v.skin);if(null==x)throw new Error("Skin not found: "+v.skin);var S=x.getAttachment(v.slotIndex,v.parent);if(null==S)throw new Error("Parent mesh not found: "+v.parent);v.mesh.deformAttachment=v.inheritDeform?S:v.mesh,v.mesh.setParentMesh(S),v.mesh.updateUVs()}for(this.linkedMeshes.length=0,l=o.readInt(!0),c=0;c<l;c++)(d=new t.EventData(o.readStringRef())).intValue=o.readInt(!1),d.floatValue=o.readFloat(),d.stringValue=o.readString(),d.audioPath=o.readString(),null!=d.audioPath&&(d.volume=o.readFloat(),d.balance=o.readFloat()),r.events.push(d);for(l=o.readInt(!0),c=0;c<l;c++)r.animations.push(this.readAnimation(o,o.readString(),r));return r},e.prototype.readSkin=function(e,i,n,s){var r=null,o=0;if(n){if(0==(o=e.readInt(!0)))return null;r=new t.Skin("default")}else{(r=new t.Skin(e.readStringRef())).bones.length=e.readInt(!0);for(var a=0,l=r.bones.length;a<l;a++)r.bones[a]=i.bones[e.readInt(!0)];for(a=0,l=e.readInt(!0);a<l;a++)r.constraints.push(i.ikConstraints[e.readInt(!0)]);for(a=0,l=e.readInt(!0);a<l;a++)r.constraints.push(i.transformConstraints[e.readInt(!0)]);for(a=0,l=e.readInt(!0);a<l;a++)r.constraints.push(i.pathConstraints[e.readInt(!0)]);o=e.readInt(!0)}for(a=0;a<o;a++)for(var c=e.readInt(!0),h=0,_=e.readInt(!0);h<_;h++){var u=e.readStringRef(),m=this.readAttachment(e,i,r,c,u,s);null!=m&&r.setAttachment(c,u,m)}return r},e.prototype.readAttachment=function(i,s,r,o,a,l){var c=this.scale,h=i.readStringRef();null==h&&(h=a);var _=i.readByte();switch(e.AttachmentTypeValues[_]){case t.AttachmentType.Region:var u=i.readStringRef(),m=i.readFloat(),d=i.readFloat(),p=i.readFloat(),f=i.readFloat(),g=i.readFloat(),y=i.readFloat(),v=i.readFloat(),x=i.readInt32();null==u&&(u=h);var S=this.attachmentLoader.newRegionAttachment(r,h,u);return null==S?null:(S.path=u,S.x=d*c,S.y=p*c,S.scaleX=f,S.scaleY=g,S.rotation=m,S.width=y*c,S.height=v*c,t.Color.rgba8888ToColor(S.color,x),S.updateOffset(),S);case t.AttachmentType.BoundingBox:var A=i.readInt(!0),C=this.readVertices(i,A),b=(x=l?i.readInt32():0,this.attachmentLoader.newBoundingBoxAttachment(r,h));return null==b?null:(b.worldVerticesLength=A<<1,b.vertices=C.vertices,b.bones=C.bones,l&&t.Color.rgba8888ToColor(b.color,x),b);case t.AttachmentType.Mesh:u=i.readStringRef(),x=i.readInt32(),A=i.readInt(!0);var T=this.readFloatArray(i,A<<1,1),w=this.readShortArray(i),E=(C=this.readVertices(i,A),i.readInt(!0)),P=null;return y=0,v=0,l&&(P=this.readShortArray(i),y=i.readFloat(),v=i.readFloat()),null==u&&(u=h),null==(I=this.attachmentLoader.newMeshAttachment(r,h,u))?null:(I.path=u,t.Color.rgba8888ToColor(I.color,x),I.bones=C.bones,I.vertices=C.vertices,I.worldVerticesLength=A<<1,I.triangles=w,I.regionUVs=T,I.updateUVs(),I.hullLength=E<<1,l&&(I.edges=P,I.width=y*c,I.height=v*c),I);case t.AttachmentType.LinkedMesh:u=i.readStringRef(),x=i.readInt32();var I,D=i.readStringRef(),R=i.readStringRef(),M=i.readBoolean();return y=0,v=0,l&&(y=i.readFloat(),v=i.readFloat()),null==u&&(u=h),null==(I=this.attachmentLoader.newMeshAttachment(r,h,u))?null:(I.path=u,t.Color.rgba8888ToColor(I.color,x),l&&(I.width=y*c,I.height=v*c),this.linkedMeshes.push(new n(I,D,o,R,M)),I);case t.AttachmentType.Path:for(var B=i.readBoolean(),O=i.readBoolean(),N=(A=i.readInt(!0),C=this.readVertices(i,A),t.Utils.newArray(A/3,0)),L=0,F=N.length;L<F;L++)N[L]=i.readFloat()*c;return x=l?i.readInt32():0,null==(u=this.attachmentLoader.newPathAttachment(r,h))?null:(u.closed=B,u.constantSpeed=O,u.worldVerticesLength=A<<1,u.vertices=C.vertices,u.bones=C.bones,u.lengths=N,l&&t.Color.rgba8888ToColor(u.color,x),u);case t.AttachmentType.Point:m=i.readFloat(),d=i.readFloat(),p=i.readFloat(),x=l?i.readInt32():0;var z=this.attachmentLoader.newPointAttachment(r,h);return null==z?null:(z.x=d*c,z.y=p*c,z.rotation=m,l&&t.Color.rgba8888ToColor(z.color,x),z);case t.AttachmentType.Clipping:var V=i.readInt(!0),U=(A=i.readInt(!0),C=this.readVertices(i,A),x=l?i.readInt32():0,this.attachmentLoader.newClippingAttachment(r,h));return null==U?null:(U.endSlot=s.slots[V],U.worldVerticesLength=A<<1,U.vertices=C.vertices,U.bones=C.bones,l&&t.Color.rgba8888ToColor(U.color,x),U)}return null},e.prototype.readVertices=function(e,i){var n=i<<1,r=new s,o=this.scale;if(!e.readBoolean())return r.vertices=this.readFloatArray(e,n,o),r;for(var a=new Array,l=new Array,c=0;c<i;c++){var h=e.readInt(!0);l.push(h);for(var _=0;_<h;_++)l.push(e.readInt(!0)),a.push(e.readFloat()*o),a.push(e.readFloat()*o),a.push(e.readFloat())}return r.vertices=t.Utils.toFloatArray(a),r.bones=l,r},e.prototype.readFloatArray=function(t,e,i){var n=new Array(e);if(1==i)for(var s=0;s<e;s++)n[s]=t.readFloat();else for(s=0;s<e;s++)n[s]=t.readFloat()*i;return n},e.prototype.readShortArray=function(t){for(var e=t.readInt(!0),i=new Array(e),n=0;n<e;n++)i[n]=t.readShort();return i},e.prototype.readAnimation=function(i,n,s){for(var r=new Array,o=this.scale,a=0,l=new t.Color,c=new t.Color,h=0,_=i.readInt(!0);h<_;h++)for(var u=i.readInt(!0),m=0,d=i.readInt(!0);m<d;m++){var p=i.readByte(),f=i.readInt(!0);switch(p){case e.SLOT_ATTACHMENT:(x=new t.AttachmentTimeline(f)).slotIndex=u;for(var g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readStringRef());r.push(x),a=Math.max(a,x.frames[f-1]);break;case e.SLOT_COLOR:for((x=new t.ColorTimeline(f)).slotIndex=u,g=0;g<f;g++){var y=i.readFloat();t.Color.rgba8888ToColor(l,i.readInt32()),x.setFrame(g,y,l.r,l.g,l.b,l.a),g<f-1&&this.readCurve(i,g,x)}r.push(x),a=Math.max(a,x.frames[(f-1)*t.ColorTimeline.ENTRIES]);break;case e.SLOT_TWO_COLOR:for((x=new t.TwoColorTimeline(f)).slotIndex=u,g=0;g<f;g++)y=i.readFloat(),t.Color.rgba8888ToColor(l,i.readInt32()),t.Color.rgb888ToColor(c,i.readInt32()),x.setFrame(g,y,l.r,l.g,l.b,l.a,c.r,c.g,c.b),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.TwoColorTimeline.ENTRIES])}}for(h=0,_=i.readInt(!0);h<_;h++){var v=i.readInt(!0);for(m=0,d=i.readInt(!0);m<d;m++)switch(p=i.readByte(),f=i.readInt(!0),p){case e.BONE_ROTATE:for((x=new t.RotateTimeline(f)).boneIndex=v,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat()),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.RotateTimeline.ENTRIES]);break;case e.BONE_TRANSLATE:case e.BONE_SCALE:case e.BONE_SHEAR:var x=void 0,S=1;for(p==e.BONE_SCALE?x=new t.ScaleTimeline(f):p==e.BONE_SHEAR?x=new t.ShearTimeline(f):(x=new t.TranslateTimeline(f),S=o),x.boneIndex=v,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat()*S,i.readFloat()*S),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.TranslateTimeline.ENTRIES])}}for(h=0,_=i.readInt(!0);h<_;h++){var A=i.readInt(!0);for(f=i.readInt(!0),(x=new t.IkConstraintTimeline(f)).ikConstraintIndex=A,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat(),i.readFloat()*o,i.readByte(),i.readBoolean(),i.readBoolean()),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.IkConstraintTimeline.ENTRIES])}for(h=0,_=i.readInt(!0);h<_;h++){for(A=i.readInt(!0),f=i.readInt(!0),(x=new t.TransformConstraintTimeline(f)).transformConstraintIndex=A,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat(),i.readFloat(),i.readFloat(),i.readFloat()),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.TransformConstraintTimeline.ENTRIES])}for(h=0,_=i.readInt(!0);h<_;h++){A=i.readInt(!0);var C=s.pathConstraints[A];for(m=0,d=i.readInt(!0);m<d;m++)switch(p=i.readByte(),f=i.readInt(!0),p){case e.PATH_POSITION:case e.PATH_SPACING:for(x=void 0,S=1,p==e.PATH_SPACING?(x=new t.PathConstraintSpacingTimeline(f),C.spacingMode!=t.SpacingMode.Length&&C.spacingMode!=t.SpacingMode.Fixed||(S=o)):(x=new t.PathConstraintPositionTimeline(f),C.positionMode==t.PositionMode.Fixed&&(S=o)),x.pathConstraintIndex=A,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat()*S),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.PathConstraintPositionTimeline.ENTRIES]);break;case e.PATH_MIX:for((x=new t.PathConstraintMixTimeline(f)).pathConstraintIndex=A,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat(),i.readFloat()),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.PathConstraintMixTimeline.ENTRIES])}}for(h=0,_=i.readInt(!0);h<_;h++){var b=s.skins[i.readInt(!0)];for(m=0,d=i.readInt(!0);m<d;m++){u=i.readInt(!0);for(var T=0,w=i.readInt(!0);T<w;T++){var E=b.getAttachment(u,i.readStringRef()),P=null!=E.bones,I=E.vertices,D=P?I.length/3*2:I.length;for(f=i.readInt(!0),(x=new t.DeformTimeline(f)).slotIndex=u,x.attachment=E,g=0;g<f;g++){y=i.readFloat();var R=void 0,M=i.readInt(!0);if(0==M)R=P?t.Utils.newFloatArray(D):I;else{R=t.Utils.newFloatArray(D);var B=i.readInt(!0);if(M+=B,1==o)for(var O=B;O<M;O++)R[O]=i.readFloat();else for(O=B;O<M;O++)R[O]=i.readFloat()*o;if(!P){O=0;for(var N=R.length;O<N;O++)R[O]+=I[O]}}x.setFrame(g,y,R),g<f-1&&this.readCurve(i,g,x)}r.push(x),a=Math.max(a,x.frames[f-1])}}}var L=i.readInt(!0);if(L>0){x=new t.DrawOrderTimeline(L);var F=s.slots.length;for(h=0;h<L;h++){y=i.readFloat();var z=i.readInt(!0),V=t.Utils.newArray(F,0);for(m=F-1;m>=0;m--)V[m]=-1;var U=t.Utils.newArray(F-z,0),G=0,H=0;for(m=0;m<z;m++){for(u=i.readInt(!0);G!=u;)U[H++]=G++;V[G+i.readInt(!0)]=G++}for(;G<F;)U[H++]=G++;for(m=F-1;m>=0;m--)-1==V[m]&&(V[m]=U[--H]);x.setFrame(h,y,V)}r.push(x),a=Math.max(a,x.frames[L-1])}var k=i.readInt(!0);if(k>0){for(x=new t.EventTimeline(k),h=0;h<k;h++){y=i.readFloat();var j=s.events[i.readInt(!0)],W=new t.Event(y,j);W.intValue=i.readInt(!1),W.floatValue=i.readFloat(),W.stringValue=i.readBoolean()?i.readString():j.stringValue,null!=W.data.audioPath&&(W.volume=i.readFloat(),W.balance=i.readFloat()),x.setFrame(h,W)}r.push(x),a=Math.max(a,x.frames[k-1])}return new t.Animation(n,r,a)},e.prototype.readCurve=function(t,i,n){switch(t.readByte()){case e.CURVE_STEPPED:n.setStepped(i);break;case e.CURVE_BEZIER:this.setCurve(n,i,t.readFloat(),t.readFloat(),t.readFloat(),t.readFloat())}},e.prototype.setCurve=function(t,e,i,n,s,r){t.setCurve(e,i,n,s,r)},e.AttachmentTypeValues=[0,1,2,3,4,5,6],e.TransformModeValues=[t.TransformMode.Normal,t.TransformMode.OnlyTranslation,t.TransformMode.NoRotationOrReflection,t.TransformMode.NoScale,t.TransformMode.NoScaleOrReflection],e.PositionModeValues=[t.PositionMode.Fixed,t.PositionMode.Percent],e.SpacingModeValues=[t.SpacingMode.Length,t.SpacingMode.Fixed,t.SpacingMode.Percent],e.RotateModeValues=[t.RotateMode.Tangent,t.RotateMode.Chain,t.RotateMode.ChainScale],e.BlendModeValues=[t.BlendMode.Normal,t.BlendMode.Additive,t.BlendMode.Multiply,t.BlendMode.Screen],e.BONE_ROTATE=0,e.BONE_TRANSLATE=1,e.BONE_SCALE=2,e.BONE_SHEAR=3,e.SLOT_ATTACHMENT=0,e.SLOT_COLOR=1,e.SLOT_TWO_COLOR=2,e.PATH_POSITION=0,e.PATH_SPACING=1,e.PATH_MIX=2,e.CURVE_LINEAR=0,e.CURVE_STEPPED=1,e.CURVE_BEZIER=2,e}();t.SkeletonBinary=e;var i=function(){function t(t,e,i,n){void 0===e&&(e=new Array),void 0===i&&(i=0),void 0===n&&(n=new DataView(t.buffer)),this.strings=e,this.index=i,this.buffer=n}return t.prototype.readByte=function(){return this.buffer.getInt8(this.index++)},t.prototype.readShort=function(){var t=this.buffer.getInt16(this.index);return this.index+=2,t},t.prototype.readInt32=function(){var t=this.buffer.getInt32(this.index);return this.index+=4,t},t.prototype.readInt=function(t){var e=this.readByte(),i=127&e;return 0!=(128&e)&&(i|=(127&(e=this.readByte()))<<7,0!=(128&e)&&(i|=(127&(e=this.readByte()))<<14,0!=(128&e)&&(i|=(127&(e=this.readByte()))<<21,0!=(128&e)&&(i|=(127&(e=this.readByte()))<<28)))),t?i:i>>>1^-(1&i)},t.prototype.readStringRef=function(){var t=this.readInt(!0);return 0==t?null:this.strings[t-1]},t.prototype.readString=function(){var t=this.readInt(!0);switch(t){case 0:return null;case 1:return""}t--;for(var e="",i=0;i<t;){var n=this.readByte();switch(n>>4){case 12:case 13:e+=String.fromCharCode((31&n)<<6|63&this.readByte()),i+=2;break;case 14:e+=String.fromCharCode((15&n)<<12|(63&this.readByte())<<6|63&this.readByte()),i+=3;break;default:e+=String.fromCharCode(n),i++}}return e},t.prototype.readFloat=function(){var t=this.buffer.getFloat32(this.index);return this.index+=4,t},t.prototype.readBoolean=function(){return 0!=this.readByte()},t}(),n=function(t,e,i,n,s){this.mesh=t,this.skin=e,this.slotIndex=i,this.parent=n,this.inheritDeform=s},s=function(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this.bones=t,this.vertices=e}}(Q9||(Q9={})),function(t){var e=function(){function e(){this.minX=0,this.minY=0,this.maxX=0,this.maxY=0,this.boundingBoxes=new Array,this.polygons=new Array,this.polygonPool=new t.Pool((function(){return t.Utils.newFloatArray(16)}))}return e.prototype.update=function(e,i){if(null==e)throw new Error("skeleton cannot be null.");var n=this.boundingBoxes,s=this.polygons,r=this.polygonPool,o=e.slots,a=o.length;n.length=0,r.freeAll(s),s.length=0;for(var l=0;l<a;l++){var c=o[l];if(c.bone.active){var h=c.getAttachment();if(h instanceof t.BoundingBoxAttachment){var _=h;n.push(_);var u=r.obtain();u.length!=_.worldVerticesLength&&(u=t.Utils.newFloatArray(_.worldVerticesLength)),s.push(u),_.computeWorldVertices(c,0,_.worldVerticesLength,u,0,2)}}}i?this.aabbCompute():(this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY)},e.prototype.aabbCompute=function(){for(var t=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,n=Number.NEGATIVE_INFINITY,s=this.polygons,r=0,o=s.length;r<o;r++)for(var a=s[r],l=a,c=0,h=a.length;c<h;c+=2){var _=l[c],u=l[c+1];t=Math.min(t,_),e=Math.min(e,u),i=Math.max(i,_),n=Math.max(n,u)}this.minX=t,this.minY=e,this.maxX=i,this.maxY=n},e.prototype.aabbContainsPoint=function(t,e){return t>=this.minX&&t<=this.maxX&&e>=this.minY&&e<=this.maxY},e.prototype.aabbIntersectsSegment=function(t,e,i,n){var s=this.minX,r=this.minY,o=this.maxX,a=this.maxY;if(t<=s&&i<=s||e<=r&&n<=r||t>=o&&i>=o||e>=a&&n>=a)return!1;var l=(n-e)/(i-t),c=l*(s-t)+e;if(c>r&&c<a)return!0;if((c=l*(o-t)+e)>r&&c<a)return!0;var h=(r-e)/l+t;return h>s&&h<o||(h=(a-e)/l+t)>s&&h<o},e.prototype.aabbIntersectsSkeleton=function(t){return this.minX<t.maxX&&this.maxX>t.minX&&this.minY<t.maxY&&this.maxY>t.minY},e.prototype.containsPoint=function(t,e){for(var i=this.polygons,n=0,s=i.length;n<s;n++)if(this.containsPointPolygon(i[n],t,e))return this.boundingBoxes[n];return null},e.prototype.containsPointPolygon=function(t,e,i){for(var n=t,s=t.length,r=s-2,o=!1,a=0;a<s;a+=2){var l=n[a+1],c=n[r+1];if(l<i&&c>=i||c<i&&l>=i){var h=n[a];h+(i-l)/(c-l)*(n[r]-h)<e&&(o=!o)}r=a}return o},e.prototype.intersectsSegment=function(t,e,i,n){for(var s=this.polygons,r=0,o=s.length;r<o;r++)if(this.intersectsSegmentPolygon(s[r],t,e,i,n))return this.boundingBoxes[r];return null},e.prototype.intersectsSegmentPolygon=function(t,e,i,n,s){for(var r=t,o=t.length,a=e-n,l=i-s,c=e*s-i*n,h=r[o-2],_=r[o-1],u=0;u<o;u+=2){var m=r[u],d=r[u+1],p=h*d-_*m,f=h-m,g=_-d,y=a*g-l*f,v=(c*f-a*p)/y;if((v>=h&&v<=m||v>=m&&v<=h)&&(v>=e&&v<=n||v>=n&&v<=e)){var x=(c*g-l*p)/y;if((x>=_&&x<=d||x>=d&&x<=_)&&(x>=i&&x<=s||x>=s&&x<=i))return!0}h=m,_=d}return!1},e.prototype.getPolygon=function(t){if(null==t)throw new Error("boundingBox cannot be null.");var e=this.boundingBoxes.indexOf(t);return-1==e?null:this.polygons[e]},e.prototype.getWidth=function(){return this.maxX-this.minX},e.prototype.getHeight=function(){return this.maxY-this.minY},e}();t.SkeletonBounds=e}(Q9||(Q9={})),function(t){var e=function(){function e(){this.triangulator=new t.Triangulator,this.clippingPolygon=new Array,this.clipOutput=new Array,this.clippedVertices=new Array,this.clippedTriangles=new Array,this.scratch=new Array}return e.prototype.clipStart=function(i,n){if(null!=this.clipAttachment)return 0;this.clipAttachment=n;var s=n.worldVerticesLength,r=t.Utils.setArraySize(this.clippingPolygon,s);n.computeWorldVertices(i,0,s,r,0,2);var o=this.clippingPolygon;e.makeClockwise(o);for(var a=this.clippingPolygons=this.triangulator.decompose(o,this.triangulator.triangulate(o)),l=0,c=a.length;l<c;l++){var h=a[l];e.makeClockwise(h),h.push(h[0]),h.push(h[1])}return a.length},e.prototype.clipEndWithSlot=function(t){null!=this.clipAttachment&&this.clipAttachment.endSlot==t.data&&this.clipEnd()},e.prototype.clipEnd=function(){null!=this.clipAttachment&&(this.clipAttachment=null,this.clippingPolygons=null,this.clippedVertices.length=0,this.clippedTriangles.length=0,this.clippingPolygon.length=0)},e.prototype.isClipping=function(){return null!=this.clipAttachment},e.prototype.clipTriangles=function(e,i,n,s,r,o,a,l,c,h,_){void 0===c&&(c=2),void 0===h&&(h=0),void 0===_&&(_=0);var u=this.clipOutput,m=this.clippedVertices,d=this.clippedTriangles,p=this.clippingPolygons,f=this.clippingPolygons.length,g=l?12:8,y=0;m.length=0,d.length=0;t:for(var v=0;v<s;v+=3)for(var x=n[v]*c,S=e[x+h],A=e[x+h+1],C=r[x+_],b=r[x+_+1],T=e[(x=n[v+1]*c)+h],w=e[x+h+1],E=r[x+_],P=r[x+_+1],I=e[(x=n[v+2]*c)+h],D=e[x+h+1],R=r[x+_],M=r[x+_+1],B=0;B<f;B++){var O=m.length;if(!this.clip(S,A,T,w,I,D,p[B],u)){(k=t.Utils.setArraySize(m,O+3*g))[O]=S,k[O+1]=A,k[O+2]=o.r,k[O+3]=o.g,k[O+4]=o.b,k[O+5]=o.a,l?(k[O+6]=C,k[O+7]=b,k[O+8]=a.r,k[O+9]=a.g,k[O+10]=a.b,k[O+11]=a.a,k[O+12]=T,k[O+13]=w,k[O+14]=o.r,k[O+15]=o.g,k[O+16]=o.b,k[O+17]=o.a,k[O+18]=E,k[O+19]=P,k[O+20]=a.r,k[O+21]=a.g,k[O+22]=a.b,k[O+23]=a.a,k[O+24]=I,k[O+25]=D,k[O+26]=o.r,k[O+27]=o.g,k[O+28]=o.b,k[O+29]=o.a,k[O+30]=R,k[O+31]=M,k[O+32]=a.r,k[O+33]=a.g,k[O+34]=a.b,k[O+35]=a.a):(k[O+6]=C,k[O+7]=b,k[O+8]=T,k[O+9]=w,k[O+10]=o.r,k[O+11]=o.g,k[O+12]=o.b,k[O+13]=o.a,k[O+14]=E,k[O+15]=P,k[O+16]=I,k[O+17]=D,k[O+18]=o.r,k[O+19]=o.g,k[O+20]=o.b,k[O+21]=o.a,k[O+22]=R,k[O+23]=M),O=d.length,(Z=t.Utils.setArraySize(d,O+3))[O]=y,Z[O+1]=y+1,Z[O+2]=y+2,y+=3;continue t}var N=u.length;if(0!=N){for(var L=w-D,F=I-T,z=S-I,V=D-A,U=1/(L*z+F*(A-D)),G=N>>1,H=this.clipOutput,k=t.Utils.setArraySize(m,O+G*g),j=0;j<N;j+=2){var W=H[j],q=H[j+1];k[O]=W,k[O+1]=q,k[O+2]=o.r,k[O+3]=o.g,k[O+4]=o.b,k[O+5]=o.a;var X=W-I,Y=q-D,K=(L*X+F*Y)*U,J=(V*X+z*Y)*U,$=1-K-J;k[O+6]=C*K+E*J+R*$,k[O+7]=b*K+P*J+M*$,l&&(k[O+8]=a.r,k[O+9]=a.g,k[O+10]=a.b,k[O+11]=a.a),O+=g}O=d.length;var Z=t.Utils.setArraySize(d,O+3*(G-2));for(G--,j=1;j<G;j++)Z[O]=y,Z[O+1]=y+j,Z[O+2]=y+j+1,O+=3;y+=G+1}}},e.prototype.clip=function(t,e,i,n,s,r,o,a){var l=a,c=!1,h=null;o.length%4>=2?(h=a,a=this.scratch):h=this.scratch,h.length=0,h.push(t),h.push(e),h.push(i),h.push(n),h.push(s),h.push(r),h.push(t),h.push(e),a.length=0;for(var _=o,u=o.length-4,m=0;;m+=2){for(var d=_[m],p=_[m+1],f=_[m+2],g=_[m+3],y=d-f,v=p-g,x=h,S=h.length-2,A=a.length,C=0;C<S;C+=2){var b=x[C],T=x[C+1],w=x[C+2],E=x[C+3],P=y*(E-g)-v*(w-f)>0;if(y*(T-g)-v*(b-f)>0){if(P){a.push(w),a.push(E);continue}var I=(R=E-T)*(f-d)-(M=w-b)*(g-p);if(Math.abs(I)>1e-6){var D=(M*(p-T)-R*(d-b))/I;a.push(d+(f-d)*D),a.push(p+(g-p)*D)}else a.push(d),a.push(p)}else if(P){var R,M;I=(R=E-T)*(f-d)-(M=w-b)*(g-p),Math.abs(I)>1e-6?(D=(M*(p-T)-R*(d-b))/I,a.push(d+(f-d)*D),a.push(p+(g-p)*D)):(a.push(d),a.push(p)),a.push(w),a.push(E)}c=!0}if(A==a.length)return l.length=0,!0;if(a.push(a[0]),a.push(a[1]),m==u)break;var B=a;(a=h).length=0,h=B}if(l!=a){l.length=0,m=0;for(var O=a.length-2;m<O;m++)l[m]=a[m]}else l.length=l.length-2;return c},e.makeClockwise=function(t){for(var e=t,i=t.length,n=e[i-2]*e[1]-e[0]*e[i-1],s=0,r=0,o=0,a=0,l=i-3;a<l;a+=2)s=e[a],r=e[a+1],o=e[a+2],n+=s*e[a+3]-o*r;if(!(n<0)){a=0;var c=i-2;for(l=i>>1;a<l;a+=2){var h=e[a],_=e[a+1],u=c-a;e[a]=e[u],e[a+1]=e[u+1],e[u]=h,e[u+1]=_}}},e}();t.SkeletonClipping=e}(Q9||(Q9={})),function(t){var e=function(){function t(){this.bones=new Array,this.slots=new Array,this.skins=new Array,this.events=new Array,this.animations=new Array,this.ikConstraints=new Array,this.transformConstraints=new Array,this.pathConstraints=new Array,this.fps=0}return t.prototype.findBone=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findBoneIndex=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,i=0,n=e.length;i<n;i++)if(e[i].name==t)return i;return-1},t.prototype.findSlot=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findSlotIndex=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,i=0,n=e.length;i<n;i++)if(e[i].name==t)return i;return-1},t.prototype.findSkin=function(t){if(null==t)throw new Error("skinName cannot be null.");for(var e=this.skins,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findEvent=function(t){if(null==t)throw new Error("eventDataName cannot be null.");for(var e=this.events,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findAnimation=function(t){if(null==t)throw new Error("animationName cannot be null.");for(var e=this.animations,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findIkConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.ikConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findTransformConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.transformConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findPathConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.pathConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findPathConstraintIndex=function(t){if(null==t)throw new Error("pathConstraintName cannot be null.");for(var e=this.pathConstraints,i=0,n=e.length;i<n;i++)if(e[i].name==t)return i;return-1},t}();t.SkeletonData=e}(Q9||(Q9={})),function(t){var e=function(){function e(t){this.scale=1,this.linkedMeshes=new Array,this.attachmentLoader=t}return e.prototype.readSkeletonData=function(i){var n=this.scale,s=new t.SkeletonData,r="string"==typeof i?JSON.parse(i):i,o=r.skeleton;if(null!=o&&(s.hash=o.hash,s.version=o.spine,s.x=o.x,s.y=o.y,s.width=o.width,s.height=o.height,s.fps=o.fps,s.imagesPath=o.images),r.bones)for(var a=0;a<r.bones.length;a++){var l=r.bones[a],c=null,h=this.getValue(l,"parent",null);if(null!=h&&null==(c=s.findBone(h)))throw new Error("Parent bone not found: "+h);(d=new t.BoneData(s.bones.length,l.name,c)).length=this.getValue(l,"length",0)*n,d.x=this.getValue(l,"x",0)*n,d.y=this.getValue(l,"y",0)*n,d.rotation=this.getValue(l,"rotation",0),d.scaleX=this.getValue(l,"scaleX",1),d.scaleY=this.getValue(l,"scaleY",1),d.shearX=this.getValue(l,"shearX",0),d.shearY=this.getValue(l,"shearY",0),d.transformMode=e.transformModeFromString(this.getValue(l,"transform","normal")),d.skinRequired=this.getValue(l,"skin",!1),s.bones.push(d)}if(r.slots)for(a=0;a<r.slots.length;a++){var _=(I=r.slots[a]).name,u=I.bone,m=s.findBone(u);if(null==m)throw new Error("Slot bone not found: "+u);var d=new t.SlotData(s.slots.length,_,m),p=this.getValue(I,"color",null);null!=p&&d.color.setFromString(p);var f=this.getValue(I,"dark",null);null!=f&&(d.darkColor=new t.Color(1,1,1,1),d.darkColor.setFromString(f)),d.attachmentName=this.getValue(I,"attachment",null),d.blendMode=e.blendModeFromString(this.getValue(I,"blend","normal")),s.slots.push(d)}if(r.ik)for(a=0;a<r.ik.length;a++){var g=r.ik[a];(d=new t.IkConstraintData(g.name)).order=this.getValue(g,"order",0),d.skinRequired=this.getValue(g,"skin",!1);for(var y=0;y<g.bones.length;y++){if(u=g.bones[y],null==(w=s.findBone(u)))throw new Error("IK bone not found: "+u);d.bones.push(w)}var v=g.target;if(d.target=s.findBone(v),null==d.target)throw new Error("IK target bone not found: "+v);d.mix=this.getValue(g,"mix",1),d.softness=this.getValue(g,"softness",0)*n,d.bendDirection=this.getValue(g,"bendPositive",!0)?1:-1,d.compress=this.getValue(g,"compress",!1),d.stretch=this.getValue(g,"stretch",!1),d.uniform=this.getValue(g,"uniform",!1),s.ikConstraints.push(d)}if(r.transform)for(a=0;a<r.transform.length;a++){for(g=r.transform[a],(d=new t.TransformConstraintData(g.name)).order=this.getValue(g,"order",0),d.skinRequired=this.getValue(g,"skin",!1),y=0;y<g.bones.length;y++){if(u=g.bones[y],null==(w=s.findBone(u)))throw new Error("Transform constraint bone not found: "+u);d.bones.push(w)}if(v=g.target,d.target=s.findBone(v),null==d.target)throw new Error("Transform constraint target bone not found: "+v);d.local=this.getValue(g,"local",!1),d.relative=this.getValue(g,"relative",!1),d.offsetRotation=this.getValue(g,"rotation",0),d.offsetX=this.getValue(g,"x",0)*n,d.offsetY=this.getValue(g,"y",0)*n,d.offsetScaleX=this.getValue(g,"scaleX",0),d.offsetScaleY=this.getValue(g,"scaleY",0),d.offsetShearY=this.getValue(g,"shearY",0),d.rotateMix=this.getValue(g,"rotateMix",1),d.translateMix=this.getValue(g,"translateMix",1),d.scaleMix=this.getValue(g,"scaleMix",1),d.shearMix=this.getValue(g,"shearMix",1),s.transformConstraints.push(d)}if(r.path)for(a=0;a<r.path.length;a++){for(g=r.path[a],(d=new t.PathConstraintData(g.name)).order=this.getValue(g,"order",0),d.skinRequired=this.getValue(g,"skin",!1),y=0;y<g.bones.length;y++){if(u=g.bones[y],null==(w=s.findBone(u)))throw new Error("Transform constraint bone not found: "+u);d.bones.push(w)}if(v=g.target,d.target=s.findSlot(v),null==d.target)throw new Error("Path target slot not found: "+v);d.positionMode=e.positionModeFromString(this.getValue(g,"positionMode","percent")),d.spacingMode=e.spacingModeFromString(this.getValue(g,"spacingMode","length")),d.rotateMode=e.rotateModeFromString(this.getValue(g,"rotateMode","tangent")),d.offsetRotation=this.getValue(g,"rotation",0),d.position=this.getValue(g,"position",0),d.positionMode==t.PositionMode.Fixed&&(d.position*=n),d.spacing=this.getValue(g,"spacing",0),d.spacingMode!=t.SpacingMode.Length&&d.spacingMode!=t.SpacingMode.Fixed||(d.spacing*=n),d.rotateMix=this.getValue(g,"rotateMix",1),d.translateMix=this.getValue(g,"translateMix",1),s.pathConstraints.push(d)}if(r.skins){var x=r.skins;if(!(x instanceof Array)){var S=[];for(var A in x)S.push({name:A,attachments:x[A]});x=S}for(a=0;a<x.length;a++){var C=x[a],b=new t.Skin(C.name);if(C.bones)for(var T=0;T<C.bones.length;T++){var w;if(null==(w=s.findBone(C.bones[T])))throw new Error("Skin bone not found: "+C.bones[a]);b.bones.push(w)}if(C.ik)for(T=0;T<C.ik.length;T++){if(null==(E=s.findIkConstraint(C.ik[T])))throw new Error("Skin IK constraint not found: "+C.ik[a]);b.constraints.push(E)}if(C.transform)for(T=0;T<C.transform.length;T++){if(null==(E=s.findTransformConstraint(C.transform[T])))throw new Error("Skin transform constraint not found: "+C.transform[a]);b.constraints.push(E)}if(C.path)for(T=0;T<C.path.length;T++){var E;if(null==(E=s.findPathConstraint(C.path[T])))throw new Error("Skin path constraint not found: "+C.path[a]);b.constraints.push(E)}for(var _ in C.attachments){var P=s.findSlot(_);if(null==P)throw new Error("Slot not found: "+_);var I=C.attachments[_];for(var D in I){var R=this.readAttachment(I[D],b,P.index,D,s);null!=R&&b.setAttachment(P.index,D,R)}}s.skins.push(b),"default"==b.name&&(s.defaultSkin=b)}}a=0;for(var M=this.linkedMeshes.length;a<M;a++){var B=this.linkedMeshes[a];if(null==(b=null==B.skin?s.defaultSkin:s.findSkin(B.skin)))throw new Error("Skin not found: "+B.skin);var O=b.getAttachment(B.slotIndex,B.parent);if(null==O)throw new Error("Parent mesh not found: "+B.parent);B.mesh.deformAttachment=B.inheritDeform?O:B.mesh,B.mesh.setParentMesh(O),B.mesh.updateUVs()}if(this.linkedMeshes.length=0,r.events)for(var N in r.events){var L=r.events[N];(d=new t.EventData(N)).intValue=this.getValue(L,"int",0),d.floatValue=this.getValue(L,"float",0),d.stringValue=this.getValue(L,"string",""),d.audioPath=this.getValue(L,"audio",null),null!=d.audioPath&&(d.volume=this.getValue(L,"volume",1),d.balance=this.getValue(L,"balance",0)),s.events.push(d)}if(r.animations)for(var F in r.animations){var z=r.animations[F];this.readAnimation(z,F,s)}return s},e.prototype.readAttachment=function(e,n,s,r,o){var a=this.scale;switch(r=this.getValue(e,"name",r),this.getValue(e,"type","region")){case"region":var l=this.getValue(e,"path",r),c=this.attachmentLoader.newRegionAttachment(n,r,l);return null==c?null:(c.path=l,c.x=this.getValue(e,"x",0)*a,c.y=this.getValue(e,"y",0)*a,c.scaleX=this.getValue(e,"scaleX",1),c.scaleY=this.getValue(e,"scaleY",1),c.rotation=this.getValue(e,"rotation",0),c.width=e.width*a,c.height=e.height*a,null!=(v=this.getValue(e,"color",null))&&c.color.setFromString(v),c.updateOffset(),c);case"boundingbox":var h=this.attachmentLoader.newBoundingBoxAttachment(n,r);return null==h?null:(this.readVertices(e,h,e.vertexCount<<1),null!=(v=this.getValue(e,"color",null))&&h.color.setFromString(v),h);case"mesh":case"linkedmesh":l=this.getValue(e,"path",r);var _=this.attachmentLoader.newMeshAttachment(n,r,l);if(null==_)return null;_.path=l,null!=(v=this.getValue(e,"color",null))&&_.color.setFromString(v),_.width=this.getValue(e,"width",0)*a,_.height=this.getValue(e,"height",0)*a;var u=this.getValue(e,"parent",null);if(null!=u)return this.linkedMeshes.push(new i(_,this.getValue(e,"skin",null),s,u,this.getValue(e,"deform",!0))),_;var m=e.uvs;return this.readVertices(e,_,m.length),_.triangles=e.triangles,_.regionUVs=m,_.updateUVs(),_.edges=this.getValue(e,"edges",null),_.hullLength=2*this.getValue(e,"hull",0),_;case"path":if(null==(l=this.attachmentLoader.newPathAttachment(n,r)))return null;l.closed=this.getValue(e,"closed",!1),l.constantSpeed=this.getValue(e,"constantSpeed",!0);var d=e.vertexCount;this.readVertices(e,l,d<<1);for(var p=t.Utils.newArray(d/3,0),f=0;f<e.lengths.length;f++)p[f]=e.lengths[f]*a;return l.lengths=p,null!=(v=this.getValue(e,"color",null))&&l.color.setFromString(v),l;case"point":var g=this.attachmentLoader.newPointAttachment(n,r);return null==g?null:(g.x=this.getValue(e,"x",0)*a,g.y=this.getValue(e,"y",0)*a,g.rotation=this.getValue(e,"rotation",0),null!=(v=this.getValue(e,"color",null))&&g.color.setFromString(v),g);case"clipping":var y=this.attachmentLoader.newClippingAttachment(n,r);if(null==y)return null;var v,x=this.getValue(e,"end",null);if(null!=x){var S=o.findSlot(x);if(null==S)throw new Error("Clipping end slot not found: "+x);y.endSlot=S}return d=e.vertexCount,this.readVertices(e,y,d<<1),null!=(v=this.getValue(e,"color",null))&&y.color.setFromString(v),y}return null},e.prototype.readVertices=function(e,i,n){var s=this.scale;i.worldVerticesLength=n;var r=e.vertices;if(n!=r.length){var o=new Array,a=new Array;for(_=0,u=r.length;_<u;){var l=r[_++];a.push(l);for(var c=_+4*l;_<c;_+=4)a.push(r[_]),o.push(r[_+1]*s),o.push(r[_+2]*s),o.push(r[_+3])}i.bones=a,i.vertices=t.Utils.toFloatArray(o)}else{var h=t.Utils.toFloatArray(r);if(1!=s)for(var _=0,u=r.length;_<u;_++)h[_]*=s;i.vertices=h}},e.prototype.readAnimation=function(e,i,n){var s=this.scale,r=new Array,o=0;if(e.slots)for(var a in e.slots){var l=e.slots[a];if(-1==($=n.findSlotIndex(a)))throw new Error("Slot not found: "+a);for(var c in l){var h=l[c];if("attachment"==c){(x=new t.AttachmentTimeline(h.length)).slotIndex=$;for(var _=0,u=0;u<h.length;u++){var m=h[u];x.setFrame(_++,this.getValue(m,"time",0),m.name)}r.push(x),o=Math.max(o,x.frames[x.getFrameCount()-1])}else if("color"==c){for((x=new t.ColorTimeline(h.length)).slotIndex=$,_=0,u=0;u<h.length;u++){m=h[u];var d=new t.Color;d.setFromString(m.color),x.setFrame(_,this.getValue(m,"time",0),d.r,d.g,d.b,d.a),this.readCurve(m,x,_),_++}r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.ColorTimeline.ENTRIES])}else{if("twoColor"!=c)throw new Error("Invalid timeline type for a slot: "+c+" ("+a+")");for((x=new t.TwoColorTimeline(h.length)).slotIndex=$,_=0,u=0;u<h.length;u++){m=h[u];var p=new t.Color,f=new t.Color;p.setFromString(m.light),f.setFromString(m.dark),x.setFrame(_,this.getValue(m,"time",0),p.r,p.g,p.b,p.a,f.r,f.g,f.b),this.readCurve(m,x,_),_++}r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.TwoColorTimeline.ENTRIES])}}}if(e.bones)for(var g in e.bones){var y=e.bones[g],v=n.findBoneIndex(g);if(-1==v)throw new Error("Bone not found: "+g);for(var c in y)if(h=y[c],"rotate"===c){for((x=new t.RotateTimeline(h.length)).boneIndex=v,_=0,u=0;u<h.length;u++)m=h[u],x.setFrame(_,this.getValue(m,"time",0),this.getValue(m,"angle",0)),this.readCurve(m,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.RotateTimeline.ENTRIES])}else{if("translate"!==c&&"scale"!==c&&"shear"!==c)throw new Error("Invalid timeline type for a bone: "+c+" ("+g+")");var x=null,S=1,A=0;for("scale"===c?(x=new t.ScaleTimeline(h.length),A=1):"shear"===c?x=new t.ShearTimeline(h.length):(x=new t.TranslateTimeline(h.length),S=s),x.boneIndex=v,_=0,u=0;u<h.length;u++){m=h[u];var C=this.getValue(m,"x",A),b=this.getValue(m,"y",A);x.setFrame(_,this.getValue(m,"time",0),C*S,b*S),this.readCurve(m,x,_),_++}r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.TranslateTimeline.ENTRIES])}}if(e.ik)for(var T in e.ik){var w=e.ik[T],E=n.findIkConstraint(T);for((x=new t.IkConstraintTimeline(w.length)).ikConstraintIndex=n.ikConstraints.indexOf(E),_=0,u=0;u<w.length;u++)m=w[u],x.setFrame(_,this.getValue(m,"time",0),this.getValue(m,"mix",1),this.getValue(m,"softness",0)*s,this.getValue(m,"bendPositive",!0)?1:-1,this.getValue(m,"compress",!1),this.getValue(m,"stretch",!1)),this.readCurve(m,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.IkConstraintTimeline.ENTRIES])}if(e.transform)for(var T in e.transform){for(w=e.transform[T],E=n.findTransformConstraint(T),(x=new t.TransformConstraintTimeline(w.length)).transformConstraintIndex=n.transformConstraints.indexOf(E),_=0,u=0;u<w.length;u++)m=w[u],x.setFrame(_,this.getValue(m,"time",0),this.getValue(m,"rotateMix",1),this.getValue(m,"translateMix",1),this.getValue(m,"scaleMix",1),this.getValue(m,"shearMix",1)),this.readCurve(m,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.TransformConstraintTimeline.ENTRIES])}let P=e.path||e.paths;if(P)for(var T in P){w=P[T];var I=n.findPathConstraintIndex(T);if(-1==I)throw new Error("Path constraint not found: "+T);var D=n.pathConstraints[I];for(var c in w)if(h=w[c],"position"===c||"spacing"===c){for(x=null,S=1,"spacing"===c?(x=new t.PathConstraintSpacingTimeline(h.length),D.spacingMode!=t.SpacingMode.Length&&D.spacingMode!=t.SpacingMode.Fixed||(S=s)):(x=new t.PathConstraintPositionTimeline(h.length),D.positionMode==t.PositionMode.Fixed&&(S=s)),x.pathConstraintIndex=I,_=0,u=0;u<h.length;u++)m=h[u],x.setFrame(_,this.getValue(m,"time",0),this.getValue(m,c,0)*S),this.readCurve(m,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.PathConstraintPositionTimeline.ENTRIES])}else if("mix"===c){for((x=new t.PathConstraintMixTimeline(h.length)).pathConstraintIndex=I,_=0,u=0;u<h.length;u++)m=h[u],x.setFrame(_,this.getValue(m,"time",0),this.getValue(m,"rotateMix",1),this.getValue(m,"translateMix",1)),this.readCurve(m,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.PathConstraintMixTimeline.ENTRIES])}}if(e.deform)for(var R in e.deform){var M=e.deform[R],B=n.findSkin(R);if(null==B)throw new Error("Skin not found: "+R);for(var a in M){if(l=M[a],-1==($=n.findSlotIndex(a)))throw new Error("Slot not found: "+l.name);for(var c in l){h=l[c];var O=B.getAttachment($,c);if(null!=O){var N=null!=O.bones,L=O.vertices,F=N?L.length/3*2:L.length;(x=new t.DeformTimeline(h.length)).slotIndex=$,x.attachment=O,_=0;for(var z=0;z<h.length;z++){m=h[z];var V=void 0,U=this.getValue(m,"vertices",null);if(null==U)V=N?t.Utils.newFloatArray(F):L;else{V=t.Utils.newFloatArray(F);var G=this.getValue(m,"offset",0);if(t.Utils.arrayCopy(U,0,V,G,U.length),1!=s)for(var H=(u=G)+U.length;u<H;u++)V[u]*=s;if(!N)for(u=0;u<F;u++)V[u]+=L[u]}x.setFrame(_,this.getValue(m,"time",0),V),this.readCurve(m,x,_),_++}r.push(x),o=Math.max(o,x.frames[x.getFrameCount()-1])}}}}var k=e.drawOrder;if(null==k&&(k=e.draworder),null!=k){x=new t.DrawOrderTimeline(k.length);var j=n.slots.length;for(_=0,z=0;z<k.length;z++){var W=k[z],q=null,X=this.getValue(W,"offsets",null);if(null!=X){q=t.Utils.newArray(j,-1);var Y=t.Utils.newArray(j-X.length,0),K=0,J=0;for(u=0;u<X.length;u++){var $,Z=X[u];if(-1==($=n.findSlotIndex(Z.slot)))throw new Error("Slot not found: "+Z.slot);for(;K!=$;)Y[J++]=K++;q[K+Z.offset]=K++}for(;K<j;)Y[J++]=K++;for(u=j-1;u>=0;u--)-1==q[u]&&(q[u]=Y[--J])}x.setFrame(_++,this.getValue(W,"time",0),q)}r.push(x),o=Math.max(o,x.frames[x.getFrameCount()-1])}if(e.events){for(x=new t.EventTimeline(e.events.length),_=0,u=0;u<e.events.length;u++){var Q=e.events[u],tt=n.findEvent(Q.name);if(null==tt)throw new Error("Event not found: "+Q.name);var et=new t.Event(t.Utils.toSinglePrecision(this.getValue(Q,"time",0)),tt);et.intValue=this.getValue(Q,"int",tt.intValue),et.floatValue=this.getValue(Q,"float",tt.floatValue),et.stringValue=this.getValue(Q,"string",tt.stringValue),null!=et.data.audioPath&&(et.volume=this.getValue(Q,"volume",1),et.balance=this.getValue(Q,"balance",0)),x.setFrame(_++,et)}r.push(x),o=Math.max(o,x.frames[x.getFrameCount()-1])}if(isNaN(o))throw new Error("Error while parsing animation, duration is NaN");n.animations.push(new t.Animation(i,r,o))},e.prototype.readCurve=function(t,e,i){var n=t.curve;n&&("stepped"==n?e.setStepped(i):"[object Array]"===Object.prototype.toString.call(n)?e.setCurve(i,n[0],n[1],n[2],n[3]):e.setCurve(i,n,this.getValue(t,"c2",0),this.getValue(t,"c3",1),this.getValue(t,"c4",1)))},e.prototype.getValue=function(t,e,i){return void 0!==t[e]?t[e]:i},e.blendModeFromString=function(e){if("normal"==(e=e.toLowerCase()))return t.BlendMode.Normal;if("additive"==e)return t.BlendMode.Additive;if("multiply"==e)return t.BlendMode.Multiply;if("screen"==e)return t.BlendMode.Screen;throw new Error("Unknown blend mode: "+e)},e.positionModeFromString=function(e){if("fixed"==(e=e.toLowerCase()))return t.PositionMode.Fixed;if("percent"==e)return t.PositionMode.Percent;throw new Error("Unknown position mode: "+e)},e.spacingModeFromString=function(e){if("length"==(e=e.toLowerCase()))return t.SpacingMode.Length;if("fixed"==e)return t.SpacingMode.Fixed;if("percent"==e)return t.SpacingMode.Percent;throw new Error("Unknown position mode: "+e)},e.rotateModeFromString=function(e){if("tangent"==(e=e.toLowerCase()))return t.RotateMode.Tangent;if("chain"==e)return t.RotateMode.Chain;if("chainscale"==e)return t.RotateMode.ChainScale;throw new Error("Unknown rotate mode: "+e)},e.transformModeFromString=function(e){if("normal"==(e=e.toLowerCase()))return t.TransformMode.Normal;if("onlytranslation"==e)return t.TransformMode.OnlyTranslation;if("norotationorreflection"==e)return t.TransformMode.NoRotationOrReflection;if("noscale"==e)return t.TransformMode.NoScale;if("noscaleorreflection"==e)return t.TransformMode.NoScaleOrReflection;throw new Error("Unknown transform mode: "+e)},e}();t.SkeletonJson=e;var i=function(t,e,i,n,s){this.mesh=t,this.skin=e,this.slotIndex=i,this.parent=n,this.inheritDeform=s}}(Q9||(Q9={})),function(t){var e=function(t,e,i){this.slotIndex=t,this.name=e,this.attachment=i};t.SkinEntry=e;var i=function(){function i(t){if(this.attachments=new Array,this.bones=Array(),this.constraints=new Array,null==t)throw new Error("name cannot be null.");this.name=t}return i.prototype.setAttachment=function(t,e,i){if(null==i)throw new Error("attachment cannot be null.");var n=this.attachments;t>=n.length&&(n.length=t+1),n[t]||(n[t]={}),n[t][e]=i},i.prototype.addSkin=function(t){for(var e=0;e<t.bones.length;e++){for(var i=t.bones[e],n=!1,s=0;s<this.bones.length;s++)if(this.bones[s]==i){n=!0;break}n||this.bones.push(i)}for(e=0;e<t.constraints.length;e++){var r=t.constraints[e];for(n=!1,s=0;s<this.constraints.length;s++)if(this.constraints[s]==r){n=!0;break}n||this.constraints.push(r)}var o=t.getAttachments();for(e=0;e<o.length;e++){var a=o[e];this.setAttachment(a.slotIndex,a.name,a.attachment)}},i.prototype.copySkin=function(e){for(var i=0;i<e.bones.length;i++){for(var n=e.bones[i],s=!1,r=0;r<this.bones.length;r++)if(this.bones[r]==n){s=!0;break}s||this.bones.push(n)}for(i=0;i<e.constraints.length;i++){var o=e.constraints[i];for(s=!1,r=0;r<this.constraints.length;r++)if(this.constraints[r]==o){s=!0;break}s||this.constraints.push(o)}var a=e.getAttachments();for(i=0;i<a.length;i++){var l=a[i];null!=l.attachment&&(l.attachment instanceof t.MeshAttachment?(l.attachment=l.attachment.newLinkedMesh(),this.setAttachment(l.slotIndex,l.name,l.attachment)):(l.attachment=l.attachment.copy(),this.setAttachment(l.slotIndex,l.name,l.attachment)))}},i.prototype.getAttachment=function(t,e){var i=this.attachments[t];return i?i[e]:null},i.prototype.removeAttachment=function(t,e){var i=this.attachments[t];i&&(i[e]=null)},i.prototype.getAttachments=function(){for(var t=new Array,i=0;i<this.attachments.length;i++){var n=this.attachments[i];if(n)for(var s in n){var r=n[s];r&&t.push(new e(i,s,r))}}return t},i.prototype.getAttachmentsForSlot=function(t,i){var n=this.attachments[t];if(n)for(var s in n){var r=n[s];r&&i.push(new e(t,s,r))}},i.prototype.clear=function(){this.attachments.length=0,this.bones.length=0,this.constraints.length=0},i.prototype.attachAll=function(t,e){for(var i=0,n=0;n<t.slots.length;n++){var s=t.slots[n],r=s.getAttachment();if(r&&i<e.attachments.length){var o=e.attachments[i];for(var a in o)if(r==o[a]){var l=this.getAttachment(i,a);null!=l&&s.setAttachment(l);break}}i++}},i}();t.Skin=i}(Q9||(Q9={})),function(t){var e=function(){function e(e,i){if(this.deform=new Array,null==e)throw new Error("data cannot be null.");if(null==i)throw new Error("bone cannot be null.");this.data=e,this.bone=i,this.color=new t.Color,this.darkColor=null==e.darkColor?null:new t.Color,this.setToSetupPose()}return e.prototype.getSkeleton=function(){return this.bone.skeleton},e.prototype.getAttachment=function(){return this.attachment},e.prototype.setAttachment=function(t){this.attachment!=t&&(this.attachment=t,this.attachmentTime=this.bone.skeleton.time,this.deform.length=0)},e.prototype.setAttachmentTime=function(t){this.attachmentTime=this.bone.skeleton.time-t},e.prototype.getAttachmentTime=function(){return this.bone.skeleton.time-this.attachmentTime},e.prototype.setToSetupPose=function(){this.color.setFromColor(this.data.color),null!=this.darkColor&&this.darkColor.setFromColor(this.data.darkColor),null==this.data.attachmentName?this.attachment=null:(this.attachment=null,this.setAttachment(this.bone.skeleton.getAttachment(this.data.index,this.data.attachmentName)))},e}();t.Slot=e}(Q9||(Q9={})),function(t){t.SlotData=function(e,i,n){if(this.color=new t.Color(1,1,1,1),e<0)throw new Error("index must be >= 0.");if(null==i)throw new Error("name cannot be null.");if(null==n)throw new Error("boneData cannot be null.");this.index=e,this.name=i,this.boneData=n}}(Q9||(Q9={})),function(t){var e,i,n=function(){function t(t){this._image=t}return t.prototype.getImage=function(){return this._image},t.filterFromString=function(t){switch(t.toLowerCase()){case"nearest":return e.Nearest;case"linear":return e.Linear;case"mipmap":return e.MipMap;case"mipmapnearestnearest":return e.MipMapNearestNearest;case"mipmaplinearnearest":return e.MipMapLinearNearest;case"mipmapnearestlinear":return e.MipMapNearestLinear;case"mipmaplinearlinear":return e.MipMapLinearLinear;default:throw new Error("Unknown texture filter "+t)}},t.wrapFromString=function(t){switch(t.toLowerCase()){case"mirroredtepeat":return i.MirroredRepeat;case"clamptoedge":return i.ClampToEdge;case"repeat":return i.Repeat;default:throw new Error("Unknown texture wrap "+t)}},t}();t.Texture=n,function(t){t[t.Nearest=9728]="Nearest",t[t.Linear=9729]="Linear",t[t.MipMap=9987]="MipMap",t[t.MipMapNearestNearest=9984]="MipMapNearestNearest",t[t.MipMapLinearNearest=9985]="MipMapLinearNearest",t[t.MipMapNearestLinear=9986]="MipMapNearestLinear",t[t.MipMapLinearLinear=9987]="MipMapLinearLinear"}(e=t.TextureFilter||(t.TextureFilter={})),function(t){t[t.MirroredRepeat=33648]="MirroredRepeat",t[t.ClampToEdge=33071]="ClampToEdge",t[t.Repeat=10497]="Repeat"}(i=t.TextureWrap||(t.TextureWrap={}));t.TextureRegion=function(){this.u=0,this.v=0,this.u2=0,this.v2=0,this.width=0,this.height=0,this.rotate=!1,this.offsetX=0,this.offsetY=0,this.originalWidth=0,this.originalHeight=0};var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ttt(e,t),e.prototype.setFilters=function(){},e.prototype.setWraps=function(){},e.prototype.dispose=function(){},e}(n);t.FakeTexture=s}(Q9||(Q9={})),function(t){var e=function(){function e(t,e){this.pages=new Array,this.regions=new Array,this.load(t,e)}return e.prototype.load=function(e,r){if(null==r)throw new Error("textureLoader cannot be null.");for(var o=new i(e),a=new Array(4),l=null;;){var c=o.readLine();if(null==c)break;if(0==(c=c.trim()).length)l=null;else if(l){var h=new s;h.name=c,h.page=l;var _=o.readValue();"true"==_.toLocaleLowerCase()?h.degrees=90:"false"==_.toLocaleLowerCase()?h.degrees=0:h.degrees=parseFloat(_),h.rotate=90==h.degrees,o.readTuple(a);var u=parseInt(a[0]),m=parseInt(a[1]);o.readTuple(a);var d=parseInt(a[0]),p=parseInt(a[1]);h.u=u/l.width,h.v=m/l.height,h.rotate?(h.u2=(u+p)/l.width,h.v2=(m+d)/l.height):(h.u2=(u+d)/l.width,h.v2=(m+p)/l.height),h.x=u,h.y=m,h.width=Math.abs(d),h.height=Math.abs(p),4==o.readTuple(a)&&4==o.readTuple(a)&&o.readTuple(a),h.originalWidth=parseInt(a[0]),h.originalHeight=parseInt(a[1]),o.readTuple(a),h.offsetX=parseInt(a[0]),h.offsetY=parseInt(a[1]),h.index=parseInt(o.readValue()),h.texture=l.texture,this.regions.push(h)}else{(l=new n).name=c,2==o.readTuple(a)&&(l.width=parseInt(a[0]),l.height=parseInt(a[1]),o.readTuple(a)),o.readTuple(a),l.minFilter=t.Texture.filterFromString(a[0]),l.magFilter=t.Texture.filterFromString(a[1]);var f=o.readValue();l.uWrap=t.TextureWrap.ClampToEdge,l.vWrap=t.TextureWrap.ClampToEdge,"x"==f?l.uWrap=t.TextureWrap.Repeat:"y"==f?l.vWrap=t.TextureWrap.Repeat:"xy"==f&&(l.uWrap=l.vWrap=t.TextureWrap.Repeat),l.texture=r(c),l.texture.setFilters(l.minFilter,l.magFilter),l.texture.setWraps(l.uWrap,l.vWrap),l.width=l.texture.getImage().width,l.height=l.texture.getImage().height,this.pages.push(l)}}},e.prototype.findRegion=function(t){for(var e=0;e<this.regions.length;e++)if(this.regions[e].name==t)return this.regions[e];return null},e.prototype.dispose=function(){for(var t=0;t<this.pages.length;t++)this.pages[t].texture.dispose()},e}();t.TextureAtlas=e;var i=function(){function t(t){this.index=0,this.lines=t.split(/\r\n|\r|\n/)}return t.prototype.readLine=function(){return this.index>=this.lines.length?null:this.lines[this.index++]},t.prototype.readValue=function(){var t=this.readLine(),e=t.indexOf(":");if(-1==e)throw new Error("Invalid line: "+t);return t.substring(e+1).trim()},t.prototype.readTuple=function(t){var e=this.readLine(),i=e.indexOf(":");if(-1==i)throw new Error("Invalid line: "+e);for(var n=0,s=i+1;n<3;n++){var r=e.indexOf(",",s);if(-1==r)break;t[n]=e.substr(s,r-s).trim(),s=r+1}return t[n]=e.substring(s).trim(),n+1},t}(),n=function(){};t.TextureAtlasPage=n;var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return ttt(e,t),e}(t.TextureRegion);t.TextureAtlasRegion=s}(Q9||(Q9={})),function(t){var e=function(){function e(e,i){if(this.rotateMix=0,this.translateMix=0,this.scaleMix=0,this.shearMix=0,this.temp=new t.Vector2,this.active=!1,null==e)throw new Error("data cannot be null.");if(null==i)throw new Error("skeleton cannot be null.");this.data=e,this.rotateMix=e.rotateMix,this.translateMix=e.translateMix,this.scaleMix=e.scaleMix,this.shearMix=e.shearMix,this.bones=new Array;for(var n=0;n<e.bones.length;n++)this.bones.push(i.findBone(e.bones[n].name));this.target=i.findBone(e.target.name)}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){this.data.local?this.data.relative?this.applyRelativeLocal():this.applyAbsoluteLocal():this.data.relative?this.applyRelativeWorld():this.applyAbsoluteWorld()},e.prototype.applyAbsoluteWorld=function(){for(var e=this.rotateMix,i=this.translateMix,n=this.scaleMix,s=this.shearMix,r=this.target,o=r.a,a=r.b,l=r.c,c=r.d,h=o*c-a*l>0?t.MathUtils.degRad:-t.MathUtils.degRad,_=this.data.offsetRotation*h,u=this.data.offsetShearY*h,m=this.bones,d=0,p=m.length;d<p;d++){var f=m[d],g=!1;if(0!=e){var y=f.a,v=f.b,x=f.c,S=f.d;(E=Math.atan2(l,o)-Math.atan2(x,y)+_)>t.MathUtils.PI?E-=t.MathUtils.PI2:E<-t.MathUtils.PI&&(E+=t.MathUtils.PI2),E*=e;var A=Math.cos(E),C=Math.sin(E);f.a=A*y-C*x,f.b=A*v-C*S,f.c=C*y+A*x,f.d=C*v+A*S,g=!0}if(0!=i){var b=this.temp;r.localToWorld(b.set(this.data.offsetX,this.data.offsetY)),f.worldX+=(b.x-f.worldX)*i,f.worldY+=(b.y-f.worldY)*i,g=!0}if(n>0){var T=Math.sqrt(f.a*f.a+f.c*f.c),w=Math.sqrt(o*o+l*l);T>1e-5&&(T=(T+(w-T+this.data.offsetScaleX)*n)/T),f.a*=T,f.c*=T,T=Math.sqrt(f.b*f.b+f.d*f.d),w=Math.sqrt(a*a+c*c),T>1e-5&&(T=(T+(w-T+this.data.offsetScaleY)*n)/T),f.b*=T,f.d*=T,g=!0}if(s>0){v=f.b,S=f.d;var E,P=Math.atan2(S,v);(E=Math.atan2(c,a)-Math.atan2(l,o)-(P-Math.atan2(f.c,f.a)))>t.MathUtils.PI?E-=t.MathUtils.PI2:E<-t.MathUtils.PI&&(E+=t.MathUtils.PI2),E=P+(E+u)*s,T=Math.sqrt(v*v+S*S),f.b=Math.cos(E)*T,f.d=Math.sin(E)*T,g=!0}g&&(f.appliedValid=!1)}},e.prototype.applyRelativeWorld=function(){for(var e=this.rotateMix,i=this.translateMix,n=this.scaleMix,s=this.shearMix,r=this.target,o=r.a,a=r.b,l=r.c,c=r.d,h=o*c-a*l>0?t.MathUtils.degRad:-t.MathUtils.degRad,_=this.data.offsetRotation*h,u=this.data.offsetShearY*h,m=this.bones,d=0,p=m.length;d<p;d++){var f,g=m[d],y=!1;if(0!=e){var v=g.a,x=g.b,S=g.c,A=g.d;(f=Math.atan2(l,o)+_)>t.MathUtils.PI?f-=t.MathUtils.PI2:f<-t.MathUtils.PI&&(f+=t.MathUtils.PI2),f*=e;var C=Math.cos(f),b=Math.sin(f);g.a=C*v-b*S,g.b=C*x-b*A,g.c=b*v+C*S,g.d=b*x+C*A,y=!0}if(0!=i){var T=this.temp;r.localToWorld(T.set(this.data.offsetX,this.data.offsetY)),g.worldX+=T.x*i,g.worldY+=T.y*i,y=!0}if(n>0){var w=(Math.sqrt(o*o+l*l)-1+this.data.offsetScaleX)*n+1;g.a*=w,g.c*=w,w=(Math.sqrt(a*a+c*c)-1+this.data.offsetScaleY)*n+1,g.b*=w,g.d*=w,y=!0}if(s>0)(f=Math.atan2(c,a)-Math.atan2(l,o))>t.MathUtils.PI?f-=t.MathUtils.PI2:f<-t.MathUtils.PI&&(f+=t.MathUtils.PI2),x=g.b,A=g.d,f=Math.atan2(A,x)+(f-t.MathUtils.PI/2+u)*s,w=Math.sqrt(x*x+A*A),g.b=Math.cos(f)*w,g.d=Math.sin(f)*w,y=!0;y&&(g.appliedValid=!1)}},e.prototype.applyAbsoluteLocal=function(){var t=this.rotateMix,e=this.translateMix,i=this.scaleMix,n=this.shearMix,s=this.target;s.appliedValid||s.updateAppliedTransform();for(var r=this.bones,o=0,a=r.length;o<a;o++){var l=r[o];l.appliedValid||l.updateAppliedTransform();var c=l.arotation;if(0!=t){var h=s.arotation-c+this.data.offsetRotation;c+=(h-=360*(16384-(16384.499999999996-h/360|0)))*t}var _=l.ax,u=l.ay;0!=e&&(_+=(s.ax-_+this.data.offsetX)*e,u+=(s.ay-u+this.data.offsetY)*e);var m=l.ascaleX,d=l.ascaleY;0!=i&&(m>1e-5&&(m=(m+(s.ascaleX-m+this.data.offsetScaleX)*i)/m),d>1e-5&&(d=(d+(s.ascaleY-d+this.data.offsetScaleY)*i)/d));var p=l.ashearY;0!=n&&(h=s.ashearY-p+this.data.offsetShearY,h-=360*(16384-(16384.499999999996-h/360|0)),l.shearY+=h*n),l.updateWorldTransformWith(_,u,c,m,d,l.ashearX,p)}},e.prototype.applyRelativeLocal=function(){var t=this.rotateMix,e=this.translateMix,i=this.scaleMix,n=this.shearMix,s=this.target;s.appliedValid||s.updateAppliedTransform();for(var r=this.bones,o=0,a=r.length;o<a;o++){var l=r[o];l.appliedValid||l.updateAppliedTransform();var c=l.arotation;0!=t&&(c+=(s.arotation+this.data.offsetRotation)*t);var h=l.ax,_=l.ay;0!=e&&(h+=(s.ax+this.data.offsetX)*e,_+=(s.ay+this.data.offsetY)*e);var u=l.ascaleX,m=l.ascaleY;0!=i&&(u>1e-5&&(u*=(s.ascaleX-1+this.data.offsetScaleX)*i+1),m>1e-5&&(m*=(s.ascaleY-1+this.data.offsetScaleY)*i+1));var d=l.ashearY;0!=n&&(d+=(s.ashearY+this.data.offsetShearY)*n),l.updateWorldTransformWith(h,_,c,u,m,l.ashearX,d)}},e}();t.TransformConstraint=e}(Q9||(Q9={})),function(t){var e=function(t){function e(e){var i=t.call(this,e,0,!1)||this;return i.bones=new Array,i.rotateMix=0,i.translateMix=0,i.scaleMix=0,i.shearMix=0,i.offsetRotation=0,i.offsetX=0,i.offsetY=0,i.offsetScaleX=0,i.offsetScaleY=0,i.offsetShearY=0,i.relative=!1,i.local=!1,i}return ttt(e,t),e}(t.ConstraintData);t.TransformConstraintData=e}(Q9||(Q9={})),function(t){var e=function(){function e(){this.convexPolygons=new Array,this.convexPolygonsIndices=new Array,this.indicesArray=new Array,this.isConcaveArray=new Array,this.triangles=new Array,this.polygonPool=new t.Pool((function(){return new Array})),this.polygonIndicesPool=new t.Pool((function(){return new Array}))}return e.prototype.triangulate=function(t){var i=t,n=t.length>>1,s=this.indicesArray;s.length=0;for(var r=0;r<n;r++)s[r]=r;var o=this.isConcaveArray;o.length=0,r=0;for(var a=n;r<a;++r)o[r]=e.isConcave(r,n,i,s);var l=this.triangles;for(l.length=0;n>3;){for(var c=n-1,h=(r=0,1);;){t:if(!o[r]){for(var _=s[c]<<1,u=s[r]<<1,m=s[h]<<1,d=i[_],p=i[_+1],f=i[u],g=i[u+1],y=i[m],v=i[m+1],x=(h+1)%n;x!=c;x=(x+1)%n)if(o[x]){var S=s[x]<<1,A=i[S],C=i[S+1];if(e.positiveArea(y,v,d,p,A,C)&&e.positiveArea(d,p,f,g,A,C)&&e.positiveArea(f,g,y,v,A,C))break t}break}if(0==h){do{if(!o[r])break;r--}while(r>0);break}c=r,r=h,h=(h+1)%n}l.push(s[(n+r-1)%n]),l.push(s[r]),l.push(s[(r+1)%n]),s.splice(r,1),o.splice(r,1);var b=(--n+r-1)%n,T=r==n?0:r;o[b]=e.isConcave(b,n,i,s),o[T]=e.isConcave(T,n,i,s)}return 3==n&&(l.push(s[2]),l.push(s[0]),l.push(s[1])),l},e.prototype.decompose=function(t,i){var n=t,s=this.convexPolygons;this.polygonPool.freeAll(s),s.length=0;var r=this.convexPolygonsIndices;this.polygonIndicesPool.freeAll(r),r.length=0;var o=this.polygonIndicesPool.obtain();o.length=0;var a=this.polygonPool.obtain();a.length=0;for(var l=-1,c=0,h=0,_=i.length;h<_;h+=3){var u=i[h]<<1,m=i[h+1]<<1,d=i[h+2]<<1,p=n[u],f=n[u+1],g=n[m],y=n[m+1],v=n[d],x=n[d+1],S=!1;if(l==u){var A=a.length-4,C=e.winding(a[A],a[A+1],a[A+2],a[A+3],v,x),b=e.winding(v,x,a[0],a[1],a[2],a[3]);C==c&&b==c&&(a.push(v),a.push(x),o.push(d),S=!0)}S||(a.length>0?(s.push(a),r.push(o)):(this.polygonPool.free(a),this.polygonIndicesPool.free(o)),(a=this.polygonPool.obtain()).length=0,a.push(p),a.push(f),a.push(g),a.push(y),a.push(v),a.push(x),(o=this.polygonIndicesPool.obtain()).length=0,o.push(u),o.push(m),o.push(d),c=e.winding(p,f,g,y,v,x),l=u)}for(a.length>0&&(s.push(a),r.push(o)),h=0,_=s.length;h<_;h++)if(0!=(o=r[h]).length)for(var T=o[0],w=o[o.length-1],E=(a=s[h])[A=a.length-4],P=a[A+1],I=a[A+2],D=a[A+3],R=a[0],M=a[1],B=a[2],O=a[3],N=e.winding(E,P,I,D,R,M),L=0;L<_;L++)if(L!=h){var F=r[L];if(3==F.length){var z=F[0],V=F[1],U=F[2],G=s[L];v=G[G.length-2],x=G[G.length-1],z==T&&V==w&&(C=e.winding(E,P,I,D,v,x),b=e.winding(v,x,R,M,B,O),C==N&&b==N&&(G.length=0,F.length=0,a.push(v),a.push(x),o.push(U),E=I,P=D,I=v,D=x,L=0))}}for(h=s.length-1;h>=0;h--)0==(a=s[h]).length&&(s.splice(h,1),this.polygonPool.free(a),o=r[h],r.splice(h,1),this.polygonIndicesPool.free(o));return s},e.isConcave=function(t,e,i,n){var s=n[(e+t-1)%e]<<1,r=n[t]<<1,o=n[(t+1)%e]<<1;return!this.positiveArea(i[s],i[s+1],i[r],i[r+1],i[o],i[o+1])},e.positiveArea=function(t,e,i,n,s,r){return t*(r-n)+i*(e-r)+s*(n-e)>=0},e.winding=function(t,e,i,n,s,r){var o=i-t,a=n-e;return s*a-r*o+o*e-t*a>=0?1:-1},e}();t.Triangulator=e}(Q9||(Q9={})),function(t){var e=function(){function t(){this.array=new Array}return t.prototype.add=function(t){var e=this.contains(t);return this.array[0|t]=0|t,!e},t.prototype.contains=function(t){return null!=this.array[0|t]},t.prototype.remove=function(t){this.array[0|t]=void 0},t.prototype.clear=function(){this.array.length=0},t}();t.IntSet=e;var i=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.r=t,this.g=e,this.b=i,this.a=n}return t.prototype.set=function(t,e,i,n){return this.r=t,this.g=e,this.b=i,this.a=n,this.clamp(),this},t.prototype.setFromColor=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},t.prototype.setFromString=function(t){return t="#"==t.charAt(0)?t.substr(1):t,this.r=parseInt(t.substr(0,2),16)/255,this.g=parseInt(t.substr(2,2),16)/255,this.b=parseInt(t.substr(4,2),16)/255,this.a=(8!=t.length?255:parseInt(t.substr(6,2),16))/255,this},t.prototype.add=function(t,e,i,n){return this.r+=t,this.g+=e,this.b+=i,this.a+=n,this.clamp(),this},t.prototype.clamp=function(){return this.r<0?this.r=0:this.r>1&&(this.r=1),this.g<0?this.g=0:this.g>1&&(this.g=1),this.b<0?this.b=0:this.b>1&&(this.b=1),this.a<0?this.a=0:this.a>1&&(this.a=1),this},t.rgba8888ToColor=function(t,e){t.r=((4278190080&e)>>>24)/255,t.g=((16711680&e)>>>16)/255,t.b=((65280&e)>>>8)/255,t.a=(255&e)/255},t.rgb888ToColor=function(t,e){t.r=((16711680&e)>>>16)/255,t.g=((65280&e)>>>8)/255,t.b=(255&e)/255},t.WHITE=new t(1,1,1,1),t.RED=new t(1,0,0,1),t.GREEN=new t(0,1,0,1),t.BLUE=new t(0,0,1,1),t.MAGENTA=new t(1,0,1,1),t}();t.Color=i;var n=function(){function t(){}return t.clamp=function(t,e,i){return t<e?e:t>i?i:t},t.cosDeg=function(e){return Math.cos(e*t.degRad)},t.sinDeg=function(e){return Math.sin(e*t.degRad)},t.signum=function(t){return t>0?1:t<0?-1:0},t.toInt=function(t){return t>0?Math.floor(t):Math.ceil(t)},t.cbrt=function(t){var e=Math.pow(Math.abs(t),1/3);return t<0?-e:e},t.randomTriangular=function(e,i){return t.randomTriangularWith(e,i,.5*(e+i))},t.randomTriangularWith=function(t,e,i){var n=Math.random(),s=e-t;return n<=(i-t)/s?t+Math.sqrt(n*s*(i-t)):e-Math.sqrt((1-n)*s*(e-i))},t.PI=3.1415927,t.PI2=2*t.PI,t.radiansToDegrees=180/t.PI,t.radDeg=t.radiansToDegrees,t.degreesToRadians=t.PI/180,t.degRad=t.degreesToRadians,t}();t.MathUtils=n;var s=function(){function t(){}return t.prototype.apply=function(t,e,i){return t+(e-t)*this.applyInternal(i)},t}();t.Interpolation=s;var r=function(t){function e(e){var i=t.call(this)||this;return i.power=2,i.power=e,i}return ttt(e,t),e.prototype.applyInternal=function(t){return t<=.5?Math.pow(2*t,this.power)/2:Math.pow(2*(t-1),this.power)/(this.power%2==0?-2:2)+1},e}(s);t.Pow=r;var o=function(t){function e(e){return t.call(this,e)||this}return ttt(e,t),e.prototype.applyInternal=function(t){return Math.pow(t-1,this.power)*(this.power%2==0?-1:1)+1},e}(r);t.PowOut=o;var a=function(){function t(){}return t.arrayCopy=function(t,e,i,n,s){for(var r=e,o=n;r<e+s;r++,o++)i[o]=t[r]},t.setArraySize=function(t,e,i){void 0===i&&(i=0);var n=t.length;if(n==e)return t;if(t.length=e,n<e)for(var s=n;s<e;s++)t[s]=i;return t},t.ensureArrayCapacity=function(e,i,n){return void 0===n&&(n=0),e.length>=i?e:t.setArraySize(e,i,n)},t.newArray=function(t,e){for(var i=new Array(t),n=0;n<t;n++)i[n]=e;return i},t.newFloatArray=function(e){if(t.SUPPORTS_TYPED_ARRAYS)return new Float32Array(e);for(var i=new Array(e),n=0;n<i.length;n++)i[n]=0;return i},t.newShortArray=function(e){if(t.SUPPORTS_TYPED_ARRAYS)return new Int16Array(e);for(var i=new Array(e),n=0;n<i.length;n++)i[n]=0;return i},t.toFloatArray=function(e){return t.SUPPORTS_TYPED_ARRAYS?new Float32Array(e):e},t.toSinglePrecision=function(e){return t.SUPPORTS_TYPED_ARRAYS?Math.fround(e):e},t.webkit602BugfixHelper=function(){},t.contains=function(t,e){for(var i=0;i<t.length;i++)if(t[i]==e)return!0;return!1},t.SUPPORTS_TYPED_ARRAYS="undefined"!=typeof Float32Array,t}();t.Utils=a;var l=function(){function t(){}return t.logBones=function(t){for(var e=0;e<t.bones.length;e++){var i=t.bones[e];console.log(i.data.name+", "+i.a+", "+i.b+", "+i.c+", "+i.d+", "+i.worldX+", "+i.worldY)}},t}();t.DebugUtils=l;var c=function(){function t(t){this.items=new Array,this.instantiator=t}return t.prototype.obtain=function(){return this.items.length>0?this.items.pop():this.instantiator()},t.prototype.free=function(t){t.reset&&t.reset(),this.items.push(t)},t.prototype.freeAll=function(t){for(var e=0;e<t.length;e++)t[e].reset&&t[e].reset(),this.items[e]=t[e]},t.prototype.clear=function(){this.items.length=0},t}();t.Pool=c;var h=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.set=function(t,e){return this.x=t,this.y=e,this},t.prototype.length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},t.prototype.normalize=function(){var t=this.length();return 0!=t&&(this.x/=t,this.y/=t),this},t}();t.Vector2=h;var _=function(){function t(){this.maxDelta=.064,this.framesPerSecond=0,this.delta=0,this.totalTime=0,this.lastTime=Date.now()/1e3,this.frameCount=0,this.frameTime=0}return t.prototype.update=function(){var t=Date.now()/1e3;this.delta=t-this.lastTime,this.frameTime+=this.delta,this.totalTime+=this.delta,this.delta>this.maxDelta&&(this.delta=this.maxDelta),this.lastTime=t,this.frameCount++,this.frameTime>1&&(this.framesPerSecond=this.frameCount/this.frameTime,this.frameTime=0,this.frameCount=0)},t}();t.TimeKeeper=_;var u=function(){function t(t){void 0===t&&(t=32),this.addedValues=0,this.lastValue=0,this.mean=0,this.dirty=!0,this.values=new Array(t)}return t.prototype.hasEnoughData=function(){return this.addedValues>=this.values.length},t.prototype.addValue=function(t){this.addedValues<this.values.length&&this.addedValues++,this.values[this.lastValue++]=t,this.lastValue>this.values.length-1&&(this.lastValue=0),this.dirty=!0},t.prototype.getMean=function(){if(this.hasEnoughData()){if(this.dirty){for(var t=0,e=0;e<this.values.length;e++)t+=this.values[e];this.mean=t/this.values.length,this.dirty=!1}return this.mean}return 0},t}();t.WindowedMean=u}(Q9||(Q9={})),Math.fround||(Math.fround=function(t){return function(e){return t[0]=e,t[0]}}(new Float32Array(1))),function(t){var e=function(t){if(null==t)throw new Error("name cannot be null.");this.name=t};t.Attachment=e;var i=function(e){function i(t){var n=e.call(this,t)||this;return n.id=(65535&i.nextID++)<<11,n.worldVerticesLength=0,n.deformAttachment=n,n}return ttt(i,e),i.prototype.computeWorldVertices=function(t,e,i,n,s,r){i=s+(i>>1)*r;var o=t.bone.skeleton,a=t.deform,l=this.vertices,c=this.bones;if(null!=c){for(var h=0,_=0,u=0;u<e;u+=2)h+=(f=c[h])+1,_+=f;var m=o.bones;if(0==a.length)for(P=s,b=3*_;P<i;P+=r){var d=0,p=0,f=c[h++];for(f+=h;h<f;h++,b+=3){x=m[c[h]],I=l[b],D=l[b+1];var g=l[b+2];d+=(I*x.a+D*x.b+x.worldX)*g,p+=(I*x.c+D*x.d+x.worldY)*g}n[P]=d,n[P+1]=p}else for(var y=a,v=(P=s,b=3*_,_<<1);P<i;P+=r){for(d=0,p=0,f=c[h++],f+=h;h<f;h++,b+=3,v+=2)x=m[c[h]],I=l[b]+y[v],D=l[b+1]+y[v+1],g=l[b+2],d+=(I*x.a+D*x.b+x.worldX)*g,p+=(I*x.c+D*x.d+x.worldY)*g;n[P]=d,n[P+1]=p}}else{a.length>0&&(l=a);for(var x,S=(x=t.bone).worldX,A=x.worldY,C=x.a,b=x.b,T=x.c,w=x.d,E=e,P=s;P<i;E+=2,P+=r){var I=l[E],D=l[E+1];n[P]=I*C+D*b+S,n[P+1]=I*T+D*w+A}}},i.prototype.copyTo=function(e){null!=this.bones?(e.bones=new Array(this.bones.length),t.Utils.arrayCopy(this.bones,0,e.bones,0,this.bones.length)):e.bones=null,null!=this.vertices?(e.vertices=t.Utils.newFloatArray(this.vertices.length),t.Utils.arrayCopy(this.vertices,0,e.vertices,0,this.vertices.length)):e.vertices=null,e.worldVerticesLength=this.worldVerticesLength,e.deformAttachment=this.deformAttachment},i.nextID=0,i}(e);t.VertexAttachment=i}(Q9||(Q9={})),function(t){var e;(e=t.AttachmentType||(t.AttachmentType={}))[e.Region=0]="Region",e[e.BoundingBox=1]="BoundingBox",e[e.Mesh=2]="Mesh",e[e.LinkedMesh=3]="LinkedMesh",e[e.Path=4]="Path",e[e.Point=5]="Point",e[e.Clipping=6]="Clipping"}(Q9||(Q9={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.color=new t.Color(1,1,1,1),n}return ttt(i,e),i.prototype.copy=function(){var t=new i(name);return this.copyTo(t),t.color.setFromColor(this.color),t},i}(t.VertexAttachment);t.BoundingBoxAttachment=e}(Q9||(Q9={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.color=new t.Color(.2275,.2275,.8078,1),n}return ttt(i,e),i.prototype.copy=function(){var t=new i(name);return this.copyTo(t),t.endSlot=this.endSlot,t.color.setFromColor(this.color),t},i}(t.VertexAttachment);t.ClippingAttachment=e}(Q9||(Q9={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.color=new t.Color(1,1,1,1),n.tempColor=new t.Color(0,0,0,0),n}return ttt(i,e),i.prototype.updateUVs=function(){var e=this.regionUVs;null!=this.uvs&&this.uvs.length==e.length||(this.uvs=t.Utils.newFloatArray(e.length));var i=this.uvs,n=this.uvs.length,s=this.region.u,r=this.region.v,o=0,a=0;if(this.region instanceof t.TextureAtlasRegion){var l=this.region,c=l.texture.getImage().width,h=l.texture.getImage().height;switch(l.degrees){case 90:s-=(l.originalHeight-l.offsetY-l.height)/c,r-=(l.originalWidth-l.offsetX-l.width)/h,o=l.originalHeight/c,a=l.originalWidth/h;for(var _=0;_<n;_+=2)i[_]=s+e[_+1]*o,i[_+1]=r+(1-e[_])*a;return;case 180:for(s-=(l.originalWidth-l.offsetX-l.width)/c,r-=l.offsetY/h,o=l.originalWidth/c,a=l.originalHeight/h,_=0;_<n;_+=2)i[_]=s+(1-e[_])*o,i[_+1]=r+(1-e[_+1])*a;return;case 270:for(s-=l.offsetY/c,r-=l.offsetX/h,o=l.originalHeight/c,a=l.originalWidth/h,_=0;_<n;_+=2)i[_]=s+(1-e[_+1])*o,i[_+1]=r+e[_]*a;return}s-=l.offsetX/c,r-=(l.originalHeight-l.offsetY-l.height)/h,o=l.originalWidth/c,a=l.originalHeight/h}else null==this.region?(s=r=0,o=a=1):(o=this.region.u2-s,a=this.region.v2-r);for(_=0;_<n;_+=2)i[_]=s+e[_]*o,i[_+1]=r+e[_+1]*a},i.prototype.getParentMesh=function(){return this.parentMesh},i.prototype.setParentMesh=function(t){this.parentMesh=t,null!=t&&(this.bones=t.bones,this.vertices=t.vertices,this.worldVerticesLength=t.worldVerticesLength,this.regionUVs=t.regionUVs,this.triangles=t.triangles,this.hullLength=t.hullLength,this.worldVerticesLength=t.worldVerticesLength)},i.prototype.copy=function(){if(null!=this.parentMesh)return this.newLinkedMesh();var e=new i(this.name);return e.region=this.region,e.path=this.path,e.color.setFromColor(this.color),this.copyTo(e),e.regionUVs=new Array(this.regionUVs.length),t.Utils.arrayCopy(this.regionUVs,0,e.regionUVs,0,this.regionUVs.length),e.uvs=new Array(this.uvs.length),t.Utils.arrayCopy(this.uvs,0,e.uvs,0,this.uvs.length),e.triangles=new Array(this.triangles.length),t.Utils.arrayCopy(this.triangles,0,e.triangles,0,this.triangles.length),e.hullLength=this.hullLength,null!=this.edges&&(e.edges=new Array(this.edges.length),t.Utils.arrayCopy(this.edges,0,e.edges,0,this.edges.length)),e.width=this.width,e.height=this.height,e},i.prototype.newLinkedMesh=function(){var t=new i(this.name);return t.region=this.region,t.path=this.path,t.color.setFromColor(this.color),t.deformAttachment=this.deformAttachment,t.setParentMesh(null!=this.parentMesh?this.parentMesh:this),t.updateUVs(),t},i}(t.VertexAttachment);t.MeshAttachment=e}(Q9||(Q9={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.closed=!1,n.constantSpeed=!1,n.color=new t.Color(1,1,1,1),n}return ttt(i,e),i.prototype.copy=function(){var e=new i(name);return this.copyTo(e),e.lengths=new Array(this.lengths.length),t.Utils.arrayCopy(this.lengths,0,e.lengths,0,this.lengths.length),e.closed=closed,e.constantSpeed=this.constantSpeed,e.color.setFromColor(this.color),e},i}(t.VertexAttachment);t.PathAttachment=e}(Q9||(Q9={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.color=new t.Color(.38,.94,0,1),n}return ttt(i,e),i.prototype.computeWorldPosition=function(t,e){return e.x=this.x*t.a+this.y*t.b+t.worldX,e.y=this.x*t.c+this.y*t.d+t.worldY,e},i.prototype.computeWorldRotation=function(e){var i=t.MathUtils.cosDeg(this.rotation),n=t.MathUtils.sinDeg(this.rotation),s=i*e.a+n*e.b,r=i*e.c+n*e.d;return Math.atan2(r,s)*t.MathUtils.radDeg},i.prototype.copy=function(){var t=new i(name);return t.x=this.x,t.y=this.y,t.rotation=this.rotation,t.color.setFromColor(this.color),t},i}(t.VertexAttachment);t.PointAttachment=e}(Q9||(Q9={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.x=0,n.y=0,n.scaleX=1,n.scaleY=1,n.rotation=0,n.width=0,n.height=0,n.color=new t.Color(1,1,1,1),n.offset=t.Utils.newFloatArray(8),n.uvs=t.Utils.newFloatArray(8),n.tempColor=new t.Color(1,1,1,1),n}return ttt(i,e),i.prototype.updateOffset=function(){var t=this.width/this.region.originalWidth*this.scaleX,e=this.height/this.region.originalHeight*this.scaleY,n=-this.width/2*this.scaleX+this.region.offsetX*t,s=-this.height/2*this.scaleY+this.region.offsetY*e,r=n+this.region.width*t,o=s+this.region.height*e,a=this.rotation*Math.PI/180,l=Math.cos(a),c=Math.sin(a),h=n*l+this.x,_=n*c,u=s*l+this.y,m=s*c,d=r*l+this.x,p=r*c,f=o*l+this.y,g=o*c,y=this.offset;y[i.OX1]=h-m,y[i.OY1]=u+_,y[i.OX2]=h-g,y[i.OY2]=f+_,y[i.OX3]=d-g,y[i.OY3]=f+p,y[i.OX4]=d-m,y[i.OY4]=u+p},i.prototype.setRegion=function(t){this.region=t;var e=this.uvs;t.rotate?(e[2]=t.u,e[3]=t.v2,e[4]=t.u,e[5]=t.v,e[6]=t.u2,e[7]=t.v,e[0]=t.u2,e[1]=t.v2):(e[0]=t.u,e[1]=t.v2,e[2]=t.u,e[3]=t.v,e[4]=t.u2,e[5]=t.v,e[6]=t.u2,e[7]=t.v2)},i.prototype.computeWorldVertices=function(t,e,n,s){var r=this.offset,o=t.worldX,a=t.worldY,l=t.a,c=t.b,h=t.c,_=t.d,u=0,m=0;u=r[i.OX1],m=r[i.OY1],e[n]=u*l+m*c+o,e[n+1]=u*h+m*_+a,n+=s,u=r[i.OX2],m=r[i.OY2],e[n]=u*l+m*c+o,e[n+1]=u*h+m*_+a,n+=s,u=r[i.OX3],m=r[i.OY3],e[n]=u*l+m*c+o,e[n+1]=u*h+m*_+a,n+=s,u=r[i.OX4],m=r[i.OY4],e[n]=u*l+m*c+o,e[n+1]=u*h+m*_+a},i.prototype.copy=function(){var e=new i(name);return e.region=this.region,e.rendererObject=this.rendererObject,e.path=this.path,e.x=this.x,e.y=this.y,e.scaleX=this.scaleX,e.scaleY=this.scaleY,e.rotation=this.rotation,e.width=this.width,e.height=this.height,t.Utils.arrayCopy(this.uvs,0,e.uvs,0,8),t.Utils.arrayCopy(this.offset,0,e.offset,0,8),e.color.setFromColor(this.color),e},i.OX1=0,i.OY1=1,i.OX2=2,i.OY2=3,i.OX3=4,i.OY3=5,i.OX4=6,i.OY4=7,i.X1=0,i.Y1=1,i.C1R=2,i.C1G=3,i.C1B=4,i.C1A=5,i.U1=6,i.V1=7,i.X2=8,i.Y2=9,i.C2R=10,i.C2G=11,i.C2B=12,i.C2A=13,i.U2=14,i.V2=15,i.X3=16,i.Y3=17,i.C3R=18,i.C3G=19,i.C3B=20,i.C3A=21,i.U3=22,i.V3=23,i.X4=24,i.Y4=25,i.C4R=26,i.C4G=27,i.C4B=28,i.C4A=29,i.U4=30,i.V4=31,i}(t.Attachment);t.RegionAttachment=e}(Q9||(Q9={})),function(t){var e=function(){function e(t,e){this.jitterX=0,this.jitterY=0,this.jitterX=t,this.jitterY=e}return e.prototype.begin=function(){},e.prototype.transform=function(e){e.x+=t.MathUtils.randomTriangular(-this.jitterX,this.jitterY),e.y+=t.MathUtils.randomTriangular(-this.jitterX,this.jitterY)},e.prototype.end=function(){},e}();t.JitterEffect=e}(Q9||(Q9={})),function(t){var e=function(){function e(t,e){this.centerX=0,this.centerY=0,this.radius=0,this.angle=0,this.worldX=0,this.worldY=0,this.radius=t,this.interpolation=e}return e.prototype.begin=function(t){this.worldX=t.x+this.centerX,this.worldY=t.y+this.centerY},e.prototype.transform=function(e){var i=this.angle*t.MathUtils.degreesToRadians,n=e.x-this.worldX,s=e.y-this.worldY,r=Math.sqrt(n*n+s*s);if(r<this.radius){var o=this.interpolation.apply(0,i,(this.radius-r)/this.radius),a=Math.cos(o),l=Math.sin(o);e.x=a*n-l*s+this.worldX,e.y=l*n+a*s+this.worldY}},e.prototype.end=function(){},e.interpolation=new t.PowOut(2),e}();t.SwirlEffect=e}(Q9||(Q9={}));var ett=Q9;const itt=1/60,ntt=[],stt=[];let rtt,ott,att,ltt,ctt,htt,_tt=0,utt=0,mtt=0,dtt=null,ptt=null,ftt=0,gtt=0,ytt=0,vtt=0,xtt=null,Stt=null,Att=0,Ctt=0;const btt=new ett.Color(1,1,1,1),Ttt=new ett.Color(1,1,1,1),wtt=[0,1,2,2,3,0];class Ett{constructor(){this.frames=[],this.totalTime=0,this.isCompleted=!1,this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this._frameIdx=-1,this._skeletonInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null,this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this.frames=[],this.totalTime=0,this._frameIdx=-1,this.isCompleted=!1,this._skeletonInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null}init(t,e){this._inited=!0,this._animationName=e,this._skeletonInfo=t}clear(){this._inited=!1;for(let t=0,e=this.frames.length;t<e;t++)this.frames[t].segments.length=0;this.invalidAllFrame()}bind(t){t.complete=t=>{t&&t.animation.name===this._animationName&&(this.isCompleted=!0)}}unbind(t){t.complete=null}begin(){if(!this._invalid)return;const t=this._skeletonInfo,e=null==t?void 0:t.curAnimationCache;e&&e!==this&&(this._privateMode?e.invalidAllFrame():e.updateToFrame());const i=null==t?void 0:t.skeleton,n=null==t?void 0:t.listener,s=null==t?void 0:t.state,r=null==i?void 0:i.data.findAnimation(this._animationName);null==s||s.setAnimationWith(0,r,!1),this.bind(n),t.curAnimationCache=this,this._frameIdx=-1,this.isCompleted=!1,this.totalTime=0,this._invalid=!1}end(){this.needToUpdate()||(this._skeletonInfo.curAnimationCache=null,this.frames.length=this._frameIdx+1,this.isCompleted=!0,this.unbind(this._skeletonInfo.listener))}updateToFrame(t){if(!this._inited)return;if(this.begin(),!this.needToUpdate(t))return;const e=this._skeletonInfo,i=null==e?void 0:e.skeleton,n=null==e?void 0:e.clipper,s=null==e?void 0:e.state;do{null==i||i.update(itt),null==s||s.update(itt),null==s||s.apply(i),null==i||i.updateWorldTransform(),this._frameIdx++,this.updateFrame(i,n,this._frameIdx),this.totalTime+=itt}while(this.needToUpdate(t));this.end()}isInited(){return this._inited}isInvalid(){return this._invalid}invalidAllFrame(){this.isCompleted=!1,this._invalid=!0}updateAllFrame(){this.invalidAllFrame(),this.updateToFrame()}enableCacheAttachedInfo(){this._enableCacheAttachedInfo||(this._enableCacheAttachedInfo=!0,this.invalidAllFrame())}fillVertices(t,e,i,n,s){if(ltt=i.a*e.a*t.a*255,rtt=e.r*t.r*255,ott=e.g*t.g*255,att=e.b*t.b*255,btt.r=rtt*i.r,btt.g=ott*i.g,btt.b=att*i.b,btt.a=ltt,null==s.darkColor?Ttt.set(0,0,0,1):(Ttt.r=s.darkColor.r*rtt,Ttt.g=s.darkColor.g*ott,Ttt.b=s.darkColor.b*att),Ttt.a=0,ctt=(btt.a<<24>>>0)+(btt.b<<16)+(btt.g<<8)+btt.r,htt=(Ttt.a<<24>>>0)+(Ttt.b<<16)+(Ttt.g<<8)+Ttt.r,xtt!==ctt||Stt!==htt){const t=this._tempColors;xtt=ctt,Stt=htt,vtt>0&&(t[vtt-1].vfOffset=mtt),t[vtt++]={fr:btt.r,fg:btt.g,fb:btt.b,fa:btt.a,dr:Ttt.r,dg:Ttt.g,db:Ttt.b,da:Ttt.a,vfOffset:0}}if(n.isClipping()){n.clipTriangles(ntt,Att,stt,Ctt,ntt,btt,Ttt,!0,6,mtt,mtt+2);const t=n.clippedVertices,e=n.clippedTriangles;Ctt=e.length,Att=t.length/12*6;for(let t=0,i=utt,n=e.length;t<n;)stt[i++]=e[t++];for(let e=0,i=t.length,n=mtt;e<i;e+=12,n+=6)ntt[n]=t[e],ntt[n+1]=t[e+1],ntt[n+2]=t[e+6],ntt[n+3]=t[e+7],ntt[n+4]=ctt,ntt[n+5]=htt}else for(let t=mtt,e=mtt+Att;t<e;t+=6)ntt[t+4]=ctt,ntt[t+5]=htt}updateFrame(t,e,i){mtt=0,_tt=0,utt=0,dtt=null,ptt=null,ftt=0,gtt=0,ytt=0,vtt=0,xtt=null,Stt=null,this.frames[i]=this.frames[i]||{segments:[],colors:[],boneInfos:[],vertices:null,uintVert:null,indices:null};const n=this.frames[i],s=this._tempSegments=n.segments,r=this._tempColors=n.colors,o=this._tempBoneInfos=n.boneInfos;this.traverseSkeleton(t,e),vtt>0&&(r[vtt-1].vfOffset=mtt),r.length=vtt,o.length=_tt;const a=ytt-1;if(a>=0)if(gtt>0){const t=s[a];t.indexCount=gtt,t.vfCount=13*ftt,t.vertexCount=ftt,s.length=ytt}else s.length=ytt-1;if(0===s.length)return;let l=n.vertices;const c=mtt/6*13;(!l||l.length<c)&&(l=n.vertices=new Float32Array(c));for(let t=0,e=0;t<c;)l[t]=ntt[e++],l[t+1]=ntt[e++],l[t+3]=ntt[e++],l[t+4]=ntt[e++],this._setVerticeColor(ntt[e++],l,t+5),this._setVerticeColor(ntt[e++],l,t+9),t+=13;let h=n.indices;(!h||h.length<utt)&&(h=n.indices=new Uint16Array(utt));for(let t=0;t<utt;t++)h[t]=stt[t];n.vertices=l,n.indices=h}needToUpdate(t){return!this.isCompleted&&this.totalTime<30&&(void 0===t||this._frameIdx<t)}traverseSkeleton(t,e){const i=this._tempSegments,n=this._tempBoneInfos,s=t.color;let r,o,a,l,c,h,_,u,m,d,p,f,g;const y=t.bones;if(this._enableCacheAttachedInfo)for(let t=0,e=y.length;t<e;t++,_tt++){const e=y[t];let i=n[_tt];i||(i=n[_tt]={}),i.a=e.a,i.b=e.b,i.c=e.c,i.d=e.d,i.worldX=e.worldX,i.worldY=e.worldY}for(let n=0,y=t.drawOrder.length;n<y;n++)if(g=t.drawOrder[n],Att=0,Ctt=0,r=g.getAttachment(),r)if(h=r instanceof ett.RegionAttachment,_=r instanceof ett.MeshAttachment,u=r instanceof ett.ClippingAttachment,u)e.clipStart(g,r);else if(h||_)if(m=r.region.texture.getRealTexture(),m){if(f=g.data.blendMode,dtt===m.nativeUrl&&ptt===f||(dtt=m.nativeUrl,ptt=f,d=ytt-1,d>=0&&(gtt>0?(p=i[d],p.indexCount=gtt,p.vertexCount=ftt,p.vfCount=13*ftt):ytt--),i[ytt]={tex:m,blendMode:f,indexCount:0,vertexCount:0,vfCount:0},ytt++,gtt=0,ftt=0),h)c=wtt,Att=24,Ctt=6,r.computeWorldVertices(g.bone,ntt,mtt,6);else if(_){const t=r;c=t.triangles,Att=6*(t.worldVerticesLength>>1),Ctt=c.length,t.computeWorldVertices(g,0,t.worldVerticesLength,ntt,mtt,6)}if(0!==Att&&0!==Ctt){for(let t=0,e=utt,i=c.length;t<i;)stt[e++]=c[t++];l=r.uvs;for(let t=mtt,e=mtt+Att,i=0;t<e;t+=6,i+=2)ntt[t+2]=l[i],ntt[t+3]=l[i+1];if(o=r.color,a=g.color,this.fillVertices(s,o,a,e,g),Ctt>0){for(let t=utt,e=utt+Ctt;t<e;t++)stt[t]+=ftt;utt+=Ctt,mtt+=Att,gtt+=Ctt,ftt+=Att/6}e.clipEndWithSlot(g)}else e.clipEndWithSlot(g)}else e.clipEndWithSlot(g);else e.clipEndWithSlot(g);else e.clipEndWithSlot(g);e.clipEnd()}_setVerticeColor(t,e,i){e[i]=(255&t)/255,e[i+1]=(t>>8&255)/255,e[i+2]=(t>>16&255)/255,e[i+3]=(t>>24&255)/255}}class Ptt{constructor(){this._privateMode=void 0,this._skeletonCache=void 0,this._animationPool=void 0,this._privateMode=!1,this._animationPool={},this._skeletonCache={}}enablePrivateMode(){this._privateMode=!0}clear(){this._animationPool={},this._skeletonCache={}}removeSkeleton(t){const e=this._skeletonCache[t];if(!e)return;const i=e.animationsCache;for(const e in i){const n=i[e];n&&(this._animationPool[`${t}#${e}`]=n,n.clear())}delete this._skeletonCache[t]}getSkeletonCache(t,e){let i=this._skeletonCache[t];if(!i){const n=new ett.Skeleton(e),s=new ett.SkeletonClipping,r=new ett.AnimationStateData(n.data),o=new ett.AnimationState(r),a=new $9;o.addListener(a),this._skeletonCache[t]=i={skeleton:n,clipper:s,state:o,listener:a,animationsCache:{},curAnimationCache:null}}return i}getAnimationCache(t,e){const i=this._skeletonCache[t];return i?i.animationsCache[e]:null}invalidAnimationCache(t){const e=this._skeletonCache[t];if(!e||!e.skeleton)return;const i=e.animationsCache;for(const t in i)i[t].invalidAllFrame()}initAnimationCache(t,e){if(!e)return null;const i=this._skeletonCache[t],n=i&&i.skeleton;if(!n)return null;if(!n.data.findAnimation(e))return null;const s=i.animationsCache;let r=s[e];if(!r){const n=`${t}#${e}`;r=this._animationPool[n],r?delete this._animationPool[n]:(r=new Ett,r._privateMode=this._privateMode),r.init(i,e),s[e]=r}return r}updateAnimationCache(t,e){if(e){const i=this.initAnimationCache(t,e);if(!i)return null;i.updateAllFrame()}else{const e=this._skeletonCache[t];if(!e||!e.skeleton)return;const i=e.animationsCache;for(const t in i)i[t].updateAllFrame()}}}Ptt.FrameTime=itt,Ptt.sharedCache=new Ptt;const Itt=new Si;class Dtt{constructor(){this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null,this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null}init(t){this._inited=!0,this._skeleton=t._skeleton,this._skeletonNode=t.node,this._skeletonComp=t}reset(){this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null}_syncAttachedNode(){if(!this._inited)return;const t=this._skeletonComp.socketNodes;if(0===t.size)return;let e=null;if(e=this._skeletonComp.isAnimationCached()?this._skeletonComp._curFrame&&this._skeletonComp._curFrame.boneInfos:this._skeleton.bones,!e)return;const i=(t,e)=>{const i=Itt;i.m00=e.a,i.m01=e.c,i.m04=e.b,i.m05=e.d,i.m12=e.worldX,i.m13=e.worldY,t.matrix=Itt,t.scale=this._skeletonNode.scale};for(const n of t.keys()){const s=t.get(n);if(!s||!s.isValid){t.delete(n);continue}const r=e[n];r?i(s,r):(s.removeFromParent(),s.destroy(),t.delete(n))}}}class Rtt extends ett.Texture{constructor(t){super(t),this.name="sp.SkeletonTexture",this._texture=null,this._material=null}setRealTexture(t){this._texture=t}getRealTexture(){return this._texture?this._texture instanceof Ru?this._texture._texture:this._texture:null}setFilters(t,e){this._texture&&this.getRealTexture().setFilters(Mtt(t),Mtt(e))}setWraps(t,e){this._texture&&this.getRealTexture().setWrapMode(Btt(t),Btt(e))}dispose(){}}function Mtt(t){switch(t){case ett.TextureFilter.Nearest:case ett.TextureFilter.MipMapNearestNearest:case ett.TextureFilter.MipMapLinearNearest:return Cu.NEAREST;case ett.TextureFilter.MipMap:case ett.TextureFilter.MipMapNearestLinear:case ett.TextureFilter.MipMapLinearLinear:case ett.TextureFilter.Linear:default:return Cu.LINEAR}}function Btt(t){switch(t){case ett.TextureWrap.MirroredRepeat:return Au.MIRRORED_REPEAT;case ett.TextureWrap.ClampToEdge:return Au.CLAMP_TO_EDGE;case ett.TextureWrap.Repeat:default:return Au.REPEAT}}var Ott,Ntt,Ltt,Ftt,ztt,Vtt,Utt,Gtt,Htt,ktt;let jtt=(Ott=u_("sp.SkeletonData"),Ntt=H_([Zm]),Ltt=H_([pe]),Ott((Vtt=n_((ztt=class extends xu{get skeletonJsonStr(){return this._skeletonJson?JSON.stringify(this._skeletonJson):""}get skeletonJson(){return this._skeletonJson}set skeletonJson(t){this.reset(),this._skeletonJson="string"==typeof t?JSON.parse(t):t,!this._uuid&&t.skeleton&&(this._uuid=t.skeleton.hash)}get atlasText(){return this._atlasText}set atlasText(t){this._atlasText=t,this.reset()}get _nativeAsset(){return this._buffer}set _nativeAsset(t){this._buffer=t,this.reset()}constructor(){super(),i_(this,"_skeletonJson",Vtt,this),i_(this,"textures",Utt,this),i_(this,"textureNames",Gtt,this),i_(this,"scale",Htt,this),i_(this,"_atlasText",ktt,this),this._buffer=void 0,this._skeletonCache=null,this._atlasCache=null,this._skinsEnum=null,this._animsEnum=null,this.reset()}createNode(t){const e=new uf(this.name);return e.addComponent("cc.Skeleton").skeletonData=this,t(null,e)}reset(){this._skeletonCache=null,this._atlasCache=null}resetEnums(){}ensureTexturesLoaded(t,e){const i=this.textures,n=i.length;if(0===n)return void(t&&t.call(e,!1));let s=0;const r=()=>{s++,s>=n&&(t&&t.call(e,!0),t=null)};for(let t=0;t<n;t++){const e=i[t];e.loaded?r():e.once("load",r)}}isTexturesLoaded(){const t=this.textures,e=t.length;for(let i=0;i<e;i++)if(!t[i].loaded)return!1;return!0}getRuntimeData(t){if(this._skeletonCache)return this._skeletonCache;if(!(this.textures&&this.textures.length>0)&&this.textureNames&&this.textureNames.length>0)return t||console.error(`${this.name} no textures found!`),null;const e=this._getAtlas(t);if(!e)return null;const i=new ett.AtlasAttachmentLoader(e);let n=null,s=null;return this.skeletonJson?(s=new ett.SkeletonJson(i),n=this.skeletonJson):(s=new ett.SkeletonBinary(i),n=new Uint8Array(this._nativeAsset)),s.scale=this.scale,this._skeletonCache=s.readSkeletonData(n),e.dispose(),this._skeletonCache}getSkinsEnum(){if(this._skinsEnum)return this._skinsEnum;const t=this.getRuntimeData(!0);if(t){const e=t.skins,i={};for(let t=0;t<e.length;t++)i[e[t].name]=t;return this._skinsEnum=Gt(i)}return null}getAnimsEnum(){if(this._animsEnum&&Object.keys(this._animsEnum).length>1)return this._animsEnum;const t=this.getRuntimeData(!0);if(t){const e={"<None>":0},i=t.animations;for(let t=0;t<i.length;t++)e[i[t].name]=t+1;return this._animsEnum=Gt(e)}return null}destroy(){return Ptt.sharedCache.removeSkeleton(this._uuid),super.destroy()}_getTexture(t){const e=this.textureNames;for(let i=0;i<e.length;i++)if(e[i]===t){const t=this.textures[i],e=new Rtt({width:t.width,height:t.height});return e.setRealTexture(t),e}return console.error(`${this.name} no textures found!`),null}_getAtlas(t){return this._atlasCache?this._atlasCache:this.atlasText?this._atlasCache=new ett.TextureAtlas(this.atlasText,this._getTexture.bind(this)):(t||console.error(`${this.name} no atlas found!`),null)}}).prototype,"_skeletonJson",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Utt=n_(ztt.prototype,"textures",[g_,Ntt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gtt=n_(ztt.prototype,"textureNames",[g_,Ltt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Htt=n_(ztt.prototype,"scale",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ktt=n_(ztt.prototype,"_atlasText",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ftt=ztt))||Ftt);var Wtt,qtt,Xtt,Ytt,Ktt,Jtt,$tt,Ztt,Qtt,tet,eet,iet,net,set,ret,oet,aet,cet,het,_et,uet,met,det,pet,fet,get,yet,vet,xet,Aet,Cet,bet,Tet,wet,Eet,Pet,Iet,Det,Ret,Met,Bet,Oet,Net,Let,Fet,zet,Vet,Uet,Get,Het,ket,jet,Wet;let qet,Xet,Yet,Ket;function Jet(t,e,i){Me.Attr.setClassAttr(t,e,"type","Enum"),Me.Attr.setClassAttr(t,e,"enumList",Gt.getList(i))}n.internal.SpineSkeletonData=jtt,function(t){t[t.default=0]="default"}(qet||(qet={})),jt(qet),function(t){t[t["<None>"]=0]="<None>"}(Xet||(Xet={})),jt(Xet),function(t){t[t.REALTIME=0]="REALTIME",t[t.SHARED_CACHE=1]="SHARED_CACHE",t[t.PRIVATE_CACHE=2]="PRIVATE_CACHE"}(Yet||(Yet={})),jt(Yet),function(t){t[t.COLORED_TEXTURED=0]="COLORED_TEXTURED",t[t.TWO_COLORED=1]="TWO_COLORED"}(Ket||(Ket={}));let $et=(Wtt=u_("sp.Skeleton.SpineSocket"),qtt=H_(uf),Wtt((Ktt=n_((Ytt=class{constructor(t="",e=null){i_(this,"path",Ktt,this),i_(this,"target",Jtt,this),this.path=t,this.target=e}}).prototype,"path",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Jtt=n_(Ytt.prototype,"target",[qtt,w_,g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xtt=Ytt))||Xtt);Vt.setClassAlias($et,"sp.Skeleton.SpineSocket");let Zet=($tt=u_("sp.Skeleton"),Ztt=T_(),Qtt=S_(),tet=H_(ov),eet=N_(),iet=P_(),net=E_(),set=H_(jtt),ret=P_(),oet=H_(qet),aet=I_(),cet=P_(),het=H_(Xet),_et=I_(),uet=P_(),met=I_(),det=H_(Yet),pet=I_(),fet=I_(),get=I_(),yet=I_(),vet=I_(),xet=I_(),Aet=I_(),Cet=H_([$et]),bet=I_(),Tet=E_(),wet=E_(),$tt(Eet=Ztt(Eet=Qtt(Eet=x_((Wet=jet=class t extends wB{get meshRenderDataArray(){return this._meshRenderDataArray}get customMaterial(){return this._customMaterial}set customMaterial(t){this._customMaterial=t,this._cleanMaterialCache()}get skeletonData(){return this._skeletonData}set skeletonData(t){t&&t.resetEnums(),this._skeletonData!=t&&(this._skeletonData=t,this.defaultSkin="",this.defaultAnimation="",this._updateSkeletonData())}get animation(){if(this.isAnimationCached())return this._animationName;const t=this.getCurrent(0);return t&&t.animation.name||""}set animation(t){t?(this.setAnimation(0,t,this.loop),this.destroyRenderData(),this.markForUpdateRenderData()):this.isAnimationCached()||(this.clearTrack(0),this.setToSetupPose())}get _defaultSkinIndex(){if(this.skeletonData){const t=this.skeletonData.getSkinsEnum();if(t)if(""===this.defaultSkin){if(t.hasOwnProperty(0))return this._defaultSkinIndex=0,0}else{const e=t[this.defaultSkin];if(void 0!==e)return e}}return 0}set _defaultSkinIndex(t){let e;if(this.skeletonData&&(e=this.skeletonData.getSkinsEnum()),!e)return void console.error(`${this.name} skin enums are invalid`);const i=e[t];void 0!==i?(this.defaultSkin=i,this.setSkin(this.defaultSkin)):console.error(`${this.name} skin enums are invalid`)}get _animationIndex(){const t=this.animation;if(this.skeletonData)if(t){const e=this.skeletonData.getAnimsEnum();if(e){const i=e[t];if(void 0!==i)return i}}else this._refreshInspector();return 0}set _animationIndex(t){let e;if(this.skeletonData&&(e=this.skeletonData.getAnimsEnum()),!e)return void console.error(`${this.name} animation enums are invalid`);const i=e[t];void 0!==i?(this.animation=i,this.animation=i):console.error(`${this.name} animation enums are invalid`)}get defaultCacheMode(){return this._defaultCacheMode}set defaultCacheMode(t){this._defaultCacheMode=t,this.setAnimationCacheMode(this._defaultCacheMode)}get premultipliedAlpha(){return this._premultipliedAlpha}set premultipliedAlpha(t){t!==this._premultipliedAlpha&&(this._premultipliedAlpha=t,this.markForUpdateRenderData())}get timeScale(){return this._timeScale}set timeScale(t){t!==this._timeScale&&(this._timeScale=t)}get debugSlots(){return this._debugSlots}set debugSlots(t){t!==this._debugSlots&&(this._debugSlots=t,this._updateDebugDraw(),this.markForUpdateRenderData())}get debugBones(){return this._debugBones}set debugBones(t){t!==this._debugBones&&(this._debugBones=t,this._updateDebugDraw(),this.markForUpdateRenderData())}get debugMesh(){return this._debugMesh}set debugMesh(t){t!==this._debugMesh&&(this._debugMesh=t,this._updateDebugDraw(),this.markForUpdateRenderData())}get useTint(){return this._useTint}set useTint(t){t!==this._useTint&&(this._useTint=t,this._updateUseTint(),this.markForUpdateRenderData())}get sockets(){return this._sockets}set sockets(t){this._sockets=t,this._updateSocketBindings(),this.attachUtil._syncAttachedNode()}get socketNodes(){return this._socketNodes}constructor(){super(),i_(this,"paused",Iet,this),i_(this,"loop",Det,this),i_(this,"_premultipliedAlpha",Ret,this),i_(this,"_timeScale",Met,this),this.enableBatch=!1,this._frameCache=null,this._curFrame=null,this._effectDelegate=null,this._skeleton=void 0,this._clipper=void 0,this._debugRenderer=void 0,this._startSlotIndex=void 0,this._endSlotIndex=void 0,this._startEntry=void 0,this._endEntry=void 0,this.attachUtil=void 0,this._materialCache={},this._enumSkins=Gt({}),this._enumAnimations=Gt({}),this._accTime=0,this._playCount=0,this._skeletonCache=null,this._animationName="",this._animationQueue=[],this._headAniInfo=null,this._playTimes=0,this._isAniComplete=!0,i_(this,"_useTint",Bet,this),i_(this,"_preCacheMode",Oet,this),i_(this,"_cacheMode",Net,this),i_(this,"_defaultCacheMode",Let,this),i_(this,"_debugBones",Fet,this),i_(this,"_debugSlots",zet,this),i_(this,"_skeletonData",Vet,this),i_(this,"defaultSkin",Uet,this),i_(this,"defaultAnimation",Get,this),i_(this,"_sockets",Het,this),this._meshRenderDataArray=[],i_(this,"_debugMesh",ket,this),this._rootBone=void 0,this._state=void 0,this._listener=void 0,this._socketNodes=new Map,this._cachedSockets=new Map,this._meshRenderDataArrayIdx=0,this._effectDelegate=null,this._skeleton=null,this._rootBone=null,this._listener=null,this._debugRenderer=null,this._startSlotIndex=-1,this._endSlotIndex=-1,this._startEntry={animation:{name:""},trackIndex:0},this._endEntry={animation:{name:""},trackIndex:0},this.attachUtil=new Dtt,Jet(this,"_defaultSkinIndex",this._enumSkins),Jet(this,"_animationIndex",this._enumAnimations)}disableRender(){this.destroyRenderData()}setSkeletonData(t){const e=this.node._uiProps.uiTransformComp;if(null!=t.width&&null!=t.height&&e.setContentSize(t.width,t.height),this._cacheMode===Yet.SHARED_CACHE?this._skeletonCache=Ptt.sharedCache:this._cacheMode===Yet.PRIVATE_CACHE&&(this._skeletonCache=new Ptt,this._skeletonCache.enablePrivateMode()),this.isAnimationCached()){(this.debugBones||this.debugSlots)&&m("Debug bones or slots is invalid in cached mode");const e=this._skeletonCache.getSkeletonCache(this.skeletonData._uuid,t);this._skeleton=e.skeleton,this._clipper=e.clipper,this._rootBone=this._skeleton.getRootBone()}else this._skeleton=new ett.Skeleton(t),this._clipper=new ett.SkeletonClipping,this._rootBone=this._skeleton.getRootBone();this.markForUpdateRenderData()}setSlotsRange(t,e){this.isAnimationCached()?m("Slots visible range can not be modified in cached mode."):(this._startSlotIndex=t,this._endSlotIndex=e)}setAnimationStateData(t){if(this.isAnimationCached())m("'setAnimationStateData' interface can not be invoked in cached mode.");else{const e=new ett.AnimationState(t);this._listener&&(this._state&&this._state.removeListener(this._listener),e.addListener(this._listener)),this._state=e}}__preload(){super.__preload();const t=this.node.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];i&&"DEBUG_DRAW_NODE"===i.name&&i.destroy()}this._updateSkeletonData(),this._updateDebugDraw(),this._updateUseTint(),this._indexBoneSockets(),this._updateSocketBindings()}setAnimationCacheMode(t){this._preCacheMode!==t&&(this._cacheMode=t,this._updateSkeletonData(),this._updateUseTint(),this._updateSocketBindings(),this.markForUpdateRenderData())}isAnimationCached(){return this._cacheMode!==Yet.REALTIME}update(t){if(!this.paused)if(t*=1*this._timeScale,this.isAnimationCached()){if(this._isAniComplete){if(0===this._animationQueue.length&&!this._headAniInfo){const t=this._frameCache;if(t&&t.isInvalid()){t.updateToFrame();const e=t.frames;this._curFrame=e[e.length-1]}return}if(this._headAniInfo||(this._headAniInfo=this._animationQueue.shift()),this._accTime+=t,this._accTime>this._headAniInfo.delay){const t=this._headAniInfo;this._headAniInfo=null,this.setAnimation(0,t.animationName,t.loop)}return}this._updateCache(t)}else this._updateRealtime(t)}setVertexEffectDelegate(t){this._effectDelegate=t}setToSetupPose(){this._skeleton&&this._skeleton.setToSetupPose()}setBonesToSetupPose(){this._skeleton&&this._skeleton.setBonesToSetupPose()}setSlotsToSetupPose(){this._skeleton&&this._skeleton.setSlotsToSetupPose()}updateAnimationCache(t){if(!this.isAnimationCached())return;const e=this._skeletonData._uuid;this._skeletonCache&&this._skeletonCache.updateAnimationCache(e,t)}invalidAnimationCache(){this.isAnimationCached()&&this._skeletonCache&&this._skeletonCache.invalidAnimationCache(this._skeletonData._uuid)}findBone(t){return this._skeleton?this._skeleton.findBone(t):null}findSlot(t){return this._skeleton?this._skeleton.findSlot(t):null}setSkin(t){this._skeleton&&(this._skeleton.setSkinByName(t),this._skeleton.setSlotsToSetupPose()),this.invalidAnimationCache()}getAttachment(t,e){return this._skeleton?this._skeleton.getAttachmentByName(t,e):null}setAttachment(t,e){this._skeleton&&this._skeleton.setAttachment(t,e),this.invalidAnimationCache()}getTextureAtlas(t){return t.region}setMix(t,e,i){this._state&&this._state.data.setMix(t,e,i)}setAnimation(t,e,i){if(this._playTimes=i?0:1,this._animationName=e,this.isAnimationCached()){if(0!==t&&m("Track index can not greater than 0 in cached mode."),!this._skeletonCache)return null;let i=this._skeletonCache.getAnimationCache(this._skeletonData._uuid,e);i||(i=this._skeletonCache.initAnimationCache(this._skeletonData._uuid,e)),i&&(this._isAniComplete=!1,this._accTime=0,this._playCount=0,this._frameCache=i,this._socketNodes.size>0&&this._frameCache.enableCacheAttachedInfo(),this._frameCache.updateToFrame(0),this._curFrame=this._frameCache.frames[0])}else if(this._skeleton){const n=this._skeleton.data.findAnimation(e);if(!n)return S(7509,e),null;const s=this._state.setAnimationWith(t,n,i);return this._state.apply(this._skeleton),s}return null}addAnimation(t,e,i,n){if(n=n||0,this.isAnimationCached())0!==t&&m("Track index can not greater than 0 in cached mode."),this._animationQueue.push({animationName:e,loop:i,delay:n});else if(this._skeleton){var s;const r=this._skeleton.data.findAnimation(e);return r?null===(s=this._state)||void 0===s?void 0:s.addAnimationWith(t,r,i,n):(S(7510,e),null)}return null}findAnimation(t){return this._skeleton?this._skeleton.data.findAnimation(t):null}getCurrent(t){if(this.isAnimationCached())m("'getCurrent' interface can not be invoked in cached mode.");else if(this._state)return this._state.getCurrent(t);return null}clearTracks(){this.isAnimationCached()?m("'clearTracks' interface can not be invoked in cached mode."):this._state&&this._state.clearTracks()}clearTrack(t){this.isAnimationCached()?m("'clearTrack' interface can not be invoked in cached mode."):this._state&&this._state.clearTrack(t)}setStartListener(t){this._ensureListener(),this._listener.start=t}setInterruptListener(t){this._ensureListener(),this._listener.interrupt=t}setEndListener(t){this._ensureListener(),this._listener.end=t}setDisposeListener(t){this._ensureListener(),this._listener.dispose=t}setCompleteListener(t){this._ensureListener(),this._listener.complete=t}setEventListener(t){this._ensureListener(),this._listener.event=t}setTrackStartListener(t,e){$9.getListeners(t).start=e}setTrackInterruptListener(t,e){$9.getListeners(t).interrupt=e}setTrackEndListener(t,e){$9.getListeners(t).end=e}setTrackDisposeListener(t,e){$9.getListeners(t).dispose=e}setTrackCompleteListener(t,e){$9.getListeners(t).complete=function(t){const i=Math.floor(t.trackTime/t.animationEnd);e(t,i)}}setTrackEventListener(t,e){$9.getListeners(t).event=e}getState(){return this._state}onEnable(){super.onEnable(),this._flushAssembler()}onDisable(){super.onDisable()}onDestroy(){this._cleanMaterialCache(),this.destroyRenderData(),super.onDestroy()}requestMeshRenderData(t){if(this._meshRenderDataArray.length>0&&0===this._meshRenderDataArray[this._meshRenderDataArray.length-1].renderData.vertexCount)return this._meshRenderDataArray[this._meshRenderDataArray.length-1];const e=new BM(t),i={renderData:e};return e.material=null,this._meshRenderDataArray.push(i),i}destroyRenderData(){this._meshRenderDataArray.length>0&&(this._meshRenderDataArray.forEach((t=>{t.renderData.reset()})),this._meshRenderDataArray.length=0)}getMaterialForBlendAndTint(t,e,i){const n=`${i}/${t}/${e}`;let s=this._materialCache[n];if(s)return s;let r=this.customMaterial;null===r&&(r=Bd.get("default-spine-material"));let o=!1;switch(i){case Ket.TWO_COLORED:o=!0;break;case Ket.COLORED_TEXTURED:}return s=new lv({parent:r,subModelIdx:0,owner:this}),this._materialCache[n]=s,s.overridePipelineStates({blendState:{blendColor:si.WHITE,targets:[{blendEq:oo.ADD,blendAlphaEq:oo.ADD,blendSrc:t,blendDst:e,blendSrcAlpha:t,blendDstAlpha:e}]}}),s.recompileShaders({TWO_COLORED:o}),s}updateMaterial(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),void(this._blendHash=-1);const t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._updateBlendFunc(),this.premultipliedAlpha&&(this._blendHash=-1)}_updateBuiltinMaterial(){return Bd.get("ui-sprite-material")}querySockets(){return this._skeleton?(0===this._cachedSockets.size&&this._indexBoneSockets(),this._cachedSockets.size>0?Array.from(this._cachedSockets.keys()).sort():[]):[]}_render(t){if(this._meshRenderDataArray)for(let e=0;e<this._meshRenderDataArray.length;e++){const i=this.material;this._meshRenderDataArrayIdx=e;const n=this._meshRenderDataArray[e];n.renderData.material&&(this.material=n.renderData.material),n.texture&&t.commitComp(this,n.texture,this._assembler,null),this.material=i}}updateWorldTransform(){this.isAnimationCached()&&this._skeleton&&this._skeleton.updateWorldTransform()}_emitCacheCompleteEvent(){this._listener&&(this._endEntry.animation.name=this._animationName,this._listener.complete&&this._listener.complete(this._endEntry),this._listener.end&&this._listener.end(this._endEntry))}_updateCache(t){const e=this._frameCache;if(!e.isInited())return;const i=e.frames,n=Ptt.FrameTime;0===this._accTime&&0===this._playCount&&(this._startEntry.animation.name=this._animationName,this._listener&&this._listener.start&&this._listener.start(this._startEntry)),this._accTime+=t;let s=Math.floor(this._accTime/n);if(e.isCompleted||e.updateToFrame(s),e.isCompleted&&s>=i.length){if(this._playCount++,this._playTimes>0&&this._playCount>=this._playTimes)return this._curFrame=i[i.length-1],this._accTime=0,this._playCount=0,this._isAniComplete=!0,this._emitCacheCompleteEvent(),void this.markForUpdateRenderData();this._accTime=0,s=0,this._emitCacheCompleteEvent()}this._curFrame=i[s],this.markForUpdateRenderData()}_updateRealtime(t){const e=this._skeleton,i=this._state;e&&(e.update(t),i&&(i.update(t),i.apply(e)),this.markForUpdateRenderData())}_indexBoneSockets(){if(!this._skeleton)return;this._cachedSockets.clear();const t=this._skeleton.bones,e=i=>null==i.parent?i.data.name||"<Unamed>":`${e(t[i.parent.data.index])}/${i.data.name}`;for(let i=0,n=t.length;i<n;i++){const n=t[i].data,s=e(t[i]);this._cachedSockets.set(s,n.index)}}_updateUseTint(){this.destroyRenderData()}_updateBatch(){this.markForUpdateRenderData()}_validateRender(){const t=this.skeletonData;t&&t.isTexturesLoaded()||this.disableRender()}_updateAnimEnum(){let t;t=this.skeletonData?this.skeletonData.getAnimsEnum():Xet,this._enumAnimations=Gt({}),Object.assign(this._enumAnimations,t),Gt.update(this._enumAnimations),Jet(this,"_animationIndex",this._enumAnimations)}_updateSkinEnum(){let t;t=this.skeletonData?this.skeletonData.getSkinsEnum():qet,this._enumSkins=Gt({}),Object.assign(this._enumSkins,t),Gt.update(this._enumSkins),Jet(this,"_defaultSkinIndex",this._enumSkins)}_ensureListener(){this._listener||(this._listener=new $9,this._state&&this._state.addListener(this._listener))}_updateSkeletonData(){if(!this.skeletonData)return void this.disableRender();const t=this.skeletonData.getRuntimeData();if(t){try{this.setSkeletonData(t),this.isAnimationCached()||this.setAnimationStateData(new ett.AnimationStateData(this._skeleton.data)),this.defaultSkin&&this.setSkin(this.defaultSkin)}catch(t){m(t)}this.attachUtil.init(this),this._preCacheMode=this._cacheMode,this.animation=this.defaultAnimation}else this.disableRender()}_refreshInspector(){this._updateAnimEnum(),this._updateSkinEnum()}_updateDebugDraw(){if(this.debugBones||this.debugSlots||this.debugMesh){if(!this._debugRenderer){const t=new uf("DEBUG_DRAW_NODE");t.hideFlags|=Gi.Flags.DontSave|Gi.Flags.HideInHierarchy;const e=t.addComponent(RN);e.lineWidth=1,e.strokeColor=new si(255,0,0,255),this._debugRenderer=e,t.parent=this.node}this.isAnimationCached()&&m("Debug bones or slots is invalid in cached mode")}else this._debugRenderer&&(this._debugRenderer.node.destroy(),this._debugRenderer=null)}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),0===this._meshRenderDataArray.length&&this._assembler&&this._assembler.createData&&(this._assembler.createData(this),this.markForUpdateRenderData(),this._updateColor())}_updateColor(){}_updateSocketBindings(){if(this._skeleton){this._socketNodes.clear();for(let t=0,e=this._sockets.length;t<e;t++){const e=this._sockets[t];if(e.path&&e.target){const t=this._cachedSockets.get(e.path);if(!t){console.error(`Skeleton data does not contain path ${e.path}`);continue}this._socketNodes.set(t,e.target)}}}}_verifySockets(t){for(let e=0,i=t.length;e<i;e++){const i=t[e].target;!i||i.parent&&i.parent==this.node||console.error(`Target node ${i.name} is expected to be a direct child of ${this.node.name}`)}const e=new Map;t.forEach((t=>{t.target&&(e.get(t.target)?console.error(`Target node ${t.target.name} has existed.`):e.set(t.target,!0))}))}_cleanMaterialCache(){for(const t in this._materialCache)this._materialCache[t].destroy();this._materialCache={}}},jet.SpineSocket=$et,jet.AnimationCacheMode=Yet,n_((Pet=Wet).prototype,"customMaterial",[k_,tet,eet,iet],Object.getOwnPropertyDescriptor(Pet.prototype,"customMaterial"),Pet.prototype),Iet=n_(Pet.prototype,"paused",[net],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),n_(Pet.prototype,"skeletonData",[w_,set],Object.getOwnPropertyDescriptor(Pet.prototype,"skeletonData"),Pet.prototype),n_(Pet.prototype,"_defaultSkinIndex",[ret,oet,aet],Object.getOwnPropertyDescriptor(Pet.prototype,"_defaultSkinIndex"),Pet.prototype),n_(Pet.prototype,"_animationIndex",[cet,het,_et],Object.getOwnPropertyDescriptor(Pet.prototype,"_animationIndex"),Pet.prototype),n_(Pet.prototype,"defaultCacheMode",[uet,met,w_,det],Object.getOwnPropertyDescriptor(Pet.prototype,"defaultCacheMode"),Pet.prototype),Det=n_(Pet.prototype,"loop",[g_,pet],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ret=n_(Pet.prototype,"_premultipliedAlpha",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),n_(Pet.prototype,"premultipliedAlpha",[w_,fet],Object.getOwnPropertyDescriptor(Pet.prototype,"premultipliedAlpha"),Pet.prototype),Met=n_(Pet.prototype,"_timeScale",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),n_(Pet.prototype,"timeScale",[get,w_],Object.getOwnPropertyDescriptor(Pet.prototype,"timeScale"),Pet.prototype),n_(Pet.prototype,"debugSlots",[w_,yet],Object.getOwnPropertyDescriptor(Pet.prototype,"debugSlots"),Pet.prototype),n_(Pet.prototype,"debugBones",[w_,vet],Object.getOwnPropertyDescriptor(Pet.prototype,"debugBones"),Pet.prototype),n_(Pet.prototype,"debugMesh",[w_,xet],Object.getOwnPropertyDescriptor(Pet.prototype,"debugMesh"),Pet.prototype),n_(Pet.prototype,"useTint",[w_,Aet],Object.getOwnPropertyDescriptor(Pet.prototype,"useTint"),Pet.prototype),n_(Pet.prototype,"sockets",[Cet,bet],Object.getOwnPropertyDescriptor(Pet.prototype,"sockets"),Pet.prototype),Bet=n_(Pet.prototype,"_useTint",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oet=n_(Pet.prototype,"_preCacheMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Net=n_(Pet.prototype,"_cacheMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yet.REALTIME}}),Let=n_(Pet.prototype,"_defaultCacheMode",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yet.REALTIME}}),Fet=n_(Pet.prototype,"_debugBones",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zet=n_(Pet.prototype,"_debugSlots",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Vet=n_(Pet.prototype,"_skeletonData",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uet=n_(Pet.prototype,"defaultSkin",[g_,Tet],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Get=n_(Pet.prototype,"defaultAnimation",[wet,g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Het=n_(Pet.prototype,"_sockets",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ket=n_(Pet.prototype,"_debugMesh",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Eet=Pet))||Eet)||Eet)||Eet)||Eet);n.internal.SpineSkeleton=Zet;let Qet=0;const tit=[0,1,2,2,3,0],eit=new si(0,0,255,255),iit=new si(255,0,0,255),nit=new si(0,255,0,255),sit=new si(255,255,0,255),rit=new ett.Color(1,1,1,1),oit=new ett.Color(1,1,1,1),ait=new ett.Vector2,lit=new ett.Vector2;let cit,hit,_it,uit,mit,dit,pit,fit,git,yit,vit,xit;const Sit=new Float32Array(4),Ait=new Float32Array(4),Cit=new oi;let bit,Tit,wit,Eit,Pit,Iit,Dit,Rit,Mit,Bit,Oit,Nit,Lit,Fit,zit,Vit,Uit,Git,Hit,kit,jit,Wit,qit,Xit,Yit,Kit,Jit,$it,Zit,Qit,tnt=0,ent=0,int=0,nnt=0,snt=0,rnt=0,ont=0,ant=null,lnt=null,cnt=null;function hnt(t){let e,i;switch(t){case ett.BlendMode.Additive:e=cit?ro.ONE:ro.SRC_ALPHA,i=ro.ONE;break;case ett.BlendMode.Multiply:e=ro.DST_COLOR,i=ro.ONE_MINUS_SRC_ALPHA;break;case ett.BlendMode.Screen:e=ro.ONE,i=ro.ONE_MINUS_SRC_COLOR;break;case ett.BlendMode.Normal:default:e=cit?ro.ONE:ro.SRC_ALPHA,i=ro.ONE_MINUS_SRC_ALPHA}return Jit.getMaterialForBlendAndTint(e,i,mit?Ket.TWO_COLORED:Ket.COLORED_TEXTURED)}function _nt(t){Wit=t.fa*xit,hit=cit?Wit/255:1,Vit=git*hit,Uit=yit*hit,Git=vit*hit,Hit=t.fr*Vit,kit=t.fg*Uit,jit=t.fb*Git,Sit[0]=Hit/255,Sit[1]=kit/255,Sit[2]=jit/255,Sit[3]=Wit/255,qit=t.dr*Vit,Xit=t.dg*Uit,Yit=t.db*Git,Kit=cit?255:0,Ait[0]=qit/255,Ait[1]=Xit/255,Ait[2]=Yit/255,Ait[3]=Kit/255}const unt=new Float32Array(4);function mnt(t){return unt[0]=t.r/255,unt[1]=t.g/255,unt[2]=t.b/255,unt[3]=t.a/255,unt}function dnt(t){return t?13:9}const pnt={createData(){},updateRenderData(t,e){Jit=t;const i=t._skeleton;!t.isAnimationCached()&&i&&i.updateWorldTransform(),i&&function(t){if(!t._skeleton)return;const e=t.color;let i;git=e.r/255,yit=e.g/255,vit=e.b/255,xit=e.a/255,mit=t.useTint||t.isAnimationCached(),bit=dnt(mit),Zit=t.node,t.destroyRenderData(),$it=t.requestMeshRenderData(bit),Jit=t,lnt=null,Dit=!0,cit=t.premultipliedAlpha,hit=1,Qet=0,Qit=!1,ant=t._effectDelegate&&t._effectDelegate._vertexEffect,(4294967295!==e._val||cit)&&(Qit=!0),mit&&(Qet|=1),Jit.enableBatch&&(i=Zit.worldMatrix,Dit=!1,Qet|=16),t.isAnimationCached()?function(t){const e=Jit._curFrame;if(!e)return;const i=e.segments;if(0===i.length)return;let n,s;Tit=12;let r=null;const o=e.vertices,a=e.indices;let l=0,c=0,h=0;t&&(Bit=t.m00,Lit=t.m01,Oit=t.m04,Fit=t.m05,Nit=t.m12,zit=t.m13);const _=16&Qet,u=_&&(1===Bit&&0===Lit&&0===Oit&&1===Fit);let m=0;const d=e.colors;let p=d[m++],f=p.vfOffset;_nt(p);for(let t=0,e=i.length;t<e;t++){const e=i[t];if(r=hnt(e.blendMode),!r)continue;lnt||(lnt=r),cnt||(cnt=e.tex),$it.renderData.material&&($it.renderData.material=lnt),(Dit||r.hash!==lnt.hash||e.tex&&e.tex!==cnt)&&(Dit=!1,$it.texture||($it.texture=e.tex),$it=Jit.requestMeshRenderData(dnt(mit)),lnt=r,cnt=e.tex,$it.texture=e.tex,$it.renderData.material=lnt),ent=e.vertexCount,snt=e.indexCount,$it.renderData.reserve(ent,snt),rnt=$it.renderData.indicesCount,int=$it.renderData.vertexCount,ont=$it.renderData.vDataOffset,n=$it.renderData.vData,s=$it.renderData.iData;for(let t=rnt,e=rnt+snt;t<e;t++)s[t]=int+a[c++];h=e.vfCount;const g=o.subarray(l,l+h);l+=h;let y=ont;bit=dnt(mit);for(let t=0;t<g.length;)n[y+0]=g[t+0],n[y+1]=g[t+1],n[y+3]=g[t+3],n[y+4]=g[t+4],n[y+5]=g[t+5],n[y+6]=g[t+6],n[y+7]=g[t+7],n[y+8]=g[t+8],mit&&(n[y+9]=g[t+9],n[y+10]=g[t+10],n[y+11]=g[t+11],n[y+12]=g[t+12]),y+=bit,t+=13;if(u)for(let t=ont,e=ont+h;t<e;t+=bit)n[t]+=Nit,n[t+1]+=zit;else if(_)for(let t=ont,e=ont+h;t<e;t+=bit)Rit=n[t],Mit=n[t+1],n[t]=Rit*Bit+Mit*Oit+Nit,n[t+1]=Rit*Lit+Mit*Fit+zit;if($it.renderData.advance(ent,snt),!Qit)continue;let v=l-h;for(let t=ont,e=ont+h;t<e;t+=bit,v+=6)v>=f&&(p=d[m++],_nt(p),f=p.vfOffset),n.set(Sit,t+5),n.set(Ait,t+9)}}(i):(ant&&ant.begin(t._skeleton),function(t){let e,i;const n=Jit._skeleton,s=n.color,r=Jit._debugRenderer,o=Jit._clipper;let a,l,c,h,_,u,m,d=null;_it=Jit._startSlotIndex,uit=Jit._endSlotIndex,Iit=!1,-1===_it&&(Iit=!0),dit=Jit.debugSlots,pit=Jit.debugBones,fit=Jit.debugMesh,r&&(pit||dit||fit)&&(r.clear(),r.lineWidth=5),Tit=12,tnt=0,int=0,nnt=0,snt=0,rnt=0;for(let f=0,g=n.drawOrder.length;f<g;f++){var p;if(m=n.drawOrder[f],void 0===m)continue;if(_it>=0&&_it===m.data.index&&(Iit=!0),!Iit){o.clipEndWithSlot(m);continue}if(uit>=0&&uit===m.data.index&&(Iit=!1),tnt=0,snt=0,a=m.getAttachment(),!a){o.clipEndWithSlot(m);continue}if(h=a instanceof ett.RegionAttachment,_=a instanceof ett.MeshAttachment,u=a instanceof ett.ClippingAttachment,u){o.clipStart(m,a);continue}if(!h&&!_){o.clipEndWithSlot(m);continue}const g=a.region.texture.getRealTexture();if(d=hnt(m.data.blendMode),!d){o.clipEndWithSlot(m);continue}if(lnt||(lnt=d),(null===(p=$it)||void 0===p?void 0:p.renderData.material)||($it.renderData.material=lnt),(Dit||d.hash!==lnt.hash||g&&cnt!==g)&&(Dit=!1,$it=Jit.requestMeshRenderData(bit),lnt=d,cnt=g,$it.texture=g,$it.renderData.material=lnt),h){if(c=tit,tnt=4*bit,snt=6,$it.renderData.reserve(4,6),rnt=$it.renderData.indicesCount,int=$it.renderData.vertexCount,nnt=$it.renderData.vDataOffset,e=$it.renderData.vData,i=$it.renderData.iData,a.computeWorldVertices(m.bone,e,nnt,bit),r&&dit){r.strokeColor=eit,r.moveTo(e[nnt],e[nnt+1]);for(let t=nnt+bit,i=nnt+tnt;t<i;t+=bit)r.lineTo(e[t],e[t+1]);r.close(),r.stroke()}}else if(_){const t=a;if(c=t.triangles,tnt=(t.worldVerticesLength>>1)*bit,snt=c.length,$it.renderData.reserve(t.worldVerticesLength>>1,snt),rnt=$it.renderData.indicesCount,int=$it.renderData.vertexCount,nnt=$it.renderData.vDataOffset,e=$it.renderData.vData,i=$it.renderData.iData,t.computeWorldVertices(m,0,t.worldVerticesLength,e,nnt,bit),r&&fit){r.strokeColor=sit;for(let t=0,i=c.length;t<i;t+=3){const i=c[t]*bit+nnt,n=c[t+1]*bit+nnt,s=c[t+2]*bit+nnt;r.moveTo(e[i],e[i+1]),r.lineTo(e[n],e[n+1]),r.lineTo(e[s],e[s+1]),r.close(),r.stroke()}}}if(0===tnt||0===snt){o.clipEndWithSlot(m);continue}const y=a;i.set(c,rnt),l=y.uvs;for(let t=nnt,i=nnt+tnt,n=0;t<i;t+=bit,n+=2)e[t+3]=l[n],e[t+4]=l[n+1];if(fnt(s,y.color,m.color,o,m),e=$it.renderData.vData,i=$it.renderData.iData,snt>0){for(let t=rnt,e=rnt+snt;t<e;t++)i[t]+=int;if(t){Bit=t.m00,Oit=t.m04,Nit=t.m12,Lit=t.m01,Fit=t.m05,zit=t.m13;for(let t=nnt,i=nnt+tnt;t<i;t+=bit)Rit=e[t],Mit=e[t+1],e[t]=Rit*Bit+Mit*Oit+Nit,e[t+1]=Rit*Lit+Mit*Fit+zit}$it.renderData.advance(tnt/bit,snt)}o.clipEndWithSlot(m)}if(o.clipEnd(),r&&pit){let t;r.strokeColor=iit,r.fillColor=eit;for(let e=0,i=n.bones.length;e<i;e++){t=n.bones[e];const i=t.data.length*t.a+t.worldX,s=t.data.length*t.c+t.worldY;r.moveTo(t.worldX,t.worldY),r.lineTo(i,s),r.stroke(),r.circle(t.worldX,t.worldY,1.5*Math.PI),r.fill(),0===e&&(r.fillColor=nit)}}}(i),ant&&ant.end()),t.attachUtil._syncAttachedNode(),Zit=void 0,$it=void 0,Jit=void 0,ant=null}(t)},updateColor(t){Jit=t},fillBuffers(t,e){if(!t||!t.meshRenderDataArray)return;Jit=t;const i=t.meshRenderDataArray,n=t.node,s=i[t._meshRenderDataArrayIdx].renderData;let r=e.acquireBufferBatch(9===s.floatStride?iN:nN),o=r.byteOffset>>2,a=r.indicesOffset,l=r.vertexOffset;r.request(s.vertexCount,s.indicesCount)||(r=e.currBufferBatch,o=0,a=0,l=0);const c=r.vData,h=r.iData,_=n.worldMatrix,u=s.vData,m=s.vertexStart,d=s.iData,p=s.floatStride;c.set(u.subarray(m,m+s.vertexCount*p),o);for(let t=0;t<s.vertexCount;t++){const e=o+t*p;Cit.set(c[e],c[e+1],c[e+2]),Cit.transformMat4(_),c[e]=Cit.x,c[e+1]=Cit.y,c[e+2]=Cit.z}const f=s.indicesStart;for(let t=0;t<s.indicesCount;t+=1)h[t+a]=d[t+f]+l}};function fnt(t,e,i,n,s){let r=$it.renderData.vData,o=$it.renderData.iData;if(rit.a=i.a*e.a*t.a*xit*255,hit=cit?rit.a:255,wit=git*e.r*t.r*hit,Eit=yit*e.g*t.g*hit,Pit=vit*e.b*t.b*hit,rit.r=wit*i.r,rit.g=Eit*i.g,rit.b=Pit*i.b,null==s.darkColor?oit.set(0,0,0,1):(oit.r=s.darkColor.r*wit,oit.g=s.darkColor.g*Eit,oit.b=s.darkColor.b*Pit),oit.a=cit?255:0,n.isClipping()){Tit=mit?12:8;const t=r.subarray(nnt),e=r.subarray(nnt+3);n.clipTriangles(t,tnt,o.subarray(rnt),snt,e,rit,oit,mit,bit);const i=new Float32Array(n.clippedVertices),s=n.clippedTriangles;if(snt=s.length,tnt=i.length/Tit*bit,$it.renderData.reserve(tnt/bit,snt),rnt=$it.renderData.indicesCount,int=$it.renderData.vertexCount,nnt=$it.renderData.vDataOffset,r=$it.renderData.vData,o=$it.renderData.iData,s.length>0&&o.set(s,rnt),ant)for(let t=0,e=i.length,n=nnt;t<e;t+=Tit,n+=bit)ait.x=i[t],ait.y=i[t+1],rit.set(i[t+2],i[t+3],i[t+4],i[t+5]),lit.x=i[t+6],lit.y=i[t+7],mit?oit.set(i[t+8],i[t+9],i[t+10],i[t+11]):oit.set(0,0,0,0),ant.transform(ait,lit,rit,oit),r[n]=ait.x,r[n+1]=ait.y,r[n+3]=lit.x,r[n+4]=lit.y,r.set(mnt(rit),n+5),mit&&r.set(mnt(oit),n+9);else for(let t=0,e=i.length,n=nnt;t<e;t+=Tit,n+=bit)r[n]=i[t],r[n+1]=i[t+1],r[n+3]=i[t+6],r[n+4]=i[t+7],r[n+5]=i[t+2]/255,r[n+6]=i[t+3]/255,r[n+7]=i[t+4]/255,r[n+8]=i[t+5]/255,mit&&(r[n+9]=i[t+8]/255,r[n+10]=i[t+9]/255,r[n+11]=i[t+10]/255,r[n+12]=i[t+11]/255)}else if(ant)for(let t=nnt,e=nnt+tnt;t<e;t+=bit)ait.x=r[t],ait.y=r[t+1],lit.x=r[t+3],lit.y=r[t+4],ant.transform(ait,lit,rit,oit),r[t]=ait.x,r[t+1]=ait.y,r[t+3]=lit.x,r[t+4]=lit.y,r.set(mnt(rit),t+5),mit&&r.set(mnt(oit),t+9);else{Sit.set(mnt(rit)),Ait.set(mnt(oit));for(let t=nnt,e=nnt+tnt;t<e;t+=bit)r.set(Sit,t+5),mit&&r.set(Ait,t+9)}}n.internal.SpineAssembler=pnt;const gnt={getAssembler:()=>pnt};Zet.Assembler=gnt;const ynt=window.spine,vnt=ynt.VertexEffectDelegate;let xnt,Snt;!function(t){t[t.REGION=0]="REGION",t[t.BOUNDING_BOX=1]="BOUNDING_BOX",t[t.MESH=2]="MESH",t[t.SKINNED_MESH=3]="SKINNED_MESH"}(xnt||(xnt={})),jt(xnt),function(t){t[t.START=0]="START",t[t.INTERRUPT=1]="INTERRUPT",t[t.END=2]="END",t[t.DISPOSE=3]="DISPOSE",t[t.COMPLETE=4]="COMPLETE",t[t.EVENT=5]="EVENT"}(Snt||(Snt={})),jt(Snt),n.internal.SpineAnimationEventType=Snt,t("sp",Object.freeze({__proto__:null,timeScale:1,get DefaultSkinsEnum(){return qet},get DefaultAnimsEnum(){return Xet},get AnimationCacheMode(){return Yet},get SpineMaterialType(){return Ket},SpineSocket:$et,Skeleton:Zet,SkeletonData:jtt,simpleSpineAssembler:gnt,spine:ynt,VertexEffectDelegate:vnt,get ATTACHMENT_TYPE(){return xnt},get AnimationEventType(){return Snt}}));var Ant=Object.setPrototypeOf;let Cnt={};Cnt||(Cnt={}),function(t){var e=function(){function e(i){this._clock=new t.WorldClock,this._events=[],this._objects=[],this._eventManager=null,this._eventManager=i,console.info("DragonBones: "+e.VERSION+"\nWebsite: http://dragonbones.com/\nSource and Demo: https://github.com/DragonBones/")}return e.prototype.advanceTime=function(e){if(this._objects.length>0){for(var i=0,n=this._objects;i<n.length;i++)n[i].returnToPool();this._objects.length=0}if(this._clock.advanceTime(e),this._events.length>0){for(var s=0;s<this._events.length;++s){var r=this._events[s],o=r.armature;null!==o._armatureData&&(o.eventDispatcher.dispatchDBEvent(r.type,r),r.type===t.EventObject.SOUND_EVENT&&this._eventManager.dispatchDBEvent(r.type,r)),this.bufferObject(r)}this._events.length=0}},e.prototype.bufferEvent=function(t){this._events.indexOf(t)<0&&this._events.push(t)},e.prototype.bufferObject=function(t){this._objects.indexOf(t)<0&&this._objects.push(t)},Object.defineProperty(e.prototype,"clock",{get:function(){return this._clock},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"eventManager",{get:function(){return this._eventManager},enumerable:!0,configurable:!0}),e.VERSION="5.6.300",e.yDown=!1,e.debug=!1,e.debugDraw=!1,e.webAssembly=!1,e}();t.DragonBones=e}(Cnt||(Cnt={})),console.warn||(console.warn=function(){}),console.assert||(console.assert=function(){}),Date.now||(Date.now=function(){return(new Date).getTime()}),Ant=function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},function(t){var e=function(){function t(){this.hashCode=t._hashCode++,this._isInPool=!1}return t._returnObject=function(e){var i=String(e.constructor),n=i in t._maxCountMap?t._maxCountMap[i]:t._defaultMaxCount,s=t._poolsMap[i]=t._poolsMap[i]||[];s.length<n&&(e._isInPool?console.warn("The object is already in the pool."):(e._isInPool=!0,s.push(e)))},t.toString=function(){throw new Error},t.setMaxCount=function(e,i){if((i<0||i!=i)&&(i=0),null!==e)null!==(s=(n=String(e))in t._poolsMap?t._poolsMap[n]:null)&&s.length>i&&(s.length=i),t._maxCountMap[n]=i;else for(var n in t._defaultMaxCount=i,t._poolsMap){var s;(s=t._poolsMap[n]).length>i&&(s.length=i),n in t._maxCountMap&&(t._maxCountMap[n]=i)}},t.clearPool=function(e){if(void 0===e&&(e=null),null!==e){var i=String(e);null!==(s=i in t._poolsMap?t._poolsMap[i]:null)&&s.length>0&&(s.length=0)}else for(var n in t._poolsMap){var s;(s=t._poolsMap[n]).length=0}},t.borrowObject=function(e){var i=String(e),n=i in t._poolsMap?t._poolsMap[i]:null;if(null!==n&&n.length>0){var s=n.pop();return s._isInPool=!1,s}var r=new e;return r._onClear(),r},t.prototype.returnToPool=function(){this._onClear(),t._returnObject(this)},t._hashCode=0,t._defaultMaxCount=3e3,t._maxCountMap={},t._poolsMap={},t}();t.BaseObject=e}(Cnt||(Cnt={})),function(t){var e=function(){function t(t,e,i,n,s,r){void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===s&&(s=0),void 0===r&&(r=0),this.a=t,this.b=e,this.c=i,this.d=n,this.tx=s,this.ty=r}return t.prototype.toString=function(){return"[object dragonBones.Matrix] a:"+this.a+" b:"+this.b+" c:"+this.c+" d:"+this.d+" tx:"+this.tx+" ty:"+this.ty},t.prototype.copyFrom=function(t){return this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.tx=t.tx,this.ty=t.ty,this},t.prototype.copyFromArray=function(t,e){return void 0===e&&(e=0),this.a=t[e],this.b=t[e+1],this.c=t[e+2],this.d=t[e+3],this.tx=t[e+4],this.ty=t[e+5],this},t.prototype.identity=function(){return this.a=this.d=1,this.b=this.c=0,this.tx=this.ty=0,this},t.prototype.concat=function(t){var e=this.a*t.a,i=0,n=0,s=this.d*t.d,r=this.tx*t.a+t.tx,o=this.ty*t.d+t.ty;return 0===this.b&&0===this.c||(e+=this.b*t.c,i+=this.b*t.d,n+=this.c*t.a,s+=this.c*t.b),0===t.b&&0===t.c||(i+=this.a*t.b,n+=this.d*t.c,r+=this.ty*t.c,o+=this.tx*t.b),this.a=e,this.b=i,this.c=n,this.d=s,this.tx=r,this.ty=o,this},t.prototype.invert=function(){var t=this.a,e=this.b,i=this.c,n=this.d,s=this.tx,r=this.ty;if(0===e&&0===i)return this.b=this.c=0,0===t||0===n?this.a=this.b=this.tx=this.ty=0:(t=this.a=1/t,n=this.d=1/n,this.tx=-t*s,this.ty=-n*r),this;var o=t*n-e*i;if(0===o)return this.a=this.d=1,this.b=this.c=0,this.tx=this.ty=0,this;o=1/o;var a=this.a=n*o;return e=this.b=-e*o,i=this.c=-i*o,n=this.d=t*o,this.tx=-(a*s+i*r),this.ty=-(e*s+n*r),this},t.prototype.transformPoint=function(t,e,i,n){void 0===n&&(n=!1),i.x=this.a*t+this.c*e,i.y=this.b*t+this.d*e,n||(i.x+=this.tx,i.y+=this.ty)},t.prototype.transformRectangle=function(t,e){void 0===e&&(e=!1);var i=this.a,n=this.b,s=this.c,r=this.d,o=e?0:this.tx,a=e?0:this.ty,l=t.x,c=t.y,h=l+t.width,_=c+t.height,u=i*l+s*c+o,m=n*l+r*c+a,d=i*h+s*c+o,p=n*h+r*c+a,f=i*h+s*_+o,g=n*h+r*_+a,y=i*l+s*_+o,v=n*l+r*_+a,x=0;u>d&&(x=u,u=d,d=x),f>y&&(x=f,f=y,y=x),t.x=Math.floor(u<f?u:f),t.width=Math.ceil((d>y?d:y)-t.x),m>p&&(x=m,m=p,p=x),g>v&&(x=g,g=v,v=x),t.y=Math.floor(m<g?m:g),t.height=Math.ceil((p>v?p:v)-t.y)},t}();t.Matrix=e}(Cnt||(Cnt={})),function(t){var e=function(){function t(t,e,i,n,s,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===s&&(s=1),void 0===r&&(r=1),this.x=t,this.y=e,this.skew=i,this.rotation=n,this.scaleX=s,this.scaleY=r}return t.normalizeRadian=function(t){return(t=(t+Math.PI)%(2*Math.PI))+(t>0?-Math.PI:Math.PI)},t.prototype.toString=function(){return"[object dragonBones.Transform] x:"+this.x+" y:"+this.y+" skewX:"+180*this.skew/Math.PI+" skewY:"+180*this.rotation/Math.PI+" scaleX:"+this.scaleX+" scaleY:"+this.scaleY},t.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.skew=t.skew,this.rotation=t.rotation,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this},t.prototype.identity=function(){return this.x=this.y=0,this.skew=this.rotation=0,this.scaleX=this.scaleY=1,this},t.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this.skew+=t.skew,this.rotation+=t.rotation,this.scaleX*=t.scaleX,this.scaleY*=t.scaleY,this},t.prototype.minus=function(t){return this.x-=t.x,this.y-=t.y,this.skew-=t.skew,this.rotation-=t.rotation,this.scaleX/=t.scaleX,this.scaleY/=t.scaleY,this},t.prototype.fromMatrix=function(e){var i=this.scaleX,n=this.scaleY,s=t.PI_Q;this.x=e.tx,this.y=e.ty,this.rotation=Math.atan(e.b/e.a);var r=Math.atan(-e.c/e.d);return this.scaleX=this.rotation>-s&&this.rotation<s?e.a/Math.cos(this.rotation):e.b/Math.sin(this.rotation),this.scaleY=r>-s&&r<s?e.d/Math.cos(r):-e.c/Math.sin(r),i>=0&&this.scaleX<0&&(this.scaleX=-this.scaleX,this.rotation=this.rotation-Math.PI),n>=0&&this.scaleY<0&&(this.scaleY=-this.scaleY,r-=Math.PI),this.skew=r-this.rotation,this},t.prototype.toMatrix=function(t){return 0===this.rotation?(t.a=1,t.b=0):(t.a=Math.cos(this.rotation),t.b=Math.sin(this.rotation)),0===this.skew?(t.c=-t.b,t.d=t.a):(t.c=-Math.sin(this.skew+this.rotation),t.d=Math.cos(this.skew+this.rotation)),1!==this.scaleX&&(t.a*=this.scaleX,t.b*=this.scaleX),1!==this.scaleY&&(t.c*=this.scaleY,t.d*=this.scaleY),t.tx=this.x,t.ty=this.y,this},t.PI=Math.PI,t.PI_D=2*Math.PI,t.PI_H=Math.PI/2,t.PI_Q=Math.PI/4,t.RAD_DEG=180/Math.PI,t.DEG_RAD=Math.PI/180,t}();t.Transform=e}(Cnt||(Cnt={})),function(t){var e=function(){function t(t,e,i,n,s,r,o,a){void 0===t&&(t=1),void 0===e&&(e=1),void 0===i&&(i=1),void 0===n&&(n=1),void 0===s&&(s=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.alphaMultiplier=t,this.redMultiplier=e,this.greenMultiplier=i,this.blueMultiplier=n,this.alphaOffset=s,this.redOffset=r,this.greenOffset=o,this.blueOffset=a}return t.prototype.copyFrom=function(t){this.alphaMultiplier=t.alphaMultiplier,this.redMultiplier=t.redMultiplier,this.greenMultiplier=t.greenMultiplier,this.blueMultiplier=t.blueMultiplier,this.alphaOffset=t.alphaOffset,this.redOffset=t.redOffset,this.greenOffset=t.greenOffset,this.blueOffset=t.blueOffset},t.prototype.identity=function(){this.alphaMultiplier=this.redMultiplier=this.greenMultiplier=this.blueMultiplier=1,this.alphaOffset=this.redOffset=this.greenOffset=this.blueOffset=0},t}();t.ColorTransform=e}(Cnt||(Cnt={})),function(t){var e=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y},t.prototype.clear=function(){this.x=this.y=0},t}();t.Point=e}(Cnt||(Cnt={})),function(t){var e=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=t,this.y=e,this.width=i,this.height=n}return t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},t.prototype.clear=function(){this.x=this.y=0,this.width=this.height=0},t}();t.Rectangle=e}(Cnt||(Cnt={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.ints=[],e.floats=[],e.strings=[],e}return Ant(e,t),e.toString=function(){return"[class dragonBones.UserData]"},e.prototype._onClear=function(){this.ints.length=0,this.floats.length=0,this.strings.length=0},e.prototype.addInt=function(t){this.ints.push(t)},e.prototype.addFloat=function(t){this.floats.push(t)},e.prototype.addString=function(t){this.strings.push(t)},e.prototype.getInt=function(t){return void 0===t&&(t=0),t>=0&&t<this.ints.length?this.ints[t]:0},e.prototype.getFloat=function(t){return void 0===t&&(t=0),t>=0&&t<this.floats.length?this.floats[t]:0},e.prototype.getString=function(t){return void 0===t&&(t=0),t>=0&&t<this.strings.length?this.strings[t]:""},e}(t.BaseObject);t.UserData=e;var i=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.data=null,e}return Ant(e,t),e.toString=function(){return"[class dragonBones.ActionData]"},e.prototype._onClear=function(){null!==this.data&&this.data.returnToPool(),this.type=0,this.name="",this.bone=null,this.slot=null,this.data=null},e}(t.BaseObject);t.ActionData=i}(Cnt||(Cnt={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.frameIndices=[],e.cachedFrames=[],e.armatureNames=[],e.armatures={},e.userData=null,e}return Ant(e,t),e.toString=function(){return"[class dragonBones.DragonBonesData]"},e.prototype._onClear=function(){for(var t in this.armatures)this.armatures[t].returnToPool(),delete this.armatures[t];null!==this.userData&&this.userData.returnToPool(),this.autoSearch=!1,this.frameRate=0,this.version="",this.name="",this.stage=null,this.frameIndices.length=0,this.cachedFrames.length=0,this.armatureNames.length=0,this.binary=null,this.intArray=null,this.floatArray=null,this.frameIntArray=null,this.frameFloatArray=null,this.frameArray=null,this.timelineArray=null,this.userData=null},e.prototype.addArmature=function(t){t.name in this.armatures?console.warn("Same armature: "+t.name):(t.parent=this,this.armatures[t.name]=t,this.armatureNames.push(t.name))},e.prototype.getArmature=function(t){return t in this.armatures?this.armatures[t]:null},e.prototype.dispose=function(){console.warn("已废弃"),this.returnToPool()},e}(t.BaseObject);t.DragonBonesData=e}(Cnt||(Cnt={})),function(t){var e=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.aabb=new t.Rectangle,i.animationNames=[],i.sortedBones=[],i.sortedSlots=[],i.defaultActions=[],i.actions=[],i.bones={},i.slots={},i.constraints={},i.skins={},i.animations={},i.canvas=null,i.userData=null,i}return Ant(i,e),i.toString=function(){return"[class dragonBones.ArmatureData]"},i.prototype._onClear=function(){for(var t=0,e=this.defaultActions;t<e.length;t++)e[t].returnToPool();for(var i=0,n=this.actions;i<n.length;i++)n[i].returnToPool();for(var s in this.bones)this.bones[s].returnToPool(),delete this.bones[s];for(var s in this.slots)this.slots[s].returnToPool(),delete this.slots[s];for(var s in this.constraints)this.constraints[s].returnToPool(),delete this.constraints[s];for(var s in this.skins)this.skins[s].returnToPool(),delete this.skins[s];for(var s in this.animations)this.animations[s].returnToPool(),delete this.animations[s];null!==this.canvas&&this.canvas.returnToPool(),null!==this.userData&&this.userData.returnToPool(),this.type=0,this.frameRate=0,this.cacheFrameRate=0,this.scale=1,this.name="",this.aabb.clear(),this.animationNames.length=0,this.sortedBones.length=0,this.sortedSlots.length=0,this.defaultActions.length=0,this.actions.length=0,this.defaultSkin=null,this.defaultAnimation=null,this.canvas=null,this.userData=null,this.parent=null},i.prototype.sortBones=function(){var t=this.sortedBones.length;if(!(t<=0)){var e=this.sortedBones.concat(),i=0,n=0;for(this.sortedBones.length=0;n<t;){var s=e[i++];if(i>=t&&(i=0),!(this.sortedBones.indexOf(s)>=0)){var r=!1;for(var o in this.constraints){var a=this.constraints[o];if(a.root===s&&this.sortedBones.indexOf(a.target)<0){r=!0;break}}r||null!==s.parent&&this.sortedBones.indexOf(s.parent)<0||(this.sortedBones.push(s),n++)}}}},i.prototype.cacheFrames=function(t){if(!(this.cacheFrameRate>0))for(var e in this.cacheFrameRate=t,this.animations)this.animations[e].cacheFrames(this.cacheFrameRate)},i.prototype.setCacheFrame=function(t,e){var i=this.parent.cachedFrames,n=i.length;return i.length+=10,i[n]=t.a,i[n+1]=t.b,i[n+2]=t.c,i[n+3]=t.d,i[n+4]=t.tx,i[n+5]=t.ty,i[n+6]=e.rotation,i[n+7]=e.skew,i[n+8]=e.scaleX,i[n+9]=e.scaleY,n},i.prototype.getCacheFrame=function(t,e,i){var n=this.parent.cachedFrames;t.a=n[i],t.b=n[i+1],t.c=n[i+2],t.d=n[i+3],t.tx=n[i+4],t.ty=n[i+5],e.rotation=n[i+6],e.skew=n[i+7],e.scaleX=n[i+8],e.scaleY=n[i+9],e.x=t.tx,e.y=t.ty},i.prototype.addBone=function(t){t.name in this.bones?console.warn("Same bone: "+t.name):(this.bones[t.name]=t,this.sortedBones.push(t))},i.prototype.addSlot=function(t){t.name in this.slots?console.warn("Same slot: "+t.name):(this.slots[t.name]=t,this.sortedSlots.push(t))},i.prototype.addConstraint=function(t){t.name in this.constraints?console.warn("Same constraint: "+t.name):this.constraints[t.name]=t},i.prototype.addSkin=function(t){t.name in this.skins?console.warn("Same skin: "+t.name):(t.parent=this,this.skins[t.name]=t,null===this.defaultSkin&&(this.defaultSkin=t),"default"===t.name&&(this.defaultSkin=t))},i.prototype.addAnimation=function(t){t.name in this.animations?console.warn("Same animation: "+t.name):(t.parent=this,this.animations[t.name]=t,this.animationNames.push(t.name),null===this.defaultAnimation&&(this.defaultAnimation=t))},i.prototype.addAction=function(t,e){e?this.defaultActions.push(t):this.actions.push(t)},i.prototype.getBone=function(t){return t in this.bones?this.bones[t]:null},i.prototype.getSlot=function(t){return t in this.slots?this.slots[t]:null},i.prototype.getConstraint=function(t){return t in this.constraints?this.constraints[t]:null},i.prototype.getSkin=function(t){return t in this.skins?this.skins[t]:null},i.prototype.getMesh=function(t,e,i){var n=this.getSkin(t);return null===n?null:n.getDisplay(e,i)},i.prototype.getAnimation=function(t){return t in this.animations?this.animations[t]:null},i}(t.BaseObject);t.ArmatureData=e;var i=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.transform=new t.Transform,i.userData=null,i}return Ant(i,e),i.toString=function(){return"[class dragonBones.BoneData]"},i.prototype._onClear=function(){null!==this.userData&&this.userData.returnToPool(),this.inheritTranslation=!1,this.inheritRotation=!1,this.inheritScale=!1,this.inheritReflection=!1,this.type=0,this.length=0,this.name="",this.transform.identity(),this.userData=null,this.parent=null},i}(t.BaseObject);t.BoneData=i;var n=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.vertices=[],e}return Ant(e,t),e.toString=function(){return"[class dragonBones.SurfaceData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=1,this.segmentX=0,this.segmentY=0,this.vertices.length=0},e}(i);t.SurfaceData=n;var s=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t.color=null,t.userData=null,t}return Ant(i,e),i.createColor=function(){return new t.ColorTransform},i.toString=function(){return"[class dragonBones.SlotData]"},i.prototype._onClear=function(){null!==this.userData&&this.userData.returnToPool(),this.blendMode=0,this.displayIndex=0,this.zOrder=0,this.name="",this.color=null,this.userData=null,this.parent=null},i.DEFAULT_COLOR=new t.ColorTransform,i}(t.BaseObject);t.SlotData=s}(Cnt||(Cnt={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.prototype._onClear=function(){this.order=0,this.name="",this.type=0,this.target=null,this.root=null,this.bone=null},e}(t.BaseObject);t.ConstraintData=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.toString=function(){return"[class dragonBones.IKConstraintData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.scaleEnabled=!1,this.bendPositive=!1,this.weight=1},e}(e);t.IKConstraintData=i;var n=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.bones=[],e}return Ant(e,t),e.toString=function(){return"[class dragonBones.PathConstraintData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.pathSlot=null,this.pathDisplayData=null,this.bones.length=0,this.positionMode=0,this.spacingMode=1,this.rotateMode=1,this.position=0,this.spacing=0,this.rotateOffset=0,this.rotateMix=0,this.translateMix=0},e.prototype.AddBone=function(t){this.bones.push(t)},e}(e);t.PathConstraintData=n}(Cnt||(Cnt={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.toString=function(){return"[class dragonBones.CanvasData]"},e.prototype._onClear=function(){this.hasBackground=!1,this.color=0,this.x=0,this.y=0,this.width=0,this.height=0},e}(t.BaseObject);t.CanvasData=e}(Cnt||(Cnt={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.displays={},e}return Ant(e,t),e.toString=function(){return"[class dragonBones.SkinData]"},e.prototype._onClear=function(){for(var t in this.displays){for(var e=0,i=this.displays[t];e<i.length;e++){var n=i[e];null!==n&&n.returnToPool()}delete this.displays[t]}this.name="",this.parent=null},e.prototype.addDisplay=function(t,e){t in this.displays||(this.displays[t]=[]),null!==e&&(e.parent=this),this.displays[t].push(e)},e.prototype.getDisplay=function(t,e){var i=this.getDisplays(t);if(null!==i)for(var n=0,s=i;n<s.length;n++){var r=s[n];if(null!==r&&r.name===e)return r}return null},e.prototype.getDisplays=function(t){return t in this.displays?this.displays[t]:null},e}(t.BaseObject);t.SkinData=e}(Cnt||(Cnt={})),function(t){var e=function(){function t(){this.weight=null}return t.prototype.clear=function(){this.isShared||null===this.weight||this.weight.returnToPool(),this.isShared=!1,this.inheritDeform=!1,this.offset=0,this.data=null,this.weight=null},t.prototype.shareFrom=function(t){this.isShared=!0,this.offset=t.offset,this.weight=t.weight},t}();t.VerticesData=e;var i=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.transform=new t.Transform,i}return Ant(i,e),i.prototype._onClear=function(){this.name="",this.path="",this.transform.identity(),this.parent=null},i}(t.BaseObject);t.DisplayData=i;var n=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.pivot=new t.Point,i}return Ant(i,e),i.toString=function(){return"[class dragonBones.ImageDisplayData]"},i.prototype._onClear=function(){e.prototype._onClear.call(this),this.type=0,this.pivot.clear(),this.texture=null},i}(i);t.ImageDisplayData=n;var s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.actions=[],e}return Ant(e,t),e.toString=function(){return"[class dragonBones.ArmatureDisplayData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this);for(var e=0,i=this.actions;e<i.length;e++)i[e].returnToPool();this.type=1,this.inheritAnimation=!1,this.actions.length=0,this.armature=null},e.prototype.addAction=function(t){this.actions.push(t)},e}(i);t.ArmatureDisplayData=s;var r=function(t){function i(){var i=null!==t&&t.apply(this,arguments)||this;return i.vertices=new e,i}return Ant(i,t),i.toString=function(){return"[class dragonBones.MeshDisplayData]"},i.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=2,this.vertices.clear(),this.texture=null},i}(i);t.MeshDisplayData=r;var o=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.boundingBox=null,e}return Ant(e,t),e.toString=function(){return"[class dragonBones.BoundingBoxDisplayData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),null!==this.boundingBox&&this.boundingBox.returnToPool(),this.type=3,this.boundingBox=null},e}(i);t.BoundingBoxDisplayData=o;var a=function(t){function i(){var i=null!==t&&t.apply(this,arguments)||this;return i.vertices=new e,i.curveLengths=[],i}return Ant(i,t),i.toString=function(){return"[class dragonBones.PathDisplayData]"},i.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=4,this.closed=!1,this.constantSpeed=!1,this.vertices.clear(),this.curveLengths.length=0},i}(i);t.PathDisplayData=a;var l=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.bones=[],e}return Ant(e,t),e.toString=function(){return"[class dragonBones.WeightData]"},e.prototype._onClear=function(){this.count=0,this.offset=0,this.bones.length=0},e.prototype.addBone=function(t){this.bones.push(t)},e}(t.BaseObject);t.WeightData=l}(Cnt||(Cnt={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.prototype._onClear=function(){this.color=0,this.width=0,this.height=0},e}(t.BaseObject);t.BoundingBoxData=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.toString=function(){return"[class dragonBones.RectangleBoundingBoxData]"},e._computeOutCode=function(t,e,i,n,s,r){var o=0;return t<i?o|=1:t>s&&(o|=2),e<n?o|=4:e>r&&(o|=8),o},e.rectangleIntersectsSegment=function(t,i,n,s,r,o,a,l,c,h,_){void 0===c&&(c=null),void 0===h&&(h=null),void 0===_&&(_=null);var u=t>r&&t<a&&i>o&&i<l,m=n>r&&n<a&&s>o&&s<l;if(u&&m)return-1;for(var d=0,p=e._computeOutCode(t,i,r,o,a,l),f=e._computeOutCode(n,s,r,o,a,l);;){if(0==(p|f)){d=2;break}if(0!=(p&f))break;var g=0,y=0,v=0,x=0!==p?p:f;0!=(4&x)?(g=t+(n-t)*(o-i)/(s-i),y=o,null!==_&&(v=.5*-Math.PI)):0!=(8&x)?(g=t+(n-t)*(l-i)/(s-i),y=l,null!==_&&(v=.5*Math.PI)):0!=(2&x)?(y=i+(s-i)*(a-t)/(n-t),g=a,null!==_&&(v=0)):0!=(1&x)&&(y=i+(s-i)*(r-t)/(n-t),g=r,null!==_&&(v=Math.PI)),x===p?(t=g,i=y,p=e._computeOutCode(t,i,r,o,a,l),null!==_&&(_.x=v)):(n=g,s=y,f=e._computeOutCode(n,s,r,o,a,l),null!==_&&(_.y=v))}return d&&(u?(d=2,null!==c&&(c.x=n,c.y=s),null!==h&&(h.x=n,h.y=n),null!==_&&(_.x=_.y+Math.PI)):m?(d=1,null!==c&&(c.x=t,c.y=i),null!==h&&(h.x=t,h.y=i),null!==_&&(_.y=_.x+Math.PI)):(d=3,null!==c&&(c.x=t,c.y=i),null!==h&&(h.x=n,h.y=s))),d},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=0},e.prototype.containsPoint=function(t,e){var i=.5*this.width;if(t>=-i&&t<=i){var n=.5*this.height;if(e>=-n&&e<=n)return!0}return!1},e.prototype.intersectsSegment=function(t,i,n,s,r,o,a){void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null);var l=.5*this.width,c=.5*this.height;return e.rectangleIntersectsSegment(t,i,n,s,-l,-c,l,c,r,o,a)},e}(e);t.RectangleBoundingBoxData=i;var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.toString=function(){return"[class dragonBones.EllipseData]"},e.ellipseIntersectsSegment=function(t,e,i,n,s,r,o,a,l,c,h){void 0===l&&(l=null),void 0===c&&(c=null),void 0===h&&(h=null);var _=o/a,u=_*_,m=i-t,d=(n*=_)-(e*=_),p=Math.sqrt(m*m+d*d),f=m/p,g=d/p,y=(s-t)*f+(r-e)*g,v=o*o,x=v-(t*t+e*e)+y*y,S=0;if(x>=0){var A=Math.sqrt(x),C=y-A,b=y+A,T=C<0?-1:C<=p?0:1,w=b<0?-1:b<=p?0:1,E=T*w;if(E<0)return-1;0===E&&(-1===T?(S=2,i=t+b*f,n=(e+b*g)/_,null!==l&&(l.x=i,l.y=n),null!==c&&(c.x=i,c.y=n),null!==h&&(h.x=Math.atan2(n/v*u,i/v),h.y=h.x+Math.PI)):1===w?(S=1,t+=C*f,e=(e+C*g)/_,null!==l&&(l.x=t,l.y=e),null!==c&&(c.x=t,c.y=e),null!==h&&(h.x=Math.atan2(e/v*u,t/v),h.y=h.x+Math.PI)):(S=3,null!==l&&(l.x=t+C*f,l.y=(e+C*g)/_,null!==h&&(h.x=Math.atan2(l.y/v*u,l.x/v))),null!==c&&(c.x=t+b*f,c.y=(e+b*g)/_,null!==h&&(h.y=Math.atan2(c.y/v*u,c.x/v)))))}return S},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=1},e.prototype.containsPoint=function(t,e){var i=.5*this.width;if(t>=-i&&t<=i){var n=.5*this.height;if(e>=-n&&e<=n)return e*=i/n,Math.sqrt(t*t+e*e)<=i}return!1},e.prototype.intersectsSegment=function(t,i,n,s,r,o,a){return void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null),e.ellipseIntersectsSegment(t,i,n,s,0,0,.5*this.width,.5*this.height,r,o,a)},e}(e);t.EllipseBoundingBoxData=n;var s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.vertices=[],e}return Ant(e,t),e.toString=function(){return"[class dragonBones.PolygonBoundingBoxData]"},e.polygonIntersectsSegment=function(t,e,i,n,s,r,o,a){void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null),t===i&&(t=i+1e-6),e===n&&(e=n+1e-6);for(var l=s.length,c=t-i,h=e-n,_=t*n-e*i,u=0,m=s[l-2],d=s[l-1],p=0,f=0,g=0,y=0,v=0,x=0,S=0;S<l;S+=2){var A=s[S],C=s[S+1];m===A&&(m=A+1e-4),d===C&&(d=C+1e-4);var b=m-A,T=d-C,w=m*C-d*A,E=c*T-h*b,P=(_*b-c*w)/E;if((P>=m&&P<=A||P>=A&&P<=m)&&(0===c||P>=t&&P<=i||P>=i&&P<=t)){var I=(_*T-h*w)/E;if((I>=d&&I<=C||I>=C&&I<=d)&&(0===h||I>=e&&I<=n||I>=n&&I<=e)){if(null===o){g=P,y=I,v=P,x=I,u++,null!==a&&(a.x=Math.atan2(C-d,A-m)-.5*Math.PI,a.y=a.x);break}var D=P-t;D<0&&(D=-D),0===u?(p=D,f=D,g=P,y=I,v=P,x=I,null!==a&&(a.x=Math.atan2(C-d,A-m)-.5*Math.PI,a.y=a.x)):(D<p&&(p=D,g=P,y=I,null!==a&&(a.x=Math.atan2(C-d,A-m)-.5*Math.PI)),D>f&&(f=D,v=P,x=I,null!==a&&(a.y=Math.atan2(C-d,A-m)-.5*Math.PI))),u++}}m=A,d=C}return 1===u?(null!==r&&(r.x=g,r.y=y),null!==o&&(o.x=g,o.y=y),null!==a&&(a.y=a.x+Math.PI)):u>1&&(u++,null!==r&&(r.x=g,r.y=y),null!==o&&(o.x=v,o.y=x)),u},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=2,this.x=0,this.y=0,this.vertices.length=0},e.prototype.containsPoint=function(t,e){var i=!1;if(t>=this.x&&t<=this.width&&e>=this.y&&e<=this.height)for(var n=0,s=this.vertices.length,r=s-2;n<s;n+=2){var o=this.vertices[r+1],a=this.vertices[n+1];if(a<e&&o>=e||o<e&&a>=e){var l=this.vertices[r],c=this.vertices[n];(e-a)*(l-c)/(o-a)+c<t&&(i=!i)}r=n}return i},e.prototype.intersectsSegment=function(t,n,s,r,o,a,l){void 0===o&&(o=null),void 0===a&&(a=null),void 0===l&&(l=null);var c=0;return 0!==i.rectangleIntersectsSegment(t,n,s,r,this.x,this.y,this.x+this.width,this.y+this.height,null,null,null)&&(c=e.polygonIntersectsSegment(t,n,s,r,this.vertices,o,a,l)),c},e}(e);t.PolygonBoundingBoxData=s}(Cnt||(Cnt={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.cachedFrames=[],e.boneTimelines={},e.surfaceTimelines={},e.slotTimelines={},e.constraintTimelines={},e.animationTimelines={},e.boneCachedFrameIndices={},e.slotCachedFrameIndices={},e.actionTimeline=null,e.zOrderTimeline=null,e}return Ant(e,t),e.toString=function(){return"[class dragonBones.AnimationData]"},e.prototype._onClear=function(){for(var t in this.boneTimelines){for(var e=0,i=this.boneTimelines[t];e<i.length;e++)i[e].returnToPool();delete this.boneTimelines[t]}for(var t in this.surfaceTimelines){for(var n=0,s=this.surfaceTimelines[t];n<s.length;n++)s[n].returnToPool();delete this.surfaceTimelines[t]}for(var t in this.slotTimelines){for(var r=0,o=this.slotTimelines[t];r<o.length;r++)o[r].returnToPool();delete this.slotTimelines[t]}for(var t in this.constraintTimelines){for(var a=0,l=this.constraintTimelines[t];a<l.length;a++)l[a].returnToPool();delete this.constraintTimelines[t]}for(var t in this.animationTimelines){for(var c=0,h=this.animationTimelines[t];c<h.length;c++)h[c].returnToPool();delete this.animationTimelines[t]}for(var t in this.boneCachedFrameIndices)delete this.boneCachedFrameIndices[t];for(var t in this.slotCachedFrameIndices)delete this.slotCachedFrameIndices[t];null!==this.actionTimeline&&this.actionTimeline.returnToPool(),null!==this.zOrderTimeline&&this.zOrderTimeline.returnToPool(),this.frameIntOffset=0,this.frameFloatOffset=0,this.frameOffset=0,this.frameCount=0,this.playTimes=0,this.duration=0,this.scale=1,this.fadeInTime=0,this.cacheFrameRate=0,this.name="",this.cachedFrames.length=0,this.actionTimeline=null,this.zOrderTimeline=null,this.parent=null},e.prototype.cacheFrames=function(t){if(!(this.cacheFrameRate>0)){this.cacheFrameRate=Math.max(Math.ceil(t*this.scale),1);var e=Math.ceil(this.cacheFrameRate*this.duration)+1;this.cachedFrames.length=e;for(var i=0,n=this.cacheFrames.length;i<n;++i)this.cachedFrames[i]=!1;for(var s=0,r=this.parent.sortedBones;s<r.length;s++){var o=r[s];for(i=0,n=(c=new Array(e)).length;i<n;++i)c[i]=-1;this.boneCachedFrameIndices[o.name]=c}for(var a=0,l=this.parent.sortedSlots;a<l.length;a++){var c,h=l[a];for(i=0,n=(c=new Array(e)).length;i<n;++i)c[i]=-1;this.slotCachedFrameIndices[h.name]=c}}},e.prototype.addBoneTimeline=function(t,e){var i=t.name in this.boneTimelines?this.boneTimelines[t.name]:this.boneTimelines[t.name]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.addSurfaceTimeline=function(t,e){var i=t.name in this.surfaceTimelines?this.surfaceTimelines[t.name]:this.surfaceTimelines[t.name]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.addSlotTimeline=function(t,e){var i=t.name in this.slotTimelines?this.slotTimelines[t.name]:this.slotTimelines[t.name]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.addConstraintTimeline=function(t,e){var i=t.name in this.constraintTimelines?this.constraintTimelines[t.name]:this.constraintTimelines[t.name]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.addAnimationTimeline=function(t,e){var i=t in this.animationTimelines?this.animationTimelines[t]:this.animationTimelines[t]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.getBoneTimelines=function(t){return t in this.boneTimelines?this.boneTimelines[t]:null},e.prototype.getSurfaceTimelines=function(t){return t in this.surfaceTimelines?this.surfaceTimelines[t]:null},e.prototype.getSlotTimelines=function(t){return t in this.slotTimelines?this.slotTimelines[t]:null},e.prototype.getConstraintTimelines=function(t){return t in this.constraintTimelines?this.constraintTimelines[t]:null},e.prototype.getAnimationTimelines=function(t){return t in this.animationTimelines?this.animationTimelines[t]:null},e.prototype.getBoneCachedFrameIndices=function(t){return t in this.boneCachedFrameIndices?this.boneCachedFrameIndices[t]:null},e.prototype.getSlotCachedFrameIndices=function(t){return t in this.slotCachedFrameIndices?this.slotCachedFrameIndices[t]:null},e}(t.BaseObject);t.AnimationData=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.toString=function(){return"[class dragonBones.TimelineData]"},e.prototype._onClear=function(){this.type=10,this.offset=0,this.frameIndicesOffset=-1},e}(t.BaseObject);t.TimelineData=i}(Cnt||(Cnt={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.boneMask=[],e}return Ant(e,t),e.toString=function(){return"[class dragonBones.AnimationConfig]"},e.prototype._onClear=function(){this.pauseFadeOut=!0,this.fadeOutMode=4,this.fadeOutTweenType=1,this.fadeOutTime=-1,this.actionEnabled=!0,this.additiveBlending=!1,this.displayControl=!0,this.pauseFadeIn=!0,this.resetToPose=!0,this.fadeInTweenType=1,this.playTimes=-1,this.layer=0,this.position=0,this.duration=-1,this.timeScale=-100,this.weight=1,this.fadeInTime=-1,this.autoFadeOutTime=-1,this.name="",this.animation="",this.group="",this.boneMask.length=0},e.prototype.clear=function(){this._onClear()},e.prototype.copyFrom=function(t){this.pauseFadeOut=t.pauseFadeOut,this.fadeOutMode=t.fadeOutMode,this.autoFadeOutTime=t.autoFadeOutTime,this.fadeOutTweenType=t.fadeOutTweenType,this.actionEnabled=t.actionEnabled,this.additiveBlending=t.additiveBlending,this.displayControl=t.displayControl,this.pauseFadeIn=t.pauseFadeIn,this.resetToPose=t.resetToPose,this.playTimes=t.playTimes,this.layer=t.layer,this.position=t.position,this.duration=t.duration,this.timeScale=t.timeScale,this.fadeInTime=t.fadeInTime,this.fadeOutTime=t.fadeOutTime,this.fadeInTweenType=t.fadeInTweenType,this.weight=t.weight,this.name=t.name,this.animation=t.animation,this.group=t.group,this.boneMask.length=t.boneMask.length;for(var e=0,i=this.boneMask.length;e<i;++e)this.boneMask[e]=t.boneMask[e]},e.prototype.containsBoneMask=function(t){return 0===this.boneMask.length||this.boneMask.indexOf(t)>=0},e.prototype.addBoneMask=function(t,e,i){void 0===i&&(i=!0);var n=t.getBone(e);if(null!==n&&(this.boneMask.indexOf(e)<0&&this.boneMask.push(e),i))for(var s=0,r=t.getBones();s<r.length;s++){var o=r[s];this.boneMask.indexOf(o.name)<0&&n.contains(o)&&this.boneMask.push(o.name)}},e.prototype.removeBoneMask=function(t,e,i){void 0===i&&(i=!0);var n=this.boneMask.indexOf(e);if(n>=0&&this.boneMask.splice(n,1),i){var s=t.getBone(e);if(null!==s)if(this.boneMask.length>0)for(var r=0,o=t.getBones();r<o.length;r++){var a=o[r],l=this.boneMask.indexOf(a.name);l>=0&&s.contains(a)&&this.boneMask.splice(l,1)}else for(var c=0,h=t.getBones();c<h.length;c++)(a=h[c])!==s&&(s.contains(a)||this.boneMask.push(a.name))}},e}(t.BaseObject);t.AnimationConfig=e}(Cnt||(Cnt={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.textures={},e}return Ant(e,t),e.prototype._onClear=function(){for(var t in this.textures)this.textures[t].returnToPool(),delete this.textures[t];this.autoSearch=!1,this.width=0,this.height=0,this.scale=1,this.name="",this.imagePath=""},e.prototype.copyFrom=function(t){for(var e in this.autoSearch=t.autoSearch,this.scale=t.scale,this.width=t.width,this.height=t.height,this.name=t.name,this.imagePath=t.imagePath,this.textures)this.textures[e].returnToPool(),delete this.textures[e];for(var e in t.textures){var i=this.createTexture();i.copyFrom(t.textures[e]),this.textures[e]=i}},e.prototype.addTexture=function(t){t.name in this.textures?console.warn("Same texture: "+t.name):(t.parent=this,this.textures[t.name]=t)},e.prototype.getTexture=function(t){return t in this.textures?this.textures[t]:null},e}(t.BaseObject);t.TextureAtlasData=e;var i=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.region=new t.Rectangle,i.frame=null,i}return Ant(i,e),i.createRectangle=function(){return new t.Rectangle},i.prototype._onClear=function(){this.rotated=!1,this.name="",this.region.clear(),this.parent=null,this.frame=null},i.prototype.copyFrom=function(t){this.rotated=t.rotated,this.name=t.name,this.region.copyFrom(t.region),this.parent=t.parent,null===this.frame&&null!==t.frame?this.frame=i.createRectangle():null!==this.frame&&null===t.frame&&(this.frame=null),null!==this.frame&&null!==t.frame&&this.frame.copyFrom(t.frame)},i}(t.BaseObject);t.TextureData=i}(Cnt||(Cnt={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.vertices=[],e.bones=[],e}return Ant(e,t),e.toString=function(){return"[class dragonBones.DeformVertices]"},e.prototype._onClear=function(){this.verticesDirty=!1,this.vertices.length=0,this.bones.length=0,this.verticesData=null},e.prototype.init=function(t,e){if(this.verticesData=t,null!==this.verticesData){var i;i=null!==this.verticesData.weight?2*this.verticesData.weight.count:2*this.verticesData.data.intArray[this.verticesData.offset+0],this.verticesDirty=!0,this.vertices.length=i,this.bones.length=0;for(var n=0,s=this.vertices.length;n<s;++n)this.vertices[n]=0;if(null!==this.verticesData.weight)for(n=0,s=this.verticesData.weight.bones.length;n<s;++n){var r=e.getBone(this.verticesData.weight.bones[n].name);this.bones.push(r)}}else this.verticesDirty=!1,this.vertices.length=0,this.bones.length=0,this.verticesData=null},e.prototype.isBonesUpdate=function(){for(var t=0,e=this.bones;t<e.length;t++){var i=e[t];if(null!==i&&i._childrenTransformDirty)return!0}return!1},e}(t.BaseObject);t.DeformVertices=e}(Cnt||(Cnt={})),function(t){var e=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t._bones=[],t._slots=[],t._constraints=[],t._actions=[],t._animation=null,t._proxy=null,t._replaceTextureAtlasData=null,t._clock=null,t}return Ant(i,e),i.toString=function(){return"[class dragonBones.Armature]"},i._onSortSlots=function(t,e){return t._zOrder>e._zOrder?1:-1},i.prototype._onClear=function(){null!==this._clock&&this._clock.remove(this);for(var t=0,e=this._bones;t<e.length;t++)e[t].returnToPool();for(var i=0,n=this._slots;i<n.length;i++)n[i].returnToPool();for(var s=0,r=this._constraints;s<r.length;s++)r[s].returnToPool();for(var o=0,a=this._actions;o<a.length;o++)a[o].returnToPool();null!==this._animation&&this._animation.returnToPool(),null!==this._proxy&&this._proxy.dbClear(),null!==this._replaceTextureAtlasData&&this._replaceTextureAtlasData.returnToPool(),this.inheritAnimation=!0,this.userData=null,this._lockUpdate=!1,this._slotsDirty=!0,this._zOrderDirty=!1,this._flipX=!1,this._flipY=!1,this._cacheFrameIndex=-1,this._bones.length=0,this._slots.length=0,this._constraints.length=0,this._actions.length=0,this._armatureData=null,this._animation=null,this._proxy=null,this._display=null,this._replaceTextureAtlasData=null,this._replacedTexture=null,this._dragonBones=null,this._clock=null,this._parent=null},i.prototype._sortZOrder=function(t,e){var i=this._armatureData.sortedSlots,n=null===t;if(this._zOrderDirty||!n){for(var s=0,r=i.length;s<r;++s){var o=n?s:t[e+s];if(!(o<0||o>=r)){var a=i[o],l=this.getSlot(a.name);null!==l&&l._setZorder(s)}}this._slotsDirty=!0,this._zOrderDirty=!n}},i.prototype._addBone=function(t){this._bones.indexOf(t)<0&&this._bones.push(t)},i.prototype._addSlot=function(t){this._slots.indexOf(t)<0&&this._slots.push(t)},i.prototype._addConstraint=function(t){this._constraints.indexOf(t)<0&&this._constraints.push(t)},i.prototype._bufferAction=function(t,e){this._actions.indexOf(t)<0&&(e?this._actions.push(t):this._actions.unshift(t))},i.prototype.dispose=function(){null!==this._armatureData&&(this._lockUpdate=!0,this._dragonBones.bufferObject(this))},i.prototype.init=function(e,i,n,s){null===this._armatureData&&(this._armatureData=e,this._animation=t.BaseObject.borrowObject(t.Animation),this._proxy=i,this._display=n,this._dragonBones=s,this._proxy.dbInit(this),this._animation.init(this),this._animation.animations=this._armatureData.animations)},i.prototype.advanceTime=function(t){if(!this._lockUpdate)if(null!==this._armatureData)if(null!==this._armatureData.parent){var e=this._cacheFrameIndex;if(this._animation.advanceTime(t),this._slotsDirty&&(this._slotsDirty=!1,this._slots.sort(i._onSortSlots)),this._cacheFrameIndex<0||this._cacheFrameIndex!==e){var n=0,s=0;for(n=0,s=this._bones.length;n<s;++n)this._bones[n].update(this._cacheFrameIndex);for(n=0,s=this._slots.length;n<s;++n)this._slots[n].update(this._cacheFrameIndex)}if(this._actions.length>0){this._lockUpdate=!0;for(var r=0,o=this._actions;r<o.length;r++){var a=o[r],l=a.actionData;if(null!==l&&0===l.type)if(null!==a.slot)null!==(_=a.slot.childArmature)&&_.animation.fadeIn(l.name);else if(null!==a.bone)for(var c=0,h=this.getSlots();c<h.length;c++){var _,u=h[c];u.parent===a.bone&&null!==(_=u.childArmature)&&_.animation.fadeIn(l.name)}else this._animation.fadeIn(l.name);a.returnToPool()}this._actions.length=0,this._lockUpdate=!1}this._proxy.dbUpdate()}else console.warn("The armature data has been disposed.\nPlease make sure dispose armature before call factory.clear().");else console.warn("The armature has been disposed.")},i.prototype.invalidUpdate=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=!1),null!==t&&t.length>0){if(null!==(o=this.getBone(t))&&(o.invalidUpdate(),e))for(var i=0,n=this._slots;i<n.length;i++)(c=n[i]).parent===o&&c.invalidUpdate()}else{for(var s=0,r=this._bones;s<r.length;s++){var o;(o=r[s]).invalidUpdate()}if(e)for(var a=0,l=this._slots;a<l.length;a++){var c;(c=l[a]).invalidUpdate()}}},i.prototype.containsPoint=function(t,e){for(var i=0,n=this._slots;i<n.length;i++){var s=n[i];if(s.containsPoint(t,e))return s}return null},i.prototype.intersectsSegment=function(t,e,i,n,s,r,o){void 0===s&&(s=null),void 0===r&&(r=null),void 0===o&&(o=null);for(var a=t===i,l=0,c=0,h=0,_=0,u=0,m=0,d=0,p=0,f=null,g=null,y=0,v=this._slots;y<v.length;y++){var x=v[y];if(x.intersectsSegment(t,e,i,n,s,r,o)>0){if(null===s&&null===r){f=x;break}var S;null!==s&&((S=a?s.y-e:s.x-t)<0&&(S=-S),(null===f||S<l)&&(l=S,h=s.x,_=s.y,f=x,o&&(d=o.x))),null!==r&&((S=r.x-t)<0&&(S=-S),(null===g||S>c)&&(c=S,u=r.x,m=r.y,g=x,null!==o&&(p=o.y)))}}return null!==f&&null!==s&&(s.x=h,s.y=_,null!==o&&(o.x=d)),null!==g&&null!==r&&(r.x=u,r.y=m,null!==o&&(o.y=p)),f},i.prototype.getBone=function(t){for(var e=0,i=this._bones;e<i.length;e++){var n=i[e];if(n.name===t)return n}return null},i.prototype.getBoneByDisplay=function(t){var e=this.getSlotByDisplay(t);return null!==e?e.parent:null},i.prototype.getSlot=function(t){for(var e=0,i=this._slots;e<i.length;e++){var n=i[e];if(n.name===t)return n}return null},i.prototype.getSlotByDisplay=function(t){if(null!==t)for(var e=0,i=this._slots;e<i.length;e++){var n=i[e];if(n.display===t)return n}return null},i.prototype.getBones=function(){return this._bones},i.prototype.getSlots=function(){return this._slots},Object.defineProperty(i.prototype,"flipX",{get:function(){return this._flipX},set:function(t){this._flipX!==t&&(this._flipX=t,this.invalidUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"flipY",{get:function(){return this._flipY},set:function(t){this._flipY!==t&&(this._flipY=t,this.invalidUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"cacheFrameRate",{get:function(){return this._armatureData.cacheFrameRate},set:function(t){if(this._armatureData.cacheFrameRate!==t){this._armatureData.cacheFrames(t);for(var e=0,i=this._slots;e<i.length;e++){var n=i[e].childArmature;null!==n&&(n.cacheFrameRate=t)}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return this._armatureData.name},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"armatureData",{get:function(){return this._armatureData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animation",{get:function(){return this._animation},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"proxy",{get:function(){return this._proxy},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"eventDispatcher",{get:function(){return this._proxy},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"display",{get:function(){return this._display},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"replacedTexture",{get:function(){return this._replacedTexture},set:function(t){if(this._replacedTexture!==t){null!==this._replaceTextureAtlasData&&(this._replaceTextureAtlasData.returnToPool(),this._replaceTextureAtlasData=null),this._replacedTexture=t;for(var e=0,i=this._slots;e<i.length;e++){var n=i[e];n.invalidUpdate(),n.update(-1)}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"clock",{get:function(){return this._clock},set:function(t){if(this._clock!==t){null!==this._clock&&this._clock.remove(this),this._clock=t,this._clock&&this._clock.add(this);for(var e=0,i=this._slots;e<i.length;e++){var n=i[e].childArmature;null!==n&&(n.clock=this._clock)}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),i.prototype.replaceTexture=function(t){this.replacedTexture=t},i.prototype.hasEventListener=function(t){return this._proxy.hasDBEventListener(t)},i.prototype.addEventListener=function(t,e,i){this._proxy.addDBEventListener(t,e,i)},i.prototype.removeEventListener=function(t,e,i){this._proxy.removeDBEventListener(t,e,i)},i.prototype.enableAnimationCache=function(t){console.warn("Deprecated."),this.cacheFrameRate=t},i.prototype.getDisplay=function(){return this._display},i}(t.BaseObject);t.Armature=e}(Cnt||(Cnt={})),function(t){var e=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.globalTransformMatrix=new t.Matrix,i.global=new t.Transform,i.offset=new t.Transform,i}return Ant(i,e),i.prototype._onClear=function(){this.globalTransformMatrix.identity(),this.global.identity(),this.offset.identity(),this.origin=null,this.userData=null,this._globalDirty=!1,this._armature=null},i.prototype.updateGlobalTransform=function(){this._globalDirty&&(this._globalDirty=!1,this.global.fromMatrix(this.globalTransformMatrix))},Object.defineProperty(i.prototype,"armature",{get:function(){return this._armature},enumerable:!0,configurable:!0}),i._helpMatrix=new t.Matrix,i._helpTransform=new t.Transform,i._helpPoint=new t.Point,i}(t.BaseObject);t.TransformObject=e}(Cnt||(Cnt={})),function(t){var e=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.animationPose=new t.Transform,i._blendState=new t.BlendState,i}return Ant(i,e),i.toString=function(){return"[class dragonBones.Bone]"},i.prototype._onClear=function(){e.prototype._onClear.call(this),this.offsetMode=1,this.animationPose.identity(),this._transformDirty=!1,this._childrenTransformDirty=!1,this._localDirty=!0,this._hasConstraint=!1,this._visible=!0,this._cachedFrameIndex=-1,this._blendState.clear(),this._boneData=null,this._parent=null,this._cachedFrameIndices=null},i.prototype._updateGlobalTransformMatrix=function(e){var i=this._boneData,n=this.global,s=this.globalTransformMatrix,r=this.origin,o=this.offset,a=this.animationPose,l=this._parent,c=this._armature.flipX,h=this._armature.flipY===t.DragonBones.yDown,_=null!==l,u=0;if(1===this.offsetMode?null!==r?(n.x=r.x+o.x+a.x,n.scaleX=r.scaleX*o.scaleX*a.scaleX,n.scaleY=r.scaleY*o.scaleY*a.scaleY,t.DragonBones.yDown?(n.y=r.y+o.y+a.y,n.skew=r.skew+o.skew+a.skew,n.rotation=r.rotation+o.rotation+a.rotation):(n.y=r.y-o.y+a.y,n.skew=r.skew-o.skew+a.skew,n.rotation=r.rotation-o.rotation+a.rotation)):(n.copyFrom(o),t.DragonBones.yDown||(n.y=-n.y,n.skew=-n.skew,n.rotation=-n.rotation),n.add(a)):0===this.offsetMode?null!==r?n.copyFrom(r).add(a):n.copyFrom(a):(_=!1,n.copyFrom(o),t.DragonBones.yDown||(n.y=-n.y,n.skew=-n.skew,n.rotation=-n.rotation)),_){var m=0===l._boneData.type?l.globalTransformMatrix:l._getGlobalTransformMatrix(n.x,n.y);if(i.inheritScale)i.inheritRotation||(l.updateGlobalTransform(),u=c&&h?n.rotation-(l.global.rotation+Math.PI):c?n.rotation+l.global.rotation+Math.PI:h?n.rotation+l.global.rotation:n.rotation-l.global.rotation,n.rotation=u),n.toMatrix(s),s.concat(m),i.inheritTranslation?(n.x=s.tx,n.y=s.ty):(s.tx=n.x,s.ty=n.y),e?n.fromMatrix(s):this._globalDirty=!0;else{if(i.inheritTranslation){var d=n.x,p=n.y;n.x=m.a*d+m.c*p+m.tx,n.y=m.b*d+m.d*p+m.ty}else c&&(n.x=-n.x),h&&(n.y=-n.y);i.inheritRotation?(l.updateGlobalTransform(),u=l.global.scaleX<0?n.rotation+l.global.rotation+Math.PI:n.rotation+l.global.rotation,m.a*m.d-m.b*m.c<0&&(u-=2*n.rotation,(c!==h||i.inheritReflection)&&(n.skew+=Math.PI),t.DragonBones.yDown||(n.skew=-n.skew)),n.rotation=u):(c||h)&&(c&&h?u=n.rotation+Math.PI:(u=c?Math.PI-n.rotation:-n.rotation,n.skew+=Math.PI),n.rotation=u),n.toMatrix(s)}}else(c||h)&&(c&&(n.x=-n.x),h&&(n.y=-n.y),c&&h?u=n.rotation+Math.PI:(u=c?Math.PI-n.rotation:-n.rotation,n.skew+=Math.PI),n.rotation=u),n.toMatrix(s)},i.prototype.init=function(t,e){null===this._boneData&&(this._boneData=t,this._armature=e,null!==this._boneData.parent&&(this._parent=this._armature.getBone(this._boneData.parent.name)),this._armature._addBone(this),this.origin=this._boneData.transform)},i.prototype.update=function(t){if(this._blendState.dirty=!1,t>=0&&null!==this._cachedFrameIndices){var e=this._cachedFrameIndices[t];if(e>=0&&this._cachedFrameIndex===e)this._transformDirty=!1;else if(e>=0)this._transformDirty=!0,this._cachedFrameIndex=e;else{if(this._hasConstraint)for(var i=0,n=this._armature._constraints;i<n.length;i++)(o=n[i])._root===this&&o.update();this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[t]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}}else{if(this._hasConstraint)for(var s=0,r=this._armature._constraints;s<r.length;s++){var o;(o=r[s])._root===this&&o.update()}(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&(t=-1,this._transformDirty=!0,this._cachedFrameIndex=-1)}if(this._transformDirty)if(this._transformDirty=!1,this._childrenTransformDirty=!0,this._cachedFrameIndex<0){var a=t>=0;this._localDirty&&this._updateGlobalTransformMatrix(a),a&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[t]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);else this._childrenTransformDirty&&(this._childrenTransformDirty=!1);this._localDirty=!0},i.prototype.updateByConstraint=function(){this._localDirty&&(this._localDirty=!1,(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&this._updateGlobalTransformMatrix(!0),this._transformDirty=!0)},i.prototype.invalidUpdate=function(){this._transformDirty=!0},i.prototype.contains=function(t){if(t===this)return!1;for(var e=t;e!==this&&null!==e;)e=e.parent;return e===this},Object.defineProperty(i.prototype,"boneData",{get:function(){return this._boneData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"visible",{get:function(){return this._visible},set:function(t){if(this._visible!==t){this._visible=t;for(var e=0,i=this._armature.getSlots();e<i.length;e++){var n=i[e];n.parent===this&&n._updateVisible()}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return this._boneData.name},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),i.prototype.getBones=function(){console.warn("Deprecated.");for(var t=new Array,e=0,i=this._armature.getBones();e<i.length;e++){var n=i[e];n.parent===this&&t.push(n)}return t},i.prototype.getSlots=function(){console.warn("Deprecated.");for(var t=new Array,e=0,i=this._armature.getSlots();e<i.length;e++){var n=i[e];n.parent===this&&t.push(n)}return t},Object.defineProperty(i.prototype,"slot",{get:function(){console.warn("Deprecated.");for(var t=0,e=this._armature.getSlots();t<e.length;t++){var i=e[t];if(i.parent===this)return i}return null},enumerable:!0,configurable:!0}),i}(t.TransformObject);t.Bone=e}(Cnt||(Cnt={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._vertices=[],e._deformVertices=[],e._hullCache=[],e._matrixCahce=[],e}return Ant(e,t),e.toString=function(){return"[class dragonBones.Surface]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._dX=0,this._dY=0,this._k=0,this._kX=0,this._kY=0,this._vertices.length=0,this._deformVertices.length=0,this._matrixCahce.length=0,this._hullCache.length=0},e.prototype._getAffineTransform=function(t,e,i,n,s,r,o,a,l,c,h,_,u){var m=o-s,d=a-r,p=l-s,f=c-r;h.rotation=Math.atan2(d,m),h.skew=Math.atan2(f,p)-.5*Math.PI-h.rotation,u&&(h.rotation+=Math.PI),h.scaleX=Math.sqrt(m*m+d*d)/i,h.scaleY=Math.sqrt(p*p+f*f)/n,h.toMatrix(_),h.x=_.tx=s-(_.a*t+_.c*e),h.y=_.ty=r-(_.b*t+_.d*e)},e.prototype._updateVertices=function(){var t=this._boneData.vertices,e=this._vertices,i=this._deformVertices;if(null!==this._parent)if(1===this._parent._boneData.type)for(var n=0,s=t.length;n<s;n+=2){var r=t[n]+i[n],o=t[n+1]+i[n],a=this._parent._getGlobalTransformMatrix(r,o);e[n]=a.a*r+a.c*o+a.tx,e[n+1]=a.b*r+a.d*o+a.ty}else{var l=this._parent.globalTransformMatrix;for(n=0,s=t.length;n<s;n+=2)r=t[n]+i[n],o=t[n+1]+i[n+1],e[n]=l.a*r+l.c*o+l.tx,e[n+1]=l.b*r+l.d*o+l.ty}else for(n=0,s=t.length;n<s;n+=2)e[n]=t[n]+i[n],e[n+1]=t[n+1]+i[n+1]},e.prototype._updateGlobalTransformMatrix=function(){var t=2*this._boneData.segmentX,e=this._vertices.length-2,i=this._vertices[0],n=this._vertices[1],s=this._vertices[t],r=this._vertices[t+1],o=this._vertices[e],a=this._vertices[e+1],l=this._vertices[e-t],c=this._vertices[e-t+1],h=i+.5*(o-i),_=n+.5*(a-n),u=h+.5*(s+.5*(l-s)-h),m=_+.5*(r+.5*(c-r)-_),d=s+.5*(o-s),p=r+.5*(a-r),f=l+.5*(o-l),g=c+.5*(a-c);this._globalDirty=!1,this._getAffineTransform(0,0,200,200,u,m,d,p,f,g,this.global,this.globalTransformMatrix,!1)},e.prototype._getGlobalTransformMatrix=function(t,i){var n=1e3;if(t<-n||n<t||i<-n||n<i)return this.globalTransformMatrix;var s=!1,r=200,o=this._boneData,a=o.segmentX,l=o.segmentY,c=2*o.segmentX,h=this._dX,_=this._dY,u=Math.floor((t+r)/h),m=Math.floor((i+r)/_),d=0,p=u*h-r,f=m*_-r,g=this._matrixCahce,y=e._helpMatrix;if(t<-r){if(i<-r||i>=r)return this.globalTransformMatrix;if(d=7*(2*(a*(l+1)+2*a+l+m)+((s=i>this._kX*(t+r)+f)?1:0)),this._matrixCahce[d]>0)y.copyFromArray(g,d+1);else{var v=m*(c+2),x=this._hullCache[4],S=this._hullCache[5],A=this._hullCache[2]-(l-m)*x,C=this._hullCache[3]-(l-m)*S,b=this._vertices;s?this._getAffineTransform(-r,f+_,800,_,b[v+c+2],b[v+c+3],A+x,C+S,b[v],b[v+1],e._helpTransform,y,!0):this._getAffineTransform(-n,f,800,_,A,C,b[v],b[v+1],A+x,C+S,e._helpTransform,y,!1),g[d]=1,g[d+1]=y.a,g[d+2]=y.b,g[d+3]=y.c,g[d+4]=y.d,g[d+5]=y.tx,g[d+6]=y.ty}}else if(t>=r){if(i<-r||i>=r)return this.globalTransformMatrix;d=7*(2*(a*(l+1)+a+m)+((s=i>this._kX*(t-n)+f)?1:0)),this._matrixCahce[d]>0?y.copyFromArray(g,d+1):(v=(m+1)*(c+2)-2,x=this._hullCache[4],S=this._hullCache[5],A=this._hullCache[0]+m*x,C=this._hullCache[1]+m*S,b=this._vertices,s?this._getAffineTransform(n,f+_,800,_,A+x,C+S,b[v+c+2],b[v+c+3],A,C,e._helpTransform,y,!0):this._getAffineTransform(r,f,800,_,b[v],b[v+1],A,C,b[v+c+2],b[v+c+3],e._helpTransform,y,!1),g[d]=1,g[d+1]=y.a,g[d+2]=y.b,g[d+3]=y.c,g[d+4]=y.d,g[d+5]=y.tx,g[d+6]=y.ty)}else if(i<-r){if(t<-r||t>=r)return this.globalTransformMatrix;d=7*(a*(l+1)+2*u+((s=i>this._kY*(t-p-h)-n)?1:0)),this._matrixCahce[d]>0?y.copyFromArray(g,d+1):(v=2*u,x=this._hullCache[10],S=this._hullCache[11],A=this._hullCache[8]+u*x,C=this._hullCache[9]+u*S,b=this._vertices,s?this._getAffineTransform(p+h,-r,h,800,b[v+2],b[v+3],b[v],b[v+1],A+x,C+S,e._helpTransform,y,!0):this._getAffineTransform(p,-n,h,800,A,C,A+x,C+S,b[v],b[v+1],e._helpTransform,y,!1),g[d]=1,g[d+1]=y.a,g[d+2]=y.b,g[d+3]=y.c,g[d+4]=y.d,g[d+5]=y.tx,g[d+6]=y.ty)}else if(i>=r){if(t<-r||t>=r)return this.globalTransformMatrix;d=7*(2*(a*(l+1)+a+l+m)+((s=i>this._kY*(t-p-h)+r)?1:0)),this._matrixCahce[d]>0?y.copyFromArray(g,d+1):(v=l*(c+2)+2*u,x=this._hullCache[10],S=this._hullCache[11],A=this._hullCache[6]-(a-u)*x,C=this._hullCache[7]-(a-u)*S,b=this._vertices,s?this._getAffineTransform(p+h,n,h,800,A+x,C+S,A,C,b[v+2],b[v+3],e._helpTransform,y,!0):this._getAffineTransform(p,r,h,800,b[v],b[v+1],b[v+2],b[v+3],A,C,e._helpTransform,y,!1),g[d]=1,g[d+1]=y.a,g[d+2]=y.b,g[d+3]=y.c,g[d+4]=y.d,g[d+5]=y.tx,g[d+6]=y.ty)}else d=7*(2*(a*m+u)+((s=i>this._k*(t-p-h)+f)?1:0)),this._matrixCahce[d]>0?y.copyFromArray(g,d+1):(v=2*u+m*(c+2),b=this._vertices,s?this._getAffineTransform(p+h,f+_,h,_,b[v+c+4],b[v+c+5],b[v+c+2],b[v+c+3],b[v+2],b[v+3],e._helpTransform,y,!0):this._getAffineTransform(p,f,h,_,b[v],b[v+1],b[v+2],b[v+3],b[v+c+2],b[v+c+3],e._helpTransform,y,!1),g[d]=1,g[d+1]=y.a,g[d+2]=y.b,g[d+3]=y.c,g[d+4]=y.d,g[d+5]=y.tx,g[d+6]=y.ty);return y},e.prototype.init=function(e,i){if(null===this._boneData){t.prototype.init.call(this,e,i);var n=e.segmentX,s=e.segmentY,r=e.vertices.length;this._dX=400/n,this._dY=400/s,this._k=-this._dY/this._dX,this._kX=-this._dY/800,this._kY=-800/this._dX,this._vertices.length=r,this._deformVertices.length=r,this._matrixCahce.length=14*(n*s+2*n+2*s),this._hullCache.length=10;for(var o=0;o<r;++o)this._deformVertices[o]=0}},e.prototype.update=function(t){if(this._blendState.dirty=!1,t>=0&&null!==this._cachedFrameIndices){var i=this._cachedFrameIndices[t];if(i>=0&&this._cachedFrameIndex===i)this._transformDirty=!1;else if(i>=0)this._transformDirty=!0,this._cachedFrameIndex=i;else{if(this._hasConstraint)for(var n=0,s=this._armature._constraints;n<s.length;n++)(a=s[n])._root===this&&a.update();this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[t]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}}else{if(this._hasConstraint)for(var r=0,o=this._armature._constraints;r<o.length;r++){var a;(a=o[r])._root===this&&a.update()}(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&(t=-1,this._transformDirty=!0,this._cachedFrameIndex=-1)}if(this._transformDirty){this._transformDirty=!1,this._childrenTransformDirty=!0;for(var l=0,c=this._matrixCahce.length;l<c;l+=7)this._matrixCahce[l]=-1;if(this._updateVertices(),this._cachedFrameIndex<0){var h=t>=0;this._localDirty&&this._updateGlobalTransformMatrix(h),h&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[t]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);var _=2*this.global.x,u=2*this.global.y,m=e._helpPoint;this.globalTransformMatrix.transformPoint(1e3,-200,m),this._hullCache[0]=m.x,this._hullCache[1]=m.y,this._hullCache[2]=_-m.x,this._hullCache[3]=u-m.y,this.globalTransformMatrix.transformPoint(0,this._dY,m,!0),this._hullCache[4]=m.x,this._hullCache[5]=m.y,this.globalTransformMatrix.transformPoint(200,1e3,m),this._hullCache[6]=m.x,this._hullCache[7]=m.y,this._hullCache[8]=_-m.x,this._hullCache[9]=u-m.y,this.globalTransformMatrix.transformPoint(this._dX,0,m,!0),this._hullCache[10]=m.x,this._hullCache[11]=m.y}else this._childrenTransformDirty&&(this._childrenTransformDirty=!1);this._localDirty=!0},e}(t.Bone);t.Surface=e}(Cnt||(Cnt={})),function(t){var e=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i._localMatrix=new t.Matrix,i._colorTransform=new t.ColorTransform,i._displayDatas=[],i._displayList=[],i._deformVertices=null,i._rawDisplay=null,i._meshDisplay=null,i}return Ant(i,e),i.prototype._onClear=function(){e.prototype._onClear.call(this);for(var i=[],n=0,s=this._displayList;n<s.length;n++)null!==(a=s[n])&&a!==this._rawDisplay&&a!==this._meshDisplay&&i.indexOf(a)<0&&i.push(a);for(var r=0,o=i;r<o.length;r++){var a;(a=o[r])instanceof t.Armature?a.dispose():this._disposeDisplay(a,!0)}null!==this._deformVertices&&this._deformVertices.returnToPool(),null!==this._meshDisplay&&this._meshDisplay!==this._rawDisplay&&this._disposeDisplay(this._meshDisplay,!1),null!==this._rawDisplay&&this._disposeDisplay(this._rawDisplay,!1),this.displayController=null,this._displayDirty=!1,this._zOrderDirty=!1,this._blendModeDirty=!1,this._colorDirty=!1,this._transformDirty=!1,this._visible=!0,this._blendMode=0,this._displayIndex=-1,this._animationDisplayIndex=-1,this._zOrder=0,this._cachedFrameIndex=-1,this._pivotX=0,this._pivotY=0,this._localMatrix.identity(),this._colorTransform.identity(),this._displayList.length=0,this._displayDatas.length=0,this._slotData=null,this._rawDisplayDatas=null,this._displayData=null,this._boundingBoxData=null,this._textureData=null,this._deformVertices=null,this._rawDisplay=null,this._meshDisplay=null,this._display=null,this._childArmature=null,this._parent=null,this._cachedFrameIndices=null},i.prototype._getDefaultRawDisplayData=function(t){var e=this._armature._armatureData.defaultSkin;if(null!==e){var i=e.getDisplays(this._slotData.name);if(null!==i)return t<i.length?i[t]:null}return null},i.prototype._updateDisplayData=function(){var e=this._displayData,n=null!==this._deformVertices?this._deformVertices.verticesData:null,s=this._textureData,r=null,o=null;if(this._displayData=null,this._boundingBoxData=null,this._textureData=null,this._displayIndex>=0&&(null!==this._rawDisplayDatas&&(r=this._displayIndex<this._rawDisplayDatas.length?this._rawDisplayDatas[this._displayIndex]:null),null===r&&(r=this._getDefaultRawDisplayData(this._displayIndex)),this._displayIndex<this._displayDatas.length&&(this._displayData=this._displayDatas[this._displayIndex])),null!==this._displayData&&(2===this._displayData.type||4===this._displayData.type?o=this._displayData.vertices:null!==r&&(2===r.type||4===r.type)&&(o=r.vertices),3===this._displayData.type?this._boundingBoxData=this._displayData.boundingBox:null!==r&&3===r.type&&(this._boundingBoxData=r.boundingBox),(0===this._displayData.type||2===this._displayData.type)&&(this._textureData=this._displayData.texture)),this._displayData!==e||o!==n||this._textureData!==s){if(null===o&&null!==this._textureData){var a=this._displayData,l=this._textureData.parent.scale*this._armature._armatureData.scale,c=this._textureData.frame;this._pivotX=a.pivot.x,this._pivotY=a.pivot.y;var h=null!==c?c:this._textureData.region,_=h.width,u=h.height;this._textureData.rotated&&null===c&&(_=h.height,u=h.width),this._pivotX*=_*l,this._pivotY*=u*l,null!==c&&(this._pivotX+=c.x*l,this._pivotY+=c.y*l),null!==this._displayData&&null!==r&&this._displayData!==r&&(r.transform.toMatrix(i._helpMatrix),i._helpMatrix.invert(),i._helpMatrix.transformPoint(0,0,i._helpPoint),this._pivotX-=i._helpPoint.x,this._pivotY-=i._helpPoint.y,this._displayData.transform.toMatrix(i._helpMatrix),i._helpMatrix.invert(),i._helpMatrix.transformPoint(0,0,i._helpPoint),this._pivotX+=i._helpPoint.x,this._pivotY+=i._helpPoint.y),t.DragonBones.yDown||(this._pivotY=(this._textureData.rotated?this._textureData.region.width:this._textureData.region.height)*l-this._pivotY)}else this._pivotX=0,this._pivotY=0;null!==r?this.origin=r.transform:null!==this._displayData?this.origin=this._displayData.transform:this.origin=null,o!==n?(null===this._deformVertices&&(this._deformVertices=t.BaseObject.borrowObject(t.DeformVertices)),this._deformVertices.init(o,this._armature)):null!==this._deformVertices&&this._textureData!==s&&(this._deformVertices.verticesDirty=!0),this._displayDirty=!0,this._transformDirty=!0}},i.prototype._updateDisplay=function(){var e=null!==this._display?this._display:this._rawDisplay,i=this._childArmature;this._displayIndex>=0&&this._displayIndex<this._displayList.length?(this._display=this._displayList[this._displayIndex],null!==this._display&&this._display instanceof t.Armature?(this._childArmature=this._display,this._display=this._childArmature.display):this._childArmature=null):(this._display=null,this._childArmature=null);var n=null!==this._display?this._display:this._rawDisplay;if(n!==e&&(this._onUpdateDisplay(),this._replaceDisplay(e),this._transformDirty=!0,this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0),n!==this._rawDisplay&&n!==this._meshDisplay||this._updateFrame(),this._childArmature!==i&&(null!==i&&(i._parent=null,i.clock=null,i.inheritAnimation&&i.animation.reset()),null!==this._childArmature&&(this._childArmature._parent=this,this._childArmature.clock=this._armature.clock,this._childArmature.inheritAnimation))){if(0===this._childArmature.cacheFrameRate){var s=this._armature.cacheFrameRate;0!==s&&(this._childArmature.cacheFrameRate=s)}var r=null;if(null!==this._displayData&&1===this._displayData.type)r=this._displayData.actions;else if(this._displayIndex>=0&&null!==this._rawDisplayDatas){var o=this._displayIndex<this._rawDisplayDatas.length?this._rawDisplayDatas[this._displayIndex]:null;null===o&&(o=this._getDefaultRawDisplayData(this._displayIndex)),null!==o&&1===o.type&&(r=o.actions)}if(null!==r&&r.length>0)for(var a=0,l=r;a<l.length;a++){var c=l[a],h=t.BaseObject.borrowObject(t.EventObject);t.EventObject.actionDataToInstance(c,h,this._armature),h.slot=this,this._armature._bufferAction(h,!1)}else this._childArmature.animation.play()}},i.prototype._updateGlobalTransformMatrix=function(t){var e=0===this._parent._boneData.type?this._parent.globalTransformMatrix:this._parent._getGlobalTransformMatrix(this.global.x,this.global.y);this.globalTransformMatrix.copyFrom(this._localMatrix),this.globalTransformMatrix.concat(e),t?this.global.fromMatrix(this.globalTransformMatrix):this._globalDirty=!0},i.prototype._setDisplayIndex=function(t,e){if(void 0===e&&(e=!1),e){if(this._animationDisplayIndex===t)return!1;this._animationDisplayIndex=t}return this._displayIndex!==t&&(this._displayIndex=t,this._displayDirty=!0,this._updateDisplayData(),this._displayDirty)},i.prototype._setZorder=function(t){return this._zOrder,this._zOrder=t,this._zOrderDirty=!0,this._zOrderDirty},i.prototype._setColor=function(t){return this._colorTransform.copyFrom(t),this._colorDirty=!0,this._colorDirty},i.prototype._setDisplayList=function(e){if(null!==e&&e.length>0){this._displayList.length!==e.length&&(this._displayList.length=e.length);for(var i=0,n=e.length;i<n;++i){var s=e[i];null!==s&&s!==this._rawDisplay&&s!==this._meshDisplay&&!(s instanceof t.Armature)&&this._displayList.indexOf(s)<0&&this._initDisplay(s,!0),this._displayList[i]=s}}else this._displayList.length>0&&(this._displayList.length=0);return this._displayIndex>=0&&this._displayIndex<this._displayList.length?this._displayDirty=this._display!==this._displayList[this._displayIndex]:this._displayDirty=null!==this._display,this._updateDisplayData(),this._displayDirty},i.prototype.init=function(t,e,i,n){if(null===this._slotData){this._slotData=t,this._isFromCache=!1,this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0,this._blendMode=this._slotData.blendMode,this._zOrder=this._slotData.zOrder,this._colorTransform.copyFrom(this._slotData.color),this._rawDisplay=i,this._meshDisplay=n,this._armature=e;var s=this._armature.getBone(this._slotData.parent.name);null!==s&&(this._parent=s),this._armature._addSlot(this),this._initDisplay(this._rawDisplay,!1),this._rawDisplay!==this._meshDisplay&&this._initDisplay(this._meshDisplay,!1),this._onUpdateDisplay(),this._addDisplay()}},i.prototype.update=function(t){if(this._isFromCache=!1,this._displayDirty&&(this._displayDirty=!1,this._updateDisplay(),this._transformDirty&&(null!==this.origin?this.global.copyFrom(this.origin).add(this.offset).toMatrix(this._localMatrix):this.global.copyFrom(this.offset).toMatrix(this._localMatrix))),this._zOrderDirty&&(this._zOrderDirty=!1,this._updateZOrder()),t>=0&&null!==this._cachedFrameIndices){var e=this._cachedFrameIndices[t];e>=0&&this._cachedFrameIndex===e?this._transformDirty=!1:e>=0?(this._transformDirty=!0,this._cachedFrameIndex=e):this._transformDirty||this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[t]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}else(this._transformDirty||this._parent._childrenTransformDirty)&&(t=-1,this._transformDirty=!0,this._cachedFrameIndex=-1);if(null!==this._display){if(this._visibleDirty&&(this._visibleDirty=!1,this._updateVisible()),this._blendModeDirty&&(this._blendModeDirty=!1,this._updateBlendMode()),this._colorDirty&&(this._colorDirty=!1,this._updateColor()),null!==this._deformVertices&&null!==this._deformVertices.verticesData&&this._display===this._meshDisplay){var i=null!==this._deformVertices.verticesData.weight,n=0!==this._parent._boneData.type;if((this._deformVertices.verticesDirty||i&&this._deformVertices.isBonesUpdate()||n&&this._parent._childrenTransformDirty)&&(this._deformVertices.verticesDirty=!1,this._updateMesh()),i||n)return}if(this._transformDirty){if(this._transformDirty=!1,this._cachedFrameIndex<0){var s=t>=0;this._updateGlobalTransformMatrix(s),s&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[t]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._isFromCache=!0,this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);this._updateTransform()}}},i.prototype.updateTransformAndMatrix=function(){this._transformDirty&&(this._transformDirty=!1,this._updateGlobalTransformMatrix(!1))},i.prototype.replaceDisplayData=function(t,e){if(void 0===e&&(e=-1),e<0&&(e=this._displayIndex<0?0:this._displayIndex),this._displayDatas.length<=e){this._displayDatas.length=e+1;for(var i=0,n=this._displayDatas.length;i<n;++i)this._displayDatas[i]||(this._displayDatas[i]=null)}this._displayDatas[e]=t},i.prototype.containsPoint=function(t,e){return null!==this._boundingBoxData&&(this.updateTransformAndMatrix(),i._helpMatrix.copyFrom(this.globalTransformMatrix),i._helpMatrix.invert(),i._helpMatrix.transformPoint(t,e,i._helpPoint),this._boundingBoxData.containsPoint(i._helpPoint.x,i._helpPoint.y))},i.prototype.intersectsSegment=function(t,e,n,s,r,o,a){if(void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null),null===this._boundingBoxData)return 0;this.updateTransformAndMatrix(),i._helpMatrix.copyFrom(this.globalTransformMatrix),i._helpMatrix.invert(),i._helpMatrix.transformPoint(t,e,i._helpPoint),t=i._helpPoint.x,e=i._helpPoint.y,i._helpMatrix.transformPoint(n,s,i._helpPoint),n=i._helpPoint.x,s=i._helpPoint.y;var l=this._boundingBoxData.intersectsSegment(t,e,n,s,r,o,a);return l>0&&(1===l||2===l?null!==r?(this.globalTransformMatrix.transformPoint(r.x,r.y,r),null!==o&&(o.x=r.x,o.y=r.y)):null!==o&&this.globalTransformMatrix.transformPoint(o.x,o.y,o):(null!==r&&this.globalTransformMatrix.transformPoint(r.x,r.y,r),null!==o&&this.globalTransformMatrix.transformPoint(o.x,o.y,o)),null!==a&&(this.globalTransformMatrix.transformPoint(Math.cos(a.x),Math.sin(a.x),i._helpPoint,!0),a.x=Math.atan2(i._helpPoint.y,i._helpPoint.x),this.globalTransformMatrix.transformPoint(Math.cos(a.y),Math.sin(a.y),i._helpPoint,!0),a.y=Math.atan2(i._helpPoint.y,i._helpPoint.x))),l},i.prototype.invalidUpdate=function(){this._displayDirty=!0,this._transformDirty=!0},Object.defineProperty(i.prototype,"visible",{get:function(){return this._visible},set:function(t){this._visible!==t&&(this._visible=t,this._updateVisible())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"displayIndex",{get:function(){return this._displayIndex},set:function(t){this._setDisplayIndex(t)&&this.update(-1)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return this._slotData.name},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"displayList",{get:function(){return this._displayList.concat()},set:function(e){var i=this._displayList.concat(),n=new Array;this._setDisplayList(e)&&this.update(-1);for(var s=0,r=i;s<r.length;s++)null!==(l=r[s])&&l!==this._rawDisplay&&l!==this._meshDisplay&&this._displayList.indexOf(l)<0&&n.indexOf(l)<0&&n.push(l);for(var o=0,a=n;o<a.length;o++){var l;(l=a[o])instanceof t.Armature||this._disposeDisplay(l,!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"slotData",{get:function(){return this._slotData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rawDisplayDatas",{get:function(){return this._rawDisplayDatas},set:function(t){if(this._rawDisplayDatas!==t)if(this._displayDirty=!0,this._rawDisplayDatas=t,null!==this._rawDisplayDatas){this._displayDatas.length=this._rawDisplayDatas.length;for(var e=0,i=this._displayDatas.length;e<i;++e){var n=this._rawDisplayDatas[e];null===n&&(n=this._getDefaultRawDisplayData(e)),this._displayDatas[e]=n}}else this._displayDatas.length=0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"displayData",{get:function(){return this._displayData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"boundingBoxData",{get:function(){return this._boundingBoxData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rawDisplay",{get:function(){return this._rawDisplay},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"meshDisplay",{get:function(){return this._meshDisplay},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"display",{get:function(){return this._display},set:function(t){if(this._display!==t){var e=this._displayList.length;if(this._displayIndex<0&&0===e&&(this._displayIndex=0),!(this._displayIndex<0)){var i=this.displayList;e<=this._displayIndex&&(i.length=this._displayIndex+1),i[this._displayIndex]=t,this.displayList=i}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"childArmature",{get:function(){return this._childArmature},set:function(t){this._childArmature!==t&&(this.display=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),i.prototype.getDisplay=function(){return this._display},i.prototype.setDisplay=function(t){this.display=t},i}(t.TransformObject);t.Slot=e}(Cnt||(Cnt={})),function(t){var e=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return Ant(i,e),i.prototype._onClear=function(){this._armature=null,this._target=null,this._root=null,this._bone=null},Object.defineProperty(i.prototype,"name",{get:function(){return this._constraintData.name},enumerable:!0,configurable:!0}),i._helpMatrix=new t.Matrix,i._helpTransform=new t.Transform,i._helpPoint=new t.Point,i}(t.BaseObject);t.Constraint=e;var i=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return Ant(i,e),i.toString=function(){return"[class dragonBones.IKConstraint]"},i.prototype._onClear=function(){e.prototype._onClear.call(this),this._scaleEnabled=!1,this._bendPositive=!1,this._weight=1,this._constraintData=null},i.prototype._computeA=function(){var e=this._target.global,i=this._root.global,n=this._root.globalTransformMatrix,s=Math.atan2(e.y-i.y,e.x-i.x);i.scaleX<0&&(s+=Math.PI),i.rotation+=t.Transform.normalizeRadian(s-i.rotation)*this._weight,i.toMatrix(n)},i.prototype._computeB=function(){var e=this._bone._boneData.length,i=this._root,n=this._target.global,s=i.global,r=this._bone.global,o=this._bone.globalTransformMatrix,a=o.a*e,l=o.b*e,c=a*a+l*l,h=Math.sqrt(c),_=r.x-s.x,u=r.y-s.y,m=_*_+u*u,d=Math.sqrt(m),p=r.rotation,f=s.rotation,g=Math.atan2(u,_),y=(_=n.x-s.x)*_+(u=n.y-s.y)*u,v=Math.sqrt(y),x=0;if(h+d<=v||v+h<=d||v+d<=h)x=Math.atan2(n.y-s.y,n.x-s.x),h+d<=v||d<h&&(x+=Math.PI);else{var S=(m-c+y)/(2*y),A=Math.sqrt(m-S*S*y)/v,C=s.x+_*S,b=s.y+u*S,T=-u*A,w=_*A,E=!1,P=i.parent;if(null!==P){var I=P.globalTransformMatrix;E=I.a*I.d-I.b*I.c<0}E!==this._bendPositive?(r.x=C-T,r.y=b-w):(r.x=C+T,r.y=b+w),x=Math.atan2(r.y-s.y,r.x-s.x)}var D=t.Transform.normalizeRadian(x-g);s.rotation=f+D*this._weight,s.toMatrix(i.globalTransformMatrix);var R=g+D*this._weight;r.x=s.x+Math.cos(R)*d,r.y=s.y+Math.sin(R)*d;var M=Math.atan2(n.y-r.y,n.x-r.x);r.scaleX<0&&(M+=Math.PI),r.rotation=s.rotation+p-f+t.Transform.normalizeRadian(M-D-p)*this._weight,r.toMatrix(o)},i.prototype.init=function(t,e){if(null===this._constraintData){this._constraintData=t,this._armature=e,this._target=this._armature.getBone(this._constraintData.target.name),this._root=this._armature.getBone(this._constraintData.root.name),this._bone=null!==this._constraintData.bone?this._armature.getBone(this._constraintData.bone.name):null;var i=this._constraintData;this._scaleEnabled=i.scaleEnabled,this._bendPositive=i.bendPositive,this._weight=i.weight,this._root._hasConstraint=!0}},i.prototype.update=function(){this._root.updateByConstraint(),null!==this._bone?(this._bone.updateByConstraint(),this._computeB()):this._computeA()},i.prototype.invalidUpdate=function(){this._root.invalidUpdate(),null!==this._bone&&this._bone.invalidUpdate()},i}(e);t.IKConstraint=i;var n=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t._bones=[],t._spaces=[],t._positions=[],t._curves=[],t._boneLengths=[],t._pathGlobalVertices=[],t._segments=[10],t}return Ant(i,e),i.toString=function(){return"[class dragonBones.PathConstraint]"},i.prototype._onClear=function(){e.prototype._onClear.call(this),this.dirty=!1,this.pathOffset=0,this.position=0,this.spacing=0,this.rotateOffset=0,this.rotateMix=1,this.translateMix=1,this._pathSlot=null,this._bones.length=0,this._spaces.length=0,this._positions.length=0,this._curves.length=0,this._boneLengths.length=0,this._pathGlobalVertices.length=0},i.prototype._updatePathVertices=function(t){var e=this._armature,i=e.armatureData.parent,n=e.armatureData.scale,s=i.intArray,r=i.floatArray,o=t.offset,a=s[o+0],l=s[o+2];this._pathGlobalVertices.length=2*a;var c=t.weight;if(null!==c)for(var h=this._pathSlot._deformVertices.bones,_=c.bones.length,u=c.offset,m=s[u+1],d=u+2+_,p=(b=0,0);b<a;b++){for(var f=0,g=0,y=0,v=s[d++];y<v;y++){var x=h[s[d++]];if(null!==x){x.updateByConstraint(),C=x.globalTransformMatrix;var S=r[m++];w=r[m++]*n,E=r[m++]*n,f+=(C.a*w+C.c*E+C.tx)*S,g+=(C.b*w+C.d*E+C.ty)*S}}this._pathGlobalVertices[p++]=f,this._pathGlobalVertices[p++]=g}else{var A=this._pathSlot.parent;A.updateByConstraint();for(var C=A.globalTransformMatrix,b=0,T=l;b<a;b+=2){var w=r[T++]*n,E=r[T++]*n,P=C.a*w+C.c*E+C.tx,I=C.b*w+C.d*E+C.ty;this._pathGlobalVertices[b]=P,this._pathGlobalVertices[b+1]=I}}},i.prototype._computeVertices=function(t,e,i,n){for(var s=i,r=t;s<e;s+=2)n[s]=this._pathGlobalVertices[r++],n[s+1]=this._pathGlobalVertices[r++]},i.prototype._computeBezierCurve=function(t,e,i,n,s){var r=this._armature.armatureData.parent.intArray[t.vertices.offset+0],o=this._positions,a=this._spaces,l=t.closed,c=Array(),h=2*r,_=h/6,u=-1,m=this.position;o.length=3*e+2;var d=0;if(t.constantSpeed){l?(h+=2,c.length=r,this._computeVertices(2,h-4,0,c),this._computeVertices(0,2,h-4,c),c[h-2]=c[0],c[h-1]=c[1]):(_--,h-=4,c.length=h,this._computeVertices(2,h,0,c));var p=new Array(_);d=0;for(var f,g,y,v,x,S,A,C,b=c[0],T=c[1],w=0,E=0,P=0,I=0,D=0,R=0,M=(H=0,2);H<_;H++,M+=6)w=c[M],E=c[M+1],P=c[M+2],I=c[M+3],x=2*(f=.1875*(b-2*w+P))+(y=.09375*(3*(w-P)-b+(D=c[M+4]))),S=2*(g=.1875*(T-2*E+I))+(v=.09375*(3*(E-I)-T+(R=c[M+5]))),A=.75*(w-b)+f+.16666667*y,C=.75*(E-T)+g+.16666667*v,d+=Math.sqrt(A*A+C*C),A+=x,C+=S,x+=y,S+=v,d+=Math.sqrt(A*A+C*C),A+=x,C+=S,d+=Math.sqrt(A*A+C*C),A+=x+y,C+=S+v,d+=Math.sqrt(A*A+C*C),p[H]=d,b=D,T=R;if(n&&(m*=d),s)for(H=0;H<e;H++)a[H]*=d;for(var B=this._segments,O=0,N=(H=0,k=0,j=0,0);H<e;H++,k+=3){var L=m+=a[H];if(l)(L%=d)<0&&(L+=d),j=0;else{if(L<0)continue;if(L>d)continue}for(;;j++){var F=p[j];if(!(L>F)){0===j?L/=F:L=(L-(U=p[j-1]))/(F-U);break}}if(j!==u){u=j;var z=6*j;for(b=c[z],T=c[z+1],w=c[z+2],E=c[z+3],P=c[z+4],I=c[z+5],x=2*(f=.03*(b-2*w+P))+(y=.006*(3*(w-P)-b+(D=c[z+6]))),S=2*(g=.03*(T-2*E+I))+(v=.006*(3*(E-I)-T+(R=c[z+7]))),A=.3*(w-b)+f+.16666667*y,C=.3*(E-T)+g+.16666667*v,O=Math.sqrt(A*A+C*C),B[0]=O,z=1;z<8;z++)A+=x,C+=S,x+=y,S+=v,O+=Math.sqrt(A*A+C*C),B[z]=O;A+=x,C+=S,O+=Math.sqrt(A*A+C*C),B[8]=O,A+=x+y,C+=S+v,O+=Math.sqrt(A*A+C*C),B[9]=O,N=0}for(L*=O;;N++){var V=B[N];if(!(L>V)){var U;0===N?L/=V:L=N+(L-(U=B[N-1]))/(V-U);break}}this.addCurvePosition(.1*L,b,T,w,E,P,I,D,R,o,k,i)}}else{var G=t.curveLengths;if(d=G[_-=l?1:2],n&&(m*=d),s)for(var H=0;H<e;H++)a[H]*=d;c.length=8;H=0;for(var k=0,j=0;H<e;H++,k+=3){if(m+=a[H],l)(m%=d)<0&&(m+=d),j=0;else{if(m<0)continue;if(m>d)continue}for(var W=0;;j++){var q=G[j];if(!(m>q)){if(0===j)W=m/q;else{var X=G[j-1];W=(m-X)/(q-X)}break}}j!==u&&(u=j,l&&j===_?(this._computeVertices(h-4,4,0,c),this._computeVertices(0,4,4,c)):this._computeVertices(6*j+2,8,0,c)),this.addCurvePosition(W,c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7],o,k,i)}}},i.prototype.addCurvePosition=function(t,e,i,n,s,r,o,a,l,c,h,_){if(0===t)return c[h]=e,c[h+1]=i,void(c[h+2]=0);if(1===t)return c[h]=a,c[h+1]=l,void(c[h+2]=0);var u=1-t,m=u*u,d=t*t,p=m*u,f=m*t*3,g=u*d*3,y=t*d,v=p*e+f*n+g*r+y*a,x=p*i+f*s+g*o+y*l;c[h]=v,c[h+1]=x,c[h+2]=_?Math.atan2(x-(p*i+f*s+g*o),v-(p*e+f*n+g*r)):0},i.prototype.init=function(t,e){this._constraintData=t,this._armature=e;var i=t;this.pathOffset=i.pathDisplayData.vertices.offset,this.position=i.position,this.spacing=i.spacing,this.rotateOffset=i.rotateOffset,this.rotateMix=i.rotateMix,this.translateMix=i.translateMix,this._root=this._armature.getBone(i.root.name),this._target=this._armature.getBone(i.target.name),this._pathSlot=this._armature.getSlot(i.pathSlot.name);for(var n=0,s=i.bones.length;n<s;n++){var r=this._armature.getBone(i.bones[n].name);null!==r&&this._bones.push(r)}2===i.rotateMode&&(this._boneLengths.length=this._bones.length),this._root._hasConstraint=!0},i.prototype.update=function(){var e=this._pathSlot;if(null!==e._deformVertices&&null!==e._deformVertices.verticesData&&e._deformVertices.verticesData.offset===this.pathOffset){var i=this._constraintData,n=e._displayData,s=!1,r=e._deformVertices;if(this._root._childrenTransformDirty?(this._updatePathVertices(n.vertices),s=!0):null!==r&&(r.verticesDirty||r.isBonesUpdate())&&(this._updatePathVertices(n.vertices),r.verticesDirty=!1,s=!0),s||this.dirty){var o=i.positionMode,a=i.spacingMode,l=i.rotateMode,c=this._bones,h=0===a,_=2===l,u=0===l,m=c.length,d=u?m:m+1,p=this.spacing,f=this._spaces;if(f.length=d,_||h){f[0]=0;for(var g=0,y=d-1;g<y;g++){(R=c[g]).updateByConstraint();var v=R._boneData.length,x=v*(M=R.globalTransformMatrix).a,S=v*M.b,A=Math.sqrt(x*x+S*S);_&&(this._boneLengths[g]=A),f[g+1]=(v+p)*A/v}}else for(g=0;g<d;g++)f[g]=p;this._computeBezierCurve(n,d,u,1===o,2===a);var C,b=this._positions,T=this.rotateOffset,w=b[0],E=b[1];0===T?C=1===l:(C=!1,null!==(R=e.parent)&&(T*=(M=R.globalTransformMatrix).a*M.d-M.b*M.c>0?t.Transform.DEG_RAD:-t.Transform.DEG_RAD));for(var P=this.rotateMix,I=this.translateMix,D=(g=0,3);g<m;g++,D+=3){var R,M;(R=c[g]).updateByConstraint(),(M=R.globalTransformMatrix).tx+=(w-M.tx)*I,M.ty+=(E-M.ty)*I;var B=(x=b[D])-w,O=(S=b[D+1])-E;if(_){var N=this._boneLengths[g],L=(Math.sqrt(B*B+O*O)/N-1)*P+1;M.a*=L,M.b*=L}if(w=x,E=S,P>0){var F=M.a,z=M.b,V=M.c,U=M.d,G=void 0,H=void 0,k=void 0;if(G=u?b[D-1]:Math.atan2(O,B),G-=Math.atan2(z,F),C){H=Math.cos(G),k=Math.sin(G);var j=R._boneData.length;w+=(j*(H*F-k*z)-B)*P,E+=(j*(k*F+H*z)-O)*P}else G+=T;G>t.Transform.PI?G-=t.Transform.PI_D:G<-t.Transform.PI&&(G+=t.Transform.PI_D),G*=P,H=Math.cos(G),k=Math.sin(G),M.a=H*F-k*z,M.b=k*F+H*z,M.c=H*V-k*U,M.d=k*V+H*U}R.global.fromMatrix(M)}this.dirty=!1}}},i.prototype.invalidUpdate=function(){},i}(e);t.PathConstraint=n}(Cnt||(Cnt={})),function(t){var e=function(){function t(t){void 0===t&&(t=0),this.time=0,this.timeScale=1,this._systemTime=0,this._animatebles=[],this._clock=null,this.time=t,this._systemTime=.001*(new Date).getTime()}return t.prototype.advanceTime=function(t){t!=t&&(t=0);var e=.001*Date.now();if(t<0&&(t=e-this._systemTime),this._systemTime=e,1!==this.timeScale&&(t*=this.timeScale),0!==t){t<0?this.time-=t:this.time+=t;for(var i=0,n=0,s=this._animatebles.length;i<s;++i){var r=this._animatebles[i];null!==r?(n>0&&(this._animatebles[i-n]=r,this._animatebles[i]=null),r.advanceTime(t)):n++}if(n>0){for(s=this._animatebles.length;i<s;++i){var o=this._animatebles[i];null!==o?this._animatebles[i-n]=o:n++}this._animatebles.length-=n}}},t.prototype.contains=function(t){if(t===this)return!1;for(var e=t;e!==this&&null!==e;)e=e.clock;return e===this},t.prototype.add=function(t){this._animatebles.indexOf(t)<0&&(this._animatebles.push(t),t.clock=this)},t.prototype.remove=function(t){var e=this._animatebles.indexOf(t);e>=0&&(this._animatebles[e]=null,t.clock=null)},t.prototype.clear=function(){for(var t=0,e=this._animatebles;t<e.length;t++){var i=e[t];null!==i&&(i.clock=null)}},Object.defineProperty(t.prototype,"clock",{get:function(){return this._clock},set:function(t){this._clock!==t&&(null!==this._clock&&this._clock.remove(this),this._clock=t,null!==this._clock&&this._clock.add(this))},enumerable:!0,configurable:!0}),t.clock=new t,t}();t.WorldClock=e}(Cnt||(Cnt={})),function(t){var e=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t._animationNames=[],t._animationStates=[],t._animations={},t._animationConfig=null,t}return Ant(i,e),i.toString=function(){return"[class dragonBones.Animation]"},i.prototype._onClear=function(){for(var t=0,e=this._animationStates;t<e.length;t++)e[t].returnToPool();for(var i in this._animations)delete this._animations[i];null!==this._animationConfig&&this._animationConfig.returnToPool(),this.timeScale=1,this._lockUpdate=!1,this._animationDirty=!1,this._inheritTimeScale=1,this._animationNames.length=0,this._animationStates.length=0,this._armature=null,this._animationConfig=null,this._lastAnimationState=null},i.prototype._fadeOut=function(t){switch(t.fadeOutMode){case 1:for(var e=0,i=this._animationStates;e<i.length;e++)null===(c=i[e])._parent&&c.layer===t.layer&&c.fadeOut(t.fadeOutTime,t.pauseFadeOut);break;case 2:for(var n=0,s=this._animationStates;n<s.length;n++)null===(c=s[n])._parent&&c.group===t.group&&c.fadeOut(t.fadeOutTime,t.pauseFadeOut);break;case 3:for(var r=0,o=this._animationStates;r<o.length;r++)null===(c=o[r])._parent&&c.layer===t.layer&&c.group===t.group&&c.fadeOut(t.fadeOutTime,t.pauseFadeOut);break;case 4:for(var a=0,l=this._animationStates;a<l.length;a++){var c;null===(c=l[a])._parent&&c.fadeOut(t.fadeOutTime,t.pauseFadeOut)}}},i.prototype.init=function(e){null===this._armature&&(this._armature=e,this._animationConfig=t.BaseObject.borrowObject(t.AnimationConfig))},i.prototype.advanceTime=function(t){t<0&&(t=-t),this._armature.inheritAnimation&&null!==this._armature._parent?this._inheritTimeScale=this._armature._parent._armature.animation._inheritTimeScale*this.timeScale:this._inheritTimeScale=this.timeScale,1!==this._inheritTimeScale&&(t*=this._inheritTimeScale);var e=this._animationStates.length;if(1===e)if((d=this._animationStates[0])._fadeState>0&&d._subFadeState>0)this._armature._dragonBones.bufferObject(d),this._animationStates.length=0,this._lastAnimationState=null;else{var i=d._animationData,n=i.cacheFrameRate;if(this._animationDirty&&n>0){this._animationDirty=!1;for(var s=0,r=this._armature.getBones();s<r.length;s++){var o=r[s];o._cachedFrameIndices=i.getBoneCachedFrameIndices(o.name)}for(var a=0,l=this._armature.getSlots();a<l.length;a++){var c=l[a],h=c.rawDisplayDatas;if(null!==h&&h.length>0){var _=h[0];if(null!==_&&_.parent===this._armature.armatureData.defaultSkin){c._cachedFrameIndices=i.getSlotCachedFrameIndices(c.name);continue}}c._cachedFrameIndices=null}}d.advanceTime(t,n)}else if(e>1){for(var u=0,m=0;u<e;++u){var d;(d=this._animationStates[u])._fadeState>0&&d._subFadeState>0?(m++,this._armature._dragonBones.bufferObject(d),this._animationDirty=!0,this._lastAnimationState===d&&(this._lastAnimationState=null)):(m>0&&(this._animationStates[u-m]=d),d.advanceTime(t,0)),u===e-1&&m>0&&(this._animationStates.length-=m,null===this._lastAnimationState&&this._animationStates.length>0&&(this._lastAnimationState=this._animationStates[this._animationStates.length-1]))}this._armature._cacheFrameIndex=-1}else this._armature._cacheFrameIndex=-1},i.prototype.reset=function(){for(var t=0,e=this._animationStates;t<e.length;t++)e[t].returnToPool();this._animationDirty=!1,this._animationConfig.clear(),this._animationStates.length=0,this._lastAnimationState=null},i.prototype.stop=function(t){if(void 0===t&&(t=null),null!==t)null!==(n=this.getState(t))&&n.stop();else for(var e=0,i=this._animationStates;e<i.length;e++){var n;(n=i[e]).stop()}},i.prototype.playConfig=function(e){var i=e.animation;if(!(i in this._animations))return console.warn("Non-existent animation.\n","DragonBones name: "+this._armature.armatureData.parent.name,"Armature name: "+this._armature.name,"Animation name: "+i),null;var n=this._animations[i];if(5===e.fadeOutMode)for(var s=0,r=this._animationStates;s<r.length;s++){var o=r[s];if(o._animationData===n)return o}0===this._animationStates.length?e.fadeInTime=0:e.fadeInTime<0&&(e.fadeInTime=n.fadeInTime),e.fadeOutTime<0&&(e.fadeOutTime=e.fadeInTime),e.timeScale<=-100&&(e.timeScale=1/n.scale),n.frameCount>1?(e.position<0?(e.position%=n.duration,e.position=n.duration-e.position):e.position===n.duration?e.position-=1e-6:e.position>n.duration&&(e.position%=n.duration),e.duration>0&&e.position+e.duration>n.duration&&(e.duration=n.duration-e.position),e.playTimes<0&&(e.playTimes=n.playTimes)):(e.playTimes=1,e.position=0,e.duration>0&&(e.duration=0)),0===e.duration&&(e.duration=-1),this._fadeOut(e);var a=t.BaseObject.borrowObject(t.AnimationState);if(a.init(this._armature,n,e),this._animationDirty=!0,this._armature._cacheFrameIndex=-1,this._animationStates.length>0){for(var l=!1,c=0,h=this._animationStates.length;c<h;++c){if(a.layer>this._animationStates[c].layer){l=!0,this._animationStates.splice(c,0,a);break}if(c!==h-1&&a.layer>this._animationStates[c+1].layer){l=!0,this._animationStates.splice(c+1,0,a);break}}l||this._animationStates.push(a)}else this._animationStates.push(a);for(var _=0,u=this._armature.getSlots();_<u.length;_++){var m=u[_].childArmature;null!==m&&m.inheritAnimation&&m.animation.hasAnimation(i)&&null===m.animation.getState(i)&&m.animation.fadeIn(i)}var d=!1;for(var p in n.animationTimelines){this._lockUpdate||(d=!0,this._lockUpdate=!0);var f=this.fadeIn(p,e.fadeInTime,1,a.layer,null,0);null!==f&&(f.resetToPose=!1,f._parent=a,f.stop())}return d&&(this._lockUpdate=!1),this._lockUpdate||(e.fadeInTime<=0&&this._armature.advanceTime(0),this._lastAnimationState=a),a},i.prototype.play=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=e,this._animationConfig.fadeInTime=0,this._animationConfig.animation=null!==t?t:"",null!==t&&t.length>0)this.playConfig(this._animationConfig);else if(null===this._lastAnimationState){var i=this._armature.armatureData.defaultAnimation;null!==i&&(this._animationConfig.animation=i.name,this.playConfig(this._animationConfig))}else this._lastAnimationState.isPlaying||this._lastAnimationState.isCompleted?(this._animationConfig.animation=this._lastAnimationState.name,this.playConfig(this._animationConfig)):this._lastAnimationState.play();return this._lastAnimationState},i.prototype.fadeIn=function(t,e,i,n,s,r){return void 0===e&&(e=-1),void 0===i&&(i=-1),void 0===n&&(n=0),void 0===s&&(s=null),void 0===r&&(r=3),this._animationConfig.clear(),this._animationConfig.fadeOutMode=r,this._animationConfig.playTimes=i,this._animationConfig.layer=n,this._animationConfig.fadeInTime=e,this._animationConfig.animation=t,this._animationConfig.group=null!==s?s:"",this.playConfig(this._animationConfig)},i.prototype.gotoAndPlayByTime=function(t,e,i){return void 0===e&&(e=0),void 0===i&&(i=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=i,this._animationConfig.position=e,this._animationConfig.fadeInTime=0,this._animationConfig.animation=t,this.playConfig(this._animationConfig)},i.prototype.gotoAndPlayByFrame=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=i,this._animationConfig.fadeInTime=0,this._animationConfig.animation=t;var n=t in this._animations?this._animations[t]:null;return null!==n&&(this._animationConfig.position=n.duration*e/n.frameCount),this.playConfig(this._animationConfig)},i.prototype.gotoAndPlayByProgress=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=i,this._animationConfig.fadeInTime=0,this._animationConfig.animation=t;var n=t in this._animations?this._animations[t]:null;return null!==n&&(this._animationConfig.position=n.duration*(e>0?e:0)),this.playConfig(this._animationConfig)},i.prototype.gotoAndStopByTime=function(t,e){void 0===e&&(e=0);var i=this.gotoAndPlayByTime(t,e,1);return null!==i&&i.stop(),i},i.prototype.gotoAndStopByFrame=function(t,e){void 0===e&&(e=0);var i=this.gotoAndPlayByFrame(t,e,1);return null!==i&&i.stop(),i},i.prototype.gotoAndStopByProgress=function(t,e){void 0===e&&(e=0);var i=this.gotoAndPlayByProgress(t,e,1);return null!==i&&i.stop(),i},i.prototype.getState=function(t){for(var e=this._animationStates.length;e--;){var i=this._animationStates[e];if(i.name===t)return i}return null},i.prototype.hasAnimation=function(t){return t in this._animations},i.prototype.getStates=function(){return this._animationStates},Object.defineProperty(i.prototype,"isPlaying",{get:function(){for(var t=0,e=this._animationStates;t<e.length;t++)if(e[t].isPlaying)return!0;return!1},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isCompleted",{get:function(){for(var t=0,e=this._animationStates;t<e.length;t++)if(!e[t].isCompleted)return!1;return this._animationStates.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lastAnimationName",{get:function(){return null!==this._lastAnimationState?this._lastAnimationState.name:""},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animationNames",{get:function(){return this._animationNames},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animations",{get:function(){return this._animations},set:function(t){if(this._animations!==t){for(var e in this._animationNames.length=0,this._animations)delete this._animations[e];for(var e in t)this._animationNames.push(e),this._animations[e]=t[e]}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animationConfig",{get:function(){return this._animationConfig.clear(),this._animationConfig},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lastAnimationState",{get:function(){return this._lastAnimationState},enumerable:!0,configurable:!0}),i.prototype.gotoAndPlay=function(t,e,i,n,s,r,o){void 0===e&&(e=-1),void 0===i&&(i=-1),void 0===n&&(n=-1),void 0===s&&(s=0),void 0===r&&(r=null),void 0===o&&(o=3),console.warn("Deprecated."),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.fadeOutMode=o,this._animationConfig.playTimes=n,this._animationConfig.layer=s,this._animationConfig.fadeInTime=e,this._animationConfig.animation=t,this._animationConfig.group=null!==r?r:"";var a=this._animations[t];return a&&i>0&&(this._animationConfig.timeScale=a.duration/i),this.playConfig(this._animationConfig)},i.prototype.gotoAndStop=function(t,e){return void 0===e&&(e=0),console.warn("Deprecated."),this.gotoAndStopByTime(t,e)},Object.defineProperty(i.prototype,"animationList",{get:function(){return console.warn("Deprecated."),this._animationNames},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animationDataList",{get:function(){console.warn("Deprecated.");for(var t=[],e=0,i=this._animationNames.length;e<i;++e)t.push(this._animations[this._animationNames[e]]);return t},enumerable:!0,configurable:!0}),i}(t.BaseObject);t.Animation=e}(Cnt||(Cnt={})),function(t){var e=function(e){function s(){var t=null!==e&&e.apply(this,arguments)||this;return t._blendState=new n,t._boneMask=[],t._boneTimelines=[],t._surfaceTimelines=[],t._slotTimelines=[],t._constraintTimelines=[],t._animationTimelines=[],t._poseTimelines=[],t._bonePoses={},t._actionTimeline=null,t._zOrderTimeline=null,t._parent=null,t}return Ant(s,e),s.toString=function(){return"[class dragonBones.AnimationState]"},s.prototype._onClear=function(){for(var t=0,e=this._boneTimelines;t<e.length;t++)e[t].returnToPool();for(var i=0,n=this._surfaceTimelines;i<n.length;i++)n[i].returnToPool();for(var s=0,r=this._slotTimelines;s<r.length;s++)r[s].returnToPool();for(var o=0,a=this._constraintTimelines;o<a.length;o++)a[o].returnToPool();for(var l=0,c=this._animationTimelines;l<c.length;l++)c[l].returnToPool();for(var h in this._bonePoses)this._bonePoses[h].returnToPool(),delete this._bonePoses[h];null!==this._actionTimeline&&this._actionTimeline.returnToPool(),null!==this._zOrderTimeline&&this._zOrderTimeline.returnToPool(),this.actionEnabled=!1,this.additiveBlending=!1,this.displayControl=!1,this.resetToPose=!1,this.playTimes=1,this.layer=0,this.timeScale=1,this.weight=1,this.autoFadeOutTime=0,this.fadeTotalTime=0,this.name="",this.group="",this._timelineDirty=2,this._playheadState=0,this._fadeState=-1,this._subFadeState=-1,this._position=0,this._duration=0,this._fadeTime=0,this._time=0,this._fadeProgress=0,this._weightResult=0,this._blendState.clear(),this._boneMask.length=0,this._boneTimelines.length=0,this._surfaceTimelines.length=0,this._slotTimelines.length=0,this._constraintTimelines.length=0,this._animationTimelines.length=0,this._poseTimelines.length=0,this._animationData=null,this._armature=null,this._actionTimeline=null,this._zOrderTimeline=null,this._parent=null},s.prototype._updateTimelines=function(){for(var e=0,i=this._armature._constraints;e<i.length;e++){var n=i[e];if(null!==(l=this._animationData.getConstraintTimelines(n.name)))for(var s=0,r=l;s<r.length;s++)switch((u=r[s]).type){case 30:(m=t.BaseObject.borrowObject(t.IKConstraintTimelineState)).constraint=n,m.init(this._armature,this,u),this._constraintTimelines.push(m)}else this.resetToPose&&((m=t.BaseObject.borrowObject(t.IKConstraintTimelineState)).constraint=n,m.init(this._armature,this,null),this._constraintTimelines.push(m),this._poseTimelines.push(m))}for(var o=0,a=this._armature.animation.getStates();o<a.length;o++){var l,c=a[o];if(c._parent===this&&null!==(l=this._animationData.getAnimationTimelines(c.name)))for(var h=0,_=l;h<_.length;h++){var u;switch((u=_[h]).type){case 40:var m;(m=t.BaseObject.borrowObject(t.AnimationTimelineState)).animationState=c,m.init(this._armature,this,u),this._animationTimelines.push(m)}}}},s.prototype._updateBoneAndSlotTimelines=function(){for(var e={},n=0,s=this._boneTimelines;n<s.length;n++)(l=(y=s[n]).bone.name)in e||(e[l]=[]),e[l].push(y);for(var r=0,o=this._armature.getBones();r<o.length;r++){var a=o[r],l=a.name;if(this.containsBoneMask(l))if(l in e)delete e[l];else if(0===a._boneData.type){var c=this._animationData.getBoneTimelines(l),h=l in this._bonePoses?this._bonePoses[l]:this._bonePoses[l]=t.BaseObject.borrowObject(i);if(null!==c)for(var _=0,u=c;_<u.length;_++)switch((R=u[_]).type){case 10:(y=t.BaseObject.borrowObject(t.BoneAllTimelineState)).bone=a,y.bonePose=h,y.init(this._armature,this,R),this._boneTimelines.push(y);break;case 11:(y=t.BaseObject.borrowObject(t.BoneTranslateTimelineState)).bone=a,y.bonePose=h,y.init(this._armature,this,R),this._boneTimelines.push(y);break;case 12:(y=t.BaseObject.borrowObject(t.BoneRotateTimelineState)).bone=a,y.bonePose=h,y.init(this._armature,this,R),this._boneTimelines.push(y);break;case 13:(y=t.BaseObject.borrowObject(t.BoneScaleTimelineState)).bone=a,y.bonePose=h,y.init(this._armature,this,R),this._boneTimelines.push(y)}else this.resetToPose&&((y=t.BaseObject.borrowObject(t.BoneAllTimelineState)).bone=a,y.bonePose=h,y.init(this._armature,this,null),this._boneTimelines.push(y),this._poseTimelines.push(y))}else if(1===a._boneData.type)if(null!==(c=this._animationData.getSurfaceTimelines(l)))for(var m=0,d=c;m<d.length;m++)switch((R=d[m]).type){case 50:(y=t.BaseObject.borrowObject(t.SurfaceTimelineState)).surface=a,y.init(this._armature,this,R),this._surfaceTimelines.push(y)}else this.resetToPose&&((y=t.BaseObject.borrowObject(t.SurfaceTimelineState)).surface=a,y.init(this._armature,this,null),this._surfaceTimelines.push(y),this._poseTimelines.push(y))}for(var p in e)for(var f=0,g=e[p];f<g.length;f++){var y=g[f];this._boneTimelines.splice(this._boneTimelines.indexOf(y),1),y.returnToPool()}for(var v={},x=[],S=0,A=this._slotTimelines;S<A.length;S++)(l=(y=A[S]).slot.name)in v||(v[l]=[]),v[l].push(y);for(var C=0,b=this._armature.getSlots();C<b.length;C++){var T=b[C],w=T.parent.name;if(this.containsBoneMask(w))if(l=T.name,c=this._animationData.getSlotTimelines(l),l in v)delete v[l];else{var E=!1,P=!1;if(x.length=0,null!==c)for(var I=0,D=c;I<D.length;I++){var R;switch((R=D[I]).type){case 20:(y=t.BaseObject.borrowObject(t.SlotDislayTimelineState)).slot=T,y.init(this._armature,this,R),this._slotTimelines.push(y),E=!0;break;case 21:(y=t.BaseObject.borrowObject(t.SlotColorTimelineState)).slot=T,y.init(this._armature,this,R),this._slotTimelines.push(y),P=!0;break;case 22:(y=t.BaseObject.borrowObject(t.DeformTimelineState)).slot=T,y.init(this._armature,this,R),this._slotTimelines.push(y),x.push(y.vertexOffset)}}if(this.resetToPose&&(E||((y=t.BaseObject.borrowObject(t.SlotDislayTimelineState)).slot=T,y.init(this._armature,this,null),this._slotTimelines.push(y),this._poseTimelines.push(y)),P||((y=t.BaseObject.borrowObject(t.SlotColorTimelineState)).slot=T,y.init(this._armature,this,null),this._slotTimelines.push(y),this._poseTimelines.push(y)),null!==T.rawDisplayDatas))for(var M=0,B=T.rawDisplayDatas;M<B.length;M++){var O=B[M];if(null!==O&&2===O.type){var N=O.vertices.offset;x.indexOf(N)<0&&((y=t.BaseObject.borrowObject(t.DeformTimelineState)).vertexOffset=N,y.slot=T,y.init(this._armature,this,null),this._slotTimelines.push(y),this._poseTimelines.push(y))}}}}for(var p in v)for(var L=0,F=v[p];L<F.length;L++)y=F[L],this._slotTimelines.splice(this._slotTimelines.indexOf(y),1),y.returnToPool()},s.prototype._advanceFadeTime=function(e){var i,n=this._fadeState>0;if(this._subFadeState<0){this._subFadeState=0;var s=n?t.EventObject.FADE_OUT:t.EventObject.FADE_IN;this._armature.eventDispatcher.hasDBEventListener(s)&&((i=t.BaseObject.borrowObject(t.EventObject)).type=s,i.armature=this._armature,i.animationState=this,this._armature._dragonBones.bufferEvent(i))}(e<0&&(e=-e),this._fadeTime+=e,this._fadeTime>=this.fadeTotalTime?(this._subFadeState=1,this._fadeProgress=n?0:1):this._fadeTime>0?this._fadeProgress=n?1-this._fadeTime/this.fadeTotalTime:this._fadeTime/this.fadeTotalTime:this._fadeProgress=n?1:0,this._subFadeState>0)&&(n||(this._playheadState|=1,this._fadeState=0),s=n?t.EventObject.FADE_OUT_COMPLETE:t.EventObject.FADE_IN_COMPLETE,this._armature.eventDispatcher.hasDBEventListener(s)&&((i=t.BaseObject.borrowObject(t.EventObject)).type=s,i.armature=this._armature,i.animationState=this,this._armature._dragonBones.bufferEvent(i)))},s.prototype.init=function(e,i,n){if(null===this._armature){if(this._armature=e,this._animationData=i,this.resetToPose=n.resetToPose,this.additiveBlending=n.additiveBlending,this.displayControl=n.displayControl,this.actionEnabled=n.actionEnabled,this.layer=n.layer,this.playTimes=n.playTimes,this.timeScale=n.timeScale,this.fadeTotalTime=n.fadeInTime,this.autoFadeOutTime=n.autoFadeOutTime,this.weight=n.weight,this.name=n.name.length>0?n.name:n.animation,this.group=n.group,n.pauseFadeIn?this._playheadState=2:this._playheadState=3,n.duration<0?(this._position=0,this._duration=this._animationData.duration,0!==n.position?this.timeScale>=0?this._time=n.position:this._time=n.position-this._duration:this._time=0):(this._position=n.position,this._duration=n.duration,this._time=0),this.timeScale<0&&0===this._time&&(this._time=-1e-6),this.fadeTotalTime<=0&&(this._fadeProgress=.999999),n.boneMask.length>0){this._boneMask.length=n.boneMask.length;for(var s=0,r=this._boneMask.length;s<r;++s)this._boneMask[s]=n.boneMask[s]}this._actionTimeline=t.BaseObject.borrowObject(t.ActionTimelineState),this._actionTimeline.init(this._armature,this,this._animationData.actionTimeline),this._actionTimeline.currentTime=this._time,this._actionTimeline.currentTime<0&&(this._actionTimeline.currentTime=this._duration-this._actionTimeline.currentTime),null!==this._animationData.zOrderTimeline&&(this._zOrderTimeline=t.BaseObject.borrowObject(t.ZOrderTimelineState),this._zOrderTimeline.init(this._armature,this,this._animationData.zOrderTimeline))}},s.prototype.advanceTime=function(e,i){if(this._blendState.dirty=!1,0===this._fadeState&&0===this._subFadeState||this._advanceFadeTime(e),3===this._playheadState&&(1!==this.timeScale&&(e*=this.timeScale),this._time+=e),0!==this._timelineDirty&&(2===this._timelineDirty&&this._updateTimelines(),this._timelineDirty=0,this._updateBoneAndSlotTimelines()),0!==this.weight){var n=0===this._fadeState&&i>0,s=!0,r=!0,o=this._time;if(this._weightResult=this.weight*this._fadeProgress,null!==this._parent&&(this._weightResult*=this._parent._weightResult/this._parent._fadeProgress),this._actionTimeline.playState<=0&&this._actionTimeline.update(o),n){var a=2*i;this._actionTimeline.currentTime=Math.floor(this._actionTimeline.currentTime*a)/a}if(null!==this._zOrderTimeline&&this._zOrderTimeline.playState<=0&&this._zOrderTimeline.update(o),n){var l=Math.floor(this._actionTimeline.currentTime*i);this._armature._cacheFrameIndex===l?(s=!1,r=!1):(this._armature._cacheFrameIndex=l,this._animationData.cachedFrames[l]?r=!1:this._animationData.cachedFrames[l]=!0)}if(s){if(r)for(var c=0,h=this._boneTimelines.length;c<h;++c)(p=this._boneTimelines[c]).playState<=0&&p.update(o),(c===h-1||p.bone!==this._boneTimelines[c+1].bone)&&0!==(_=p.bone._blendState.update(this._weightResult,this.layer))&&p.blend(_);for(c=0,h=this._surfaceTimelines.length;c<h;++c){var _=(p=this._surfaceTimelines[c]).surface._blendState.update(this._weightResult,this.layer);p.playState<=0&&p.update(o),0!==_&&p.blend(_)}if(this.displayControl)for(c=0,h=this._slotTimelines.length;c<h;++c){var u=(p=this._slotTimelines[c]).slot.displayController;null!==u&&u!==this.name&&u!==this.group||p.playState<=0&&p.update(o)}for(c=0,h=this._constraintTimelines.length;c<h;++c)(p=this._constraintTimelines[c]).playState<=0&&p.update(o);for(c=0,h=this._animationTimelines.length;c<h;++c)_=(p=this._animationTimelines[c]).animationState._blendState.update(this._weightResult,this.layer),p.playState<=0&&p.update(o),0!==_&&p.blend(_)}if(0===this._fadeState){if(this._subFadeState>0&&(this._subFadeState=0,this._poseTimelines.length>0)){for(var m=0,d=this._poseTimelines;m<d.length;m++){var p;(p=d[m])instanceof t.BoneTimelineState?this._boneTimelines.splice(this._boneTimelines.indexOf(p),1):p instanceof t.SurfaceTimelineState?this._surfaceTimelines.splice(this._surfaceTimelines.indexOf(p),1):p instanceof t.SlotTimelineState?this._slotTimelines.splice(this._slotTimelines.indexOf(p),1):p instanceof t.ConstraintTimelineState&&this._constraintTimelines.splice(this._constraintTimelines.indexOf(p),1),p.returnToPool()}this._poseTimelines.length=0}this._actionTimeline.playState>0&&this.autoFadeOutTime>=0&&this.fadeOut(this.autoFadeOutTime)}}},s.prototype.play=function(){this._playheadState=3},s.prototype.stop=function(){this._playheadState&=1},s.prototype.fadeOut=function(t,e){if(void 0===e&&(e=!0),t<0&&(t=0),e&&(this._playheadState&=2),this._fadeState>0){if(t>this.fadeTotalTime-this._fadeTime)return}else{this._fadeState=1,this._subFadeState=-1,(t<=0||this._fadeProgress<=0)&&(this._fadeProgress=1e-6);for(var i=0,n=this._boneTimelines;i<n.length;i++)(u=n[i]).fadeOut();for(var s=0,r=this._surfaceTimelines;s<r.length;s++)(u=r[s]).fadeOut();for(var o=0,a=this._slotTimelines;o<a.length;o++)(u=a[o]).fadeOut();for(var l=0,c=this._constraintTimelines;l<c.length;l++)(u=c[l]).fadeOut();for(var h=0,_=this._animationTimelines;h<_.length;h++){var u;(u=_[h]).animationState.fadeOut(t,e),u.fadeOut()}}this.displayControl=!1,this.fadeTotalTime=this._fadeProgress>1e-6?t/this._fadeProgress:0,this._fadeTime=this.fadeTotalTime*(1-this._fadeProgress)},s.prototype.containsBoneMask=function(t){return 0===this._boneMask.length||this._boneMask.indexOf(t)>=0},s.prototype.addBoneMask=function(t,e){void 0===e&&(e=!0);var i=this._armature.getBone(t);if(null!==i){if(this._boneMask.indexOf(t)<0&&this._boneMask.push(t),e)for(var n=0,s=this._armature.getBones();n<s.length;n++){var r=s[n];this._boneMask.indexOf(r.name)<0&&i.contains(r)&&this._boneMask.push(r.name)}this._timelineDirty=1}},s.prototype.removeBoneMask=function(t,e){void 0===e&&(e=!0);var i=this._boneMask.indexOf(t);if(i>=0&&this._boneMask.splice(i,1),e){var n=this._armature.getBone(t);if(null!==n){var s=this._armature.getBones();if(this._boneMask.length>0)for(var r=0,o=s;r<o.length;r++){var a=o[r],l=this._boneMask.indexOf(a.name);l>=0&&n.contains(a)&&this._boneMask.splice(l,1)}else for(var c=0,h=s;c<h.length;c++)(a=h[c])!==n&&(n.contains(a)||this._boneMask.push(a.name))}}this._timelineDirty=1},s.prototype.removeAllBoneMask=function(){this._boneMask.length=0,this._timelineDirty=1},Object.defineProperty(s.prototype,"isFadeIn",{get:function(){return this._fadeState<0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isFadeOut",{get:function(){return this._fadeState>0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isFadeComplete",{get:function(){return 0===this._fadeState},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isPlaying",{get:function(){return 0!=(2&this._playheadState)&&this._actionTimeline.playState<=0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isCompleted",{get:function(){return this._actionTimeline.playState>0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"currentPlayTimes",{get:function(){return this._actionTimeline.currentPlayTimes},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"totalTime",{get:function(){return this._duration},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"currentTime",{get:function(){return this._actionTimeline.currentTime},set:function(t){var e=this._actionTimeline.currentPlayTimes-(this._actionTimeline.playState>0?1:0);if((t<0||this._duration<t)&&(t=t%this._duration+e*this._duration)<0&&(t+=this._duration),this.playTimes>0&&e===this.playTimes-1&&t===this._duration&&(t=this._duration-1e-6),this._time!==t){this._time=t,this._actionTimeline.setCurrentTime(this._time),null!==this._zOrderTimeline&&(this._zOrderTimeline.playState=-1);for(var i=0,n=this._boneTimelines;i<n.length;i++)n[i].playState=-1;for(var s=0,r=this._slotTimelines;s<r.length;s++)r[s].playState=-1}},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"animationData",{get:function(){return this._animationData},enumerable:!0,configurable:!0}),s}(t.BaseObject);t.AnimationState=e;var i=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.current=new t.Transform,i.delta=new t.Transform,i.result=new t.Transform,i}return Ant(i,e),i.toString=function(){return"[class dragonBones.BonePose]"},i.prototype._onClear=function(){this.current.identity(),this.delta.identity(),this.result.identity()},i}(t.BaseObject);t.BonePose=i;var n=function(){function t(){}return t.prototype.update=function(t,e){if(this.dirty){if(!(this.leftWeight>0))return 0;if(this.layer!==e){if(this.layerWeight>=this.leftWeight)return this.leftWeight=0,0;this.layer=e,this.leftWeight-=this.layerWeight,this.layerWeight=0}return t*=this.leftWeight,this.layerWeight+=t,this.blendWeight=t,2}return this.dirty=!0,this.layer=e,this.layerWeight=t,this.leftWeight=1,this.blendWeight=t,1},t.prototype.clear=function(){this.dirty=!1,this.layer=0,this.leftWeight=0,this.layerWeight=0,this.blendWeight=0},t}();t.BlendState=n}(Cnt||(Cnt={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.prototype._onClear=function(){this.playState=-1,this.currentPlayTimes=-1,this.currentTime=-1,this._tweenState=0,this._frameRate=0,this._frameValueOffset=0,this._frameCount=0,this._frameOffset=0,this._frameIndex=-1,this._frameRateR=0,this._position=0,this._duration=0,this._timeScale=1,this._timeOffset=0,this._dragonBonesData=null,this._animationData=null,this._timelineData=null,this._armature=null,this._animationState=null,this._actionTimeline=null,this._frameArray=null,this._frameIntArray=null,this._frameFloatArray=null,this._timelineArray=null,this._frameIndices=null},e.prototype._setCurrentTime=function(t){var e=this.playState,i=this.currentPlayTimes,n=this.currentTime;if(null!==this._actionTimeline&&this._frameCount<=1)this.playState=this._actionTimeline.playState>=0?1:-1,this.currentPlayTimes=1,this.currentTime=this._actionTimeline.currentTime;else if(null===this._actionTimeline||1!==this._timeScale||0!==this._timeOffset){var s=this._animationState.playTimes,r=s*this._duration;t*=this._timeScale,0!==this._timeOffset&&(t+=this._timeOffset*this._animationData.duration),s>0&&(t>=r||t<=-r)?(this.playState<=0&&3===this._animationState._playheadState&&(this.playState=1),this.currentPlayTimes=s,this.currentTime=t<0?0:this._duration+1e-6):(0!==this.playState&&3===this._animationState._playheadState&&(this.playState=0),t<0?(t=-t,this.currentPlayTimes=Math.floor(t/this._duration),this.currentTime=this._duration-t%this._duration):(this.currentPlayTimes=Math.floor(t/this._duration),this.currentTime=t%this._duration)),this.currentTime+=this._position}else this.playState=this._actionTimeline.playState,this.currentPlayTimes=this._actionTimeline.currentPlayTimes,this.currentTime=this._actionTimeline.currentTime;return(this.currentPlayTimes!==i||this.currentTime!==n)&&((e<0&&this.playState!==e||this.playState<=0&&this.currentPlayTimes!==i)&&(this._frameIndex=-1),!0)},e.prototype.init=function(t,e,i){this._armature=t,this._animationState=e,this._timelineData=i,this._actionTimeline=this._animationState._actionTimeline,this===this._actionTimeline&&(this._actionTimeline=null),this._animationData=this._animationState._animationData,this._frameRate=this._animationData.parent.frameRate,this._frameRateR=1/this._frameRate,this._position=this._animationState._position,this._duration=this._animationState._duration,this._dragonBonesData=this._animationData.parent.parent,null!==this._timelineData&&(this._frameIntArray=this._dragonBonesData.frameIntArray,this._frameFloatArray=this._dragonBonesData.frameFloatArray,this._frameArray=this._dragonBonesData.frameArray,this._timelineArray=this._dragonBonesData.timelineArray,this._frameIndices=this._dragonBonesData.frameIndices,this._frameCount=this._timelineArray[this._timelineData.offset+2],this._frameValueOffset=this._timelineArray[this._timelineData.offset+4],this._timeScale=100/this._timelineArray[this._timelineData.offset+0],this._timeOffset=.01*this._timelineArray[this._timelineData.offset+1])},e.prototype.fadeOut=function(){},e.prototype.update=function(t){if(this._setCurrentTime(t)){if(this._frameCount>1){var e=Math.floor(this.currentTime*this._frameRate),i=this._frameIndices[this._timelineData.frameIndicesOffset+e];this._frameIndex!==i&&(this._frameIndex=i,this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+this._frameIndex],this._onArriveAtFrame())}else this._frameIndex<0&&(this._frameIndex=0,null!==this._timelineData&&(this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5]),this._onArriveAtFrame());0!==this._tweenState&&this._onUpdateFrame()}},e}(t.BaseObject);t.TimelineState=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e._getEasingValue=function(t,e,i){var n=e;switch(t){case 3:n=Math.pow(e,2);break;case 4:n=1-Math.pow(1-e,2);break;case 5:n=.5*(1-Math.cos(e*Math.PI))}return(n-e)*i+e},e._getEasingCurveValue=function(t,e,i,n){if(t<=0)return 0;if(t>=1)return 1;var s=i+1,r=Math.floor(t*s),o=0===r?0:e[n+r-1];return 1e-4*(o+((r===s-1?1e4:e[n+r])-o)*(t*s-r))},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._tweenType=0,this._curveCount=0,this._framePosition=0,this._frameDurationR=0,this._tweenProgress=0,this._tweenEasing=0},e.prototype._onArriveAtFrame=function(){if(this._frameCount>1&&(this._frameIndex!==this._frameCount-1||0===this._animationState.playTimes||this._animationState.currentPlayTimes<this._animationState.playTimes-1))if(this._tweenType=this._frameArray[this._frameOffset+1],this._tweenState=0===this._tweenType?1:2,2===this._tweenType?this._curveCount=this._frameArray[this._frameOffset+2]:0!==this._tweenType&&1!==this._tweenType&&(this._tweenEasing=.01*this._frameArray[this._frameOffset+2]),this._framePosition=this._frameArray[this._frameOffset]*this._frameRateR,this._frameIndex===this._frameCount-1)this._frameDurationR=1/(this._animationData.duration-this._framePosition);else{var t=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+this._frameIndex+1],e=this._frameArray[t]*this._frameRateR-this._framePosition;this._frameDurationR=e>0?1/e:0}else this._tweenState=1},e.prototype._onUpdateFrame=function(){2===this._tweenState?(this._tweenProgress=(this.currentTime-this._framePosition)*this._frameDurationR,2===this._tweenType?this._tweenProgress=e._getEasingCurveValue(this._tweenProgress,this._frameArray,this._curveCount,this._frameOffset+3):1!==this._tweenType&&(this._tweenProgress=e._getEasingValue(this._tweenType,this._tweenProgress,this._tweenEasing))):this._tweenProgress=0},e}(e);t.TweenTimelineState=i;var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.prototype._onClear=function(){t.prototype._onClear.call(this),this.bone=null,this.bonePose=null},e.prototype.blend=function(t){var e=this.bone._blendState.blendWeight,i=this.bone.animationPose,n=this.bonePose.result;2===t?(i.x+=n.x*e,i.y+=n.y*e,i.rotation+=n.rotation*e,i.skew+=n.skew*e,i.scaleX+=(n.scaleX-1)*e,i.scaleY+=(n.scaleY-1)*e):1!==e?(i.x=n.x*e,i.y=n.y*e,i.rotation=n.rotation*e,i.skew=n.skew*e,i.scaleX=(n.scaleX-1)*e+1,i.scaleY=(n.scaleY-1)*e+1):(i.x=n.x,i.y=n.y,i.rotation=n.rotation,i.skew=n.skew,i.scaleX=n.scaleX,i.scaleY=n.scaleY),0===this._animationState._fadeState&&0===this._animationState._subFadeState||(this.bone._transformDirty=!0)},e}(i);t.BoneTimelineState=n;var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.prototype._onClear=function(){t.prototype._onClear.call(this),this.slot=null},e}(i);t.SlotTimelineState=s;var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.prototype._onClear=function(){t.prototype._onClear.call(this),this.constraint=null},e}(i);t.ConstraintTimelineState=r}(Cnt||(Cnt={})),function(t){var e=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return Ant(i,e),i.toString=function(){return"[class dragonBones.ActionTimelineState]"},i.prototype._onCrossFrame=function(e){var i=this._armature.eventDispatcher;if(this._animationState.actionEnabled)for(var n=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+e],s=this._frameArray[n+1],r=this._animationData.parent.actions,o=0;o<s;++o){var a=r[this._frameArray[n+2+o]];if(0===a.type)(l=t.BaseObject.borrowObject(t.EventObject)).time=this._frameArray[n]/this._frameRate,l.animationState=this._animationState,t.EventObject.actionDataToInstance(a,l,this._armature),this._armature._bufferAction(l,!0);else{var l,c=10===a.type?t.EventObject.FRAME_EVENT:t.EventObject.SOUND_EVENT;(11===a.type||i.hasDBEventListener(c))&&((l=t.BaseObject.borrowObject(t.EventObject)).time=this._frameArray[n]/this._frameRate,l.animationState=this._animationState,t.EventObject.actionDataToInstance(a,l,this._armature),this._armature._dragonBones.bufferEvent(l))}}},i.prototype._onArriveAtFrame=function(){},i.prototype._onUpdateFrame=function(){},i.prototype.update=function(e){var i=this.playState,n=this.currentPlayTimes,s=this.currentTime;if(this._setCurrentTime(e)){var r=this._armature.eventDispatcher;if(i<0){if(this.playState===i)return;if(this._animationState.displayControl&&this._animationState.resetToPose&&this._armature._sortZOrder(null,0),n=this.currentPlayTimes,r.hasDBEventListener(t.EventObject.START)){var o=t.BaseObject.borrowObject(t.EventObject);o.type=t.EventObject.START,o.armature=this._armature,o.animationState=this._animationState,this._armature._dragonBones.bufferEvent(o)}}var a=this._animationState.timeScale<0,l=null,c=null;if(this.currentPlayTimes!==n&&(r.hasDBEventListener(t.EventObject.LOOP_COMPLETE)&&((l=t.BaseObject.borrowObject(t.EventObject)).type=t.EventObject.LOOP_COMPLETE,l.armature=this._armature,l.animationState=this._animationState),this.playState>0&&r.hasDBEventListener(t.EventObject.COMPLETE)&&((c=t.BaseObject.borrowObject(t.EventObject)).type=t.EventObject.COMPLETE,c.armature=this._armature,c.animationState=this._animationState)),this._frameCount>1){var h=this._timelineData,_=Math.floor(this.currentTime*this._frameRate),u=this._frameIndices[h.frameIndicesOffset+_];if(this._frameIndex!==u){var m=this._frameIndex;if(this._frameIndex=u,null!==this._timelineArray)if(this._frameOffset=this._animationData.frameOffset+this._timelineArray[h.offset+5+this._frameIndex],a){if(m<0){var d=Math.floor(s*this._frameRate);m=this._frameIndices[h.frameIndicesOffset+d],this.currentPlayTimes===n&&m===u&&(m=-1)}for(;m>=0;){var p=this._animationData.frameOffset+this._timelineArray[h.offset+5+m],f=this._frameArray[p]/this._frameRate;if(this._position<=f&&f<=this._position+this._duration&&this._onCrossFrame(m),null!==l&&0===m&&(this._armature._dragonBones.bufferEvent(l),l=null),m>0?m--:m=this._frameCount-1,m===u)break}}else for(m<0&&(d=Math.floor(s*this._frameRate),m=this._frameIndices[h.frameIndicesOffset+d],p=this._animationData.frameOffset+this._timelineArray[h.offset+5+m],f=this._frameArray[p]/this._frameRate,this.currentPlayTimes===n&&(s<=f?m>0?m--:m=this._frameCount-1:m===u&&(m=-1)));m>=0&&(m<this._frameCount-1?m++:m=0,p=this._animationData.frameOffset+this._timelineArray[h.offset+5+m],f=this._frameArray[p]/this._frameRate,this._position<=f&&f<=this._position+this._duration&&this._onCrossFrame(m),null!==l&&0===m&&(this._armature._dragonBones.bufferEvent(l),l=null),m!==u););}}else this._frameIndex<0&&(this._frameIndex=0,null!==this._timelineData)&&(this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5],f=this._frameArray[this._frameOffset]/this._frameRate,this.currentPlayTimes===n?s<=f&&this._onCrossFrame(this._frameIndex):this._position<=f&&(a||null===l||(this._armature._dragonBones.bufferEvent(l),l=null),this._onCrossFrame(this._frameIndex)));null!==l&&this._armature._dragonBones.bufferEvent(l),null!==c&&this._armature._dragonBones.bufferEvent(c)}},i.prototype.setCurrentTime=function(t){this._setCurrentTime(t),this._frameIndex=-1},i}(t.TimelineState);t.ActionTimelineState=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.toString=function(){return"[class dragonBones.ZOrderTimelineState]"},e.prototype._onArriveAtFrame=function(){this.playState>=0&&(this._frameArray[this._frameOffset+1]>0?this._armature._sortZOrder(this._frameArray,this._frameOffset+2):this._armature._sortZOrder(null,0))},e.prototype._onUpdateFrame=function(){},e}(t.TimelineState);t.ZOrderTimelineState=i;var n=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return Ant(i,e),i.toString=function(){return"[class dragonBones.BoneAllTimelineState]"},i.prototype._onArriveAtFrame=function(){if(e.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var t=this._animationData.frameFloatOffset+this._frameValueOffset+6*this._frameIndex,i=this._armature._armatureData.scale,n=this._frameFloatArray,s=this.bonePose.current,r=this.bonePose.delta;s.x=n[t++]*i,s.y=n[t++]*i,s.rotation=n[t++],s.skew=n[t++],s.scaleX=n[t++],s.scaleY=n[t++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(t=this._animationData.frameFloatOffset+this._frameValueOffset),r.x=n[t++]*i-s.x,r.y=n[t++]*i-s.y,r.rotation=n[t++]-s.rotation,r.skew=n[t++]-s.skew,r.scaleX=n[t++]-s.scaleX,r.scaleY=n[t++]-s.scaleY):(r.x=0,r.y=0,r.rotation=0,r.skew=0,r.scaleX=0,r.scaleY=0)}else s=this.bonePose.current,r=this.bonePose.delta,s.x=0,s.y=0,s.rotation=0,s.skew=0,s.scaleX=1,s.scaleY=1,r.x=0,r.y=0,r.rotation=0,r.skew=0,r.scaleX=0,r.scaleY=0},i.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this);var t=this.bonePose.current,i=this.bonePose.delta,n=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),n.x=t.x+i.x*this._tweenProgress,n.y=t.y+i.y*this._tweenProgress,n.rotation=t.rotation+i.rotation*this._tweenProgress,n.skew=t.skew+i.skew*this._tweenProgress,n.scaleX=t.scaleX+i.scaleX*this._tweenProgress,n.scaleY=t.scaleY+i.scaleY*this._tweenProgress},i.prototype.fadeOut=function(){var e=this.bonePose.result;e.rotation=t.Transform.normalizeRadian(e.rotation),e.skew=t.Transform.normalizeRadian(e.skew)},i}(t.BoneTimelineState);t.BoneAllTimelineState=n;var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.toString=function(){return"[class dragonBones.BoneTranslateTimelineState]"},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,i=this._armature._armatureData.scale,n=this._frameFloatArray,s=this.bonePose.current,r=this.bonePose.delta;s.x=n[e++]*i,s.y=n[e++]*i,2===this._tweenState?(this._frameIndex===this._frameCount-1&&(e=this._animationData.frameFloatOffset+this._frameValueOffset),r.x=n[e++]*i-s.x,r.y=n[e++]*i-s.y):(r.x=0,r.y=0)}else s=this.bonePose.current,r=this.bonePose.delta,s.x=0,s.y=0,r.x=0,r.y=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this);var e=this.bonePose.current,i=this.bonePose.delta,n=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),n.x=e.x+i.x*this._tweenProgress,n.y=e.y+i.y*this._tweenProgress},e}(t.BoneTimelineState);t.BoneTranslateTimelineState=s;var r=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return Ant(i,e),i.toString=function(){return"[class dragonBones.BoneRotateTimelineState]"},i.prototype._onArriveAtFrame=function(){if(e.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var i=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,n=this._frameFloatArray,s=this.bonePose.current,r=this.bonePose.delta;s.rotation=n[i++],s.skew=n[i++],2===this._tweenState?(this._frameIndex===this._frameCount-1?(i=this._animationData.frameFloatOffset+this._frameValueOffset,r.rotation=t.Transform.normalizeRadian(n[i++]-s.rotation)):r.rotation=n[i++]-s.rotation,r.skew=n[i++]-s.skew):(r.rotation=0,r.skew=0)}else s=this.bonePose.current,r=this.bonePose.delta,s.rotation=0,s.skew=0,r.rotation=0,r.skew=0},i.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this);var t=this.bonePose.current,i=this.bonePose.delta,n=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),n.rotation=t.rotation+i.rotation*this._tweenProgress,n.skew=t.skew+i.skew*this._tweenProgress},i.prototype.fadeOut=function(){var e=this.bonePose.result;e.rotation=t.Transform.normalizeRadian(e.rotation),e.skew=t.Transform.normalizeRadian(e.skew)},i}(t.BoneTimelineState);t.BoneRotateTimelineState=r;var o=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.toString=function(){return"[class dragonBones.BoneScaleTimelineState]"},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,i=this._frameFloatArray,n=this.bonePose.current,s=this.bonePose.delta;n.scaleX=i[e++],n.scaleY=i[e++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(e=this._animationData.frameFloatOffset+this._frameValueOffset),s.scaleX=i[e++]-n.scaleX,s.scaleY=i[e++]-n.scaleY):(s.scaleX=0,s.scaleY=0)}else n=this.bonePose.current,s=this.bonePose.delta,n.scaleX=1,n.scaleY=1,s.scaleX=0,s.scaleY=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this);var e=this.bonePose.current,i=this.bonePose.delta,n=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),n.scaleX=e.scaleX+i.scaleX*this._tweenProgress,n.scaleY=e.scaleY+i.scaleY*this._tweenProgress},e}(t.BoneTimelineState);t.BoneScaleTimelineState=o;var a=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._current=[],e._delta=[],e._result=[],e}return Ant(e,t),e.toString=function(){return"[class dragonBones.SurfaceTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.surface=null,this._frameFloatOffset=0,this._valueCount=0,this._deformCount=0,this._valueOffset=0,this._current.length=0,this._delta.length=0,this._result.length=0},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+this._frameIndex*this._valueCount,i=this._armature._armatureData.scale,n=this._frameFloatArray;if(2===this._tweenState){var s=e+this._valueCount;this._frameIndex===this._frameCount-1&&(s=this._animationData.frameFloatOffset+this._frameValueOffset);for(var r=0;r<this._valueCount;++r)this._delta[r]=n[s+r]*i-(this._current[r]=n[e+r]*i)}else for(r=0;r<this._valueCount;++r)this._current[r]=n[e+r]*i}else for(r=0;r<this._valueCount;++r)this._current[r]=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),this.surface._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0);for(var e=0;e<this._valueCount;++e)this._result[e]=this._current[e]+this._delta[e]*this._tweenProgress},e.prototype.init=function(e,i,n){if(t.prototype.init.call(this,e,i,n),null!==this._timelineData){var s=this._animationData.frameIntOffset+this._timelineArray[this._timelineData.offset+3];this._deformCount=this._frameIntArray[s+1],this._valueCount=this._frameIntArray[s+2],this._valueOffset=this._frameIntArray[s+3],this._frameFloatOffset=this._frameIntArray[s+4]+this._animationData.frameFloatOffset}else this._deformCount=this.surface._deformVertices.length,this._valueCount=this._deformCount,this._valueOffset=0,this._frameFloatOffset=0;this._current.length=this._valueCount,this._delta.length=this._valueCount,this._result.length=this._valueCount;for(var r=0;r<this._valueCount;++r)this._delta[r]=0},e.prototype.blend=function(t){for(var e=this.surface._blendState.blendWeight,i=this.surface._deformVertices,n=0;n<this._deformCount;++n){var s;s=n<this._valueOffset?this._frameFloatArray[this._frameFloatOffset+n]:n<this._valueOffset+this._valueCount?this._result[n-this._valueOffset]:this._frameFloatArray[this._frameFloatOffset+n-this._valueCount],2===t?i[n]+=s*e:i[n]=1!==e?s*e:s}0===this._animationState._fadeState&&0===this._animationState._subFadeState||(this.surface._transformDirty=!0)},e}(t.TweenTimelineState);t.SurfaceTimelineState=a;var l=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.toString=function(){return"[class dragonBones.SlotDislayTimelineState]"},e.prototype._onArriveAtFrame=function(){if(this.playState>=0){var t=null!==this._timelineData?this._frameArray[this._frameOffset+1]:this.slot._slotData.displayIndex;this.slot.displayIndex!==t&&this.slot._setDisplayIndex(t,!0)}},e}(t.SlotTimelineState);t.SlotDislayTimelineState=l;var c=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._current=[0,0,0,0,0,0,0,0],e._delta=[0,0,0,0,0,0,0,0],e._result=[0,0,0,0,0,0,0,0],e}return Ant(e,t),e.toString=function(){return"[class dragonBones.SlotColorTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._dirty=!1},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._dragonBonesData.intArray,i=this._frameIntArray,n=this._animationData.frameIntOffset+this._frameValueOffset+1*this._frameIndex,s=i[n];s<0&&(s+=65536),this._current[0]=e[s++],this._current[1]=e[s++],this._current[2]=e[s++],this._current[3]=e[s++],this._current[4]=e[s++],this._current[5]=e[s++],this._current[6]=e[s++],this._current[7]=e[s++],2===this._tweenState&&((s=this._frameIndex===this._frameCount-1?i[this._animationData.frameIntOffset+this._frameValueOffset]:i[n+1])<0&&(s+=65536),this._delta[0]=e[s++]-this._current[0],this._delta[1]=e[s++]-this._current[1],this._delta[2]=e[s++]-this._current[2],this._delta[3]=e[s++]-this._current[3],this._delta[4]=e[s++]-this._current[4],this._delta[5]=e[s++]-this._current[5],this._delta[6]=e[s++]-this._current[6],this._delta[7]=e[s++]-this._current[7])}else{var r=this.slot._slotData.color;this._current[0]=100*r.alphaMultiplier,this._current[1]=100*r.redMultiplier,this._current[2]=100*r.greenMultiplier,this._current[3]=100*r.blueMultiplier,this._current[4]=r.alphaOffset,this._current[5]=r.redOffset,this._current[6]=r.greenOffset,this._current[7]=r.blueOffset}},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),this._dirty=!0,2!==this._tweenState&&(this._tweenState=0),this._result[0]=.01*(this._current[0]+this._delta[0]*this._tweenProgress),this._result[1]=.01*(this._current[1]+this._delta[1]*this._tweenProgress),this._result[2]=.01*(this._current[2]+this._delta[2]*this._tweenProgress),this._result[3]=.01*(this._current[3]+this._delta[3]*this._tweenProgress),this._result[4]=this._current[4]+this._delta[4]*this._tweenProgress,this._result[5]=this._current[5]+this._delta[5]*this._tweenProgress,this._result[6]=this._current[6]+this._delta[6]*this._tweenProgress,this._result[7]=this._current[7]+this._delta[7]*this._tweenProgress},e.prototype.fadeOut=function(){this._tweenState=0,this._dirty=!1},e.prototype.update=function(e){if(t.prototype.update.call(this,e),0!==this._tweenState||this._dirty){var i=this.slot._colorTransform;if(0!==this._animationState._fadeState||0!==this._animationState._subFadeState){if(i.alphaMultiplier!==this._result[0]||i.redMultiplier!==this._result[1]||i.greenMultiplier!==this._result[2]||i.blueMultiplier!==this._result[3]||i.alphaOffset!==this._result[4]||i.redOffset!==this._result[5]||i.greenOffset!==this._result[6]||i.blueOffset!==this._result[7]){var n=Math.pow(this._animationState._fadeProgress,4);i.alphaMultiplier+=(this._result[0]-i.alphaMultiplier)*n,i.redMultiplier+=(this._result[1]-i.redMultiplier)*n,i.greenMultiplier+=(this._result[2]-i.greenMultiplier)*n,i.blueMultiplier+=(this._result[3]-i.blueMultiplier)*n,i.alphaOffset+=(this._result[4]-i.alphaOffset)*n,i.redOffset+=(this._result[5]-i.redOffset)*n,i.greenOffset+=(this._result[6]-i.greenOffset)*n,i.blueOffset+=(this._result[7]-i.blueOffset)*n,this.slot._colorDirty=!0}}else this._dirty&&(this._dirty=!1,i.alphaMultiplier===this._result[0]&&i.redMultiplier===this._result[1]&&i.greenMultiplier===this._result[2]&&i.blueMultiplier===this._result[3]&&i.alphaOffset===this._result[4]&&i.redOffset===this._result[5]&&i.greenOffset===this._result[6]&&i.blueOffset===this._result[7]||(i.alphaMultiplier=this._result[0],i.redMultiplier=this._result[1],i.greenMultiplier=this._result[2],i.blueMultiplier=this._result[3],i.alphaOffset=this._result[4],i.redOffset=this._result[5],i.greenOffset=this._result[6],i.blueOffset=this._result[7],this.slot._colorDirty=!0))}},e}(t.SlotTimelineState);t.SlotColorTimelineState=c;var h=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._current=[],e._delta=[],e._result=[],e}return Ant(e,t),e.toString=function(){return"[class dragonBones.DeformTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.vertexOffset=0,this._dirty=!1,this._frameFloatOffset=0,this._valueCount=0,this._deformCount=0,this._valueOffset=0,this._current.length=0,this._delta.length=0,this._result.length=0},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+this._frameIndex*this._valueCount,i=this._armature._armatureData.scale,n=this._frameFloatArray;if(2===this._tweenState){var s=e+this._valueCount;this._frameIndex===this._frameCount-1&&(s=this._animationData.frameFloatOffset+this._frameValueOffset);for(var r=0;r<this._valueCount;++r)this._delta[r]=n[s+r]*i-(this._current[r]=n[e+r]*i)}else for(r=0;r<this._valueCount;++r)this._current[r]=n[e+r]*i}else for(r=0;r<this._valueCount;++r)this._current[r]=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),this._dirty=!0,2!==this._tweenState&&(this._tweenState=0);for(var e=0;e<this._valueCount;++e)this._result[e]=this._current[e]+this._delta[e]*this._tweenProgress},e.prototype.init=function(e,i,n){if(t.prototype.init.call(this,e,i,n),null!==this._timelineData){var s=this._animationData.frameIntOffset+this._timelineArray[this._timelineData.offset+3];this.vertexOffset=this._frameIntArray[s+0],this.vertexOffset<0&&(this.vertexOffset+=65536),this._deformCount=this._frameIntArray[s+1],this._valueCount=this._frameIntArray[s+2],this._valueOffset=this._frameIntArray[s+3],this._frameFloatOffset=this._frameIntArray[s+4]+this._animationData.frameFloatOffset}else{var r=this.slot._deformVertices;this._deformCount=null!==r?r.vertices.length:0,this._valueCount=this._deformCount,this._valueOffset=0,this._frameFloatOffset=0}this._current.length=this._valueCount,this._delta.length=this._valueCount,this._result.length=this._valueCount;for(var o=0;o<this._valueCount;++o)this._delta[o]=0},e.prototype.fadeOut=function(){this._tweenState=0,this._dirty=!1},e.prototype.update=function(e){var i=this.slot._deformVertices;if(null!==i&&null!==i.verticesData&&i.verticesData.offset===this.vertexOffset&&(t.prototype.update.call(this,e),0!==this._tweenState||this._dirty)){var n=i.vertices;if(0!==this._animationState._fadeState||0!==this._animationState._subFadeState){for(var s=Math.pow(this._animationState._fadeProgress,2),r=0;r<this._deformCount;++r)r<this._valueOffset?n[r]+=(this._frameFloatArray[this._frameFloatOffset+r]-n[r])*s:r<this._valueOffset+this._valueCount?n[r]+=(this._result[r-this._valueOffset]-n[r])*s:n[r]+=(this._frameFloatArray[this._frameFloatOffset+r-this._valueCount]-n[r])*s;i.verticesDirty=!0}else if(this._dirty){for(this._dirty=!1,r=0;r<this._deformCount;++r)r<this._valueOffset?n[r]=this._frameFloatArray[this._frameFloatOffset+r]:r<this._valueOffset+this._valueCount?n[r]=this._result[r-this._valueOffset]:n[r]=this._frameFloatArray[this._frameFloatOffset+r-this._valueCount];i.verticesDirty=!0}}},e}(t.SlotTimelineState);t.DeformTimelineState=h;var _=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.toString=function(){return"[class dragonBones.IKConstraintTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._current=0,this._delta=0},e.prototype._onArriveAtFrame=function(){t.prototype._onArriveAtFrame.call(this);var e=this.constraint;if(null!==this._timelineData){var i=this._animationData.frameIntOffset+this._frameValueOffset+2*this._frameIndex,n=this._frameIntArray,s=0!==n[i++];this._current=.01*n[i++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(i=this._animationData.frameIntOffset+this._frameValueOffset),this._delta=.01*n[i+1]-this._current):this._delta=0,e._bendPositive=s}else{var r=e._constraintData;this._current=r.weight,this._delta=0,e._bendPositive=r.bendPositive}e.invalidUpdate()},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),2!==this._tweenState&&(this._tweenState=0);var e=this.constraint;e._weight=this._current+this._delta*this._tweenProgress,e.invalidUpdate()},e}(t.ConstraintTimelineState);t.IKConstraintTimelineState=_;var u=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._floats=[0,0,0,0,0,0],e}return Ant(e,t),e.toString=function(){return"[class dragonBones.AnimationTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.animationState=null},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameIntOffset+this._frameValueOffset+2*this._frameIndex,i=1/this.animationState._animationData.parent.frameRate,n=this._frameIntArray;this._floats[0]=n[e++]*i,this._floats[3]=.01*n[e++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(e=this._animationData.frameIntOffset+this._frameValueOffset),this._floats[1]=n[e++]*i-this._floats[0],this._floats[4]=.01*n[e++]-this._floats[3]):(this._floats[1]=0,this._floats[4]=0)}},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),2!==this._tweenState&&(this._tweenState=0),this._floats[0]>=0&&(this._floats[2]=this._floats[0]+this._floats[1]*this._tweenProgress),this._floats[5]=this._floats[3]+this._floats[4]*this._tweenProgress},e.prototype.blend=function(t){var e=this.animationState,i=e._blendState.blendWeight;2===t?(e.weight+=this._floats[5]*i,e.currentTime+=this._floats[2]*i):(e.weight=this._floats[5]*i,e.currentTime=this._floats[2]*i)},e}(t.TweenTimelineState);t.AnimationTimelineState=u}(Cnt||(Cnt={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Ant(e,t),e.actionDataToInstance=function(t,i,n){0===t.type?i.type=e.FRAME_EVENT:i.type=10===t.type?e.FRAME_EVENT:e.SOUND_EVENT,i.name=t.name,i.armature=n,i.actionData=t,i.data=t.data,null!==t.bone&&(i.bone=n.getBone(t.bone.name)),null!==t.slot&&(i.slot=n.getSlot(t.slot.name))},e.toString=function(){return"[class dragonBones.EventObject]"},e.prototype._onClear=function(){this.time=0,this.type="",this.name="",this.armature=null,this.bone=null,this.slot=null,this.animationState=null,this.actionData=null,this.data=null},e.START="start",e.LOOP_COMPLETE="loopComplete",e.COMPLETE="complete",e.FADE_IN="fadeIn",e.FADE_IN_COMPLETE="fadeInComplete",e.FADE_OUT="fadeOut",e.FADE_OUT_COMPLETE="fadeOutComplete",e.FRAME_EVENT="frameEvent",e.SOUND_EVENT="soundEvent",e}(t.BaseObject);t.EventObject=e}(Cnt||(Cnt={})),function(t){var e=function(){function e(){}return e._getArmatureType=function(t){switch(t.toLowerCase()){case"stage":return 2;case"armature":return 0;case"movieclip":return 1;default:return 0}},e._getBoneType=function(t){switch(t.toLowerCase()){case"bone":return 0;case"surface":return 1;default:return 0}},e._getDisplayType=function(t){switch(t.toLowerCase()){case"image":return 0;case"mesh":return 2;case"armature":return 1;case"boundingbox":return 3;case"path":return 4;default:return 0}},e._getBoundingBoxType=function(t){switch(t.toLowerCase()){case"rectangle":return 0;case"ellipse":return 1;case"polygon":return 2;default:return 0}},e._getActionType=function(t){switch(t.toLowerCase()){case"play":return 0;case"frame":return 10;case"sound":return 11;default:return 0}},e._getBlendMode=function(t){switch(t.toLowerCase()){case"normal":return 0;case"add":return 1;case"alpha":return 2;case"darken":return 3;case"difference":return 4;case"erase":return 5;case"hardlight":return 6;case"invert":return 7;case"layer":return 8;case"lighten":return 9;case"multiply":return 10;case"overlay":return 11;case"screen":return 12;case"subtract":return 13;default:return 0}},e._getPositionMode=function(t){switch(t.toLocaleLowerCase()){case"percent":return 1;case"fixed":return 0;default:return 1}},e._getSpacingMode=function(t){switch(t.toLocaleLowerCase()){case"length":return 0;case"percent":return 2;case"fixed":return 1;default:return 0}},e._getRotateMode=function(t){switch(t.toLocaleLowerCase()){case"tangent":return 0;case"chain":return 1;case"chainscale":return 2;default:return 0}},e.parseDragonBonesData=function(e){return console.warn("Deprecated."),e instanceof ArrayBuffer?t.BinaryDataParser.getInstance().parseDragonBonesData(e):t.ObjectDataParser.getInstance().parseDragonBonesData(e)},e.parseTextureAtlasData=function(i,n){void 0===n&&(n=1),console.warn("已废弃");for(var s={},r=i[e.SUB_TEXTURE],o=0,a=r.length;o<a;o++){var l=r[o],c=l[e.NAME],h=new t.Rectangle,_=null;h.x=l[e.X]/n,h.y=l[e.Y]/n,h.width=l[e.WIDTH]/n,h.height=l[e.HEIGHT]/n,e.FRAME_WIDTH in l&&((_=new t.Rectangle).x=l[e.FRAME_X]/n,_.y=l[e.FRAME_Y]/n,_.width=l[e.FRAME_WIDTH]/n,_.height=l[e.FRAME_HEIGHT]/n),s[c]={region:h,frame:_,rotated:!1}}return s},e.DATA_VERSION_2_3="2.3",e.DATA_VERSION_3_0="3.0",e.DATA_VERSION_4_0="4.0",e.DATA_VERSION_4_5="4.5",e.DATA_VERSION_5_0="5.0",e.DATA_VERSION_5_5="5.5",e.DATA_VERSION=e.DATA_VERSION_5_5,e.DATA_VERSIONS=[e.DATA_VERSION_4_0,e.DATA_VERSION_4_5,e.DATA_VERSION_5_0,e.DATA_VERSION_5_5],e.TEXTURE_ATLAS="textureAtlas",e.SUB_TEXTURE="SubTexture",e.FORMAT="format",e.IMAGE_PATH="imagePath",e.WIDTH="width",e.HEIGHT="height",e.ROTATED="rotated",e.FRAME_X="frameX",e.FRAME_Y="frameY",e.FRAME_WIDTH="frameWidth",e.FRAME_HEIGHT="frameHeight",e.DRADON_BONES="dragonBones",e.USER_DATA="userData",e.ARMATURE="armature",e.BONE="bone",e.SURFACE="surface",e.SLOT="slot",e.CONSTRAINT="constraint",e.IK="ik",e.PATH_CONSTRAINT="path",e.SKIN="skin",e.DISPLAY="display",e.ANIMATION="animation",e.Z_ORDER="zOrder",e.FFD="ffd",e.FRAME="frame",e.TRANSLATE_FRAME="translateFrame",e.ROTATE_FRAME="rotateFrame",e.SCALE_FRAME="scaleFrame",e.DISPLAY_FRAME="displayFrame",e.COLOR_FRAME="colorFrame",e.DEFAULT_ACTIONS="defaultActions",e.ACTIONS="actions",e.EVENTS="events",e.INTS="ints",e.FLOATS="floats",e.STRINGS="strings",e.CANVAS="canvas",e.TRANSFORM="transform",e.PIVOT="pivot",e.AABB="aabb",e.COLOR="color",e.VERSION="version",e.COMPATIBLE_VERSION="compatibleVersion",e.FRAME_RATE="frameRate",e.TYPE="type",e.SUB_TYPE="subType",e.NAME="name",e.PARENT="parent",e.TARGET="target",e.STAGE="stage",e.SHARE="share",e.PATH="path",e.LENGTH="length",e.DISPLAY_INDEX="displayIndex",e.BLEND_MODE="blendMode",e.INHERIT_TRANSLATION="inheritTranslation",e.INHERIT_ROTATION="inheritRotation",e.INHERIT_SCALE="inheritScale",e.INHERIT_REFLECTION="inheritReflection",e.INHERIT_ANIMATION="inheritAnimation",e.INHERIT_DEFORM="inheritDeform",e.SEGMENT_X="segmentX",e.SEGMENT_Y="segmentY",e.BEND_POSITIVE="bendPositive",e.CHAIN="chain",e.WEIGHT="weight",e.FADE_IN_TIME="fadeInTime",e.PLAY_TIMES="playTimes",e.SCALE="scale",e.OFFSET="offset",e.POSITION="position",e.DURATION="duration",e.TWEEN_EASING="tweenEasing",e.TWEEN_ROTATE="tweenRotate",e.TWEEN_SCALE="tweenScale",e.CLOCK_WISE="clockwise",e.CURVE="curve",e.SOUND="sound",e.EVENT="event",e.ACTION="action",e.X="x",e.Y="y",e.SKEW_X="skX",e.SKEW_Y="skY",e.SCALE_X="scX",e.SCALE_Y="scY",e.VALUE="value",e.ROTATE="rotate",e.SKEW="skew",e.ALPHA_OFFSET="aO",e.RED_OFFSET="rO",e.GREEN_OFFSET="gO",e.BLUE_OFFSET="bO",e.ALPHA_MULTIPLIER="aM",e.RED_MULTIPLIER="rM",e.GREEN_MULTIPLIER="gM",e.BLUE_MULTIPLIER="bM",e.UVS="uvs",e.VERTICES="vertices",e.TRIANGLES="triangles",e.WEIGHTS="weights",e.SLOT_POSE="slotPose",e.BONE_POSE="bonePose",e.GLUE_WEIGHTS="glueWeights",e.GLUE_MESHES="glueMeshes",e.BONES="bones",e.POSITION_MODE="positionMode",e.SPACING_MODE="spacingMode",e.ROTATE_MODE="rotateMode",e.SPACING="spacing",e.ROTATE_OFFSET="rotateOffset",e.ROTATE_MIX="rotateMix",e.TRANSLATE_MIX="translateMix",e.TARGET_DISPLAY="targetDisplay",e.CLOSED="closed",e.CONSTANT_SPEED="constantSpeed",e.VERTEX_COUNT="vertexCount",e.LENGTHS="lengths",e.GOTO_AND_PLAY="gotoAndPlay",e.DEFAULT_NAME="default",e}();t.DataParser=e}(Cnt||(Cnt={})),function(t){var e=function(e){function n(){var i=null!==e&&e.apply(this,arguments)||this;return i._rawTextureAtlasIndex=0,i._rawBones=[],i._data=null,i._armature=null,i._bone=null,i._surface=null,i._slot=null,i._skin=null,i._mesh=null,i._animation=null,i._timeline=null,i._rawTextureAtlases=null,i._defaultColorOffset=-1,i._prevClockwise=0,i._prevRotation=0,i._helpMatrixA=new t.Matrix,i._helpMatrixB=new t.Matrix,i._helpTransform=new t.Transform,i._helpColorTransform=new t.ColorTransform,i._helpPoint=new t.Point,i._helpArray=[],i._intArray=[],i._floatArray=[],i._frameIntArray=[],i._frameFloatArray=[],i._frameArray=[],i._timelineArray=[],i._cacheRawMeshes=[],i._cacheMeshes=[],i._actionFrames=[],i._weightSlotPose={},i._weightBonePoses={},i._cacheBones={},i._slotChildActions={},i}return Ant(n,e),n._getBoolean=function(t,e,i){if(e in t){var n=t[e],s=typeof n;if("boolean"===s)return n;if("string"!==s)return!!n;switch(n){case"0":case"NaN":case"":case"false":case"null":case"undefined":return!1;default:return!0}}return i},n._getNumber=function(t,e,i){if(e in t){var n=t[e];return null===n||"NaN"===n?i:+n||0}return i},n._getString=function(e,i,n){if(i in e){var s=e[i];if("string"==typeof s){if(t.DragonBones.webAssembly)for(var r=0,o=s.length;r<o;++r)if(s.charCodeAt(r)>255)return encodeURI(s);return s}return String(s)}return n},n.prototype._getCurvePoint=function(t,e,i,n,s,r,o,a,l,c){var h=1-l,_=h*h,u=l*l,m=h*_,d=3*l*_,p=3*h*u,f=l*u;c.x=m*t+d*i+p*s+f*o,c.y=m*e+d*n+p*r+f*a},n.prototype._samplingEasingCurve=function(t,e){for(var i=t.length,n=-2,s=0,r=e.length;s<r;++s){for(var o=(s+1)/(r+1);(n+6<i?t[n+6]:1)<o;)n+=6;for(var a=n>=0&&n+6<i,l=a?t[n]:0,c=a?t[n+1]:0,h=t[n+2],_=t[n+3],u=t[n+4],m=t[n+5],d=a?t[n+6]:1,p=a?t[n+7]:1,f=0,g=1;g-f>1e-4;){var y=.5*(g+f);this._getCurvePoint(l,c,h,_,u,m,d,p,y,this._helpPoint),o-this._helpPoint.x>0?f=y:g=y}e[s]=this._helpPoint.y}},n.prototype._parseActionDataInFrame=function(e,i,n,s){t.DataParser.EVENT in e&&this._mergeActionFrame(e[t.DataParser.EVENT],i,10,n,s),t.DataParser.SOUND in e&&this._mergeActionFrame(e[t.DataParser.SOUND],i,11,n,s),t.DataParser.ACTION in e&&this._mergeActionFrame(e[t.DataParser.ACTION],i,0,n,s),t.DataParser.EVENTS in e&&this._mergeActionFrame(e[t.DataParser.EVENTS],i,10,n,s),t.DataParser.ACTIONS in e&&this._mergeActionFrame(e[t.DataParser.ACTIONS],i,0,n,s)},n.prototype._mergeActionFrame=function(e,n,s,r,o){for(var a=t.DragonBones.webAssembly?this._armature.actions.size():this._armature.actions.length,l=this._parseActionData(e,s,r,o),c=0,h=null,_=0,u=l;_<u.length;_++){var m=u[_];this._armature.addAction(m,!1)}0===this._actionFrames.length&&((h=new i).frameStart=0,this._actionFrames.push(h),h=null);for(var d=0,p=this._actionFrames;d<p.length;d++){var f=p[d];if(f.frameStart===n){h=f;break}if(f.frameStart>n)break;c++}null===h&&((h=new i).frameStart=n,this._actionFrames.splice(c+1,0,h));for(var g=0;g<l.length;++g)h.actions.push(a+g)},n.prototype._parseArmature=function(e,i){var s=t.BaseObject.borrowObject(t.ArmatureData);if(s.name=n._getString(e,t.DataParser.NAME,""),s.frameRate=n._getNumber(e,t.DataParser.FRAME_RATE,this._data.frameRate),s.scale=i,t.DataParser.TYPE in e&&"string"==typeof e[t.DataParser.TYPE]?s.type=t.DataParser._getArmatureType(e[t.DataParser.TYPE]):s.type=n._getNumber(e,t.DataParser.TYPE,0),0===s.frameRate&&(s.frameRate=24),this._armature=s,t.DataParser.CANVAS in e){var r=e[t.DataParser.CANVAS],o=t.BaseObject.borrowObject(t.CanvasData);t.DataParser.COLOR in r?o.hasBackground=!0:o.hasBackground=!1,o.color=n._getNumber(r,t.DataParser.COLOR,0),o.x=n._getNumber(r,t.DataParser.X,0)*s.scale,o.y=n._getNumber(r,t.DataParser.Y,0)*s.scale,o.width=n._getNumber(r,t.DataParser.WIDTH,0)*s.scale,o.height=n._getNumber(r,t.DataParser.HEIGHT,0)*s.scale,s.canvas=o}if(t.DataParser.AABB in e){var a=e[t.DataParser.AABB];s.aabb.x=n._getNumber(a,t.DataParser.X,0)*s.scale,s.aabb.y=n._getNumber(a,t.DataParser.Y,0)*s.scale,s.aabb.width=n._getNumber(a,t.DataParser.WIDTH,0)*s.scale,s.aabb.height=n._getNumber(a,t.DataParser.HEIGHT,0)*s.scale}if(t.DataParser.BONE in e)for(var l=0,c=e[t.DataParser.BONE];l<c.length;l++){var h=c[l],_=n._getString(h,t.DataParser.PARENT,""),u=this._parseBone(h);if(_.length>0){var m=s.getBone(_);null!==m?u.parent=m:(_ in this._cacheBones||(this._cacheBones[_]=[]),this._cacheBones[_].push(u))}if(u.name in this._cacheBones){for(var d=0,p=this._cacheBones[u.name];d<p.length;d++)p[d].parent=u;delete this._cacheBones[u.name]}s.addBone(u),this._rawBones.push(u)}if(t.DataParser.IK in e)for(var f=0,g=e[t.DataParser.IK];f<g.length;f++){var y=g[f];(P=this._parseIKConstraint(y))&&s.addConstraint(P)}if(s.sortBones(),t.DataParser.SLOT in e)for(var v=0,x=0,S=e[t.DataParser.SLOT];x<S.length;x++){var A=S[x];s.addSlot(this._parseSlot(A,v++))}if(t.DataParser.SKIN in e)for(var C=0,b=e[t.DataParser.SKIN];C<b.length;C++){var T=b[C];s.addSkin(this._parseSkin(T))}if(t.DataParser.PATH_CONSTRAINT in e)for(var w=0,E=e[t.DataParser.PATH_CONSTRAINT];w<E.length;w++){var P,I=E[w];(P=this._parsePathConstraint(I))&&s.addConstraint(P)}for(var D=0,R=this._cacheRawMeshes.length;D<R;++D){var M=this._cacheRawMeshes[D];t.DataParser.GLUE_WEIGHTS in M&&t.DataParser.GLUE_MESHES in M&&this._parseMeshGlue(M,this._cacheMeshes[D])}for(D=0,R=this._cacheRawMeshes.length;D<R;++D){var B=this._cacheRawMeshes[D],O=n._getString(B,t.DataParser.SHARE,"");if(0!==O.length){var N=n._getString(B,t.DataParser.SKIN,t.DataParser.DEFAULT_NAME);0===N.length&&(N=t.DataParser.DEFAULT_NAME);var L=s.getMesh(N,"",O);null!==L&&this._cacheMeshes[D].vertices.shareFrom(L.vertices)}}if(t.DataParser.ANIMATION in e)for(var F=0,z=e[t.DataParser.ANIMATION];F<z.length;F++){var V=z[F],U=this._parseAnimation(V);s.addAnimation(U)}if(t.DataParser.DEFAULT_ACTIONS in e)for(var G=0,H=this._parseActionData(e[t.DataParser.DEFAULT_ACTIONS],0,null,null);G<H.length;G++){var k=H[G];s.addAction(k,!0),0===k.type&&null!==(U=s.getAnimation(k.name))&&(s.defaultAnimation=U)}if(t.DataParser.ACTIONS in e)for(var j=0,W=this._parseActionData(e[t.DataParser.ACTIONS],0,null,null);j<W.length;j++)k=W[j],s.addAction(k,!1);for(var q in this._rawBones.length=0,this._cacheRawMeshes.length=0,this._cacheMeshes.length=0,this._armature=null,this._weightSlotPose)delete this._weightSlotPose[q];for(var q in this._weightBonePoses)delete this._weightBonePoses[q];for(var q in this._cacheBones)delete this._cacheBones[q];for(var q in this._slotChildActions)delete this._slotChildActions[q];return s},n.prototype._parseBone=function(e){var i=this._armature.scale;if(0===(t.DataParser.TYPE in e&&"string"==typeof e[t.DataParser.TYPE]?t.DataParser._getBoneType(e[t.DataParser.TYPE]):n._getNumber(e,t.DataParser.TYPE,0))){var s=t.BaseObject.borrowObject(t.BoneData);return s.inheritTranslation=n._getBoolean(e,t.DataParser.INHERIT_TRANSLATION,!0),s.inheritRotation=n._getBoolean(e,t.DataParser.INHERIT_ROTATION,!0),s.inheritScale=n._getBoolean(e,t.DataParser.INHERIT_SCALE,!0),s.inheritReflection=n._getBoolean(e,t.DataParser.INHERIT_REFLECTION,!0),s.length=n._getNumber(e,t.DataParser.LENGTH,0)*i,s.name=n._getString(e,t.DataParser.NAME,""),t.DataParser.TRANSFORM in e&&this._parseTransform(e[t.DataParser.TRANSFORM],s.transform,i),s}var r=t.BaseObject.borrowObject(t.SurfaceData);if(r.name=n._getString(e,t.DataParser.NAME,""),r.segmentX=n._getNumber(e,t.DataParser.SEGMENT_X,0),r.segmentY=n._getNumber(e,t.DataParser.SEGMENT_Y,0),r.vertices.length=(r.segmentX+1)*(r.segmentY+1)*2,t.DataParser.VERTICES in e)for(var o=e[t.DataParser.VERTICES],a=0,l=r.vertices.length;a<l;++a)a<o.length?r.vertices[a]=o[a]*i:r.vertices[a]=0;return r},n.prototype._parseIKConstraint=function(e){var i=this._armature.getBone(n._getString(e,t.DataParser.BONE,""));if(null===i)return null;var s=this._armature.getBone(n._getString(e,t.DataParser.TARGET,""));if(null===s)return null;var r=t.BaseObject.borrowObject(t.IKConstraintData);return r.scaleEnabled=n._getBoolean(e,t.DataParser.SCALE,!1),r.bendPositive=n._getBoolean(e,t.DataParser.BEND_POSITIVE,!0),r.weight=n._getNumber(e,t.DataParser.WEIGHT,1),r.name=n._getString(e,t.DataParser.NAME,""),r.type=0,r.target=s,n._getNumber(e,t.DataParser.CHAIN,0)>0&&null!==i.parent?(r.root=i.parent,r.bone=i):(r.root=i,r.bone=null),r},n.prototype._parsePathConstraint=function(e){var i=this._armature.getSlot(n._getString(e,t.DataParser.TARGET,""));if(null===i)return null;var s=this._armature.defaultSkin;if(null===s)return null;var r=s.getDisplay(i.name,n._getString(e,t.DataParser.TARGET_DISPLAY,i.name));if(null===r||!(r instanceof t.PathDisplayData))return null;var o=e[t.DataParser.BONES];if(null===o||0===o.length)return null;var a=t.BaseObject.borrowObject(t.PathConstraintData);a.name=n._getString(e,t.DataParser.NAME,""),a.type=1,a.pathSlot=i,a.pathDisplayData=r,a.target=i.parent,a.positionMode=t.DataParser._getPositionMode(n._getString(e,t.DataParser.POSITION_MODE,"")),a.spacingMode=t.DataParser._getSpacingMode(n._getString(e,t.DataParser.SPACING_MODE,"")),a.rotateMode=t.DataParser._getRotateMode(n._getString(e,t.DataParser.ROTATE_MODE,"")),a.position=n._getNumber(e,t.DataParser.POSITION,0),a.spacing=n._getNumber(e,t.DataParser.SPACING,0),a.rotateOffset=n._getNumber(e,t.DataParser.ROTATE_OFFSET,0),a.rotateMix=n._getNumber(e,t.DataParser.ROTATE_MIX,1),a.translateMix=n._getNumber(e,t.DataParser.TRANSLATE_MIX,1);for(var l=0,c=o;l<c.length;l++){var h=c[l],_=this._armature.getBone(h);null!==_&&(a.AddBone(_),null===a.root&&(a.root=_))}return a},n.prototype._parseSlot=function(e,i){var s=t.BaseObject.borrowObject(t.SlotData);return s.displayIndex=n._getNumber(e,t.DataParser.DISPLAY_INDEX,0),s.zOrder=i,s.name=n._getString(e,t.DataParser.NAME,""),s.parent=this._armature.getBone(n._getString(e,t.DataParser.PARENT,"")),t.DataParser.BLEND_MODE in e&&"string"==typeof e[t.DataParser.BLEND_MODE]?s.blendMode=t.DataParser._getBlendMode(e[t.DataParser.BLEND_MODE]):s.blendMode=n._getNumber(e,t.DataParser.BLEND_MODE,0),t.DataParser.COLOR in e?(s.color=t.SlotData.createColor(),this._parseColorTransform(e[t.DataParser.COLOR],s.color)):s.color=t.SlotData.DEFAULT_COLOR,t.DataParser.ACTIONS in e&&(this._slotChildActions[s.name]=this._parseActionData(e[t.DataParser.ACTIONS],0,null,null)),s},n.prototype._parseSkin=function(e){var i=t.BaseObject.borrowObject(t.SkinData);if(i.name=n._getString(e,t.DataParser.NAME,t.DataParser.DEFAULT_NAME),0===i.name.length&&(i.name=t.DataParser.DEFAULT_NAME),t.DataParser.SLOT in e){var s=e[t.DataParser.SLOT];this._skin=i;for(var r=0,o=s;r<o.length;r++){var a=o[r],l=n._getString(a,t.DataParser.NAME,""),c=this._armature.getSlot(l);if(null!==c){if(this._slot=c,t.DataParser.DISPLAY in a)for(var h=0,_=a[t.DataParser.DISPLAY];h<_.length;h++){var u=_[h];u?i.addDisplay(l,this._parseDisplay(u)):i.addDisplay(l,null)}this._slot=null}}this._skin=null}return i},n.prototype._parseDisplay=function(e){var i=n._getString(e,t.DataParser.NAME,""),s=n._getString(e,t.DataParser.PATH,""),r=0,o=null;switch(r=t.DataParser.TYPE in e&&"string"==typeof e[t.DataParser.TYPE]?t.DataParser._getDisplayType(e[t.DataParser.TYPE]):n._getNumber(e,t.DataParser.TYPE,r)){case 0:var a=o=t.BaseObject.borrowObject(t.ImageDisplayData);a.name=i,a.path=s.length>0?s:i,this._parsePivot(e,a);break;case 1:var l=o=t.BaseObject.borrowObject(t.ArmatureDisplayData);if(l.name=i,l.path=s.length>0?s:i,l.inheritAnimation=!0,t.DataParser.ACTIONS in e)for(var c=0,h=this._parseActionData(e[t.DataParser.ACTIONS],0,null,null);c<h.length;c++){var _=h[c];l.addAction(_)}else if(this._slot.name in this._slotChildActions){var u=this._skin.getDisplays(this._slot.name);if(null===u?0===this._slot.displayIndex:this._slot.displayIndex===u.length){for(var m=0,d=this._slotChildActions[this._slot.name];m<d.length;m++)_=d[m],l.addAction(_);delete this._slotChildActions[this._slot.name]}}break;case 2:var p=o=t.BaseObject.borrowObject(t.MeshDisplayData);p.vertices.inheritDeform=n._getBoolean(e,t.DataParser.INHERIT_DEFORM,!0),p.name=i,p.path=s.length>0?s:i,p.vertices.data=this._data,t.DataParser.SHARE in e?(this._cacheRawMeshes.push(e),this._cacheMeshes.push(p)):this._parseMesh(e,p),t.DataParser.GLUE_WEIGHTS in e&&t.DataParser.GLUE_MESHES in e&&(this._cacheRawMeshes.push(e),this._cacheMeshes.push(p));break;case 3:var f=this._parseBoundingBox(e);if(null!==f){var g=o=t.BaseObject.borrowObject(t.BoundingBoxDisplayData);g.name=i,g.path=s.length>0?s:i,g.boundingBox=f}break;case 4:var y=e[t.DataParser.LENGTHS],v=o=t.BaseObject.borrowObject(t.PathDisplayData);v.closed=n._getBoolean(e,t.DataParser.CLOSED,!1),v.constantSpeed=n._getBoolean(e,t.DataParser.CONSTANT_SPEED,!1),v.name=i,v.path=s.length>0?s:i,v.vertices.data=this._data,v.curveLengths.length=y.length;for(var x=0,S=y.length;x<S;++x)v.curveLengths[x]=y[x];this._parsePath(e,v)}return null!==o&&t.DataParser.TRANSFORM in e&&this._parseTransform(e[t.DataParser.TRANSFORM],o.transform,this._armature.scale),o},n.prototype._parsePath=function(e,i){var s=e[t.DataParser.VERTICES],r=n._getNumber(e,t.DataParser.VERTEX_COUNT,0),o=this._floatArray.length,a=this._intArray.length;if(i.vertices.offset=a,this._intArray.length+=2,this._intArray[a+0]=r,this._intArray[a+2]=o,t.DataParser.WEIGHTS in e){var l=e[t.DataParser.WEIGHTS],c=e[t.DataParser.BONES],h=c.length,_=Math.floor(l.length-r)/2,u=this._intArray.length,m=this._floatArray.length,d=this._armature.sortedBones,p=t.BaseObject.borrowObject(t.WeightData);for(p.count=_,p.offset=u,this._intArray.length+=2+h+r+_,this._intArray[u+0]=h,this._intArray[u+1]=m,P=0;P<h;P++){var f=c[P],g=this._rawBones[f];p.addBone(g),this._intArray[u+2+P]=d.indexOf(g)}this._floatArray.length+=3*_,P=0;for(var y=0,v=0,x=u+2+h,S=m;P<_;P++){var A=l[y++];this._intArray[x++]=A;for(var C=0;C<A;C++){var b=l[y++],T=l[y++],w=s[v++],E=s[v++];this._intArray[x++]=c.indexOf(b),this._floatArray[S++]=T,this._floatArray[S++]=w,this._floatArray[S++]=E}}i.vertices.weight=p}else{this._floatArray.length+=s.length;for(var P=0,I=s.length;P<I;++P)this._floatArray[o+P]=s[P]}},n.prototype._parsePivot=function(e,i){if(t.DataParser.PIVOT in e){var s=e[t.DataParser.PIVOT];i.pivot.x=n._getNumber(s,t.DataParser.X,0),i.pivot.y=n._getNumber(s,t.DataParser.Y,0)}else i.pivot.x=.5,i.pivot.y=.5},n.prototype._parseMesh=function(e,i){var n=e[t.DataParser.VERTICES],s=e[t.DataParser.UVS],r=e[t.DataParser.TRIANGLES],o=Math.floor(n.length/2),a=Math.floor(r.length/3),l=this._floatArray.length,c=l+2*o,h=this._intArray.length,_=this._skin.name+"_"+this._slot.name+"_"+i.name;i.vertices.offset=h,this._intArray.length+=4+3*a,this._intArray[h+0]=o,this._intArray[h+1]=a,this._intArray[h+2]=l;for(var u=0,m=3*a;u<m;++u)this._intArray[h+4+u]=r[u];for(this._floatArray.length+=2*o+2*o,u=0,m=2*o;u<m;++u)this._floatArray[l+u]=n[u],this._floatArray[c+u]=s[u];if(t.DataParser.WEIGHTS in e){var d=e[t.DataParser.WEIGHTS],p=e[t.DataParser.SLOT_POSE],f=e[t.DataParser.BONE_POSE],g=this._armature.sortedBones,y=new Array,v=Math.floor(f.length/7),x=this._floatArray.length,S=Math.floor(d.length-o)/2,A=this._intArray.length,C=t.BaseObject.borrowObject(t.WeightData);for(C.count=S,C.offset=A,y.length=v,this._intArray.length+=2+v+o+S,this._intArray[A+1]=x,u=0;u<v;++u){var b=f[7*u],T=this._rawBones[b];C.addBone(T),y[u]=b,this._intArray[A+2+u]=g.indexOf(T)}this._floatArray.length+=3*S,this._helpMatrixA.copyFromArray(p,0),u=0;for(var w=0,E=A+2+v,P=x;u<o;++u){var I=2*u,D=this._intArray[E++]=d[w++],R=this._floatArray[l+I],M=this._floatArray[l+I+1];this._helpMatrixA.transformPoint(R,M,this._helpPoint),R=this._helpPoint.x,M=this._helpPoint.y;for(var B=0;B<D;++B){b=d[w++];var O=y.indexOf(b);this._helpMatrixB.copyFromArray(f,7*O+1),this._helpMatrixB.invert(),this._helpMatrixB.transformPoint(R,M,this._helpPoint),this._intArray[E++]=O,this._floatArray[P++]=d[w++],this._floatArray[P++]=this._helpPoint.x,this._floatArray[P++]=this._helpPoint.y}}i.vertices.weight=C,this._weightSlotPose[_]=p,this._weightBonePoses[_]=f}},n.prototype._parseMeshGlue=function(){},n.prototype._parseBoundingBox=function(e){var i=null,s=0;switch(s=t.DataParser.SUB_TYPE in e&&"string"==typeof e[t.DataParser.SUB_TYPE]?t.DataParser._getBoundingBoxType(e[t.DataParser.SUB_TYPE]):n._getNumber(e,t.DataParser.SUB_TYPE,s)){case 0:i=t.BaseObject.borrowObject(t.RectangleBoundingBoxData);break;case 1:i=t.BaseObject.borrowObject(t.EllipseBoundingBoxData);break;case 2:i=this._parsePolygonBoundingBox(e)}return null!==i&&(i.color=n._getNumber(e,t.DataParser.COLOR,0),0!==i.type&&1!==i.type||(i.width=n._getNumber(e,t.DataParser.WIDTH,0),i.height=n._getNumber(e,t.DataParser.HEIGHT,0))),i},n.prototype._parsePolygonBoundingBox=function(e){var i=t.BaseObject.borrowObject(t.PolygonBoundingBoxData);if(t.DataParser.VERTICES in e){var n=this._armature.scale,s=e[t.DataParser.VERTICES],r=i.vertices;t.DragonBones.webAssembly?r.resize(s.length,0):r.length=s.length;for(var o=0,a=s.length;o<a;o+=2){var l=s[o]*n,c=s[o+1]*n;t.DragonBones.webAssembly?(r.set(o,l),r.set(o+1,c)):(r[o]=l,r[o+1]=c),0===o?(i.x=l,i.y=c,i.width=l,i.height=c):(l<i.x?i.x=l:l>i.width&&(i.width=l),c<i.y?i.y=c:c>i.height&&(i.height=c))}i.width-=i.x,i.height-=i.y}else console.warn("Data error.\n Please reexport DragonBones Data to fixed the bug.");return i},n.prototype._parseAnimation=function(e){var i=t.BaseObject.borrowObject(t.AnimationData);if(i.frameCount=Math.max(n._getNumber(e,t.DataParser.DURATION,1),1),i.playTimes=n._getNumber(e,t.DataParser.PLAY_TIMES,1),i.duration=i.frameCount/this._armature.frameRate,i.fadeInTime=n._getNumber(e,t.DataParser.FADE_IN_TIME,0),i.scale=n._getNumber(e,t.DataParser.SCALE,1),i.name=n._getString(e,t.DataParser.NAME,t.DataParser.DEFAULT_NAME),0===i.name.length&&(i.name=t.DataParser.DEFAULT_NAME),i.frameIntOffset=this._frameIntArray.length,i.frameFloatOffset=this._frameFloatArray.length,i.frameOffset=this._frameArray.length,this._animation=i,t.DataParser.FRAME in e){var s=e[t.DataParser.FRAME],r=s.length;if(r>0)for(var o=0,a=0;o<r;++o){var l=s[o];this._parseActionDataInFrame(l,a,null,null),a+=n._getNumber(l,t.DataParser.DURATION,1)}}if(t.DataParser.Z_ORDER in e&&(this._animation.zOrderTimeline=this._parseTimeline(e[t.DataParser.Z_ORDER],null,t.DataParser.FRAME,1,!1,!1,0,this._parseZOrderFrame)),t.DataParser.BONE in e)for(var c=0,h=e[t.DataParser.BONE];c<h.length;c++){var _=h[c];this._parseBoneTimeline(_)}if(t.DataParser.SURFACE in e)for(var u=0,m=e[t.DataParser.SURFACE];u<m.length;u++){_=m[u];var d=n._getString(_,t.DataParser.NAME,"");this._surface=this._armature.getBone(d),null!==this._surface&&(null!==(P=this._parseTimeline(_,null,t.DataParser.FRAME,50,!1,!0,0,this._parseSurfaceFrame))&&this._animation.addSurfaceTimeline(this._surface,P),this._surface=null)}if(t.DataParser.SLOT in e)for(var p=0,f=e[t.DataParser.SLOT];p<f.length;p++)_=f[p],this._parseSlotTimeline(_);if(t.DataParser.FFD in e)for(var g=0,y=e[t.DataParser.FFD];g<y.length;g++){_=y[g];var v=n._getString(_,t.DataParser.SKIN,t.DataParser.DEFAULT_NAME),x=n._getString(_,t.DataParser.SLOT,""),S=n._getString(_,t.DataParser.NAME,"");0===v.length&&(v=t.DataParser.DEFAULT_NAME),this._slot=this._armature.getSlot(x),this._mesh=this._armature.getMesh(v,x,S),null!==this._slot&&null!==this._mesh&&(null!==(P=this._parseTimeline(_,null,t.DataParser.FRAME,22,!1,!0,0,this._parseSlotFFDFrame))&&this._animation.addSlotTimeline(this._slot,P),this._slot=null,this._mesh=null)}if(t.DataParser.IK in e)for(var A=0,C=e[t.DataParser.IK];A<C.length;A++){_=C[A];var b=n._getString(_,t.DataParser.NAME,""),T=this._armature.getConstraint(b);null!==T&&null!==(P=this._parseTimeline(_,null,t.DataParser.FRAME,30,!0,!1,2,this._parseIKConstraintFrame))&&this._animation.addConstraintTimeline(T,P)}if(t.DataParser.ANIMATION in e)for(var w=0,E=e[t.DataParser.ANIMATION];w<E.length;w++){_=E[w];var P,I=n._getString(_,t.DataParser.NAME,"");null!==(P=this._parseTimeline(_,null,t.DataParser.FRAME,40,!0,!1,2,this._parseAnimationFrame))&&this._animation.addAnimationTimeline(I,P)}return this._actionFrames.length>0&&(this._animation.actionTimeline=this._parseTimeline(null,this._actionFrames,"",0,!1,!1,0,this._parseActionFrame),this._actionFrames.length=0),this._animation=null,i},n.prototype._parseTimeline=function(e,s,r,o,a,l,c,h){if(null!==e&&r.length>0&&r in e&&(s=e[r]),null===s)return null;var _=s.length;if(0===_)return null;var u=this._frameIntArray.length,m=this._frameFloatArray.length,d=t.BaseObject.borrowObject(t.TimelineData),p=this._timelineArray.length;if(this._timelineArray.length+=5+_,null!==e?(this._timelineArray[p+0]=Math.round(100*n._getNumber(e,t.DataParser.SCALE,1)),this._timelineArray[p+1]=Math.round(100*n._getNumber(e,t.DataParser.OFFSET,0))):(this._timelineArray[p+0]=100,this._timelineArray[p+1]=0),this._timelineArray[p+2]=_,this._timelineArray[p+3]=c,this._timelineArray[p+4]=a?u-this._animation.frameIntOffset:l?m-this._animation.frameFloatOffset:0,this._timeline=d,d.type=o,d.offset=p,1===_)d.frameIndicesOffset=-1,this._timelineArray[p+5+0]=h.call(this,s[0],0,0)-this._animation.frameOffset;else{var f=this._animation.frameCount+1,g=this._data.frameIndices,y=0;t.DragonBones.webAssembly?(y=g.size(),g.resize(y+f,0)):(y=g.length,g.length+=f),d.frameIndicesOffset=y;for(var v=0,x=0,S=0,A=0;v<f;++v){if(S+A<=v&&x<_){var C=s[x];S=v,A=x===_-1?this._animation.frameCount-S:C instanceof i?this._actionFrames[x+1].frameStart-S:n._getNumber(C,t.DataParser.DURATION,1),this._timelineArray[p+5+x]=h.call(this,C,S,A)-this._animation.frameOffset,x++}t.DragonBones.webAssembly?g.set(y+v,x-1):g[y+v]=x-1}}return this._timeline=null,d},n.prototype._parseBoneTimeline=function(e){var i,s=this._armature.getBone(n._getString(e,t.DataParser.NAME,""));null!==s&&(this._bone=s,this._slot=this._armature.getSlot(this._bone.name),t.DataParser.TRANSLATE_FRAME in e&&null!==(i=this._parseTimeline(e,null,t.DataParser.TRANSLATE_FRAME,11,!1,!0,2,this._parseBoneTranslateFrame))&&this._animation.addBoneTimeline(s,i),t.DataParser.ROTATE_FRAME in e&&null!==(i=this._parseTimeline(e,null,t.DataParser.ROTATE_FRAME,12,!1,!0,2,this._parseBoneRotateFrame))&&this._animation.addBoneTimeline(s,i),t.DataParser.SCALE_FRAME in e&&null!==(i=this._parseTimeline(e,null,t.DataParser.SCALE_FRAME,13,!1,!0,2,this._parseBoneScaleFrame))&&this._animation.addBoneTimeline(s,i),t.DataParser.FRAME in e&&null!==(i=this._parseTimeline(e,null,t.DataParser.FRAME,10,!1,!0,6,this._parseBoneAllFrame))&&this._animation.addBoneTimeline(s,i),this._bone=null,this._slot=null)},n.prototype._parseSlotTimeline=function(e){var i=this._armature.getSlot(n._getString(e,t.DataParser.NAME,""));if(null!==i){this._slot=i;var s;null!==(s=t.DataParser.DISPLAY_FRAME in e?this._parseTimeline(e,null,t.DataParser.DISPLAY_FRAME,20,!1,!1,0,this._parseSlotDisplayFrame):this._parseTimeline(e,null,t.DataParser.FRAME,20,!1,!1,0,this._parseSlotDisplayFrame))&&this._animation.addSlotTimeline(i,s);var r;null!==(r=t.DataParser.COLOR_FRAME in e?this._parseTimeline(e,null,t.DataParser.COLOR_FRAME,21,!0,!1,1,this._parseSlotColorFrame):this._parseTimeline(e,null,t.DataParser.FRAME,21,!0,!1,1,this._parseSlotColorFrame))&&this._animation.addSlotTimeline(i,r),this._slot=null}},n.prototype._parseFrame=function(t,e){var i=this._frameArray.length;return this._frameArray.length+=1,this._frameArray[i+0]=e,i},n.prototype._parseTweenFrame=function(e,i,s){var r=this._parseFrame(e,i,s);if(s>0)if(t.DataParser.CURVE in e){var o=s+1;this._helpArray.length=o,this._samplingEasingCurve(e[t.DataParser.CURVE],this._helpArray),this._frameArray.length+=2+this._helpArray.length,this._frameArray[r+1]=2,this._frameArray[r+2]=o;for(var a=0;a<o;++a)this._frameArray[r+3+a]=Math.round(1e4*this._helpArray[a])}else{var l=-2;t.DataParser.TWEEN_EASING in e&&(l=n._getNumber(e,t.DataParser.TWEEN_EASING,-2)),-2===l?(this._frameArray.length+=1,this._frameArray[r+1]=0):0===l?(this._frameArray.length+=1,this._frameArray[r+1]=1):l<0?(this._frameArray.length+=2,this._frameArray[r+1]=3,this._frameArray[r+2]=Math.round(100*-l)):l<=1?(this._frameArray.length+=2,this._frameArray[r+1]=4,this._frameArray[r+2]=Math.round(100*l)):(this._frameArray.length+=2,this._frameArray[r+1]=5,this._frameArray[r+2]=Math.round(100*l-100))}else this._frameArray.length+=1,this._frameArray[r+1]=0;return r},n.prototype._parseActionFrame=function(t,e){var i=this._frameArray.length,n=t.actions.length;this._frameArray.length+=2+n,this._frameArray[i+0]=e,this._frameArray[i+0+1]=n;for(var s=0;s<n;++s)this._frameArray[i+0+2+s]=t.actions[s];return i},n.prototype._parseZOrderFrame=function(e,i,n){var s=this._parseFrame(e,i,n);if(t.DataParser.Z_ORDER in e){var r=e[t.DataParser.Z_ORDER];if(r.length>0){for(var o=this._armature.sortedSlots.length,a=new Array(o-r.length/2),l=new Array(o),c=0;c<a.length;++c)a[c]=0;for(var h=0;h<o;++h)l[h]=-1;for(var _=0,u=0,m=0,d=r.length;m<d;m+=2){for(var p=r[m],f=r[m+1];_!==p;)a[u++]=_++;l[_+f]=_++}for(;_<o;)a[u++]=_++;this._frameArray.length+=1+o,this._frameArray[s+1]=o;for(var g=o;g--;)-1===l[g]?this._frameArray[s+2+g]=a[--u]||0:this._frameArray[s+2+g]=l[g]||0;return s}}return this._frameArray.length+=1,this._frameArray[s+1]=0,s},n.prototype._parseBoneAllFrame=function(e,i,s){this._helpTransform.identity(),t.DataParser.TRANSFORM in e&&this._parseTransform(e[t.DataParser.TRANSFORM],this._helpTransform,1);var r=this._helpTransform.rotation;0!==i&&(0===this._prevClockwise?r=this._prevRotation+t.Transform.normalizeRadian(r-this._prevRotation):((this._prevClockwise>0?r>=this._prevRotation:r<=this._prevRotation)&&(this._prevClockwise=this._prevClockwise>0?this._prevClockwise-1:this._prevClockwise+1),r=this._prevRotation+r-this._prevRotation+t.Transform.PI_D*this._prevClockwise)),this._prevClockwise=n._getNumber(e,t.DataParser.TWEEN_ROTATE,0),this._prevRotation=r;var o=this._parseTweenFrame(e,i,s),a=this._frameFloatArray.length;return this._frameFloatArray.length+=6,this._frameFloatArray[a++]=this._helpTransform.x,this._frameFloatArray[a++]=this._helpTransform.y,this._frameFloatArray[a++]=r,this._frameFloatArray[a++]=this._helpTransform.skew,this._frameFloatArray[a++]=this._helpTransform.scaleX,this._frameFloatArray[a++]=this._helpTransform.scaleY,this._parseActionDataInFrame(e,i,this._bone,this._slot),o},n.prototype._parseBoneTranslateFrame=function(e,i,s){var r=this._parseTweenFrame(e,i,s),o=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[o++]=n._getNumber(e,t.DataParser.X,0),this._frameFloatArray[o++]=n._getNumber(e,t.DataParser.Y,0),r},n.prototype._parseBoneRotateFrame=function(e,i,s){var r=n._getNumber(e,t.DataParser.ROTATE,0)*t.Transform.DEG_RAD;0!==i&&(0===this._prevClockwise?r=this._prevRotation+t.Transform.normalizeRadian(r-this._prevRotation):((this._prevClockwise>0?r>=this._prevRotation:r<=this._prevRotation)&&(this._prevClockwise=this._prevClockwise>0?this._prevClockwise-1:this._prevClockwise+1),r=this._prevRotation+r-this._prevRotation+t.Transform.PI_D*this._prevClockwise)),this._prevClockwise=n._getNumber(e,t.DataParser.CLOCK_WISE,0),this._prevRotation=r;var o=this._parseTweenFrame(e,i,s),a=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[a++]=r,this._frameFloatArray[a++]=n._getNumber(e,t.DataParser.SKEW,0)*t.Transform.DEG_RAD,o},n.prototype._parseBoneScaleFrame=function(e,i,s){var r=this._parseTweenFrame(e,i,s),o=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[o++]=n._getNumber(e,t.DataParser.X,1),this._frameFloatArray[o++]=n._getNumber(e,t.DataParser.Y,1),r},n.prototype._parseSurfaceFrame=function(e,i,s){var r=this._frameFloatArray.length,o=this._parseTweenFrame(e,i,s),a=e[t.DataParser.VERTICES],l=n._getNumber(e,t.DataParser.OFFSET,0),c=this._surface.vertices.length/2,h=0,_=0;this._frameFloatArray.length+=2*c;for(var u=0;u<2*c;u+=2)h=u<l||u-l>=a.length?0:a[u-l],_=u+1<l||u+1-l>=a.length?0:a[u+1-l],this._frameFloatArray[r+u]=h,this._frameFloatArray[r+u+1]=_;if(0===i){var m=this._frameIntArray.length;this._frameIntArray.length+=5,this._frameIntArray[m+0]=0,this._frameIntArray[m+1]=this._frameFloatArray.length-r,this._frameIntArray[m+2]=this._frameFloatArray.length-r,this._frameIntArray[m+3]=0,this._frameIntArray[m+4]=r-this._animation.frameFloatOffset,this._timelineArray[this._timeline.offset+3]=m-this._animation.frameIntOffset}return o},n.prototype._parseSlotDisplayFrame=function(e,i,s){var r=this._parseFrame(e,i,s);return this._frameArray.length+=1,t.DataParser.VALUE in e?this._frameArray[r+1]=n._getNumber(e,t.DataParser.VALUE,0):this._frameArray[r+1]=n._getNumber(e,t.DataParser.DISPLAY_INDEX,0),this._parseActionDataInFrame(e,i,this._slot.parent,this._slot),r},n.prototype._parseSlotColorFrame=function(e,i,n){var s=this._parseTweenFrame(e,i,n),r=-1;if(t.DataParser.VALUE in e||t.DataParser.COLOR in e){var o=t.DataParser.VALUE in e?e[t.DataParser.VALUE]:e[t.DataParser.COLOR];for(var a in o){this._parseColorTransform(o,this._helpColorTransform),r=this._intArray.length,this._intArray.length+=8,this._intArray[r++]=Math.round(100*this._helpColorTransform.alphaMultiplier),this._intArray[r++]=Math.round(100*this._helpColorTransform.redMultiplier),this._intArray[r++]=Math.round(100*this._helpColorTransform.greenMultiplier),this._intArray[r++]=Math.round(100*this._helpColorTransform.blueMultiplier),this._intArray[r++]=Math.round(this._helpColorTransform.alphaOffset),this._intArray[r++]=Math.round(this._helpColorTransform.redOffset),this._intArray[r++]=Math.round(this._helpColorTransform.greenOffset),this._intArray[r++]=Math.round(this._helpColorTransform.blueOffset),r-=8;break}}r<0&&(this._defaultColorOffset<0&&(this._defaultColorOffset=r=this._intArray.length,this._intArray.length+=8,this._intArray[r++]=100,this._intArray[r++]=100,this._intArray[r++]=100,this._intArray[r++]=100,this._intArray[r++]=0,this._intArray[r++]=0,this._intArray[r++]=0,this._intArray[r++]=0),r=this._defaultColorOffset);var l=this._frameIntArray.length;return this._frameIntArray.length+=1,this._frameIntArray[l]=r,s},n.prototype._parseSlotFFDFrame=function(e,i,s){var r=this._frameFloatArray.length,o=this._parseTweenFrame(e,i,s),a=t.DataParser.VERTICES in e?e[t.DataParser.VERTICES]:null,l=n._getNumber(e,t.DataParser.OFFSET,0),c=this._intArray[this._mesh.vertices.offset+0],h=this._mesh.parent.name+"_"+this._slot.name+"_"+this._mesh.name,_=this._mesh.vertices.weight,u=0,m=0,d=0,p=0;if(null!==_){var f=this._weightSlotPose[h];this._helpMatrixA.copyFromArray(f,0),this._frameFloatArray.length+=2*_.count,d=_.offset+2+_.bones.length}else this._frameFloatArray.length+=2*c;for(var g=0;g<2*c;g+=2)if(null===a?(u=0,m=0):(u=g<l||g-l>=a.length?0:a[g-l],m=g+1<l||g+1-l>=a.length?0:a[g+1-l]),null!==_){var y=this._weightBonePoses[h],v=this._intArray[d++];this._helpMatrixA.transformPoint(u,m,this._helpPoint,!0),u=this._helpPoint.x,m=this._helpPoint.y;for(var x=0;x<v;++x){var S=this._intArray[d++];this._helpMatrixB.copyFromArray(y,7*S+1),this._helpMatrixB.invert(),this._helpMatrixB.transformPoint(u,m,this._helpPoint,!0),this._frameFloatArray[r+p++]=this._helpPoint.x,this._frameFloatArray[r+p++]=this._helpPoint.y}}else this._frameFloatArray[r+g]=u,this._frameFloatArray[r+g+1]=m;if(0===i){var A=this._frameIntArray.length;this._frameIntArray.length+=5,this._frameIntArray[A+0]=this._mesh.vertices.offset,this._frameIntArray[A+1]=this._frameFloatArray.length-r,this._frameIntArray[A+2]=this._frameFloatArray.length-r,this._frameIntArray[A+3]=0,this._frameIntArray[A+4]=r-this._animation.frameFloatOffset,this._timelineArray[this._timeline.offset+3]=A-this._animation.frameIntOffset}return o},n.prototype._parseIKConstraintFrame=function(e,i,s){var r=this._parseTweenFrame(e,i,s),o=this._frameIntArray.length;return this._frameIntArray.length+=2,this._frameIntArray[o++]=n._getBoolean(e,t.DataParser.BEND_POSITIVE,!0)?1:0,this._frameIntArray[o++]=Math.round(100*n._getNumber(e,t.DataParser.WEIGHT,1)),r},n.prototype._parseAnimationFrame=function(e,i,s){var r=this._parseTweenFrame(e,i,s),o=this._frameIntArray.length;return this._frameIntArray.length+=2,this._frameIntArray[o++]=n._getNumber(e,t.DataParser.VALUE,0),this._frameIntArray[o++]=Math.round(100*n._getNumber(e,t.DataParser.WEIGHT,1)),r},n.prototype._parseActionData=function(e,i,s,r){var o=new Array;if("string"==typeof e)(h=t.BaseObject.borrowObject(t.ActionData)).type=i,h.name=e,h.bone=s,h.slot=r,o.push(h);else if(e instanceof Array)for(var a=0,l=e;a<l.length;a++){var c=l[a],h=t.BaseObject.borrowObject(t.ActionData);if(t.DataParser.GOTO_AND_PLAY in c?(h.type=0,h.name=n._getString(c,t.DataParser.GOTO_AND_PLAY,"")):(t.DataParser.TYPE in c&&"string"==typeof c[t.DataParser.TYPE]?h.type=t.DataParser._getActionType(c[t.DataParser.TYPE]):h.type=n._getNumber(c,t.DataParser.TYPE,i),h.name=n._getString(c,t.DataParser.NAME,"")),t.DataParser.BONE in c){var _=n._getString(c,t.DataParser.BONE,"");h.bone=this._armature.getBone(_)}else h.bone=s;if(t.DataParser.SLOT in c){var u=n._getString(c,t.DataParser.SLOT,"");h.slot=this._armature.getSlot(u)}else h.slot=r;var m=null;if(t.DataParser.INTS in c){null===m&&(m=t.BaseObject.borrowObject(t.UserData));for(var d=0,p=c[t.DataParser.INTS];d<p.length;d++){var f=p[d];m.addInt(f)}}if(t.DataParser.FLOATS in c){null===m&&(m=t.BaseObject.borrowObject(t.UserData));for(var g=0,y=c[t.DataParser.FLOATS];g<y.length;g++)f=y[g],m.addFloat(f)}if(t.DataParser.STRINGS in c){null===m&&(m=t.BaseObject.borrowObject(t.UserData));for(var v=0,x=c[t.DataParser.STRINGS];v<x.length;v++)f=x[v],m.addString(f)}h.data=m,o.push(h)}return o},n.prototype._parseTransform=function(e,i,s){i.x=n._getNumber(e,t.DataParser.X,0)*s,i.y=n._getNumber(e,t.DataParser.Y,0)*s,t.DataParser.ROTATE in e||t.DataParser.SKEW in e?(i.rotation=t.Transform.normalizeRadian(n._getNumber(e,t.DataParser.ROTATE,0)*t.Transform.DEG_RAD),i.skew=t.Transform.normalizeRadian(n._getNumber(e,t.DataParser.SKEW,0)*t.Transform.DEG_RAD)):(t.DataParser.SKEW_X in e||t.DataParser.SKEW_Y in e)&&(i.rotation=t.Transform.normalizeRadian(n._getNumber(e,t.DataParser.SKEW_Y,0)*t.Transform.DEG_RAD),i.skew=t.Transform.normalizeRadian(n._getNumber(e,t.DataParser.SKEW_X,0)*t.Transform.DEG_RAD)-i.rotation),i.scaleX=n._getNumber(e,t.DataParser.SCALE_X,1),i.scaleY=n._getNumber(e,t.DataParser.SCALE_Y,1)},n.prototype._parseColorTransform=function(e,i){i.alphaMultiplier=.01*n._getNumber(e,t.DataParser.ALPHA_MULTIPLIER,100),i.redMultiplier=.01*n._getNumber(e,t.DataParser.RED_MULTIPLIER,100),i.greenMultiplier=.01*n._getNumber(e,t.DataParser.GREEN_MULTIPLIER,100),i.blueMultiplier=.01*n._getNumber(e,t.DataParser.BLUE_MULTIPLIER,100),i.alphaOffset=n._getNumber(e,t.DataParser.ALPHA_OFFSET,0),i.redOffset=n._getNumber(e,t.DataParser.RED_OFFSET,0),i.greenOffset=n._getNumber(e,t.DataParser.GREEN_OFFSET,0),i.blueOffset=n._getNumber(e,t.DataParser.BLUE_OFFSET,0)},n.prototype._parseArray=function(){this._intArray.length=0,this._floatArray.length=0,this._frameIntArray.length=0,this._frameFloatArray.length=0,this._frameArray.length=0,this._timelineArray.length=0},n.prototype._modifyArray=function(){this._intArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._intArray.push(0),this._frameIntArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._frameIntArray.push(0),this._frameArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._frameArray.push(0),this._timelineArray.length%Uint16Array.BYTES_PER_ELEMENT!=0&&this._timelineArray.push(0);var e=this._intArray.length*Int16Array.BYTES_PER_ELEMENT,i=this._floatArray.length*Float32Array.BYTES_PER_ELEMENT,n=this._frameIntArray.length*Int16Array.BYTES_PER_ELEMENT,s=this._frameFloatArray.length*Float32Array.BYTES_PER_ELEMENT,r=this._frameArray.length*Int16Array.BYTES_PER_ELEMENT,o=this._timelineArray.length*Uint16Array.BYTES_PER_ELEMENT,a=e+i+n+s+r+o;if(t.DragonBones.webAssembly){for(var l=t.webAssemblyModule.HEAP16.buffer,c=t.webAssemblyModule._malloc(a),h=new Int16Array(l,c,this._intArray.length),_=new Float32Array(l,c+e,this._floatArray.length),u=new Int16Array(l,c+e+i,this._frameIntArray.length),m=new Float32Array(l,c+e+i+n,this._frameFloatArray.length),d=new Int16Array(l,c+e+i+n+s,this._frameArray.length),p=new Uint16Array(l,c+e+i+n+s+r,this._timelineArray.length),f=0,g=this._intArray.length;f<g;++f)h[f]=this._intArray[f];for(f=0,g=this._floatArray.length;f<g;++f)_[f]=this._floatArray[f];for(f=0,g=this._frameIntArray.length;f<g;++f)u[f]=this._frameIntArray[f];for(f=0,g=this._frameFloatArray.length;f<g;++f)m[f]=this._frameFloatArray[f];for(f=0,g=this._frameArray.length;f<g;++f)d[f]=this._frameArray[f];for(f=0,g=this._timelineArray.length;f<g;++f)p[f]=this._timelineArray[f];t.webAssemblyModule.setDataBinary(this._data,c,e,i,n,s,r,o)}else{var y=new ArrayBuffer(a);for(h=new Int16Array(y,0,this._intArray.length),_=new Float32Array(y,e,this._floatArray.length),u=new Int16Array(y,e+i,this._frameIntArray.length),m=new Float32Array(y,e+i+n,this._frameFloatArray.length),d=new Int16Array(y,e+i+n+s,this._frameArray.length),p=new Uint16Array(y,e+i+n+s+r,this._timelineArray.length),f=0,g=this._intArray.length;f<g;++f)h[f]=this._intArray[f];for(f=0,g=this._floatArray.length;f<g;++f)_[f]=this._floatArray[f];for(f=0,g=this._frameIntArray.length;f<g;++f)u[f]=this._frameIntArray[f];for(f=0,g=this._frameFloatArray.length;f<g;++f)m[f]=this._frameFloatArray[f];for(f=0,g=this._frameArray.length;f<g;++f)d[f]=this._frameArray[f];for(f=0,g=this._timelineArray.length;f<g;++f)p[f]=this._timelineArray[f];this._data.binary=y,this._data.intArray=h,this._data.floatArray=_,this._data.frameIntArray=u,this._data.frameFloatArray=m,this._data.frameArray=d,this._data.timelineArray=p}this._defaultColorOffset=-1},n.prototype.parseDragonBonesData=function(e,i){void 0===i&&(i=1),console.assert(null!=e,"Data error.");var s=n._getString(e,t.DataParser.VERSION,""),r=n._getString(e,t.DataParser.COMPATIBLE_VERSION,"");if(t.DataParser.DATA_VERSIONS.indexOf(s)>=0||t.DataParser.DATA_VERSIONS.indexOf(r)>=0){var o=t.BaseObject.borrowObject(t.DragonBonesData);if(o.version=s,o.name=n._getString(e,t.DataParser.NAME,""),o.frameRate=n._getNumber(e,t.DataParser.FRAME_RATE,24),0===o.frameRate&&(o.frameRate=24),t.DataParser.ARMATURE in e){this._data=o,this._parseArray(e);for(var a=0,l=e[t.DataParser.ARMATURE];a<l.length;a++){var c=l[a];o.addArmature(this._parseArmature(c,i))}this._data.binary||this._modifyArray(),t.DataParser.STAGE in e?o.stage=o.getArmature(n._getString(e,t.DataParser.STAGE,"")):o.armatureNames.length>0&&(o.stage=o.getArmature(o.armatureNames[0])),this._data=null}return t.DataParser.TEXTURE_ATLAS in e&&(this._rawTextureAtlases=e[t.DataParser.TEXTURE_ATLAS]),o}return console.assert(!1,"Nonsupport data version: "+s+"\nPlease convert DragonBones data to support version.\nRead more: https://github.com/DragonBones/Tools/"),null},n.prototype.parseTextureAtlasData=function(e,i,s){if(void 0===s&&(s=1),console.assert(void 0!==e),null===e){if(null===this._rawTextureAtlases||0===this._rawTextureAtlases.length)return!1;var r=this._rawTextureAtlases[this._rawTextureAtlasIndex++];return this.parseTextureAtlasData(r,i,s),this._rawTextureAtlasIndex>=this._rawTextureAtlases.length&&(this._rawTextureAtlasIndex=0,this._rawTextureAtlases=null),!0}if(i.width=n._getNumber(e,t.DataParser.WIDTH,0),i.height=n._getNumber(e,t.DataParser.HEIGHT,0),i.scale=1===s?1/n._getNumber(e,t.DataParser.SCALE,1):s,i.name=n._getString(e,t.DataParser.NAME,""),i.imagePath=n._getString(e,t.DataParser.IMAGE_PATH,""),t.DataParser.SUB_TEXTURE in e)for(var o=e[t.DataParser.SUB_TEXTURE],a=0,l=o.length;a<l;++a){var c=o[a],h=i.createTexture();h.rotated=n._getBoolean(c,t.DataParser.ROTATED,!1),h.name=n._getString(c,t.DataParser.NAME,""),h.region.x=n._getNumber(c,t.DataParser.X,0),h.region.y=n._getNumber(c,t.DataParser.Y,0),h.region.width=n._getNumber(c,t.DataParser.WIDTH,0),h.region.height=n._getNumber(c,t.DataParser.HEIGHT,0);var _=n._getNumber(c,t.DataParser.FRAME_WIDTH,-1),u=n._getNumber(c,t.DataParser.FRAME_HEIGHT,-1);_>0&&u>0&&(h.frame=t.TextureData.createRectangle(),h.frame.x=n._getNumber(c,t.DataParser.FRAME_X,0),h.frame.y=n._getNumber(c,t.DataParser.FRAME_Y,0),h.frame.width=_,h.frame.height=u),i.addTexture(h)}return!0},n.getInstance=function(){return null===n._objectDataParserInstance&&(n._objectDataParserInstance=new n),n._objectDataParserInstance},n._objectDataParserInstance=null,n}(t.DataParser);t.ObjectDataParser=e;var i=function(){this.frameStart=0,this.actions=[]};t.ActionFrame=i}(Cnt||(Cnt={})),function(t){var e=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return Ant(i,e),i.prototype._inRange=function(t,e,i){return e<=t&&t<=i},i.prototype._decodeUTF8=function(t){for(var e,i=0,n="",s=0,r=0,o=0,a=0;t.length>i;){var l=t[i++];if(-1===l)e=0!==r?65533:-1;else if(0===r)this._inRange(l,0,127)?e=l:(this._inRange(l,194,223)?(r=1,a=128,s=l-192):this._inRange(l,224,239)?(r=2,a=2048,s=l-224):this._inRange(l,240,244)&&(r=3,a=65536,s=l-240),s*=Math.pow(64,r),e=null);else if(this._inRange(l,128,191))if(o+=1,s+=(l-128)*Math.pow(64,r-o),o!==r)e=null;else{var c=s,h=a;s=0,r=0,o=0,a=0,e=this._inRange(c,h,1114111)&&!this._inRange(c,55296,57343)?c:l}else s=0,r=0,o=0,a=0,i--,e=l;null!==e&&-1!==e&&(e<=65535?e>0&&(n+=String.fromCharCode(e)):(e-=65536,n+=String.fromCharCode(55296+(e>>10&1023)),n+=String.fromCharCode(56320+(1023&e))))}return n},i.prototype._getUTF16Key=function(t){for(var e=0,i=t.length;e<i;++e)if(t.charCodeAt(e)>255)return encodeURI(t);return t},i.prototype._parseBinaryTimeline=function(e,i,n){void 0===n&&(n=null);var s=null!==n?n:t.BaseObject.borrowObject(t.TimelineData);s.type=e,s.offset=i,this._timeline=s;var r=this._timelineArrayBuffer[s.offset+2];if(1===r)s.frameIndicesOffset=-1;else{var o=0,a=this._animation.frameCount+1,l=this._data.frameIndices;t.DragonBones.webAssembly?(o=l.size(),l.resize(o+a,0)):(o=l.length,l.length+=a),s.frameIndicesOffset=o;for(var c=0,h=0,_=0,u=0;c<a;++c)_+u<=c&&h<r&&(_=this._frameArrayBuffer[this._animation.frameOffset+this._timelineArrayBuffer[s.offset+5+h]],u=h===r-1?this._animation.frameCount-_:this._frameArrayBuffer[this._animation.frameOffset+this._timelineArrayBuffer[s.offset+5+h+1]]-_,h++),t.DragonBones.webAssembly?l.set(o+c,h-1):l[o+c]=h-1}return this._timeline=null,s},i.prototype._parseVertices=function(e,i){i.offset=e[t.DataParser.OFFSET];var n=this._intArrayBuffer[i.offset+3];if(n>=0){var s=t.BaseObject.borrowObject(t.WeightData),r=this._intArrayBuffer[i.offset+0],o=this._intArrayBuffer[n+0];s.offset=n;for(var a=0;a<o;++a){var l=this._intArrayBuffer[n+2+a];s.addBone(this._rawBones[l])}for(var c=n+2+o,h=0,_=(a=0,r);a<_;++a){var u=this._intArrayBuffer[c++];h+=u,c+=u}s.count=h,i.weight=s}},i.prototype._parseMesh=function(t,e){this._parseVertices(t,e.vertices)},i.prototype._parsePath=function(t,e){this._parseVertices(t,e.vertices)},i.prototype._parseAnimation=function(e){var i=t.BaseObject.borrowObject(t.AnimationData);i.frameCount=Math.max(t.ObjectDataParser._getNumber(e,t.DataParser.DURATION,1),1),i.playTimes=t.ObjectDataParser._getNumber(e,t.DataParser.PLAY_TIMES,1),i.duration=i.frameCount/this._armature.frameRate,i.fadeInTime=t.ObjectDataParser._getNumber(e,t.DataParser.FADE_IN_TIME,0),i.scale=t.ObjectDataParser._getNumber(e,t.DataParser.SCALE,1),i.name=t.ObjectDataParser._getString(e,t.DataParser.NAME,t.DataParser.DEFAULT_NAME),0===i.name.length&&(i.name=t.DataParser.DEFAULT_NAME);var n=e[t.DataParser.OFFSET];if(i.frameIntOffset=n[0],i.frameFloatOffset=n[1],i.frameOffset=n[2],this._animation=i,t.DataParser.ACTION in e&&(i.actionTimeline=this._parseBinaryTimeline(0,e[t.DataParser.ACTION])),t.DataParser.Z_ORDER in e&&(i.zOrderTimeline=this._parseBinaryTimeline(1,e[t.DataParser.Z_ORDER])),t.DataParser.BONE in e){var s=e[t.DataParser.BONE];for(var r in s){var o=s[r];t.DragonBones.webAssembly&&(r=this._getUTF16Key(r));var a=this._armature.getBone(r);if(null!==a)for(var l=0,c=o.length;l<c;l+=2){var h=o[l],_=o[l+1],u=this._parseBinaryTimeline(h,_);this._animation.addBoneTimeline(a,u)}}}if(t.DataParser.SURFACE in e)for(var r in s=e[t.DataParser.SURFACE]){o=s[r],t.DragonBones.webAssembly&&(r=this._getUTF16Key(r));var m=this._armature.getBone(r);if(null!==m)for(l=0,c=o.length;l<c;l+=2)h=o[l],_=o[l+1],u=this._parseBinaryTimeline(h,_),this._animation.addSurfaceTimeline(m,u)}if(t.DataParser.SLOT in e)for(var r in s=e[t.DataParser.SLOT]){o=s[r],t.DragonBones.webAssembly&&(r=this._getUTF16Key(r));var d=this._armature.getSlot(r);if(null!==d)for(l=0,c=o.length;l<c;l+=2)h=o[l],_=o[l+1],u=this._parseBinaryTimeline(h,_),this._animation.addSlotTimeline(d,u)}if(t.DataParser.CONSTRAINT in e)for(var r in s=e[t.DataParser.CONSTRAINT]){o=s[r],t.DragonBones.webAssembly&&(r=this._getUTF16Key(r));var p=this._armature.getConstraint(r);if(null!==p)for(l=0,c=o.length;l<c;l+=2)h=o[l],_=o[l+1],u=this._parseBinaryTimeline(h,_),this._animation.addConstraintTimeline(p,u)}if(t.DataParser.ANIMATION in e)for(var r in s=e[t.DataParser.ANIMATION])for(o=s[r],t.DragonBones.webAssembly&&(r=this._getUTF16Key(r)),l=0,c=o.length;l<c;l+=2)h=o[l],_=o[l+1],u=this._parseBinaryTimeline(h,_),this._animation.addAnimationTimeline(r,u);return this._animation=null,i},i.prototype._parseArray=function(e){var i=e[t.DataParser.OFFSET],n=i[1],s=i[3],r=i[5],o=i[7],a=i[9],l=i[11],c=new Int16Array(this._binary,this._binaryOffset+i[0],n/Int16Array.BYTES_PER_ELEMENT),h=new Float32Array(this._binary,this._binaryOffset+i[2],s/Float32Array.BYTES_PER_ELEMENT),_=new Int16Array(this._binary,this._binaryOffset+i[4],r/Int16Array.BYTES_PER_ELEMENT),u=new Float32Array(this._binary,this._binaryOffset+i[6],o/Float32Array.BYTES_PER_ELEMENT),m=new Int16Array(this._binary,this._binaryOffset+i[8],a/Int16Array.BYTES_PER_ELEMENT),d=new Uint16Array(this._binary,this._binaryOffset+i[10],l/Uint16Array.BYTES_PER_ELEMENT);if(t.DragonBones.webAssembly){for(var p=n+s+r+o+a+l,f=t.webAssemblyModule._malloc(p),g=new Uint8Array(this._binary,this._binaryOffset,p/Uint8Array.BYTES_PER_ELEMENT),y=new Uint8Array(t.webAssemblyModule.HEAP16.buffer,f,g.length),v=0,x=g.length;v<x;++v)y[v]=g[v];t.webAssemblyModule.setDataBinary(this._data,f,n,s,r,o,a,l),this._intArrayBuffer=c,this._floatArrayBuffer=h,this._frameIntArrayBuffer=_,this._frameFloatArrayBuffer=u,this._frameArrayBuffer=m,this._timelineArrayBuffer=d}else this._data.binary=this._binary,this._data.intArray=this._intArrayBuffer=c,this._data.floatArray=this._floatArrayBuffer=h,this._data.frameIntArray=this._frameIntArrayBuffer=_,this._data.frameFloatArray=this._frameFloatArrayBuffer=u,this._data.frameArray=this._frameArrayBuffer=m,this._data.timelineArray=this._timelineArrayBuffer=d},i.prototype.parseDragonBonesData=function(t,i){void 0===i&&(i=1),console.assert(null!=t&&t instanceof ArrayBuffer,"Data error.");var n=new Uint8Array(t,0,8);if(n[0]!=="D".charCodeAt(0)||n[1]!=="B".charCodeAt(0)||n[2]!=="D".charCodeAt(0)||n[3]!=="T".charCodeAt(0))return console.assert(!1,"Nonsupport data."),null;var s=new Uint32Array(t,8,1)[0],r=new Uint8Array(t,12,s),o=this._decodeUTF8(r),a=JSON.parse(o);return this._binaryOffset=12+s,this._binary=t,e.prototype.parseDragonBonesData.call(this,a,i)},i.getInstance=function(){return null===i._binaryDataParserInstance&&(i._binaryDataParserInstance=new i),i._binaryDataParserInstance},i._binaryDataParserInstance=null,i}(t.ObjectDataParser);t.BinaryDataParser=e}(Cnt||(Cnt={})),function(t){var e=function(){function e(i){void 0===i&&(i=null),this.autoSearch=!1,this._dragonBonesDataMap={},this._textureAtlasDataMap={},this._dragonBones=null,this._dataParser=null,null===e._objectParser&&(e._objectParser=new t.ObjectDataParser),null===e._binaryParser&&(e._binaryParser=new t.BinaryDataParser),this._dataParser=null!==i?i:e._objectParser}return e.prototype._isSupportMesh=function(){return!0},e.prototype._getTextureData=function(t,e){if(t in this._textureAtlasDataMap)for(var i=0,n=this._textureAtlasDataMap[t];i<n.length;i++)if(null!==(l=(a=n[i]).getTexture(e)))return l;if(this.autoSearch)for(var s in this._textureAtlasDataMap)for(var r=0,o=this._textureAtlasDataMap[s];r<o.length;r++){var a,l;if((a=o[r]).autoSearch&&null!==(l=a.getTexture(e)))return l}return null},e.prototype._fillBuildArmaturePackage=function(t,e,i,n,s){var r=null,o=null;if(e.length>0&&e in this._dragonBonesDataMap&&(o=(r=this._dragonBonesDataMap[e]).getArmature(i)),null===o&&(0===e.length||this.autoSearch))for(var a in this._dragonBonesDataMap)if(r=this._dragonBonesDataMap[a],(0===e.length||r.autoSearch)&&null!==(o=r.getArmature(i))){e=a;break}if(null!==o){if(t.dataName=e,t.textureAtlasName=s,t.data=r,t.armature=o,t.skin=null,n.length>0&&(t.skin=o.getSkin(n),null===t.skin&&this.autoSearch))for(var a in this._dragonBonesDataMap){var l=this._dragonBonesDataMap[a].getArmature(n);if(null!==l){t.skin=l.defaultSkin;break}}return null===t.skin&&(t.skin=o.defaultSkin),!0}return!1},e.prototype._buildBones=function(e,i){for(var n=0,s=e.armature.sortedBones;n<s.length;n++){var r=s[n];t.BaseObject.borrowObject(0===r.type?t.Bone:t.Surface).init(r,i)}},e.prototype._buildSlots=function(e,i){var n=e.skin,s=e.armature.defaultSkin;if(null!==n&&null!==s){var r={};for(var o in s.displays){var a=s.getDisplays(o);r[o]=a}if(n!==s)for(var o in n.displays)a=n.getDisplays(o),r[o]=a;for(var l=0,c=e.armature.sortedSlots;l<c.length;l++){var h=c[l],_=h.name in r?r[h.name]:null,u=this._buildSlot(e,h,i);if(u.rawDisplayDatas=_,null!==_){for(var m=new Array,d=0,p=t.DragonBones.webAssembly?_.size():_.length;d<p;++d){var f=t.DragonBones.webAssembly?_.get(d):_[d];null!==f?m.push(this._getSlotDisplay(e,f,null,u)):m.push(null)}u._setDisplayList(m)}u._setDisplayIndex(h.displayIndex,!0)}}},e.prototype._buildConstraints=function(e,i){var n=e.armature.constraints;for(var s in n){var r=n[s];switch(r.type){case 0:var o=t.BaseObject.borrowObject(t.IKConstraint);o.init(r,i),i._addConstraint(o);break;case 1:var a=t.BaseObject.borrowObject(t.PathConstraint);a.init(r,i),i._addConstraint(a);break;default:var l=t.BaseObject.borrowObject(t.IKConstraint);l.init(r,i),i._addConstraint(l)}}},e.prototype._buildChildArmature=function(t,e,i){return this.buildArmature(i.path,null!==t?t.dataName:"","",null!==t?t.textureAtlasName:"")},e.prototype._getSlotDisplay=function(e,i,n,s){var r=null!==e?e.dataName:i.parent.parent.parent.name,o=null;switch(i.type){case 0:var a=i;null!==e&&e.textureAtlasName.length>0&&(a.texture=this._getTextureData(e.textureAtlasName,i.path)),null===a.texture&&(a.texture=this._getTextureData(r,i.path)),o=null!==n&&2===n.type&&this._isSupportMesh()?s.meshDisplay:s.rawDisplay;break;case 2:var l=i;null!==e&&e.textureAtlasName.length>0&&(l.texture=this._getTextureData(e.textureAtlasName,l.path)),null===l.texture&&(l.texture=this._getTextureData(r,l.path)),o=this._isSupportMesh()?s.meshDisplay:s.rawDisplay;break;case 1:var c=i,h=this._buildChildArmature(e,s,i);if(null!==h){if(h.inheritAnimation=c.inheritAnimation,!h.inheritAnimation){var _=c.actions.length>0?c.actions:h.armatureData.defaultActions;if(_.length>0)for(var u=0,m=_;u<m.length;u++){var d=m[u],p=t.BaseObject.borrowObject(t.EventObject);t.EventObject.actionDataToInstance(d,p,s.armature),p.slot=s,s.armature._bufferAction(p,!1)}else h.animation.play()}c.armature=h.armatureData}o=h}return o},e.prototype.parseDragonBonesData=function(t,i,n){void 0===i&&(i=null),void 0===n&&(n=1);for(var s=t instanceof ArrayBuffer?e._binaryParser:this._dataParser,r=s.parseDragonBonesData(t,n);;){var o=this._buildTextureAtlasData(null,null);if(!s.parseTextureAtlasData(null,o,n)){o.returnToPool();break}this.addTextureAtlasData(o,i)}return null!==r&&this.addDragonBonesData(r,i),r},e.prototype.parseTextureAtlasData=function(t,e,i,n){void 0===i&&(i=null),void 0===n&&(n=1);var s=this._buildTextureAtlasData(null,null);return this._dataParser.parseTextureAtlasData(t,s,n),this._buildTextureAtlasData(s,e||null),this.addTextureAtlasData(s,i),s},e.prototype.updateTextureAtlasData=function(t,e){var i=this.getTextureAtlasData(t);if(null!==i)for(var n=0,s=i.length;n<s;++n)n<e.length&&this._buildTextureAtlasData(i[n],e[n])},e.prototype.getDragonBonesData=function(t){return t in this._dragonBonesDataMap?this._dragonBonesDataMap[t]:null},e.prototype.addDragonBonesData=function(t,e){if(void 0===e&&(e=null),(e=null!==e?e:t.name)in this._dragonBonesDataMap){if(this._dragonBonesDataMap[e]===t)return;console.warn("Can not add same name data: "+e)}else this._dragonBonesDataMap[e]=t},e.prototype.removeDragonBonesData=function(t,e){void 0===e&&(e=!0),t in this._dragonBonesDataMap&&(e&&this._dragonBones.bufferObject(this._dragonBonesDataMap[t]),delete this._dragonBonesDataMap[t])},e.prototype.getTextureAtlasData=function(t){return t in this._textureAtlasDataMap?this._textureAtlasDataMap[t]:null},e.prototype.addTextureAtlasData=function(t,e){void 0===e&&(e=null);var i=(e=null!==e?e:t.name)in this._textureAtlasDataMap?this._textureAtlasDataMap[e]:this._textureAtlasDataMap[e]=[];i.indexOf(t)<0&&i.push(t)},e.prototype.removeTextureAtlasData=function(t,e){if(void 0===e&&(e=!0),t in this._textureAtlasDataMap){var i=this._textureAtlasDataMap[t];if(e)for(var n=0,s=i;n<s.length;n++){var r=s[n];this._dragonBones.bufferObject(r)}delete this._textureAtlasDataMap[t]}},e.prototype.getArmatureData=function(t,e){void 0===e&&(e="");var n=new i;return this._fillBuildArmaturePackage(n,e,t,"","")?n.armature:null},e.prototype.clear=function(t){for(var e in void 0===t&&(t=!0),this._dragonBonesDataMap)t&&this._dragonBones.bufferObject(this._dragonBonesDataMap[e]),delete this._dragonBonesDataMap[e];for(var e in this._textureAtlasDataMap){if(t)for(var i=0,n=this._textureAtlasDataMap[e];i<n.length;i++){var s=n[i];this._dragonBones.bufferObject(s)}delete this._textureAtlasDataMap[e]}},e.prototype.buildArmature=function(t,e,n,s){void 0===e&&(e=""),void 0===n&&(n=""),void 0===s&&(s="");var r=new i;if(!this._fillBuildArmaturePackage(r,e||"",t,n||"",s||""))return console.warn("No armature data: "+t+", "+(null!==e?e:"")),null;var o=this._buildArmature(r);return this._buildBones(r,o),this._buildSlots(r,o),this._buildConstraints(r,o),o.invalidUpdate(null,!0),o.advanceTime(0),o},e.prototype.replaceDisplay=function(e,i,n){void 0===n&&(n=-1),n<0&&(n=e.displayIndex),n<0&&(n=0),e.replaceDisplayData(i,n);var s=e.displayList;if(s.length<=n){s.length=n+1;for(var r=0,o=s.length;r<o;++r)s[r]||(s[r]=null)}if(null!==i){var a=e.rawDisplayDatas,l=null;a&&(t.DragonBones.webAssembly?n<a.size()&&(l=a.get(n)):n<a.length&&(l=a[n])),s[n]=this._getSlotDisplay(null,i,l,e)}else s[n]=null;e.displayList=s},e.prototype.replaceSlotDisplay=function(t,e,i,n,s,r){void 0===r&&(r=-1);var o=this.getArmatureData(e,t||"");if(!o||!o.defaultSkin)return!1;var a=o.defaultSkin.getDisplay(i,n);return!!a&&(this.replaceDisplay(s,a,r),!0)},e.prototype.replaceSlotDisplayList=function(e,i,n,s){var r=this.getArmatureData(i,e||"");if(!r||!r.defaultSkin)return!1;var o=r.defaultSkin.getDisplays(n);if(!o)return!1;for(var a=0,l=0,c=t.DragonBones.webAssembly?o.size():o.length;l<c;++l){var h=t.DragonBones.webAssembly?o.get(l):o[l];this.replaceDisplay(s,h,a++)}return!0},e.prototype.replaceSkin=function(e,i,n,s){void 0===n&&(n=!1),void 0===s&&(s=null);for(var r=!1,o=i.parent.defaultSkin,a=0,l=e.getSlots();a<l.length;a++){var c=l[a];if(!(null!==s&&s.indexOf(c.name)>=0)){var h=i.getDisplays(c.name);if(h||(null!==o&&i!==o&&(h=o.getDisplays(c.name)),h)){var _=t.DragonBones.webAssembly?h.size():h.length,u=c.displayList;u.length=_;for(var m=0,d=_;m<d;++m){var p=t.DragonBones.webAssembly?h.get(m):h[m];u[m]=null!==p?this._getSlotDisplay(null,p,null,c):null}r=!0,c.rawDisplayDatas=h,c.displayList=u}else n&&(c.rawDisplayDatas=null,c.displayList=[])}}return r},e.prototype.replaceAnimation=function(e,i,n){void 0===n&&(n=!0);var s=i.defaultSkin;if(null===s)return!1;if(n)e.animation.animations=i.animations;else{var r=e.animation.animations,o={};for(var a in r)o[a]=r[a];for(var a in i.animations)o[a]=i.animations[a];e.animation.animations=o}for(var l=0,c=e.getSlots();l<c.length;l++)for(var h=c[l],_=0,u=0,m=h.displayList;u<m.length;u++){var d=m[u];if(d instanceof t.Armature){var p=s.getDisplays(h.name);if(null!==p&&_<(t.DragonBones.webAssembly?p.size():p.length)){var f=t.DragonBones.webAssembly?p.get(_):p[_];if(null!==f&&1===f.type){var g=this.getArmatureData(f.path,f.parent.parent.parent.name);g&&this.replaceAnimation(d,g,n)}}}_++}return!0},e.prototype.getAllDragonBonesData=function(){return this._dragonBonesDataMap},e.prototype.getAllTextureAtlasData=function(){return this._textureAtlasDataMap},Object.defineProperty(e.prototype,"clock",{get:function(){return this._dragonBones.clock},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dragonBones",{get:function(){return this._dragonBones},enumerable:!0,configurable:!0}),e.prototype.changeSkin=function(t,e,i){return void 0===i&&(i=null),this.replaceSkin(t,e,!1,i)},e.prototype.copyAnimationsToArmature=function(t,e,i,n,s){void 0===n&&(n=""),void 0===s&&(s=!0);var r=this.getArmatureData(e,n);return!!r&&this.replaceAnimation(t,r,s)},e._objectParser=null,e._binaryParser=null,e}();t.BaseFactory=e;var i=function(){this.dataName="",this.textureAtlasName="",this.skin=null};t.BuildArmaturePackage=i}(Cnt||(Cnt={})),function(t){t.BinaryOffset={WeigthBoneCount:0,WeigthFloatOffset:1,WeigthBoneIndices:2,MeshVertexCount:0,MeshTriangleCount:1,MeshFloatOffset:2,MeshWeightOffset:3,MeshVertexIndices:4,TimelineScale:0,TimelineOffset:1,TimelineKeyFrameCount:2,TimelineFrameValueCount:3,TimelineFrameValueOffset:4,TimelineFrameOffset:5,FramePosition:0,FrameTweenType:1,FrameTweenEasingOrCurveSampleCount:2,FrameCurveSamples:3,DeformMeshOffset:0,DeformCount:1,DeformValueCount:2,DeformValueOffset:3,DeformFloatOffset:4},t.ArmatureType={Armature:0,MovieClip:1,Stage:2},t.BoneType={Bone:0,Surface:1},t.DisplayType={Image:0,Armature:1,Mesh:2,BoundingBox:3},t.BoundingBoxType={Rectangle:0,Ellipse:1,Polygon:2},t.ActionType={Play:0,Stop:1,GotoAndPlay:2,GotoAndStop:3,FadeIn:4,FadeOut:5,Frame:10,Sound:11},t.BlendMode={Normal:0,Add:1,Alpha:2,Darken:3,Difference:4,Erase:5,HardLight:6,Invert:7,Layer:8,Lighten:9,Multiply:10,Overlay:11,Screen:12,Subtract:13},t.TweenType={None:0,Line:1,Curve:2,QuadIn:3,QuadOut:4,QuadInOut:5},t.TimelineType={Action:0,ZOrder:1,BoneAll:10,BoneTranslate:11,BoneRotate:12,BoneScale:13,Surface:50,SlotDisplay:20,SlotColor:21,SlotFFD:22,IKConstraint:30,AnimationTime:40,AnimationWeight:41}}(Cnt||(Cnt={}));const bnt=Cnt.DragonBones,Tnt=Cnt.BaseObject,wnt=Cnt.Matrix,Ent=(Cnt.Transform,Cnt.ColorTransform,Cnt.Point,Cnt.Rectangle,Cnt.UserData,Cnt.ActionData,Cnt.DragonBonesData,Cnt.ArmatureData,Cnt.BoneData,Cnt.SurfaceData,Cnt.SlotData,Cnt.ConstraintData,Cnt.IKConstraintData,Cnt.PathConstraintData,Cnt.CanvasData,Cnt.SkinData,Cnt.VerticesData,Cnt.DisplayData),Pnt=(Cnt.ImageDisplayData,Cnt.ArmatureDisplayData,Cnt.MeshDisplayData,Cnt.BoundingBoxDisplayData,Cnt.PathDisplayData,Cnt.WeightData,Cnt.BoundingBoxData,Cnt.RectangleBoundingBoxData,Cnt.EllipseBoundingBoxData,Cnt.PolygonBoundingBoxData,Cnt.AnimationData,Cnt.TimelineData,Cnt.AnimationConfig,Cnt.TextureAtlasData),Int=Cnt.TextureData,Dnt=(Cnt.DeformVertices,Cnt.Armature),Rnt=(Cnt.TransformObject,Cnt.Bone,Cnt.Surface,Cnt.Slot),Mnt=(Cnt.Constraint,Cnt.IKConstraint,Cnt.PathConstraint,Cnt.WorldClock,Cnt.Animation),Bnt=(Cnt.AnimationState,Cnt.BonePose,Cnt.BlendState,Cnt.TimelineState,Cnt.TweenTimelineState,Cnt.BoneTimelineState,Cnt.SlotTimelineState,Cnt.ConstraintTimelineState,Cnt.ActionTimelineState,Cnt.ZOrderTimelineState,Cnt.BoneAllTimelineState,Cnt.BoneTranslateTimelineState,Cnt.BoneRotateTimelineState,Cnt.BoneScaleTimelineState,Cnt.SurfaceTimelineState,Cnt.SlotDislayTimelineState,Cnt.SlotColorTimelineState,Cnt.DeformTimelineState,Cnt.IKConstraintTimelineState,Cnt.AnimationTimelineState,Cnt.EventObject),Ont=(Cnt.DataParser,Cnt.ObjectDataParser,Cnt.ActionFrame,Cnt.BinaryDataParser,Cnt.BaseFactory),Nnt=(Cnt.BuildArmaturePackage,Cnt.BinaryOffset),Lnt=(Cnt.ArmatureType,Cnt.BoneType);var Fnt,znt;Cnt.DisplayType,Cnt.BoundingBoxType,Cnt.ActionType,Cnt.BlendMode,Cnt.TweenType,Cnt.TimelineType;let Vnt=u_("dragonBones.CCTextureAtlasData")(Fnt=class extends Pnt{constructor(...t){super(...t),this._renderTexture=null}get renderTexture(){return this._renderTexture}set renderTexture(t){if(this._renderTexture=t,t)for(const e in this.textures){const i=this.textures[e];if(!i.spriteFrame){let e=null;i.rotated?e=new Oi(i.region.x,i.region.y,i.region.height,i.region.width):(e=new Oi(i.region.x,i.region.y,i.region.width,i.region.height),i.spriteFrame=new zR,i.spriteFrame.texture=t,i.spriteFrame.rect=e)}}else for(const t in this.textures)this.textures[t].spriteFrame=null}static toString(){return"[class dragonBones.CCTextureAtlasData]"}createTexture(){return Tnt.borrowObject(Unt)}_onClear(){super._onClear(),this.renderTexture=null}})||Fnt,Unt=u_("dragonBones.CCTextureData")(znt=class extends Int{constructor(...t){super(...t),this.spriteFrame=null}static toString(){return"[class dragonBones.CCTextureData]"}_onClear(){super._onClear(),this.spriteFrame=null}})||znt;var Gnt;let Hnt=u_("dragonBones.CCSlot")(Gnt=class extends Rnt{static toString(){return"[class dragonBones.CCSlot]"}constructor(){super(),this._localVertices=void 0,this._indices=void 0,this._matrix=void 0,this._worldMatrix=void 0,this._worldMatrixDirty=void 0,this._color=void 0,this._localVertices=[],this._indices=[],this._matrix=new Si,this._worldMatrix=new Si,this._worldMatrixDirty=!0,this._visible=!1,this._color=new si}getTexture(){if(this._textureData){const t=this._textureData.spriteFrame;return t.texture instanceof Ru?t.texture._texture:t.texture}return null}calculWorldMatrix(){const t=this._armature._parent;t?this._mulMat(this._worldMatrix,t._worldMatrix,this._matrix):Si.copy(this._worldMatrix,this._matrix),this._worldMatrixDirty=!1}_onClear(){super._onClear(),this._localVertices.length=0,this._indices.length=0,Si.identity(this._matrix),Si.identity(this._worldMatrix),this._worldMatrixDirty=!0,this._color=new si,this._visible=!1}_onUpdateDisplay(){}_initDisplay(t){}_addDisplay(){this._visible=!0}_replaceDisplay(t){}_removeDisplay(){this._visible=!1}_disposeDisplay(t){}_updateVisible(){this._visible=this.parent.visible}_updateGlueMesh(){}_updateZOrder(){}_updateBlendMode(){if(this._childArmature){const t=this._childArmature.getSlots();for(let e=0,i=t.length;e<i;e++){const i=t[e];i._blendMode=this._blendMode,i._updateBlendMode()}}}_updateColor(){const t=this._color;t.r=255*this._colorTransform.redMultiplier,t.g=255*this._colorTransform.greenMultiplier,t.b=255*this._colorTransform.blueMultiplier,t.a=255*this._colorTransform.alphaMultiplier}_updateFrame(){this._indices.length=0;const t=this._indices,e=this._localVertices;let i=0,n=0;const s=this._textureData;if(!this._display||this._displayIndex<0||!s||!s.spriteFrame)return;const r=s.spriteFrame.texture,o=r.width,a=r.height,l=s.region;if(0===o||0===a)return void console.error(`SpriteFrame ${s.spriteFrame.name} incorrect size ${o} x ${a}`);const c=null!==this._deformVertices&&this._display===this._meshDisplay?this._deformVertices.verticesData:null;if(c){const s=c.data,r=s.intArray,h=s.floatArray,_=r[c.offset+Nnt.MeshVertexCount],u=r[c.offset+Nnt.MeshTriangleCount];let m=r[c.offset+Nnt.MeshFloatOffset];m<0&&(m+=65536);const d=m+2*_,p=this._armature._armatureData.scale;for(let t=0,i=2*_;t<i;t+=2)e[n++]=h[m+t]*p,e[n++]=-h[m+t+1]*p,c.rotated?(e[n++]=(l.x+(1-h[d+t])*l.width)/o,e[n++]=(l.y+h[d+t+1]*l.height)/a):(e[n++]=(l.x+h[d+t]*l.width)/o,e[n++]=(l.y+h[d+t+1]*l.height)/a);for(let e=0;e<3*u;++e)t[i++]=r[c.offset+Nnt.MeshVertexIndices+e];e.length=n,t.length=i,c.weight&&this._identityTransform()}else{const i=l.x/o,s=(l.y+l.height)/a,r=(l.x+l.width)/o,c=l.y/a;e[n++]=0,e[n++]=0,e[n++]=i,e[n++]=s,e[n++]=l.width,e[n++]=0,e[n++]=r,e[n++]=s,e[n++]=0,e[n++]=l.height,e[n++]=i,e[n++]=c,e[n++]=l.width,e[n++]=l.height,e[n++]=r,e[n++]=c,t[0]=0,t[1]=1,t[2]=2,t[3]=1,t[4]=3,t[5]=2,e.length=n,t.length=6}this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0}_updateMesh(){const t=this._armature._armatureData.scale,e=this._deformVertices.vertices,i=this._deformVertices.bones,n=this._deformVertices.verticesData,s=n.weight,r=e.length>0&&n.inheritDeform,o=this._localVertices;if(s){const a=n.data,l=a.intArray,c=a.floatArray,h=l[n.offset+Nnt.MeshVertexCount];let _=l[s.offset+Nnt.WeigthFloatOffset];_<0&&(_+=65536);for(let n=0,a=s.offset+Nnt.WeigthBoneIndices+i.length,u=_,m=0,d=0;n<h;n++,d+=4){const n=l[a++];let s=0,h=0;for(let o=0;o<n;++o){const n=i[l[a++]];if(null!==n){const i=n.globalTransformMatrix,o=c[u++];let a=c[u++]*t,l=c[u++]*t;r&&(a+=e[m++],l+=e[m++]),s+=(i.a*a+i.c*l+i.tx)*o,h+=(i.b*a+i.d*l+i.ty)*o}}o[d]=s,o[d+1]=-h}}else if(r){const i=this._parent._boneData.type!==Lnt.Bone,s=n.data,r=s.intArray,a=s.floatArray,l=r[n.offset+Nnt.MeshVertexCount];let c=r[n.offset+Nnt.MeshFloatOffset];c<0&&(c+=65536);for(let n=0,s=l,r=0;n<s;n++,r+=4){const s=a[c+2*n]*t+e[2*n],l=a[c+2*n+1]*t+e[2*n+1];if(i){const t=this._parent._getGlobalTransformMatrix(s,l);o[r]=t.a*s+t.c*l+t.tx,o[r+1]=-t.b*s+t.d*l+t.ty}else o[r]=s,o[r+1]=-l}}s&&this._identityTransform()}_identityTransform(){const t=this._matrix;t.m00=1,t.m01=0,t.m04=-0,t.m05=-1,t.m12=0,t.m13=0,this._worldMatrixDirty=!0}_updateTransform(){const t=this._matrix;t.m00=this.globalTransformMatrix.a,t.m01=this.globalTransformMatrix.b,t.m04=-this.globalTransformMatrix.c,t.m05=-this.globalTransformMatrix.d,this._childArmature?(t.m12=this.globalTransformMatrix.tx,t.m13=this.globalTransformMatrix.ty):(t.m12=this.globalTransformMatrix.tx-(this.globalTransformMatrix.a*this._pivotX-this.globalTransformMatrix.c*this._pivotY),t.m13=this.globalTransformMatrix.ty-(this.globalTransformMatrix.b*this._pivotX-this.globalTransformMatrix.d*this._pivotY)),this._worldMatrixDirty=!0}updateWorldMatrix(){if(!this._armature)return;const t=this._armature._parent;if(t&&t.updateWorldMatrix(),this._worldMatrixDirty){this.calculWorldMatrix();const t=this.childArmature;if(!t)return;const e=t.getSlots();for(let t=0,i=e.length;t<i;t++){const i=e[t];i&&(i._worldMatrixDirty=!0)}}}_mulMat(t,e,i){const n=e.m00,s=e.m01,r=e.m04,o=e.m05,a=e.m12,l=e.m13,c=i.m00,h=i.m01,_=i.m04,u=i.m05,m=i.m12,d=i.m13;0!==s||0!==r?(t.m00=c*n+h*r,t.m01=c*s+h*o,t.m04=_*n+u*r,t.m05=_*s+u*o,t.m12=n*m+r*d+a,t.m13=s*m+o*d+l):(t.m00=c*n,t.m01=h*o,t.m04=_*n,t.m05=u*o,t.m12=n*m+a,t.m13=o*d+l)}})||Gnt;var knt;let jnt=u_("dragonBones.CCArmatureDisplay")(knt=class extends Ent{get node(){return this}constructor(){super(),this.shouldAdvanced=!1,this._ccNode=null,this._ccComponent=null,this._eventTarget=void 0,this._armature=null,this._eventTarget=new Zi}hasEvent(t){return console.warn("Method not implemented."),!1}addEvent(t,e,i){console.warn("Method not implemented.")}removeEvent(t,e,i){console.warn("Method not implemented.")}setEventTarget(t){this._eventTarget=t}getRootDisplay(){let t,e=this._armature._parent;if(!e)return this;for(;e;)t=e,e=e._armature._parent;return t._armature.display}convertToRootSpace(t){const e=this._armature._parent;if(!e)return t;e.updateWorldMatrix();const i=e._worldMatrix,n=new oi(0,0);return n.x=t.x*i.m00+t.y*i.m04+i.m12,n.y=t.x*i.m01+t.y*i.m05+i.m13,n}convertToWorldSpace(t){var e;const i=this.convertToRootSpace(t),n=this.getRootNode();return null==n||null===(e=n._uiProps.uiTransformComp)||void 0===e?void 0:e.convertToWorldSpaceAR(i)}getRootNode(){const t=this.getRootDisplay();return t&&t._ccNode}dbInit(t){this._armature=t}dbClear(){this._armature=null}dbUpdate(){this._ccComponent&&this._ccComponent.markForUpdateRenderData()}advanceTimeBySelf(t){this.shouldAdvanced=!!t}hasDBEventListener(t){return this._eventTarget.hasEventListener(t)}addDBEventListener(t,e,i){this._eventTarget.on(t,e,i)}removeDBEventListener(t,e,i){this._eventTarget.off(t,e,i)}dispatchDBEvent(t,e){this._eventTarget.emit(t,e)}})||knt;var Wnt,qnt,Xnt;let Ynt=u_("CCFactory")((Xnt=qnt=class t extends Ont{static getInstance(){return t._factory||(t._factory=new t),t._factory}constructor(){super(),this.id=void 0,this.uuid=void 0,this._slots=void 0;const t=new jnt;this._dragonBones=new bnt(t),aT.getScheduler()&&(Lv.on(Nv.EVENT_RESTART,this.initUpdate,this),this.initUpdate()),this.id=this.uuid="CCFactory"}initUpdate(t){eS.enableForTarget(this),aT.getScheduler().scheduleUpdate(this,eS.PRIORITY_SYSTEM,!1)}update(t){this._dragonBones.advanceTime(t)}getDragonBonesDataByRawData(t){return(t instanceof ArrayBuffer?Ont._binaryParser:this._dataParser).parseDragonBonesData(t,1)}buildArmatureDisplay(t,e,i,n){const s=this.buildArmature(t,e,i,n);return s?s._display:null}createArmatureNode(t,e,i){let n=(i=i||new uf).getComponent("dragonBones.ArmatureDisplay");return n||(n=i.addComponent("dragonBones.ArmatureDisplay")),i.name=e,n._armatureName=e,n._dragonAsset=t.dragonAsset,n._dragonAtlasAsset=t.dragonAtlasAsset,n._init(),n}_buildTextureAtlasData(t,e){return t?t.renderTexture=e:t=Tnt.borrowObject(Vnt),t}_sortSlots(){const t=this._slots,e=[];for(let i=0,n=t.length;i<n;i++){const n=t[i],s=n._zOrder;let r=!1;for(let t=e.length-1;t>=0;t--)if(s>=e[t]._zOrder){e.splice(t+1,0,n),r=!0;break}r||e.splice(0,0,n)}this._slots=e}_buildArmature(t){const e=Tnt.borrowObject(Dnt);e._skinData=t.skin,e._animation=Tnt.borrowObject(Mnt),e._animation._armature=e,e._animation.animations=t.armature.animations,e._isChildArmature=!1;const i=new jnt;return e.init(t.armature,i,i,this._dragonBones),e}_buildSlot(t,e,i){const n=Tnt.borrowObject(Hnt),s=n;return n.init(e,i,s,s),n}getDragonBonesDataByUUID(t){for(const e in this._dragonBonesDataMap)if(-1!==e.indexOf(t))return this._dragonBonesDataMap[e];return null}removeDragonBonesDataByUUID(t,e){void 0===e&&(e=!0);for(const i in this._dragonBonesDataMap)-1!==i.indexOf(t)&&(e&&this._dragonBones.bufferObject(this._dragonBonesDataMap[i]),delete this._dragonBonesDataMap[i])}},qnt._factory=null,Wnt=Xnt))||Wnt;const Knt=1/60,Jnt=[],$nt=[];let Znt,Qnt,tst=0,est=0,ist=0,nst=null,sst=null,rst=0,ost=0,ast=0,lst=0,cst=0;class hst{constructor(){this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this.frames=[],this.totalTime=0,this.isCompleted=!1,this._frameIdx=-1,this._armatureInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null}init(t,e){this._inited=!0,this._armatureInfo=t,this._animationName=e}clear(){this._inited=!1;for(let t=0,e=this.frames.length;t<e;t++)this.frames[t].segments.length=0;this.invalidAllFrame()}begin(){if(!this._invalid)return;const t=this._armatureInfo,e=t.curAnimationCache;e&&e!==this&&(this._privateMode?e.invalidAllFrame():e.updateToFrame()),t.armature.animation.play(this._animationName,1),t.curAnimationCache=this,this._invalid=!1,this._frameIdx=-1,this.totalTime=0,this.isCompleted=!1}end(){this._needToUpdate()||(this._armatureInfo.curAnimationCache=null,this.frames.length=this._frameIdx+1,this.isCompleted=!0)}_needToUpdate(t){return!this._armatureInfo.armature.animation.isCompleted&&this.totalTime<30&&(void 0===t||this._frameIdx<t)}updateToFrame(t){if(!this._inited)return;if(this.begin(),!this._needToUpdate(t))return;const e=this._armatureInfo.armature;do{e.advanceTime(Knt),this._frameIdx++,this._updateFrame(e,this._frameIdx),this.totalTime+=Knt}while(this._needToUpdate(t));this.end()}isInited(){return this._inited}isInvalid(){return this._invalid}invalidAllFrame(){this.isCompleted=!1,this._invalid=!0}updateAllFrame(){this.invalidAllFrame(),this.updateToFrame()}enableCacheAttachedInfo(){this._enableCacheAttachedInfo||(this._enableCacheAttachedInfo=!0,this.invalidAllFrame())}_updateFrame(t,e){ist=0,tst=0,est=0,nst=null,sst=null,rst=0,ost=0,ast=0,lst=0,cst=0,this.frames[e]=this.frames[e]||{segments:[],colors:[],boneInfos:[],vertices:null,uintVert:null,indices:null};const i=this.frames[e],n=this._tempSegments=i.segments,s=this._tempColors=i.colors,r=this._tempBoneInfos=i.boneInfos;this._traverseArmature(t,1),lst>0&&(s[lst-1].vfOffset=ist),s.length=lst,r.length=tst;const o=ast-1;if(o>=0)if(ost>0){const t=n[o];t.indexCount=ost,t.vfCount=5*rst,t.vertexCount=rst,n.length=ast}else n.length=ast-1;if(0===n.length)return;let a=i.vertices,l=i.uintVert;(!a||a.length<ist)&&(a=i.vertices=new Float32Array(ist),l=i.uintVert=new Uint32Array(a.buffer));for(let t=0,e=0;t<ist;)a[t++]=Jnt[e++],a[t++]=Jnt[e++],a[t++]=Jnt[e++],a[t++]=Jnt[e++],l[t++]=Jnt[e++];let c=i.indices;(!c||c.length<est)&&(c=i.indices=new Uint16Array(est));for(let t=0;t<est;t++)c[t]=$nt[t];i.vertices=a,i.uintVert=l,i.indices=c}_traverseArmature(t,e){const i=this._tempColors,n=this._tempSegments,s=this._tempBoneInfos,r=Jnt,o=$nt,a=t._slots;let l,c,h,_,u,m,d,p,f;const g=t._bones;if(this._enableCacheAttachedInfo)for(let t=0,e=g.length;t<e;t++,tst++){const e=g[t];let i=s[tst];i||(i=s[tst]={globalTransformMatrix:new wnt});const n=e.globalTransformMatrix;i.globalTransformMatrix.copyFrom(n)}for(let t=0,s=a.length;t<s;t++)if(h=a[t],h._visible&&h._displayData)if(h.updateWorldMatrix(),u=h._color,h.childArmature)this._traverseArmature(h.childArmature,e*u.a/255);else if(d=h.getTexture(),d){nst===d.nativeUrl&&sst===h._blendMode||(nst=d.nativeUrl,sst=h._blendMode,p=ast-1,p>=0&&(ost>0?(f=n[p],f.indexCount=ost,f.vertexCount=rst,f.vfCount=5*rst):ast--),n[ast]={tex:d,blendMode:h._blendMode,indexCount:0,vertexCount:0,vfCount:0},ast++,ost=0,rst=0),m=(u.a*e<<24>>>0)+(u.b<<16)+(u.g<<8)+u.r,cst!==m&&(cst=m,lst>0&&(i[lst-1].vfOffset=ist),i[lst++]={r:u.r,g:u.g,b:u.b,a:u.a*e,vfOffset:0}),l=h._localVertices,c=h._indices,_=h._worldMatrix;for(let t=0,e=l.length;t<e;)Znt=l[t++],Qnt=l[t++],r[ist++]=Znt*_.m00+Qnt*_.m04+_.m12,r[ist++]=Znt*_.m01+Qnt*_.m05+_.m13,r[ist++]=l[t++],r[ist++]=l[t++],r[ist++]=m;for(let t=0,e=c.length;t<e;t++)o[est++]=rst+c[t];ost+=c.length,rst+=l.length/4}}}class _st{constructor(){this._privateMode=!1,this._animationPool={},this._armatureCache={}}enablePrivateMode(){this._privateMode=!0}dispose(){for(const t in this._armatureCache){const e=this._armatureCache[t];if(e){const t=e.armature;t&&t.dispose()}}this._armatureCache={},this._animationPool={}}_removeArmature(t){const e=this._armatureCache[t],i=e.animationsCache;for(const e in i){const n=i[e];n&&(this._animationPool[`${t}#${e}`]=n,n.clear())}const n=e.armature;n&&n.dispose(),delete this._armatureCache[t]}resetArmature(t){for(const e in this._armatureCache)-1!==e.indexOf(t)&&this._removeArmature(e)}getArmatureCache(t,e,i){const n=this._armatureCache[e];let s;if(n)s=n.armature;else{const n=Ynt.getInstance().buildArmatureDisplay(t,e,"",i);if(!n||!n._armature)return null;if(s=n._armature,!_st.canCache(s))return s.dispose(),null;this._armatureCache[e]={armature:s,animationsCache:{},curAnimationCache:null}}return s}getAnimationCache(t,e){const i=this._armatureCache[t];return i?i.animationsCache[e]:null}initAnimationCache(t,e){if(!e)return null;const i=this._armatureCache[t],n=i&&i.armature;if(!n)return null;if(!n.animation.hasAnimation(e))return null;const s=i.animationsCache;let r=s[e];if(!r){const n=`${t}#${e}`;r=this._animationPool[n],r?delete this._animationPool[n]:(r=new hst,r._privateMode=this._privateMode),r.init(i,e),s[e]=r}return r}invalidAnimationCache(t){const e=this._armatureCache[t];if(!e||!e.armature)return;const i=e.animationsCache;for(const t in i)i[t].invalidAllFrame()}updateAnimationCache(t,e){if(e){const i=this.initAnimationCache(t,e);if(!i)return;i.updateAllFrame()}else{const e=this._armatureCache[t];if(!e||!e.armature)return;const i=e.animationsCache;for(const t in i)i[t].updateAllFrame()}}static canCache(t){const e=t._slots;for(let t=0,i=e.length;t<i;t++)if(e[t].childArmature)return!1;return!0}}var ust,mst,dst;_st.FrameTime=Knt,_st.sharedCache=new _st;let pst=u_("dragonBones.DragonBonesAsset")((dst=n_((mst=class extends xu{constructor(...t){super(...t),i_(this,"_dragonBonesJson",dst,this),this._factory=null,this._dragonBonesJsonData=void 0,this._armaturesEnum=null}get dragonBonesJson(){return this._dragonBonesJson}set dragonBonesJson(t){this._dragonBonesJson=t,this._dragonBonesJsonData=JSON.parse(t),this.reset()}constructctor(){this.reset()}createNode(t){const e=new uf(this.name);return e.addComponent("dragonBones.ArmatureDisplay").dragonAsset=this,t(null,e)}reset(){this._clear()}init(t,e){this._factory=t,!this._dragonBonesJsonData&&this.dragonBonesJson&&(this._dragonBonesJsonData=JSON.parse(this.dragonBonesJson));let i=null;if(i=this._dragonBonesJsonData?this._dragonBonesJsonData:this._nativeAsset,!this._uuid){const t=this._factory.getDragonBonesDataByRawData(i);t?this._uuid=t.name:console.warn("dragonbones name is empty")}const n=`${this._uuid}#${e}`;return this._factory.getDragonBonesData(n)||this._factory.parseDragonBonesData(i instanceof ArrayBuffer?i:i.buffer instanceof ArrayBuffer?i.buffer:i,n),n}getArmatureEnum(){if(this._armaturesEnum)return this._armaturesEnum;this.init();const t=this._factory.getDragonBonesDataByUUID(this._uuid);if(t){const e=t.armatureNames,i={};for(let t=0;t<e.length;t++)i[e[t]]=t;return this._armaturesEnum=Gt(i)}return null}getAnimsEnum(t){this.init();const e=this._factory.getDragonBonesDataByUUID(this._uuid);if(e){const i=e.getArmature(t);if(!i)return null;const n={"<None>":0},s=i.animations;let r=0;for(const t in s)s.hasOwnProperty(t)&&(n[t]=r+1,r++);return Gt(n)}return null}destroy(){return this._clear(),super.destroy()}_clear(){this._factory&&(_st.sharedCache.resetArmature(this._uuid),this._factory.removeDragonBonesDataByUUID(this._uuid,!0))}}).prototype,"_dragonBonesJson",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ust=mst))||ust;var fst,gst,yst,vst,xst,Sst,Ast,Cst;n.internal.DragonBonesAsset=pst;let bst=(fst=u_("dragonBones.DragonBonesAtlasAsset"),gst=H_(Zm),fst((xst=n_((vst=class extends xu{constructor(){super(),i_(this,"_atlasJson",xst,this),i_(this,"_texture",Sst,this),i_(this,"_atlasJsonData",Ast,this),this._factory=null,i_(this,"_textureAtlasData",Cst,this),this._clear()}get atlasJson(){return this._atlasJson}set atlasJson(t){this._atlasJson=t,this._atlasJsonData=JSON.parse(this.atlasJson),this._clear()}get texture(){return this._texture}set texture(t){this._texture=t,this._clear()}createNode(t){const e=new uf(this.name);return e.addComponent("dragonBones.ArmatureDisplay").dragonAtlasAsset=this,t(null,e)}init(t){this._factory=t,this._atlasJsonData||(this._atlasJsonData=JSON.parse(this.atlasJson));const e=this._atlasJsonData;this._uuid=this._uuid||e.name,this._textureAtlasData?t.addTextureAtlasData(this._textureAtlasData,this._uuid):this._textureAtlasData=t.parseTextureAtlasData(e,this.texture,this._uuid)}destroy(){return this._clear(),super.destroy()}_clear(){}}).prototype,"_atlasJson",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Sst=n_(vst.prototype,"_texture",[g_,gst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ast=n_(vst.prototype,"_atlasJsonData",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),Cst=n_(vst.prototype,"_textureAtlasData",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yst=vst))||yst);var Tst;n.internal.DragonBonesAtlasAsset=bst;const wst=new Si;let Est=u_("dragonBones.AttachUtil")(Tst=class{constructor(){this._inited=!1,this._armature=null,this._armatureNode=null,this._armatureDisplay=null}init(t){this._inited=!0,this._armature=t._armature,this._armatureNode=t.node,this._armatureDisplay=t}reset(){this._inited=!1,this._armature=null,this._armatureNode=null,this._armatureDisplay=null}_syncAttachedNode(){if(!this._inited)return;this._armatureNode.worldMatrix;let t=null;const e=this._armatureDisplay.isAnimationCached();if(e&&this._armatureDisplay&&(t=this._armatureDisplay._curFrame&&this._armatureDisplay._curFrame.boneInfos,!t))return;const i=this._armatureDisplay.sockets,n=this._armatureDisplay.socketNodes,s=new oi,r=(t,e)=>{const i=wst;i.m00=e.a,i.m01=e.b,i.m04=-e.c,i.m05=-e.d,i.m12=e.tx,i.m13=e.ty,t._oldScale||(t._oldScale=t.scale.clone()),s.set(t._oldScale),t.matrix=wst,t.scale=s.multiply(this._armatureNode.scale)},o=this._armature.getBones();for(let s=i.length-1;s>=0;s--){const a=i[s],l=a.target;if(!l)continue;if(!l.isValid){n.delete(a.path),i.splice(s,1);continue}const c=e?t[a.boneIndex]:o[a.boneIndex];c&&r(l,c.globalTransformMatrix)}}})||Tst;var Pst,Ist,Dst,Rst,Mst,Bst,Ost,Nst,Lst,Fst,zst,Vst,Ust,Gst,Hst,kst,jst,Wst,qst,Xst,Yst,Kst,Jst,$st,Zst,Qst,trt,ert,irt,nrt,srt,rrt,ort,art,lrt,crt,hrt,_rt,urt,mrt,drt,prt,frt,grt,yrt,vrt,xrt,Srt,Art,Crt;let brt;function Trt(t,e,i){Me.Attr.setClassAttr(t,e,"type","Enum"),Me.Attr.setClassAttr(t,e,"enumList",Gt.getList(i))}!function(t){t[t.default=-1]="default"}(Srt||(Srt={})),jt(Srt),function(t){t[t["<None>"]=0]="<None>"}(Art||(Art={})),jt(Art),function(t){t[t.REALTIME=0]="REALTIME"}(Crt||(Crt={})),jt(Art),function(t){t[t.REALTIME=0]="REALTIME",t[t.SHARED_CACHE=1]="SHARED_CACHE",t[t.PRIVATE_CACHE=2]="PRIVATE_CACHE"}(brt||(brt={})),jt(brt);let wrt=(Pst=u_("dragonBones.ArmatureDisplay.DragonBoneSocket"),Ist=H_(uf),Pst((Mst=n_((Rst=class{constructor(t="",e=null){i_(this,"path",Mst,this),i_(this,"target",Bst,this),this.boneIndex=null,this.path=t,this.target=e}}).prototype,"path",[g_,w_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Bst=n_(Rst.prototype,"target",[Ist,w_,g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Dst=Rst))||Dst);Mt(wrt,"dragonBones.ArmatureDisplay.DragonBoneSocket");let Ert=(Ost=u_("dragonBones.ArmatureDisplay"),Nst=T_(),Lst=S_(),Fst=H_(pst),zst=I_(),Vst=H_(bst),Ust=I_(),Gst=E_(),Hst=E_(),kst=P_(),jst=H_(Srt),Wst=I_(),qst=H_(Art),Xst=P_(),Yst=I_(),Kst=P_(),Jst=I_(),$st=I_(),Zst=I_(),Qst=I_(),trt=I_(),ert=H_([wrt]),irt=I_(),Ost(nrt=Nst(nrt=Lst(nrt=x_((xrt=vrt=class t extends wB{get dragonAsset(){return this._dragonAsset}set dragonAsset(t){this._dragonAsset=t,this._refresh()}get dragonAtlasAsset(){return this._dragonAtlasAsset}set dragonAtlasAsset(t){this._dragonAtlasAsset=t,this._parseDragonAtlasAsset(),this._refresh()}get armatureName(){return this._armatureName}set armatureName(t){this._armatureName=t;const e=this.getAnimationNames(this._armatureName);(!this.animationName||e.indexOf(this.animationName)<0)&&(this.animationName=""),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.remove(this._armature),this._refresh(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature)}get animationName(){return this._animationName}set animationName(t){this._animationName=t}get _defaultArmatureIndex(){return this._defaultArmatureIndexValue}set _defaultArmatureIndex(t){this._defaultArmatureIndexValue=t;let e="";if(this.dragonAsset){let t;if(this.dragonAsset&&(t=this.dragonAsset.getArmatureEnum()),!t)return void T(7400,this.name);e=t[this._defaultArmatureIndex]}void 0!==e?this.armatureName=e:T(7401,this.name),this.resetRenderData(),this.markForUpdateRenderData()}get _animationIndex(){return this._animationIndexValue}set _animationIndex(t){if(this._animationIndexValue=t,0===this._animationIndex)return void(this.animationName="");let e;if(this.dragonAsset&&(e=this.dragonAsset.getAnimsEnum(this.armatureName)),!e)return;const i=e[this._animationIndex];void 0!==i?this.playAnimation(i,this.playTimes):T(7402,this.name)}get _defaultCacheMode(){return this._defaultCacheModeValue}set _defaultCacheMode(t){if(this._defaultCacheModeValue=t,this._defaultCacheMode!==brt.REALTIME&&this._armature&&!_st.canCache(this._armature))return this._defaultCacheMode=brt.REALTIME,void console.warn("Animation cache mode doesn't support skeletal nesting");this.setAnimationCacheMode(this._defaultCacheMode)}get timeScale(){return this._timeScale}set timeScale(t){this._timeScale=t,this._armature&&!this.isAnimationCached()&&(this._armature.animation.timeScale=this.timeScale)}get debugBones(){return this._debugBones}set debugBones(t){this._debugBones=t,this._updateDebugDraw()}get sockets(){return this._sockets}set sockets(t){this._verifySockets(t),this._sockets=t,this._updateSocketBindings(),t.length>0&&this._frameCache&&this._frameCache.enableCacheAttachedInfo()}get socketNodes(){return this._socketNodes}get meshRenderDataArray(){return this._meshRenderDataArray}constructor(){super(),i_(this,"playTimes",rrt,this),i_(this,"premultipliedAlpha",ort,this),this._armature=null,this.attachUtil=void 0,i_(this,"_defaultArmatureIndexValue",art,this),i_(this,"_dragonAsset",lrt,this),i_(this,"_dragonAtlasAsset",crt,this),i_(this,"_armatureName",hrt,this),i_(this,"_animationName",_rt,this),i_(this,"_animationIndexValue",urt,this),this._preCacheMode=-1,this._cacheMode=brt.REALTIME,i_(this,"_defaultCacheModeValue",mrt,this),i_(this,"_timeScale",drt,this),i_(this,"_playTimes",prt,this),i_(this,"_debugBones",frt,this),this._debugDraw=null,i_(this,"_enableBatch",grt,this),this._armatureKey="",this._accTime=0,this._playCount=0,this._frameCache=null,this._curFrame=null,this._playing=!1,this._armatureCache=null,this._eventTarget=void 0,this._factory=null,this._displayProxy=null,this._meshRenderDataArray=[],this._materialCache={},this._enumArmatures=Gt({}),this._enumAnimations=Gt({}),this._socketNodes=new Map,this._cachedSockets=new Map,i_(this,"_sockets",yrt,this),this._inited=void 0,this._meshRenderDataArrayIdx=0,this._cacheModeEnum=void 0,this._eventTarget=new Zi,this._inited=!1,this.attachUtil=new Est,this.initFactory(),Trt(this,"_animationIndex",this._enumAnimations),Trt(this,"_defaultArmatureIndex",this._enumArmatures)}initFactory(){this._factory=Ynt.getInstance()}onLoad(){const t=this.node.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];0===(i.name&&i.name.search("CHILD_ARMATURE-"))&&i.destroy()}}requestMeshRenderData(){const t=this._meshRenderDataArray;if(t.length>0&&0===t[t.length-1].renderData.vertexCount)return t[t.length-1];const e={renderData:new BM,texture:null};return t.push(e),e}destroyRenderData(){this._meshRenderDataArray&&(this._meshRenderDataArray.forEach((t=>{t.renderData.reset()})),this._meshRenderDataArray.length=0)}resetRenderData(){this._meshRenderDataArray&&this._meshRenderDataArray.forEach((t=>{t.renderData.reset()}))}getMaterialForBlend(t,e){const i=`${t}/${e}`;let n=this._materialCache[i];if(n)return n;const s=this.getMaterial(0);return n=new lv({parent:s,subModelIdx:0,owner:this}),n.recompileShaders({USE_LOCAL:!1},0),this._materialCache[i]=n,n.overridePipelineStates({blendState:{targets:[{blendSrc:t,blendDst:e}]}}),n}_render(t){if(this._meshRenderDataArray)for(let e=0;e<this._meshRenderDataArray.length;e++){const i=this.material;this._meshRenderDataArrayIdx=e;const n=this._meshRenderDataArray[e];this.material=n.renderData.material,n.texture&&t.commitComp(this,n.texture,this._assembler,null),this.material=i}}_updateBatch(){this._materialCache={},this.destroyRenderData(),this.markForUpdateRenderData()}_updateMaterial(){this.markForUpdateRenderData()}disableRender(){}_validateRender(){const t=this.dragonAtlasAsset&&this.dragonAtlasAsset.texture;return!(!t||!t.loaded)||(this.disableRender(),!1)}__preload(){super.__preload(),this._init()}_init(){if(this._cacheMode=this._defaultCacheMode,this._inited)return;this._inited=!0,this._parseDragonAtlasAsset(),this._refresh();const t=this.node.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];i&&"DEBUG_DRAW_NODE"===i.name&&i.destroy()}this._updateDebugDraw(),this._indexBoneSockets(),this._updateSocketBindings()}getArmatureKey(){return this._armatureKey}setAnimationCacheMode(t){this._preCacheMode!==t&&(this._cacheMode=t,this._buildArmature(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature),this._updateSocketBindings(),this.markForUpdateRenderData())}isAnimationCached(){return this._cacheMode!==brt.REALTIME}onEnable(){super.onEnable(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature),this._flushAssembler()}onDisable(){super.onDisable(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.remove(this._armature)}_emitCacheCompleteEvent(){this._eventTarget.emit(Bnt.LOOP_COMPLETE),this._eventTarget.emit(Bnt.COMPLETE)}update(t){if(!this.isAnimationCached())return;if(!this._frameCache)return;this.markForUpdateRenderData();const e=this._frameCache;if(!e.isInited())return;const i=e.frames;if(!this._playing)return void(e.isInvalid()&&(e.updateToFrame(),this._curFrame=i[i.length-1]));const n=_st.FrameTime;0===this._accTime&&0===this._playCount&&this._eventTarget.emit(Bnt.START),this._accTime+=t*this.timeScale*1;let s=Math.floor(this._accTime/n);if(e.isCompleted||e.updateToFrame(s),e.isCompleted&&s>=i.length){if(this._playCount++,this.playTimes>0&&this._playCount>=this.playTimes)return this._curFrame=i[i.length-1],this._accTime=0,this._playing=!1,this._playCount=0,this._emitCacheCompleteEvent(),void this.attachUtil._syncAttachedNode();this._accTime=0,s=0,this._emitCacheCompleteEvent()}this._curFrame=i[s],this.attachUtil._syncAttachedNode()}onDestroy(){this._materialInstances=this._materialInstances.filter((t=>!!t)),super.onDestroy(),this._inited=!1,this._cacheMode===brt.PRIVATE_CACHE?(this._armatureCache.dispose(),this._armatureCache=null,this._armature=null):this._cacheMode===brt.SHARED_CACHE?(this._armatureCache=null,this._armature=null):this._armature&&(this._armature.dispose(),this._armature=null),this.destroyRenderData()}_updateDebugDraw(){if(this.debugBones){if(!this._debugDraw){const t=new uf("DEBUG_DRAW_NODE");t.hideFlags|=Gi.Flags.DontSave|Gi.Flags.HideInHierarchy;const e=t.addComponent(RN);e.lineWidth=1,e.strokeColor=new si(255,0,0,255),this._debugDraw=e}this._debugDraw.node.parent=this.node}else this._debugDraw&&(this._debugDraw.node.parent=null);this.destroyRenderData(),this.markForUpdateRenderData()}_buildArmature(){if(!this.dragonAsset||!this.dragonAtlasAsset||!this.armatureName)return;this._armature&&(this._preCacheMode===brt.PRIVATE_CACHE?this._armatureCache.dispose():this._preCacheMode===brt.REALTIME&&this._armature.dispose(),this._armatureCache=null,this._armature=null,this._displayProxy=null,this._frameCache=null,this._curFrame=null,this._playing=!1,this._preCacheMode=-1),this._cacheMode===brt.SHARED_CACHE?this._armatureCache=_st.sharedCache:this._cacheMode===brt.PRIVATE_CACHE&&(this._armatureCache=new _st,this._armatureCache.enablePrivateMode());const t=this.dragonAtlasAsset._uuid;if(this._armatureKey=this.dragonAsset.init(this._factory,t),this.isAnimationCached()&&(this._armature=this._armatureCache.getArmatureCache(this.armatureName,this._armatureKey,t),this._armature||(this._cacheMode=brt.REALTIME)),this._preCacheMode=this._cacheMode,this._cacheMode===brt.REALTIME){if(this._displayProxy=this._factory.buildArmatureDisplay(this.armatureName,this._armatureKey,"",t),!this._displayProxy)return;this._displayProxy._ccNode=this.node,this._displayProxy._ccComponent=this,this._displayProxy.setEventTarget(this._eventTarget),this._armature=this._displayProxy._armature,this._armature.animation.timeScale=this.timeScale}if(this._cacheMode!==brt.REALTIME&&this.debugBones&&console.warn("Debug bones is invalid in cached mode"),this._armature){const t=this._armature.armatureData.aabb;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._updateBatch(),this.attachUtil.init(this),this.animationName&&this.playAnimation(this.animationName,this.playTimes),this.destroyRenderData(),this.markForUpdateRenderData()}querySockets(){return this._armature?(0===this._cachedSockets.size&&this._indexBoneSockets(),Array.from(this._cachedSockets.keys()).sort()):[]}setBlendHash(){-1!==this._blendHash&&(this._blendHash=-1)}querySocketPathByName(t){const e=[];for(const i of this._cachedSockets.keys())i.endsWith(t)&&e.push(i);return e}_parseDragonAtlasAsset(){this.dragonAtlasAsset&&this.dragonAtlasAsset.init(this._factory)}_refresh(){this._buildArmature(),this.markForUpdateRenderData()}_updateCacheModeEnum(){this._cacheModeEnum=Gt({}),this._armature?Object.assign(this._cacheModeEnum,brt):Object.assign(this._cacheModeEnum,Crt),Trt(this,"_defaultCacheMode",this._cacheModeEnum)}_updateAnimEnum(){let t;t=this.dragonAsset?this.dragonAsset.getAnimsEnum(this.armatureName):Art,this._enumAnimations=Gt({}),Object.assign(this._enumAnimations,t||Art),Gt.update(this._enumAnimations),Trt(this,"_animationIndex",this._enumAnimations)}_updateArmatureEnum(){let t;t=this.dragonAsset?this.dragonAsset.getArmatureEnum():Srt,this._enumArmatures=Gt({}),Object.assign(this._enumArmatures,t||Srt),Gt.update(this._enumArmatures),Trt(this,"_defaultArmatureIndex",this._enumArmatures)}_indexBoneSockets(){if(!this._armature)return;this._cachedSockets.clear();const t=this._cachedSockets,e=(t,i,n)=>{if(n.has(t))return n.get(t);const s=i[t];if(!s.parent)return n.set(t,s.name),s.path=s.name,s.name;const r=`${e(s.parent._boneIndex,i,n)}/${s.name}`;return n.set(t,r),s.path=r,r},i=(n,s)=>{const r=s.getBones(),o=new Map;for(let t=0;t<r.length;t++)r[t]._boneIndex=t;for(let t=0;t<r.length;t++)e(t,r,o);for(const e of o.keys())t.set(`${n}${o.get(e)}`,e);const a=s.getSlots();for(let t=0;t<a.length;t++)a[t].childArmature&&i(a[t].name,a[t].childArmature)};i("",this._armature)}playAnimation(t,e){if(this.playTimes=void 0===e?-1:e,this.animationName=t,this.isAnimationCached()){let e=this._armatureCache.getAnimationCache(this._armatureKey,t);e||(e=this._armatureCache.initAnimationCache(this._armatureKey,t)),e&&(this._accTime=0,this._playCount=0,this._frameCache=e,this._sockets.length>0&&this._frameCache.enableCacheAttachedInfo(),this._frameCache.updateToFrame(0),this._playing=!0,this._curFrame=this._frameCache.frames[0])}else if(this._armature)return this._armature.animation.play(t,this.playTimes);return this.markForUpdateRenderData(),null}updateAnimationCache(t){this.isAnimationCached()&&this._armatureCache.updateAnimationCache(this._armatureKey,t)}invalidAnimationCache(){this.isAnimationCached()&&this._armatureCache.invalidAnimationCache(this._armatureKey)}getArmatureNames(){const t=this._factory.getDragonBonesData(this._armatureKey);return t&&t.armatureNames||[]}getAnimationNames(t){const e=[],i=this._factory.getDragonBonesData(this._armatureKey);if(i){const n=i.getArmature(t);if(n)for(const t in n.animations)n.animations.hasOwnProperty(t)&&e.push(t)}return e}on(t,e,i){this.addEventListener(t,e,i)}off(t,e,i){this.removeEventListener(t,e,i)}once(t,e,i){this._eventTarget.once(t,e,i)}addEventListener(t,e,i){this._eventTarget.on(t,e,i)}removeEventListener(t,e,i){this._eventTarget.off(t,e,i)}buildArmature(t,e){return this._factory.createArmatureNode(this,t,e)}armature(){return this._armature}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),0===this._meshRenderDataArray.length&&this._assembler&&this._assembler.createData&&(this._assembler.createData(this),this.markForUpdateRenderData(),this._updateColor())}_updateSocketBindings(){if(this._armature){this._socketNodes.clear();for(let t=0,e=this._sockets.length;t<e;t++){const e=this._sockets[t];if(e.path&&e.target){const t=this._cachedSockets.get(e.path);if(!t){console.error(`Skeleton data does not contain path ${e.path}`);continue}e.boneIndex=t,this._socketNodes.set(e.path,e.target)}}}}_verifySockets(t){for(let e=0,i=t.length;e<i;e++){const i=t[e].target;!i||i.parent&&i.parent===this.node||console.error(`Target node ${i.name} is expected to be a direct child of ${this.node.name}`)}}},vrt.AnimationCacheMode=brt,n_((srt=xrt).prototype,"dragonAsset",[w_,Fst,zst],Object.getOwnPropertyDescriptor(srt.prototype,"dragonAsset"),srt.prototype),n_(srt.prototype,"dragonAtlasAsset",[w_,Vst,Ust],Object.getOwnPropertyDescriptor(srt.prototype,"dragonAtlasAsset"),srt.prototype),n_(srt.prototype,"armatureName",[Gst],Object.getOwnPropertyDescriptor(srt.prototype,"armatureName"),srt.prototype),n_(srt.prototype,"animationName",[Hst],Object.getOwnPropertyDescriptor(srt.prototype,"animationName"),srt.prototype),n_(srt.prototype,"_defaultArmatureIndex",[kst,w_,jst,Wst],Object.getOwnPropertyDescriptor(srt.prototype,"_defaultArmatureIndex"),srt.prototype),n_(srt.prototype,"_animationIndex",[w_,qst,Xst,Yst],Object.getOwnPropertyDescriptor(srt.prototype,"_animationIndex"),srt.prototype),n_(srt.prototype,"_defaultCacheMode",[w_,Kst,Jst],Object.getOwnPropertyDescriptor(srt.prototype,"_defaultCacheMode"),srt.prototype),n_(srt.prototype,"timeScale",[w_,$st,g_],Object.getOwnPropertyDescriptor(srt.prototype,"timeScale"),srt.prototype),rrt=n_(srt.prototype,"playTimes",[Zst,w_,g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ort=n_(srt.prototype,"premultipliedAlpha",[g_,w_,Qst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),n_(srt.prototype,"debugBones",[trt,w_],Object.getOwnPropertyDescriptor(srt.prototype,"debugBones"),srt.prototype),n_(srt.prototype,"sockets",[ert,irt],Object.getOwnPropertyDescriptor(srt.prototype,"sockets"),srt.prototype),art=n_(srt.prototype,"_defaultArmatureIndexValue",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Srt.default}}),lrt=n_(srt.prototype,"_dragonAsset",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),crt=n_(srt.prototype,"_dragonAtlasAsset",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hrt=n_(srt.prototype,"_armatureName",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_rt=n_(srt.prototype,"_animationName",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),urt=n_(srt.prototype,"_animationIndexValue",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mrt=n_(srt.prototype,"_defaultCacheModeValue",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return brt.REALTIME}}),drt=n_(srt.prototype,"_timeScale",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),prt=n_(srt.prototype,"_playTimes",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),frt=n_(srt.prototype,"_debugBones",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),grt=n_(srt.prototype,"_enableBatch",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yrt=n_(srt.prototype,"_sockets",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nrt=srt))||nrt)||nrt)||nrt)||nrt);n.internal.ArmatureDisplay=Ert;const Prt=new si(255,0,0,255),Irt=new si(0,0,255,255),Drt=new si(0,255,0,255);let Rrt,Mrt,Brt,Ort,Nrt,Lrt,Frt,zrt,Vrt,Urt,Grt,Hrt,krt,jrt,Wrt,qrt;const Xrt=new Float32Array(4);let Yrt,Krt,Jrt,$rt,Zrt,Qrt,tot;const eot=new oi;function iot(t,e){if(!t)return null;let i,n;switch(e){case 1:i=Nrt?ro.ONE:ro.SRC_ALPHA,n=ro.ONE;break;case 10:i=ro.DST_COLOR,n=ro.ONE_MINUS_SRC_ALPHA;break;case 12:i=ro.ONE,n=ro.ONE_MINUS_SRC_COLOR;break;case 0:default:i=Nrt?ro.ONE:ro.SRC_ALPHA,n=ro.ONE_MINUS_SRC_ALPHA}return Vrt.setBlendHash(),Vrt.getMaterialForBlend(i,n)}function not(t,e){const i=t.a*e*Ort,n=Nrt?i/255:1,s=t.r*Rrt*n/255,r=t.g*Mrt*n/255,o=t.b*Brt*n/255;Xrt[0]=s,Xrt[1]=r,Xrt[2]=o,Xrt[3]=Nrt?1:i/255}function sot(t){Xrt[0]=(255&t>>>24)/255,Xrt[1]=(255&t>>>16)/255,Xrt[2]=(255&t>>>8)/255,Xrt[3]=(255&t>>>0)/255}const rot={createData(){},updateRenderData(t,e){Vrt=t,function(t){const e=t._armature;if(!e)return;t.markForUpdateRenderData(),t.destroyRenderData(),Lrt=!0,Nrt=t.premultipliedAlpha,zrt=t.node,Frt=t.requestMeshRenderData(),Vrt=t,Yrt=0;const i=t.color;let n;if(Rrt=i.r/255,Mrt=i.g/255,Brt=i.b/255,Ort=i.a/255,4294967295!==i._val&&(Yrt|=1),Vrt._enableBatch&&(n=zrt.worldMatrix,Lrt=!1,Yrt|=16),t.isAnimationCached())!function(t,e){if(!t)return;const i=t.segments;if(0===i.length)return;let n,s,r;const o=t.vertices,a=new Uint32Array(o.buffer),l=t.indices;let c=0,h=0,_=0;e&&(Krt=e.m00,Zrt=e.m01,Jrt=e.m04,Qrt=e.m05,$rt=e.m12,tot=e.m13);const u=16&Yrt,m=u&&(1===Krt&&0===Zrt&&0===Jrt&&1===Qrt);let d=0;const p=t.colors;let f=p[d++],g=f.vfOffset;not(f,1);for(let t=0,e=i.length;t<e;t++){const e=i[t];r=iot(e.tex,e.blendMode),Frt.renderData.material||(Frt.renderData.material=r),Frt.texture||(Frt.texture=e.tex),(Lrt||Frt.renderData.material!==r||Frt.texture!==e.tex)&&(Lrt=!1,Frt=Vrt.requestMeshRenderData(),Frt.renderData.material=r,Frt.texture=e.tex),krt=e.vertexCount,jrt=e.indexCount;const y=Frt.renderData;y.reserve(krt,jrt),Grt=y.indicesCount,Urt=y.vDataOffset,Hrt=y.vertexCount,n=Frt.renderData.vData,s=Frt.renderData.iData;for(let t=Grt,e=Grt+jrt;t<e;t++)s[t]=Hrt+l[h++];_=e.vfCount;for(let t=c,e=Urt;t<c+_;)n[e]=o[t++],n[e+1]=o[t++],n[e+3]=o[t++],n[e+4]=o[t++],sot(a[t++]),n.set(Xrt,e+5),e+=9;if(c+=_,m)for(let t=Urt,e=Urt+_;t<e;t+=9)n[t]+=$rt,n[t+1]+=tot;else if(u)for(let t=Urt,e=Urt+_;t<e;t+=9)Wrt=n[t],qrt=n[t+1],n[t]=Wrt*Krt+qrt*Jrt+$rt,n[t+1]=Wrt*Zrt+qrt*Qrt+tot;if(Frt.renderData.advance(krt,jrt),!(1&Yrt))continue;let v=c-_;for(let t=Urt+5,e=Urt+4+_;t<e;t+=9,v+=9)v>=g&&(f=p[d++],not(f,1),g=f.vfOffset),n.set(Xrt,t)}}(t._curFrame,n);else{oot(e,n,1);const i=t._debugDraw;if(t.debugBones&&i){i.clear(),i.lineWidth=5,i.strokeColor=Prt,i.fillColor=Irt;const t=e.getBones();for(let e=0,n=t.length;e<n;e++){const n=t[e],s=Math.max(n.boneData.length,5),r=n.globalTransformMatrix.tx,o=n.globalTransformMatrix.ty,a=r+n.globalTransformMatrix.a*s,l=o+n.globalTransformMatrix.b*s;i.moveTo(r,o),i.lineTo(a,l),i.stroke(),i.circle(r,o,2*Math.PI),i.fill(),0===e&&(i.fillColor=Drt)}}}t.attachUtil._syncAttachedNode(),zrt=void 0,Frt=void 0,Vrt=void 0}(t)},updateColor(t){},fillBuffers(t,e){if(!t||0===t.meshRenderDataArray.length)return;const i=t.meshRenderDataArray,n=t.node;let s=e.acquireBufferBatch(),r=s.byteOffset>>2,o=s.indicesOffset,a=s.vertexOffset;const l=i[t._meshRenderDataArrayIdx].renderData;s.request(l.vertexCount,l.indicesCount)||(s=e.currBufferBatch,r=0,o=0,a=0);const c=s.vData,h=s.iData,_=n.worldMatrix,u=l.vData,m=l.vertexStart,d=l.iData;if(c.set(u.slice(m,m+9*l.vertexCount),r),!t._enableBatch)for(let t=0;t<l.vertexCount;t++){const e=r+9*t;eot.set(c[e],c[e+1],c[e+2]),eot.transformMat4(_),c[e]=eot.x,c[e+1]=eot.y,c[e+2]=eot.z}const p=l.indicesStart;for(let t=0;t<l.indicesCount;t+=1)h[t+o]=d[t+p]+a}};function oot(t,e,i){const n=t._slots;let s,r,o,a,l,c,h;const _=new Si;for(let t=0,u=n.length;t<u;t++){if(h=n[t],c=h._color,!h._visible||!h._displayData)continue;if(e?h._mulMat(h._worldMatrix,e,h._matrix):Si.copy(h._worldMatrix,h._matrix),h.childArmature){oot(h.childArmature,h._worldMatrix,i*c.a/255);continue}if(o=iot(h.getTexture(),h._blendMode),!o)continue;Frt.renderData.material||(Frt.renderData.material=o),Frt.texture||(Frt.texture=h.getTexture()),(Lrt||o!==Frt.renderData.material||Frt.texture!==h.getTexture())&&(Lrt=!1,Frt=Vrt.requestMeshRenderData(),Frt.renderData.material=o,Frt.texture=h.getTexture()),not(c,i),_.set(h._worldMatrix),a=h._localVertices,krt=a.length>>2,l=h._indices,jrt=l.length;const u=Frt.renderData;u.reserve(krt,jrt),Grt=u.indicesCount,Urt=u.vDataOffset,Hrt=u.vertexCount,s=Frt.renderData.vData,r=Frt.renderData.iData,Krt=_.m00,Jrt=_.m04,$rt=_.m12,Zrt=_.m01,Qrt=_.m05,tot=_.m13;for(let t=0,e=a.length;t<e;)Wrt=a[t++],qrt=a[t++],s[Urt]=Wrt*Krt+qrt*Jrt+$rt,s[Urt+1]=Wrt*Zrt+qrt*Qrt+tot,s[Urt+3]=a[t++],s[Urt+4]=a[t++],s.set(Xrt,Urt+5),Urt+=9;for(let t=0,e=l.length;t<e;t++)r[Grt++]=Hrt+l[t];Frt.renderData.advance(krt,jrt)}}n.internal.DragonBonesAssembler=rot;const aot={getAssembler:()=>rot};let lot,cot,hot;Ert.Assembler=aot,function(t){t[t.FFD=0]="FFD",t[t.AdjustColor=10]="AdjustColor",t[t.BevelFilter=11]="BevelFilter",t[t.BlurFilter=12]="BlurFilter",t[t.DropShadowFilter=13]="DropShadowFilter",t[t.GlowFilter=14]="GlowFilter",t[t.GradientBevelFilter=15]="GradientBevelFilter",t[t.GradientGlowFilter=16]="GradientGlowFilter"}(lot||(lot={})),function(t){t[t.Frame=0]="Frame",t[t.Sound=1]="Sound"}(cot||(cot={})),function(t){t[t.None=0]="None",t[t.SameLayer=1]="SameLayer",t[t.SameGroup=2]="SameGroup",t[t.SameLayerAndGroup=3]="SameLayerAndGroup",t[t.All=4]="All"}(hot||(hot={}));const _ot=window.dragonBones,uot=_ot.Slot,mot=_ot.Matrix,dot=_ot.BaseObject,pot=_ot.BoundingBoxData,fot=_ot.PolygonBoundingBoxData,got=_ot.Transform,yot=_ot.Animation,vot=_ot.TextureData,xot=_ot.CCTextureData,Sot=_ot.BaseFactory,Aot=_ot.CCFactory,Cot=_ot.WorldClock,bot=_ot.TextureAtlasData,Tot=_ot.CCArmatureDisplay,wot=_ot.AnimationState,Eot=_ot.BoneData,Pot=_ot.EllipseBoundingBoxData,Iot=_ot.ArmatureData,Dot=_ot.CCTextureAtlasData,Rot=_ot.TransformObject,Mot=_ot.CCSlot,Bot=_ot.Armature,Oot=_ot.Bone,Not=_ot.RectangleBoundingBoxData,Lot=_ot.ArmatureCacheMgr,Fot=_ot.SkinData,zot=_ot.EventObject,Vot=_ot.SlotData,Uot=_ot.DragonBonesData,Got=_ot.AnimationData,Hot=_ot.CCArmatureCacheDisplay;t("dragonBones",Object.freeze({__proto__:null,DragonBonesAsset:pst,DragonBonesAtlasAsset:bst,timeScale:1,get AnimationCacheMode(){return brt},DragonBoneSocket:wrt,ArmatureDisplay:Ert,AttachUtil:Est,simpleDragonBoneAssembler:aot,get ExtensionType(){return lot},get EventType(){return cot},get AnimationFadeOutMode(){return hot},Slot:uot,Matrix:mot,BaseObject:dot,BoundingBoxData:pot,PolygonBoundingBoxData:fot,Transform:got,Animation:yot,TextureData:vot,CCTextureData:xot,BaseFactory:Sot,CCFactory:Aot,WorldClock:Cot,TextureAtlasData:bot,CCArmatureDisplay:Tot,AnimationState:wot,BoneData:Eot,EllipseBoundingBoxData:Pot,ArmatureData:Iot,CCTextureAtlasData:Dot,TransformObject:Rot,CCSlot:Mot,Armature:Bot,Bone:Oot,RectangleBoundingBoxData:Not,ArmatureCacheMgr:Lot,SkinData:Fot,EventObject:zot,SlotData:Vot,DragonBonesData:Uot,AnimationData:Got,CCArmatureCacheDisplay:Hot}))}}}));
